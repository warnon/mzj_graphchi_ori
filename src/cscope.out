cscope 15 $HOME/graphchi-cpp-master/src -q 0000003253 0000536934
	@api/chifilenames.hpp

33 #iâdeà
GRAPHCHI_FILENAMES_DEF


34 
	#GRAPHCHI_FILENAMES_DEF


	)

36 
	~<f¡»am
>

37 
	~<fú.h
>

38 
	~<¡ršg
>

39 
	~<s¡»am
>

40 
	~<¡dlib.h
>

41 
	~<”ºo.h
>

42 
	~<uni¡d.h
>

43 
	~<veùÜ
>

44 
	~<sys/¡©.h
>

46 
	~"g¿phchi_ty³s.hµ
"

47 
	~"logg”/logg”.hµ
"

49 #ifdeà
DYNAMICEDATA


50 
	~"sh¬ds/dyÇmicd©a/dyÇmicblock.hµ
"

53 
Çme¥aû
 
	gg¿phchi
 {

55 #ifdeà
__GNUC__


56 
	#VARIABLE_IS_NOT_USED
 
	`__©Œibu‹__
 ((
unu£d
))

	)

58 
	#VARIABLE_IS_NOT_USED


	)

60 
VARIABLE_IS_NOT_USED
 
g‘_İtiÚ_št
(cÚ¡ *
İtiÚ_Çme
, 
deçuÉ_v®ue
);

65 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
>

66 
	g¡d
::
¡ršg
 
f’ame_v”‹x_d©a
(
¡d
::¡ršg 
ba£f’ame
) {

67 
¡d
::
¡ršg¡»am
 
ss
;

68 
	gss
 << 
	gba£f’ame
;

69 
	gss
 << "." << (
	gV”‹xD©aTy³
) << "B.vout";

70  
	gss
.
¡r
();

73 
	g¡d
::
¡ršg
 
f’ame_deg»e_d©a
(
¡d
::¡ršg 
ba£f’ame
) {

74  
ba£f’ame
 + "_degs.bin";

77 
	g¡d
::
¡ršg
 
f’ame_š‹rv®s
(
¡d
::¡ršg 
ba£f’ame
, 
nsh¬ds
) {

78 
	g¡d
::
¡ršg¡»am
 
ss
;

79 
	gss
 << 
	gba£f’ame
;

80 
	gss
 << "." << 
	gnsh¬ds
 << ".intervals";

81  
	gss
.
¡r
();

85 
	g¡d
::
¡ršg
 
VARIABLE_IS_NOT_USED
 
g‘_·¹_¡r
(
p
, 
nsh¬ds
) {

86 
	g·¹¡r
[32];

87 
¥rštf
(
·¹¡r
, ".%d_%d", 
p
, 
nsh¬ds
);

88  
	g¡d
::
¡ršg
(
·¹¡r
);

91 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

92 
	g¡d
::
¡ršg
 
f’ame_sh¬d_ed©a
(
¡d
::¡ršg 
ba£f’ame
, 
p
, 
nsh¬ds
) {

93 
	g¡d
::
¡ršg¡»am
 
ss
;

94 
	gss
 << 
	gba£f’ame
;

95 #ifdeà
DYNAMICEDATA


96 
	gss
 << ".dynamic.";

98 
	gss
 << ".edata.";

100 #iâdeà
GRAPHCHI_DISABLE_COMPRESSION


101 
	gss
 << ".Z.";

103 
	gss
 << "e" << (
	gEdgeD©aTy³
) << "B.";

104 
	gss
 << 
	gp
 << "_" << 
	gnsh¬ds
;

106  
	gss
.
¡r
();

112 
	g¡d
::
¡ršg
 
dœÇme_sh¬d_ed©a_block
(
¡d
::¡ršg 
ed©a_sh¬dÇme
, 
size_t
 
blocksize
) {

113 
	g¡d
::
¡ršg¡»am
 
ss
;

114 
	gss
 << 
	ged©a_sh¬dÇme
;

115 
	gss
 << "_blockdœ_" << 
	gblocksize
;

116  
	gss
.
¡r
();

119 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

120 
size_t
 
g‘_sh¬d_ed©a_fesize
(
¡d
::
¡ršg
 
ed©a_sh¬dÇme
) {

121 
size_t
 
fsize
;

122 
	g¡d
::
¡ršg
 
âame
 = 
ed©a_sh¬dÇme
 + ".size";

123 
	g¡d
::
if¡»am
 
ifs
(
âame
.
c_¡r
());

124 ià(!
	gifs
.
good
()) {

125 
log¡»am
(
LOG_FATAL
è<< "Could‚Ù†ßd " << 
	gâame
 << ". P»´oûssšg fÜgÙ‹n?" << 
	g¡d
::
’dl
;

126 
as£¹
(
ifs
.
good
());

128 
	gifs
 >> 
	gfsize
;

129 
	gifs
.
şo£
();

130  
	gfsize
;

134 
	g¡d
::
¡ršg
 
f’ame_sh¬d_ed©a_block
(
¡d
::¡ršg 
ed©a_sh¬dÇme
, 
blockid
, 
size_t
 
blocksize
) {

135 
	g¡d
::
¡ršg¡»am
 
ss
;

136 
	gss
 << 
dœÇme_sh¬d_ed©a_block
(
ed©a_sh¬dÇme
, 
blocksize
);

137 
	gss
 << "/";

138 
	gss
 << 
	gblockid
;

139  
	gss
.
¡r
();

143 
	g¡d
::
¡ršg
 
f’ame_sh¬d_adj
(
¡d
::¡ršg 
ba£f’ame
, 
p
, 
nsh¬ds
) {

144 
	g¡d
::
¡ršg¡»am
 
ss
;

145 
	gss
 << 
	gba£f’ame
;

146 
	gss
 << ".edata_azv.";

147 
	gss
 << 
	gp
 << "_" << 
	gnsh¬ds
 << ".adj";

148  
	gss
.
¡r
();

151 
	g¡d
::
¡ršg
 
f’ame_sh¬d_adjidx
(
¡d
::¡ršg 
adjf’ame
) {

152  
adjf’ame
 + "idx";

158 
	g¡d
::
¡ršg
 
f’ame_cÚfig
();

159 
	g¡d
::
¡ršg
 
f’ame_cÚfig
() {

160 * 
chi_roÙ
 = 
g‘’v
("GRAPHCHI_ROOT");

161 ià(
	gchi_roÙ
 !ğ
NULL
) {

162  
¡d
::
¡ršg
(
chi_roÙ
) + "/conf/graphchi.cnf";

172 
	g¡d
::
¡ršg
 
f’ame_cÚfig_loÿl
();

173 
	g¡d
::
¡ršg
 
f’ame_cÚfig_loÿl
() {

174 * 
chi_roÙ
 = 
g‘’v
("GRAPHCHI_ROOT");

175 ià(
	gchi_roÙ
 !ğ
NULL
) {

176  
¡d
::
¡ršg
(
chi_roÙ
) + "/conf/graphchi.local.cnf";

183 
boŞ
 
fe_exi¡s
(
¡d
::
¡ršg
 
¢ame
);

184 
boŞ
 
fe_exi¡s
(
¡d
::
¡ršg
 
¢ame
) {

185 
Œyf
 = 
İ’
(
¢ame
.
c_¡r
(), 
O_RDONLY
);

186 ià(
	gŒyf
 < 0) {

187  
	gçl£
;

189 
şo£
(
Œyf
);

190  
	gŒue
;

200 
	g‹m¶©e
<
ty³Çme
 
	gEdgeD©aTy³
>

201 
fšd_sh¬ds
(
¡d
::
¡ršg
 
ba£_f’ame
, std::¡ršg 
sh¬d_¡ršg
="auto") {

202 
Œy_sh¬d_num
;

203 
	g¡¬t_num
 = 0;

204 
	gÏ¡_sh¬d_num
 = 2400;

205 ià(
	gsh¬d_¡ršg
 == "auto") {

206 
¡¬t_num
 = 0;

208 
	g¡¬t_num
 = 
©oi
(
sh¬d_¡ršg
.
c_¡r
());

211 ià(
	g¡¬t_num
 > 0) {

212 
	gÏ¡_sh¬d_num
 = 
¡¬t_num
;

214 
size_t
 
	gblocksize
 = 1024 * 1024;

215 
	gblocksize
 % (
	gEdgeD©aTy³
è!ğ0è
blocksize
++;

217 
	gŒy_sh¬d_num
=
¡¬t_num
;ry_sh¬d_num <ğ
Ï¡_sh¬d_num
;ry_shard_num++) {

218 
	g¡d
::
¡ršg
 
Ï¡_sh¬d_Çme
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
ba£_f’ame
, 
	gŒy_sh¬d_num
 - 1,ry_shard_num);

219 
	g¡d
::
¡ršg
 
Ï¡_block_Çme
 = 
f’ame_sh¬d_ed©a_block
(
Ï¡_sh¬d_Çme
, 0, 
blocksize
);

220 
	gŒyf
 = 
İ’
(
Ï¡_block_Çme
.
c_¡r
(), 
O_RDONLY
);

221 ià(
	gŒyf
 >= 0) {

223 
şo£
(
Œyf
);

225 
	gnsh¬ds_ÿndid©e
 = 
Œy_sh¬d_num
;

226 
boŞ
 
	gsucûss
 = 
Œue
;

229 
	gp
=0;… < 
	gnsh¬ds_ÿndid©e
;…++) {

230 
	g¡d
::
¡ršg
 
¢ame
 = 
f’ame_sh¬d_ed©a_block
(

231 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
ba£_f’ame
, 
p
, 
nsh¬ds_ÿndid©e
), 0, 
blocksize
);

232 ià(!
fe_exi¡s
(
¢ame
)) {

233 
log¡»am
(
LOG_DEBUG
è<< "Missšg dœeùÜy fe: " << 
	g¢ame
 << 
	g¡d
::
’dl
;

234 
	gsucûss
 = 
çl£
;

238 
	g¢ame
 = 
f’ame_sh¬d_adj
(
ba£_f’ame
, 
p
, 
nsh¬ds_ÿndid©e
);

239 ià(!
fe_exi¡s
(
¢ame
)) {

240 
log¡»am
(
LOG_DEBUG
è<< "Missšg sh¬d fe: " << 
	g¢ame
 << 
	g¡d
::
’dl
;

241 
	gsucûss
 = 
çl£
;

247 
	g¡d
::
¡ršg
 
deg»eâame
 = 
f’ame_deg»e_d©a
(
ba£_f’ame
);

248 ià(!
fe_exi¡s
(
deg»eâame
)) {

249 
log¡»am
(
LOG_ERROR
è<< "Missšg deg»fe: " << 
	gdeg»eâame
 << 
	g¡d
::
’dl
;

250 
log¡»am
(
LOG_ERROR
è<< "You‚“dØ´•roûs (sh¬d”èyou¸fagaš!" << 
	g¡d
::
’dl
;

254 
	g¡d
::
¡ršg
 
š‹rv®âame
 = 
f’ame_š‹rv®s
(
ba£_f’ame
, 
nsh¬ds_ÿndid©e
);

255 ià(!
fe_exi¡s
(
š‹rv®âame
)) {

256 
log¡»am
(
LOG_ERROR
è<< "Missšg iÁ”v® fe: " << 
	gš‹rv®âame
 << 
	g¡d
::
’dl
;

257 
log¡»am
(
LOG_ERROR
è<< "You‚“dØ´•roûs (sh¬d”èyou¸fagaš!" << 
	g¡d
::
’dl
;

261 ià(!
	gsucûss
) {

265 
log¡»am
(
LOG_INFO
è<< "D‘eùed‚umb” oàsh¬ds: " << 
	gnsh¬ds_ÿndid©e
 << 
	g¡d
::
’dl
;

266 
log¡»am
(
LOG_INFO
è<< "TØ¥ecify‡ difã»Á‚umb” oàsh¬ds, u£ commªd-lš·¿m‘” 'nsh¬ds'" << 
	g¡d
::
’dl
;

267  
	gnsh¬ds_ÿndid©e
;

270 ià(
	gÏ¡_sh¬d_num
 =ğ
¡¬t_num
) {

271 
log¡»am
(
LOG_WARNING
è<< "Could‚Ù fšd sh¬d w™h‚sh¬d ğ" << 
¡¬t_num
 << 
¡d
::
’dl
;

272 
log¡»am
(
LOG_WARNING
è<< "PËa£ defš'nsh¬d 0' o¸'nsh¬d auto'Øautom©iÿÎy d‘eù." << 
	g¡d
::
’dl
;

281 
	g‹m¶©e
<
ty³Çme
 
	gEdgeD©aTy³_
>

282 
d–‘e_sh¬ds
(
¡d
::
¡ršg
 
ba£_f’ame
, 
nsh¬ds
) {

283 #ifdeà
DYNAMICEDATA


284 
	tEdgeD©aTy³
;

286 
EdgeD©aTy³_
 
	tEdgeD©aTy³
;

288 
log¡»am
(
LOG_DEBUG
è<< "D–‘šg fe fÜ " << 
	gba£_f’ame
 << " sh¬ds=" << 
	gnsh¬ds
 << 
	g¡d
::
’dl
;

289 
	g¡d
::
¡ršg
 
š‹rv®âame
 = 
f’ame_š‹rv®s
(
ba£_f’ame
, 
nsh¬ds
);

290 ià(
fe_exi¡s
(
š‹rv®âame
)) {

291 
	g”r
 = 
»move
(
š‹rv®âame
.
c_¡r
());

292 ià(
	g”r
 !ğ0è
log¡»am
(
LOG_ERROR
è<< "E¼Ü„emovšg f" << 
š‹rv®âame


293 << ", " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

303 
size_t
 
	gblocksize
 = 1024 * 1024;

304 
	gblocksize
 % (
	gEdgeD©aTy³
è!ğ0è
blocksize
++;

306 
	gp
=0;… < 
	gnsh¬ds
;…++) {

307 
	gblockid
 = 0;

308 
	g¡d
::
¡ršg
 
f’ame_ed©a
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
ba£_f’ame
, 
	gp
, 
	gnsh¬ds
);

309 
	g¡d
::
¡ršg
 
fsiz’ame
 = 
f’ame_ed©a
 + ".size";

310 ià(
fe_exi¡s
(
fsiz’ame
)) {

311 
	g”r
 = 
»move
(
fsiz’ame
.
c_¡r
());

312 ià(
	g”r
 !ğ0è
log¡»am
(
LOG_ERROR
è<< "E¼Ü„emovšg f" << 
fsiz’ame


313 << ", " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

315 
	gŒue
) {

316 
	g¡d
::
¡ršg
 
block_f’ame
 = 
f’ame_sh¬d_ed©a_block
(
f’ame_ed©a
, 
blockid
, 
blocksize
);

317 ià(
fe_exi¡s
(
block_f’ame
)) {

318 
	g”r
 = 
»move
(
block_f’ame
.
c_¡r
());

319 ià(
	g”r
 !ğ0è
log¡»am
(
LOG_ERROR
è<< "E¼Ü„emovšg f" << 
block_f’ame


320 << ", " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

326 #ifdeà
DYNAMICEDATA


327 
d–‘e_block_uncom´es£d_sizefe
(
block_f’ame
);

329 
	gblockid
++;

331 
	g¡d
::
¡ršg
 
dœÇme
 = 
dœÇme_sh¬d_ed©a_block
(
f’ame_ed©a
, 
blocksize
);

332 ià(
fe_exi¡s
(
dœÇme
)) {

333 
	g”r
 = 
»move
(
dœÇme
.
c_¡r
());

334 ià(
	g”r
 !ğ0è
log¡»am
(
LOG_ERROR
è<< "E¼Ü„emovšg dœeùÜy " << 
dœÇme


335 << ", " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

339 
	g¡d
::
¡ršg
 
adjÇme
 = 
f’ame_sh¬d_adj
(
ba£_f’ame
, 
p
, 
nsh¬ds
);

340 
log¡»am
(
LOG_DEBUG
è<< "D–‘šg " << 
	gadjÇme
 << "ƒxi¡s: " << 
fe_exi¡s
(
adjÇme
è<< 
	g¡d
::
’dl
;

342 ià(
fe_exi¡s
(
adjÇme
)) {

343 
	g”r
 = 
»move
(
adjÇme
.
c_¡r
());

344 ià(
	g”r
 !ğ0è
log¡»am
(
LOG_ERROR
è<< "E¼Ü„emovšg f" << 
adjÇme


345 << ", " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

348 
	g¡d
::
¡ršg
 
idxÇme
 = 
f’ame_sh¬d_adjidx
(
adjÇme
);

349 
log¡»am
(
LOG_DEBUG
è<< "D–‘šg " << 
	gidxÇme
 << "ƒxi¡s: " << 
fe_exi¡s
(
idxÇme
è<< 
	g¡d
::
’dl
;

351 ià(
fe_exi¡s
(
idxÇme
)) {

352 
	g”r
 = 
»move
(
idxÇme
.
c_¡r
());

353 ià(
	g”r
 !ğ0è
log¡»am
(
LOG_ERROR
è<< "E¼Ü„emovšg f" << 
idxÇme


354 << ", " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

359 
	g¡d
::
¡ršg
 
numv_f’ame
 = 
ba£_f’ame
 + ".numvertices";

360 ià(
fe_exi¡s
(
numv_f’ame
)) {

361 
	g”r
 = 
»move
(
numv_f’ame
.
c_¡r
());

362 ià(
	g”r
 !ğ0è
log¡»am
(
LOG_ERROR
è<< "E¼Ü„emovšg f" << 
numv_f’ame


363 << ", " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

367 
	g¡d
::
¡ršg
 
deg_f’ame
 = 
f’ame_deg»e_d©a
(
ba£_f’ame
);

368 ià(
fe_exi¡s
(
deg_f’ame
)) {

369 
	g”r
 = 
»move
(
deg_f’ame
.
c_¡r
());

370 ià(
	g”r
 !ğ0è
log¡»am
(
LOG_ERROR
è<< "E¼Ü„emovšg f" << 
deg_f’ame


371 << ", " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

379 
VARIABLE_IS_NOT_USED
 
lßd_v”‹x_š‹rv®s
(
¡d
::
¡ršg
 
ba£_f’ame
, 
nsh¬ds
, std::
veùÜ
<¡d::
·œ
<
vid_t
, vid_t> > & 
š‹rv®s
, 
boŞ
 
®lowç
);

380 
VARIABLE_IS_NOT_USED
 
lßd_v”‹x_š‹rv®s
(
¡d
::
¡ršg
 
ba£_f’ame
, 
nsh¬ds
, std::
veùÜ
<¡d::
·œ
<
vid_t
, vid_t> > & 
š‹rv®s
, 
boŞ
 
®lowç
=
çl£
) {

381 
¡d
::
¡ršg
 
š‹rv®sF’ame
 = 
f’ame_š‹rv®s
(
ba£_f’ame
, 
nsh¬ds
);

382 
	g¡d
::
if¡»am
 
š‹rv®sF
(
š‹rv®sF’ame
.
c_¡r
());

384 ià(!
	gš‹rv®sF
.
good
()) {

385 ià(
	g®lowç
) ;

386 
log¡»am
(
LOG_ERROR
è<< "Could‚Ù†ßd iÁ”v®s-fe: " << 
	gš‹rv®sF’ame
 << 
	g¡d
::
’dl
;

388 
as£¹
(
š‹rv®sF
.
good
());

390 
	gš‹rv®s
.
ş—r
();

392 
vid_t
 
	g¡
=0, 
	g’
;

393 
	gi
=0; i < 
	gnsh¬ds
; i++) {

394 
as£¹
(!
š‹rv®sF
.
eof
());

395 
	gš‹rv®sF
 >> 
	g’
;

396 
	gš‹rv®s
.
push_back
(
¡d
::
·œ
<
vid_t
,vid_t>(
¡
, 
’
));

397 
	g¡
 = 
’
 + 1;

399 
	gi
=0; i < 
	gnsh¬ds
; i++) {

400 
log¡»am
(
LOG_INFO
è<< "sh¬d: " << 
	gš‹rv®s
[
i
].
	gfœ¡
 << " - " << iÁ”v®s[i].
	g£cÚd
 << 
	g¡d
::
’dl
;

402 
	gš‹rv®sF
.
şo£
();

408 
VARIABLE_IS_NOT_USED
 
size_t
 
g‘_num_v”tiûs
(
¡d
::
¡ršg
 
ba£f’ame
);

409 
VARIABLE_IS_NOT_USED
 
size_t
 
g‘_num_v”tiûs
(
¡d
::
¡ršg
 
ba£f’ame
) {

410 
¡d
::
¡ršg
 
numv_f’ame
 = 
ba£f’ame
 + ".numvertices";

411 
	g¡d
::
if¡»am
 
vfeF
(
numv_f’ame
.
c_¡r
());

412 ià(!
	gvfeF
.
good
()) {

413 
log¡»am
(
LOG_ERROR
è<< "Could‚Ù fšd f" << 
	gnumv_f’ame
 << 
	g¡d
::
’dl
;

414 
log¡»am
(
LOG_ERROR
è<< "Maybyou havŞd sh¬d -…Ëa£„eü—‹." << 
	g¡d
::
’dl
;

415 
as£¹
(
çl£
);

417 
size_t
 
	gn
;

418 
	gvfeF
 >> 
	gn
;

419 
	gvfeF
.
şo£
();

420  
	gn
;

423 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

424 
	g¡d
::
¡ršg
 
´•roûss_f’ame
(
¡d
::¡ršg 
ba£f’ame
) {

425 
¡d
::
¡ršg¡»am
 
ss
;

426 
	gss
 << 
	gba£f’ame
;

427 
	gss
 << "." << (
	gEdgeD©aTy³
) << "B.bin";

428  
	gss
.
¡r
();

438 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

439 
boŞ
 
check_Üigfe_modifiÿtiÚ_—¾›r
(
¡d
::
¡ršg
 
ba£f’ame
, 
nsh¬ds
) {

441 ià(
fe_exi¡s
(
ba£f’ame
è&& 
g‘_İtiÚ_št
("disable-modtime-check", 0) == 0) {

442 
¡©
 
Üig¡©
, 
sh¬d¡©
;

443 
	g”r1
 = 
¡©
(
ba£f’ame
.
c_¡r
(), &
Üig¡©
);

445 
	g¡d
::
¡ršg
 
adjâame
 = 
f’ame_sh¬d_adj
(
ba£f’ame
, 0, 
nsh¬ds
);

446 
	g”r2
 = 
¡©
(
adjâame
.
c_¡r
(), &
sh¬d¡©
);

448 ià(
	g”r1
 !ğ0 || 
”r2
 != 0) {

449 
log¡»am
(
LOG_ERROR
è<< "E¼Ü wh’ checkšg fmodifiÿtiÚimes: " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

450  
	gnsh¬ds
;

453 ià(
	gÜig¡©
.
	g¡_mtime
 > 
	gsh¬d¡©
.st_mtime) {

454 
log¡»am
(
LOG_INFO
è<< "Thšpuˆg¿ph modifiÿtiÚ d©wa Ãw”hª oàthsh¬ds." << 
	g¡d
::
’dl
;

455 
log¡»am
(
LOG_INFO
è<< "GošgØd–‘Şd sh¬d ªd„eü—‹‚ew oÃs. TØdi§bË " << 
	g¡d
::
’dl
;

456 
log¡»am
(
LOG_INFO
è<< "funùiÚ®™y, s³cify --di§bË-modtime-check=1" << 
	g¡d
::
’dl
;

459 
	gd–‘e_sh¬ds
<
	gEdgeD©aTy³
>(
	gba£f’ame
, 
	gnsh¬ds
);

462 
	g¡d
::
¡ršg
 
´•rocfe
 = 
´•roûss_f’ame
<
EdgeD©aTy³
>(
ba£f’ame
);

463 ià(
fe_exi¡s
(
´•rocfe
)) {

464 
log¡»am
(
LOG_DEBUG
è<< "D–‘šg: " << 
	g´•rocfe
 << 
	g¡d
::
’dl
;

465 
	g”r
 = 
»move
(
´•rocfe
.
c_¡r
());

466 ià(
	g”r
 != 0) {

467 
log¡»am
(
LOG_ERROR
è<< "E¼Ü d–‘šg fe: " << 
´•rocfe
 << ", " <<

468 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

471  
	gçl£
;

473  
	gŒue
;

478  
	gŒue
;

	@api/dynamicdata/chivector.hpp

30 #iâdeà
DEF_GRAPHCHI_CHIVECTOR


31 
	#DEF_GRAPHCHI_CHIVECTOR


	)

33 
	~<veùÜ
>

34 
	~<¡dšt.h
>

36 
Çme¥aû
 
	gg¿phchi
 {

39 
	#MINCAPACITY
 2

	)

45 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

46 şas 
	cex‹nsiÚ_poŞ
 {

51 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

52 şas 
	cchiveùÜ
 {

54 
ušt16_t
 
	gnsize
;

55 
ušt16_t
 
	gnÿ·c™y
;

56 
T
 * 
	gd©a
;

57 
	g¡d
::
veùÜ
<
T
> * 
ex‹nsiÚs
;

59 
	gpublic
:

60 
T
 
	t–em’t_ty³_t
;

61 
ušt32_t
 
	tsizewÜd_t
;

62 
chiveùÜ
() {

63 
	gex‹nsiÚs
 = 
NULL
;

66 
chiveùÜ
(
ušt16_t
 
sz
, ušt16_ˆ
ÿp
, 
T
 * 
d©­Œ
è: 
d©a
(dataptr) {

67 
nsize
 = 
sz
;

68 
	gnÿ·c™y
 = 
ÿp
;

69 
as£¹
(
ÿp
 >ğ
nsize
);

70 
	gex‹nsiÚs
 = 
NULL
;

73 ~
chiveùÜ
() {

74 ià(
	gex‹nsiÚs
 !ğ
NULL
) {

75 
d–‘e
 
ex‹nsiÚs
;

76 
	gex‹nsiÚs
 = 
NULL
;

80 
wr™e
(
T
 * 
de¡
) {

81 
	gsz
 = (è
this
->
size
();

82 
	gi
=0; i < 
	gsz
; i++) {

83 
	gde¡
[
i
] = 
g‘
(i);

87 
ušt16_t
 
size
() {

88  
	gnsize
;

91 
ušt16_t
 
ÿ·c™y
() {

92  
	gnsize
 > 
	gMINCAPACITY
 ?‚siz: 
MINCAPACITY
;

95 
add
(
T
 
v®
) {

96 
	gnsize
 ++;

97 ià(
	gnsize
 > 
	gnÿ·c™y
) {

98 ià(
	gex‹nsiÚs
 =ğ
NULL
è
ex‹nsiÚs
 = 
Ãw
 
¡d
::
veùÜ
<
T
>();

99 
	gex‹nsiÚs
->
push_back
(
v®
);

101 
	gd©a
[
nsize
 - 1] = 
v®
;

105 
£t
(
idx
, 
T
 
v®
){

106 ià(
	gidx
 >ğ
nÿ·c™y
) {

107 (*
ex‹nsiÚs
)[
idx
 - ()
nÿ·c™y
] = 
v®
;

109 
	gd©a
[
idx
] = 
v®
;

115 
T
 
g‘
(
idx
) {

116 ià(
	gidx
 >ğ
nÿ·c™y
) {

117  (* 
ex‹nsiÚs
)[
idx
 - ()
nÿ·c™y
];

119  
	gd©a
[
idx
];

123 
»move
(
idx
) {

124 
as£¹
(
çl£
);

127 
fšd
(
T
 
v®
) {

128 
as£¹
(
çl£
);

132 
ş—r
() {

133 
	gnsize
 = 0;

	@api/functional/functional_api.hpp

33 #iâdeà
GRAPHCHI_FUNCTIONALAPI_DEF


34 
	#GRAPHCHI_FUNCTIONALAPI_DEF


	)

36 
	~<as£¹.h
>

38 
	~"­i/g¿ph_objeùs.hµ
"

39 
	~"­i/g¿phchi_cÚ‹xt.hµ
"

40 
	~"’gše/funùiÚ®/funùiÚ®_’gše.hµ
"

41 
	~"m‘rics/m‘rics.hµ
"

42 
	~"g¿phchi_ty³s.hµ
"

44 
	~"­i/funùiÚ®/funùiÚ®_defs.hµ
"

45 
	~"­i/funùiÚ®/funùiÚ®_£misync.hµ
"

46 
	~"­i/funùiÚ®/funùiÚ®_bulksync.hµ
"

47 
	~"´•roûssšg/cÚv”siÚs.hµ
"

49 
Çme¥aû
 
	gg¿phchi
 {

54 
	g‹m¶©e
 <
ty³Çme
 
	gFV”‹xD©aTy³
,y³Çm
	gFEdgeD©aTy³
>

55 
	sfunùiÚ®_k”Ãl
 {

57 
FV”‹xD©aTy³
 
	tV”‹xD©aTy³
;

58 
FEdgeD©aTy³
 
	tEdgeD©aTy³
;

60 
funùiÚ®_k”Ãl
() {}

63 
vœtu®
 
V”‹xD©aTy³
 
š™Ÿl_v®ue
(
g¿phchi_cÚ‹xt
 &
šfo
, 
v”‹x_šfo
& 
myv”‹x
) = 0;

65 
vœtu®
 
V”‹xD©aTy³
 
»£t
() = 0;

68 
vœtu®
 
EdgeD©aTy³
 
İ_ÃighbÜv®
(
g¿phchi_cÚ‹xt
 &
šfo
, 
v”‹x_šfo
& 
myv”‹x
, 
vid_t
 
nbid
, EdgeD©aTy³ 
nbv®
)= 0;

70 
vœtu®
 
EdgeD©aTy³
 
¶us
(
V”‹xD©aTy³
 
curv®
, EdgeD©aTy³ 
tßdd
) = 0;

72 
vœtu®
 
V”‹xD©aTy³
 
compu‹_v”‹xv®ue
(
g¿phchi_cÚ‹xt
 &
gšfo
, 
v”‹x_šfo
& 
myv”‹x
, 
EdgeD©aTy³
 
nbv®sum
) = 0;

74 
vœtu®
 
EdgeD©aTy³
 
v®ue_to_ÃighbÜ
(
g¿phchi_cÚ‹xt
 &
šfo
, 
v”‹x_šfo
& 
myv”‹x
, 
vid_t
 
nbid
, 
V”‹xD©aTy³
 
myv®
) = 0;

93 
	g‹m¶©e
 <
şass
 
	gKERNEL
>

94 
run_funùiÚ®_unweigh‹d_£misynchrÚous
(
¡d
::
¡ršg
 
f’ame
, 
n™”s
, 
m‘rics
 &
_m
) {

95 
	gFunùiÚ®Prog¿mProxySemisync
<
	gKERNEL
> 
	g´og¿m
;

98 
	gnsh¬ds


99 ğ
cÚv”t_if_nÙexi¡s
<
ty³Çme
 
FunùiÚ®Prog¿mProxySemisync
<
KERNEL
>::
EdgeD©aTy³
>(
f’ame
, 
g‘_İtiÚ_¡ršg
("nshards", "auto"));

101 
	gfunùiÚ®_’gše
<
ty³Çme
 
	gFunùiÚ®Prog¿mProxySemisync
<
	gKERNEL
>::
V”‹xD©aTy³
,

102 
ty³Çme
 
	gFunùiÚ®Prog¿mProxySemisync
<
	gKERNEL
>::
EdgeD©aTy³
,

103 
ty³Çme
 
	gFunùiÚ®Prog¿mProxySemisync
<
	gKERNEL
>::
fv”‹x_t
 >

104 
’gše
(
f’ame
, 
nsh¬ds
, 
çl£
, 
_m
);

107 
	g’gše
.
£t_modif›s_šedges
(
çl£
);

108 
	g’gše
.
£t_modif›s_ou‹dges
(
Œue
);

109 
	g’gše
.
run
(
´og¿m
, 
n™”s
);

123 
	g‹m¶©e
 <
şass
 
	gKERNEL
>

124 
run_funùiÚ®_unweigh‹d_synchrÚous
(
¡d
::
¡ršg
 
f’ame
, 
n™”s
, 
m‘rics
 &
_m
) {

125 
	gFunùiÚ®Prog¿mProxyBulkSync
<
	gKERNEL
> 
	g´og¿m
;

126 
	gnsh¬ds


127 ğ
cÚv”t_if_nÙexi¡s
<
ty³Çme
 
FunùiÚ®Prog¿mProxyBulkSync
<
KERNEL
>::
EdgeD©aTy³
>(
f’ame
, 
g‘_İtiÚ_¡ršg
("nshards", "auto"));

129 
	gfunùiÚ®_’gše
<
ty³Çme
 
	gFunùiÚ®Prog¿mProxyBulkSync
<
	gKERNEL
>::
V”‹xD©aTy³
,

130 
ty³Çme
 
	gFunùiÚ®Prog¿mProxyBulkSync
<
	gKERNEL
>::
EdgeD©aTy³
,

131 
ty³Çme
 
	gFunùiÚ®Prog¿mProxyBulkSync
<
	gKERNEL
>::
fv”‹x_t
 >

132 
’gše
(
f’ame
, 
nsh¬ds
, 
çl£
, 
_m
);

133 
	g’gše
.
£t_modif›s_šedges
(
çl£
);

134 
	g’gše
.
£t_modif›s_ou‹dges
(
Œue
);

135 
	g’gše
.
£t_’abË_d‘”mši¡ic_·¿Î–ism
(
çl£
);

136 
	g’gše
.
run
(
´og¿m
, 
n™”s
);

	@api/functional/functional_bulksync.hpp

35 #iâdeà
GRAPHCHI_FUNCTIONAL_BULKSYNC_DEF


36 
	#GRAPHCHI_FUNCTIONAL_BULKSYNC_DEF


	)

38 
	~<as£¹.h
>

41 
	~"­i/g¿ph_objeùs.hµ
"

42 
	~"­i/g¿phchi_cÚ‹xt.hµ
"

43 
	~"­i/funùiÚ®/funùiÚ®_defs.hµ
"

45 
	~"m‘rics/m‘rics.hµ
"

46 
	~"g¿phchi_ty³s.hµ
"

48 
Çme¥aû
 
	gg¿phchi
 {

51 
	g‹m¶©e
 <
ty³Çme
 
	gKERNEL
>

52 
şass
 
	gfunùiÚ®_v”‹x_unweigh‹d_bulksync
 : 
public
 
g¿phchi_v”‹x
<
ty³Çme
 
KERNEL
::
V”‹xD©aTy³
, 
	gPaœCÚš”
<ty³Çm
	gKERNEL
::
EdgeD©aTy³
> > {

53 
public
:

55 
ty³Çme
 
	tKERNEL
::
	tV”‹xD©aTy³
 
	tVT
;

56 
	gPaœCÚš”
<
	tty³Çme
 
	tKERNEL
::
	tEdgeD©aTy³
> 
	tET
;

58 
KERNEL
 
	gk”Ãl
;

60 
VT
 
	gcumv®
;

62 
v”‹x_šfo
 
	gvšfo
;

63 
g¿phchi_cÚ‹xt
 * 
	ggcÚ‹xt
;

65 
funùiÚ®_v”‹x_unweigh‹d_bulksync
(è: 
g¿phchi_v”‹x
<
VT
, 
	gET
> () {}

67 
funùiÚ®_v”‹x_unweigh‹d_bulksync
(
g¿phchi_cÚ‹xt
 &
gšfo
, 
vid_t
 
_id
, 
šdeg
, 
outdeg
) :

68 
g¿phchi_v”‹x
<
VT
, 
	gET
> (
	g_id
, 
	gNULL
, NULL, 
	gšdeg
, 
	goutdeg
) {

69 
	gvšfo
.
	gšdeg»e
 = 
šdeg
;

70 
	gvšfo
.
	goutdeg»e
 = 
outdeg
;

71 
	gvšfo
.
	gv”‹xid
 = 
_id
;

72 
	gcumv®
 = 
k”Ãl
.
»£t
();

73 
	ggcÚ‹xt
 = &
gšfo
;

76 
funùiÚ®_v”‹x_unweigh‹d_bulksync
(
vid_t
 
_id
,

77 
g¿phchi_edge
<
ET
> * 
Œ
,

78 
g¿phchi_edge
<
ET
> * 
İŒ
,

79 
šdeg
,

80 
outdeg
) {

81 
as£¹
(
çl£
);

84 
fœ¡_™”©iÚ
(
g¿phchi_cÚ‹xt
 &
gšfo
) {

85 
	gthis
->
£t_d©a
(
k”Ãl
.
š™Ÿl_v®ue
(
gšfo
, 
všfo
));

86 
	ggcÚ‹xt
 = &
gšfo
;

91 
šlše
 
add_šedge
(
vid_t
 
¤c
, 
ET
 * 
±r
, 
boŞ
 
¥ecŸl_edge
) {

92 ià(
	ggcÚ‹xt
->
	g™”©iÚ
 > 0) {

93 
g‘_lock
(
všfo
.
v”‹xid
).
lock
();

94 
	gcumv®
 = 
k”Ãl
.
¶us
(
cumv®
, k”Ãl.
İ_ÃighbÜv®
(*
gcÚ‹xt
,

95 
všfo
,

96 
¤c
,

97 
±r
->
Şdv®
(
gcÚ‹xt
->
™”©iÚ
)));

98 
g‘_lock
(
všfo
.
v”‹xid
).
uÆock
();

103 
»ady
(
g¿phchi_cÚ‹xt
 &
gšfo
) {

104 
	gthis
->
£t_d©a
(
k”Ãl
.
compu‹_v”‹xv®ue
(*
gcÚ‹xt
, 
všfo
, 
cumv®
));

107 
šlše
 
add_ou‹dge
(
vid_t
 
d¡
, 
ET
 * 
±r
, 
boŞ
 
¥ecŸl_edge
) {

108 
ty³Çme
 
	gKERNEL
::
EdgeD©aTy³
 
Ãwv®
 =

109 
k”Ãl
.
v®ue_to_ÃighbÜ
(*
gcÚ‹xt
, 
všfo
, 
d¡
, 
this
->
g‘_d©a
());

110 
ET
 
	g·œcÚt
 = *
±r
;

111 
	g·œcÚt
.
£t_Ãwv®
(
gcÚ‹xt
->
™”©iÚ
, 
Ãwv®
);

112 *
	g±r
 = 
·œcÚt
;

115 
boŞ
 
computiÚ®_edges
() {

116  
	gŒue
;

123 
boŞ
 
»ad_ou‹dges
() {

124  
	gŒue
;

130 
	g‹m¶©e
 <
ty³Çme
 
	gKERNEL
>

131 
şass
 
	gFunùiÚ®Prog¿mProxyBulkSync
 : 
public
 
G¿phChiProg¿m
<
ty³Çme
 
KERNEL
::
V”‹xD©aTy³
, 
	gPaœCÚš”
<ty³Çm
	gKERNEL
::
EdgeD©aTy³
>, 
	gfunùiÚ®_v”‹x_unweigh‹d_bulksync
<KERNEL> > {

132 
	gpublic
:

134 
ty³Çme
 
	tKERNEL
::
	tV”‹xD©aTy³
 VertexDataType;

135 
	gPaœCÚš”
<
	tty³Çme
 
	tKERNEL
::
	tEdgeD©aTy³
> EdgeDataType;

136 
	gfunùiÚ®_v”‹x_unweigh‹d_bulksync
<
	tKERNEL
> 
	tfv”‹x_t
;

141 
befÜe_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
šfo
) {

147 
aá”_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gšfo
) {

153 
befÜe_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gšfo
) {

160 
upd©e
(
fv”‹x_t
 &
v
, 
g¿phchi_cÚ‹xt
 &
gšfo
) {

161 ià(
	ggšfo
.
	g™”©iÚ
 == 0) {

162 
v
.
fœ¡_™”©iÚ
(
gšfo
);

164 
	gv
.
»ady
(
gšfo
);

	@api/functional/functional_defs.hpp

27 #iâdeà
GRAPHCHI_FUNCTIONALDEFS_DEF


28 
	#GRAPHCHI_FUNCTIONALDEFS_DEF


	)

30 
	~"­i/g¿phchi_´og¿m.hµ
"

31 
	~<veùÜ
>

32 
	~"ut/±h»ad_toŞs.hµ
"

34 
Çme¥aû
 
	gg¿phchi
 {

36 
	sv”‹x_šfo
 {

37 
vid_t
 
	gv”‹xid
;

38 
	gšdeg»e
;

39 
	goutdeg»e
;

43 
	gmu‹x
 & 
g‘_lock
(
vid_t
 
v”‹xid
) {

44 
	g¡d
::
veùÜ
<
mu‹x
> 
locks
(1024);

45  
	glocks
[
v”‹xid
 % 1024];

	@api/functional/functional_semisync.hpp

29 #iâdeà
GRAPHCHI_FUNCTIONAL_SEMISYNC_DEF


30 
	#GRAPHCHI_FUNCTIONAL_SEMISYNC_DEF


	)

32 
	~<as£¹.h
>

35 
	~"­i/g¿ph_objeùs.hµ
"

36 
	~"­i/g¿phchi_cÚ‹xt.hµ
"

37 
	~"­i/funùiÚ®/funùiÚ®_defs.hµ
"

39 
	~"m‘rics/m‘rics.hµ
"

40 
	~"g¿phchi_ty³s.hµ
"

42 
Çme¥aû
 
	gg¿phchi
 {

44 
	g‹m¶©e
 <
ty³Çme
 
	gKERNEL
>

45 şas 
	cfunùiÚ®_v”‹x_unweigh‹d_£misync
 {

46 
	gpublic
:

48 
ty³Çme
 
	tKERNEL
::
	tV”‹xD©aTy³
 
	tVT
;

49 
ty³Çme
 
	tKERNEL
::
	tEdgeD©aTy³
 
	tET
;

51 
VT
 
	gcumv®
;

53 
KERNEL
 
	gk”Ãl
;

54 
v”‹x_šfo
 
	gvšfo
;

55 
g¿phchi_cÚ‹xt
 * 
	ggcÚ‹xt
;

58 
boŞ
 
	gšc
;

59 
boŞ
 
	goutc
;

60 
boŞ
 
	gscheduËd
;

61 
boŞ
 
	gmodif›d
;

62 
boŞ
 
	g·¿Î–_§ã
;

63 
VT
 * 
	gd©­Œ
;

65 
funùiÚ®_v”‹x_unweigh‹d_£misync
() {}

67 
funùiÚ®_v”‹x_unweigh‹d_£misync
(
g¿phchi_cÚ‹xt
 &
gšfo
, 
vid_t
 
_id
, 
šdeg
, 
outdeg
) {

68 
	gvšfo
.
	gšdeg»e
 = 
šdeg
;

69 
	gvšfo
.
	goutdeg»e
 = 
outdeg
;

70 
	gvšfo
.
	gv”‹xid
 = 
_id
;

71 
	gcumv®
 = 
k”Ãl
.
»£t
();

72 
	ggcÚ‹xt
 = &
gšfo
;

75 
funùiÚ®_v”‹x_unweigh‹d_£misync
(
vid_t
 
_id
,

76 
g¿phchi_edge
<
ET
> * 
Œ
,

77 
g¿phchi_edge
<
ET
> * 
İŒ
,

78 
šdeg
,

79 
outdeg
) {

80 
as£¹
(
çl£
);

83 
fœ¡_™”©iÚ
(
g¿phchi_cÚ‹xt
 &
gcÚ‹xt_
) {

84 
	gthis
->
£t_d©a
(
k”Ãl
.
š™Ÿl_v®ue
(
gcÚ‹xt_
, 
všfo
));

89 
šlše
 
add_šedge
(
vid_t
 
¤c
, 
ET
 * 
±r
, 
boŞ
 
¥ecŸl_edge
) {

90 ià(
	ggcÚ‹xt
->
	g™”©iÚ
 > 0) {

91 
g‘_lock
(
všfo
.
v”‹xid
).
lock
();

92 
	gcumv®
 = 
k”Ãl
.
¶us
(
cumv®
, k”Ãl.
İ_ÃighbÜv®
(*
gcÚ‹xt
, 
všfo
, 
¤c
, *
±r
));

93 
g‘_lock
(
všfo
.
v”‹xid
).
uÆock
();

97 
»ady
(
g¿phchi_cÚ‹xt
 &
gcÚ‹xt_
) {

98 
	gthis
->
£t_d©a
(
k”Ãl
.
compu‹_v”‹xv®ue
(
gcÚ‹xt_
, 
všfo
, 
cumv®
));

101 
šlše
 
add_ou‹dge
(
vid_t
 
d¡
, 
ET
 * 
±r
, 
boŞ
 
¥ecŸl_edge
) {

102 *
	g±r
 = 
k”Ãl
.
v®ue_to_ÃighbÜ
(*
gcÚ‹xt
, 
všfo
, 
d¡
, 
this
->
g‘_d©a
());

105 
boŞ
 
computiÚ®_edges
() {

106  
	gŒue
;

110 
boŞ
 
»ad_ou‹dges
() {

111  
	gçl£
;

119 
vœtu®
 
£t_d©a
(
VT
 
d
) {

120 *(
	gthis
->
	gd©­Œ
èğ
d
;

121 
	gthis
->
	gmodif›d
 = 
Œue
;

124 
VT
 
g‘_d©a
() {

125  *(
	gthis
->
	gd©­Œ
);

132 
	g‹m¶©e
 <
ty³Çme
 
	gKERNEL
>

133 
şass
 
	gFunùiÚ®Prog¿mProxySemisync
 : 
public
 
G¿phChiProg¿m
<
ty³Çme
 
KERNEL
::
V”‹xD©aTy³
,y³Çm
	gKERNEL
::
EdgeD©aTy³
, 
	gfunùiÚ®_v”‹x_unweigh‹d_£misync
<KERNEL> > {

134 
	gpublic
:

135 
ty³Çme
 
	tKERNEL
::
	tV”‹xD©aTy³
 VertexDataType;

136 
ty³Çme
 
	tKERNEL
::
	tEdgeD©aTy³
 EdgeDataType;

137 
	gfunùiÚ®_v”‹x_unweigh‹d_£misync
<
	tKERNEL
> 
	tfv”‹x_t
;

142 
befÜe_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
šfo
) {

148 
aá”_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gšfo
) {

154 
befÜe_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gšfo
) {

160 
upd©e
(
fv”‹x_t
 &
v
, 
g¿phchi_cÚ‹xt
 &
gšfo
) {

161 ià(
	ggšfo
.
	g™”©iÚ
 == 0) {

162 
v
.
fœ¡_™”©iÚ
(
gšfo
);

164 
	gv
.
»ady
(
gšfo
);

	@api/graph_objects.hpp

30 #iâdeà
DEF_GRAPHCHI_OBJECTS


31 
	#DEF_GRAPHCHI_OBJECTS


	)

33 
	~<veùÜ
>

34 
	~<as£¹.h
>

35 
	~<omp.h
>

36 
	~<¡ršg.h
>

38 
	~"g¿phchi_ty³s.hµ
"

39 
	~"ut/qsÜt.hµ
"

41 
Çme¥aû
 
	gg¿phchi
 {

47 #ifdeà
__GNUC__


48 
	#VARIABLE_IS_NOT_USED
 
	`__©Œibu‹__
 ((
unu£d
))

	)

50 
	#VARIABLE_IS_NOT_USED


	)

55 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

56 şas 
	cg¿phchi_edge
 {

58 
	gpublic
:

59 
vid_t
 
v”‹xid
;

60 
EdgeD©aTy³
 * 
	gd©a_±r
;

62 
g¿phchi_edge
() {}

63 
g¿phchi_edge
(
vid_t
 
_v”‹xid
, 
EdgeD©aTy³
 * 
ed©a_±r
è: 
v”‹xid
(_v”‹xid), 
d©a_±r
(edata_ptr) {

66 #iâdeà
DYNAMICEDATA


67 
EdgeD©aTy³
 
g‘_d©a
() {

68  * 
	gd©a_±r
;

71 
£t_d©a
(
EdgeD©aTy³
 
x
) {

72 *
	gd©a_±r
 = 
x
;

75 
EdgeD©aTy³
 * 
g‘_veùÜ
() {

76  
	gd©a_±r
;

83 
vid_t
 
v”‹x_id
() {

84  
	gv”‹xid
;

88 } 
__©Œibu‹__
((
·cked
));

90 
	g‹m¶©e
 <
ty³Çme
 
	gET
>

91 
boŞ
 
•Œ_Ëss
(cÚ¡ 
g¿phchi_edge
<
ET
> &
a
, cÚ¡ g¿phchi_edge<ET> &
b
) {

92  
	ga
.
	gv”‹xid
 < 
	gb
.vertexid;

96 #ifdeà
SUPPORT_DELETIONS


106 
šlše
 
boŞ
 
VARIABLE_IS_NOT_USED
 
is_d–‘ed_edge_v®ue
(
v®
);

107 
šlše
 
boŞ
 
VARIABLE_IS_NOT_USED
 
	$is_d–‘ed_edge_v®ue
(
boŞ
 
v®
) {

108  
v®
;

109 
	}
}

111 
šlše
 
boŞ
 
VARIABLE_IS_NOT_USED
 
is_d–‘ed_edge_v®ue
(
v®
);

112 
šlše
 
boŞ
 
VARIABLE_IS_NOT_USED
 
	$is_d–‘ed_edge_v®ue
(
v®
) {

113  0xfffffffà=ğ()
v®
;

114 
	}
}

116 
šlše
 
boŞ
 
VARIABLE_IS_NOT_USED
 
is_d–‘ed_edge_v®ue
(
vid_t
 
v®
);

117 
šlše
 
boŞ
 
VARIABLE_IS_NOT_USED
 
	$is_d–‘ed_edge_v®ue
(
vid_t
 
v®
) {

118  0xffffffffu =ğ
v®
;

119 
	}
}

122 
šlše
 
boŞ
 
VARIABLE_IS_NOT_USED
 
is_d–‘ed_edge_v®ue
(
v®
);

123 
šlše
 
boŞ
 
VARIABLE_IS_NOT_USED
 
	$is_d–‘ed_edge_v®ue
(
v®
) {

124  !(
v®
 < 0 || val > 0);

125 
	}
}

127 
VARIABLE_IS_NOT_USED
 
»move_edgev
(
g¿phchi_edge
<
boŞ
> * 
e
);

128 
VARIABLE_IS_NOT_USED
 
»move_edgev
(
g¿phchi_edge
<
boŞ
> * 
e
) {

129 
	ge
->
£t_d©a
(
Œue
);

132 
VARIABLE_IS_NOT_USED
 
»move_edgev
(
g¿phchi_edge
<
vid_t
> * 
e
);

133 
VARIABLE_IS_NOT_USED
 
»move_edgev
(
g¿phchi_edge
<
vid_t
> * 
e
) {

134 
	ge
->
£t_d©a
(0xffffffff);

137 
VARIABLE_IS_NOT_USED
 
»move_edgev
(
g¿phchi_edge
<> * 
e
);

138 
VARIABLE_IS_NOT_USED
 
»move_edgev
(
g¿phchi_edge
<> * 
e
) {

139 
	ge
->
£t_d©a
(0xffffffff);

145 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
,y³Çm
	gEdgeD©aTy³
>

146 şas 
	cš‹º®_g¿phchi_v”‹x
 {

148 
	gpublic
:

149 vŞ©
šc
;

150 vŞ©
	goutc
;

152 
vid_t
 
	gv”‹xid
;

154 
	g´Ùeùed
:

155 
g¿phchi_edge
<
EdgeD©aTy³
> * 
šedges_±r
;

156 
	gg¿phchi_edge
<
	gEdgeD©aTy³
> * 
	gou‹dges_±r
;

159 
	gpublic
:

160 
boŞ
 
modif›d
;

161 
V”‹xD©aTy³
 * 
	gd©­Œ
;

165 
boŞ
 
	gscheduËd
;

166 
boŞ
 
	g·¿Î–_§ã
;

168 #ifdeà
SUPPORT_DELETIONS


169 
	gd–‘ed_šc
;

170 
	gd–‘ed_outc
;

174 
š‹º®_g¿phchi_v”‹x
(è: 
šc
(0), 
outc
(0) {

175 #ifdeà
SUPPORT_DELETIONS


176 
	gd–‘ed_outc
 = 
d–‘ed_šc
 = 0;

178 
	gd©­Œ
 = 
NULL
;

182 
š‹º®_g¿phchi_v”‹x
(
vid_t
 
_id
, 
g¿phchi_edge
<
EdgeD©aTy³
> * 
Œ
,

183 
g¿phchi_edge
<
EdgeD©aTy³
> * 
İŒ
,

184 
šdeg
,

185 
outdeg
) :

186 
v”‹xid
(
_id
), 
šedges_±r
(
Œ
), 
ou‹dges_±r
(
İŒ
) {

187 
	gšc
 = 0;

188 
	goutc
 = 0;

189 
	gscheduËd
 = 
çl£
;

190 
	gmodif›d
 = 
çl£
;

191 
	g·¿Î–_§ã
 = 
Œue
;

192 
	gd©­Œ
 = 
NULL
;

193 #ifdeà
SUPPORT_DELETIONS


194 
	gd–‘ed_šc
 = 0;

195 
	gd–‘ed_outc
 = 0;

199 
	gvœtu®
 ~
š‹º®_g¿phchi_v”‹x
() {}

202 
vid_t
 
id
() const {

203  
	gv”‹xid
;

206 
num_šedges
() const {

207  
	gšc
;

210 
num_ou‹dges
() const {

211  
	goutc
;

213 
num_edges
() const {

214  
	gšc
 + 
	goutc
;

222 
šlše
 
add_šedge
(
vid_t
 
¤c
, 
EdgeD©aTy³
 * 
±r
, 
boŞ
 
¥ecŸl_edge
) {

223 #ifdeà
SUPPORT_DELETIONS


224 ià(
	gšedges_±r
 !ğ
NULL
 && 
is_d–‘ed_edge_v®ue
(*
±r
)) {

225 
d–‘ed_šc
++;

229 
	gi
 = 
__sync_add_ªd_ãtch
(&
šc
, 1);

230 ià(
	gšedges_±r
 !ğ
NULL
)

231 
šedges_±r
[
i
 - 1] = 
g¿phchi_edge
<
EdgeD©aTy³
>(
¤c
, 
	g±r
);

233 
as£¹
(
¤c
 !ğ
v”‹xid
);

240 
šlše
 
add_ou‹dge
(
vid_t
 
d¡
, 
EdgeD©aTy³
 * 
±r
, 
boŞ
 
¥ecŸl_edge
) {

241 #ifdeà
SUPPORT_DELETIONS


242 ià(
	gou‹dges_±r
 !ğ
NULL
 && 
is_d–‘ed_edge_v®ue
(*
±r
)) {

243 
d–‘ed_outc
++;

247 
	gi
 = 
__sync_add_ªd_ãtch
(&
outc
, 1);

248 ià(
	gou‹dges_±r
 !ğ
NULL
è
ou‹dges_±r
[
i
 - 1] = 
g¿phchi_edge
<
EdgeD©aTy³
>(
d¡
, 
	g±r
);

249 
as£¹
(
d¡
 !ğ
v”‹xid
);

255 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
,y³Çm
	gEdgeD©aTy³
 >

256 
şass
 
	gg¿phchi_v”‹x
 : 
public
 
š‹º®_g¿phchi_v”‹x
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
> {

258 
	gpublic
:

260 
g¿phchi_v”‹x
(è: 
š‹º®_g¿phchi_v”‹x
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
>() { }

262 
g¿phchi_v”‹x
(
vid_t
 
_id
,

263 
g¿phchi_edge
<
EdgeD©aTy³
> * 
Œ
,

264 
g¿phchi_edge
<
EdgeD©aTy³
> * 
İŒ
,

265 
šdeg
,

266 
outdeg
) :

267 
š‹º®_g¿phchi_v”‹x
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
>(
	g_id
, 
	gŒ
, 
	gİŒ
, 
	gšdeg
, 
	goutdeg
) {}

269 
	gvœtu®
 ~
g¿phchi_v”‹x
() {}

275 
	gg¿phchi_edge
<
	gEdgeD©aTy³
> * 
edge
(
i
) {

276 ià(
	gi
 < 
	gthis
->
	gšc
è 
šedge
(
i
);

277  
ou‹dge
(
i
 - 
this
->
šc
);

281 
	gg¿phchi_edge
<
	gEdgeD©aTy³
> * 
šedge
(
i
) {

282 
as£¹
(
i
 >ğ0 && i < 
this
->
šc
);

283  &
	gthis
->
	gšedges_±r
[
i
];

286 
	gg¿phchi_edge
<
	gEdgeD©aTy³
> * 
ou‹dge
(
i
) {

287 
as£¹
(
i
 >ğ0 && i < 
this
->
outc
);

288  &
	gthis
->
	gou‹dges_±r
[
i
];

291 
	gg¿phchi_edge
<
	gEdgeD©aTy³
> * 
¿ndom_ou‹dge
() {

292 ià(
	gthis
->
	goutc
 =ğ0è 
NULL
;

293  
ou‹dge
((è(
¡d
::
abs
(
¿ndom
()è% 
this
->
outc
));

299 #iâdeà
DYNAMICVERTEXDATA


300 
V”‹xD©aTy³
 
g‘_d©a
() {

301  *(
	gthis
->
	gd©­Œ
);

305 
V”‹xD©aTy³
 * 
g‘_veùÜ
() {

306 
	gthis
->
	gmodif›d
 = 
Œue
;

307  
	gthis
->
	gd©­Œ
;

315 
vœtu®
 
£t_d©a
(
V”‹xD©aTy³
 
d
) {

316 *(
	gthis
->
	gd©­Œ
èğ
d
;

317 
	gthis
->
	gmodif›d
 = 
Œue
;

321 
boŞ
 
computiÚ®_edges
() {

322  
	gçl£
;

324 
boŞ
 
»ad_ou‹dges
() {

325  
	gŒue
;

334 
VARIABLE_IS_NOT_USED
 
sÜt_edges_šdœeù
() {

336 ià(
	gthis
->
	gšc
 !ğ(
this
->
ou‹dges_±r
 -his->
šedges_±r
)) {

338 
memmove
(&
this
->
šedges_±r
[this->
šc
],his->
ou‹dges_±r
,his->
outc
 * (
g¿phchi_edge
<
EdgeD©aTy³
>));

339 
	gthis
->
	gou‹dges_±r
 = &
this
->
šedges_±r
[this->
šc
];

341 
quickSÜt
(
this
->
šedges_±r
, (èÑhis->
šc
 +his->
outc
), 
•Œ_Ëss
<
EdgeD©aTy³
>);

346 #ifdeà
SUPPORT_DELETIONS


347 
VARIABLE_IS_NOT_USED
 
»move_edge
(
i
) {

348 
»move_edgev
(
edge
(
i
));

351 
VARIABLE_IS_NOT_USED
 
»move_šedge
(
i
) {

352 
»move_edgev
(
šedge
(
i
));

355 
VARIABLE_IS_NOT_USED
 
»move_ou‹dge
(
i
) {

356 
»move_edgev
(
ou‹dge
(
i
));

359 
VARIABLE_IS_NOT_USED
 
»move_®Ëdges
() {

360 
	gj
=
this
->
num_edges
()-1; j>=0; j--è
»move_edge
(
j
);

364 
VARIABLE_IS_NOT_USED
 
»move_®lou‹dges
() {

365 
	gj
=
this
->
num_ou‹dges
()-1; j>=0; j--è
»move_ou‹dge
(
j
);

368 
VARIABLE_IS_NOT_USED
 
»move_®lšedges
() {

369 
	gj
=
this
->
num_šedges
()-1; j>=0; j--è
»move_šedge
(
j
);

385 
	#HIGHMASK
 (1 + (2147483647 >> 1))

	)

386 
	#CLEARMASK
 (2147483647 >> 1)

	)

387 
šlše
 
vid_t
 
	$Œª¦©e_edge
(
vid_t
 
¿wid
, 
boŞ
 &
is_¥ecŸl
) {

388 
is_¥ecŸl
 = (
¿wid
 & 
HIGHMASK
) != 0;

389  
¿wid
 & 
CLEARMASK
;

390 
	}
}

391 
šlše
 
vid_t
 
	$make_¥ecŸl
(
vid_t
 
¿wid
) {

392  
¿wid
 | 
HIGHMASK
;

393 
	}
}

394 
šlše
 
boŞ
 
	$is_¥ecŸl
(
vid_t
 
¿wid
) {

395  (
¿wid
 & 
HIGHMASK
) != 0;

396 
	}
}

	@api/graphchi_context.hpp

32 #iâdeà
DEF_GRAPHCHI_CONTEXT


33 
	#DEF_GRAPHCHI_CONTEXT


	)

35 
	~<veùÜ
>

36 
	~<as£¹.h
>

37 
	~<omp.h
>

38 
	~<sys/time.h
>

40 
	~"g¿phchi_ty³s.hµ
"

41 
	~"­i/ischeduËr.hµ
"

43 
Çme¥aû
 
	gg¿phchi
 {

45 
	sg¿phchi_cÚ‹xt
 {

47 
size_t
 
	gnv”tiûs
;

48 
size_t
 
	gÃdges
;

50 
ischeduËr
 * 
	gscheduËr
;

51 
	g™”©iÚ
;

52 
	gnum_™”©iÚs
;

53 
	gÏ¡_™”©iÚ
;

54 
	gexeùh»ads
;

55 
	g¡d
::
veùÜ
<> 
d–s
;

56 
timev®
 
	g¡¬t
;

57 
	g¡d
::
¡ršg
 
f’ame
;

58 
	gÏ¡_d–sum
;

60 
g¿phchi_cÚ‹xt
(è: 
scheduËr
(
NULL
), 
™”©iÚ
(0), 
Ï¡_™”©iÚ
(-1) {

61 
g‘timeofday
(&
¡¬t
, 
NULL
);

62 
	gÏ¡_d–sum
 = 0.0;

65 
ruÁime
() {

66 
timev®
 
	g’d
;

67 
g‘timeofday
(&
’d
, 
NULL
);

68  
	g’d
.
	gtv_£c
-
	g¡¬t
.tv_£c+ (()Ónd.
	gtv_u£c
-start.tv_usec))/1.0E6;

74 
£t_Ï¡_™”©iÚ
(
_Ï¡_™”©iÚ
) {

75 
	gÏ¡_™”©iÚ
 = 
_Ï¡_™”©iÚ
;

78 
»£t_d–s
(
Áh»ads
) {

79 
	gd–s
 = 
¡d
::
veùÜ
<>(
Áh»ads
, 0.0);

82 
g‘_d–
() {

83 
	gd
 = 0.0;

84 
	gi
=0; i < ()
	gd–s
.
size
(); i++) {

85 
	gd
 +ğ
d–s
[
i
];

87 
	gÏ¡_d–sum
 = 
d
;

88  
	gd
;

91 
šlše
 
boŞ
 
i¢ª
(
x
) {

92  !(
	gx
<0 || x>=0);

101 
log_chªge
(
d–
) {

102 
	gd–s
[
omp_g‘_th»ad_num
()] +ğ
d–
;

103 
as£¹
(
d–
 >= 0);

104 
as£¹
(!
i¢ª
(
d–
));

	@api/graphchi_program.hpp

32 #iâdeà
GRAPHCHI_PROGRAM_DEF


33 
	#GRAPHCHI_PROGRAM_DEF


	)

35 
	~"­i/g¿ph_objeùs.hµ
"

36 
	~"­i/g¿phchi_cÚ‹xt.hµ
"

38 
Çme¥aû
 
	gg¿phchi
 {

40 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³_
,y³Çm
	gEdgeD©aTy³_
,

41 
ty³Çme
 
	gv”‹x_t
 = 
g¿phchi_v”‹x
<
V”‹xD©aTy³_
, 
	gEdgeD©aTy³_
> >

42 şas 
	cG¿phChiProg¿m
 {

44 
	gpublic
:

45 
V”‹xD©aTy³_
 
	tV”‹xD©aTy³
;

46 
EdgeD©aTy³_
 
	tEdgeD©aTy³
;

48 
	gvœtu®
 ~
G¿phChiProg¿m
() {}

53 
vœtu®
 
befÜe_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

59 
vœtu®
 
aá”_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

66 
vœtu®
 
boŞ
 
»³©_upd©es
(
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

67  
	gçl£
;

75 
vœtu®
 
befÜe_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

81 
vœtu®
 
aá”_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

87 
vœtu®
 
upd©e
(
v”‹x_t
 &
v
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) = 0;

	@api/graphlab2_1_GAS_api/assertions.hpp

58 #iâdeà
_ASSERTIONS_H_


59 
	#_ASSERTIONS_H_


	)

61 
	~<¡d¬g.h
>

62 
	~<¡dlib.h
>

63 
	~<¡dio.h
>

64 #ifdeà
HAVE_UNISTD_H


65 
	~<uni¡d.h
>

67 
	~<¡ršg.h
>

68 
	~<as£¹.h
>

69 
	~<”ºo.h
>

70 
	~<s¡»am
>

71 
	~<ÿs£¹
>

73 
	~"logg”/logg”.hµ
"

74 
	~<boo¡/ty³of/ty³of.hµ
>

76 
	$__´št_back_Œaû
() {

77 
	`log¡»am
(
LOG_ERROR
è<< "G¿phCh˜dÛ nÙ cu¼’y havth_´št_back_Œaû im¶em’tiÚ!" << 
¡d
::
’dl
;

78 
	}
}

84 
	#WRITE_TO_STDERR
(
buf
, 
Ën
è(
	`logbuf
(
LOG_FATAL
, buf,†’))

	)

90 
	#CHECK
(
cÚd™iÚ
) \

92 ià(
	`__butš_ex³ù
(!(
cÚd™iÚ
), 0)) { \

93 
	`log¡»am
(
LOG_ERROR
) \

94 << "Check faed: " << #cÚd™iÚ << 
¡d
::
’dl
; \

95 
	`__´št_back_Œaû
(); \

96 
	`throw
("assertion failure"); \

98 } 0)

	)

103 
	#PCHECK
(
cÚd™iÚ
) \

105 ià(
	`__butš_ex³ù
(!(
cÚd™iÚ
), 0)) { \

106 cÚ¡ 
_PCHECK_”r_no_
 = 
”ºo
; \

107 
	`log¡»am
(
LOG_ERROR
) \

109 << 
	`¡»¼Ü
(
”r_no
è<< 
¡d
::
’dl
; \

110 
	`__´št_back_Œaû
(); \

111 
	`throw
("assertion failure"); \

113 } 0)

	)

121 
	#CHECK_OP
(
İ
, 
v®1
, 
v®2
) \

123 cÚ¡ 
	`ty³of
(
v®1
è
_CHECK_OP_v1_
 = val1; \

124 cÚ¡ 
	`ty³of
(
v®2
è
_CHECK_OP_v2_
 = (typeof(val2))val2; \

125 ià(
	`__butš_ex³ù
(!((
_CHECK_OP_v1_
è
İ
 \

126 (
	`ty³of
(
v®1
))(
_CHECK_OP_v2_
)), 0)) { \

127 
	`log¡»am
(
LOG_ERROR
) \

131 << 
_CHECK_OP_v1_
 \

133 << 
_CHECK_OP_v2_
 << "]" << 
¡d
::
’dl
; \

134 
	`__´št_back_Œaû
(); \

135 
	`throw
("assertion failure"); \

137 } 0)

	)

139 
	#CHECK_EQ
(
v®1
, 
v®2
è
	`CHECK_OP
(==, v®1, v®2)

	)

140 
	#CHECK_NE
(
v®1
, 
v®2
è
	`CHECK_OP
(!=, v®1, v®2)

	)

141 
	#CHECK_LE
(
v®1
, 
v®2
è
	`CHECK_OP
(<=, v®1, v®2)

	)

142 
	#CHECK_LT
(
v®1
, 
v®2
è
	`CHECK_OP
(< , v®1, v®2)

	)

143 
	#CHECK_GE
(
v®1
, 
v®2
è
	`CHECK_OP
(>=, v®1, v®2)

	)

144 
	#CHECK_GT
(
v®1
, 
v®2
è
	`CHECK_OP
(> , v®1, v®2)

	)

147 
	#EXPECT_EQ
(
v®1
, 
v®2
è
	`CHECK_EQ
(v®1, v®2)

	)

148 
	#EXPECT_NE
(
v®1
, 
v®2
è
	`CHECK_NE
(v®1, v®2)

	)

149 
	#EXPECT_LE
(
v®1
, 
v®2
è
	`CHECK_LE
(v®1, v®2)

	)

150 
	#EXPECT_LT
(
v®1
, 
v®2
è
	`CHECK_LT
(v®1, v®2)

	)

151 
	#EXPECT_GE
(
v®1
, 
v®2
è
	`CHECK_GE
(v®1, v®2)

	)

152 
	#EXPECT_GT
(
v®1
, 
v®2
è
	`CHECK_GT
(v®1, v®2)

	)

153 
	#ASSERT_EQ
(
v®1
, 
v®2
è
	`EXPECT_EQ
(v®1, v®2)

	)

154 
	#ASSERT_NE
(
v®1
, 
v®2
è
	`EXPECT_NE
(v®1, v®2)

	)

155 
	#ASSERT_LE
(
v®1
, 
v®2
è
	`EXPECT_LE
(v®1, v®2)

	)

156 
	#ASSERT_LT
(
v®1
, 
v®2
è
	`EXPECT_LT
(v®1, v®2)

	)

157 
	#ASSERT_GE
(
v®1
, 
v®2
è
	`EXPECT_GE
(v®1, v®2)

	)

158 
	#ASSERT_GT
(
v®1
, 
v®2
è
	`EXPECT_GT
(v®1, v®2)

	)

160 
	#EXPECT_TRUE
(
cÚd
è
	`CHECK
(cÚd)

	)

161 
	#EXPECT_FALSE
(
cÚd
è
	`CHECK
(!(cÚd))

	)

162 
	#EXPECT_STREQ
(
a
, 
b
è
	`CHECK
(
	`¡rcmp
×, bè=ğ0)

	)

163 
	#ASSERT_TRUE
(
cÚd
è
	`EXPECT_TRUE
(cÚd)

	)

164 
	#ASSERT_FALSE
(
cÚd
è
	`EXPECT_FALSE
(cÚd)

	)

165 
	#ASSERT_STREQ
(
a
, 
b
è
	`EXPECT_STREQ
×, b)

	)

168 
	#ASSERT_MSG
(
cÚd™iÚ
, 
fmt
, ...) \

170 ià(
	`__butš_ex³ù
(!(
cÚd™iÚ
), 0)) { \

171 
	`log¡»am
(
LOG_ERROR
) \

173 
	`logg”
(
LOG_ERROR
, 
fmt
, ##
__VA_ARGS__
); \

174 
	`__´št_back_Œaû
(); \

175 
	`throw
("assertion failure"); \

177 } 0)

	)

180 
	#CHECK_ERR
(
švoÿtiÚ
è
	`PCHECK
((švoÿtiÚè!ğ-1)

	)

183 #ifdeà
NDEBUG


184 
	#DCHECK_EQ
(
v®1
, 
v®2
)

	)

185 
	#DCHECK_NE
(
v®1
, 
v®2
)

	)

186 
	#DCHECK_LE
(
v®1
, 
v®2
)

	)

187 
	#DCHECK_LT
(
v®1
, 
v®2
)

	)

188 
	#DCHECK_GE
(
v®1
, 
v®2
)

	)

189 
	#DCHECK_GT
(
v®1
, 
v®2
)

	)

190 
	#DASSERT_TRUE
(
cÚd
)

	)

191 
	#DASSERT_FALSE
(
cÚd
)

	)

192 
	#DASSERT_MSG
(
cÚd™iÚ
, 
fmt
, ...)

	)

195 
	#DCHECK_EQ
(
v®1
, 
v®2
è
	`CHECK_EQ
(v®1, v®2)

	)

196 
	#DCHECK_NE
(
v®1
, 
v®2
è
	`CHECK_NE
(v®1, v®2)

	)

197 
	#DCHECK_LE
(
v®1
, 
v®2
è
	`CHECK_LE
(v®1, v®2)

	)

198 
	#DCHECK_LT
(
v®1
, 
v®2
è
	`CHECK_LT
(v®1, v®2)

	)

199 
	#DCHECK_GE
(
v®1
, 
v®2
è
	`CHECK_GE
(v®1, v®2)

	)

200 
	#DCHECK_GT
(
v®1
, 
v®2
è
	`CHECK_GT
(v®1, v®2)

	)

201 
	#DASSERT_TRUE
(
cÚd
è
	`ASSERT_TRUE
(cÚd)

	)

202 
	#DASSERT_FALSE
(
cÚd
è
	`ASSERT_FALSE
(cÚd)

	)

203 
	#DASSERT_MSG
(
cÚd™iÚ
, 
fmt
, ...) \

205 ià(
	`__butš_ex³ù
(!(
cÚd™iÚ
), 0)) { \

206 
	`log¡»am
(
LOG_ERROR
) \

208 
	`logg”
(
LOG_ERROR
, 
fmt
, ##
__VA_ARGS__
); \

209 
	`__´št_back_Œaû
(); \

210 
	`throw
("assertion failure"); \

212 } 0)

	)

217 #ifdeà
ERROR


218 #undeà
ERROR


	@api/graphlab2_1_GAS_api/graphchi_graphlabv2_1.hpp

29 #iâdeà
DEF_GRAPHLAB_WRAPPERS


30 
	#DEF_GRAPHLAB_WRAPPERS


	)

32 
	~"g¿phchi_basic_šşudes.hµ
"

34 
usšg
 
Çme¥aû
 
	gg¿phchi
;

37 
Çme¥aû
 
	gg¿phÏb
 {

39 
	sIS_POD_TYPE
 { };

40 
	sem±y
 {};

42 
	eedge_dœ_ty³
 {

48 
	gNO_EDGES
 = 0,

53 
	gIN_EDGES
 = 1,

58 
	gOUT_EDGES
 = 2 ,

65 
	gALL_EDGES
 = 3

69 
vid_t
 
	tv”‹x_id_ty³
;

71 
	g‹m¶©e
<
ty³Çme
 
	gG¿phTy³
,

72 
ty³Çme
 
	gG©h”Ty³
,

73 
ty³Çme
 
	gMes§geTy³
>

74 şas 
	cicÚ‹xt
 {

75 
	gpublic
:

81 
G¿phTy³
 
	tg¿ph_ty³
;

87 
ty³Çme
 
	tg¿ph_ty³
::
	tv”‹x_ty³
 vertex_type;

93 
ty³Çme
 
	tg¿ph_ty³
::
	tv”‹x_id_ty³
 vertex_id_type;

99 
Mes§geTy³
 
	tmes§ge_ty³
;

105 
G©h”Ty³
 
	tg©h”_ty³
;

108 
g¿phchi_cÚ‹xt
 * 
	ggcÚ‹xt
;

112 
	gpublic
:

114 
icÚ‹xt
(
g¿phchi_cÚ‹xt
 * 
gcÚ‹xt
) : gcontext(gcontext) {}

117 
vœtu®
 ~
icÚ‹xt
() { }

124 
vœtu®
 
size_t
 
num_v”tiûs
(ècÚ¡ {  
gcÚ‹xt
->
nv”tiûs
; }

133 
vœtu®
 
size_t
 
num_edges
(ècÚ¡ { 
as£¹
(
çl£
);  0; }

145 
vœtu®
 
size_t
 
´ocid
(ècÚ¡ {  (
	gsize_t
è
omp_g‘_th»ad_num
(); }

161 
vœtu®
 
	g¡d
::
o¡»am
& 
cout
(ècÚ¡ {  
¡d
::cout; }

177 
vœtu®
 
	g¡d
::
o¡»am
& 
û¼
(ècÚ¡ {  
¡d
::cerr; }

190 
vœtu®
 
size_t
 
num_´ocs
(ècÚ¡ {  
	ggcÚ‹xt
->
	gexeùh»ads
; }

197 
vœtu®
 
–­£d_£cÚds
(ècÚ¡ {  
	ggcÚ‹xt
->
ruÁime
(); }

205 
vœtu®
 
™”©iÚ
(ècÚ¡ {  
	ggcÚ‹xt
->
	g™”©iÚ
; }

217 
vœtu®
 
¡İ
() {

218 
	ggcÚ‹xt
->
	gÏ¡_™”©iÚ
 = 
gcÚ‹xt
->
™”©iÚ
;

239 
vœtu®
 
sigÇl
(cÚ¡ 
v”‹x_ty³
& 
v”‹x
,

240 cÚ¡ 
mes§ge_ty³
& 
mes§ge
 = message_type()) {

241 
gcÚ‹xt
->
scheduËr
->
add_sk
(
v”‹x
.
id
());

255 
vœtu®
 
sigÇl_vid
(
v”‹x_id_ty³
 
gvid
,

256 cÚ¡ 
mes§ge_ty³
& 
mes§ge
 = message_type()) {

257 
gcÚ‹xt
->
scheduËr
->
add_sk
(
gvid
);

284 
vœtu®
 
po¡_d–
(cÚ¡ 
v”‹x_ty³
& 
v”‹x
,

285 cÚ¡ 
g©h”_ty³
& 
d–
) {

286 
as£¹
(
çl£
);

297 
vœtu®
 
ş—r_g©h”_ÿche
(cÚ¡ 
v”‹x_ty³
& 
v”‹x
) {

298 
as£¹
(
çl£
);

305 
	g‹m¶©e
 <
ty³Çme
 
	gGLV”‹xD©aTy³
,y³Çm
	gEdgeD©aTy³
>

306 
	gG¿phLabV”‹xW¿µ”
;

308 
	g‹m¶©e
 <
ty³Çme
 
	gGLV”‹xD©aTy³
,y³Çm
	gEdgeD©aTy³
>

309 
	gG¿phLabEdgeW¿µ”
;

313 
	g‹m¶©e
 <
ty³Çme
 
	gv”‹x_d©a
,y³Çm
	gedge_d©a
>

314 
	sdi¡ribu‹d_g¿ph
 {

315 
v”‹x_d©a
 
	tv”‹x_d©a_ty³
;

316 
edge_d©a
 
	tedge_d©a_ty³
;

317 
	gG¿phLabV”‹xW¿µ”
<
	tv”‹x_d©a_ty³
, 
	tedge_d©a_ty³
> 
	tv”‹x_ty³
;

318 
	gG¿phLabEdgeW¿µ”
<
	tv”‹x_d©a_ty³
, 
	tedge_d©a_ty³
> 
	tedge_ty³
;

319 
	gg¿phchi
::
	tvid_t
 
	tv”‹x_id_ty³
;

324 
	g‹m¶©e
<
ty³Çme
 
	gG¿ph
,

325 
ty³Çme
 
	gG©h”Ty³
,y³Çm
	gMes§geTy³
 = 
boŞ
>

326 
	siv”‹x_´og¿m
 {

329 
ty³Çme
 
	tG¿ph
::
	tv”‹x_d©a_ty³
 vertex_data_type;

330 
ty³Çme
 
	tG¿ph
::
	tedge_d©a_ty³
ƒdge_data_type;

331 
G©h”Ty³
 
	tg©h”_ty³
;

332 
Mes§geTy³
 
	tmes§ge_ty³
;

334 
G¿ph
 
	tg¿ph_ty³
;

335 
ty³Çme
 
	tg¿phchi
::
	tvid_t
 
	tv”‹x_id_ty³
;

336 
	gG¿phLabV”‹xW¿µ”
<
	tv”‹x_d©a_ty³
, 
	tedge_d©a_ty³
> 
	tv”‹x_ty³
;

337 
	gG¿phLabEdgeW¿µ”
<
	tv”‹x_d©a_ty³
, 
	tedge_d©a_ty³
> 
	tedge_ty³
;

338 
	gicÚ‹xt
<
	tg¿ph_ty³
, 
	tg©h”_ty³
, 
	tmes§ge_ty³
> 
	ticÚ‹xt_ty³
;

340 
	gg¿phÏb
::
	tedge_dœ_ty³
ƒdge_dir_type;

342 
vœtu®
 
š™
(
icÚ‹xt_ty³
& 
cÚ‹xt
,

343 cÚ¡ 
v”‹x_ty³
& 
v”‹x
,

344 cÚ¡ 
mes§ge_ty³
& 
msg
) { }

350 
vœtu®
 
edge_dœ_ty³
 
g©h”_edges
(
icÚ‹xt_ty³
& 
cÚ‹xt
,

351 cÚ¡ 
v”‹x_ty³
& 
v”‹x
) const {

352  
	gIN_EDGES
;

360 
vœtu®
 
g©h”_ty³
 
g©h”
(
icÚ‹xt_ty³
& 
cÚ‹xt
,

361 cÚ¡ 
v”‹x_ty³
& 
v”‹x
,

362 
edge_ty³
& 
edge
) const {

363 
log¡»am
(
LOG_FATAL
è<< "G©h”‚Ù im¶em’‹d!" << 
	g¡d
::
’dl
;

364  
g©h”_ty³
();

371 
vœtu®
 
­¶y
(
icÚ‹xt_ty³
& 
cÚ‹xt
,

372 
v”‹x_ty³
& 
v”‹x
,

373 cÚ¡ 
g©h”_ty³
& 
tÙ®
) = 0;

379 
vœtu®
 
edge_dœ_ty³
 
sÿ‰”_edges
(
icÚ‹xt_ty³
& 
cÚ‹xt
,

380 cÚ¡ 
v”‹x_ty³
& 
v”‹x
) const {

381  
	gOUT_EDGES
;

389 
vœtu®
 
sÿ‰”
(
icÚ‹xt_ty³
& 
cÚ‹xt
, cÚ¡ 
v”‹x_ty³
& 
v”‹x
,

390 
edge_ty³
& 
edge
) const {

391 
log¡»am
(
LOG_FATAL
è<< "Sÿ‰”‚Ù im¶em’‹d!" << 
	g¡d
::
’dl
;

395 
	g‹m¶©e
 <
ty³Çme
 
	gGLV”‹xD©aTy³
,y³Çm
	gEdgeD©aTy³
>

396 
	sG¿phLabV”‹xW¿µ”
 {

397 
	gg¿phchi_v”‹x
<
	tboŞ
, 
	tEdgeD©aTy³
> 
	tV”‹xTy³
;

398 
GLV”‹xD©aTy³
 
	tv”‹x_d©a_ty³
;

399 
	gG¿phLabV”‹xW¿µ”
<
	tGLV”‹xD©aTy³
, 
	tEdgeD©aTy³
> 
	tv”‹x_ty³
;

401 
	gg¿phchi
::
vid_t
 
v”‹xId
;

402 
V”‹xTy³
 * 
	gv”‹x
;

403 
	g¡d
::
veùÜ
<
GLV”‹xD©aTy³
> * 
v”‹xA¼ay
;

405 
G¿phLabV”‹xW¿µ”
(
g¿phchi
::
vid_t
 
v”‹xId
, 
V”‹xTy³
 * 
v”‹x
,

406 
¡d
::
veùÜ
<
GLV”‹xD©aTy³
> * 
v”‹xA¼ay
): 
v”‹xId
(vertexId),

407 
v”‹x
(v”‹x), 
v”‹xA¼ay
(vertexArray) { }

409 
boŞ
 
	gİ”©Ü
==(
v”‹x_ty³
& 
Ùh”
) const {

410  
v”‹xId
 =ğ
Ùh”
.vertexId;

414 cÚ¡ 
	gv”‹x_d©a_ty³
& 
d©a
() const {

415  (*
	gv”‹xA¼ay
)[
v”‹xId
];

419 
	gv”‹x_d©a_ty³
& 
d©a
() {

420  (*
	gv”‹xA¼ay
)[
v”‹xId
];

424 
size_t
 
num_š_edges
() const {

425 ià(
	gv”‹x
 =ğ
NULL
) {

426 
log¡»am
(
LOG_ERROR
è<< "G¿phCh˜dÛ nÙ suµÜˆaskšg‚eighbÜ v”tiû š/ouˆdeg»es." << 
¡d
::
’dl
;

429  
	gv”‹x
->
num_edges
();

433 
size_t
 
num_out_edges
() const {

434 ià(
	gv”‹x
 =ğ
NULL
) {

435 
log¡»am
(
LOG_ERROR
è<< "G¿phCh˜dÛ nÙ suµÜˆaskšg‚eighbÜ v”tiû š/ouˆdeg»es." << 
¡d
::
’dl
;

438  
	gv”‹x
->
num_ou‹dges
();

442 
	gg¿phchi
::
vid_t
 
id
() const {

443  
v”‹xId
;

449 
	gg¿phchi
::
vid_t
 
loÿl_id
() const {

450  
v”‹xId
;

456 
	g‹m¶©e
 <
ty³Çme
 
	gGLV”‹xD©aTy³
,y³Çm
	gEdgeD©aTy³
>

457 
	sG¿phLabEdgeW¿µ”
 {

458 
	gg¿phchi_v”‹x
<
	tboŞ
, 
	tEdgeD©aTy³
> 
	tV”‹xTy³
;

459 
GLV”‹xD©aTy³
 
	tv”‹x_d©a_ty³
;

460 
EdgeD©aTy³
 
	tedge_d©a_ty³
;

461 
	gG¿phLabV”‹xW¿µ”
<
	tGLV”‹xD©aTy³
, 
	tEdgeD©aTy³
> 
	tv”‹x_ty³
;

463 
	gg¿phchi_edge
<
	gEdgeD©aTy³
> * 
	gedge
;

464 
V”‹xTy³
 * 
	gv”‹x
;

465 
	g¡d
::
veùÜ
<
GLV”‹xD©aTy³
> * 
v”‹xA¼ay
;

466 
boŞ
 
	gis_šedge
;

468 
G¿phLabEdgeW¿µ”
(
g¿phchi_edge
<
EdgeD©aTy³
> * 
edge
, 
V”‹xTy³
 * 
v”‹x
,

469 
¡d
::
veùÜ
<
GLV”‹xD©aTy³
> * 
v”‹xA¼ay
, 
boŞ
 
is_šedge
):

470 
edge
Ódge), 
v”‹x
(v”‹x), 
v”‹xA¼ay
(v”‹xA¼ay), 
is_šedge
(is_inedge) { }

473 
	gpublic
:

486 
v”‹x_ty³
 
sourû
() const {

487 ià(
is_šedge
) {

488  
G¿phLabV”‹xW¿µ”
<
GLV”‹xD©aTy³
, 
	gEdgeD©aTy³
>(
	gv”‹x
->
id
(), v”‹x, 
	gv”‹xA¼ay
);

490  
	gG¿phLabV”‹xW¿µ”
<
	gGLV”‹xD©aTy³
, 
	gEdgeD©aTy³
>(
	gedge
->
v”‹x_id
(), 
	gNULL
, 
	gv”‹xA¼ay
);

506 
v”‹x_ty³
 
rg‘
() const {

507 ià(!
	gis_šedge
) {

508  
	gG¿phLabV”‹xW¿µ”
<
	gGLV”‹xD©aTy³
, 
	gEdgeD©aTy³
>(
	gv”‹x
->
id
(), v”‹x, 
	gv”‹xA¼ay
);

510  
	gG¿phLabV”‹xW¿µ”
<
	gGLV”‹xD©aTy³
, 
	gEdgeD©aTy³
>(
	gedge
->
v”‹x_id
(), 
	gNULL
, 
	gv”‹xA¼ay
);

517 cÚ¡ 
	gedge_d©a_ty³
& 
d©a
(ècÚ¡ {  
	gcÚ¡_ÿ¡
<edge_d©a_ty³&>(*
	gedge
->
	gd©a_±r
); }

522 
	gedge_d©a_ty³
& 
d©a
(è{  *(
	gedge
->
	gd©a_±r
); }

527 
	g‹m¶©e
 <
şass
 
	gG¿phLabV”‹xProg¿m
>

528 
	gG¿phLabW¿µ”
 : 
public
 
G¿phChiProg¿m
<
boŞ
, 
ty³Çme
 
	gG¿phLabV”‹xProg¿m
::
edge_d©a_ty³
> {

529 
boŞ
 
	tV”‹xD©aTy³
;

530 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tv”‹x_d©a_ty³
 
	tGLV”‹xD©aTy³
;

531 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tedge_d©a_ty³
 
	tEdgeD©aTy³
;

532 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tg©h”_ty³
 gather_type;

533 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tg¿ph_ty³
 graph_type;

534 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tmes§ge_ty³
 message_type;

536 
	g¡d
::
veùÜ
<
GLV”‹xD©aTy³
> * 
v”‹xInmemÜyA¼ay
;

538 
G¿phLabW¿µ”
() {

539 
	gv”‹xInmemÜyA¼ay
 = 
Ãw
 
¡d
::
veùÜ
<
GLV”‹xD©aTy³
>();

545 
vœtu®
 
befÜe_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

546 ià(
	ggcÚ‹xt
.
	g™”©iÚ
 == 0) {

547 
log¡»am
(
LOG_INFO
è<< "In™Ÿlizv”tiû š memÜy." << 
¡d
::
’dl
;

548 
	gv”‹xInmemÜyA¼ay
->
»size
(
gcÚ‹xt
.
nv”tiûs
);

555 
vœtu®
 
aá”_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

561 
vœtu®
 
befÜe_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

567 
vœtu®
 
aá”_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

573 
upd©e
(
g¿phchi_v”‹x
<
boŞ
, 
EdgeD©aTy³
> &
v”‹x
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

574 
	gg¿phÏb
::
icÚ‹xt
<
g¿ph_ty³
, 
	gg©h”_ty³
, 
	gmes§ge_ty³
> 
glcÚ‹xt
(&
gcÚ‹xt
);

577 
	gG¿phLabV”‹xW¿µ”
<
	gGLV”‹xD©aTy³
, 
	gEdgeD©aTy³
> 
w¿µ”V”‹x
(
v”‹x
.
id
(), &v”‹x, 
v”‹xInmemÜyA¼ay
);

578 
G¿phLabV”‹xProg¿m
 
	gglV”‹xProg¿m
;

581 
	gglV”‹xProg¿m
.
š™
(
glcÚ‹xt
, 
w¿µ”V”‹x
, 
ty³Çme
 
G¿phLabV”‹xProg¿m
::
mes§ge_ty³
());

582 cÚ¡ 
	gG¿phLabV”‹xProg¿m
& 
	gcÚ¡_v´og
 = 
glV”‹xProg¿m
;

585 
edge_dœ_ty³
 
	gg©h”_dœeùiÚ
 = 
cÚ¡_v´og
.
g©h”_edges
(
glcÚ‹xt
, 
w¿µ”V”‹x
);

586 
g©h”_ty³
 
	gsum
;

588 
	gg©h”ed
 = 0;

589 
	gg©h”_dœeùiÚ
) {

590 
	gALL_EDGES
:

591 
IN_EDGES
:

592 
i
=0; 
	gi
 < 
	gv”‹x
.
num_šedges
(); i++) {

593 
	gG¿phLabEdgeW¿µ”
<
	gGLV”‹xD©aTy³
, 
	gEdgeD©aTy³
> 
edgeW¿µ”
(
v”‹x
.
šedge
(
i
), &v”‹x, 
v”‹xInmemÜyA¼ay
, 
Œue
);

594 ià(
	gg©h”ed
 > 0è
	gsum
 +ğ
cÚ¡_v´og
.
g©h”
(
glcÚ‹xt
, 
w¿µ”V”‹x
, 
edgeW¿µ”
);

595 
	gsum
 = 
cÚ¡_v´og
.
g©h”
(
glcÚ‹xt
, 
w¿µ”V”‹x
, 
edgeW¿µ”
);

596 
	gg©h”ed
++;

598 ià(
	gg©h”_dœeùiÚ
 !ğ
ALL_EDGES
)

600 
	gOUT_EDGES
:

601 
i
=0; 
	gi
 < 
	gv”‹x
.
num_ou‹dges
(); i++) {

602 
	gG¿phLabEdgeW¿µ”
<
	gGLV”‹xD©aTy³
, 
	gEdgeD©aTy³
> 
edgeW¿µ”
(
v”‹x
.
ou‹dge
(
i
), &v”‹x, 
v”‹xInmemÜyA¼ay
, 
çl£
);

603 ià(
	gg©h”ed
 > 0è
	gsum
 +ğ
cÚ¡_v´og
.
g©h”
(
glcÚ‹xt
, 
w¿µ”V”‹x
, 
edgeW¿µ”
);

604 
	gsum
 = 
cÚ¡_v´og
.
g©h”
(
glcÚ‹xt
, 
w¿µ”V”‹x
, 
edgeW¿µ”
);

605 
	gg©h”ed
++;

608 
	gNO_EDGES
:

611 
as£¹
(
çl£
);

616 
	gglV”‹xProg¿m
.
­¶y
(
glcÚ‹xt
, 
w¿µ”V”‹x
, 
sum
);

619 
edge_dœ_ty³
 
	gsÿ‰”_dœeùiÚ
 = 
cÚ¡_v´og
.
sÿ‰”_edges
(
glcÚ‹xt
, 
w¿µ”V”‹x
);

621 
	gsÿ‰”_dœeùiÚ
) {

622 
	gALL_EDGES
:

623 
IN_EDGES
:

624 
i
=0; 
	gi
 < 
	gv”‹x
.
num_šedges
(); i++) {

625 
	gG¿phLabEdgeW¿µ”
<
	gGLV”‹xD©aTy³
, 
	gEdgeD©aTy³
> 
edgeW¿µ”
(
v”‹x
.
šedge
(
i
), &v”‹x, 
v”‹xInmemÜyA¼ay
, 
Œue
);

626 
	gcÚ¡_v´og
.
sÿ‰”
(
glcÚ‹xt
, 
w¿µ”V”‹x
, 
edgeW¿µ”
);

628 ià(
	gsÿ‰”_dœeùiÚ
 !ğ
ALL_EDGES
)

630 
	gOUT_EDGES
:

631 
i
=0; 
	gi
 < 
	gv”‹x
.
num_ou‹dges
(); i++) {

632 
	gG¿phLabEdgeW¿µ”
<
	gGLV”‹xD©aTy³
, 
	gEdgeD©aTy³
> 
edgeW¿µ”
(
v”‹x
.
ou‹dge
(
i
), &v”‹x, 
v”‹xInmemÜyA¼ay
, 
çl£
);

633 
	gcÚ¡_v´og
.
sÿ‰”
(
glcÚ‹xt
, 
w¿µ”V”‹x
, 
edgeW¿µ”
);

636 
	gNO_EDGES
:

639 
as£¹
(
çl£
);

648 
	g‹m¶©e
 <
ty³Çme
 
	gG¿phLabV”‹xProg¿m
,y³Çm
	gReduùiÚTy³
,

649 
ty³Çme
 
	gEdgeM­Ty³
,

650 
ty³Çme
 
	gFš®iz”Ty³
>

651 
	gG¿phLabEdgeAgg»g©ÜW¿µ”
 : 
public
 
G¿phChiProg¿m
<
boŞ
, 
ty³Çme
 
	gG¿phLabV”‹xProg¿m
::
edge_d©a_ty³
> {

652 
boŞ
 
	tV”‹xD©aTy³
;

653 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tv”‹x_d©a_ty³
 
	tGLV”‹xD©aTy³
;

654 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tedge_d©a_ty³
 
	tEdgeD©aTy³
;

655 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tedge_ty³
ƒdge_type;

656 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tg©h”_ty³
 gather_type;

657 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tg¿ph_ty³
 graph_type;

658 
ty³Çme
 
	tG¿phLabV”‹xProg¿m
::
	tmes§ge_ty³
 message_type;

660 
mu‹x
 
	gm
;

661 
	g¡d
::
veùÜ
<
ReduùiÚTy³
> 
loÿÏggr
;

662 
ReduùiÚTy³
 
	gaggr
;

663 
	g¡d
::
veùÜ
<
GLV”‹xD©aTy³
> * 
v”‹xInmemÜyA¼ay
;

664 
EdgeM­Ty³
 
	gm­_funùiÚ
;

665 
Fš®iz”Ty³
 
	gfš®ize_funùiÚ
;

667 
G¿phLabEdgeAgg»g©ÜW¿µ”
(
EdgeM­Ty³
 
m­_funùiÚ
,

668 
Fš®iz”Ty³
 
fš®ize_funùiÚ
,

669 
¡d
::
veùÜ
<
ty³Çme
 
G¿phLabV”‹xProg¿m
::
v”‹x_d©a_ty³
> * 
v”tiûs
è: 
m­_funùiÚ
(map_function),

670 
fš®ize_funùiÚ
(finalize_function) {

671 
	gv”‹xInmemÜyA¼ay
 = 
v”tiûs
;

677 
vœtu®
 
befÜe_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

678 
	gaggr
 = 
ReduùiÚTy³
();

679 
	gloÿÏggr
.
»size
(
gcÚ‹xt
.
exeùh»ads
);

685 
vœtu®
 
aá”_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

686 
log¡»am
(
LOG_INFO
è<< "GošgØruÀedge-agg»g©Ü fš®ize." << 
	g¡d
::
’dl
;

688 
	gi
=0; i < ()
	gloÿÏggr
.
size
(); i++) {

689 
	gaggr
 +ğ
loÿÏggr
[
i
];

692 
	gg¿phÏb
::
icÚ‹xt
<
g¿ph_ty³
, 
	gg©h”_ty³
, 
	gmes§ge_ty³
> 
glcÚ‹xt
(&
gcÚ‹xt
);

693 
fš®ize_funùiÚ
(
glcÚ‹xt
, 
aggr
);

699 
vœtu®
 
befÜe_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

705 
vœtu®
 
aá”_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

711 
upd©e
(
g¿phchi_v”‹x
<
boŞ
, 
EdgeD©aTy³
> &
v”‹x
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

712 
	gg¿phÏb
::
icÚ‹xt
<
g¿ph_ty³
, 
	gg©h”_ty³
, 
	gmes§ge_ty³
> 
glcÚ‹xt
(&
gcÚ‹xt
);

713 
ReduùiÚTy³
 
	ga
;

714 
	gi
=0; i < 
	gv”‹x
.
num_edges
(); i++) {

715 cÚ¡ 
	gG¿phLabEdgeW¿µ”
<
	gGLV”‹xD©aTy³
, 
	gEdgeD©aTy³
> 
edgeW¿µ”
(
v”‹x
.
edge
(
i
), &v”‹x, 
v”‹xInmemÜyA¼ay
, 
Œue
);

716 
ReduùiÚTy³
 
	gm­³d
 = 
m­_funùiÚ
(
glcÚ‹xt
, 
edgeW¿µ”
);

717 
	ga
 +ğ
m­³d
;

719 
	gloÿÏggr
[
omp_g‘_th»ad_num
()] +ğ
a
;

729 
Çme¥aû
 
	gmes§ges
 {

734 
	gsum_´iÜ™y
 : 
public
 
g¿phÏb
::
IS_POD_TYPE
 {

735 
v®ue
;

736 
sum_´iÜ™y
(cÚ¡ 
v®ue
 = 0) : value(value) { }

737 
´iÜ™y
(ècÚ¡ {  
v®ue
; }

738 
	gsum_´iÜ™y
& 
	gİ”©Ü
+=(cÚ¡ 
sum_´iÜ™y
& 
Ùh”
) {

739 
v®ue
 +ğ
Ùh”
.value;

740  *
	gthis
;

747 
	gmax_´iÜ™y
 : 
public
 
g¿phÏb
::
IS_POD_TYPE
 {

748 
v®ue
;

749 
max_´iÜ™y
(cÚ¡ 
v®ue
 = 0) : value(value) { }

750 
´iÜ™y
(ècÚ¡ {  
v®ue
; }

751 
	gmax_´iÜ™y
& 
	gİ”©Ü
+=(cÚ¡ 
max_´iÜ™y
& 
Ùh”
) {

752 
v®ue
 = 
¡d
::
max
(v®ue, 
Ùh”
.value);

753  *
	gthis
;

765 
	g‹m¶©e
 <
ty³Çme
 
	gG¿phLabV”‹xProg¿m
>

766 
	g¡d
::
veùÜ
<
ty³Çme
 
G¿phLabV”‹xProg¿m
::
v”‹x_d©a_ty³
> *

767 
run_g¿phÏb_v”‹x´og¿m
(
¡d
::
¡ršg
 
ba£_f’ame
, 
nsh¬ds
, 
n™”s
, 
boŞ
 
scheduËr
, 
m‘rics
 & 
_m
,

768 
boŞ
 
modif›s_šedges
=
Œue
, boŞ 
modif›s_ou‹dges
=true) {

769 
g¿phÏb
::
	tG¿phLabW¿µ”
<
	tG¿phLabV”‹xProg¿m
> 
	tGLW¿µ”
;

770 
GLW¿µ”
 
	gw¿µ”Prog¿m
;

771 
	gg¿phchi_’gše
<
	gboŞ
, 
ty³Çme
 
	gGLW¿µ”
::
EdgeD©aTy³
> 
’gše
(
ba£_f’ame
, 
nsh¬ds
, 
scheduËr
, 
_m
);

772 
	g’gše
.
£t_modif›s_šedges
(
modif›s_šedges
);

773 
	g’gše
.
£t_modif›s_ou‹dges
(
modif›s_ou‹dges
);

774 
	g’gše
.
run
(
w¿µ”Prog¿m
, 
n™”s
);

775  
	gw¿µ”Prog¿m
.
	gv”‹xInmemÜyA¼ay
;

778 
	g‹m¶©e
 <
ty³Çme
 
	gG¿phLabV”‹xProg¿m
,y³Çm
	gReduùiÚTy³
,

779 
ty³Çme
 
	gEdgeM­Ty³
,

780 
ty³Çme
 
	gFš®iz”Ty³
>

781 
ReduùiÚTy³
 
run_g¿phÏb_edge_agg»g©Ü
(
¡d
::
¡ršg
 
ba£_f’ame
, 
nsh¬ds
,

782 
EdgeM­Ty³
 
m­_funùiÚ
,

783 
Fš®iz”Ty³
 
fš®ize_funùiÚ
, 
¡d
::
veùÜ
<
ty³Çme
 
G¿phLabV”‹xProg¿m
::
v”‹x_d©a_ty³
> * 
v”tiûs
, 
m‘rics
 & 
_m
) {

784 
	gg¿phÏb
::
	tG¿phLabEdgeAgg»g©ÜW¿µ”
<
	tG¿phLabV”‹xProg¿m
, 
	tReduùiÚTy³
, 
	tEdgeM­Ty³
, 
	tFš®iz”Ty³
> 
	tGLEdgeAggrW¿µ”
;

785 
log¡»am
(
LOG_INFO
è<< "S¹šgƒdgagg»g©Ü." << 
	g¡d
::
’dl
;

786 
GLEdgeAggrW¿µ”
 
glAgg»g©Ü
(
m­_funùiÚ
, 
fš®ize_funùiÚ
, 
v”tiûs
);

787 
	gg¿phchi_’gše
<
	gboŞ
, 
ty³Çme
 
	gGLEdgeAggrW¿µ”
::
EdgeD©aTy³
> 
’gše
(
ba£_f’ame
, 
nsh¬ds
, 
Œue
, 
_m
);

788 
	g’gše
.
£t_modif›s_šedges
(
çl£
);

789 
	g’gše
.
£t_modif›s_ou‹dges
(
çl£
);

790 
	g’gše
.
run
(
glAgg»g©Ü
, 1);

791  
	gglAgg»g©Ü
.
	gaggr
;

	@api/graphlab2_1_GAS_api/graphlab.hpp

29 #iâdeà
DEF_GRAPHLAB_GAS_API_V2_1


30 
	#DEF_GRAPHLAB_GAS_API_V2_1


	)

33 
	~"­i/g¿phÏb2_1_GAS_­i/as£¹iÚs.hµ
"

34 
	~"­i/g¿phÏb2_1_GAS_­i/g¿phchi_g¿phÏbv2_1.hµ
"

37 
	~<boo¡/fÜ—ch.hµ
>

38 
	~<¡dšt.h
>

42 #ifdeà
__GNUC__


43 
	#GRAPHLAB_MACROS_INC_LEVEL
 
__INCLUDE_LEVEL__


	)

48 #ifdeà
GRAPHLAB_MACROS


52 
	#GRAPHLAB_MACROS


	)

56 
	#DISALLOW_COPY_AND_ASSIGN
(
Ty³Name
) \

57 
	`Ty³Name
(cÚ¡ 
Ty³Name
&); \

58 
İ”©Ü
=(cÚ¡ 
Ty³Name
&);

	)

64 
	#fÜ—ch
 
BOOST_FOREACH


	)

66 
	#»v_fÜ—ch
 
BOOST_REVERSE_FOREACH


	)

69 
	~"­i/g¿phÏb2_1_GAS_­i/¿ndom.hµ
"

	@api/graphlab2_1_GAS_api/random.cpp

24 
	~<±h»ad.h
>

26 
	~<£t
>

27 
	~<io¡»am
>

28 
	~<f¡»am
>

30 
	~<boo¡/¿ndom.hµ
>

31 
	~<boo¡/š‹g”_Œa™s.hµ
>

33 
	~"ut/±h»ad_toŞs.hµ
"

34 
	~"­i/g¿phÏb2_1_GAS_­i/g¿phÏb.hµ
"

38 
Çme¥aû
 
	gg¿phÏb
 {

39 
Çme¥aû
 
	g¿ndom
 {

44 şas 
	cnÚd‘_g’”©Ü
 {

45 
	gpublic
:

46 
nÚd‘_g’”©Ü
& 
glob®
() {

47 
nÚd‘_g’”©Ü
 
glob®_g’
;

48  
	gglob®_g’
;

51 
size_t
 
	t»suÉ_ty³
;

52 
BOOST_STATIC_CONSTANT
(
»suÉ_ty³
, 
mš_v®ue
 =

53 
boo¡
::
š‹g”_Œa™s
<
»suÉ_ty³
>::
cÚ¡_mš
);

54 
BOOST_STATIC_CONSTANT
(
»suÉ_ty³
, 
max_v®ue
 =

55 
boo¡
::
š‹g”_Œa™s
<
»suÉ_ty³
>::
cÚ¡_max
);

56 
»suÉ_ty³
 
mš
 
BOOST_PREVENT_MACRO_SUBSTITUTION
 (ècÚ¡ {  
	gmš_v®ue
; }

57 
»suÉ_ty³
 
max
 
BOOST_PREVENT_MACRO_SUBSTITUTION
 (ècÚ¡ {  
	gmax_v®ue
; }

59 
nÚd‘_g’”©Ü
() {

60 
	gºd_dev
.
İ’
("/dev/u¿ndom", 
¡d
::
ios
::
bš¬y
 | std::ios::
š
);

61 
ASSERT_TRUE
(
ºd_dev
.
good
());

64 ~
nÚd‘_g’”©Ü
(è{ 
	gºd_dev
.
şo£
(); }

66 
»suÉ_ty³
 
İ”©Ü
()() {

68 
»suÉ_ty³
 
»suÉ
(0);

69 
	gmut
.
lock
();

70 
ASSERT_TRUE
(
ºd_dev
.
good
());

71 
	gºd_dev
.
»ad
(
»š‹½»t_ÿ¡
<*>(&
»suÉ
), (
»suÉ_ty³
));

72 
ASSERT_TRUE
(
ºd_dev
.
good
());

73 
	gmut
.
uÆock
();

75  
	g»suÉ
;

77 
	g´iv©e
:

78 
¡d
::
if¡»am
 
ºd_dev
;

79 
mu‹x
 
	gmut
;

92 
	ssourû_»gi¡ry
 {

93 
	g¡d
::
£t
<
g’”©Ü
*> 
g’”©Üs
;

94 
g’”©Ü
 
	gma¡”
;

95 
mu‹x
 
	gmut
;

97 
	gsourû_»gi¡ry
& 
glob®
() {

98 
sourû_»gi¡ry
 
	g»gi¡ry
;

99  
	g»gi¡ry
;

104 
£ed
() {

105 
	gmut
.
lock
();

106 
	gma¡”
.
£ed
();

107 
fÜ—ch
(
g’”©Ü
* g’”©Ü, 
g’”©Üs
) {

108 
ASSERT_TRUE
(
g’”©Ü
 !ğ
NULL
);

109 
	gg’”©Ü
->
£ed
(
ma¡”
);

111 
	gmut
.
uÆock
();

117 
nÚd‘_£ed
() {

118 
	gmut
.
lock
();

119 
	gma¡”
.
nÚd‘_£ed
();

120 
fÜ—ch
(
g’”©Ü
* g’”©Ü, 
g’”©Üs
) {

121 
ASSERT_TRUE
(
g’”©Ü
 !ğ
NULL
);

122 
	gg’”©Ü
->
£ed
(
ma¡”
);

124 
	gmut
.
uÆock
();

131 
time_£ed
() {

132 
	gmut
.
lock
();

133 
	gma¡”
.
time_£ed
();

134 
fÜ—ch
(
g’”©Ü
* g’”©Ü, 
g’”©Üs
) {

135 
ASSERT_TRUE
(
g’”©Ü
 !ğ
NULL
);

136 
	gg’”©Ü
->
£ed
(
ma¡”
);

138 
	gmut
.
uÆock
();

145 
£ed
(cÚ¡ 
size_t
 
numb”
) {

146 
	gmut
.
lock
();

147 
	gma¡”
.
£ed
(
numb”
);

148 
fÜ—ch
(
g’”©Ü
* g’”©Ü, 
g’”©Üs
) {

149 
ASSERT_TRUE
(
g’”©Ü
 !ğ
NULL
);

150 
	gg’”©Ü
->
£ed
(
ma¡”
);

152 
	gmut
.
uÆock
();

159 
»gi¡”_g’”©Ü
(
g’”©Ü
* 
s_±r
) {

160 
ASSERT_TRUE
(
s_±r
 !ğ
NULL
);

161 
	gmut
.
lock
();

162 
	gg’”©Üs
.
š£¹
(
s_±r
);

163 
	gs_±r
->
£ed
(
ma¡”
);

166 
	gmut
.
uÆock
();

172 
uÄegi¡”_sourû
(
g’”©Ü
* 
s_±r
) {

173 
	gmut
.
lock
();

174 
	gg’”©Üs
.
”a£
(
s_±r
);

175 
	gmut
.
uÆock
();

194 
de¡roy_s_d©a
(* 
±r
) {

195 
g’”©Ü
* 
	gs_ºd_±r
 =

196 
»š‹½»t_ÿ¡
<
g’”©Ü
*>(
±r
);

197 if(
	gs_ºd_±r
 !ğ
NULL
) {

198 
sourû_»gi¡ry
::
glob®
().
uÄegi¡”_sourû
(
s_ºd_±r
);

199 
d–‘e
 
	gs_ºd_±r
;

208 
	ss_key_ü—tÜ
 {

209 
±h»ad_key_t
 
	gTLS_RANDOM_SOURCE_KEY
;

210 
s_key_ü—tÜ
(è: 
TLS_RANDOM_SOURCE_KEY
(0) {

211 
±h»ad_key_ü—‹
(&
TLS_RANDOM_SOURCE_KEY
,

212 
de¡roy_s_d©a
);

217 
±h»ad_key_t
 
g‘_¿ndom_sourû_key
() {

218 cÚ¡ 
s_key_ü—tÜ
 
	gkey
;

219  
	gkey
.
	gTLS_RANDOM_SOURCE_KEY
;

222 
±h»ad_key_t
 
__unu£d_š™_keys__
(
g‘_¿ndom_sourû_key
());

237 
	gg’”©Ü
& 
g‘_sourû
() {

239 
g’”©Ü
* 
	gs_ºd_±r
 =

240 
»š‹½»t_ÿ¡
<
g’”©Ü
*>

241 (
±h»ad_g‘¥ecific
(
g‘_¿ndom_sourû_key
()));

243 if(
	gs_ºd_±r
 =ğ
NULL
) {

244 
s_ºd_±r
 = 
Ãw
 
g’”©Ü
();

245 
as£¹
(
s_ºd_±r
 !ğ
NULL
);

247 
	gsourû_»gi¡ry
::
glob®
().
»gi¡”_g’”©Ü
(
s_ºd_±r
);

248 
±h»ad_£t¥ecific
(
g‘_¿ndom_sourû_key
(),

249 
s_ºd_±r
);

252  *
	gs_ºd_±r
;

257 
£ed
(è{ 
	gsourû_»gi¡ry
::
glob®
().seed(); }

259 
nÚd‘_£ed
(è{ 
	gsourû_»gi¡ry
::
glob®
().nondet_seed(); }

261 
time_£ed
(è{ 
	gsourû_»gi¡ry
::
glob®
().time_seed(); }

263 
£ed
(cÚ¡ 
size_t
 
£ed_v®ue
) {

264 
	gsourû_»gi¡ry
::
glob®
().
£ed
(
£ed_v®ue
);

268 
	gg’”©Ü
::
nÚd‘_£ed
() {

270 
nÚd‘_g’”©Ü
& 
nÚd‘_ºd
ÒÚd‘_g’”©Ü::
glob®
());

271 
	gmut
.
lock
();

273 
	g»®_ºg
.
£ed
(
nÚd‘_ºd
());

275 
	gdisü‘e_ºg
.
£ed
(
nÚd‘_ºd
());

277 
	gç¡_disü‘e_ºg
.
£ed
(
nÚd‘_ºd
());

278 
	gmut
.
uÆock
();

282 
pdf2cdf
(
¡d
::
veùÜ
<>& 
pdf
) {

283 
Z
 = 0;

284 
size_t
 
	gi
 = 0; i < 
	gpdf
.
size
(); ++iè
	gZ
 +ğ
pdf
[
i
];

285 
size_t
 
	gi
 = 0; i < 
	gpdf
.
size
(); ++i)

286 
	gpdf
[
i
] = 
pdf
[i]/
Z
 + ((i>0)?…df[i-1] : 0);

	@api/graphlab2_1_GAS_api/random.hpp

24 #iâdeà
GRAPHLAB_RANDOM_HPP


25 
	#GRAPHLAB_RANDOM_HPP


	)

27 
	~<c¡dlib
>

28 
	~<¡dšt.h
>

31 
	~<veùÜ
>

32 
	~<lim™s
>

33 
	~<®gÜ™hm
>

35 
	~<boo¡/¿ndom.hµ
>

36 
	~"ut/±h»ad_toŞs.hµ
"

38 
usšg
 
Çme¥aû
 
	gg¿phchi
;

40 
Çme¥aû
 
	gg¿phÏb
 {

48 
Çme¥aû
 
	g¿ndom
 {

56 
Çme¥aû
 
	gdi¡ributiÚs
 {

64 
	g‹m¶©e
<
ty³Çme
 
	gIÁTy³
>

65 
	sunifÜm
 {

66 
	gboo¡
::
	tunifÜm_št
<
	tIÁTy³
> 
	tdi¡ributiÚ_ty³
;

67 
	g‹m¶©e
<
ty³Çme
 
	gR—lRNG
,y³Çm
	gDisü‘eRNG
>

68 
šlše
 
IÁTy³
 
§m¶e
(
R—lRNG
& 
»®_ºg
,

69 
Disü‘eRNG
& 
disü‘e_ºg
,

70 cÚ¡ 
IÁTy³
& 
mš
, cÚ¡ IÁTy³& 
max
) {

71  
di¡ributiÚ_ty³
(
mš
, 
max
)(
	gdisü‘e_ºg
);

74 
	g‹m¶©e
<>

75 
	gunifÜm
<> {

76 
	gboo¡
::
	tunifÜm_»®
<> 
	tdi¡ributiÚ_ty³
;

77 
	g‹m¶©e
<
ty³Çme
 
	gR—lRNG
,y³Çm
	gDisü‘eRNG
>

78 
šlše
 
§m¶e
(
R—lRNG
& 
»®_ºg
,

79 
Disü‘eRNG
& 
disü‘e_ºg
,

80 cÚ¡ & 
mš
, cÚ¡ & 
max
) {

81  
di¡ributiÚ_ty³
(
mš
, 
max
)(
	g»®_ºg
);

84 
	g‹m¶©e
<>

85 
	gunifÜm
<> {

86 
	gboo¡
::
	tunifÜm_»®
<> 
	tdi¡ributiÚ_ty³
;

87 
	g‹m¶©e
<
ty³Çme
 
	gR—lRNG
,y³Çm
	gDisü‘eRNG
>

88 
šlše
 
§m¶e
(
R—lRNG
& 
»®_ºg
,

89 
Disü‘eRNG
& 
disü‘e_ºg
,

90 cÚ¡ & 
mš
, cÚ¡ & 
max
) {

91  
di¡ributiÚ_ty³
(
mš
, 
max
)(
	g»®_ºg
);

101 şas 
	cg’”©Ü
 {

102 
	gpublic
:

104 
boo¡
::
	tÏgged_fibÚacci607
 
	t»®_ºg_ty³
;

105 
	gboo¡
::
	tmt11213b
 
	tdisü‘e_ºg_ty³
;

106 
	gboo¡
::
	t¿nd48
 
	tç¡_disü‘e_ºg_ty³
;

108 
g’”©Ü
() {

109 
time_£ed
();

113 
šlše
 
£ed
() {

114 
	gmut
.
lock
();

115 
	g»®_ºg
.
£ed
();

116 
	gdisü‘e_ºg
.
£ed
();

117 
	gç¡_disü‘e_ºg
.
£ed
();

118 
	gmut
.
uÆock
();

122 
nÚd‘_£ed
();

126 
šlše
 
time_£ed
() {

127 
£ed
(
time
(
NULL
) );

131 
£ed
(
size_t
 
numb”
) {

132 
	gmut
.
lock
();

133 
	gç¡_disü‘e_ºg
.
£ed
(
numb”
);

134 
	g»®_ºg
.
£ed
(
ç¡_disü‘e_ºg
);

135 
	gdisü‘e_ºg
.
£ed
(
ç¡_disü‘e_ºg
);

136 
	gmut
.
uÆock
();

140 
£ed
(
g’”©Ü
& 
Ùh”
){

141 
	gmut
.
lock
();

142 
	g»®_ºg
.
£ed
(
Ùh”
.
»®_ºg
);

143 
	gdisü‘e_ºg
.
£ed
(
Ùh”
.
disü‘e_ºg
);

144 
	gç¡_disü‘e_ºg
.
£ed
(
Ùh”
.
ç¡_disü‘e_ºg
());

145 
	gmut
.
uÆock
();

152 
	g‹m¶©e
<
ty³Çme
 
	gNumTy³
>

153 
šlše
 
NumTy³
 
unifÜm
(cÚ¡ NumTy³ 
mš
, cÚ¡ NumTy³ 
max
) {

154 
	gmut
.
lock
();

155 cÚ¡ 
NumTy³
 
	g»suÉ
 = 
di¡ributiÚs
::
unifÜm
<NumType>::

156 
§m¶e
(
»®_ºg
, 
disü‘e_ºg
, 
mš
, 
max
);

157 
	gmut
.
uÆock
();

158  
	g»suÉ
;

165 
	g‹m¶©e
<
ty³Çme
 
	gNumTy³
>

166 
šlše
 
NumTy³
 
ç¡_unifÜm
(cÚ¡ NumTy³ 
mš
, cÚ¡ NumTy³ 
max
) {

167 
	gmut
.
lock
();

168 cÚ¡ 
NumTy³
 
	g»suÉ
 = 
di¡ributiÚs
::
unifÜm
<NumType>::

169 
§m¶e
(
»®_ºg
, 
ç¡_disü‘e_ºg
, 
mš
, 
max
);

170 
	gmut
.
uÆock
();

171  
	g»suÉ
;

179 
šlše
 
gamma
(cÚ¡ 
®pha
 = (1)) {

180 
boo¡
::
gamma_di¡ributiÚ
<> 
gamma_di¡
(
®pha
);

181 
	gmut
.
lock
();

182 cÚ¡ 
	g»suÉ
 = 
gamma_di¡
(
»®_ºg
);

183 
	gmut
.
uÆock
();

184  
	g»suÉ
;

192 
šlše
 
gaussŸn
(cÚ¡ 
m—n
 = (0),

193 cÚ¡ 
¡dev
 = (1)) {

194 
boo¡
::
nÜm®_di¡ributiÚ
<> 
nÜm®_di¡
(
m—n
,
¡dev
);

195 
	gmut
.
lock
();

196 cÚ¡ 
	g»suÉ
 = 
nÜm®_di¡
(
»®_ºg
);

197 
	gmut
.
uÆock
();

198  
	g»suÉ
;

205 
šlše
 
nÜm®
(cÚ¡ 
m—n
 = (0),

206 cÚ¡ 
¡dev
 = (1)) {

207  
gaussŸn
(
m—n
, 
¡dev
);

211 
šlše
 
boŞ
 
b”nouÎi
(cÚ¡ 
p
 = (0.5)) {

212 
boo¡
::
b”nouÎi_di¡ributiÚ
<> 
di¡
(
p
);

213 
	gmut
.
lock
();

214 cÚ¡ 
»suÉ
(
di¡
(
disü‘e_ºg
));

215 
	gmut
.
uÆock
();

216  
	g»suÉ
;

219 
šlše
 
boŞ
 
ç¡_b”nouÎi
(cÚ¡ 
p
 = (0.5)) {

220 
boo¡
::
b”nouÎi_di¡ributiÚ
<> 
di¡
(
p
);

221 
	gmut
.
lock
();

222 cÚ¡ 
»suÉ
(
di¡
(
ç¡_disü‘e_ºg
));

223 
	gmut
.
uÆock
();

224  
	g»suÉ
;

231 
	g‹m¶©e
<
ty³Çme
 
	gDoubË
>

232 
size_t
 
muÉšomŸl
(cÚ¡ 
¡d
::
veùÜ
<
DoubË
>& 
´b
) {

233 
ASSERT_GT
(
´b
.
size
(),0);

234 ià(
	g´b
.
size
() == 1) {  0; }

235 
DoubË
 
sum
(0);

236 
size_t
 
	gi
 = 0; i < 
	g´b
.
size
(); ++i) {

237 
ASSERT_GE
(
´b
[
i
], 0);

238 
	gsum
 +ğ
´b
[
i
];

240 
ASSERT_GT
(
sum
, 0);

242 cÚ¡ 
DoubË
 
ºd
(
unifÜm
<Double>(0,1));

243 
size_t
 
	gšd
 = 0;

244 
DoubË
 
cumsum
(
´b
[
šd
]/
sum
);

245 
	gºd
 > 
	gcumsum
 && (
	gšd
+1è< 
	g´b
.
size
();

246 
	gcumsum
 +ğ(
´b
[++
šd
]/
sum
));

247  
	gšd
;

256 
	g‹m¶©e
<
ty³Çme
 
	gDoubË
>

257 
šlše
 
size_t
 
muÉšomŸl_cdf
(cÚ¡ 
¡d
::
veùÜ
<
DoubË
>& 
cdf
) {

258  
¡d
::
uµ”_bound
(
cdf
.
begš
(), cdf.
’d
(),

259 
unifÜm
<
DoubË
>(0,1)è- 
	gcdf
.
begš
();

267 
	g‹m¶©e
<
ty³Çme
 
	gT
>

268 
šlše
 
	g¡d
::
veùÜ
<
T
> 
³rmutiÚ
(cÚ¡ 
size_t
 
ÃËms
) {

269 
¡d
::
veùÜ
<
T
> 
³rm
(
ÃËms
);

270 
T
 
	gi
 = 0; i < 
	gÃËms
; ++iè
	g³rm
[
i
] = i;

271 
shufæe
(
³rm
);

272  
	g³rm
;

278 
	g‹m¶©e
<
ty³Çme
 
	gT
>

279 
shufæe
(
¡d
::
veùÜ
<
T
>& 
vec
è{ shufæe(vec.
begš
(), vec.
’d
()); }

284 
	g‹m¶©e
<
ty³Çme
 
	gI‹¿tÜ
>

285 
shufæe
(
I‹¿tÜ
 
begš
, I‹¿tÜ 
’d
) {

286 
	gmut
.
lock
();

287 
shufæe_funùÜ
 
funùÜ
(*
this
);

288 
	g¡d
::
¿ndom_shufæe
(
begš
, 
’d
, 
funùÜ
);

289 
	gmut
.
uÆock
();

292 
	g´iv©e
:

295 
	sshufæe_funùÜ
 {

296 
g’”©Ü
& 
g’
;

297 
šlše
 
shufæe_funùÜ
(
g’”©Ü
& 
g’
) : gen(gen) { }

298 
šlše
 
¡d
::
±rdiff_t
 
İ”©Ü
()(¡d::±rdiff_ˆ
’d
) {

299  
di¡ributiÚs
::
unifÜm
<
±rdiff_t
>::

300 
§m¶e
(
g’
.
»®_ºg
, g’.
ç¡_disü‘e_ºg
, 0, 
’d
-1);

306 
»®_ºg_ty³
 
	g»®_ºg
;

308 
disü‘e_ºg_ty³
 
	gdisü‘e_ºg
;

310 
ç¡_disü‘e_ºg_ty³
 
	gç¡_disü‘e_ºg
;

312 
mu‹x
 
	gmut
;

333 
£ed
();

339 
£ed
(
size_t
 
£ed_v®ue
);

345 
nÚd‘_£ed
();

351 
time_£ed
();

358 
	gg’”©Ü
& 
g‘_sourû
();

365 
	g‹m¶©e
<
ty³Çme
 
	gNumTy³
>

366 
šlše
 
NumTy³
 
unifÜm
(cÚ¡ NumTy³ 
mš
, cÚ¡ NumTy³ 
max
) {

367  
g‘_sourû
().
	gunifÜm
<
	gNumTy³
>(
	gmš
, 
	gmax
);

375 
	g‹m¶©e
<
ty³Çme
 
	gNumTy³
>

376 
šlše
 
NumTy³
 
ç¡_unifÜm
(cÚ¡ NumTy³ 
mš
, cÚ¡ NumTy³ 
max
) {

377  
g‘_sourû
().
	gç¡_unifÜm
<
	gNumTy³
>(
	gmš
, 
	gmax
);

384 
šlše
 
¿nd01
(è{  
	gunifÜm
<>(0, 1); }

390 
šlše
 
¿nd
(è{  
ç¡_unifÜm
(0, 
RAND_MAX
); }

397 
šlše
 
gamma
(cÚ¡ 
®pha
 = (1)) {

398  
g‘_sourû
().
gamma
(
®pha
);

408 
šlše
 
gaussŸn
(cÚ¡ 
m—n
 = (0),

409 cÚ¡ 
¡dev
 = (1)) {

410  
g‘_sourû
().
gaussŸn
(
m—n
, 
¡dev
);

418 
šlše
 
nÜm®
(cÚ¡ 
m—n
 = (0),

419 cÚ¡ 
¡dev
 = (1)) {

420  
g‘_sourû
().
nÜm®
(
m—n
, 
¡dev
);

427 
šlše
 
boŞ
 
b”nouÎi
(cÚ¡ 
p
 = (0.5)) {

428  
g‘_sourû
().
b”nouÎi
(
p
);

435 
šlše
 
boŞ
 
ç¡_b”nouÎi
(cÚ¡ 
p
 = (0.5)) {

436  
g‘_sourû
().
ç¡_b”nouÎi
(
p
);

444 
	g‹m¶©e
<
ty³Çme
 
	gDoubË
>

445 
šlše
 
size_t
 
muÉšomŸl
(cÚ¡ 
¡d
::
veùÜ
<
DoubË
>& 
´b
) {

446  
g‘_sourû
().
muÉšomŸl
(
´b
);

454 
	g‹m¶©e
<
ty³Çme
 
	gDoubË
>

455 
šlše
 
size_t
 
muÉšomŸl_cdf
(cÚ¡ 
¡d
::
veùÜ
<
DoubË
>& 
cdf
) {

456  
g‘_sourû
().
muÉšomŸl_cdf
(
cdf
);

465 
	g‹m¶©e
<
ty³Çme
 
	gT
>

466 
šlše
 
	g¡d
::
veùÜ
<
T
> 
³rmutiÚ
(cÚ¡ 
size_t
 
ÃËms
) {

467  
g‘_sourû
().
³rmutiÚ
<
T
>(
ÃËms
);

475 
	g‹m¶©e
<
ty³Çme
 
	gT
>

476 
šlše
 
shufæe
(
¡d
::
veùÜ
<
T
>& 
vec
) {

477 
g‘_sourû
().
shufæe
(
vec
);

484 
	g‹m¶©e
<
ty³Çme
 
	gI‹¿tÜ
>

485 
šlše
 
shufæe
(
I‹¿tÜ
 
begš
, I‹¿tÜ 
’d
) {

486 
g‘_sourû
().
shufæe
(
begš
, 
’d
);

492 
pdf2cdf
(
¡d
::
veùÜ
<>& 
pdf
);

	@api/ischeduler.hpp

30 #iâdeà
DEF_GRAPHCHI_ISCHEDULER


31 
	#DEF_GRAPHCHI_ISCHEDULER


	)

33 
	~"g¿phchi_ty³s.hµ
"

34 
	~"logg”/logg”.hµ
"

36 
Çme¥aû
 
	gg¿phchi
 {

38 şas 
	cischeduËr
 {

39 
	gpublic
:

40 
vœtu®
 ~
ischeduËr
() {}

41 
vœtu®
 
add_sk
(
vid_t
 
vid
, 
boŞ
 
®so_this_™”©iÚ
=
çl£
) = 0;

42 
vœtu®
 
add_sk_to_®l
() = 0;

43 
vœtu®
 
boŞ
 
is_scheduËd
(
vid_t
 
v”‹x
) = 0;

44 
vœtu®
 
size_t
 
num_sks
() = 0;

45 
vœtu®
 
Ãw_™”©iÚ
(
™”©iÚ
) = 0;

46 
vœtu®
 
»move_sks
(
vid_t
 
äomv”‹x
, vid_ˆ
tov”‹x
) = 0;

53 şas 
	cnÚ_scheduËr
 : 
public
 
ischeduËr
 {

54 
nw¬nšgs
;

55 
	gpublic
:

56 
nÚ_scheduËr
(è: 
nw¬nšgs
(0) {}

57 
vœtu®
 ~
nÚ_scheduËr
() {}

58 
vœtu®
 
add_sk
(
vid_t
 
vid
, 
boŞ
 
®so_this_™”©iÚ
=
çl£
) {

59 ià(
nw¬nšgs
++ % 10000 == 0) {

60 
log¡»am
(
LOG_WARNING
è<< "Tr›dØaddaskØscheduËr, buˆschedulšg wa nÙƒÇbËd!" << 
¡d
::
’dl
;

63 
vœtu®
 
add_sk_to_®l
() { }

64 
vœtu®
 
boŞ
 
is_scheduËd
(
vid_t
 
v”‹x
è{  
	gŒue
; }

65 
vœtu®
 
size_t
 
num_sks
() {  0; }

66 
vœtu®
 
Ãw_™”©iÚ
(
™”©iÚ
) {}

68 
vœtu®
 
»move_sks
(
vid_t
 
äomv”‹x
, vid_ˆ
tov”‹x
) {}

	@api/vertex_aggregator.hpp

33 #iâdeà
DEF_GRAPHCHI_VERTEX_AGGREGATOR


34 
	#DEF_GRAPHCHI_VERTEX_AGGREGATOR


	)

36 
	~<”ºo.h
>

37 
	~<memÜy.h
>

38 
	~<¡ršg
>

40 
	~"g¿phchi_ty³s.hµ
"

41 
	~"­i/chif’ames.hµ
"

42 
	~"io/¡redio.hµ
"

43 
	~"ut/iout.hµ
"

44 
	~"’gše/auxd©a/v”‹x_d©a.hµ
"

46 
Çme¥aû
 
	gg¿phchi
 {

52 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
>

53 şas 
	cVC®lback
 {

54 
	gpublic
:

55 
vœtu®
 
ÿÎback
(
vid_t
 
v”‹x_id
, 
V”‹xD©aTy³
 &
v®ue
) = 0;

67 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
>

68 
fÜ—ch_v”tiûs
(
¡d
::
¡ršg
 
ba£f’ame
, 
vid_t
 
äomv
, vid_ˆ
tov
, 
VC®lback
<
V”‹xD©aTy³
> &
ÿÎback
) {

69 
	g¡d
::
¡ršg
 
f’ame
 = 
f’ame_v”‹x_d©a
<
V”‹xD©aTy³
>(
ba£f’ame
);

70 
m‘rics
 
m
("foreach");

71 
¡redio
 * 
	giomgr
 = 
Ãw
 sŒedio(
m
);

73 
vid_t
 
	g»adwšdow
 = 1024 * 1024;

74 
size_t
 
	gnumv”tiûs
 = 
g‘_num_v”tiûs
(
ba£f’ame
);

75 
	gv”‹x_d©a_¡Üe
<
	gV”‹xD©aTy³
> * 
	gv”‹xd©a
 =

76 
Ãw
 
v”‹x_d©a_¡Üe
<
V”‹xD©aTy³
>(
ba£f’ame
, 
	gnumv”tiûs
, 
	giomgr
);

78 
vid_t
 
	g¡
 = 
äomv
;

79 
vid_t
 
	g’
 = 0;

80 
	g¡
 <ğ
tov
) {

81 
’
 = 
¡
 + 
»adwšdow
 - 1;

82 ià(
	g’
 >ğ
tov
è
’
 =ov - 1;

84 ià(
	g¡
 < 
	g’
) {

85 
	gv”‹xd©a
->
lßd
(
¡
, 
’
);

86 
vid_t
 
	gv
=
¡
; v<=
’
; v++) {

87 
V”‹xD©aTy³
 * 
	gv±r
 = 
v”‹xd©a
->
v”‹x_d©a_±r
(
v
);

88 
	gÿÎback
.
ÿÎback
(
v
, (
V”‹xD©aTy³
&è*
v±r
);

92 
	g¡
 +ğ
»adwšdow
;

94 
d–‘e
 
	gv”‹xd©a
;

95 
d–‘e
 
	giomgr
;

102 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
,y³Çm
	gSumTy³
>

103 
şass
 
	gSumC®lback
 : 
public
 
VC®lback
<
V”‹xD©aTy³
> {

104 
public
:

105 
SumTy³
 
accum
;

106 
SumC®lback
(
SumTy³
 
š™v®
è: 
VC®lback
<
V”‹xD©aTy³
>() {

107 
accum
 = 
š™v®
;

110 
ÿÎback
(
vid_t
 
v”‹x_id
, 
V”‹xD©aTy³
 &
v®ue
) {

111 
	gaccum
 +ğ
v®ue
;

124 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
,y³Çm
	gSumTy³
>

125 
SumTy³
 
sum_v”tiûs
(
¡d
::
¡ršg
 
ba£_f’ame
, 
vid_t
 
äomv
, vid_ˆ
tov
) {

126 
	gSumC®lback
<
	gV”‹xD©aTy³
, 
	gSumTy³
> 
sumc
(0);

127 
	gfÜ—ch_v”tiûs
<
	gV”‹xD©aTy³
>(
	gba£_f’ame
, 
	gäomv
, 
	gtov
, 
	gsumc
);

128  
	gsumc
.
	gaccum
;

	@engine/auxdata/degree_data.hpp

30 #iâdeà
DEF_GRAPHCHI_DEGREE_DATA


31 
	#DEF_GRAPHCHI_DEGREE_DATA


	)

33 
	~<f¡»am
>

34 
	~<as£¹.h
>

35 
	~<¡ršg
>

36 
	~<¡dlib.h
>

37 
	~<sys/mmª.h
>

39 
	~"g¿phchi_ty³s.hµ
"

40 
	~"io/¡redio.hµ
"

42 
Çme¥aû
 
	gg¿phchi
 {

45 
	sdeg»e
 {

46 
	gšdeg»e
;

47 
	goutdeg»e
;

51 şas 
	cdeg»e_d©a
 {

54 
	g´Ùeùed
:

56 
vid_t
 
v”‹x_¡
;

57 
vid_t
 
	gv”‹x_’
;

58 
¡redio
 * 
	giomgr
;

61 
deg»e
 * 
	glßded_chunk
;

62 
	g¡d
::
¡ršg
 
f’ame
;

63 
	g¡d
::
¡ršg
 
ba£_f’ame
;

65 
boŞ
 
	gmodif›d
;

67 
	gfedesc
;

69 
boŞ
 
	gu£_mm­
;

70 
deg»e
 * 
	gmm­_fe
;

71 
size_t
 
	gmm­_Ëngth
;

73 
vœtu®
 
İ’_fe
(
¡d
::
¡ršg
 
ba£_f’ame
) {

74 
f’ame
 = 
f’ame_deg»e_d©a
(
ba£_f’ame
);

75 
	gmodif›d
 = 
çl£
;

76 ià(!
	gu£_mm­
) {

77 
	gfedesc
 = 
iomgr
->
İ’_£ssiÚ
(
f’ame
.
c_¡r
(), 
çl£
);

79 
	gmm­_Ëngth
 = 
g‘_fesize
(
f’ame
);

80 
	gfedesc
 = 
İ’
(
f’ame
.
c_¡r
(), 
O_RDWR
);

81 
	gmm­_fe
 = (
deg»e
 *è
mm­
(
NULL
, 
mm­_Ëngth
, 
PROT_READ
 | 
PROT_WRITE
, 
MAP_SHARED
, 
fedesc
, 0);

82 
as£¹
(
mm­_fe
);

86 
	gpublic
:

92 
deg»e_d©a
(
¡d
::
¡ršg
 
ba£_f’ame
, 
¡redio
 * 
iomgr
è: iomgr(iomgr), 
lßded_chunk
(
NULL
) {

93 
	gv”‹x_¡
 = 
v”‹x_’
 = 0;

94 
	gthis
->
	gba£_f’ame
 = 
ba£_f’ame
;

95 
	gu£_mm­
 = 
g‘_İtiÚ_št
("mmap", 0);

96 ià(
	gu£_mm­
) {

97 
log¡»am
(
LOG_INFO
è<< "U£ memÜy m­pšg fÜ deg»d©a." << 
	g¡d
::
’dl
;

99 
İ’_fe
(
ba£_f’ame
);

102 
	gvœtu®
 ~
deg»e_d©a
() {

103 ià(!
	gu£_mm­
) {

104 ià(
	glßded_chunk
 !ğ
NULL
) {

105 
iomgr
->
mªaged_»Ëa£
(
fedesc
, &
lßded_chunk
);

107 
	giomgr
->
şo£_£ssiÚ
(
fedesc
);

109 ià(
	gmodif›d
) {

110 
msync
(
mm­_fe
, 
mm­_Ëngth
, 
MS_SYNC
);

112 
munm­
(
mm­_fe
, 
mm­_Ëngth
);

113 
şo£
(
fedesc
);

122 
vœtu®
 
lßd
(
vid_t
 
_v”‹x_¡
, vid_ˆ
_v”‹x_’
) {

123 ià(!
	gu£_mm­
) {

124 
as£¹
(
_v”‹x_’
 >ğ
_v”‹x_¡
);

125 
	gv”‹x_¡
 = 
_v”‹x_¡
;

126 
	gv”‹x_’
 = 
_v”‹x_’
;

128 
size_t
 
	gd©asize
 = (
v”‹x_’
 - 
v”‹x_¡
 + 1è* (
deg»e
);

129 
size_t
 
	gd©a¡¬t
 = 
v”‹x_¡
 * (
deg»e
);

131 ià(
	glßded_chunk
 !ğ
NULL
) {

132 
iomgr
->
mªaged_»Ëa£
(
fedesc
, &
lßded_chunk
);

135 
	giomgr
->
mªaged_m®loc
(
fedesc
, &
lßded_chunk
, 
d©asize
, 
d©a¡¬t
);

136 
	giomgr
->
mªaged_´—da_now
(
fedesc
, &
lßded_chunk
, 
d©asize
, 
d©a¡¬t
);

143 
vid_t
 
fœ¡_v”‹x_id
() {

144 ià(!
	gu£_mm­
) {

145 
as£¹
(
lßded_chunk
 !ğ
NULL
);

146  
	gv”‹x_¡
;

152 
vœtu®
 
£t_deg»e
(
vid_t
 
v”‹xid
, 
šdeg»e
, 
outdeg»e
) {

153 
	gmodif›d
 = 
Œue
;

154 ià(!
	gu£_mm­
) {

155 
as£¹
(
v”‹xid
 >ğ
v”‹x_¡
 && v”‹xid <ğ
v”‹x_’
);

156 
	glßded_chunk
[
v”‹xid
 - 
v”‹x_¡
].
	gšdeg»e
 = 
šdeg»e
;

157 
	glßded_chunk
[
v”‹xid
 - 
v”‹x_¡
].
	goutdeg»e
 = 
outdeg»e
;

159 
	gmm­_fe
[
v”‹xid
].
	gšdeg»e
 = 
šdeg»e
;

160 
	gmm­_fe
[
v”‹xid
].
	goutdeg»e
 = 
outdeg»e
;

164 
vœtu®
 
£t_deg»e
(
vid_t
 
v”‹xid
, 
deg»e
 
d
) {

165 
	gmodif›d
 = 
Œue
;

166 ià(!
	gu£_mm­
) {

167 
as£¹
(
v”‹xid
 >ğ
v”‹x_¡
 && v”‹xid <ğ
v”‹x_’
);

168 
	glßded_chunk
[
v”‹xid
 - 
v”‹x_¡
] = 
d
;

170 
	gmm­_fe
[
v”‹xid
] = 
d
;

174 
šlše
 
deg»e
 
g‘_deg»e
(
vid_t
 
v”‹xid
) {

175 ià(!
	gu£_mm­
) {

176 
as£¹
(
v”‹xid
 >ğ
v”‹x_¡
 && v”‹xid <ğ
v”‹x_’
);

177  
	glßded_chunk
[
v”‹xid
 - 
v”‹x_¡
];

179  
	gmm­_fe
[
v”‹xid
];

183 
§ve
() {

184 ià(!
	gu£_mm­
) {

185 
size_t
 
	gd©asize
 = (
v”‹x_’
 - 
v”‹x_¡
 + 1è* (
deg»e
);

186 
size_t
 
	gd©a¡¬t
 = 
v”‹x_¡
 * (
deg»e
);

187 
	giomgr
->
mªaged_pwr™—_now
(
fedesc
, &
lßded_chunk
, 
d©asize
, 
d©a¡¬t
);

191 
’su»_size
(
vid_t
 
maxid
) {

192 ià(!
	gu£_mm­
) {

193 
	giomgr
->
Œunÿ‹
(
fedesc
, (1 + 
maxid
è* (
deg»e
));

195 
munm­
(
mm­_fe
, 
mm­_Ëngth
);

196 
árunÿ‹
(
fedesc
, (1 + 
maxid
è* (
deg»e
));

197 
şo£
(
fedesc
);

198 
İ’_fe
(
ba£_f’ame
);

	@engine/auxdata/dynamicdata/vertex_data_dynamic.hpp

36 #iâdeà
DYNAMICVERTEXDATA


37 
	$ERROR
(
DYNAMICVERTEXDATA
 
NEEDS
 
TO
 
BE
 
DEFINED
)

40 #iâdeà
DEF_GRAPHCHI_VERTEXDATA


41 
	#DEF_GRAPHCHI_VERTEXDATA


	)

43 
	~<¡dlib.h
>

44 
	~<¡ršg
>

45 
	~<fú.h
>

46 
	~<”ºo.h
>

47 
	~<sys/¡©.h
>

48 
	~<as£¹.h
>

50 
	~"g¿phchi_ty³s.hµ
"

51 
	~"­i/chif’ames.hµ
"

52 
	~"io/¡redio.hµ
"

53 
	~"ut/iout.hµ
"

54 
	~"­i/dyÇmicd©a/chiveùÜ.hµ
"

55 
	~"sh¬ds/dyÇmicd©a/dyÇmicblock.hµ
"

57 
Çme¥aû
 
g¿phchi
 {

59 
‹m¶©e
 <
ty³Çme
 
V”‹xD©aTy³
>

60 
	svdblock_t
 {

61 
blockid
;

62 
fd
;

63 
ušt8_t
* 
d©a
;

64 
dyÇmicd©a_block
<
V”‹xD©aTy³
> * 
dblock
;

65 
	`vdblock_t
(
bid
è: 
	`blockid
(bid), 
	`d©a
(
NULL
), 
	`dblock
(NULL) {}

68 
‹m¶©e
 <
ty³Çme
 
V”‹xD©aTy³
>

69 şas 
	cv”‹x_d©a_¡Üe
 {

71 
vdblock_t
<
	tV”‹xD©aTy³
> 
	tvdblock
;

72 
´Ùeùed
:

74 
¡redio
 * 
iomgr
;

77 
vid_t
 
v”‹x_¡
;

78 
vid_t
 
v”‹x_’
;

80 
¡d
::
¡ršg
 
dœÇme
;

81 
size_t
 
v”tiû¥”block
;

83 
V”‹xD©aTy³
 * 
lßded_chunk
;

84 
¡d
::
veùÜ
<
vdblock
> 
lßdedblocks
;

87 
public
:

89 
	`v”‹x_d©a_¡Üe
(
¡d
::
¡ršg
 
ba£_f’ame
, 
size_t
 
nv”tiûs
, 
¡redio
 * 
iomgr
è: 
	`iomgr
(iomgr), 
	`lßded_chunk
(
NULL
){

90 
v”‹x_¡
 = 
v”‹x_’
 = 0;

91 
v”tiû¥”block
 = 1024 * 1024;

93 
dœÇme
 = 
f’ame_v”‹x_d©a
<
V”‹xD©aTy³
>(
ba£_f’ame
) + ".dynamic_blockdir";

94 
	`check_size
(
nv”tiûs
);

97 
vœtu®
 ~
	`v”‹x_d©a_¡Üe
() {

98 
iomgr
->
	`wa™_fÜ_wr™es
();

99 
	`»Ëa£blocks
();

103 
	`check_size
(
size_t
 
nv”tiûs
) {

104 
nblocks
 = (
nv”tiûs
 - 1è/ 
v”tiû¥”block
 + 1;

105 
i
=0; i < 
nblocks
; i++) {

106 
	`š™_block
(
i
);

110 
	`ş—r
(
size_t
 
nv”tiûs
) {

111 
nblocks
 = (
nv”tiûs
 - 1è/ 
v”tiû¥”block
 + 1;

112 
i
=0; i < 
nblocks
; i++) {

113 
¡d
::
¡ršg
 
bf’ame
 = 
	`blockf’ame
(
i
);

114 ià(
	`fe_exi¡s
(
bf’ame
)) {

115 
	`»move
(
bf’ame
.
	`c_¡r
());

117 
	`d–‘e_block_uncom´es£d_sizefe
(
bf’ame
);

121 
´iv©e
:

122 
¡d
::
¡ršg
 
	`blockf’ame
(
blockid
) {

123 
¡d
::
¡ršg¡»am
 
ss
;

124 
ss
 << 
dœÇme
;

125 
ss
 << "/";

126 
ss
 << 
blockid
;

127  
ss
.
	`¡r
();

130 
	`»Ëa£blocks
() {

131 
i
=0; i < ()
lßdedblocks
.
	`size
(); i++) {

132 
	`d–‘e
(
lßdedblocks
[
i
].
dblock
);

133 
iomgr
->
	`mªaged_»Ëa£
(
lßdedblocks
[
i
].
fd
, &lßdedblocks[i].
d©a
);

134 
iomgr
->
	`şo£_£ssiÚ
(
lßdedblocks
[
i
].
fd
);

135 
lßdedblocks
[
i
].
d©a
 = 
NULL
;

136 
lßdedblocks
[
i
].
dblock
 = 
NULL
;

138 
lßdedblocks
.
	`ş—r
();

141 
	`š™_block
(
blockid
) {

142 
¡d
::
¡ršg
 
bf’ame
 = 
	`blockf’ame
(
blockid
);

143 ià(!
	`fe_exi¡s
(
bf’ame
)) {

144 
	`mkdœ
(
dœÇme
.
	`c_¡r
(), 0777);

145 
size_t
 
š™size
 = 
v”tiû¥”block
 * (
ty³Çme
 
V”‹xD©aTy³
::
sizewÜd_t
);

146 
f
 = 
	`İ’
(
bf’ame
.
	`c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

147 
ušt8_t
 * 
z”os
 = (ušt8_ˆ*è
	`ÿÎoc
(
v”tiû¥”block
, (
ty³Çme
 
V”‹xD©aTy³
::
sizewÜd_t
));

148 
	`wr™e_com´es£d
(
f
, 
z”os
, 
š™size
);

149 
	`ä“
(
z”os
);

151 
	`wr™e_block_uncom´es£d_size
(
bf’ame
, 
š™size
);

152 
	`şo£
(
f
);

158 
vdblock
 
	`lßd_block
(
blockid
) {

159 
vdblock
 
	`db
(
blockid
);

161 
¡d
::
¡ršg
 
blockâame
 = 
	`blockf’ame
(
blockid
);

162 
db
.
fd
 = 
iomgr
->
	`İ’_£ssiÚ
(
blockâame
, 
çl£
, 
Œue
);

163 
»®size
 = 
	`g‘_block_uncom´es£d_size
(
blockâame
, -1);

164 
	`as£¹
(
»®size
 > 0);

166 
iomgr
->
	`mªaged_m®loc
(
db
.
fd
, &db.
d©a
, 
»®size
, 0);

167 
iomgr
->
	`mªaged_´—da_now
(
db
.
fd
, &db.
d©a
, 
»®size
, 0);

168 
db
.
dblock
 = 
Ãw
 
dyÇmicd©a_block
<
V”‹xD©aTy³
>(
v”tiû¥”block
, (
ušt8_t
 *)db.
d©a
, 
»®size
);

169  
db
;

172 
	`wr™e_block
(
vdblock
 &
block
) {

173 
»®size
;

174 
ušt8_t
 * 
outd©a
;

175 
block
.
dblock
->
	`wr™e
(&
outd©a
, 
»®size
);

176 
¡d
::
¡ršg
 
blockâame
 = 
	`blockf’ame
(
block
.
blockid
);

177 
iomgr
->
	`mªaged_pwr™—_now
(
block
.
fd
, &
outd©a
, 
»®size
, 0);

178 
	`wr™e_block_uncom´es£d_size
(
blockâame
, 
»®size
);

179 
	`ä“
(
outd©a
);

182 
public
:

189 
vœtu®
 
	`lßd
(
vid_t
 
_v”‹x_¡
, vid_ˆ
_v”‹x_’
) {

190 
	`as£¹
(
_v”‹x_’
 >ğ
_v”‹x_¡
);

191 
v”‹x_¡
 = 
_v”‹x_¡
;

192 
v”‹x_’
 = 
_v”‹x_’
;

194 
	`»Ëa£blocks
();

196 
mš_blockid
 = 
v”‹x_¡
 / 
v”tiû¥”block
;

197 
max_blockid
 = 
v”‹x_’
 / 
v”tiû¥”block
;

198 
i
=
mš_blockid
; i <ğ
max_blockid
; i++) {

199 
lßdedblocks
.
	`push_back
(
	`lßd_block
(
i
));

206 
vœtu®
 
	`§ve
(
boŞ
 
async
=
çl£
) {

207 
i
=0; i < ()
lßdedblocks
.
	`size
(); i++) {

208 
	`wr™e_block
(
lßdedblocks
[
i
]);

216 
vid_t
 
	`fœ¡_v”‹x_id
() {

217  
v”‹x_¡
;

221 
V”‹xD©aTy³
 * 
	`v”‹x_d©a_±r
(
vid_t
 
v”‹xid
) {

222 
blockid
 = 
v”‹xid
 / 
v”tiû¥”block
;

223 
fœ¡lßded
 = 
lßdedblocks
[0].
blockid
;

224 
dyÇmicd©a_block
<
V”‹xD©aTy³
> * 
dynblock
 = 
lßdedblocks
[
blockid
 - 
fœ¡lßded
].
dblock
;

225  
dynblock
->
	`edgevec
(
v”‹xid
 % 
v”tiû¥”block
);

229 
	}
};

	@engine/auxdata/vertex_data.hpp

33 #ifdeà
DYNAMICVERTEXDATA


34 
	~"’gše/auxd©a/dyÇmicd©a/v”‹x_d©a_dyÇmic.hµ
"

37 #iâdeà
DEF_GRAPHCHI_VERTEXDATA


38 
	#DEF_GRAPHCHI_VERTEXDATA


	)

40 
	~<¡dlib.h
>

41 
	~<¡ršg
>

42 
	~<as£¹.h
>

43 
	~<sys/mmª.h
>

45 
	~"g¿phchi_ty³s.hµ
"

46 
	~"­i/chif’ames.hµ
"

47 
	~"io/¡redio.hµ
"

48 
	~"ut/iout.hµ
"

50 
Çme¥aû
 
	gg¿phchi
 {

52 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
>

53 şas 
	cv”‹x_d©a_¡Üe
 {

55 
	g´Ùeùed
:

57 
¡redio
 * 
iomgr
;

60 
vid_t
 
	gv”‹x_¡
;

61 
vid_t
 
	gv”‹x_’
;

63 
	g¡d
::
¡ršg
 
f’ame
;

64 
	gfedesc
;

66 
V”‹xD©aTy³
 * 
	glßded_chunk
;

68 
boŞ
 
	gu£_mm­
;

69 
V”‹xD©aTy³
 * 
	gmm­_fe
;

70 
size_t
 
	gmm­_Ëngth
;

72 
vid_t
 
	gÏ¡_nv”tiûs
;

75 
vœtu®
 
İ’_fe
() {

76 ià(!
	gu£_mm­
) {

77 
	gfedesc
 = 
iomgr
->
İ’_£ssiÚ
(
f’ame
.
c_¡r
(), 
çl£
);

79 
	gmm­_Ëngth
 = 
g‘_fesize
(
f’ame
);

80 
	gfedesc
 = 
İ’
(
f’ame
.
c_¡r
(), 
O_RDWR
);

81 
	gmm­_fe
 = (
V”‹xD©aTy³
 *è
mm­
(
NULL
, 
mm­_Ëngth
, 
PROT_WRITE
 | 
PROT_READ
, 
MAP_SHARED
, 
fedesc
, 0);

82 
as£¹
(
mm­_fe
);

86 
	gpublic
:

88 
v”‹x_d©a_¡Üe
(
¡d
::
¡ršg
 
ba£_f’ame
, 
size_t
 
nv”tiûs
, 
¡redio
 * 
iomgr
è: iomgr(iomgr), 
lßded_chunk
(
NULL
){

89 
	gv”‹x_¡
 = 
v”‹x_’
 = 0;

90 
	gf’ame
 = 
f’ame_v”‹x_d©a
<
V”‹xD©aTy³
>(
ba£_f’ame
);

92 
	gmm­_fe
 = 
NULL
;

93 
	gÏ¡_nv”tiûs
 = 0;

94 
	gu£_mm­
 = 
g‘_İtiÚ_št
("mmap", 0);

95 ià(
	gu£_mm­
) {

96 
log¡»am
(
LOG_INFO
è<< "U£ memÜy m­pšg fÜ v”‹x d©a." << 
	g¡d
::
’dl
;

97 
check_size
(
nv”tiûs
);

99 
check_size
(
nv”tiûs
);

100 
İ’_fe
();

105 
	gvœtu®
 ~
v”‹x_d©a_¡Üe
() {

106 ià(!
	gu£_mm­
) {

107 
	giomgr
->
şo£_£ssiÚ
(
fedesc
);

108 
	giomgr
->
wa™_fÜ_wr™es
();

109 ià(
	glßded_chunk
 !ğ
NULL
) {

110 
iomgr
->
mªaged_»Ëa£
(
fedesc
, &
lßded_chunk
);

113 
log¡»am
(
LOG_INFO
è<< "Syncšg v”‹x d©a..." << 
	g¡d
::
’dl
;

114 
msync
(
mm­_fe
, 
mm­_Ëngth
, 
MS_SYNC
);

115 
munm­
(
mm­_fe
, 
mm­_Ëngth
);

116 
şo£
(
fedesc
);

121 
check_size
(
size_t
 
nv”tiûs
) {

122 ià(
	gnv”tiûs
 =ğ
Ï¡_nv”tiûs
) ;

123 ià(!
	gu£_mm­
) {

124 
	gcheck¬¿y_fesize
<
	gV”‹xD©aTy³
>(
	gf’ame
, 
	gnv”tiûs
);

126 ià(
	gmm­_fe
) {

127 
msync
(
mm­_fe
, 
mm­_Ëngth
, 
MS_SYNC
);

128 
munm­
(
mm­_fe
, 
mm­_Ëngth
);

129 
	gmm­_fe
 = 
NULL
;

130 
şo£
(
fedesc
);

132 
	gcheck¬¿y_fesize
<
	gV”‹xD©aTy³
>(
	gf’ame
, 
	gnv”tiûs
);

133 
İ’_fe
();

135 
	gÏ¡_nv”tiûs
 = 
nv”tiûs
;

138 
ş—r
(
size_t
 
nv”tiûs
) {

139 
check_size
(0);

140 
check_size
(
nv”tiûs
);

148 
vœtu®
 
lßd
(
vid_t
 
_v”‹x_¡
, vid_ˆ
_v”‹x_’
) {

149 ià(!
	gu£_mm­
) {

150 
as£¹
(
_v”‹x_’
 >ğ
_v”‹x_¡
);

151 
	gv”‹x_¡
 = 
_v”‹x_¡
;

152 
	gv”‹x_’
 = 
_v”‹x_’
;

154 
size_t
 
	gd©asize
 = (
v”‹x_’
 - 
v”‹x_¡
 + 1)* (
V”‹xD©aTy³
);

155 
size_t
 
	gd©a¡¬t
 = 
v”‹x_¡
 * (
V”‹xD©aTy³
);

157 ià(
	glßded_chunk
 !ğ
NULL
) {

158 
iomgr
->
mªaged_»Ëa£
(
fedesc
, &
lßded_chunk
);

161 
	giomgr
->
mªaged_m®loc
(
fedesc
, &
lßded_chunk
, 
d©asize
, 
d©a¡¬t
);

162 
	giomgr
->
mªaged_´—da_now
(
fedesc
, &
lßded_chunk
, 
d©asize
, 
d©a¡¬t
);

172 
vœtu®
 
§ve
(
boŞ
 
async
=
çl£
) {

173 ià(!
u£_mm­
) {

174 
as£¹
(
lßded_chunk
 !ğ
NULL
);

175 
size_t
 
	gd©asize
 = (
v”‹x_’
 - 
v”‹x_¡
 + 1è* (
V”‹xD©aTy³
);

176 
size_t
 
	gd©a¡¬t
 = 
v”‹x_¡
 * (
V”‹xD©aTy³
);

177 ià(
	gasync
) {

178 
	giomgr
->
mªaged_pwr™—_async
(
fedesc
, &
lßded_chunk
, 
d©asize
, 
d©a¡¬t
, 
çl£
);

180 
	giomgr
->
mªaged_pwr™—_now
(
fedesc
, &
lßded_chunk
, 
d©asize
, 
d©a¡¬t
);

191 
vid_t
 
fœ¡_v”‹x_id
() {

192 ià(!
	gu£_mm­
) {

193 
as£¹
(
lßded_chunk
 !ğ
NULL
);

194  
	gv”‹x_¡
;

201 
V”‹xD©aTy³
 * 
v”‹x_d©a_±r
(
vid_t
 
v”‹xid
) {

202 ià(!
	gu£_mm­
) {

203 
as£¹
(
v”‹xid
 >ğ
v”‹x_¡
 && v”‹xid <ğ
v”‹x_’
);

204  &
	glßded_chunk
[
v”‹xid
 - 
v”‹x_¡
];

206  &
	gmm­_fe
[
v”‹xid
];

	@engine/bitset_scheduler.hpp

29 #iâdeà
DEF_GRAPHCHI_BITSETSCHEDULER


30 
	#DEF_GRAPHCHI_BITSETSCHEDULER


	)

32 
	~"g¿phchi_ty³s.hµ
"

33 
	~"­i/ischeduËr.hµ
"

34 
	~"ut/d’£_b™£t.hµ
"

36 
Çme¥aû
 
	gg¿phchi
 {

38 şas 
	cb™£t_scheduËr
 : 
public
 
ischeduËr
 {

39 
´iv©e
:

40 
d’£_b™£t
 * 
cur™”©iÚ_b™£t
;

41 
d’£_b™£t
 * 
	gÃxt™”©iÚ_b™£t
;

42 
	gpublic
:

43 
boŞ
 
has_Ãw_sks
;

45 
b™£t_scheduËr
(
nv”tiûs
) {

46 
	gcur™”©iÚ_b™£t
 = 
Ãw
 
d’£_b™£t
(
nv”tiûs
);

47 
	gÃxt™”©iÚ_b™£t
 = 
Ãw
 
d’£_b™£t
(
nv”tiûs
);

50 
Ãw_™”©iÚ
(
™”©iÚ
) {

51 ià(
	g™”©iÚ
 > 0) {

53 
d’£_b™£t
 * 
	gtmp
 = 
cur™”©iÚ_b™£t
;

54 
	gcur™”©iÚ_b™£t
 = 
Ãxt™”©iÚ_b™£t
;

55 
	gÃxt™”©iÚ_b™£t
 = 
tmp
;

56 
	gÃxt™”©iÚ_b™£t
->
ş—r
();

61 
	gvœtu®
 ~
b™£t_scheduËr
() {

62 
d–‘e
 
	gÃxt™”©iÚ_b™£t
;

63 
d–‘e
 
	gcur™”©iÚ_b™£t
;

66 
šlše
 
add_sk
(
vid_t
 
v”‹x
, 
boŞ
 
®so_this_™”©iÚ
=
çl£
) {

67 
Ãxt™”©iÚ_b™£t
->
£t_b™
(
v”‹x
);

68 ià(
	g®so_this_™”©iÚ
) {

70 
	gcur™”©iÚ_b™£t
->
£t_b™
(
v”‹x
);

72 
	ghas_Ãw_sks
 = 
Œue
;

75 
»size
(
vid_t
 
maxsize
) {

76 
	gcur™”©iÚ_b™£t
->
»size
(
maxsize
);

77 
	gÃxt™”©iÚ_b™£t
->
»size
(
maxsize
);

81 
šlše
 
boŞ
 
is_scheduËd
(
vid_t
 
v”‹x
) {

82  
	gcur™”©iÚ_b™£t
->
g‘
(
v”‹x
);

85 
»move_sks
(
vid_t
 
äomv”‹x
, vid_ˆ
tov”‹x
) {

86 
	gÃxt™”©iÚ_b™£t
->
ş—r_b™s
(
äomv”‹x
, 
tov”‹x
);

91 
add_sk_to_®l
() {

92 
	ghas_Ãw_sks
 = 
Œue
;

93 
	gcur™”©iÚ_b™£t
->
£Î
();

96 
size_t
 
num_sks
() {

97 
size_t
 
	gn
 = 0;

98 
vid_t
 
	gi
=0; i < 
	gcur™”©iÚ_b™£t
->
size
(); i++) {

99 
	gn
 +ğ
cur™”©iÚ_b™£t
->
g‘
(
i
);

101  
	gn
;

	@engine/dynamic_graphs/edgebuffers.hpp

29 #iâdeà
DEF_GRAPHCHI_EDGEBUFFERS


30 
	#DEF_GRAPHCHI_EDGEBUFFERS


	)

32 
	~<¡dlib.h
>

33 
	~<veùÜ
>

36 
Çme¥aû
 
	gg¿phchi
 {

42 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

43 
	sü—‹d_edge
 {

44 
vid_t
 
	g¤c
;

45 
vid_t
 
	gd¡
;

46 
EdgeD©aTy³
 
	gd©a
;

47 
boŞ
 
	gaccouÁed_fÜ_outc
;

48 
boŞ
 
	gaccouÁed_fÜ_šc
;

49 
ü—‹d_edge
(
vid_t
 
¤c
, vid_ˆ
d¡
, 
EdgeD©aTy³
 
_d©a
è: src(¤c), d¡(d¡), 
d©a
(_d©a), 
accouÁed_fÜ_outc
(
çl£
),

50 
accouÁed_fÜ_šc
(
çl£
) {}

53 
	#EDGE_BUFFER_CHUNKSIZE
 65536

	)

59 
	g‹m¶©e
 <
ty³Çme
 
	gET
>

60 şas 
	cedge_bufãr_æ©
 {

62 
	gcouÁ
;

63 
	g¡d
::
veùÜ
<
ü—‹d_edge
<
ET
> *> 
bufs
;

65 
	gpublic
:

67 
edge_bufãr_æ©
(è: 
couÁ
(0) {

70 ~
edge_bufãr_æ©
() {

71 
ş—r
();

74 
ş—r
() {

75 
	gi
=0; i< ()
	gbufs
.
size
(); i++) {

76 
ä“
(
bufs
[
i
]);

78 
	gbufs
.
ş—r
();

79 
	gcouÁ
 = 0;

82 
size
() {

83  
	gcouÁ
;

86 
	gü—‹d_edge
<
	gET
> * 
	gİ”©Ü
[](
	gi
) {

87  &
	gbufs
[
i
 / 
EDGE_BUFFER_CHUNKSIZE
][i % EDGE_BUFFER_CHUNKSIZE];

90 
add
(
vid_t
 
¤c
, vid_ˆ
d¡
, 
ET
 
d©a
) {

91 
add
(
ü—‹d_edge
<
ET
>(
¤c
, 
d¡
, 
d©a
));

94 
add
(
ü—‹d_edge
<
ET
> 
ûdge
) {

95 
	gidx
 = 
couÁ
++;

96 
	gbufidx
 = 
idx
 / 
EDGE_BUFFER_CHUNKSIZE
;

97 ià(
	gbufidx
 =ğ(è
bufs
.
size
()) {

98 
bufs
.
push_back
((
ü—‹d_edge
<
ET
>*)
ÿÎoc
((ü—‹d_edge<ET>), 
EDGE_BUFFER_CHUNKSIZE
));

100 
	gbufs
[
bufidx
][
idx
 % 
EDGE_BUFFER_CHUNKSIZE
] = 
ûdge
;

103 
	g´iv©e
:

105 
edge_bufãr_æ©
(constƒdge_buffer_flat&);

106 
	gedge_bufãr_æ©
& 
	gİ”©Ü
=(cÚ¡ 
edge_bufãr_æ©
&);

	@engine/dynamic_graphs/graphchi_dynamicgraph_engine.hpp

31 #iâdeà
GRAPHCHI_DYNAMICGRAPHENGINE_DEF


32 
	#GRAPHCHI_DYNAMICGRAPHENGINE_DEF


	)

34 
	~<¡dlib.h
>

35 
	~<veùÜ
>

37 
	~"’gše/g¿phchi_’gše.hµ
"

38 
	~"’gše/dyÇmic_g¿phs/edgebufãrs.hµ
"

39 
	~"logg”/logg”.hµ
"

42 
Çme¥aû
 
	gg¿phchi
 {

48 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
,y³Çm
	gEdgeD©aTy³
,y³Çm
	gsv”‹x_t
 = 
g¿phchi_v”‹x
<
V”‹xD©aTy³
, EdgeDataType> >

49 
şass
 
	gg¿phchi_dyÇmicg¿ph_’gše
 : 
public
 
g¿phchi_’gše
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
, 
	gsv”‹x_t
> {

50 
	gpublic
:

51 
g¿phchi_’gše
<
	tV”‹xD©aTy³
, 
	tEdgeD©aTy³
> 
	tba£_’gše
;

52 
	gedge_bufãr_æ©
<
	tEdgeD©aTy³
> 
	tedge_bufãr
;

54 
g¿phchi_dyÇmicg¿ph_’gše
(
¡d
::
¡ršg
 
ba£_f’ame
, 
nsh¬ds
, 
boŞ
 
£Ëùive_schedulšg
, 
m‘rics
 &
_m
) :

55 
g¿phchi_’gše
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
, 
	gsv”‹x_t
>(
	gba£_f’ame
, 
	gnsh¬ds
, 
	g£Ëùive_schedulšg
, 
	g_m
){

56 
	g_m
.
£t
("engine", "dynamicgraphs");

57 
	gadded_edges
 = 0;

58 
	gÏ¡_comm™
 = 0;

59 
	gmaxsh¬dsize
 = 200 * 1024 * 1024;

62 
	g´Ùeùed
:

67 
¡d
::
veùÜ
< std::veùÜ< 
edge_bufãr
 * > > 
Ãw_edge_bufãrs
;

68 
	g¡d
::
veùÜ
<> 
d–‘ecouÁs
;

69 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
sh¬d_suffiûs
;

71 
vid_t
 
	gmax_v”‹x_id
;

72 
size_t
 
	gmax_edge_bufãr
;

73 
size_t
 
	gÏ¡_comm™
;

74 
size_t
 
	gadded_edges
;

75 
	g¡d
::
¡ršg
 
¡©e
;

76 
size_t
 
	gmaxsh¬dsize
;

77 
size_t
 
	gedges_š_sh¬ds
;

78 
size_t
 
	gÜig_edges
;

83 
mu‹x
 
	gscheduË¾ock
;

84 
mu‹x
 
	gsh¬dlock
;

89 
vœtu®
 
boŞ
 
di§bË_´–ßdšg
() {

90  
	gŒue
;

96 
vœtu®
 
deg»e_d©a
 * 
ü—‹_deg»e_hªdËr
() {

98 
	g¡d
::
¡ršg
 
Üig_deg»e_fe
 = 
f’ame_deg»e_d©a
(
this
->
ba£_f’ame
);

99 
	g¡d
::
¡ršg
 
dynsuffix
 = ".dynamic";

100 
	g¡d
::
¡ršg
 
dyÇmic_deg»e_fe
 = 
f’ame_deg»e_d©a
(
this
->
ba£_f’ame
 + 
dynsuffix
);

101 
ı
(
Üig_deg»e_fe
, 
dyÇmic_deg»e_fe
);

102  
Ãw
 
deg»e_d©a
(
this
->
ba£_f’ame
 + 
dynsuffix
,his->
iomgr
);

104 
vœtu®
 
size_t
 
num_edges
() {

105 
	gsh¬dlock
.
lock
();

106 
size_t
 
	gÃ
 = 0;

107 
	gi
=0; i < 
	gthis
->
	gnsh¬ds
; i++) {

108 
	gÃ
 +ğ
this
->
¦idšg_sh¬ds
[
i
]->
num_edges
();

109 
	gj
=0; j < (è
	gÃw_edge_bufãrs
[
i
].
size
(); j++)

110 
	gÃ
 +ğ
Ãw_edge_bufãrs
[
i
][
j
]->
size
();

112 
	gsh¬dlock
.
uÆock
();

113  
	gÃ
;

116 
	gpublic
:

118 
size_t
 
num_edges_§ã
() {

119  
added_edges
 + 
Üig_edges
;

122 
size_t
 
num_bufã»d_edges
() {

123  
	gadded_edges
 - 
	gÏ¡_comm™
;

126 
	g´Ùeùed
:

127 
š™_bufãrs
() {

128 
max_edge_bufãr
 = 
g‘_İtiÚ_lÚg
("max_edgebufãr_mb", 1000è* 1024 * 1024 / (
	gü—‹d_edge
<
	gEdgeD©aTy³
>);

131 
	g¡d
::
veùÜ
< 
¡d
::veùÜ< 
edge_bufãr
 * > > 
tmp_Ãw_edge_bufãrs
;

132 
	gi
=0; i < 
	gthis
->
	gnsh¬ds
; i++) {

133 
	g¡d
::
veùÜ
<
edge_bufãr
 *> 
sh¬dbufãrs
 = 
¡d
::vector<edge_buffer *>();

134 
	gj
=0; j < 
	gthis
->
	gnsh¬ds
; j++) {

135 
	gsh¬dbufãrs
.
push_back
(
Ãw
 
edge_bufãr
());

137 
	gtmp_Ãw_edge_bufãrs
.
push_back
(
sh¬dbufãrs
);

142 
	gi
 = 0;

143 
ty³Çme
 
	g¡d
::
veùÜ
< 
¡d
::veùÜ< 
edge_bufãr
 * > >::
™”©Ü
 
Şd™
 = 
Ãw_edge_bufãrs
.
begš
();

144 
	gŞd™
 !ğ
Ãw_edge_bufãrs
.
’d
(); ++oldit) {

145 
ty³Çme
 
	g¡d
::
veùÜ
< 
edge_bufãr
 *>::
™”©Ü
 
buf™
 = 
Şd™
->
begš
(); 
	gbuf™
 !ğŞd™->
’d
(); ++bufit) {

146 
	gedge_bufãr
 &
	gbufãr_fÜ_wšdow
 = **
buf™
;

147 
	gebi
 = 0;ƒb˜< 
	gbufãr_fÜ_wšdow
.
size
();ƒbi++ ) {

148 
	gü—‹d_edge
<
	gEdgeD©aTy³
> * 
	gedge
 = 
bufãr_fÜ_wšdow
[
ebi
];

149 
	gsh¬d
 = 
g‘_sh¬d_fÜ
(
edge
->
d¡
);

150 
	g¤csh¬d
 = 
g‘_sh¬d_fÜ
(
edge
->
¤c
);

151 
	gi
++;

152 
	gtmp_Ãw_edge_bufãrs
[
sh¬d
][
¤csh¬d
]->
add
(*
edge
);

154 
d–‘e
 *
	gbuf™
;

158 
	g¡d
::
cout
 << "TRANSFERRED " << 
i
 << " EDGES OVER." << 
¡d
::
’dl
;

160 
	gÃw_edge_bufãrs
 = 
tmp_Ãw_edge_bufãrs
;

168 
size_t
 
ı
(
¡d
::
¡ršg
 
Üigfe
, std::¡ršg 
d¡fe
, 
boŞ
 
z”oout
=
çl£
) {

169 * 
buf
;

170 
	gf
 = 
İ’
(
Üigfe
.
c_¡r
(), 
O_RDONLY
);

171 
size_t
 
	gËn
 = 
»adfuÎ
(
f
, &
buf
);

172 
	g¡d
::
cout
 << "L’gth: " << 
Ën
 << 
¡d
::
’dl
;

173 
	g¡d
::
cout
 << 
Üigfe
 << " ----> " << 
d¡fe
 << 
¡d
::
’dl
;

175 
şo£
(
f
);

176 
»move
(
d¡fe
.
c_¡r
());

177 
	gof
 = 
İ’
(
d¡fe
.
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

178 
as£¹
(
of
 >= 0);

179 ià(
	gz”oout
) {

180 
mem£t
(
buf
, 0, 
Ën
);

182 
wr™—
(
of
, 
buf
, 
Ën
);

184 
as£¹
(
g‘_fesize
(
Üigfe
è=ğg‘_fesize(
d¡fe
));

185 
şo£
(
of
);

186 
ä“
(
buf
);

187  
	gËn
;

191 
ıed©a
(
¡d
::
¡ršg
 
Üigfe
, std::¡ršg 
d¡fe
, 
boŞ
 
z”oout
=
çl£
) {

192 
ı
(
Üigfe
 + ".size", 
d¡fe
 + ".size");

193 
	g¡d
::
¡ršg
 
dœÇme
 = 
dœÇme_sh¬d_ed©a_block
(
d¡fe
, 
ba£_’gše
::
blocksize
);

194 
mkdœ
(
dœÇme
.
c_¡r
(), 0777);

195 
size_t
 
	ged©asize
 = 
g‘_sh¬d_ed©a_fesize
<
EdgeD©aTy³
>(
Üigfe
);

196 
	gnblocks
 = (è((
ed©asize
 / 
ba£_’gše
::
blocksize
) + (edatasize % base_engine::blocksize == 0 ? 0 : 1));

197 
	gi
=0; i < 
	gnblocks
; i++) {

198 
	g¡d
::
¡ršg
 
ÜigblockÇme
 = 
f’ame_sh¬d_ed©a_block
(
Üigfe
, 
i
, 
ba£_’gše
::
blocksize
);

199 
	g¡d
::
¡ršg
 
d¡blockÇme
 = 
f’ame_sh¬d_ed©a_block
(
d¡fe
, 
i
, 
ba£_’gše
::
blocksize
);

200 
ı
(
ÜigblockÇme
, 
d¡blockÇme
);

205 
vœtu®
 
ty³Çme
 
	gba£_’gše
::
memsh¬d_t
 * 
ü—‹_memsh¬d
(
vid_t
 
š‹rv®_¡
, vid_ˆ
š‹rv®_’
) {

206 
	gp
 = 
this
->
exec_š‹rv®
;

207 
	g¡d
::
¡ršg
 
adj_f’ame
 = 
f’ame_sh¬d_adj
(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
p
];

208 
	g¡d
::
¡ršg
 
ed©a_f’ame
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
p
];

209  
Ãw
 
ty³Çme
 
	gba£_’gše
::
memsh¬d_t
(
this
->
iomgr
,

210 
ed©a_f’ame
,

211 
adj_f’ame
,

212 
š‹rv®_¡
,

213 
š‹rv®_’
,

214 
ba£_’gše
::
blocksize
,

215 
this
->
m
);

222 
vœtu®
 
š™Ÿlize_¦idšg_sh¬ds
() {

223 
	g¡©e
 = "initialize-shards";

224 
	gsh¬dlock
.
lock
();

225 ià(
	gthis
->
	g¦idšg_sh¬ds
.
em±y
()) {

226 
	gp
=0;… < 
	gthis
->
	gnsh¬ds
;…++) {

227 
	g¡d
::
¡ršg
 
adj_f’ame
 = 
f’ame_sh¬d_adj
(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
p
];

228 
	g¡d
::
¡ršg
 
ed©a_f’ame
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
p
];

230 
	gthis
->
	g¦idšg_sh¬ds
.
push_back
(

231 
Ãw
 
ty³Çme
 
ba£_’gše
::
¦idšgsh¬d_t
(
this
->
iomgr
, 
ed©a_f’ame
,

232 
adj_f’ame
,

233 
this
->
š‹rv®s
[
p
].
fœ¡
,

234 
this
->
š‹rv®s
[
p
].
£cÚd
,

235 
this
->
blocksize
,

236 
this
->
m
,

237 !
this
->
modif›s_ou‹dges
,

238 
çl£
));

241 
	gp
=0;… < 
	gthis
->
	gnsh¬ds
;…++) {

242 ià(
	gthis
->
	g¦idšg_sh¬ds
[
p
] =ğ
NULL
) {

243 
¡d
::
¡ršg
 
adj_f’ame
 = 
f’ame_sh¬d_adj
(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
p
];

244 
	g¡d
::
¡ršg
 
ed©a_f’ame
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
p
];

246 
	gthis
->
	g¦idšg_sh¬ds
[
p
] = 
Ãw
 
ty³Çme
 
ba£_’gše
::
¦idšgsh¬d_t
(
this
->
iomgr
, 
ed©a_f’ame
,

247 
adj_f’ame
,

248 
this
->
š‹rv®s
[
p
].
fœ¡
,

249 
this
->
š‹rv®s
[
p
].
£cÚd
,

250 
this
->
blocksize
,

251 
this
->
m
,

252 !
this
->
modif›s_ou‹dges
,

253 
çl£
);

257 
	gsh¬dlock
.
uÆock
();

258 
	gedges_š_sh¬ds
 = 
num_edges
();

259 ià(
	gÜig_edges
 =ğ0è
Üig_edges
 = 
edges_š_sh¬ds
;

262 
´•¬e_ş—n_¦©e
() {

263 
log¡»am
(
LOG_INFO
è<< "P»·ršg cËª sÏ‹..." << 
	g¡d
::
’dl
;

264 
	gsh¬d
=0; sh¬d < 
	gthis
->
	gnsh¬ds
; shard++) {

265 
	gsh¬d_suffiûs
.
push_back
(
g‘_·¹_¡r
(
sh¬d
, 
this
->
nsh¬ds
));

267 
	g¡d
::
¡ršg
 
ed©a_f’ame
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
this
->
ba£_f’ame
, 
	gsh¬d
, 
	gthis
->
	gnsh¬ds
);

268 
	g¡d
::
¡ršg
 
adj_f’ame
 = 
f’ame_sh¬d_adj
(
this
->
ba£_f’ame
, 
sh¬d
,his->
nsh¬ds
);

269 
	g¡d
::
¡ršg
 
de¡_adj
 = 
f’ame_sh¬d_adj
(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
sh¬d
];

270 
	g¡d
::
¡ršg
 
de¡_ed©a
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
sh¬d
];

272 
ıed©a
(
ed©a_f’ame
, 
de¡_ed©a
, 
Œue
);

273 
ı
(
adj_f’ame
, 
de¡_adj
);

274 
ı
(
f’ame_sh¬d_adjidx
(
adj_f’ame
), f’ame_sh¬d_adjidx(
de¡_adj
));

279 
g‘_sh¬d_fÜ
(
vid_t
 
d¡
) {

280 
	gi
=0; i < 
	gthis
->
	gnsh¬ds
; i++) {

281 ià(
	gd¡
 >ğ
this
->
š‹rv®s
[
i
].
fœ¡
 && 
d¡
 <ğthis->š‹rv®s[i].
£cÚd
) {

282  
i
;

285  
	gthis
->
	gnsh¬ds
 - 1;

288 
	gpublic
:

289 
boŞ
 
add_edge
(
vid_t
 
¤c
, vid_ˆ
d¡
, 
EdgeD©aTy³
 
ed©a
) {

290 ià(
	g¤c
 =ğ
d¡
) {

291 
log¡»am
(
LOG_WARNING
è<< "WARNING :r›dØadd s–f-edge!" << 
¡d
::
’dl
;

292  
	gŒue
;

294 ià(
	gthis
->
	g™”
 < 1) {

295 
log¡»am
(
LOG_WARNING
è<< "Tr›dØaddƒdgbefÜfœ¡ i‹¿tiÚ ha ·s£d" << 
	g¡d
::
’dl
;

296 
u¦“p
(1000000);

297  
	gçl£
;

299 ià(
	gadded_edges
 - 
	gÏ¡_comm™
 > 1.2 * 
	gmax_edge_bufãr
) {

300 
log¡»am
(
LOG_INFO
è<< "Ov” 20% oàmax bufãr... hŞd on...." << 
	g¡d
::
’dl
;

301 
u¦“p
(1000000);

302  
	gçl£
;

304 
	gthis
->
	gmodifiÿtiÚ_lock
.
lock
();

305 
	gadded_edges
++;

306 
	gsh¬d
 = 
g‘_sh¬d_fÜ
(
d¡
);

307 
	g¤csh¬d
 = 
g‘_sh¬d_fÜ
(
¤c
);

309 
vid_t
 
	g´ev_max_id
 = 
max_v”‹x_id
;

310 
	gmax_v”‹x_id
 = 
¡d
::
max
(
max_v”‹x_id
, 
d¡
);

311 
	gmax_v”‹x_id
 = 
¡d
::
max
(
max_v”‹x_id
, 
¤c
);

314 ià(
	gmax_v”‹x_id
>
	g´ev_max_id
) {

315 
	gthis
->
	gdeg»e_hªdËr
->
’su»_size
(
this
->
max_v”‹x_id
);

318 ià(
	gthis
->
	gscheduËr
 !ğ
NULL
) {

319 
scheduË¾ock
.
lock
();

320 
	gthis
->
	gscheduËr
->
»size
(1 + 
max_v”‹x_id
);

321 
	gscheduË¾ock
.
uÆock
();

326 
	gÃw_edge_bufãrs
[
sh¬d
][
¤csh¬d
]->
add
(
¤c
, 
d¡
, 
ed©a
);

327 
	gthis
->
	gmodifiÿtiÚ_lock
.
uÆock
();

328  
	gŒue
;

331 
add_sk
(
vid_t
 
vid
) {

332 ià(
	gthis
->
	gscheduËr
 !ğ
NULL
) {

333 
this
->
modifiÿtiÚ_lock
.
lock
();

334 
	gthis
->
	gscheduËr
->
add_sk
(
vid
);

335 
	gthis
->
	gmodifiÿtiÚ_lock
.
uÆock
();

339 
	g´Ùeùed
:

340 
šcÜpÜ©e_bufã»d_edges
(
wšdow
, 
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
¡d
::
veùÜ
<
sv”‹x_t
> & 
v”tiûs
) {

342 
nü—‹d
 = 0;

344 
	gsh¬d
=0; sh¬d<
	gthis
->
	gnsh¬ds
; shard++) {

345 
	gedge_bufãr
 &
	gbufãr_fÜ_wšdow
 = *
Ãw_edge_bufãrs
[
sh¬d
][
wšdow
];

346 
	gebi
=0;ƒbi<
	gbufãr_fÜ_wšdow
.
size
();ƒbi++) {

347 
	gü—‹d_edge
<
	gEdgeD©aTy³
> * 
	gedge
 = 
bufãr_fÜ_wšdow
[
ebi
];

348 ià(
	gedge
->
	g¤c
 >ğ
wšdow_¡
 && 
edge
->
¤c
 <ğ
wšdow_’
) {

349 ià(
v”tiûs
[
edge
->
¤c
-
wšdow_¡
].
scheduËd
) {

350 ià(
v”tiûs
[
edge
->
¤c
-
wšdow_¡
].
scheduËd
)

351 
v”tiûs
[
edge
->
¤c
-
wšdow_¡
].
add_ou‹dge
Ódge->
d¡
, &edge->
d©a
, 
çl£
);

352 
	gnü—‹d
++;

359 
	gw
=0; w<
	gthis
->
	gnsh¬ds
; w++) {

360 
	gedge_bufãr
 &
	gbufãr_fÜ_wšdow
 = *
Ãw_edge_bufãrs
[
wšdow
][
w
];

361 
	gebi
=0;ƒbi<
	gbufãr_fÜ_wšdow
.
size
();ƒbi++) {

362 
	gü—‹d_edge
<
	gEdgeD©aTy³
> * 
	gedge
 = 
bufãr_fÜ_wšdow
[
ebi
];

363 ià(
	gedge
->
	gd¡
 >ğ
wšdow_¡
 && 
edge
->
d¡
 <ğ
wšdow_’
) {

364 ià(
v”tiûs
[
edge
->
d¡
 - 
wšdow_¡
].
scheduËd
) {

365 ià(
v”tiûs
[
edge
->
d¡
-
wšdow_¡
].
scheduËd
)

366 
v”tiûs
[
edge
->
d¡
 - 
wšdow_¡
].
add_šedge
Ódge->
¤c
, &edge->
d©a
, 
çl£
);

367 
	gnü—‹d
++;

372 
log¡»am
(
LOG_INFO
è<< "::: U£d " << 
	gnü—‹d
 << " bufã»dƒdges." << 
	g¡d
::
’dl
;

375 
boŞ
 
šcÜpÜ©e_Ãw_edge_deg»es
(
wšdow
, 
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
) {

376 
boŞ
 
	gmodif›d
 = 
çl£
;

378 
	gsh¬d
=0; sh¬d < 
	gthis
->
	gnsh¬ds
; shard++) {

379 
	gedge_bufãr
 &
	gbufãr_fÜ_wšdow
 = *
Ãw_edge_bufãrs
[
sh¬d
][
wšdow
];

380 
	gebi
=0;ƒbi<
	gbufãr_fÜ_wšdow
.
size
();ƒbi++) {

381 
	gü—‹d_edge
<
	gEdgeD©aTy³
> * 
	gedge
 = 
bufãr_fÜ_wšdow
[
ebi
];

382 ià(
	gedge
->
	g¤c
 >ğ
wšdow_¡
 && 
edge
->
¤c
 <ğ
wšdow_’
) {

383 ià(!
edge
->
accouÁed_fÜ_outc
) {

384 
deg»e
 
d
 = 
this
->
deg»e_hªdËr
->
g‘_deg»e
(
edge
->
¤c
);

385 
	gd
.
	goutdeg»e
++;

386 
	gthis
->
	gdeg»e_hªdËr
->
£t_deg»e
(
edge
->
¤c
, 
d
);

388 
	gmodif›d
 = 
Œue
;

389 
	gedge
->
	gaccouÁed_fÜ_outc
 = 
Œue
;

396 
	gw
=0; w < 
	gthis
->
	gnsh¬ds
; w++) {

397 
	gedge_bufãr
 &
	gbufãr_fÜ_wšdow
 = *
Ãw_edge_bufãrs
[
wšdow
][
w
];

398 
	gebi
=0;ƒbi<
	gbufãr_fÜ_wšdow
.
size
();ƒbi++) {

399 
	gü—‹d_edge
<
	gEdgeD©aTy³
> * 
	gedge
 = 
bufãr_fÜ_wšdow
[
ebi
];

400 ià(
	gedge
->
	gd¡
 >ğ
wšdow_¡
 && 
edge
->
d¡
 <ğ
wšdow_’
) {

401 ià(!
edge
->
accouÁed_fÜ_šc
) {

402 
deg»e
 
d
 = 
this
->
deg»e_hªdËr
->
g‘_deg»e
(
edge
->
d¡
);

403 
	gd
.
	gšdeg»e
++;

404 
	gthis
->
	gdeg»e_hªdËr
->
£t_deg»e
(
edge
->
d¡
, 
d
);

405 
	gedge
->
	gaccouÁed_fÜ_šc
 = 
Œue
;

406 
	gmodif›d
 = 
Œue
;

411  
	gmodif›d
;

414 
adju¡_deg»es_fÜ_d–‘ed
(
¡d
::
veùÜ
< 
sv”‹x_t
 > &
v”tiûs
, 
vid_t
 
wšdow_¡
) {

415 #ifdeà
SUPPORT_DELETIONS


417 
boŞ
 
	gsomechªged
 = 
çl£
;

418 
	gi
=0; i < ()
	gv”tiûs
.
size
(); i++) {

419 
	gsv”‹x_t
 &
	gv
 = 
v”tiûs
[
i
];

420 ià(
	gv
.
	gscheduËd
) {

421 
	gthis
->
	gdeg»e_hªdËr
->
£t_deg»e
(
v
.
id
(), v.
šc
, v.
outc
);

422 
	gsomechªged
 = 
somechªged
 || (
v
.
d–‘ed_šc
 + v.
d–‘ed_outc
 > 0);

423 
deg»e
 
	gdeg
 = 
this
->
deg»e_hªdËr
->
g‘_deg»e
(
v
.
id
());

425 ià(!(
	gdeg
.
	gšdeg»e
 >=0 && 
deg
.
outdeg»e
 >= 0)) {

426 
¡d
::
cout
 << "Deg»disü•ªcy: " << 
deg
.
šdeg»e
 << " " << deg.
outdeg»e
 << std::
’dl
;

428 
as£¹
(
deg
.
šdeg»e
 >=0 && deg.
outdeg»e
 >= 0);

431 ià(
	gsomechªged
) {

432 
	gthis
->
	gdeg»e_hªdËr
->
§ve
();

437 
vœtu®
 
vid_t
 
d‘”mše_Ãxt_wšdow
(vid_ˆ
iš‹rv®
, vid_ˆ
äomvid
, vid_ˆ
maxvid
, 
size_t
 
membudg‘
) {

439 
	gthis
->
	gdeg»e_hªdËr
->
lßd
(
äomvid
, 
maxvid
);

440 ià(
šcÜpÜ©e_Ãw_edge_deg»es
(
iš‹rv®
, 
äomvid
, 
maxvid
)) {

441 
	gthis
->
	gdeg»e_hªdËr
->
§ve
();

444 
size_t
 
	gmem»q
 = 0;

445 
	gmax_š‹rv®
 = 
maxvid
 - 
äomvid
;

446 
	gi
=0; i < 
	gmax_š‹rv®
; i++) {

447 
deg»e
 
	gdeg
 = 
this
->
deg»e_hªdËr
->
g‘_deg»e
(
äomvid
 + 
i
);

448 
	gšc
 = 
deg
.
šdeg»e
;

449 
	goutc
 = 
deg
.
outdeg»e
;

452 
	gmem»q
 +ğ(
sv”‹x_t
è+ ((
EdgeD©aTy³
è+ (
vid_t
) +

453 (
g¿phchi_edge
<
EdgeD©aTy³
>))*(
outc
 + 
šc
);

454 ià(
	gmem»q
 > 
	gmembudg‘
) {

455  
	gäomvid
 + 
	gi
 - 1;

458  
	gmaxvid
;

462 
vœtu®
 
lßd_befÜe_upd©es
(
¡d
::
veùÜ
<
sv”‹x_t
> &
v”tiûs
) {

463 
¡©e
 = "load-edges";

465 
	gthis
->
	gba£_’gše
::
lßd_befÜe_upd©es
(
v”tiûs
);

467 #ifdeà
SUPPORT_DELETIONS


468 
	gi
=0; i < ()
	gv”tiûs
.
size
(); i++) {

469 
	gd–‘ecouÁs
[
this
->
exec_š‹rv®
] +ğ
v”tiûs
[
i
].
d–‘ed_šc
;

473 
	g¡©e
 = "execute-updates";

477 
vœtu®
 
š™_v”tiûs
(
¡d
::
veùÜ
<
sv”‹x_t
> &
v”tiûs
, 
g¿phchi_edge
<
EdgeD©aTy³
> * &
ed©a
) {

478 
	gba£_’gše
::
š™_v”tiûs
(
v”tiûs
, 
ed©a
);

479 
šcÜpÜ©e_bufã»d_edges
(
this
->
exec_š‹rv®
,his->
sub_š‹rv®_¡
,his->
sub_š‹rv®_’
, 
v”tiûs
);

483 
vœtu®
 
š™Ÿlize_™”
() {

484 
	gthis
->
	gš‹rv®s
[
this
->
nsh¬ds
 - 1].
	g£cÚd
 = 
max_v”‹x_id
;

485 
	gthis
->
	gv”‹x_d©a_hªdËr
->
check_size
(
max_v”‹x_id
 + 1);

486 
š™Ÿlize_¦idšg_sh¬ds
();

489 
	gd–‘ecouÁs
.
ş—r
();

490 
	gp
=0;… < 
	gthis
->
	gnsh¬ds
;…++)

491 
	gd–‘ecouÁs
.
push_back
(0);

494 
vœtu®
 
™”©iÚ_fšished
() {

495 ià(
	gthis
->
	g™”
 <his->
	gn™”s
 - 1) {

497 
	gp
=0;… < 
	gthis
->
	gnsh¬ds
;…++) {

498 
	gthis
->
	g¦idšg_sh¬ds
[
p
]->
æush
();

499 
	gthis
->
	g¦idšg_sh¬ds
[
p
]->
£t_off£t
(0, 0, 0);

502 
	gthis
->
	giomgr
->
wa™_fÜ_wr™es
();

504 
comm™_g¿ph_chªges
();

508 
vœtu®
 
š™Ÿlize_befÜe_run
() {

509 
´•¬e_ş—n_¦©e
();

510 
š™_bufãrs
();

512 
	gmax_v”‹x_id
 = (
vid_t
è(
this
->
num_v”tiûs
() - 1);

514 
	gthis
->
	gv”‹x_d©a_hªdËr
->
ş—r
(
this
->
num_v”tiûs
());

515 
	gÜig_edges
 = 0;

520 
vœtu®
 
lßd_aá”_upd©es
(
¡d
::
veùÜ
<
sv”‹x_t
> &
v”tiûs
) {

521 
this
->
ba£_’gše
::
lßd_aá”_upd©es
(
v”tiûs
);

522 
adju¡_deg»es_fÜ_d–‘ed
(
v”tiûs
, 
this
->
sub_š‹rv®_¡
);

525 
	gpublic
:

526 
fšish_aá”_™”s
(
exŒa_™”s
) {

527 
this
->
chicÚ‹xt
.
Ï¡_™”©iÚ
 =his->chicÚ‹xt.
™”©iÚ
 + 
exŒa_™”s
;

530 
	g´Ùeùed
:

533 
	#BBUF
 32000000

	)

535 
size_t
 
cu¿djf•os
;

540 
comm™_g¿ph_chªges
() {

542 
size_t
 
	gnd–‘ed
 = 0;

543 
size_t
 
	gi
=0; i < 
	gd–‘ecouÁs
.
size
(); i++) {

544 
	gnd–‘ed
 +ğ
d–‘ecouÁs
[
i
];

549 
log¡»am
(
LOG_DEBUG
è<< "TÙ® d–‘ed: " << 
	gnd–‘ed
 << "Ù®ƒdges: " << 
	gthis
->
num_edges
(è<< 
	g¡d
::
’dl
;

551 ià(
	gadded_edges
 - 
	gÏ¡_comm™
 < 
	gmax_edge_bufãr
 * 0.8 && 
	gnd–‘ed
 < 
	gthis
->
num_edges
() * 0.1) {

552 
	g¡d
::
cout
 << "==============================" << 
¡d
::
’dl
;

553 
	g¡d
::
cout
 << "NØtimtØcomm™ y‘.... OÆy " << (
added_edges
 - 
Ï¡_comm™
è<< " / " << 
max_edge_bufãr


554 << " iÀbufãrs" << 
¡d
::
’dl
;

559 
boŞ
 
	g¿ngeschªged
 = 
çl£
;

560 
	g¡©e
 = "commit-ingests";

561 
vid_t
 
	gmaxwšdow
 = 4000000;

562 
size_t
 
	gmem_budg‘
 = 
this
->
membudg‘_mb
 * 1024 * 1024;

563 
	gthis
->
	gmodifiÿtiÚ_lock
.
lock
();

568 
	g¡d
::
veùÜ
<> 
edge¥”sh¬d
;

569 
	gp
=0;… < 
	gthis
->
	gnsh¬ds
;…++) {

570 
	gedge¥”sh¬d
.
push_back
(
this
->
¦idšg_sh¬ds
[
p
]->
num_edges
());

573 
	g¡d
::
veùÜ
<
¡d
::
·œ
<
vid_t
, 
	gvid_t
> > 
	gÃw¿nges
;

574 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Ãwsuffiûs
;

576 
	g™”¡r
[128];

577 
¥rštf
(
™”¡r
, "%d", 
this
->
™”
);

579 
size_t
 
	gmš_bufãr_š_sh¬d_to_comm™
 = 
max_edge_bufãr
 / 
this
->
nsh¬ds
 / 2;

581 
	g¡d
::
veùÜ
<
boŞ
> 
was_comm™ed
(
this
->
nsh¬ds
, 
Œue
);

583 
	gsh¬d
=0; sh¬d < 
	gthis
->
	gnsh¬ds
; shard++) {

584 
	g¡d
::
veùÜ
<
edge_bufãr
*> &
sh¬d_bufãr
 = 
Ãw_edge_bufãrs
[
sh¬d
];

587 
size_t
 
	gbuãdges
 = 0;

588 
	gw
=0; w < 
	gthis
->
	gnsh¬ds
; w++) {

589 
	gbuãdges
 +ğ
sh¬d_bufãr
[
w
]->
size
();

593 ià(
	gbuãdges
 < 
	gmš_bufãr_š_sh¬d_to_comm™
 && 
	gd–‘ecouÁs
[
sh¬d
] * 1.0 / 
	gedge¥”sh¬d
[shard] < 0.2) {

594 
log¡»am
(
LOG_DEBUG
è<< 
	gsh¬d
 << ":‚Ùƒnoughƒdge fÜ sh¬d: " << 
	gbuãdges
 << " d–‘ed:" << 
	gd–‘ecouÁs
[
sh¬d
] << "/" << 
	gedge¥”sh¬d
[sh¬d] << 
	g¡d
::
’dl
;

595 
	gÃw¿nges
.
push_back
(
this
->
š‹rv®s
[
sh¬d
]);

596 
	gÃwsuffiûs
.
push_back
(
sh¬d_suffiûs
[
sh¬d
]);

597 
	gwas_comm™ed
[
sh¬d
] = 
çl£
;

600 
log¡»am
(
LOG_DEBUG
è<< 
	gsh¬d
 << ": gošgØ»wr™e, d–‘ed:" << 
	gd–‘ecouÁs
[
sh¬d
] << "/" << 
	gedge¥”sh¬d
[sh¬d] << " buãdges: " << 
	gbuãdges
 << 
	g¡d
::
’dl
;

601 
	gsh¬dlock
.
lock
();

602 
d–‘e
 
	gthis
->
	g¦idšg_sh¬ds
[
sh¬d
];

603 
	gthis
->
	g¦idšg_sh¬ds
[
sh¬d
] = 
NULL
;

604 
	gsh¬dlock
.
uÆock
();

606 
	g¡d
::
¡ršg
 
Üigsh¬dfe
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
sh¬d
];

607 
	g¡d
::
¡ršg
 
Üigadjfe
 = 
f’ame_sh¬d_adj
(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
sh¬d
];

610 
off_t
 
	gsz
 = 
g‘_sh¬d_ed©a_fesize
<
EdgeD©aTy³
>(
Üigsh¬dfe
);

612 
	gou¬ts
 = ( 
sz
 >ğ(
off_t
è
maxsh¬dsize
 ? 2 : 1);

614 
vid_t
 
	g¥l™pos
 = 0;

615 
	g¡d
::
cout
 << "Size: " << 
sz
 << " vs. maxsh¬dsize: " << 
maxsh¬dsize
 << 
¡d
::
’dl
;

616 ià(
	gsz
 > (
	goff_t
)
	gmaxsh¬dsize
) {

617 
	g¿ngeschªged
 = 
Œue
;

619 
size_t
 
	gh®ãdges
 = (
sz
 / (
EdgeD©aTy³
)) / 2;

621 
	gw
=0; w < 
	gthis
->
	gnsh¬ds
; w++) {

622 
	gh®ãdges
 +ğ
Ãw_edge_bufãrs
[
sh¬d
][
w
]->
size
() / 2;

624 
size_t
 
	gÃdges
 = 0;

626 
vid_t
 
	g¡
 = 
this
->
š‹rv®s
[
sh¬d
].
fœ¡
;

627 
	g¥l™pos
 = 
¡
 + (
this
->
š‹rv®s
[
sh¬d
].
£cÚd
 - st) / 2;

628 
boŞ
 
	gfound
 = 
çl£
;

629 
	g¡
 < 
	gthis
->
	gš‹rv®s
[
sh¬d
].
	g£cÚd
) {

630 
vid_t
 
	g’
 = 
¡d
::
mš
(
¡
 + 
maxwšdow
, 
this
->
š‹rv®s
[
sh¬d
].
£cÚd
);

631 
	gthis
->
	gdeg»e_hªdËr
->
lßd
(
¡
, 
’
);

632 
	gnv
 = 
’
 - 
¡
 + 1;

634 
	gi
=0; i<
	gnv
; i++) {

635 
	gÃdges
 +ğ
this
->
deg»e_hªdËr
->
g‘_deg»e
(
¡
 + 
i
).
šdeg»e
;

636 ià(
	gÃdges
 >ğ
h®ãdges
) {

637 
¥l™pos
 = 
i
+
¡
-1;

638 
	gfound
 = 
Œue
;

642 ià(
	gfound
) ;

643 
	g¡
 = 
’
+1;

645 
as£¹
(
¥l™pos
 > 
this
->
š‹rv®s
[
sh¬d
].
fœ¡
 && s¶™po <his->š‹rv®s[sh¬d].
£cÚd
);

648 
	g¥l™s
=0; s¶™s<
	gou¬ts
; splits++) {

649 
ty³Çme
 
	gba£_’gše
::
¦idšgsh¬d_t
 * 
cursh¬d
 =

650 
Ãw
 
ty³Çme
 
ba£_’gše
::
¦idšgsh¬d_t
(
this
->
iomgr
, 
Üigsh¬dfe
, 
Üigadjfe
,

651 
this
->
š‹rv®s
[
sh¬d
].
fœ¡
,his->š‹rv®s[sh¬d].
£cÚd
,

652 
ba£_’gše
::
blocksize
, 
this
->
m
, 
Œue
);

655 
	g¡d
::
¡ršg
 
suffix
 = "";

656 
	g·¹¡r
[128];

657 
¥rštf
(
·¹¡r
, "%d", 
sh¬d
);

658 ià(
	g¥l™s
 == 0) {

659 
suffix
 = 
¡d
::
¡ršg
(
·¹¡r
);

661 
	gsuffix
 = 
¡d
::
¡ršg
(
·¹¡r
) + ".split";

663 
	gsuffix
 = 
suffix
 + ".i" + 
¡d
::
¡ršg
(
™”¡r
);

664 
	gÃwsuffiûs
.
push_back
(
suffix
);

665 
	gcu¿djf•os
 = 0;

666 
	g¡d
::
¡ršg
 
outfe_ed©a
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsuffix
;

667 
	g¡d
::
¡ršg
 
outfe_ed©a_dœÇme
 = 
dœÇme_sh¬d_ed©a_block
(
outfe_ed©a
, 
ba£_’gše
::
blocksize
);

668 
mkdœ
(
outfe_ed©a_dœÇme
.
c_¡r
(), 0777);

669 
	g¡d
::
¡ršg
 
outfe_adj
 = 
f’ame_sh¬d_adj
(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsuffix
;

671 
vid_t
 
	g¥l™¡¬t
 = 
this
->
š‹rv®s
[
sh¬d
].
fœ¡
;

672 
vid_t
 
	g¥l™’d
 = 
this
->
š‹rv®s
[
sh¬d
].
£cÚd
;

673 ià(
	gsh¬d
 =ğ
this
->
nsh¬ds
 - 1è
¥l™’d
 = 
max_v”‹x_id
;

676 ià(
	gou¬ts
 == 2) {

677 ià(
¥l™s
==0è
¥l™’d
 = 
¥l™pos
;

678 
	g¥l™¡¬t
 = 
¥l™pos
+1;

680 
	gÃw¿nges
.
push_back
(
¡d
::
·œ
<
vid_t
,vid_t>(
¥l™¡¬t
, 
¥l™’d
));

683 
	gf
 = 
İ’
(
outfe_adj
.
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

684 
	g”r
 = 
árunÿ‹
(
f
, 0);

685 ià(
	g”r
 != 0) {

686 
log¡»am
(
LOG_ERROR
è<< "E¼Ürunÿtšg " << 
outfe_adj
 << ",ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

688 
as£¹
(
”r
 == 0);

690 
	gef
 = 
İ’
(
outfe_ed©a
.
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

691 
	g”r
 = 
árunÿ‹
(
ef
, 0);

692 ià(
	g”r
 != 0) {

693 
log¡»am
(
LOG_ERROR
è<< "E¼Ürunÿtšg " << 
outfe_ed©a
 << ",ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

695 
as£¹
(
”r
 == 0);

696 * 
	gbuf
 = (*è
m®loc
(
BBUF
);

697 * 
	gbuåŒ
 = 
buf
;

698 * 
	gebuf
 = (*è
m®loc
(
BBUF
);

699 * 
	gebuåŒ
 = 
ebuf
;

700 
size_t
 
	gtÙ_ed©aby‹s
 = 0;

703 
	g¡d
::
¡ršg
 
šdexfe
 = 
f’ame_sh¬d_adjidx
(
outfe_adj
);

704 
	gidxf
 = 
İ’
(
šdexfe
.
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

705 
size_t
 
	gÏ¡_šdex_ouut
 = 0;

706 
size_t
 
	gšdex_š‹rv®_edges
 = 1024 * 1024;

707 
size_t
 
	gedgecouÁ”
 = 0;

708 
as£¹
(
idxf
>0);

712 
	gwšdow
=0; wšdow < 
	gthis
->
	gnsh¬ds
; window++) {

713 
vid_t
 
	g¿nge_¡
 = 
this
->
š‹rv®s
[
wšdow
].
fœ¡
;

714 
vid_t
 
	g¿nge_’
 = 
this
->
š‹rv®s
[
wšdow
].
£cÚd
;

715 ià(
	gwšdow
 =ğ
this
->
nsh¬ds
 - 1è
¿nge_’
 = 
max_v”‹x_id
;

716 
	gedge_bufãr
 &
	gbufãr_fÜ_wšdow
 = *
Ãw_edge_bufãrs
[
sh¬d
][
wšdow
];

718 
vid_t
 
	gwšdow_¡
=
¿nge_¡
; wšdow_¡<
	g¿nge_’
; ) {

720 
vid_t
 
	gwšdow_’
 = 
d‘”mše_Ãxt_wšdow
(
wšdow
, 
wšdow_¡
,

721 
¡d
::
mš
(
¿nge_’
, 
wšdow_¡
 + (
vid_t
)
maxwšdow
), 
mem_budg‘
);

723 
	gnv”tiûs
 = 
wšdow_’
-
wšdow_¡
+1;

724 
	g¡d
::
veùÜ
< 
sv”‹x_t
 > 
v”tiûs
(
nv”tiûs
, svertex_t());

726 
	gg¿phchi_edge
<
	gEdgeD©aTy³
> * 
	ged©a
 = 
NULL
;

727 
size_t
 
	gnum_edges
=0;

728 
	gi
=0; i<
	gnv”tiûs
; i++) {

729 
deg»e
 
	gd
 = 
this
->
deg»e_hªdËr
->
g‘_deg»e
(
i
 + 
wšdow_¡
);

730 
	gnum_edges
 +ğ
d
.
šdeg»e
+d.
outdeg»e
;

732 
size_t
 
	gecouÁ”
 = 0;

733 
	ged©a
 = (
g¿phchi_edge
<
EdgeD©aTy³
>*)
m®loc
(
num_edges
 * (graphchi_edge<EdgeDataType>));

734 
	gi
=0; i<()
	gnv”tiûs
; i++) {

736 
deg»e
 
	gd
 = 
this
->
deg»e_hªdËr
->
g‘_deg»e
(
i
 + 
wšdow_¡
);

737 
	goutc
 = 
d
.
outdeg»e
;

738 
	gv”tiûs
[
i
] = 
sv”‹x_t
(
wšdow_¡
+i, &
ed©a
[
ecouÁ”
],

739 &
ed©a
[
ecouÁ”
+0], 0, 
outc
);

740 
	gv”tiûs
[
i
].
	gscheduËd
 = 
Œue
;

741 
	gecouÁ”
 +ğ0 + 
outc
;

745 
	gcursh¬d
->
»ad_Ãxt_v”tiûs
(
nv”tiûs
, 
wšdow_¡
, 
v”tiûs
, 
çl£
, 
Œue
);

748 
	gebi
=0;ƒbi<
	gbufãr_fÜ_wšdow
.
size
();ƒbi++) {

749 
	gü—‹d_edge
<
	gEdgeD©aTy³
> * 
	gedge
 = 
bufãr_fÜ_wšdow
[
ebi
];

750 ià(
	gedge
->
	g¤c
 >ğ
wšdow_¡
 && 
edge
->
¤c
 <ğ
wšdow_’
) {

751 
v”tiûs
[
edge
->
¤c
-
wšdow_¡
].
add_ou‹dge
Ódge->
d¡
, &edge->
d©a
, 
çl£
);

755 
	gthis
->
	giomgr
->
wa™_fÜ_»ads
();

758 
	g¡d
::
veùÜ
<> 
adju¡ed_couÁs
(
v”tiûs
.
size
(), 0);

759 
	giv
=0; iv< ()
	gv”tiûs
.
size
(); iv++è
	gadju¡ed_couÁs
[
iv
] = 
v”tiûs
[iv].
outc
;

761 ià(
	gou¬ts
 == 2) {

763 
iv
=0; 
	giv
< ()
	gv”tiûs
.
size
(); iv++) {

764 
	gsv”‹x_t
 &
	gv”‹x
 = 
v”tiûs
[
iv
];

765 
	gi
=0; i<
	gv”‹x
.
	goutc
; i++) {

766 ià(!(
	gv”‹x
.
ou‹dge
(
i
)->
	gv”‹xid
 >ğ
¥l™¡¬t
 && 
v”‹x
.ou‹dge(i)->
v”‹xid
 <ğ
¥l™’d
)) {

767 
adju¡ed_couÁs
[
iv
]--;

773 #ifdeà
SUPPORT_DELETIONS


775 
	giv
=0; iv< ()
	gv”tiûs
.
size
(); iv++) {

776 
	gsv”‹x_t
 &
	gv”‹x
 = 
v”tiûs
[
iv
];

777 
	gi
=0; i<
	gv”‹x
.
	goutc
; i++) {

778 ià(
is_d–‘ed_edge_v®ue
(
v”‹x
.
ou‹dge
(
i
)->
g‘_d©a
())) {

779 
	gadju¡ed_couÁs
[
iv
]--;

780 
as£¹
(
çl£
);

789 
size_t
 
	gÃ
 = 0;

790 
vid_t
 
	gcurvid
=
wšdow_¡
; curvid<=
wšdow_’
;) {

791 
	giv
 = 
curvid
 - 
wšdow_¡
;

792 
	gsv”‹x_t
 &
	gv”‹x
 = 
v”tiûs
[
iv
];

793 
	gcouÁ
 = 
adju¡ed_couÁs
[
iv
];

794 ià(
	gcouÁ
 == 0) {

796 
nz
=0;

797 
	gcurvid
++;

798 ; 
	gcurvid
 <ğ
wšdow_’
 && 
nz
<254; curvid++) {

799 ià(
	gadju¡ed_couÁs
[
curvid
 - 
wšdow_¡
] == 0) {

800 
nz
++;

805 
ušt8_t
 
	gÂz
 = (ušt8_t)
nz
;

807 
	gbwr™e
<
	gušt8_t
>(
	gf
, 
	gbuf
, 
	gbuåŒ
, 0);

808 
	gbwr™e
<
	gušt8_t
>(
	gf
, 
	gbuf
, 
	gbuåŒ
, 
	gÂz
);

812 ià(
	gedgecouÁ”
 - 
	gÏ¡_šdex_ouut
 >ğ
šdex_š‹rv®_edges
) {

813 
size_t
 
curåos
 = 
cu¿djf•os
;

814 
sh¬d_šdex
 
sidx
(
curvid
, 
curåos
, 
edgecouÁ”
);

815 
size_t
 
	ga
 = 
wr™e
(
idxf
, &
sidx
, (
sh¬d_šdex
));

816 
as£¹
(
a
>0);

817 
	gÏ¡_šdex_ouut
 = 
edgecouÁ”
;

821 ià(
	gcouÁ
 < 255) {

822 
ušt8_t
 
	gx
 = (ušt8_t)
couÁ
;

823 
	gbwr™e
<
	gušt8_t
>(
	gf
, 
	gbuf
, 
	gbuåŒ
, 
	gx
);

825 
	gbwr™e
<
	gušt8_t
>(
	gf
, 
	gbuf
, 
	gbuåŒ
, 0xff);

826 
	gbwr™e
<
	gušt32_t
>(
	gf
, 
	gbuf
, 
	gbuåŒ
, (ušt32_t)
	gcouÁ
);

829 
	gi
=0; i<
	gv”‹x
.
	goutc
; i++) {

830 ià(
	gv”‹x
.
ou‹dge
(
i
)->
	gv”‹xid
 >ğ
¥l™¡¬t
 && 
v”‹x
.ou‹dge(i)->
v”‹xid
 <ğ
¥l™’d
) {

831 #ifdeà
SUPPORT_DELETIONS


832 ià(
is_d–‘ed_edge_v®ue
(
v”‹x
.
ou‹dge
(
i
)->
g‘_d©a
())) {

833 
as£¹
(
çl£
);

837 
bwr™e
(
f
, 
buf
, 
buåŒ
, 
v”‹x
.
ou‹dge
(
i
)->
v”‹xid
);

838 
	gbwr™e_ed©a
<
	gEdgeD©aTy³
>(
	gebuf
, 
	gebuåŒ
, 
	gv”‹x
.
ou‹dge
(
i
)->
g‘_d©a
(), 
	gtÙ_ed©aby‹s
, 
	goutfe_ed©a
);

839 
	gÃ
++;

840 
	gedgecouÁ”
++;

841 } 
as£¹
(
ou¬ts
 == 2);

843 
	gcurvid
++;

846 
ä“
(
ed©a
);

847 
	gwšdow_¡
 = 
wšdow_’
+1;

853 
wr™—
(
f
, 
buf
, 
buåŒ
-buf);

855 
	ged©a_æush
<
	gEdgeD©aTy³
>(
	gebuf
, 
	gebuåŒ
, 
	goutfe_ed©a
, 
	gtÙ_ed©aby‹s
);

858 
	g¡d
::
¡ršg
 
sizef’ame
 = 
outfe_ed©a
 + ".size";

859 
	g¡d
::
of¡»am
 
ofs
(
sizef’ame
.
c_¡r
());

860 
	gofs
 << 
	gtÙ_ed©aby‹s
;

861 
	gofs
.
şo£
();

864 
ä“
(
buf
);

865 
ä“
(
ebuf
);

867 
d–‘e
 
	gcursh¬d
;

868 
şo£
(
f
);

869 
şo£
(
ef
);

870 
şo£
(
idxf
);

872 
	gthis
->
	giomgr
->
wa™_fÜ_wr™es
();

876 
	g¡d
::
¡ršg
 
Şd_fe_adj
 = 
f’ame_sh¬d_adj
(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
sh¬d
];

877 
	g¡d
::
¡ršg
 
Şd_fe_ed©a
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
this
->
ba£_f’ame
, 0, 0è+ ".dyng¿ph" + 
	gsh¬d_suffiûs
[
sh¬d
];

878 
	g¡d
::
¡ršg
 
Şd_blockdœ
 = 
dœÇme_sh¬d_ed©a_block
(
Şd_fe_ed©a
, 
ba£_’gše
::
blocksize
);

879 
	g¡d
::
¡ršg
 
Şd_fe_adj_idx
 = 
f’ame_sh¬d_adjidx
(
Şd_fe_adj
);

880 
»move
(
Şd_fe_adj
.
c_¡r
());

881 
»move
(
Şd_blockdœ
.
c_¡r
());

882 
»move
(
Şd_fe_adj_idx
.
c_¡r
());

884 
	g¡d
::
¡ršg
 
Şd_sizef’ame
 = 
Şd_fe_ed©a
 + ".size";

885 
»move
(
Şd_sizef’ame
.
c_¡r
());

889 
	gsh¬d
=0; sh¬d < 
	gthis
->
	gnsh¬ds
; shard++) {

890 ià(
	gwas_comm™ed
[
sh¬d
]) {

891 
	gwš
=0; wš < 
	gthis
->
	gnsh¬ds
; win++) {

892 
	gedge_bufãr
 &
	gbufãr_fÜ_wšdow
 = *
Ãw_edge_bufãrs
[
sh¬d
][
wš
];

893 
	gebi
=0;ƒbi<
	gbufãr_fÜ_wšdow
.
size
();ƒbi++) {

894 
	gü—‹d_edge
<
	gEdgeD©aTy³
> * 
	gedge
 = 
bufãr_fÜ_wšdow
[
ebi
];

895 ià(!
	gedge
->
	gaccouÁed_fÜ_outc
) {

896 
	g¡d
::
cout
 << "EdgnÙ‡ccouÁed (out)! " << 
edge
->
¤c
 << " -- " <<ƒdge->
d¡
 << 
¡d
::
’dl
;

898 ià(!
	gedge
->
	gaccouÁed_fÜ_šc
) {

899 
	g¡d
::
cout
 << "EdgnÙ‡ccouÁed (š)! " << 
edge
->
¤c
 << " -- " <<ƒdge->
d¡
 << 
¡d
::
’dl
;

902 
as£¹
(
edge
->
accouÁed_fÜ_šc
);

903 
as£¹
(
edge
->
accouÁed_fÜ_outc
);

905 
	gbufãr_fÜ_wšdow
.
ş—r
();

911 
	gÏ¡_comm™
 = 
added_edges
;

912 
	gthis
->
	gš‹rv®s
 = 
Ãw¿nges
;

913 
	gsh¬d_suffiûs
 = 
Ãwsuffiûs
;

914 
	gthis
->
	gnsh¬ds
 = (è
this
->
š‹rv®s
.
size
();

917 ià(
	g¿ngeschªged
) {

918 
	gsh¬dlock
.
lock
();

919 
	gi
=0; i<()
	gthis
->
	g¦idšg_sh¬ds
.
size
(); i++) {

920 ià(
	gthis
->
	g¦idšg_sh¬ds
[
i
] !ğ
NULL
è
d–‘e
 
this
->
¦idšg_sh¬ds
[i];

922 
	gthis
->
	g¦idšg_sh¬ds
.
ş—r
();

923 
	gsh¬dlock
.
uÆock
();

926 
	g¡d
::
¡ršg
 
numv_f’ame
 = 
ba£_’gše
::
ba£_f’ame
 + ".numvertices";

927 
FILE
 * 
	gf
 = 
fİ’
(
numv_f’ame
.
c_¡r
(), "w");

928 
årštf
(
f
, "%lu\n", 
ba£_’gše
::
num_v”tiûs
());

929 
fşo£
(
f
);

931 
š™_bufãrs
();

932 
	gthis
->
	gmodifiÿtiÚ_lock
.
uÆock
();

936 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

937 
bwr™e
(
f
, * 
buf
, * &
buåŒ
, 
T
 
v®
) {

938 
	gcu¿djf•os
 +ğ(
T
);

939 ià(
	gbuåŒ
+(
	gT
)-
	gbuf
>=
BBUF
) {

940 
wr™—
(
f
, 
buf
, 
buåŒ
-buf);

941 
	gbuåŒ
 = 
buf
;

943 *((
	gT
*)
	gbuåŒ
èğ
v®
;

944 
	gbuåŒ
 +ğ(
T
);

948 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

949 
ed©a_æush
(* 
buf
, * 
buåŒ
, 
¡d
::
¡ršg
 & 
sh¬d_f’ame
, 
size_t
 
tÙby‹s
) {

950 
	gblockid
 = (è((
tÙby‹s
 - (
T
)è/ 
ba£_’gše
::
blocksize
);

951 
	gËn
 = (è(
buåŒ
 - 
buf
);

952 
as£¹
(
Ën
 <ğ()
ba£_’gše
::
blocksize
);

954 
	g¡d
::
¡ršg
 
block_f’ame
 = 
f’ame_sh¬d_ed©a_block
(
sh¬d_f’ame
, 
blockid
, 
ba£_’gše
::
blocksize
);

955 
	gf
 = 
İ’
(
block_f’ame
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

956 
wr™e_com´es£d
(
f
, 
buf
, 
Ën
);

957 
şo£
(
f
);

960 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

961 
bwr™e_ed©a
(* 
buf
, * &
buåŒ
, 
T
 
v®
, 
size_t
 & 
tÙby‹s
, 
¡d
::
¡ršg
 & 
sh¬d_f’ame
) {

962 ià((è(
buåŒ
 + (
T
è- 
buf
è> ()
ba£_’gše
::
blocksize
) {

963 
ed©a_æush
<
T
>(
buf
, 
	gbuåŒ
, 
	gsh¬d_f’ame
, 
	gtÙby‹s
);

964 
	gbuåŒ
 = 
buf
;

966 
	gtÙby‹s
 +ğ(
T
);

967 *((
	gT
*)
	gbuåŒ
èğ
v®
;

968 
	gbuåŒ
 +ğ(
T
);

976 
	gpublic
:

977 
¡d
::
¡ršg
 
g‘_šfo_jsÚ
() {

978 
¡d
::
¡ršg¡»am
 
jsÚ
;

980 
	gthis
->
	gh‰¶ock
.
lock
();

985 
	gjsÚ
 << "{";

986 
	gjsÚ
 << "\"¡©e\" : \"" << 
	g¡©e
 << "\",\n";

987 
	gjsÚ
 << "\"fe\" : \"" << 
	gthis
->
	gba£_f’ame
 << "\",\n";

988 
	gjsÚ
 << "\"numOfSh¬ds\": " << 
	gthis
->
	gnsh¬ds
 << ",\n";

989 
	gjsÚ
 << "\"™”©iÚ\": " << 
	gthis
->
	gchicÚ‹xt
.
	g™”©iÚ
 << ",\n";

990 
	gjsÚ
 << "\"numI‹¿tiÚs\": " << 
	gthis
->
	gchicÚ‹xt
.
	gnum_™”©iÚs
 << ",\n";

991 
	gjsÚ
 << "\"runTime\": " << 
	gthis
->
	gchicÚ‹xt
.
ruÁime
() << ",\n";

993 
	gjsÚ
 << "\"upd©es\": " << 
	gthis
->
	gnupd©es
 << ",\n";

994 
	gjsÚ
 << "\"nv”tiûs\": " << 
	gthis
->
	gchicÚ‹xt
.
	gnv”tiûs
 << ",\n";

995 
	gjsÚ
 << "\"edges\": " << 
num_edges_§ã
() << ",\n";

997 
	gjsÚ
 << "\"edgesInBufãrs\": " << 
	gadded_edges
 << ",\n";

999 
	gjsÚ
 << "\"š‹rv®\":" << 
	gthis
->
	gexec_š‹rv®
 << ",\n";

1000 
	gjsÚ
 << "\"wšdowS¹\":" << 
	gthis
->
	gsub_š‹rv®_¡
 << ",";

1001 
	gjsÚ
 << "\"wšdowEnd\": " << 
	gthis
->
	gsub_š‹rv®_’
 << ",";

1002 
	gjsÚ
 << "\"shards\": [";

1005 
	gsh¬dlock
.
lock
();

1006 
	gp
=0;… < (è
	gthis
->
	g¦idšg_sh¬ds
.
size
();…++) {

1007 ià(
	gp
>0è
	gjsÚ
 << ",";

1009 
ty³Çme
 
	gba£_’gše
::
¦idšgsh¬d_t
 * 
sh¬d
 = 
this
->
¦idšg_sh¬ds
[
p
];

1010 ià(
	gsh¬d
 !ğ
NULL
) {

1011 
jsÚ
 << "{";

1012 
	gjsÚ
 << "\"p\": " << 
	gp
 << ", ";

1013 
	gjsÚ
 << 
	gsh¬d
->
g‘_šfo_jsÚ
();

1014 
	gjsÚ
 << "}";

1016 
	gjsÚ
 << "{";

1017 
	gjsÚ
 << "\"p\": " << 
	gp
 << ", ";

1018 
	gjsÚ
 << "\"state\": \"recreated\"";

1019 
	gjsÚ
 << "}";

1022 
	gsh¬dlock
.
uÆock
();

1024 
	gjsÚ
 << "]";

1026 
	g¡d
::
m­
<
¡d
::
¡ršg
, std::¡ršg>::
™”©Ü
 
™
;

1027 
	g™
=
this
->
jsÚ_·¿ms
.
begš
(); iˆ!ğthis->jsÚ_·¿ms.
’d
(); ++it) {

1028 
	gjsÚ
 << ", \"" << 
	g™
->
	gfœ¡
 << "\":\"";

1029 
	gjsÚ
 << 
	g™
->
	g£cÚd
 << "\"";

1032 
	gjsÚ
 << "}";

1034 
	gthis
->
	gh‰¶ock
.
uÆock
();

1035  
	gjsÚ
.
¡r
();

	@engine/functional/functional_engine.hpp

32 #iâdeà
GRAPHCHI_FUNCTIONALENGINE_DEF


33 
	#GRAPHCHI_FUNCTIONALENGINE_DEF


	)

35 
	~"’gše/g¿phchi_’gše.hµ
"

36 
	~"logg”/logg”.hµ
"

38 
Çme¥aû
 
	gg¿phchi
 {

40 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
,y³Çm
	gEdgeD©aTy³
,y³Çm
	gfv”‹x_t
>

41 
şass
 
	gfunùiÚ®_’gše
 : 
public
 
g¿phchi_’gše
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
, 
	gfv”‹x_t
> {

42 
	gpublic
:

43 
funùiÚ®_’gše
(
¡d
::
¡ršg
 
ba£_f’ame
, 
nsh¬ds
, 
boŞ
 
£Ëùive_schedulšg
, 
m‘rics
 &
_m
) :

44 
g¿phchi_’gše
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
, 
	gfv”‹x_t
>(
	gba£_f’ame
, 
	gnsh¬ds
, 
	g£Ëùive_schedulšg
, 
	g_m
){

45 
	g_m
.
£t
("engine", "functional");

48 
	g´Ùeùed
:

50 
vœtu®
 
lßd_befÜe_upd©es
(
¡d
::
veùÜ
<
fv”‹x_t
> &
v”tiûs
) {

51 
log¡»am
(
LOG_DEBUG
è<< "Proûssšg in-edges." << 
¡d
::
’dl
;

53 ià(!
	gthis
->
	gmemÜysh¬d
->
lßded
()) {

54 
	gthis
->
	gmemÜysh¬d
->
lßd
();

58 
	gthis
->
	gmemÜysh¬d
->
lßd_v”tiûs
(
this
->
sub_š‹rv®_¡
,his->
sub_š‹rv®_’
, 
v”tiûs
, 
Œue
, 
çl£
);

61 
	gthis
->
	gv”‹x_d©a_hªdËr
->
lßd
(
this
->
sub_š‹rv®_¡
,his->
sub_š‹rv®_’
);

64 
	gthis
->
	giomgr
->
wa™_fÜ_»ads
();

69 
vœtu®
 
boŞ
 
is_šmemÜy_mode
() {

70  
	gçl£
;

74 
vœtu®
 
š™_v”tiûs
(
¡d
::
veùÜ
<
fv”‹x_t
> &
v”tiûs
, 
g¿phchi_edge
<
EdgeD©aTy³
> * &
e
) {

75 
size_t
 
	gnv”tiûs
 = 
v”tiûs
.
size
();

78 
size_t
 
	gnum_edges
 = 
this
->
num_edges_subš‹rv®
Ñhis->
sub_š‹rv®_¡
,his->
sub_š‹rv®_’
);

81 
size_t
 
	gecouÁ”
 = 0;

82 
	gi
=0; i < ()
	gnv”tiûs
; i++) {

83 
deg»e
 
	gd
 = 
this
->
deg»e_hªdËr
->
g‘_deg»e
Ñhis->
sub_š‹rv®_¡
 + 
i
);

84 
	gšc
 = 
d
.
šdeg»e
;

85 
	goutc
 = 
d
.
outdeg»e
;

86 
	gv”tiûs
[
i
] = 
fv”‹x_t
(
this
->
chicÚ‹xt
,his->
sub_š‹rv®_¡
 + i, 
šc
, 
outc
);

88 ià(
	gthis
->
	gscheduËr
 !ğ
NULL
) {

89 
boŞ
 
is_sched
 = 
this
->
scheduËr
->
is_scheduËd
Ñhis->
sub_š‹rv®_¡
 + 
i
);

90 ià(
	gis_sched
) {

91 
	gv”tiûs
[
i
].
	gscheduËd
 = 
Œue
;

92 
	gthis
->
	gnupd©es
++;

93 
	gecouÁ”
 +ğ
šc
 + 
outc
;

96 
	gthis
->
	gnupd©es
++;

97 
	gv”tiûs
[
i
].
	gscheduËd
 = 
Œue
;

98 
	gecouÁ”
 +ğ
šc
 + 
outc
;

101 
	gthis
->
	gwÜk
 +ğ
num_edges
;

106 
vœtu®
 
lßd_aá”_upd©es
(
¡d
::
veùÜ
<
fv”‹x_t
> &
v”tiûs
) {

107 
log¡»am
(
LOG_DEBUG
è<< "Proûssšg out-edge (brßdÿ¡)." << 
¡d
::
’dl
;

108 
omp_£t_num_th»ads
(
this
->
lßd_th»ads
);

109 #´agm¨
omp
 
·¿Î–
 
scheduË
(
dyÇmic
, 1)

110 
	gp
=0;… < 
	gthis
->
	gnsh¬ds
;…++) {

112 ià(
	gp
 !ğ
this
->
exec_š‹rv®
) {

113 
this
->
¦idšg_sh¬ds
[
p
]->
»ad_Ãxt_v”tiûs
(
v”tiûs
.
size
(),his->
sub_š‹rv®_¡
, vertices,

114 
this
->
scheduËr
 !ğ
NULL
 &&his->
™”
 == 0);

117 
	gthis
->
	gmemÜysh¬d
->
lßd_v”tiûs
(
this
->
sub_š‹rv®_¡
,his->
sub_š‹rv®_’
, 
v”tiûs
, 
çl£
, 
Œue
);

	@engine/graphchi_engine.hpp

29 #iâdeà
DEF_GRAPHCHI_GRAPHCHI_ENGINE


30 
	#DEF_GRAPHCHI_GRAPHCHI_ENGINE


	)

33 
	~<io¡»am
>

34 
	~<f¡»am
>

35 
	~<s¡»am
>

36 
	~<c¡dio
>

37 
	~<fú.h
>

38 
	~<uni¡d.h
>

39 
	~<as£¹.h
>

40 
	~<omp.h
>

41 
	~<veùÜ
>

42 
	~<sys/time.h
>

44 
	~"­i/chif’ames.hµ
"

45 
	~"­i/g¿ph_objeùs.hµ
"

46 
	~"­i/g¿phchi_cÚ‹xt.hµ
"

47 
	~"­i/g¿phchi_´og¿m.hµ
"

48 
	~"’gše/auxd©a/deg»e_d©a.hµ
"

49 
	~"’gše/auxd©a/v”‹x_d©a.hµ
"

50 
	~"’gše/b™£t_scheduËr.hµ
"

51 
	~"io/¡redio.hµ
"

52 
	~"logg”/logg”.hµ
"

53 
	~"m‘rics/m‘rics.hµ
"

54 
	~"sh¬ds/memÜysh¬d.hµ
"

55 
	~"sh¬ds/¦idšgsh¬d.hµ
"

56 
	~"ut/±h»ad_toŞs.hµ
"

57 
	~"ouut/ouut.hµ
"

59 
Çme¥aû
 
	gg¿phchi
 {

62 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
,y³Çm
	gEdgeD©aTy³
,

63 
ty³Çme
 
	gsv”‹x_t
 = 
g¿phchi_v”‹x
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
> >

65 şas 
	cg¿phchi_’gše
 {

66 
	gpublic
:

67 
¦idšg_sh¬d
<
	tV”‹xD©aTy³
, 
	tEdgeD©aTy³
, 
	tsv”‹x_t
> 
	t¦idšgsh¬d_t
;

68 
	gmemÜy_sh¬d
<
	tV”‹xD©aTy³
, 
	tEdgeD©aTy³
, 
	tsv”‹x_t
> 
	tmemsh¬d_t
;

70 
	g´Ùeùed
:

71 
¡d
::
¡ršg
 
ba£_f’ame
;

72 
	gnsh¬ds
;

75 
¡redio
 * 
	giomgr
;

78 
	g¡d
::
veùÜ
<
¦idšgsh¬d_t
 *> 
¦idšg_sh¬ds
;

79 
memsh¬d_t
 * 
	gmemÜysh¬d
;

80 
	g¡d
::
veùÜ
<
¡d
::
·œ
<
vid_t
, 
	gvid_t
> > 
	gš‹rv®s
;

83 
deg»e_d©a
 * 
	gdeg»e_hªdËr
;

84 
	gv”‹x_d©a_¡Üe
<
	gV”‹xD©aTy³
> * 
	gv”‹x_d©a_hªdËr
;

87 
g¿phchi_cÚ‹xt
 
	gchicÚ‹xt
;

90 
b™£t_scheduËr
 * 
	gscheduËr
;

93 
boŞ
 
	gmodif›s_ou‹dges
;

94 
boŞ
 
	gmodif›s_šedges
;

95 
boŞ
 
	gdi§bË_ou‹dges
;

96 
boŞ
 
	gÚly_adjaûncy
;

97 
boŞ
 
	gu£_£Ëùive_schedulšg
;

98 
boŞ
 
	g’abË_d‘”mši¡ic_·¿Î–ism
;

99 
boŞ
 
	g¡Üe_šedges
;

100 
boŞ
 
	gdi§bË_v”‹xd©a_¡Üage
;

102 
boŞ
 
	g¿ndomiz©iÚ
;

103 
boŞ
 
	gš™Ÿlize_edges_befÜe_run
;

105 
size_t
 
	gblocksize
;

106 
	gmembudg‘_mb
;

107 
	glßd_th»ads
;

108 
	gexec_th»ads
;

111 
vid_t
 
	gsub_š‹rv®_¡
;

112 
vid_t
 
	gsub_š‹rv®_’
;

113 
	g™”
;

114 
	gn™”s
;

115 
	gexec_š‹rv®
;

116 
size_t
 
	gnupd©es
;

117 
size_t
 
	gÃdges
;

118 
size_t
 
	gwÜk
;

119 
	gmaxwšdow
;

120 
mu‹x
 
	gmodifiÿtiÚ_lock
;

122 
boŞ
 
	g»£t_v”‹xd©a
;

123 
boŞ
 
	g§ve_edgesfes_aá”_šmemmode
;

126 
	g¡d
::
veùÜ
<
iouut
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
> *> 
	gouuts
;

129 
	gm‘rics
 &
	gm
;

131 
´št_cÚfig
() {

132 
log¡»am
(
LOG_INFO
è<< "EngšcÚfigu¿tiÚ: " << 
	g¡d
::
’dl
;

133 
log¡»am
(
LOG_INFO
è<< "ƒxec_th»ad ğ" << 
	gexec_th»ads
 << 
	g¡d
::
’dl
;

134 
log¡»am
(
LOG_INFO
è<< "†ßd_th»ad ğ" << 
	glßd_th»ads
 << 
	g¡d
::
’dl
;

135 
log¡»am
(
LOG_INFO
è<< " membudg‘_mb = " << 
	gmembudg‘_mb
 << 
	g¡d
::
’dl
;

136 
log¡»am
(
LOG_INFO
è<< " blocksizğ" << 
	gblocksize
 << 
	g¡d
::
’dl
;

137 
log¡»am
(
LOG_INFO
è<< " scheduË¸ğ" << 
	gu£_£Ëùive_schedulšg
 << 
	g¡d
::
’dl
;

140 
	gpublic
:

148 
g¿phchi_’gše
(
¡d
::
¡ršg
 
_ba£_f’ame
, 
_nsh¬ds
, 
boŞ
 
_£Ëùive_schedulšg
, 
m‘rics
 &
_m
è: 
ba£_f’ame
(_ba£_f’ame), 
nsh¬ds
(_nsh¬ds), 
u£_£Ëùive_schedulšg
(_£Ëùive_schedulšg), 
m
(_m) {

150 
	gm
.
¡¬t_time
("iomgr_init");

151 
	giomgr
 = 
Ãw
 
¡redio
(
m
);

152 
	gm
.
¡İ_time
("iomgr_init");

153 #iâdeà
DYNAMICEDATA


154 
log¡»am
(
LOG_INFO
è<< "In™Ÿlizšg g¿phchi_’gše. Thi ’gšex³ù " << (
	gEdgeD©aTy³
)

155 << "-by‹ƒdgd©a. " << 
	g¡d
::
’dl
;

157 
log¡»am
(
LOG_INFO
) << "Initializing graphchi_engine with dynamicƒdge-data. Thisƒngineƒxpects " << ()

158 << "-by‹ƒdgd©a. " << 
	g¡d
::
’dl
;

162 ià(
	gnsh¬ds
 < 1) {

163 
	gnsh¬ds
 = 
g‘_İtiÚ_št
("nshards", 0);

164 ià(
	gnsh¬ds
 < 1) {

165 
log¡»am
(
LOG_WARNING
è<< "Numb” oàsh¬d wa nÙ s³cif›d (commªd-lš¬gum’ˆ'nsh¬ds'). TryšgØd‘eù. " << 
	g¡d
::
’dl
;

166 
	gnsh¬ds
 = 
discov”_sh¬d_num
();

171 
	gmemÜysh¬d
 = 
NULL
;

172 
	gmodif›s_ou‹dges
 = 
Œue
;

173 
	gmodif›s_šedges
 = 
Œue
;

174 
	g§ve_edgesfes_aá”_šmemmode
 = 
çl£
;

176 
	gÚly_adjaûncy
 = 
çl£
;

177 
	gdi§bË_ou‹dges
 = 
çl£
;

178 
	g»£t_v”‹xd©a
 = 
çl£
;

179 
	gš™Ÿlize_edges_befÜe_run
 = 
çl£
;

180 
	gblocksize
 = 1024 * 1024;

181 #iâdeà
DYNAMICEDATA


182 
	gblocksize
 % (
	gEdgeD©aTy³
è!ğ0è
blocksize
++;

185 
	gdi§bË_v”‹xd©a_¡Üage
 = 
çl£
;

187 
	gmembudg‘_mb
 = 
g‘_İtiÚ_št
("membudget_mb", 1024);

188 
	gnupd©es
 = 0;

189 
	g™”
 = 0;

190 
	gwÜk
 = 0;

191 
	gÃdges
 = 0;

192 
	gscheduËr
 = 
NULL
;

193 
	g¡Üe_šedges
 = 
Œue
;

194 
	gdeg»e_hªdËr
 = 
NULL
;

195 
	gv”‹x_d©a_hªdËr
 = 
NULL
;

196 
	g’abË_d‘”mši¡ic_·¿Î–ism
 = 
Œue
;

197 
	glßd_th»ads
 = 
g‘_İtiÚ_št
("loadthreads", 2);

198 
	gexec_th»ads
 = 
g‘_İtiÚ_št
("exeùh»ads", 
omp_g‘_max_th»ads
());

199 
	gmaxwšdow
 = 40000000;

202 
_lßd_v”‹x_š‹rv®s
();

204 
	g_m
.
£t
("fe", 
_ba£_f’ame
);

205 
	g_m
.
£t
("engine", "default");

206 
	g_m
.
£t
("nsh¬ds", (
size_t
)
nsh¬ds
);

209 
	gvœtu®
 ~
g¿phchi_’gše
() {

210 ià(
	gdeg»e_hªdËr
 !ğ
NULL
è
d–‘e
 
deg»e_hªdËr
;

211 ià(
	gv”‹x_d©a_hªdËr
 !ğ
NULL
è
d–‘e
 
v”‹x_d©a_hªdËr
;

212 ià(
	gmemÜysh¬d
 !ğ
NULL
) {

213 
d–‘e
 
memÜysh¬d
;

214 
	gmemÜysh¬d
 = 
NULL
;

216 
	gi
=0; i < ()
	g¦idšg_sh¬ds
.
size
(); i++) {

217 ià(
	g¦idšg_sh¬ds
[
i
] !ğ
NULL
) {

218 
d–‘e
 
¦idšg_sh¬ds
[
i
];

220 
	g¦idšg_sh¬ds
[
i
] = 
NULL
;

222 
	gdeg»e_hªdËr
 = 
NULL
;

223 
	gv”‹x_d©a_hªdËr
 = 
NULL
;

224 
d–‘e
 
	giomgr
;

229 
	g´Ùeùed
:

231 
vœtu®
 
deg»e_d©a
 * 
ü—‹_deg»e_hªdËr
() {

232  
Ãw
 
deg»e_d©a
(
ba£_f’ame
, 
iomgr
);

241 
discov”_sh¬d_num
() {

242 #iâdeà
DYNAMICEDATA


243 
	g_nsh¬ds
 = 
fšd_sh¬ds
<
EdgeD©aTy³
>(
ba£_f’ame
);

245 
	g_nsh¬ds
 = 
fšd_sh¬ds
<>(
ba£_f’ame
);

247 ià(
	g_nsh¬ds
 == 0) {

248 
log¡»am
(
LOG_ERROR
è<< "Could‚Ù fšd su™abË sh¬d - maybyou‚“dØruÀsh¬d”Øü—‹hem?" << 
¡d
::
’dl
;

249 
log¡»am
(
LOG_ERROR
è<< "Wa lookšg w™h f’am[" << 
	gba£_f’ame
 << "]" << 
	g¡d
::
’dl
;

250 
log¡»am
(
LOG_ERROR
è<< "You‚“dØü—‹hsh¬d w™hƒdgd©a-ty³ oàsiz" << (
	gEdgeD©aTy³
è<< " by‹s." << 
	g¡d
::
’dl
;

251 
log¡»am
(
LOG_ERROR
è<< "TØ¥ecifyhnumb” oàsh¬ds, u£ commªd-lš·¿m‘” 'nsh¬ds'" << 
	g¡d
::
’dl
;

252 
as£¹
(0);

254  
	g_nsh¬ds
;

258 
vœtu®
 
š™Ÿlize_¦idšg_sh¬ds
() {

259 
as£¹
(
¦idšg_sh¬ds
.
size
() == 0);

260 
	gp
=0;… < 
	gnsh¬ds
;…++) {

261 #iâdeà
DYNAMICEDATA


262 
	g¡d
::
¡ršg
 
ed©a_f’ame
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
ba£_f’ame
, 
	gp
, 
	gnsh¬ds
);

263 
	g¡d
::
¡ršg
 
adj_f’ame
 = 
f’ame_sh¬d_adj
(
ba£_f’ame
, 
p
, 
nsh¬ds
);

265 
	g¡d
::
¡ršg
 
ed©a_f’ame
 = 
f’ame_sh¬d_ed©a
<>(
ba£_f’ame
, 
	gp
, 
	gnsh¬ds
);

266 
	g¡d
::
¡ršg
 
adj_f’ame
 = 
f’ame_sh¬d_adj
(
ba£_f’ame
, 
p
, 
nsh¬ds
);

270 
	g¦idšg_sh¬ds
.
push_back
(

271 
Ãw
 
¦idšgsh¬d_t
(
iomgr
, 
ed©a_f’ame
,

272 
adj_f’ame
,

273 
š‹rv®s
[
p
].
fœ¡
,

274 
š‹rv®s
[
p
].
£cÚd
,

275 
blocksize
,

276 
m
,

277 !
modif›s_ou‹dges
,

278 
Úly_adjaûncy
));

279 ià(!
	gÚly_adjaûncy
)

280 
	gÃdges
 +ğ
¦idšg_sh¬ds
[¦idšg_sh¬ds.
size
(è- 1]->
num_edges
();

285 
vœtu®
 
š™Ÿlize_scheduËr
() {

286 ià(
	gu£_£Ëùive_schedulšg
) {

287 ià(
	gscheduËr
 !ğ
NULL
è
d–‘e
 
scheduËr
;

288 
	gscheduËr
 = 
Ãw
 
b™£t_scheduËr
((è
num_v”tiûs
());

289 
	gscheduËr
->
add_sk_to_®l
();

291 
	gscheduËr
 = 
NULL
;

299 
vœtu®
 
boŞ
 
is_šmemÜy_mode
() {

300  (
	gnsh¬ds
 =ğ1 && 
num_v”tiûs
(è< 2 * 
maxwšdow
);

307 
vœtu®
 
vid_t
 
d‘”mše_Ãxt_wšdow
(vid_ˆ
iš‹rv®
, vid_ˆ
äomvid
, vid_ˆ
maxvid
, 
size_t
 
membudg‘
) {

309 
	gdeg»e_hªdËr
->
lßd
(
äomvid
, 
maxvid
);

312 ià(
is_šmemÜy_mode
(è|| 
sv”‹x_t
().
computiÚ®_edges
()) {

313  
	gmaxvid
;

315 
size_t
 
	gmem»q
 = 0;

316 
	gmax_š‹rv®
 = 
maxvid
 - 
äomvid
;

317 
	gi
=0; i < 
	gmax_š‹rv®
; i++) {

318 
deg»e
 
	gdeg
 = 
deg»e_hªdËr
->
g‘_deg»e
(
äomvid
 + 
i
);

319 
	gšc
 = 
deg
.
šdeg»e
;

320 
	goutc
 = 
deg
.
outdeg»e
 * (!
di§bË_ou‹dges
);

323 
	gmem»q
 +ğ(
sv”‹x_t
è+ ((
EdgeD©aTy³
è+ (
vid_t
è+ (
g¿phchi_edge
<EdgeD©aTy³>))*(
outc
 + 
šc
);

324 ià(
	gmem»q
 > 
	gmembudg‘
) {

325 
log¡»am
(
LOG_DEBUG
è<< "MemÜy budg‘ƒxûeded w™h " << 
	gmem»q
 << " by‹s." << 
	g¡d
::
’dl
;

326  
	gäomvid
 + 
	gi
 - 1;

329  
	gmaxvid
;

337 
size_t
 
num_edges_subš‹rv®
(
vid_t
 
¡
, vid_ˆ
’
) {

338 
size_t
 
	gnum_edges
 = 0;

339 
	gnv”tiûs
 = 
’
 - 
¡
 + 1;

340 ià(
	gscheduËr
 !ğ
NULL
) {

341 
i
=0; 
	gi
 < 
	gnv”tiûs
; i++) {

342 
boŞ
 
	gis_sched
 = 
scheduËr
->
is_scheduËd
(
¡
 + 
i
);

343 ià(
	gis_sched
) {

344 
deg»e
 
	gd
 = 
deg»e_hªdËr
->
g‘_deg»e
(
¡
 + 
i
);

345 
	gnum_edges
 +ğ
d
.
šdeg»e
 * 
¡Üe_šedges
 + d.
outdeg»e
;

349 
	gi
=0; i < 
	gnv”tiûs
; i++) {

350 
deg»e
 
	gd
 = 
deg»e_hªdËr
->
g‘_deg»e
(
¡
 + 
i
);

351 
	gnum_edges
 +ğ
d
.
šdeg»e
 * 
¡Üe_šedges
 + d.
outdeg»e
;

354  
	gnum_edges
;

357 
vœtu®
 
lßd_befÜe_upd©es
(
¡d
::
veùÜ
<
sv”‹x_t
> &
v”tiûs
) {

358 
omp_£t_num_th»ads
(
lßd_th»ads
);

362 #´agm¨
omp
 
·¿Î–
 
scheduË
(
dyÇmic
, 1)

363 
	gp
=-1;… < 
	gnsh¬ds
;…++) {

364 ià(
	gp
==(-1)) {

366 ià(!
memÜysh¬d
->
lßded
()) {

367 
memÜysh¬d
->
lßd
();

371 
	gmemÜysh¬d
->
lßd_v”tiûs
(
sub_š‹rv®_¡
, 
sub_š‹rv®_’
, 
v”tiûs
, 
Œue
, !
di§bË_ou‹dges
);

374 ià(!
	gdi§bË_v”‹xd©a_¡Üage
) {

375 
	gv”‹x_d©a_hªdËr
->
lßd
(
sub_š‹rv®_¡
, 
sub_š‹rv®_’
);

379 ià(!
	gdi§bË_ou‹dges
) {

380 ià(
	gp
 !ğ
exec_š‹rv®
) {

381 ià(
¿ndomiz©iÚ
) {

382 
¦idšg_sh¬ds
[
p
]->
£t_di§bË_async_wr™es
(
Œue
);

384 
	g¦idšg_sh¬ds
[
p
]->
»ad_Ãxt_v”tiûs
((è
v”tiûs
.
size
(), 
sub_š‹rv®_¡
, vertices,

385 (
¿ndomiz©iÚ
 || 
scheduËr
 !ğ
NULL
è&& 
chicÚ‹xt
.
™”©iÚ
 == 0);

393 
	giomgr
->
wa™_fÜ_»ads
();

396 
vœtu®
 
exec_upd©es
(
G¿phChiProg¿m
<
V”‹xD©aTy³
, 
EdgeD©aTy³
, 
sv”‹x_t
> &
u£½rog¿m
,

397 
¡d
::
veùÜ
<
sv”‹x_t
> &
v”tiûs
) {

398 
m‘rics_’Œy
 
me
 = 
m
.
¡¬t_time
();

399 
size_t
 
	gnv”tiûs
 = 
v”tiûs
.
size
();

400 ià(!
	g’abË_d‘”mši¡ic_·¿Î–ism
) {

401 
	gi
=0; i < ()
	gnv”tiûs
; i++è
	gv”tiûs
[
i
].
	g·¿Î–_§ã
 = 
Œue
;

403 
	gsub_š‹rv®_Ën
 = 
sub_š‹rv®_’
 - 
sub_š‹rv®_¡
;

405 
	g¡d
::
veùÜ
<
vid_t
> 
¿ndom_Üd”
(
¿ndomiz©iÚ
 ? 
sub_š‹rv®_Ën
 + 1 : 0);

406 ià(
	g¿ndomiz©iÚ
) {

408 
	gidx
=0; idx <ğ()
sub_š‹rv®_Ën
; idx++è
	g¿ndom_Üd”
[
idx
] = idx;

409 
	g¡d
::
¿ndom_shufæe
(
¿ndom_Üd”
.
begš
(),„ªdom_Üd”.
’d
());

413 
omp_£t_num_th»ads
(
exec_th»ads
);

415 #´agm¨
omp
 
·¿Î–
 
£ùiÚs


417 #´agm¨
omp
 
£ùiÚ


419 #´agm¨
omp
 
·¿Î–
 

420 
	gidx
=0; idx <ğ()
sub_š‹rv®_Ën
; idx++) {

421 
vid_t
 
	gvid
 = 
sub_š‹rv®_¡
 + (
¿ndomiz©iÚ
 ? 
¿ndom_Üd”
[
idx
] : idx);

422 
	gsv”‹x_t
 & 
	gv
 = 
v”tiûs
[
vid
 - 
sub_š‹rv®_¡
];

424 ià(
	gexec_th»ads
 =ğ1 || 
v
.
·¿Î–_§ã
) {

425 ià(!
di§bË_v”‹xd©a_¡Üage
)

426 
v
.
d©­Œ
 = 
v”‹x_d©a_hªdËr
->
v”‹x_d©a_±r
(
vid
);

427 ià(
	gv
.
	gscheduËd
)

428 
	gu£½rog¿m
.
upd©e
(
v
, 
chicÚ‹xt
);

432 #´agm¨
omp
 
£ùiÚ


434 ià(
	gexec_th»ads
 > 1 && 
	g’abË_d‘”mši¡ic_·¿Î–ism
) {

435 
	gnÚ§ã_couÁ
 = 0;

436 
	gidx
=0; idx <ğ()
sub_š‹rv®_Ën
; idx++) {

437 
vid_t
 
	gvid
 = 
sub_š‹rv®_¡
 + (
¿ndomiz©iÚ
 ? 
¿ndom_Üd”
[
idx
] : idx);

438 
	gsv”‹x_t
 & 
	gv
 = 
v”tiûs
[
vid
 - 
sub_š‹rv®_¡
];

439 ià(!
	gv
.
	g·¿Î–_§ã
 && v.
	gscheduËd
) {

440 ià(!
	gdi§bË_v”‹xd©a_¡Üage
)

441 
	gv
.
	gd©­Œ
 = 
v”‹x_d©a_hªdËr
->
v”‹x_d©a_±r
(
vid
);

442 
	gu£½rog¿m
.
upd©e
(
v
, 
chicÚ‹xt
);

443 
	gnÚ§ã_couÁ
++;

447 
	gm
.
add
("£rŸlized-upd©es", 
nÚ§ã_couÁ
);

451 } 
	gu£½rog¿m
.
»³©_upd©es
(
chicÚ‹xt
));

453 
	gm
.
¡İ_time
(
me
, "execute-updates");

465 
vœtu®
 
exec_upd©es_šmemÜy_mode
(
G¿phChiProg¿m
<
V”‹xD©aTy³
, 
EdgeD©aTy³
, 
sv”‹x_t
> &
u£½rog¿m
,

466 
¡d
::
veùÜ
<
sv”‹x_t
> &
v”tiûs
) {

467 
wÜk
 = 
nupd©es
 = 0;

469 
	g™”
=0; i‹r<
	gn™”s
; iter++) {

470 
log¡»am
(
LOG_INFO
è<< "In-memÜy mode: I‹¿tiÚ " << 
	g™”
 << " s¹s. (" << 
	gchicÚ‹xt
.
ruÁime
(è<< " secs)" << 
	g¡d
::
’dl
;

471 
	gchicÚ‹xt
.
	g™”©iÚ
 = 
™”
;

472 ià(
	g™”
 > 0)

473 
	gu£½rog¿m
.
befÜe_™”©iÚ
(
™”
, 
chicÚ‹xt
);

474 
	gu£½rog¿m
.
befÜe_exec_š‹rv®
(0, ()
num_v”tiûs
(), 
chicÚ‹xt
);

476 ià(
	gu£_£Ëùive_schedulšg
) {

477 ià(
	g™”
 > 0 && !
	gscheduËr
->
	ghas_Ãw_sks
) {

478 
log¡»am
(
LOG_INFO
è<< "NØÃwask tØrun!" << 
	g¡d
::
’dl
;

479 
	gn™”s
 = 
™”
;

482 
	gscheduËr
->
Ãw_™”©iÚ
(
™”
);

484 
boŞ
 
	gÃwsks
 = 
çl£
;

485 
	gi
=0; i < ()
	gv”tiûs
.
size
(); i++) {

486 ià(
	g™”
 =ğ0 || 
scheduËr
->
is_scheduËd
(
i
)) {

487 
v”tiûs
[
i
].
scheduËd
 = 
Œue
;

488 
	gÃwsks
 = 
Œue
;

489 
	gnupd©es
++;

490 
	gwÜk
 +ğ
v”tiûs
[
i
].
šc
 + v”tiûs[i].
outc
;

492 
	gv”tiûs
[
i
].
	gscheduËd
 = 
çl£
;

495 ià(!
	gÃwsks
) {

497 
	gn™”s
 = 
™”
;

501 
	gscheduËr
->
	ghas_Ãw_sks
 = 
çl£
;

503 
	gnupd©es
 +ğ
num_v”tiûs
();

504 ià(!
	gÚly_adjaûncy
) {

505 
	gwÜk
 +ğ
num_edges
();

509 
	gm
.
¡¬t_time
("inmem-exec");

511 
exec_upd©es
(
u£½rog¿m
, 
v”tiûs
);

513 
	gm
.
¡İ_time
("inmem-exec");

515 
lßd_aá”_upd©es
(
v”tiûs
);

517 
	gu£½rog¿m
.
aá”_exec_š‹rv®
(0, ()
num_v”tiûs
(), 
chicÚ‹xt
);

518 
	gu£½rog¿m
.
aá”_™”©iÚ
(
™”
, 
chicÚ‹xt
);

519 ià(
	gchicÚ‹xt
.
	gÏ¡_™”©iÚ
 > 0 && chicÚ‹xt.Ï¡_™”©iÚ <ğ
™”
){

520 
log¡»am
(
LOG_INFO
)<<"Stİpšgƒngšsšû†a¡ i‹¿tiÚ wa £ˆto: " << 
chicÚ‹xt
.
Ï¡_™”©iÚ
 << 
¡d
::
’dl
;

526 ià(
	g§ve_edgesfes_aá”_šmemmode
) {

527 
log¡»am
(
LOG_INFO
è<< "Savšg memÜy sh¬d..." << 
	g¡d
::
’dl
;

533 
vœtu®
 
š™_v”tiûs
(
¡d
::
veùÜ
<
sv”‹x_t
> &
v”tiûs
, 
g¿phchi_edge
<
EdgeD©aTy³
> * &
ed©a
) {

534 
size_t
 
	gnv”tiûs
 = 
v”tiûs
.
size
();

537 
size_t
 
	gnum_edges
 = 
num_edges_subš‹rv®
(
sub_š‹rv®_¡
, 
sub_š‹rv®_’
);

540 
	ged©a
 = (
g¿phchi_edge
<
EdgeD©aTy³
>*è
m®loc
(
num_edges
 * (graphchi_edge<EdgeDataType>));

543 
size_t
 
	gecouÁ”
 = 0;

544 
	gi
=0; i < ()
	gnv”tiûs
; i++) {

545 
deg»e
 
	gd
 = 
deg»e_hªdËr
->
g‘_deg»e
(
sub_š‹rv®_¡
 + 
i
);

546 
	gšc
 = 
d
.
šdeg»e
;

547 
	goutc
 = 
d
.
outdeg»e
 * (!
di§bË_ou‹dges
);

548 
	gv”tiûs
[
i
] = 
sv”‹x_t
(
sub_š‹rv®_¡
 + i, &
ed©a
[
ecouÁ”
],

549 &
ed©a
[
ecouÁ”
 + 
šc
 * 
¡Üe_šedges
], inc, 
outc
);

552 ià(
	gdi§bË_ou‹dges
) {

553 
	gv”tiûs
[
i
].
	goutc
 = 
d
.
outdeg»e
;

556 ià(
	gscheduËr
 !ğ
NULL
) {

557 
boŞ
 
is_sched
 = ( 
scheduËr
->
is_scheduËd
(
sub_š‹rv®_¡
 + 
i
));

558 ià(
	gis_sched
) {

559 
	gv”tiûs
[
i
].
	gscheduËd
 = 
Œue
;

560 
	gnupd©es
++;

561 
	gecouÁ”
 +ğ
šc
 * 
¡Üe_šedges
 + 
outc
;

564 
	gnupd©es
++;

565 
	gv”tiûs
[
i
].
	gscheduËd
 = 
Œue
;

566 
	gecouÁ”
 +ğ
šc
 * 
¡Üe_šedges
 + 
outc
;

569 
	gwÜk
 +ğ
ecouÁ”
;

570 
as£¹
(
ecouÁ”
 <ğ
num_edges
);

574 
§ve_v”tiûs
(
¡d
::
veùÜ
<
sv”‹x_t
> &
v”tiûs
) {

575 ià(
di§bË_v”‹xd©a_¡Üage
) ;

576 
size_t
 
	gnv”tiûs
 = 
v”tiûs
.
size
();

577 
boŞ
 
	gmodif›d_ªy_v”‹x
 = 
çl£
;

578 
	gi
=0; i < ()
	gnv”tiûs
; i++) {

579 ià(
	gv”tiûs
[
i
].
	gmodif›d
) {

580 
	gmodif›d_ªy_v”‹x
 = 
Œue
;

584 ià(
	gmodif›d_ªy_v”‹x
) {

585 
	gv”‹x_d©a_hªdËr
->
§ve
();

589 
vœtu®
 
lßd_aá”_upd©es
(
¡d
::
veùÜ
<
sv”‹x_t
> &
v”tiûs
) {

593 
vœtu®
 
wr™e_d–_log
() {

595 
¡d
::
¡ršg
 
d–âame
 = 
iomgr
->
muÉËx´efix
(0è+ 
ba£_f’ame
 + ".deltalog";

596 
FILE
 * 
	gdf
 = 
fİ’
(
d–âame
.
c_¡r
(), (
chicÚ‹xt
.
™”©iÚ
 == 0 ? "w" : "a"));

597 
årštf
(
df
, "%d,%lu,%lu,%lf\n", 
chicÚ‹xt
.
™”©iÚ
, 
nupd©es
, 
wÜk
, chicÚ‹xt.
g‘_d–
());

598 
fşo£
(
df
);

601 
	gpublic
:

603 
vœtu®
 
¡d
::
veùÜ
< std::
·œ
<
vid_t
, 
	gvid_t
> > 
g‘_š‹rv®s
() {

604  
	gš‹rv®s
;

607 
vœtu®
 
	g¡d
::
·œ
<
vid_t
, 
	gvid_t
> 
g‘_š‹rv®
(
i
) {

608  
	gš‹rv®s
[
i
];

614 
vid_t
 
g‘_š‹rv®_¡¬t
(
i
) {

615  
g‘_š‹rv®
(
i
).
	gfœ¡
;

621 
vid_t
 
g‘_š‹rv®_’d
(
i
) {

622  
g‘_š‹rv®
(
i
).
	g£cÚd
;

625 
vœtu®
 
size_t
 
num_v”tiûs
() {

626  1 + 
	gš‹rv®s
[
nsh¬ds
 - 1].
	g£cÚd
;

629 
	gg¿phchi_cÚ‹xt
 &
g‘_cÚ‹xt
() {

630  
	gchicÚ‹xt
;

633 
vœtu®
 
g‘_nsh¬ds
() {

634  
	gnsh¬ds
;

637 
size_t
 
num_upd©es
() {

638  
	gnupd©es
;

644 
vœtu®
 
size_t
 
num_edges_§ã
() {

645  
num_edges
();

648 
vœtu®
 
size_t
 
num_bufã»d_edges
() {

655 
vœtu®
 
size_t
 
num_edges
() {

656 ià(
	g¦idšg_sh¬ds
.
size
() == 0) {

657 
log¡»am
(
LOG_ERROR
è<< "’gše.num_edges(èÿÀbÿÎed oÆy‡á”ƒngšha b“À¡¬‹d. TØbfixed†©”. A ¨wÜk¬ound,…uˆth’gšštØ¨glob® v¬ŸbË,‡nd qu”yhnumb”‡á”w¬d š begš_™”©iÚ(), fÜƒxam¶e." << 
¡d
::
’dl
;

658 
as£¹
(
çl£
);

660 ià(
	gÚly_adjaûncy
) {

662 
log¡»am
(
LOG_ERROR
è<< "Asked‚umb” oàedges, buˆ’gšwa ruÀw™houˆedge-d©a." << 
	g¡d
::
’dl
;

665  
	gÃdges
;

673 
boŞ
 
is_ªy_v”‹x_scheduËd
(
vid_t
 
¡
, vid_ˆ
’
) {

674 ià(
	gscheduËr
 =ğ
NULL
è 
Œue
;

675 
vid_t
 
	gv
=
¡
; v<=
’
; v++) {

676 ià(
	gscheduËr
->
is_scheduËd
(
v
)) {

677  
	gŒue
;

680  
	gçl£
;

683 
vœtu®
 
š™Ÿlize_™”
() {

687 
vœtu®
 
š™Ÿlize_befÜe_run
() {

688 ià(
	g»£t_v”‹xd©a
 && 
	gv”‹x_d©a_hªdËr
 !ğ
NULL
) {

689 
v”‹x_d©a_hªdËr
->
ş—r
(
num_v”tiûs
());

693 
vœtu®
 
memsh¬d_t
 * 
ü—‹_memsh¬d
(
vid_t
 
š‹rv®_¡
, vid_ˆ
š‹rv®_’
) {

694 #iâdeà
DYNAMICEDATA


695  
Ãw
 
memsh¬d_t
(
this
->
iomgr
,

696 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
ba£_f’ame
, 
exec_š‹rv®
, 
nsh¬ds
),

697 
f’ame_sh¬d_adj
(
ba£_f’ame
, 
exec_š‹rv®
, 
nsh¬ds
),

698 
š‹rv®_¡
,

699 
š‹rv®_’
,

700 
blocksize
,

701 
m
);

703  
Ãw
 
memsh¬d_t
(
this
->
iomgr
,

704 
f’ame_sh¬d_ed©a
<>(
ba£_f’ame
, 
exec_š‹rv®
, 
nsh¬ds
),

705 
f’ame_sh¬d_adj
(
ba£_f’ame
, 
exec_š‹rv®
, 
nsh¬ds
),

706 
š‹rv®_¡
,

707 
š‹rv®_’
,

708 
blocksize
,

709 
m
);

718 
run
(
G¿phChiProg¿m
<
V”‹xD©aTy³
, 
EdgeD©aTy³
, 
sv”‹x_t
> &
u£½rog¿m
, 
_n™”s
) {

719 
	gm
.
¡¬t_time
("runtime");

720 ià(
	gdeg»e_hªdËr
 =ğ
NULL
)

721 
deg»e_hªdËr
 = 
ü—‹_deg»e_hªdËr
();

722 
	giomgr
->
£t_ÿche_budg‘
(
g‘_İtiÚ_lÚg
("cachesize_mb", 0) * 1024L * 1024L);

724 
	gm
.
£t
("ÿchesize_mb", 
g‘_İtiÚ_št
("cachesize_mb", 0));

725 
	gm
.
£t
("membudg‘_mb", 
g‘_İtiÚ_št
("membudget_mb", 0));

727 
	g¿ndomiz©iÚ
 = 
g‘_İtiÚ_št
("randomization", 0) == 1;

729 ià(
sv”‹x_t
().
computiÚ®_edges
()) {

731 
£t_maxwšdow
(
membudg‘_mb
 * 1024 * 1024 / 3 / 100);

732 
log¡»am
(
LOG_INFO
è<< "S‘ maxwšdow:" << 
	gmaxwšdow
 << 
	g¡d
::
’dl
;

735 ià(
	g¿ndomiz©iÚ
) {

736 
timev®
 
	g‰
;

737 
g‘timeofday
(&
‰
, 
NULL
);

738 
ušt32_t
 
	g£ed
 = (ušt32_tè
g‘_İtiÚ_št
("£ed", ()
‰
.
tv_u£c
);

739 
	g¡d
::
cout
 << "SEED: " << 
£ed
 << 
¡d
::
’dl
;

740 
¤ªd
(
£ed
);

743 
	gn™”s
 = 
_n™”s
;

744 
log¡»am
(
LOG_INFO
è<< "G¿phCh˜¡¬tšg" << 
	g¡d
::
’dl
;

745 
log¡»am
(
LOG_INFO
è<< "Liûn£d und”hA·chLiûn£ 2.0" << 
	g¡d
::
’dl
;

746 
log¡»am
(
LOG_INFO
è<< "CİyrighˆA­ØKyrŞ¨‘‡l., C¬Ãg› M–lÚ Univ”s™y (2012)" << 
	g¡d
::
’dl
;

748 ià(
	gv”‹x_d©a_hªdËr
 =ğ
NULL
 && !
di§bË_v”‹xd©a_¡Üage
)

749 
v”‹x_d©a_hªdËr
 = 
Ãw
 
v”‹x_d©a_¡Üe
<
V”‹xD©aTy³
>(
ba£_f’ame
, 
num_v”tiûs
(), 
	giomgr
);

751 
š™Ÿlize_befÜe_run
();

755 ià(
	g¦idšg_sh¬ds
.
size
() == 0) {

756 
š™Ÿlize_¦idšg_sh¬ds
();

757 ià(
	gš™Ÿlize_edges_befÜe_run
) {

758 
	gj
=0; j<()
	g¦idšg_sh¬ds
.
size
(); j++è¦idšg_sh¬ds[
j
]->
š™d©a
();

761 
log¡»am
(
LOG_DEBUG
è<< "Engšbešg„e¡¬‹d, dØnÙ„eš™Ÿlize." << 
	g¡d
::
’dl
;

764 
š™Ÿlize_scheduËr
();

765 
omp_£t_Ã¡ed
(1);

769 
	gchicÚ‹xt
.
	gscheduËr
 = 
scheduËr
;

770 ià(
	gscheduËr
 =ğ
NULL
) {

771 
chicÚ‹xt
.
scheduËr
 = 
Ãw
 
nÚ_scheduËr
();

775 
´št_cÚfig
();

779 
	g™”
=0; i‹¸< 
	gn™”s
; iter++) {

780 
log¡»am
(
LOG_INFO
è<< "S¹ i‹¿tiÚ: " << 
	g™”
 << 
	g¡d
::
’dl
;

782 
š™Ÿlize_™”
();

785 ià(!
	gdi§bË_v”‹xd©a_¡Üage
)

786 
	gv”‹x_d©a_hªdËr
->
check_size
(
num_v”tiûs
());

789 
	gchicÚ‹xt
.
	gf’ame
 = 
ba£_f’ame
;

790 
	gchicÚ‹xt
.
	g™”©iÚ
 = 
™”
;

791 
	gchicÚ‹xt
.
	gnum_™”©iÚs
 = 
n™”s
;

792 
	gchicÚ‹xt
.
	gnv”tiûs
 = 
num_v”tiûs
();

793 ià(!
	gÚly_adjaûncy
è
	gchicÚ‹xt
.
	gÃdges
 = 
num_edges
();

795 
	gchicÚ‹xt
.
	gexeùh»ads
 = 
exec_th»ads
;

796 
	gchicÚ‹xt
.
»£t_d–s
(
exec_th»ads
);

799 
	gu£½rog¿m
.
befÜe_™”©iÚ
(
™”
, 
chicÚ‹xt
);

802 ià(
	gu£_£Ëùive_schedulšg
) {

803 ià(
	gscheduËr
 !ğ
NULL
) {

804 ià(!
scheduËr
->
has_Ãw_sks
) {

805 
log¡»am
(
LOG_INFO
è<< "NØÃwask tØrun!" << 
¡d
::
’dl
;

808 
	gscheduËr
->
	ghas_Ãw_sks
 = 
çl£
;

813 ià(
	gscheduËr
 !ğ
NULL
)

814 
scheduËr
->
Ãw_™”©iÚ
(
™”
);

817 
	g¡d
::
veùÜ
<> 
štshufæe
(
nsh¬ds
);

819 ià(
	g¿ndomiz©iÚ
) {

820 
	gi
=0; i<
	gnsh¬ds
; i++è
	gštshufæe
[
i
] = i;

821 
	g¡d
::
¿ndom_shufæe
(
štshufæe
.
begš
(), iÁshufæe.
’d
());

825 
	gš‹rv®_idx
=0; iÁ”v®_idx < 
	gnsh¬ds
; ++interval_idx) {

826 
	gexec_š‹rv®
 = 
š‹rv®_idx
;

828 ià(
	g¿ndomiz©iÚ
 && 
	g™”
 > 0) {

829 
	gexec_š‹rv®
 = 
štshufæe
[
š‹rv®_idx
];

832 
	gp
=0;…<
	gnsh¬ds
;…++) {

833 
	g¦idšg_sh¬ds
[
p
]->
æush
();

834 
	g¦idšg_sh¬ds
[
p
]->
£t_off£t
(0, 0, 0);

840 
vid_t
 
	gš‹rv®_¡
 = 
g‘_š‹rv®_¡¬t
(
exec_š‹rv®
);

841 
vid_t
 
	gš‹rv®_’
 = 
g‘_š‹rv®_’d
(
exec_š‹rv®
);

843 ià(
	gš‹rv®_¡
 > 
	gš‹rv®_’
) ;

845 ià(!
is_šmemÜy_mode
())

846 
	gu£½rog¿m
.
befÜe_exec_š‹rv®
(
š‹rv®_¡
, 
š‹rv®_’
, 
chicÚ‹xt
);

849 
	g¦idšg_sh¬ds
[
exec_š‹rv®
]->
æush
();

850 
	giomgr
->
wa™_fÜ_wr™es
();

853 ià(
	gmemÜysh¬d
 !ğ
NULL
è
d–‘e
 
memÜysh¬d
;

854 
	gmemÜysh¬d
 = 
ü—‹_memsh¬d
(
š‹rv®_¡
, 
š‹rv®_’
);

855 
	gmemÜysh¬d
->
	gÚly_adjaûncy
 = 
Úly_adjaûncy
;

856 
	gmemÜysh¬d
->
£t_di§bË_async_wr™es
(
¿ndomiz©iÚ
);

858 
	gsub_š‹rv®_¡
 = 
š‹rv®_¡
;

859 
log¡»am
(
LOG_INFO
è<< 
	gchicÚ‹xt
.
ruÁime
() << "s: Starting: "

860 << 
	gsub_š‹rv®_¡
 << " -- " << 
	gš‹rv®_’
 << 
	g¡d
::
’dl
;

862 
	gsub_š‹rv®_¡
 <ğ
š‹rv®_’
) {

864 
modifiÿtiÚ_lock
.
lock
();

866 
	gsub_š‹rv®_’
 = 
d‘”mše_Ãxt_wšdow
(
exec_š‹rv®
,

867 
sub_š‹rv®_¡
,

868 
¡d
::
mš
(
š‹rv®_’
, (
is_šmemÜy_mode
(è? iÁ”v®_’ : 
sub_š‹rv®_¡
 + 
maxwšdow
)),

869 
size_t
(
membudg‘_mb
) * 1024 * 1024);

870 
as£¹
(
sub_š‹rv®_’
 >ğ
sub_š‹rv®_¡
);

872 
log¡»am
(
LOG_INFO
è<< "I‹¿tiÚ " << 
	g™”
 << "/" << (
	gn™”s
 - 1è<< ", subš‹rv®: " << 
	gsub_š‹rv®_¡
 << " - " << 
	gsub_š‹rv®_’
 << 
	g¡d
::
’dl
;

874 
boŞ
 
	gªy_v”‹x_scheduËd
 = 
is_ªy_v”‹x_scheduËd
(
sub_š‹rv®_¡
, 
sub_š‹rv®_’
);

875 ià(!
	gªy_v”‹x_scheduËd
) {

876 
log¡»am
(
LOG_INFO
è<< "NØv”tiû scheduËd, sk." << 
	g¡d
::
’dl
;

877 
	gsub_š‹rv®_¡
 = 
sub_š‹rv®_’
 + 1;

878 
	gmodifiÿtiÚ_lock
.
uÆock
();

883 
	gnv”tiûs
 = 
sub_š‹rv®_’
 - 
sub_š‹rv®_¡
 + 1;

884 
	gg¿phchi_edge
<
	gEdgeD©aTy³
> * 
	ged©a
 = 
NULL
;

886 
	g¡d
::
veùÜ
<
sv”‹x_t
> 
v”tiûs
(
nv”tiûs
, svertex_t());

887 
log¡»am
(
LOG_DEBUG
è<< "AÎoÿtiÚ " << 
	gnv”tiûs
 << " v”tiûs, sizeof:" << (
	gsv”‹x_t
)

888 << "Ù®:" << 
nv”tiûs
 * (
	gsv”‹x_t
è<< 
	g¡d
::
’dl
;

889 
š™_v”tiûs
(
v”tiûs
, 
ed©a
);

892 
lßd_befÜe_upd©es
(
v”tiûs
);

894 
	gmodifiÿtiÚ_lock
.
uÆock
();

896 
log¡»am
(
LOG_INFO
è<< "S¹ upd©es" << 
	g¡d
::
’dl
;

898 ià(!
is_šmemÜy_mode
()) {

899 
exec_upd©es
(
u£½rog¿m
, 
v”tiûs
);

901 
lßd_aá”_upd©es
(
v”tiûs
);

904 
exec_upd©es_šmemÜy_mode
(
u£½rog¿m
, 
v”tiûs
);

906 
log¡»am
(
LOG_INFO
è<< "Fšished upd©es" << 
	g¡d
::
’dl
;

910 ià(!
	gdi§bË_v”‹xd©a_¡Üage
) {

911 
§ve_v”tiûs
(
v”tiûs
);

913 
	gsub_š‹rv®_¡
 = 
sub_š‹rv®_’
 + 1;

916 ià(
	ged©a
 !ğ
NULL
) {

917 
d–‘e
 
ed©a
;

918 
	ged©a
 = 
NULL
;

923 ià(
	gmemÜysh¬d
->
lßded
(è&& (
	g§ve_edgesfes_aá”_šmemmode
 || !
is_šmemÜy_mode
())) {

924 
	gmemÜysh¬d
->
comm™
(
modif›s_šedges
, 
modif›s_ou‹dges
 & !
di§bË_ou‹dges
);

926 ià(!
	g¿ndomiz©iÚ
) {

927 
	g¦idšg_sh¬ds
[
exec_š‹rv®
]->
£t_off£t
(
memÜysh¬d
->
off£t_fÜ_¡»am_cÚt
(), memÜysh¬d->
off£t_vid_fÜ_¡»am_cÚt
(),

928 
memÜysh¬d
->
ed©a_±r_fÜ_¡»am_cÚt
());

930 
d–‘e
 
	gmemÜysh¬d
;

931 
	gmemÜysh¬d
 = 
NULL
;

933 ià(!
is_šmemÜy_mode
())

934 
	gu£½rog¿m
.
aá”_exec_š‹rv®
(
š‹rv®_¡
, 
š‹rv®_’
, 
chicÚ‹xt
);

938 ià(!
is_šmemÜy_mode
())

939 
	gu£½rog¿m
.
aá”_™”©iÚ
(
™”
, 
chicÚ‹xt
);

943 
	gp
=0;…<
	gnsh¬ds
;…++) {

944 
	g¦idšg_sh¬ds
[
p
]->
æush
();

945 
	g¦idšg_sh¬ds
[
p
]->
£t_off£t
(0, 0, 0);

947 
	giomgr
->
wa™_fÜ_wr™es
();

950 
wr™e_d–_log
();

953 ià(
	gchicÚ‹xt
.
	gÏ¡_™”©iÚ
 >= 0) {

954 
n™”s
 = 
chicÚ‹xt
.
Ï¡_™”©iÚ
 + 1;

955 
log¡»am
(
LOG_DEBUG
è<< "La¡ i‹¿tiÚ i now: " << (
	gn™”s
-1è<< 
	g¡d
::
’dl
;

957 
™”©iÚ_fšished
();

958 
	giomgr
->
fœ¡_·ss_fšished
();

961 
	gm
.
¡İ_time
("runtime");

963 
	gm
.
£t
("upd©es", 
nupd©es
);

964 
	gm
.
£t
("wÜk", 
wÜk
);

965 
	gm
.
£t
("nv”tiûs", 
num_v”tiûs
());

966 
	gm
.
£t
("exeùh»ads", (
size_t
)
exec_th»ads
);

967 
	gm
.
£t
("lßdth»ads", (
size_t
)
lßd_th»ads
);

968 #iâdeà
GRAPHCHI_DISABLE_COMPRESSION


969 
	gm
.
£t
("compression", 1);

971 
	gm
.
£t
("compression", 0);

974 
	gm
.
£t
("scheduËr", (
size_t
)
u£_£Ëùive_schedulšg
);

975 
	gm
.
£t
("n™”s", 
n™”s
);

978 
	gi
=0; i< ()
	gouuts
.
size
(); i++) {

979 
	gouuts
[
i
]->
şo£
();

981 
	gouuts
.
ş—r
();

984 ià(
	gv”‹x_d©a_hªdËr
 !ğ
NULL
) {

985 
d–‘e
 
v”‹x_d©a_hªdËr
;

986 
	gv”‹x_d©a_hªdËr
 = 
NULL
;

989 ià(
	gmodif›s_šedges
 || 
	gmodif›s_ou‹dges
) {

990 
	giomgr
->
comm™_ÿched_blocks
();

994 
vœtu®
 
™”©iÚ_fšished
() {

998 
¡redio
 * 
g‘_iomªag”
() {

999  
	giomgr
;

1002 
vœtu®
 
£t_modif›s_šedges
(
boŞ
 
b
) {

1003 
	gmodif›s_šedges
 = 
b
;

1006 
vœtu®
 
£t_modif›s_ou‹dges
(
boŞ
 
b
) {

1007 
	gmodif›s_ou‹dges
 = 
b
;

1010 
vœtu®
 
£t_Úly_adjaûncy
(
boŞ
 
b
) {

1011 
	gÚly_adjaûncy
 = 
b
;

1014 
vœtu®
 
£t_di§bË_ou‹dges
(
boŞ
 
b
) {

1015 
	gdi§bË_ou‹dges
 = 
b
;

1023 
£t_blocksize
(
size_t
 
blocksize_š_by‹s
) {

1024 
	gblocksize
 = 
blocksize_š_by‹s
;

1032 
£t_membudg‘_mb
(
mbs
) {

1033 
	gmembudg‘_mb
 = 
mbs
;

1036 
g‘_membudg‘_mb
() {

1037  
	gmembudg‘_mb
;

1040 
£t_lßd_th»ads
(
É
) {

1041 
	glßd_th»ads
 = 
É
;

1044 
£t_exec_th»ads
(
‘
) {

1045 
	gexec_th»ads
 = 
‘
;

1052 
£t_’abË_d‘”mši¡ic_·¿Î–ism
(
boŞ
 
b
) {

1053 #ifdeà
DYNAMICEDATA


1054 ià(!
	gb
) {

1055 
log¡»am
(
LOG_ERROR
è<< "W™h dyÇmiøedgd©a, you cªnÙ di§bË d‘”mšiø·¿Î–ism." << 
	g¡d
::
’dl
;

1056 
log¡»am
(
LOG_ERROR
è<< "Oth”wi£„aû cÚd™iÚ would cÜru±h¡ruùu» oàthd©a." << 
	g¡d
::
’dl
;

1057 
as£¹
(
b
);

1061 
	g’abË_d‘”mši¡ic_·¿Î–ism
 = 
b
;

1064 
	gpublic
:

1065 
£t_di§bË_v”‹xd©a_¡Üage
() {

1066 
this
->
di§bË_v”‹xd©a_¡Üage
 = 
Œue
;

1069 
£t_’abË_v”‹xd©a_¡Üage
() {

1070 
	gthis
->
	gdi§bË_v”‹xd©a_¡Üage
 = 
çl£
;

1073 
£t_maxwšdow
(
_maxwšdow
){

1074 
	gmaxwšdow
 = 
_maxwšdow
;

1079 
size_t
 
add_ouut
(
iouut
<
V”‹xD©aTy³
, 
EdgeD©aTy³
> * 
ouut
) {

1080 
	gouuts
.
push_back
(
ouut
);

1081  (
	gouuts
.
size
() - 1);

1084 
	giouut
<
	gV”‹xD©aTy³
, 
	gEdgeD©aTy³
> * 
ouut
(
size_t
 
idx
) {

1085 ià(
	gidx
 >ğ
ouuts
.
size
()) {

1086 
log¡»am
(
LOG_FATAL
è<< "Tr›dØg‘ ouuˆw™h index " << 
idx
 << ", buˆÚly " << 
ouuts
.
size
(è<< " ouut w”š™Ÿlized!" << 
¡d
::
’dl
;

1088 
as£¹
(
idx
 < 
ouuts
.
size
());

1089  
	gouuts
[
idx
];

1092 
	g´Ùeùed
:

1094 
vœtu®
 
_lßd_v”‹x_š‹rv®s
() {

1095 
lßd_v”‹x_š‹rv®s
(
ba£_f’ame
, 
nsh¬ds
, 
š‹rv®s
);

1098 
	g´Ùeùed
:

1099 
mu‹x
 
h‰¶ock
;

1100 
	g¡d
::
m­
<
¡d
::
¡ršg
, std::¡ršg> 
jsÚ_·¿ms
;

1102 
	gpublic
:

1107 
‹m¶©e
<
ty³Çme
 
ET
>

1108 
»š™Ÿlize_edge_d©a
(
ET
 
z”ov®ue
) {

1110 
p
=0; 
	gp
 < 
	gnsh¬ds
;…++) {

1111 
	g¡d
::
¡ršg
 
ed©ash¬dÇme
 = 
f’ame_sh¬d_ed©a
<
ET
>(
ba£_f’ame
, 
	gp
, 
	gnsh¬ds
);

1112 
	g¡d
::
¡ršg
 
dœÇme
 = 
dœÇme_sh¬d_ed©a_block
(
ed©ash¬dÇme
, 
blocksize
);

1113 
size_t
 
	ged©asize
 = 
g‘_sh¬d_ed©a_fesize
<
ET
>(
ed©ash¬dÇme
);

1114 
log¡»am
(
LOG_INFO
è<< "CË¬šg d©a: " << 
	ged©ash¬dÇme
 << " by‹s: " << 
	ged©asize
 << 
	g¡d
::
’dl
;

1115 
	gnblocks
 = (è((
ed©asize
 / 
blocksize
) + (edatasize % blocksize == 0 ? 0 : 1));

1116 
	gi
=0; i < 
	gnblocks
; i++) {

1117 
	g¡d
::
¡ršg
 
block_f’ame
 = 
f’ame_sh¬d_ed©a_block
(
ed©ash¬dÇme
, 
i
, 
blocksize
);

1118 
	gËn
 = (è
¡d
::
mš
(
ed©asize
 - 
i
 * 
blocksize
, blocksize);

1119 
	gf
 = 
İ’
(
block_f’ame
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

1120 
ET
 * 
	gbuf
 = (ET *è
m®loc
(
Ën
);

1121 
	gi
=0; i < (è(
	gËn
 / (
	gET
)); i++) {

1122 
	gbuf
[
i
] = 
z”ov®ue
;

1124 
wr™e_com´es£d
(
f
, 
buf
, 
Ën
);

1125 
şo£
(
f
);

1127 #ifdeà
DYNAMICEDATA


1128 
wr™e_block_uncom´es£d_size
(
block_f’ame
, 
Ën
);

1140 
£t_»£t_v”‹xd©a
(
boŞ
 
»£t
) {

1141 
	g»£t_v”‹xd©a
 = 
»£t
;

1148 
vœtu®
 
£t_§ve_edgesfes_aá”_šmemmode
(
boŞ
 
b
) {

1149 
	gthis
->
	g§ve_edgesfes_aá”_šmemmode
 = 
b
;

1152 
vœtu®
 
£t_š™Ÿlize_edges_befÜe_run
(
boŞ
 
b
) {

1153 
	gthis
->
	gš™Ÿlize_edges_befÜe_run
 = 
b
;

1161 
£t_jsÚ
(
¡d
::
¡ršg
 
key
, std::¡ršg 
v®ue
) {

1162 
h‰¶ock
.
lock
();

1163 
	gjsÚ_·¿ms
[
key
] = 
v®ue
;

1164 
	gh‰¶ock
.
uÆock
();

1167 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

1168 
£t_jsÚ
(
¡d
::
¡ršg
 
key
, 
T
 
v®
) {

1169 
	g¡d
::
¡ršg¡»am
 
ss
;

1170 
	gss
 << 
	gv®
;

1171 
£t_jsÚ
(
key
, 
ss
.
¡r
());

1174 
	g¡d
::
¡ršg
 
g‘_šfo_jsÚ
() {

1175 
¡d
::
¡ršg¡»am
 
jsÚ
;

1176 
	gjsÚ
 << "{";

1177 
	gjsÚ
 << "\"fe\" : \"" << 
	gba£_f’ame
 << "\",\n";

1178 
	gjsÚ
 << "\"numOfSh¬ds\": " << 
	gnsh¬ds
 << ",\n";

1179 
	gjsÚ
 << "\"™”©iÚ\": " << 
	gchicÚ‹xt
.
	g™”©iÚ
 << ",\n";

1180 
	gjsÚ
 << "\"numI‹¿tiÚs\": " << 
	gchicÚ‹xt
.
	gnum_™”©iÚs
 << ",\n";

1181 
	gjsÚ
 << "\"runTime\": " << 
	gchicÚ‹xt
.
ruÁime
() << ",\n";

1183 
	gjsÚ
 << "\"upd©es\": " << 
	gnupd©es
 << ",\n";

1184 
	gjsÚ
 << "\"nv”tiûs\": " << 
	gchicÚ‹xt
.
	gnv”tiûs
 << ",\n";

1185 
	gjsÚ
 << "\"š‹rv®\":" << 
	gexec_š‹rv®
 << ",\n";

1186 
	gjsÚ
 << "\"wšdowS¹\":" << 
	gsub_š‹rv®_¡
 << ",";

1187 
	gjsÚ
 << "\"wšdowEnd\": " << 
	gsub_š‹rv®_’
 << ",";

1188 
	gjsÚ
 << "\"shards\": [";

1190 
	gp
=0;… < ()
	gnsh¬ds
;…++) {

1191 ià(
	gp
>0è
	gjsÚ
 << ",";

1193 
	gjsÚ
 << "{";

1194 
	gjsÚ
 << "\"p\": " << 
	gp
 << ", ";

1195 
	gjsÚ
 << 
	g¦idšg_sh¬ds
[
p
]->
g‘_šfo_jsÚ
();

1196 
	gjsÚ
 << "}";

1199 
	gjsÚ
 << "]";

1200 
	gjsÚ
 << "}";

1201  
	gjsÚ
.
¡r
();

	@external/vpiotr-mongoose-cpp/examples/chat.c

13 
	~<¡dio.h
>

14 
	~<¡dlib.h
>

15 
	~<as£¹.h
>

16 
	~<¡ršg.h
>

17 
	~<time.h
>

18 
	~<¡d¬g.h
>

19 
	~<±h»ad.h
>

21 
	~"mÚgoo£.h
"

23 
	#MAX_USER_LEN
 20

	)

24 
	#MAX_MESSAGE_LEN
 100

	)

25 
	#MAX_MESSAGES
 5

	)

26 
	#MAX_SESSIONS
 2

	)

27 
	#SESSION_TTL
 120

	)

29 cÚ¡ *
	gauthÜize_u¾
 = "/authorize";

30 cÚ¡ *
	glogš_u¾
 = "/login.html";

31 cÚ¡ *
	gajax_»¶y_¡¬t
 =

39 
	smes§ge
 {

40 
	mid
;

41 
	mu£r
[
MAX_USER_LEN
];

42 
	m‹xt
[
MAX_MESSAGE_LEN
];

43 
time_t
 
	mtime¡amp
;

47 
	s£ssiÚ
 {

48 
	m£ssiÚ_id
[33];

49 
	m¿ndom
[20];

50 
	mu£r
[
MAX_USER_LEN
];

51 
time_t
 
	mexpœe
;

54 
mes§ge
 
	gmes§ges
[
MAX_MESSAGES
];

55 
£ssiÚ
 
	g£ssiÚs
[
MAX_SESSIONS
];

56 
	gÏ¡_mes§ge_id
;

59 
±h»ad_rwlock_t
 
	grwlock
 = 
PTHREAD_RWLOCK_INITIALIZER
;

62 
£ssiÚ
 *
	$g‘_£ssiÚ
(cÚ¡ 
mg_cÚÃùiÚ
 *
cÚn
) {

63 
i
;

64 
£ssiÚ_id
[33];

65 
time_t
 
now
 = 
	`time
(
NULL
);

66 
	`mg_g‘_cook›
(
cÚn
, "£ssiÚ", 
£ssiÚ_id
, (session_id));

67 
i
 = 0; i < 
MAX_SESSIONS
; i++) {

68 ià(
£ssiÚs
[
i
].
expœe
 != 0 &&

69 
£ssiÚs
[
i
].
expœe
 > 
now
 &&

70 
	`¡rcmp
(
£ssiÚs
[
i
].
£ssiÚ_id
, session_id) == 0) {

74  
i
 =ğ
MAX_SESSIONS
 ? 
NULL
 : &
£ssiÚs
[i];

75 
	}
}

77 
	$g‘_qsv¬
(cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
,

78 cÚ¡ *
Çme
, *
d¡
, 
size_t
 
d¡_Ën
) {

79 cÚ¡ *
qs
 = 
»que¡_šfo
->
qu”y_¡ršg
;

80 
	`mg_g‘_v¬
(
qs
, 
	`¡¾’
(q =ğ
NULL
 ? "" : qs), 
Çme
, 
d¡
, 
d¡_Ën
);

81 
	}
}

87 *
	$mes§ges_to_jsÚ
(
Ï¡_id
) {

88 cÚ¡ 
mes§ge
 *message;

89 
max_msgs
, 
Ën
;

90 
buf
[(
mes§ges
)];

93 
	`±h»ad_rwlock_rdlock
(&
rwlock
);

94 
Ën
 = 0;

95 
max_msgs
 = (
mes§ges
) / (messages[0]);

97 ià(
Ï¡_mes§ge_id
 - 
Ï¡_id
 > 
max_msgs
) {

98 
Ï¡_id
 = 
Ï¡_mes§ge_id
 - 
max_msgs
;

100 ; 
Ï¡_id
 < 
Ï¡_mes§ge_id
;†ast_id++) {

101 
mes§ge
 = &
mes§ges
[
Ï¡_id
 % 
max_msgs
];

102 ià(
mes§ge
->
time¡amp
 == 0) {

108 
Ën
 +ğ
	`¢´štf
(
buf
 +†en, (buf) -†en,

110 
mes§ge
->
u£r
, mes§ge->
‹xt
, mes§ge->
time¡amp
, mes§ge->
id
);

111 
	`as£¹
(
Ën
 > 0);

112 
	`as£¹
((
size_t
è
Ën
 < (
buf
));

114 
	`±h»ad_rwlock_uÆock
(&
rwlock
);

116  
Ën
 =ğ0 ? 
NULL
 : 
	`¡rdup
(
buf
);

117 
	}
}

122 
	$hªdË_jsÚp
(
mg_cÚÃùiÚ
 *
cÚn
,

123 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

124 
cb
[64];

126 
	`g‘_qsv¬
(
»que¡_šfo
, "ÿÎback", 
cb
, (cb));

127 ià(
cb
[0] != '\0') {

128 
	`mg_´štf
(
cÚn
, "%s(", 
cb
);

131  
cb
[0] == '\0' ? 0 : 1;

132 
	}
}

136 
	$ajax_g‘_mes§ges
(
mg_cÚÃùiÚ
 *
cÚn
,

137 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

138 
Ï¡_id
[32], *
jsÚ
;

139 
is_jsÚp
;

141 
	`mg_´štf
(
cÚn
, "%s", 
ajax_»¶y_¡¬t
);

142 
is_jsÚp
 = 
	`hªdË_jsÚp
(
cÚn
, 
»que¡_šfo
);

144 
	`g‘_qsv¬
(
»que¡_šfo
, "Ï¡_id", 
Ï¡_id
, (last_id));

145 ià((
jsÚ
 = 
	`mes§ges_to_jsÚ
(
	`¡¹oul
(
Ï¡_id
, 
NULL
, 10))) != NULL) {

146 
	`mg_´štf
(
cÚn
, "[%s]", 
jsÚ
);

147 
	`ä“
(
jsÚ
);

150 ià(
is_jsÚp
) {

151 
	`mg_´štf
(
cÚn
, "%s", ")");

153 
	}
}

156 
mes§ge
 *
	$Ãw_mes§ge
() {

157 
size
 = (
mes§ges
) / (messages[0]);

158 
mes§ge
 *mes§gğ&
mes§ges
[
Ï¡_mes§ge_id
 % 
size
];

159 
mes§ge
->
id
 = 
Ï¡_mes§ge_id
++;

160 
mes§ge
->
time¡amp
 = 
	`time
(0);

161  
mes§ge
;

162 
	}
}

164 
	$my_¡¾ıy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
Ën
) {

165 
	`¡ºıy
(
d¡
, 
¤c
, 
Ën
);

166 
d¡
[
Ën
 - 1] = '\0';

167 
	}
}

170 
	$ajax_£nd_mes§ge
(
mg_cÚÃùiÚ
 *
cÚn
,

171 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

172 
mes§ge
 *message;

173 
£ssiÚ
 *session;

174 
‹xt
[(
mes§ge
->text) - 1];

175 
is_jsÚp
;

177 
	`mg_´štf
(
cÚn
, "%s", 
ajax_»¶y_¡¬t
);

178 
is_jsÚp
 = 
	`hªdË_jsÚp
(
cÚn
, 
»que¡_šfo
);

180 
	`g‘_qsv¬
(
»que¡_šfo
, "‹xt", 
‹xt
, (text));

181 ià(
‹xt
[0] != '\0') {

184 
	`±h»ad_rwlock_w¾ock
(&
rwlock
);

185 
mes§ge
 = 
	`Ãw_mes§ge
();

187 
£ssiÚ
 = 
	`g‘_£ssiÚ
(
cÚn
);

188 
	`as£¹
(
£ssiÚ
 !ğ
NULL
);

189 
	`my_¡¾ıy
(
mes§ge
->
‹xt
,ext, (text));

190 
	`my_¡¾ıy
(
mes§ge
->
u£r
, 
£ssiÚ
->user, (message->user));

191 
	`±h»ad_rwlock_uÆock
(&
rwlock
);

194 
	`mg_´štf
(
cÚn
, "%s", 
‹xt
[0] == '\0' ? "false" : "true");

196 ià(
is_jsÚp
) {

197 
	`mg_´štf
(
cÚn
, "%s", ")");

199 
	}
}

203 
	$»dœeù_to_logš
(
mg_cÚÃùiÚ
 *
cÚn
,

204 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

205 
	`mg_´štf
(
cÚn
, "HTTP/1.1 302 Found\r\n"

208 
»que¡_šfo
->
uri
, 
logš_u¾
);

209 
	}
}

212 
	$check_·sswÜd
(cÚ¡ *
u£r
, cÚ¡ *
·sswÜd
) {

216  (
u£r
[0] && 
·sswÜd
[0]);

217 
	}
}

220 
£ssiÚ
 *
	$Ãw_£ssiÚ
() {

221 
i
;

222 
time_t
 
now
 = 
	`time
(
NULL
);

223 
	`±h»ad_rwlock_w¾ock
(&
rwlock
);

224 
i
 = 0; i < 
MAX_SESSIONS
; i++) {

225 ià(
£ssiÚs
[
i
].
expœe
 =ğ0 || sessiÚs[i].expœ< 
now
) {

226 
£ssiÚs
[
i
].
expœe
 = 
	`time
(0è+ 
SESSION_TTL
;

230 
	`±h»ad_rwlock_uÆock
(&
rwlock
);

231  
i
 =ğ
MAX_SESSIONS
 ? 
NULL
 : &
£ssiÚs
[i];

232 
	}
}

237 
	$g’”©e_£ssiÚ_id
(*
buf
, cÚ¡ *
¿ndom
,

238 cÚ¡ *
u£r
) {

239 
	`mg_md5
(
buf
, 
¿ndom
, 
u£r
, 
NULL
);

240 
	}
}

242 
	$£nd_£rv”_mes§ge
(cÚ¡ *
fmt
, ...) {

243 
va_li¡
 
­
;

244 
mes§ge
 *message;

246 
	`±h»ad_rwlock_w¾ock
(&
rwlock
);

247 
mes§ge
 = 
	`Ãw_mes§ge
();

248 
mes§ge
->
u£r
[0] = '\0';

249 
	`va_¡¬t
(
­
, 
fmt
);

250 
	`v¢´štf
(
mes§ge
->
‹xt
, (mes§ge->‹xt), 
fmt
, 
­
);

251 
	`va_’d
(
­
);

253 
	`±h»ad_rwlock_uÆock
(&
rwlock
);

254 
	}
}

258 
	$authÜize
(
mg_cÚÃùiÚ
 *
cÚn
,

259 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

260 
u£r
[
MAX_USER_LEN
], 
·sswÜd
[MAX_USER_LEN];

261 
£ssiÚ
 *session;

264 
	`g‘_qsv¬
(
»que¡_šfo
, "u£r", 
u£r
, (user));

265 
	`g‘_qsv¬
(
»que¡_šfo
, "·sswÜd", 
·sswÜd
, (password));

267 ià(
	`check_·sswÜd
(
u£r
, 
·sswÜd
è&& (
£ssiÚ
 = 
	`Ãw_£ssiÚ
()è!ğ
NULL
) {

279 
	`my_¡¾ıy
(
£ssiÚ
->
u£r
, user, (session->user));

280 
	`¢´štf
(
£ssiÚ
->
¿ndom
, (£ssiÚ->¿ndom), "%d", 
	`¿nd
());

281 
	`g’”©e_£ssiÚ_id
(
£ssiÚ
->
£ssiÚ_id
, sessiÚ->
¿ndom
, sessiÚ->
u£r
);

282 
	`£nd_£rv”_mes§ge
("<%s> jošed", 
£ssiÚ
->
u£r
);

283 
	`mg_´štf
(
cÚn
, "HTTP/1.1 302 Found\r\n"

288 
£ssiÚ
->
£ssiÚ_id
, sessiÚ->
u£r
);

291 
	`»dœeù_to_logš
(
cÚn
, 
»que¡_šfo
);

293 
	}
}

296 
	$is_authÜized
(cÚ¡ 
mg_cÚÃùiÚ
 *
cÚn
,

297 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

298 
£ssiÚ
 *session;

299 
v®id_id
[33];

300 
authÜized
 = 0;

303 ià(!
	`¡rcmp
(
»que¡_šfo
->
uri
, 
logš_u¾
) ||

304 !
	`¡rcmp
(
»que¡_šfo
->
uri
, 
authÜize_u¾
)) {

308 
	`±h»ad_rwlock_rdlock
(&
rwlock
);

309 ià((
£ssiÚ
 = 
	`g‘_£ssiÚ
(
cÚn
)è!ğ
NULL
) {

310 
	`g’”©e_£ssiÚ_id
(
v®id_id
, 
£ssiÚ
->
¿ndom
, sessiÚ->
u£r
);

311 ià(
	`¡rcmp
(
v®id_id
, 
£ssiÚ
->
£ssiÚ_id
) == 0) {

312 
£ssiÚ
->
expœe
 = 
	`time
(0è+ 
SESSION_TTL
;

313 
authÜized
 = 1;

316 
	`±h»ad_rwlock_uÆock
(&
rwlock
);

318  
authÜized
;

319 
	}
}

321 
	$»dœeù_to_s¦
(
mg_cÚÃùiÚ
 *
cÚn
,

322 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

323 cÚ¡ *
p
, *
ho¡
 = 
	`mg_g‘_h—d”
(
cÚn
, "Host");

324 ià(
ho¡
 !ğ
NULL
 && (
p
 = 
	`¡rchr
(host, ':')) != NULL) {

325 
	`mg_´štf
(
cÚn
, "HTTP/1.1 302 Found\r\n"

327 
p
 - 
ho¡
, ho¡, 
»que¡_šfo
->
uri
);

329 
	`mg_´štf
(
cÚn
, "%s", "HTTP/1.1 500 Error\r\n\r\nHost: header is‚ot set");

331 
	}
}

333 *
	$ev’t_hªdËr
(
mg_ev’t
 
ev’t
,

334 
mg_cÚÃùiÚ
 *
cÚn
,

335 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

336 *
´oûs£d
 = "yes";

338 ià(
ev’t
 =ğ
MG_NEW_REQUEST
) {

339 ià(!
»que¡_šfo
->
is_s¦
) {

340 
	`»dœeù_to_s¦
(
cÚn
, 
»que¡_šfo
);

341 } ià(!
	`is_authÜized
(
cÚn
, 
»que¡_šfo
)) {

342 
	`»dœeù_to_logš
(
cÚn
, 
»que¡_šfo
);

343 } ià(
	`¡rcmp
(
»que¡_šfo
->
uri
, 
authÜize_u¾
) == 0) {

344 
	`authÜize
(
cÚn
, 
»que¡_šfo
);

345 } ià(
	`¡rcmp
(
»que¡_šfo
->
uri
, "/ajax/get_messages") == 0) {

346 
	`ajax_g‘_mes§ges
(
cÚn
, 
»que¡_šfo
);

347 } ià(
	`¡rcmp
(
»que¡_šfo
->
uri
, "/ajax/send_message") == 0) {

348 
	`ajax_£nd_mes§ge
(
cÚn
, 
»que¡_šfo
);

352 
´oûs£d
 = 
NULL
;

355 
´oûs£d
 = 
NULL
;

358  
´oûs£d
;

359 
	}
}

361 cÚ¡ *
	gİtiÚs
[] = {

366 
NULL


369 
	$maš
() {

370 
mg_cÚ‹xt
 *
ùx
;

374 
	`¤ªd
((è
	`time
(0));

377 
ùx
 = 
	`mg_¡¬t
(&
ev’t_hªdËr
, 
NULL
, 
İtiÚs
);

378 
	`as£¹
(
ùx
 !ğ
NULL
);

381 
	`´štf
("Chat server started on…orts %s,…ressƒntero quit.\n",

382 
	`mg_g‘_İtiÚ
(
ùx
, "listening_ports"));

383 
	`g‘ch¬
();

384 
	`mg_¡İ
(
ùx
);

385 
	`´štf
("%s\n", "Chat server stopped.");

387  
EXIT_SUCCESS
;

388 
	}
}

	@external/vpiotr-mongoose-cpp/main.c

21 #ià
defšed
(
_WIN32
)

22 
	#_CRT_SECURE_NO_WARNINGS


23 #–£

	)

24 
	#_XOPEN_SOURCE
 600

26 

	)

27 
	~<sys/¡©.h
>

28 
	~<¡dio.h
>

29 
	~<¡dlib.h
>

30 
	~<sigÇl.h
>

31 
	~<¡ršg.h
>

32 
	~<”ºo.h
>

33 
	~<lim™s.h
>

34 
	~<¡ddef.h
>

35 
	~<¡d¬g.h
>

37 
	~"mÚgoo£.h
"

39 #ifdeà
_WIN32


40 
	~<wšdows.h
>

41 
	~<wšsvc.h
>

42 
	#PATH_MAX
 
MAX_PATH


	)

43 
	#S_ISDIR
(
x
è((xè& 
_S_IFDIR
)

	)

44 
	#DIRSEP
 '\\'

	)

45 
	#¢´štf
 
_¢´štf


	)

46 
	#v¢´štf
 
_v¢´štf


	)

47 
	#¦“p
(
x
è
	`SË•
((xè* 1000)

	)

48 
	#WINCDECL
 
__cdeş


	)

50 
	~<sys/wa™.h
>

51 
	~<uni¡d.h
>

52 
	#DIRSEP
 '/'

	)

53 
	#WINCDECL


	)

56 
	#MAX_OPTIONS
 40

	)

58 
	gex™_æag
;

59 
	g£rv”_Çme
[40];

60 
	gcÚfig_fe
[
PATH_MAX
];

61 
mg_cÚ‹xt
 *
	gùx
;

63 #ià!
defšed
(
CONFIG_FILE
)

64 
	#CONFIG_FILE
 "mÚgoo£.cÚf"

	)

67 
WINCDECL
 
	$sigÇl_hªdËr
(
sig_num
) {

68 
ex™_æag
 = 
sig_num
;

69 
	}
}

71 
	$d›
(cÚ¡ *
fmt
, ...) {

72 
va_li¡
 
­
;

73 
msg
[200];

75 
	`va_¡¬t
(
­
, 
fmt
);

76 
	`v¢´štf
(
msg
, (msg), 
fmt
, 
­
);

77 
	`va_’d
(
­
);

79 #ià
	`defšed
(
_WIN32
)

80 
	`Mes§geBox
(
NULL
, 
msg
, "E¼Ü", 
MB_OK
);

82 
	`årštf
(
¡d”r
, "%s\n", 
msg
);

85 
	`ex™
(
EXIT_FAILURE
);

86 
	}
}

91 
	$mg_ed™_·sswÜds
(cÚ¡ *
âame
, cÚ¡ *
domaš
,

92 cÚ¡ *
u£r
, cÚ¡ *
·ss
) {

93 
mg_cÚ‹xt
 *
ùx
;

94 cÚ¡ *
İtiÚs
[] = {"auth’tiÿtiÚ_domaš", 
NULL
, NULL};

95 
sucûss
;

97 
İtiÚs
[1] = 
domaš
;

98 
ùx
 = 
	`mg_¡¬t
(
NULL
, NULL, 
İtiÚs
);

99 
sucûss
 = 
	`mg_modify_·sswÜds_fe
(
ùx
, 
âame
, 
u£r
, 
·ss
);

100 
	`mg_¡İ
(
ùx
);

102  
sucûss
;

103 
	}
}

105 
	$show_u§ge_ªd_ex™
() {

106 cÚ¡ **
Çmes
;

107 
i
;

109 
	`årštf
(
¡d”r
, "MÚgoo£ v”siÚ % (cèS”gey Lyubka\n", 
	`mg_v”siÚ
());

110 
	`årštf
(
¡d”r
, "Usage:\n");

111 
	`årštf
(
¡d”r
, " mongoose -A <htpasswd_file> <realm> <user> <passwd>\n");

112 
	`årštf
(
¡d”r
, " mongoose <config_file>\n");

113 
	`årštf
(
¡d”r
, " mongoose [-option value ...]\n");

114 
	`årštf
(
¡d”r
, "OPTIONS:\n");

116 
Çmes
 = 
	`mg_g‘_v®id_İtiÚ_Çmes
();

117 
i
 = 0; 
Çmes
[i] !ğ
NULL
; i += 3) {

118 
	`årštf
(
¡d”r
, " -%s %s (default: \"%s\")\n",

119 
Çmes
[
i
],‚ames[˜+ 1],‚ames[˜+ 2] =ğ
NULL
 ? "" :‚ames[i + 2]);

121 
	`årštf
(
¡d”r
, "See http://code.google.com/p/mongoose/wiki/MongooseManual"

123 
	`årštf
(
¡d”r
, "Example:\n mongoose -s cert.pem -p 80,443s -d‚o\n");

124 
	`ex™
(
EXIT_FAILURE
);

125 
	}
}

127 
	$v”ify_docum’t_roÙ
(cÚ¡ *
roÙ
) {

128 cÚ¡ *
p
, *
·th
;

129 
buf
[
PATH_MAX
];

130 
¡©
 
¡
;

132 
·th
 = 
roÙ
;

133 ià((
p
 = 
	`¡rchr
(
roÙ
, ',')è!ğ
NULL
 && (
size_t
èÕ -„oÙè< (
buf
)) {

134 
	`¡ºıy
(
buf
, 
roÙ
, 
p
 -„oot);

135 
·th
 = 
buf
;

138 ià(
	`¡©
(
·th
, &
¡
è!ğ0 || !
	`S_ISDIR
(¡.
¡_mode
)) {

139 
	`d›
("Inv®id„oÙ dœeùÜy: \"%s\"", 
roÙ
);

141 
	}
}

143 *
	$sdup
(cÚ¡ *
¡r
) {

144 *
p
;

145 ià((
p
 = 
	`m®loc
(
	`¡¾’
(
¡r
è+ 1)è!ğ
NULL
) {

146 
	`¡rıy
(
p
, 
¡r
);

148  
p
;

149 
	}
}

151 
	$£t_İtiÚ
(**
İtiÚs
, cÚ¡ *
Çme
, cÚ¡ *
v®ue
) {

152 
i
;

154 ià(!
	`¡rcmp
(
Çme
, "document_root") || !(strcmp(name, "r"))) {

155 
	`v”ify_docum’t_roÙ
(
v®ue
);

158 
i
 = 0; i < 
MAX_OPTIONS
 - 3; i++) {

159 ià(
İtiÚs
[
i
] =ğ
NULL
) {

160 
İtiÚs
[
i
] = 
	`sdup
(
Çme
);

161 
İtiÚs
[
i
 + 1] = 
	`sdup
(
v®ue
);

162 
İtiÚs
[
i
 + 2] = 
NULL
;

167 ià(
i
 =ğ
MAX_OPTIONS
 - 3) {

168 
	`d›
("%s", "Too many options specified");

170 
	}
}

172 
	$´oûss_commªd_lše_¬gum’ts
(*
¬gv
[], **
İtiÚs
) {

173 
lše
[512], 
İt
[512], 
v®
[512], *
p
;

174 
FILE
 *
å
 = 
NULL
;

175 
size_t
 
i
, 
lše_no
 = 0;

177 
İtiÚs
[0] = 
NULL
;

180 ià(
¬gv
[1] !ğ
NULL
 &&‡rgv[2] == NULL) {

181 
	`¢´štf
(
cÚfig_fe
, (cÚfig_fe), "%s", 
¬gv
[1]);

182 } ià((
p
 = 
	`¡¼chr
(
¬gv
[0], 
DIRSEP
)è=ğ
NULL
) {

184 
	`¢´štf
(
cÚfig_fe
, (cÚfig_fe), "%s", 
CONFIG_FILE
);

186 
	`¢´štf
(
cÚfig_fe
, (config_file), "%.*s%c%s",

187 (è(
p
 - 
¬gv
[0]),‡rgv[0], 
DIRSEP
, 
CONFIG_FILE
);

190 
å
 = 
	`fİ’
(
cÚfig_fe
, "r");

193 ià(
¬gv
[1] !ğ
NULL
 &&‡rgv[2] =ğNULL && 
å
 == NULL) {

194 
	`d›
("CªnÙ o³ÀcÚfig f%s: %s", 
cÚfig_fe
, 
	`¡»¼Ü
(
”ºo
));

198 ià(
å
 !ğ
NULL
) {

199 
	`årštf
(
¡d”r
, "Lßdšg cÚfig f%s\n", 
cÚfig_fe
);

202 
	`fg‘s
(
lše
, Öše), 
å
è!ğ
NULL
) {

204 
lše_no
++;

207 ià(
lše
[0] == '#' ||†ine[0] == '\n')

210 ià(
	`ssÿnf
(
lše
, "% %[^\r\n#]", 
İt
, 
v®
) != 2) {

211 
	`d›
("%s:†š%d i šv®id", 
cÚfig_fe
, (è
lše_no
);

213 
	`£t_İtiÚ
(
İtiÚs
, 
İt
, 
v®
);

216 (è
	`fşo£
(
å
);

220 
i
 = 1; 
¬gv
[i] !ğ
NULL
; i += 2) {

221 ià(
¬gv
[
i
][0] !ğ'-' ||‡rgv[˜+ 1] =ğ
NULL
) {

222 
	`show_u§ge_ªd_ex™
();

224 
	`£t_İtiÚ
(
İtiÚs
, &
¬gv
[
i
][1],‡rgv[i + 1]);

226 
	}
}

228 
	$š™_£rv”_Çme
() {

229 
	`¢´štf
(
£rv”_Çme
, (server_name), "Mongoose web server v.%s",

230 
	`mg_v”siÚ
());

231 
	}
}

233 
	$¡¬t_mÚgoo£
(
¬gc
, *
¬gv
[]) {

234 *
İtiÚs
[
MAX_OPTIONS
];

235 
i
;

238 ià(
¬gc
 > 1 && 
¬gv
[1][0] == '-' &&‡rgv[1][1] == 'A') {

239 ià(
¬gc
 != 6) {

240 
	`show_u§ge_ªd_ex™
();

242 
	`ex™
(
	`mg_ed™_·sswÜds
(
¬gv
[2],‡rgv[3],‡rgv[4],‡rgv[5]) ?

243 
EXIT_SUCCESS
 : 
EXIT_FAILURE
);

247 ià(
¬gc
 =ğ2 && (!
	`¡rcmp
(
¬gv
[1], "-h") || !strcmp(argv[1], "--help"))) {

248 
	`show_u§ge_ªd_ex™
();

252 
	`´oûss_commªd_lše_¬gum’ts
(
¬gv
, 
İtiÚs
);

255 
	`sigÇl
(
SIGTERM
, 
sigÇl_hªdËr
);

256 
	`sigÇl
(
SIGINT
, 
sigÇl_hªdËr
);

259 
ùx
 = 
	`mg_¡¬t
(
NULL
, NULL, (cÚ¡ **è
İtiÚs
);

260 
i
 = 0; 
İtiÚs
[i] !ğ
NULL
; i++) {

261 
	`ä“
(
İtiÚs
[
i
]);

264 ià(
ùx
 =ğ
NULL
) {

265 
	`d›
("%s", "Failedo start Mongoose. Maybe some options‡re "

269 
	}
}

271 #ifdeà
_WIN32


272 
SERVICE_STATUS
 
	gss
;

273 
SERVICE_STATUS_HANDLE
 
	ghStus
;

274 cÚ¡ *
	g£rviû_magic_¬gum’t
 = "--";

276 
WINAPI
 
	$CÚŒŞHªdËr
(
DWORD
 
code
) {

277 ià(
code
 =ğ
SERVICE_CONTROL_STOP
 || cod=ğ
SERVICE_CONTROL_SHUTDOWN
) {

278 
ss
.
dwWš32Ex™Code
 = 0;

279 
ss
.
dwCu¼’tS‹
 = 
SERVICE_STOPPED
;

281 
	`S‘S”viûStus
(
hStus
, &
ss
);

282 
	}
}

284 
WINAPI
 
	$S”viûMaš
() {

285 
ss
.
dwS”viûTy³
 = 
SERVICE_WIN32
;

286 
ss
.
dwCu¼’tS‹
 = 
SERVICE_RUNNING
;

287 
ss
.
dwCÚŒŞsAcû±ed
 = 
SERVICE_ACCEPT_STOP
 | 
SERVICE_ACCEPT_SHUTDOWN
;

289 
hStus
 = 
	`Regi¡”S”viûCŒlHªdËr
(
£rv”_Çme
, 
CÚŒŞHªdËr
);

290 
	`S‘S”viûStus
(
hStus
, &
ss
);

292 
ss
.
dwCu¼’tS‹
 =ğ
SERVICE_RUNNING
) {

293 
	`SË•
(1000);

295 
	`mg_¡İ
(
ùx
);

297 
ss
.
dwCu¼’tS‹
 = 
SERVICE_STOPPED
;

298 
ss
.
dwWš32Ex™Code
 = (
DWORD
) -1;

299 
	`S‘S”viûStus
(
hStus
, &
ss
);

300 
	}
}

302 
	#ID_TRAYICON
 100

	)

303 
	#ID_QUIT
 101

	)

304 
	#ID_EDIT_CONFIG
 102

	)

305 
	#ID_SEPARATOR
 103

	)

306 
	#ID_INSTALL_SERVICE
 104

	)

307 
	#ID_REMOVE_SERVICE
 105

	)

308 
	#ID_ICON
 200

	)

309 
NOTIFYICONDATA
 
	gT¿yIcÚ
;

311 
	$ed™_cÚfig_fe
() {

312 cÚ¡ **
Çmes
, *
v®ue
;

313 
FILE
 *
å
;

314 
i
;

315 
cmd
[200];

318 ià((
å
 = 
	`fİ’
(
cÚfig_fe
, "r")è!ğ
NULL
) {

319 
	`fşo£
(
å
);

320 } ià((
å
 = 
	`fİ’
(
cÚfig_fe
, "a+")è!ğ
NULL
) {

321 
	`årštf
(
å
,

326 
Çmes
 = 
	`mg_g‘_v®id_İtiÚ_Çmes
();

327 
i
 = 0; 
Çmes
[i] !ğ
NULL
; i += 3) {

328 
v®ue
 = 
	`mg_g‘_İtiÚ
(
ùx
, 
Çmes
[
i
]);

329 
	`årštf
(
å
, "# % %s\n", 
Çmes
[
i
 + 1], *
v®ue
 ? value : "<value>");

331 
	`fşo£
(
å
);

334 
	`¢´štf
(
cmd
, (cmd), "nÙ•ad.ex%s", 
cÚfig_fe
);

335 
	`WšExec
(
cmd
, 
SW_SHOW
);

336 
	}
}

338 
	$show_”rÜ
() {

339 
buf
[256];

340 
	`FÜm©Mes§ge
(
FORMAT_MESSAGE_FROM_SYSTEM
 | 
FORMAT_MESSAGE_IGNORE_INSERTS
,

341 
NULL
, 
	`G‘La¡E¼Ü
(),

342 
	`MAKELANGID
(
LANG_NEUTRAL
, 
SUBLANG_DEFAULT
),

343 
buf
, (buf), 
NULL
);

344 
	`Mes§geBox
(
NULL
, 
buf
, "E¼Ü", 
MB_OK
);

345 
	}
}

347 
	$mªage_£rviû
(
aùiÚ
) {

348 cÚ¡ *
£rviû_Çme
 = "Mongoose";

349 
SC_HANDLE
 
hSCM
 = 
NULL
, 
hS”viû
 = NULL;

350 
SERVICE_DESCRIPTION
 
desü
 = {
£rv”_Çme
};

351 
·th
[
PATH_MAX
 + 20];

352 
sucûss
 = 1;

354 ià((
hSCM
 = 
	`O³nSCMªag”
(
NULL
, NULL, 
aùiÚ
 =ğ
ID_INSTALL_SERVICE
 ?

355 
GENERIC_WRITE
 : 
GENERIC_READ
)è=ğ
NULL
) {

356 
sucûss
 = 0;

357 
	`show_”rÜ
();

358 } ià(
aùiÚ
 =ğ
ID_INSTALL_SERVICE
) {

359 
	`G‘ModuËFeName
(
NULL
, 
·th
, (path));

360 
	`¡ºÿt
(
·th
, " ", (path));

361 
	`¡ºÿt
(
·th
, 
£rviû_magic_¬gum’t
, (path));

362 
hS”viû
 = 
	`C»©eS”viû
(
hSCM
, 
£rviû_Çme
, service_name,

363 
SERVICE_ALL_ACCESS
, 
SERVICE_WIN32_OWN_PROCESS
,

364 
SERVICE_AUTO_START
, 
SERVICE_ERROR_NORMAL
,

365 
·th
, 
NULL
, NULL, NULL, NULL, NULL);

366 ià(
hS”viû
) {

367 
	`ChªgeS”viûCÚfig2
(
hS”viû
, 
SERVICE_CONFIG_DESCRIPTION
, &
desü
);

369 
	`show_”rÜ
();

371 } ià(
aùiÚ
 =ğ
ID_REMOVE_SERVICE
) {

372 ià((
hS”viû
 = 
	`O³nS”viû
(
hSCM
, 
£rviû_Çme
, 
DELETE
)è=ğ
NULL
 ||

373 !
	`D–‘eS”viû
(
hS”viû
)) {

374 
	`show_”rÜ
();

376 } ià((
hS”viû
 = 
	`O³nS”viû
(
hSCM
, 
£rviû_Çme
,

377 
SERVICE_QUERY_STATUS
)è=ğ
NULL
) {

378 
sucûss
 = 0;

381 
	`Clo£S”viûHªdË
(
hS”viû
);

382 
	`Clo£S”viûHªdË
(
hSCM
);

384  
sucûss
;

385 
	}
}

387 
LRESULT
 
CALLBACK
 
	$WšdowProc
(
HWND
 
hWnd
, 
UINT
 
msg
, 
WPARAM
 
wP¬am
,

388 
LPARAM
 
lP¬am
) {

389 
SERVICE_TABLE_ENTRY
 
£rviû_bË
[] = {

390 {
£rv”_Çme
, (
LPSERVICE_MAIN_FUNCTION
è
S”viûMaš
},

391 {
NULL
, NULL}

393 
£rviû_š¡®Ëd
;

394 
buf
[200], *
£rviû_¬gv
[] = {
__¬gv
[0], 
NULL
};

395 
POINT
 
±
;

396 
HMENU
 
hM’u
;

398 
msg
) {

399 
WM_CREATE
:

400 ià(
__¬gv
[1] !ğ
NULL
 &&

401 !
	`¡rcmp
(
__¬gv
[1], 
£rviû_magic_¬gum’t
)) {

402 
	`¡¬t_mÚgoo£
(1, 
£rviû_¬gv
);

403 
	`S¹S”viûCŒlDi¥©ch”
(
£rviû_bË
);

404 
	`ex™
(
EXIT_SUCCESS
);

406 
	`¡¬t_mÚgoo£
(
__¬gc
, 
__¬gv
);

409 
WM_COMMAND
:

410 
	`LOWORD
(
wP¬am
)) {

411 
ID_QUIT
:

412 
	`mg_¡İ
(
ùx
);

413 
	`Sh–l_NÙifyIcÚ
(
NIM_DELETE
, &
T¿yIcÚ
);

414 
	`Po¡Qu™Mes§ge
(0);

416 
ID_EDIT_CONFIG
:

417 
	`ed™_cÚfig_fe
();

419 
ID_INSTALL_SERVICE
:

420 
ID_REMOVE_SERVICE
:

421 
	`mªage_£rviû
(
	`LOWORD
(
wP¬am
));

425 
WM_USER
:

426 
lP¬am
) {

427 
WM_RBUTTONUP
:

428 
WM_LBUTTONUP
:

429 
WM_LBUTTONDBLCLK
:

430 
hM’u
 = 
	`C»©ePİupM’u
();

431 
	`Aµ’dM’u
(
hM’u
, 
MF_STRING
 | 
MF_GRAYED
, 
ID_SEPARATOR
, 
£rv”_Çme
);

432 
	`Aµ’dM’u
(
hM’u
, 
MF_SEPARATOR
, 
ID_SEPARATOR
, "");

433 
£rviû_š¡®Ëd
 = 
	`mªage_£rviû
(0);

434 
	`¢´štf
(
buf
, (buf), "NT service: %s installed",

435 
£rviû_š¡®Ëd
 ? "" : "not");

436 
	`Aµ’dM’u
(
hM’u
, 
MF_STRING
 | 
MF_GRAYED
, 
ID_SEPARATOR
, 
buf
);

437 
	`Aµ’dM’u
(
hM’u
, 
MF_STRING
 | (
£rviû_š¡®Ëd
 ? 
MF_GRAYED
 : 0),

438 
ID_INSTALL_SERVICE
, "Install");

439 
	`Aµ’dM’u
(
hM’u
, 
MF_STRING
 | (!
£rviû_š¡®Ëd
 ? 
MF_GRAYED
 : 0),

440 
ID_REMOVE_SERVICE
, "Deinstall");

441 
	`Aµ’dM’u
(
hM’u
, 
MF_SEPARATOR
, 
ID_SEPARATOR
, "");

442 
	`Aµ’dM’u
(
hM’u
, 
MF_STRING
, 
ID_EDIT_CONFIG
, "Edit config file");

443 
	`Aµ’dM’u
(
hM’u
, 
MF_STRING
, 
ID_QUIT
, "Exit");

444 
	`G‘CursÜPos
(&
±
);

445 
	`S‘FÜegroundWšdow
(
hWnd
);

446 
	`T¿ckPİupM’u
(
hM’u
, 0, 
±
.
x
,…t.
y
, 0, 
hWnd
, 
NULL
);

447 
	`Po¡Mes§ge
(
hWnd
, 
WM_NULL
, 0, 0);

448 
	`De¡royM’u
(
hM’u
);

454  
	`DefWšdowProc
(
hWnd
, 
msg
, 
wP¬am
, 
lP¬am
);

455 
	}
}

457 
WINAPI
 
	$WšMaš
(
HINSTANCE
 
hIn¡
, HINSTANCE 
hP»v
, 
LPSTR
 
cmdlše
, 
show
) {

458 
WNDCLASS
 
şs
;

459 
HWND
 
hWnd
;

460 
MSG
 
msg
;

462 
	`š™_£rv”_Çme
();

463 
	`mem£t
(&
şs
, 0, (cls));

464 
şs
.
ÍâWndProc
 = (
WNDPROC
è
WšdowProc
;

465 
şs
.
hIcÚ
 = 
	`LßdIcÚ
(
NULL
, 
IDI_APPLICATION
);

466 
şs
.
ÍszCÏssName
 = 
£rv”_Çme
;

468 
	`Regi¡”CÏss
(&
şs
);

469 
hWnd
 = 
	`C»©eWšdow
(
şs
.
ÍszCÏssName
, 
£rv”_Çme
, 
WS_OVERLAPPEDWINDOW
,

470 0, 0, 0, 0, 
NULL
, NULL, NULL, NULL);

471 
	`ShowWšdow
(
hWnd
, 
SW_HIDE
);

473 
T¿yIcÚ
.
cbSize
 = (TrayIcon);

474 
T¿yIcÚ
.
uID
 = 
ID_TRAYICON
;

475 
T¿yIcÚ
.
uFÏgs
 = 
NIF_ICON
 | 
NIF_MESSAGE
 | 
NIF_TIP
;

476 
T¿yIcÚ
.
hIcÚ
 = 
	`LßdImage
(
	`G‘ModuËHªdË
(
NULL
), 
	`MAKEINTRESOURCE
(
ID_ICON
),

477 
IMAGE_ICON
, 16, 16, 0);

478 
T¿yIcÚ
.
hWnd
 = hWnd;

479 
	`¢´štf
(
T¿yIcÚ
.
szT
, (T¿yIcÚ.szT), "%s", 
£rv”_Çme
);

480 
T¿yIcÚ
.
uC®lbackMes§ge
 = 
WM_USER
;

481 
	`Sh–l_NÙifyIcÚ
(
NIM_ADD
, &
T¿yIcÚ
);

483 
	`G‘Mes§ge
(&
msg
, 
hWnd
, 0, 0)) {

484 
	`T¿n¦©eMes§ge
(&
msg
);

485 
	`Di¥©chMes§ge
(&
msg
);

487 
	}
}

489 
	$maš
(
¬gc
, *
¬gv
[]) {

490 
	`š™_£rv”_Çme
();

491 
	`¡¬t_mÚgoo£
(
¬gc
, 
¬gv
);

492 
	`´štf
("%s started on…ort(s) %s with web„oot [%s]\n",

493 
£rv”_Çme
, 
	`mg_g‘_İtiÚ
(
ùx
, "listening_ports"),

494 
	`mg_g‘_İtiÚ
(
ùx
, "document_root"));

495 
ex™_æag
 == 0) {

496 
	`¦“p
(1);

498 
	`´štf
("Exiting on signal %d, waiting for‡llhreadso finish...",

499 
ex™_æag
);

500 
	`fæush
(
¡dout
);

501 
	`mg_¡İ
(
ùx
);

502 
	`´štf
("%s", " done.\n");

504  
EXIT_SUCCESS
;

505 
	}
}

	@external/vpiotr-mongoose-cpp/mongcpp.cpp

12 
	~"mÚgıp.h
"

14 
	~<s¡»am
>

15 
	~<c¡ršg
>

17 
usšg
 
Çme¥aû
 
	gmÚgoo£
;

19 
M‘hodM­Gu¬d
 
	gMÚgoo£S”v”
::
m_m‘hodM­
;

21 
	g‹m¶©e
 <
şass
 
	gT
>

22 
šlše
 
	g¡d
::
¡ršg
 
	$toSŒšg
 (cÚ¡ 
T
& 
t
)

24 
¡d
::
¡ršg¡»am
 
ss
;

25 
ss
 << 
t
;

26  
ss
.
	`¡r
();

27 
	}
}

29 
šlše
 
¡ršgToUIÁDef
(cÚ¡ 
¡d
::
¡ršg
 &
¡r
, 
defV®
)

31 
usšg
 
Çme¥aû
 
	g¡d
;

32 
	g»s
;

33 
i¡ršg¡»am
 
cSŒ—m
(
¡r
);

34 ià(!(
	gcSŒ—m
 >> 
	g»s
)) {

35 
	g»s
 = 
defV®
;

37  
	g»s
;

40 
	gMÚgoo£CÚÃùiÚ
::
	$MÚgoo£CÚÃùiÚ
(
mg_cÚÃùiÚ
 *
cÚn
): 
	$m_cÚn
(
cÚn
)

42 
	}
}

44 
MÚgoo£CÚÃùiÚ
::~
	$MÚgoo£CÚÃùiÚ
()

46 
	}
}

48 
MÚgoo£CÚÃùiÚ
::
	$wr™e
(cÚ¡ *
buf
, 
size_t
 
Ën
)

50  
	`mg_wr™e
(
m_cÚn
, 
buf
, 
Ën
);

51 
	}
}

53 
	gMÚgoo£CÚÃùiÚ
::
wr™e
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
)

55  
wr™e
(
‹xt
.
c_¡r
(),ext.
Ëngth
());

58 
	gMÚgoo£CÚÃùiÚ
::
	$»ad
(*
buf
, 
size_t
 
Ën
)

60  
	`mg_»ad
(
m_cÚn
, 
buf
, 
Ën
);

61 
	}
}

63 
	gMÚgoo£CÚÃùiÚ
::
£ndAuthÜiz©iÚReque¡
(cÚ¡ 
¡d
::
¡ršg
 &
nÚû
)

65 ià(
nÚû
.
em±y
())

66 
mg_£nd_authÜiz©iÚ_»que¡
(
m_cÚn
, 
NULL
);

68 
mg_£nd_authÜiz©iÚ_»que¡
(
m_cÚn
, 
nÚû
.
c_¡r
());

71 
boŞ
 
	gMÚgoo£CÚÃùiÚ
::
g‘H—d”
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
ouut
) const

73 cÚ¡ *
v®ue
 = 
mg_g‘_h—d”
(
m_cÚn
, 
Çme
.
c_¡r
());

74 ià(
	gv®ue
 !ğ
NULL
)

76 
ouut
 = 
¡d
::
¡ršg
(
v®ue
);

77  
	gŒue
;

79 
	gouut
 = "";

80  
	gçl£
;

84 
boŞ
 
	gMÚgoo£CÚÃùiÚ
::
g‘Cook›
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
ouut
) const

86 cÚ¡ 
BUF_LEN
 = 4096;

87 
	gbufãr
[
BUF_LEN
];

89 
	g»adCÁ
 = 
mg_g‘_cook›
(
m_cÚn
, 
Çme
.
c_¡r
(), 
bufãr
, 
BUF_LEN
 - 1);

91 ià(
	g»adCÁ
 >= 0) {

92 
bufãr
[
BUF_LEN
 - 1] = '\0';

93 
	gouut
 = 
bufãr
;

94  
	gŒue
;

96 
	gouut
 = "";

97  
	gçl£
;

101 
mg_cÚÃùiÚ
 *
	gMÚgoo£CÚÃùiÚ
::
	$g‘Info
()

103  
m_cÚn
;

104 
	}
}

107 
	gMÚgoo£Reque¡
::
	$MÚgoo£Reque¡
(
mg_cÚÃùiÚ
 *
cÚn
, 
mg_»que¡_šfo
* 
šfo
):

108 
	`m_cÚn
(
cÚn
), 
	$m_šfo
(
šfo
)

110 
	}
}

112 
	gMÚgoo£Reque¡
::~
	$MÚgoo£Reque¡
()

114 
	}
}

116 cÚ¡ 
¡d
::
¡ršg
 
MÚgoo£Reque¡
::
	$g‘Reque¡M‘hod
() const

118  
¡d
::
	`¡ršg
(
m_šfo
->
»que¡_m‘hod
);

119 
	}
}

121 
MÚgoo£Reque¡M‘hodCode
 
	gMÚgoo£Reque¡
::
	$g‘Reque¡M‘hodCode
() const

124  
MÚgoo£S”v”
::
	`m‘hodTextToCode
(
	`g‘Reque¡M‘hod
());

125 
	}
}

127 cÚ¡ 
	g¡d
::
¡ršg
 
MÚgoo£Reque¡
::
	$g‘Uri
() const

129  
¡d
::
	`¡ršg
(
m_šfo
->
uri
);

130 
	}
}

132 cÚ¡ 
	g¡d
::
¡ršg
 
MÚgoo£Reque¡
::
	$g‘H‰pV”siÚ
() const

134  
¡d
::
	`¡ršg
(
m_šfo
->
h‰p_v”siÚ
);

135 
	}
}

138 cÚ¡ 
	g¡d
::
¡ršg
 
MÚgoo£Reque¡
::
	$g‘Qu”ySŒšg
() const

140 ià(
m_šfo
->
qu”y_¡ršg
 !ğ
NULL
)

141  
¡d
::
	`¡ršg
(
m_šfo
->
qu”y_¡ršg
);

144 
	}
}

147 cÚ¡ 
	g¡d
::
¡ršg
 
MÚgoo£Reque¡
::
	$»adQu”ySŒšg
() const

149 cÚ¡ *
ş
 = 
	`mg_g‘_h—d”
(
m_cÚn
, "Content-Length");

150 
size_t
 
buf_Ën
;

151 ià(
ş
 !ğ
NULL
)

152 
buf_Ën
 = 
	`¡ršgToUIÁDef
(
¡d
::
	`¡ršg
(
ş
), 0);

154 
buf_Ën
 = 0;

156 
¡d
::
¡ršg
 
»s
;

158 ià(
buf_Ën
 > 0)

160 *
buf
 = 
Ãw
 [
buf_Ën
+1];

164 ià(
buf_Ën
 > 2) {

165 
	`mg_»ad
(
m_cÚn
, 
buf
, 2);

166 
	`mg_»ad
(
m_cÚn
, 
buf
 + 2, 
buf_Ën
 - 2);

168 
	`mg_»ad
(
m_cÚn
, 
buf
, 
buf_Ën
);

171 
buf
[
buf_Ën
] = '\0';

172 
»s
 = 
¡d
::
	`¡ršg
(
buf
);

173 
d–‘e
[] 
buf
;

176  
»s
;

177 
	}
}

179 cÚ¡ 
	g¡d
::
¡ršg
 
MÚgoo£Reque¡
::
	$g‘RemÙeU£r
() const

181  
¡d
::
	`¡ršg
(
m_šfo
->
»mÙe_u£r
);

182 
	}
}

184 cÚ¡ 
	g¡d
::
¡ršg
 
MÚgoo£Reque¡
::
	$g‘LogMes§ge
() const

186  
¡d
::
	`¡ršg
(
m_šfo
->
log_mes§ge
);

187 
	}
}

189 
	gMÚgoo£Reque¡
::
	$g‘RemÙeIp
() const

191  
m_šfo
->
»mÙe_
;

192 
	}
}

194 
	gMÚgoo£Reque¡
::
	$g‘RemÙePÜt
() const

196  
m_šfo
->
»mÙe_pÜt
;

197 
	}
}

199 
	gMÚgoo£Reque¡
::
	$g‘StusCode
() const

201  
m_šfo
->
¡©us_code
;

202 
	}
}

204 
boŞ
 
	gMÚgoo£Reque¡
::
	$isS¦
() const

206  (
m_šfo
->
is_s¦
 > 0);

207 
	}
}

209 
mg_»que¡_šfo
* 
	gMÚgoo£Reque¡
::
	$g‘Info
() const

211  
m_šfo
;

212 
	}
}

214 
boŞ
 
	gMÚgoo£Reque¡
::
g‘V¬
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
ouut
) const

216 cÚ¡ 
MAX_VAR_LEN
 = 4096;

217 
	gbufãr
[
MAX_VAR_LEN
];

218 cÚ¡ *
	gqs
 = 
m_šfo
->
qu”y_¡ršg
;

219 
	g»adCÁ
 = 
mg_g‘_v¬
(
qs
, 
¡¾’
(q =ğ
NULL
 ? "" : qs), 
Çme
.
c_¡r
(), 
bufãr
, 
MAX_VAR_LEN
 - 1);

220 ià(
	g»adCÁ
 >= 0) {

221 
bufãr
[
MAX_VAR_LEN
 - 1] = '\0';

222 
	gouut
 = 
bufãr
;

223  
	gŒue
;

225 
	gouut
.
ş—r
();

226  
	gçl£
;

231 
	gMÚgoo£Re¥Ú£
::
	$MÚgoo£Re¥Ú£
(
mg_cÚÃùiÚ
 *
cÚn
): 
	$m_cÚn
(
cÚn
)

233 
	}
}

235 
MÚgoo£Re¥Ú£
::~
	$MÚgoo£Re¥Ú£
()

237 
	}
}

239 
MÚgoo£Re¥Ú£
::
	$wr™e
()

241 
	`mg_wr™e
(
m_cÚn
, 
m_‹xt
.
	`c_¡r
(), m_‹xt.
	`Ëngth
());

242 
m_‹xt
.
	`ş—r
();

243 
	}
}

245 cÚ¡ *
	gMÚgoo£Re¥Ú£
::
	$g‘H‰pStusDesc
(
¡©usCode
)

247 cÚ¡ *
»s
;

249 
¡©usCode
) {

250 100: 
»s
 = "Continue";

252 101: 
»s
 = "Switching Protocols";

255 200: 
»s
 = "OK";

257 201: 
»s
 = "Created";

259 202: 
»s
 = "Accepted";

261 203: 
»s
 = "Non-Authoritative Information";

263 204: 
»s
 = "No Content";

265 205: 
»s
 = "Reset Content";

267 206: 
»s
 = "Partial Content";

270 300: 
»s
 = "Multiple Choices";

272 301: 
»s
 = "Moved Permanently";

274 302: 
»s
 = "Found";

276 303: 
»s
 = "See Other";

278 304: 
»s
 = "Not Modified";

280 305: 
»s
 = "Use Proxy";

282 306: 
»s
 = "Switch Proxy";

284 307: 
»s
 = "Temporary Redirect";

287 400: 
»s
 = "Bad Request";

289 401: 
»s
 = "Unauthorized";

291 402: 
»s
 = "Payment Required";

293 403: 
»s
 = "Forbidden";

295 404: 
»s
 = "Not Found";

297 405: 
»s
 = "Method Not Allowed";

299 406: 
»s
 = "Not Acceptable";

301 407: 
»s
 = "Proxy Authentication Required";

303 408: 
»s
 = "Request Timeout";

305 409: 
»s
 = "Conflict";

307 410: 
»s
 = "Gone";

309 411: 
»s
 = "Length Required";

311 412: 
»s
 = "Precondition Failed";

313 413: 
»s
 = "Request Entity Too Large";

315 414: 
»s
 = "Request-URI Too Long";

317 415: 
»s
 = "Unsupported Media Type";

319 416: 
»s
 = "Requested Range Not Satisfiable";

321 417: 
»s
 = "Expectation Failed";

324 500: 
»s
 = "Internal Server Error";

326 501: 
»s
 = "Not Implemented";

328 502: 
»s
 = "Bad Gateway";

330 503: 
»s
 = "Service Unavailable";

332 504: 
»s
 = "Gateway Timeout";

334 505: 
»s
 = "HTTP Version Not Supported";

337 
»s
 = "";

340  
»s
;

341 
	}
}

343 
	gMÚgoo£Re¥Ú£
::
£tStus
(
code
, cÚ¡ 
¡d
::
¡ršg
 &
¡©usDesc
, cÚ¡ std::¡ršg &
h‰pV”
)

345 cÚ¡ *
»®StusDesc
 = 
NULL
;

346 cÚ¡ *
	g»®H‰pV”
 = 
NULL
;

348 ià(!
	gh‰pV”
.
em±y
()) {

349 
	g»®H‰pV”
 = 
h‰pV”
.
c_¡r
();

352 
	g»®H‰pV”
 = "HTTP/1.1";

355 ià(!
	g¡©usDesc
.
em±y
()) {

356 
	g»®StusDesc
 = 
¡©usDesc
.
c_¡r
();

358 
	g»®StusDesc
 = 
MÚgoo£Re¥Ú£
::
g‘H‰pStusDesc
(
code
);

361 
	g¡d
::
¡ršg
 
ouut
 = 
¡d
::¡ršg(
»®H‰pV”
è+ " " + 
toSŒšg
(
code
è+ " " + std::¡ršg(
»®StusDesc
);

362 
	gm_¡©usText
.
»£t
(
Ãw
 
¡d
::
¡ršg
(
ouut
));

365 
	gMÚgoo£Re¥Ú£
::
£tS‘Cook›
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ std::¡ršg &
v®ue
)

367 
£tH—d”V®ue
("S‘-Cook›", 
Çme
+"="+
v®ue
);

370 
	gMÚgoo£Re¥Ú£
::
£tLoÿtiÚ
(cÚ¡ 
¡d
::
¡ršg
 &
v®ue
)

372 
£tH—d”V®ue
("LoÿtiÚ", 
v®ue
);

375 
	gMÚgoo£Re¥Ú£
::
£tCÚ‹ÁTy³
(cÚ¡ 
¡d
::
¡ršg
 &
v®ue
)

377 ià(
v®ue
.
em±y
())

378 
£tH—d”V®ue
("Content-type", "text/html");

380 
£tH—d”V®ue
("CÚ‹Á-ty³", 
v®ue
);

383 
boŞ
 
	gMÚgoo£Re¥Ú£
::
g‘H—d”V®ue
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
ouut
)

385 
´•¬eH—d”V®ues
();

387 
	gRe¥Ú£V®ueIndex
::
cÚ¡_™”©Ü
 
c™
 = 
m_h—d”V®uesIndex
->
fšd
(
Çme
);

388 
boŞ
 
	g»s
 = 
çl£
;

390 ià(
	gc™
 !ğ
m_h—d”V®uesIndex
->
’d
()) {

391 
idx
 = 
c™
->
£cÚd
;

392 
	gouut
 = (*
m_h—d”V®ues
)[
idx
].
£cÚd
;

393 
	g»s
 = 
Œue
;

395 
	gouut
.
ş—r
();

398  
	g»s
;

402 
	gMÚgoo£Re¥Ú£
::
addH—d”V®ue
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ std::¡ršg &
v®ue
)

404 
´•¬eH—d”V®ues
();

406 
	gidx
 = 
m_h—d”V®ues
->
size
();

408 
	gRe¥Ú£V®ueIndex
::
™”©Ü
 
c™
 = 
m_h—d”V®uesIndex
->
fšd
(
Çme
);

409 ià(
	gc™
 !ğ
m_h—d”V®uesIndex
->
’d
()) {

410 
c™
->
£cÚd
 = 
idx
;

412 
	gm_h—d”V®uesIndex
->
š£¹
(
¡d
::
make_·œ
<¡d::
¡ršg
, >(
Çme
, 
idx
));

415 
	gm_h—d”V®ues
->
push_back
(
¡d
::
make_·œ
<¡d::
¡ršg
, std::¡ršg>(
Çme
, 
v®ue
));

418 
	gMÚgoo£Re¥Ú£
::
£tH—d”V®ue
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ std::¡ršg &
v®ue
)

420 
´•¬eH—d”V®ues
();

421 
	gRe¥Ú£V®ueIndex
::
cÚ¡_™”©Ü
 
c™
 = 
m_h—d”V®uesIndex
->
fšd
(
Çme
);

422 ià(
	gc™
 !ğ
m_h—d”V®uesIndex
->
’d
()) {

423 
idx
 = 
c™
->
£cÚd
;

424 (*
	gm_h—d”V®ues
)[
idx
].
	g£cÚd
 = 
v®ue
;

426 
	gidx
 = 
m_h—d”V®ues
->
size
();

427 
	gm_h—d”V®uesIndex
->
š£¹
(
¡d
::
make_·œ
<¡d::
¡ršg
, >(
Çme
, 
idx
));

428 
	gm_h—d”V®ues
->
push_back
(
¡d
::
make_·œ
<¡d::
¡ršg
, std::¡ršg>(
Çme
, 
v®ue
));

432 
	gMÚgoo£Re¥Ú£
::
addCÚ‹Á
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
, 
boŞ
 
addL’
)

434 ià(
	gaddL’
) {

435 
£tH—d”V®ue
("CÚ‹Á-Ëngth", 
toSŒšg
(
‹xt
.
Ëngth
()));

436 
addH—d”
();

437 
addTextLše
("");

438 
addText
(
‹xt
);

440 
addH—d”
();

441 
addText
(
‹xt
);

445 
	gMÚgoo£Re¥Ú£
::
	$£tCÚÃùiÚAlive
(
boŞ
 
k“pAlive
)

447 ià(
k“pAlive
)

448 
	`£tH—d”V®ue
("Connection", "Keep-Alive");

450 
	`£tH—d”V®ue
("Connection", "close");

451 
	}
}

453 
	gMÚgoo£Re¥Ú£
::
	$£tCacheDi§bËd
()

455 
	`£tH—d”V®ue
("Cache-Control", "no-cache, must-revalidate");

456 
	`£tH—d”V®ue
("Expires", "Sat, 26 Jul 1997 05:00:00 GMT");

457 
	}
}

459 
	gMÚgoo£Re¥Ú£
::
	$addH—d”
()

461 ià(
m_¡©usText
.
	`g‘
(è!ğ
NULL
) {

462 
	`addTextLše
(*
m_¡©usText
);

463 
m_¡©usText
.
	`»£t
();

466 ià(
m_h—d”V®ues
.
	`g‘
(è!ğ
NULL
) {

467 
Re¥Ú£V®ueLi¡
::
cÚ¡_™”©Ü
 
c™
 = 
m_h—d”V®ues
->
	`begš
(), 
•os
 = m_h—d”V®ues->
	`’d
(); cit !=ƒpos; ++cit)

469 
	`addH—d”V®ueToText
(
c™
->
fœ¡
, c™->
£cÚd
);

473 
m_h—d”V®ues
.
	`»£t
();

474 
m_h—d”V®uesIndex
.
	`»£t
();

475 
	}
}

477 
	gMÚgoo£Re¥Ú£
::
addH—d”V®ueToText
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ std::¡ršg &
v®ue
)

479 
addTextLše
(
Çme
 + 
¡d
::
¡ršg
(": "è+ 
v®ue
);

482 
	gMÚgoo£Re¥Ú£
::
addText
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
)

484 
m_‹xt
 +ğ
‹xt
;

487 
	gMÚgoo£Re¥Ú£
::
addTextLše
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
)

489 
addText
(
‹xt
+
¡d
::
¡ršg
("\r\n"));

492 
Re¥Ú£V®ueLi¡
 *
	gMÚgoo£Re¥Ú£
::
	$´•¬eH—d”V®ues
()

494 ià(
m_h—d”V®ues
.
	`g‘
(è=ğ
NULL
) {

495 
m_h—d”V®ues
.
	`»£t
(
Ãw
 
Re¥Ú£V®ueLi¡
);

496 
m_h—d”V®uesIndex
.
	`»£t
(
Ãw
 
Re¥Ú£V®ueIndex
);

499  
m_h—d”V®ues
.
	`g‘
();

500 
	}
}

503 *
	$LoÿlMÚgoo£Ev’tHªdËr
(
mg_ev’t
 
ev’tCode
,

504 
mg_cÚÃùiÚ
 *
cÚn
,

505 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
)

507 
MÚgoo£S”v”
* 
£rv”
 = (MÚgoo£S”v”* )
	`mg_»ad_u£r_d©a
(
cÚn
);

508  
£rv”
->
	`hªdËEv’t
(
ev’tCode
, 
cÚn
, 
»que¡_šfo
);

509 
	}
}

512 
	gMÚgoo£S”v”
::
	$MÚgoo£S”v”
(): 
	`m_¡©usRuÂšg
(
çl£
), 
	`m_´•¬ed
(çl£), 
	$m_ùx
(
NULL
)

514 
	}
}

516 
	gMÚgoo£S”v”
::~
	$MÚgoo£S”v”
()

518 
	`checkStİ³d
();

519 
	}
}

522 
	gMÚgoo£S”v”
::
	$£tO±iÚs
(cÚ¡ 
S”v”O±iÚS‘
 &
İtiÚs
)

524 
m_İtiÚs
 = 
İtiÚs
;

525 
	}
}

527 
	gMÚgoo£S”v”
::
£tO±iÚ
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ std::¡ršg &
v®ue
)

529 
m_İtiÚs
[
Çme
] = 
v®ue
;

532 
	gMÚgoo£S”v”
::
	$g‘O±iÚs
(
S”v”O±iÚS‘
 &
İtiÚs
) const

534 
İtiÚs
 = 
m_İtiÚs
;

535 
	}
}

537 
boŞ
 
	gMÚgoo£S”v”
::
g‘O±iÚV®ue
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
v®ue
) const

539 
S”v”O±iÚS‘
::
cÚ¡_™”©Ü
 
c™”
 = 
m_İtiÚs
.
fšd
(
Çme
);

540 ià(
	gc™”
 !ğ
m_İtiÚs
.
’d
()) {

541 
v®ue
 = 
c™”
->
£cÚd
;

542  
	gŒue
;

544 
	gv®ue
 = "";

545  
	gçl£
;

549 
	gMÚgoo£S”v”
::
g‘O±iÚV®ue
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
v®ue
, cÚ¡ std::¡ršg &
defV®ue
) const

551 
boŞ
 
found
 = 
g‘O±iÚV®ue
(
Çme
, 
v®ue
);

552 ià(!
	gfound
) {

553 
	gv®ue
 = 
defV®ue
;

557 
	gMÚgoo£S”v”
::
	$g‘V®idO±iÚs
(
S”v”O±iÚLi¡
 &
ouut
)

559 cÚ¡ **
Çmes
;

560 cÚ¡ 
SEP_CHAR
 = ';';

562 
Çmes
 = 
	`mg_g‘_v®id_İtiÚ_Çmes
();

564 
i
 = 0; 
Çmes
[i] !ğ
NULL
; i += 3) {

565 
ouut
.
	`push_back
(

566 
¡d
::
	`¡ršg
(
Çmes
[
i
]è+ 
SEP_CHAR
 +

567 
¡d
::
	`¡ršg
(
Çmes
[
i
] + 1è+ 
SEP_CHAR
 +

568 
¡d
::
	`¡ršg
(
Çmes
[
i
 + 2] =ğ
NULL
 ? "" :‚ames[i + 2])

571 
	}
}

573 
	g¡d
::
¡ršg
 
MÚgoo£S”v”
::
	$g‘V”siÚ
()

575  
¡d
::
	`¡ršg
(
	`mg_v”siÚ
());

576 
	}
}

578 
	gMÚgoo£S”v”
::
ÿlcMD5
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
, std::¡ršg &
ouut
)

580 
buf
[33];

581 
mg_md5
(
buf
, 
‹xt
.
c_¡r
());

582 
	gouut
 = 
buf
;

586 
	gMÚgoo£S”v”
::
	$š™
()

588 
	`checkM‘hodM­
();

589 
	}
}

591 
	gMÚgoo£S”v”
::
	$¡¬t
()

593 ià(!
m_´•¬ed
) {

594 
	`š™
();

595 
m_´•¬ed
 = 
Œue
;

598 
	`checkStİ³d
();

600 
m_ùx
 = 
	`mg_¡¬t
(
LoÿlMÚgoo£Ev’tHªdËr
, (*è
this
, 
	`´•¬eO±iÚs
());

601 
m_¡©usRuÂšg
 = 
Œue
;

602 
	}
}

604 
	gMÚgoo£S”v”
::
	$¡İ
()

606 ià(!
	`isRuÂšg
())

608 
	`mg_¡İ
(
m_ùx
);

609 
	`uÅ»·»O±iÚs
();

610 
m_ùx
 = 
NULL
;

611 
m_¡©usRuÂšg
 = 
çl£
;

612 
	}
}

614 
boŞ
 
	gMÚgoo£S”v”
::
	$isRuÂšg
()

616  
m_¡©usRuÂšg
;

617 
	}
}

620 #´agm¨
w¬nšg
Ğ
di§bË
 : 4716 )

621 #´agm¨
w¬nšg
Ğ
di§bË
 : 4100 )

622 
boŞ
 
	gMÚgoo£S”v”
::
	$hªdËEv’t
(
S”v”HªdlšgEv’t
 
ev’tCode
, 
MÚgoo£CÚÃùiÚ
 &
cÚÃùiÚ
, cÚ¡ 
MÚgoo£Reque¡
 &
»que¡
, 
MÚgoo£Re¥Ú£
 &
»¥Ú£
)

624  
NULL
;

625 
	}
}

627 *
	gMÚgoo£S”v”
::
	$hªdËEv’t
(
S”v”HªdlšgEv’t
 
ev’tCode
,

628 
mg_cÚÃùiÚ
 *
cÚn
,

629 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
)

631 *
´oûs£d
 = 
»š‹½»t_ÿ¡
<*> (
cÚ¡_ÿ¡
<*>("yes"));

632 
¡d
::
auto_±r
<
MÚgoo£CÚÃùiÚ
> 
	`cÚÃùiÚ
(
	`ÃwCÚÃùiÚ
(
cÚn
));

633 
¡d
::
auto_±r
<
MÚgoo£Reque¡
> 
	`»que¡
(
	`ÃwReque¡
(
cÚn
, 
»que¡_šfo
));

634 
¡d
::
auto_±r
<
MÚgoo£Re¥Ú£
> 
	`»¥Ú£
(
	`ÃwRe¥Ú£
(
cÚn
));

636 ià(
	`hªdËEv’t
(
ev’tCode
, *
cÚÃùiÚ
, *
»que¡
, *
»¥Ú£
))

637  
´oûs£d
;

639  
NULL
;

640 
	}
}

642 
MÚgoo£CÚÃùiÚ
 *
	gMÚgoo£S”v”
::
	$ÃwCÚÃùiÚ
(
mg_cÚÃùiÚ
 *
cÚn
)

644  
Ãw
 
	`MÚgoo£CÚÃùiÚ
(
cÚn
);

645 
	}
}

647 
MÚgoo£Reque¡
 *
	gMÚgoo£S”v”
::
	$ÃwReque¡
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ 
mg_»que¡_šfo
 *
»que¡
)

649  
Ãw
 
	`MÚgoo£Reque¡
(
cÚn
, 
cÚ¡_ÿ¡
<
mg_»que¡_šfo
 *>(
»que¡
));

650 
	}
}

652 
MÚgoo£Re¥Ú£
 *
	gMÚgoo£S”v”
::
	$ÃwRe¥Ú£
(
mg_cÚÃùiÚ
 *
cÚn
)

654  
Ãw
 
	`MÚgoo£Re¥Ú£
(
cÚn
);

655 
	}
}

657 
	gMÚgoo£S”v”
::
	$checkStİ³d
()

659 ià(
m_¡©usRuÂšg
)

660 
	`¡İ
();

661 
	}
}

663 cÚ¡ **
	gMÚgoo£S”v”
::
	$´•¬eO±iÚs
()

665 
	`uÅ»·»O±iÚs
();

666 
S”v”O±iÚS‘
::
cÚ¡_™”©Ü
 
c™
 = 
m_İtiÚs
.
	`begš
(), 
•os
 = m_İtiÚs.
	`’d
(); cit !=ƒpos; ++cit)

668 
m_İtiÚStÜage
.
	`push_back
(
c™
->
fœ¡
.
	`c_¡r
());

669 
m_İtiÚStÜage
.
	`push_back
(
c™
->
£cÚd
.
	`c_¡r
());

671 
m_İtiÚStÜage
.
	`push_back
(
NULL
);

672  &(*
m_İtiÚStÜage
.
	`begš
());

673 
	}
}

675 
	gMÚgoo£S”v”
::
	$uÅ»·»O±iÚs
()

677 
m_İtiÚStÜage
.
	`ş—r
();

678 
	}
}

680 
	gMÚgoo£S”v”
::
	$checkM‘hodM­
()

682 ià(
m_m‘hodM­
.
	`g‘
(è=ğ
NULL
)

684 
m_m‘hodM­
.
	`»£t
(
Ãw
 
M‘hodM­
);

686 
m_m‘hodM­
->
	`š£¹
(
¡d
::
	`make_·œ
("GET", 
rmcG‘
));

687 
m_m‘hodM­
->
	`š£¹
(
¡d
::
	`make_·œ
("POST", 
rmcPo¡
));

688 
m_m‘hodM­
->
	`š£¹
(
¡d
::
	`make_·œ
("HEAD", 
rmcH—d
));

689 
m_m‘hodM­
->
	`š£¹
(
¡d
::
	`make_·œ
("PUT", 
rmcPut
));

690 
m_m‘hodM­
->
	`š£¹
(
¡d
::
	`make_·œ
("DELETE", 
rmcD–‘e
));

691 
m_m‘hodM­
->
	`š£¹
(
¡d
::
	`make_·œ
("TRACE", 
rmcT¿û
));

692 
m_m‘hodM­
->
	`š£¹
(
¡d
::
	`make_·œ
("OPTIONS", 
rmcO±iÚs
));

694 
	}
}

696 
MÚgoo£Reque¡M‘hodCode
 
	gMÚgoo£S”v”
::
m‘hodTextToCode
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
)

698 
M‘hodM­
::
cÚ¡_™”©Ü
 
c™
 = 
m_m‘hodM­
->
fšd
(
‹xt
);

699 ià(
	gc™
 =ğ
m_m‘hodM­
->
’d
())

700  
rmcUndef
;

702  
	gc™
->
	g£cÚd
;

	@external/vpiotr-mongoose-cpp/mongcpp.h

12 #iâdeà
_MONGCPP_H__


13 
	#_MONGCPP_H__


	)

25 
	~<c¡ddef
>

26 
	~<c¡dlib
>

28 
	~"mÚgoo£.h
"

30 
	~<¡ršg
>

31 
	~<m­
>

32 
	~<veùÜ
>

33 
	~<memÜy
>

35 
Çme¥aû
 
	gmÚgoo£


41 
	eMÚgoo£Reque¡M‘hodCode
 {

42 
	grmcUndef
,

43 
	grmcG‘
,

44 
	grmcPo¡
,

45 
	grmcH—d
,

46 
	grmcPut
,

47 
	grmcD–‘e
,

48 
	grmcT¿û
,

49 
	grmcO±iÚs


52 
	g¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, std::¡ršg> 
	tS”v”O±iÚS‘
;

53 
	g¡d
::
	tveùÜ
<
	t¡d
::
	t¡ršg
> 
	tS”v”O±iÚLi¡
;

54 
	g¡d
::
	tveùÜ
<cÚ¡ *> 
	tS”v”O±iÚStÜage
;

55 
	g¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, std::¡ršg> 
	tReque¡V®ueS‘
;

56 
	g¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, > 
	tRe¥Ú£V®ueIndex
;

57 
	g¡d
::
	tveùÜ
< 
	t¡d
::
	t·œ
<¡d::
	t¡ršg
, std::¡ršg> > 
	tRe¥Ú£V®ueLi¡
;

58 
mg_ev’t
 
	tS”v”HªdlšgEv’t
;

59 
	g¡d
::
	tm­
<
	t¡d
::
	t¡ršg
, 
	tMÚgoo£Reque¡M‘hodCode
> 
	tM‘hodM­
;

60 
	g¡d
::
	tauto_±r
<
	tM‘hodM­
> 
	tM‘hodM­Gu¬d
;

74 şas 
	cMÚgoo£CÚÃùiÚ
 {

75 
	gpublic
:

76 
MÚgoo£CÚÃùiÚ
(
mg_cÚÃùiÚ
 *
cÚn
);

77 
	gvœtu®
 ~
MÚgoo£CÚÃùiÚ
();

78 
wr™e
(cÚ¡ *
buf
, 
size_t
 
Ën
);

79 
wr™e
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
);

80 
»ad
(*
buf
, 
size_t
 
Ën
);

81 
£ndAuthÜiz©iÚReque¡
(cÚ¡ 
¡d
::
¡ršg
 &
nÚû
 = "");

82 
boŞ
 
g‘H—d”
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
ouut
) const;

83 
boŞ
 
g‘Cook›
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
ouut
) const;

84 
	g´Ùeùed
:

85 
mg_cÚÃùiÚ
 *
g‘Info
();

86 
	g´Ùeùed
:

87 
mg_cÚÃùiÚ
 *
m_cÚn
;

90 şas 
	cMÚgoo£Reque¡
 {

91 
	gpublic
:

92 
MÚgoo£Reque¡
(
mg_cÚÃùiÚ
 *
cÚn
, 
mg_»que¡_šfo
* 
šfo
);

93 
	gvœtu®
 ~
MÚgoo£Reque¡
();

94 cÚ¡ 
	g¡d
::
¡ršg
 
g‘Reque¡M‘hod
() const;

95 
MÚgoo£Reque¡M‘hodCode
 
g‘Reque¡M‘hodCode
() const;

96 cÚ¡ 
	g¡d
::
¡ršg
 
g‘Uri
() const;

97 cÚ¡ 
	g¡d
::
¡ršg
 
g‘H‰pV”siÚ
() const;

98 cÚ¡ 
	g¡d
::
¡ršg
 
g‘Qu”ySŒšg
() const;

99 cÚ¡ 
	g¡d
::
¡ršg
 
»adQu”ySŒšg
() const;

100 cÚ¡ 
	g¡d
::
¡ršg
 
g‘RemÙeU£r
() const;

101 cÚ¡ 
	g¡d
::
¡ršg
 
g‘LogMes§ge
() const;

102 
g‘RemÙeIp
() const;

103 
g‘RemÙePÜt
() const;

104 
g‘StusCode
() const;

105 
boŞ
 
isS¦
() const;

106 
boŞ
 
g‘V¬
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
ouut
) const;

107 
MÚgoo£Reque¡M‘hodCode
 
m‘hodTextToCode
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
);

108 
	g´Ùeùed
:

109 
mg_»que¡_šfo
* 
g‘Info
() const;

110 
	g´Ùeùed
:

111 
mg_»que¡_šfo
* 
m_šfo
;

112 
mg_cÚÃùiÚ
 *
	gm_cÚn
;

115 şas 
	cMÚgoo£Re¥Ú£
 {

116 
	gpublic
:

117 
MÚgoo£Re¥Ú£
(
mg_cÚÃùiÚ
 *
cÚn
);

118 
	gvœtu®
 ~
MÚgoo£Re¥Ú£
();

119 
vœtu®
 
wr™e
();

120 
£tStus
(
code
, cÚ¡ 
¡d
::
¡ršg
 &
¡©usDesc
 = "", cÚ¡ std::¡ršg &
h‰pV”
 = "");

121 
£tS‘Cook›
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ std::¡ršg &
v®ue
);

122 
£tLoÿtiÚ
(cÚ¡ 
¡d
::
¡ršg
 &
v®ue
 = "");

123 
£tCÚ‹ÁTy³
(cÚ¡ 
¡d
::
¡ršg
 &
v®ue
 = "");

124 
boŞ
 
g‘H—d”V®ue
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
ouut
);

125 
addH—d”V®ue
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ std::¡ršg &
v®ue
);

126 
£tH—d”V®ue
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ std::¡ršg &
v®ue
);

127 
£tCÚÃùiÚAlive
(
boŞ
 
k“pAlive
 = 
çl£
);

128 
£tCacheDi§bËd
();

129 
addH—d”
();

130 
addCÚ‹Á
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
, 
boŞ
 
addL’
 = 
Œue
);

131 
addText
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
);

132 
addTextLše
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
);

133 cÚ¡ *
g‘H‰pStusDesc
(
¡©usCode
);

134 
	g´Ùeùed
:

135 
Re¥Ú£V®ueLi¡
 *
´•¬eH—d”V®ues
();

136 
addH—d”V®ueToText
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ std::¡ršg &
v®ue
);

137 
	g´Ùeùed
:

138 
mg_cÚÃùiÚ
 *
m_cÚn
;

139 
	g¡d
::
¡ršg
 
m_‹xt
;

140 
	g¡d
::
auto_±r
<
Re¥Ú£V®ueLi¡
> 
m_h—d”V®ues
;

141 
	g¡d
::
auto_±r
<
Re¥Ú£V®ueIndex
> 
m_h—d”V®uesIndex
;

142 
	g¡d
::
auto_±r
<
¡d
::
¡ršg
> 
m_¡©usText
;

145 şas 
	cMÚgoo£S”v”
 {

146 
	gpublic
:

148 
MÚgoo£S”v”
();

149 
	gvœtu®
 ~
MÚgoo£S”v”
();

151 
£tO±iÚs
(cÚ¡ 
S”v”O±iÚS‘
 &
İtiÚs
);

152 
£tO±iÚ
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ std::¡ršg &
v®ue
);

153 
g‘O±iÚs
(
S”v”O±iÚS‘
 &
İtiÚs
) const;

154 
boŞ
 
g‘O±iÚV®ue
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
v®ue
) const;

155 
g‘O±iÚV®ue
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, std::¡ršg &
v®ue
, cÚ¡ std::¡ršg &
defV®ue
) const;

156 
g‘V®idO±iÚs
(
S”v”O±iÚLi¡
 &
ouut
);

157 
	g¡d
::
¡ršg
 
g‘V”siÚ
();

158 
ÿlcMD5
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
, std::¡ršg &
ouut
);

159 
MÚgoo£Reque¡M‘hodCode
 
m‘hodTextToCode
(cÚ¡ 
¡d
::
¡ršg
 &
‹xt
);

161 
vœtu®
 
š™
();

162 
¡¬t
();

163 
¡İ
();

164 
boŞ
 
isRuÂšg
();

165 
vœtu®
 *
hªdËEv’t
(
S”v”HªdlšgEv’t
 
ev’tCode
,

166 
mg_cÚÃùiÚ
 *
cÚn
,

167 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
);

168 
	g´Ùeùed
:

169 
vœtu®
 
boŞ
 
hªdËEv’t
(
S”v”HªdlšgEv’t
 
ev’tCode
, 
MÚgoo£CÚÃùiÚ
 &
cÚÃùiÚ
, cÚ¡ 
MÚgoo£Reque¡
 &
»que¡
, 
MÚgoo£Re¥Ú£
 &
»¥Ú£
);

170 
vœtu®
 
MÚgoo£CÚÃùiÚ
 *
ÃwCÚÃùiÚ
(
mg_cÚÃùiÚ
 *
cÚn
);

171 
vœtu®
 
MÚgoo£Reque¡
 *
ÃwReque¡
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ 
mg_»que¡_šfo
 *
»que¡
);

172 
vœtu®
 
MÚgoo£Re¥Ú£
 *
ÃwRe¥Ú£
(
mg_cÚÃùiÚ
 *
cÚn
);

173 
checkStİ³d
();

174 cÚ¡ **
´•¬eO±iÚs
();

175 
uÅ»·»O±iÚs
();

176 
checkM‘hodM­
();

177 
	g´Ùeùed
:

178 
S”v”O±iÚS‘
 
m_İtiÚs
;

179 
S”v”O±iÚStÜage
 
	gm_İtiÚStÜage
;

180 
boŞ
 
	gm_¡©usRuÂšg
;

181 
boŞ
 
	gm_´•¬ed
;

182 
mg_cÚ‹xt
 *
	gm_ùx
;

183 
M‘hodM­Gu¬d
 
	gm_m‘hodM­
;

	@external/vpiotr-mongoose-cpp/mongoose.c

21 #ià
defšed
(
_WIN32
)

22 
	#_CRT_SECURE_NO_WARNINGS


23 #–£

	)

24 
	#_XOPEN_SOURCE
 600

25 
	#_LARGEFILE_SOURCE


27 

	)

28 #iâdeà
_WIN32_WCE


29 
	~<sys/ty³s.h
>

30 
	~<sys/¡©.h
>

31 
	~<”ºo.h
>

32 
	~<sigÇl.h
>

33 
	~<fú.h
>

36 
	~<time.h
>

37 
	~<¡dlib.h
>

38 
	~<¡d¬g.h
>

39 
	~<as£¹.h
>

40 
	~<¡ršg.h
>

41 
	~<ùy³.h
>

42 
	~<lim™s.h
>

43 
	~<¡ddef.h
>

44 
	~<¡dio.h
>

46 #ià
defšed
(
_WIN32
)

47 
	#_WIN32_WINNT
 0x0400

48 
	~<wšdows.h
>

	)

50 #iâdeà
PATH_MAX


51 
	#PATH_MAX
 
MAX_PATH


	)

54 #iâdeà
_WIN32_WCE


55 
	~<´oûss.h
>

56 
	~<dœeù.h
>

57 
	~<io.h
>

59 
	~<wšsock2.h
>

60 
	#NO_CGI


61 

	)

62 
	toff_t
;

63 
	#BUFSIZ
 128000

	)

65 
	#”ºo
 
	`G‘La¡E¼Ü
()

	)

66 
	#¡»¼Ü
(
x
è
	`_uÉß
(x, (*è
	`_®loÿ
((xè*3 ), 10)

	)

69 
	#MAKEUQUAD
(
lo
, 
hi
è((
ušt64_t
)(((
ušt32_t
)Öo)è| \

	)

70 ((
	gušt64_t
)((
	gušt32_t
)(
	ghi
))) << 32))

71 
	#RATE_DIFF
 10000000

72 
	#EPOCH_DIFF
 
	`MAKEUQUAD
(0xd53e8000, 0x019db1de)

	)

73 
	#SYS2UNIX_TIME
(
lo
, 
hi
è\

	)

74 (
	gtime_t
è((
MAKEUQUAD
((
lo
), (
hi
)è- 
	gEPOCH_DIFF
è/ 
	gRATE_DIFF
)

79 #ià
defšed
(
_MSC_VER
) && _MSC_VER < 1300

80 
	#STRX
(
x
è#x

	)

81 
	#STR
(
x
è
	`STRX
(x)

	)

82 
	#__func__
 "lš" 
	`STR
(
__LINE__
)

	)

83 
	#¡¹ouÎ
(
x
, 
y
, 
z
è
	`¡¹oul
(x, y, z)

	)

84 
	#¡¹Şl
(
x
, 
y
, 
z
è
	`¡¹Ş
(x, y, z)

	)

86 
	#__func__
 
__FUNCTION__


	)

87 
	#¡¹ouÎ
(
x
, 
y
, 
z
è
	`_¡¹oui64
(x, y, z)

	)

88 
	#¡¹Şl
(
x
, 
y
, 
z
è
	`_¡¹oi64
(x, y, z)

	)

91 
	#ERRNO
 
	`G‘La¡E¼Ü
()

	)

92 
	#NO_SOCKLEN_T


	)

93 
	#SSL_LIB
 "s¦—y32.dÎ"

	)

94 
	#CRYPTO_LIB
 "lib—y32.dÎ"

	)

95 
	#DIRSEP
 '\\'

	)

96 
	#IS_DIRSEP_CHAR
(
c
è((cè=ğ'/' || (cè=ğ'\\')

	)

97 
	#O_NONBLOCK
 0

	)

98 #ià!
defšed
(
EWOULDBLOCK
)

99 
	#EWOULDBLOCK
 
WSAEWOULDBLOCK


	)

101 
	#_POSIX_


	)

102 
	#INT64_FMT
 "I64d"

	)

104 
	#WINCDECL
 
__cdeş


	)

105 
	#SHUT_WR
 1

	)

106 
	#¢´štf
 
_¢´štf


	)

107 
	#v¢´štf
 
_v¢´štf


	)

108 
	#¦“p
(
x
è
	`SË•
((xè* 1000)

	)

110 
	#pe
(
x
è
	`_pe
(x, 
BUFSIZ
, 
_O_BINARY
)

	)

111 
	#pİ’
(
x
, 
y
è
	`_pİ’
(x, y)

	)

112 
	#pşo£
(
x
è
	`_pşo£
(x)

	)

113 
	#şo£
(
x
è
	`_şo£
(x)

	)

114 
	#dlsym
(
x
,
y
è
	`G‘ProcAdd»ss
((
HINSTANCE
è(x), (y))

	)

115 
	#RTLD_LAZY
 0

	)

116 
	#f£eko
(
x
, 
y
, 
z
è
	`f£ek
((x), (y), (z))

	)

117 
	#fdİ’
(
x
, 
y
è
	`_fdİ’
((x), (y))

	)

118 
	#wr™e
(
x
, 
y
, 
z
è
	`_wr™e
((x), (y), (èz)

	)

119 
	#»ad
(
x
, 
y
, 
z
è
	`_»ad
((x), (y), (èz)

	)

120 
	#æockfe
(
x
è(è0

	)

121 
	#fuÆockfe
(
x
è(è0

	)

123 #ià!
defšed
(
f’o
)

124 
	#f’o
(
x
è
	`_f’o
(x)

	)

127 
HANDLE
 
	t±h»ad_mu‹x_t
;

128 ¡ruù {
HANDLE
 
	msigÇl
, 
	mbrßdÿ¡
;} 
	t±h»ad_cÚd_t
;

129 
DWORD
 
	t±h»ad_t
;

130 
	#pid_t
 
HANDLE


131 

	)

132 
	stime¥ec
 {

133 
	mtv_n£c
;

134 
	mtv_£c
;

137 
±h»ad_mu‹x_lock
(
±h»ad_mu‹x_t
 *);

138 
±h»ad_mu‹x_uÆock
(
±h»ad_mu‹x_t
 *);

139 
FILE
 *
mg_fİ’
(cÚ¡ *
·th
, cÚ¡ *
mode
);

141 #ià
defšed
(
HAVE_STDINT
)

142 
	~<¡dšt.h
>

144 
	tušt32_t
;

145 
	tušt16_t
;

146 
	t__št64
 
	tušt64_t
;

147 
__št64
 
	tšt64_t
;

148 
	#INT64_MAX
 9223372036854775807

	)

152 
	sdœ’t
 {

153 
	md_Çme
[
PATH_MAX
];

156 
	sDIR
 {

157 
HANDLE
 
	mhªdË
;

158 
WIN32_FIND_DATAW
 
	mšfo
;

159 
dœ’t
 
	m»suÉ
;

160 } 
	tDIR
;

163 
	~<sys/wa™.h
>

164 
	~<sys/sock‘.h
>

165 
	~<sys/£Ëù.h
>

166 
	~<Ãtš‘/š.h
>

167 
	~<¬·/š‘.h
>

168 
	~<sys/time.h
>

169 
	~<¡dšt.h
>

170 
	~<š‰y³s.h
>

171 
	~<Ãtdb.h
>

173 
	~<pwd.h
>

174 
	~<uni¡d.h
>

175 
	~<dœ’t.h
>

176 #ià!
defšed
(
NO_SSL_DL
è&& !defšed(
NO_SSL
)

177 
	~<dlfú.h
>

179 
	~<±h»ad.h
>

180 #ià
defšed
(
__MACH__
)

181 
	#SSL_LIB
 "libs¦.dylib"

	)

182 
	#CRYPTO_LIB
 "libüy±o.dylib"

	)

184 #ià!
defšed
(
SSL_LIB
)

185 
	#SSL_LIB
 "libs¦.so"

	)

187 #ià!
defšed
(
CRYPTO_LIB
)

188 
	#CRYPTO_LIB
 "libüy±o.so"

	)

191 
	#DIRSEP
 '/'

	)

192 
	#IS_DIRSEP_CHAR
(
c
è((cè=ğ'/')

	)

193 
	#O_BINARY
 0

	)

194 
	#şo£sock‘
(
a
è
	`şo£
×)

	)

195 
	#mg_fİ’
(
x
, 
y
è
	`fİ’
(x, y)

	)

196 
	#mg_mkdœ
(
x
, 
y
è
	`mkdœ
(x, y)

	)

197 
	#mg_»move
(
x
è
	`»move
(x)

	)

198 
	#mg_»Çme
(
x
, 
y
è
	`»Çme
(x, y)

	)

199 
	#ERRNO
 
”ºo


	)

200 
	#INVALID_SOCKET
 (-1)

	)

201 
	#INT64_FMT
 
PRId64


	)

202 
	tSOCKET
;

203 
	#WINCDECL


	)

207 
	~"mÚgoo£.h
"

209 
	#MONGOOSE_VERSION
 "3.0"

	)

210 
	#PASSWORDS_FILE_NAME
 ".hasswd"

	)

211 
	#CGI_ENVIRONMENT_SIZE
 4096

	)

212 
	#MAX_CGI_ENVIR_VARS
 64

	)

213 
	#ARRAY_SIZE
(
¬¿y
è(×¼ayè/ ×¼ay[0]))

	)

215 #ià
defšed
(
DEBUG
)

216 
	#DEBUG_TRACE
(
x
èdØ{ \

	)

217 
æockfe
(
¡dout
); \

218 
´štf
("*** %lu.%p.%s.%d: ", \

219 (è
time
(
NULL
), (*è
±h»ad_£lf
(), \

220 
__func__
, 
__LINE__
); \

221 
´štf
 
	gx
; \

222 
putch¬
('\n'); \

223 
fæush
(
¡dout
); \

224 
fuÆockfe
(
¡dout
); \

227 
	#DEBUG_TRACE
(
x
)

	)

231 #ifdeà
NO_SOCKLEN_T


232 
	tsockËn_t
;

235 * (*
	tmg_th»ad_func_t
)(*);

237 cÚ¡ *
h‰p_500_”rÜ
 = "Internal Server Error";

242 
s¦_¡
 
	tSSL
;

243 
s¦_m‘hod_¡
 
	tSSL_METHOD
;

244 
s¦_ùx_¡
 
	tSSL_CTX
;

246 
	#SSL_ERROR_WANT_READ
 2

	)

247 
	#SSL_ERROR_WANT_WRITE
 3

	)

248 
	#SSL_FILETYPE_PEM
 1

	)

249 
	#CRYPTO_LOCK
 1

	)

251 #ià
	`defšed
(
NO_SSL_DL
)

252 
	`SSL_ä“
(
SSL
 *);

253 
	`SSL_acû±
(
SSL
 *);

254 
	`SSL_cÚÃù
(
SSL
 *);

255 
	`SSL_»ad
(
SSL
 *, *, );

256 
	`SSL_wr™e
(
SSL
 *, const *, );

257 
	`SSL_g‘_”rÜ
(cÚ¡ 
SSL
 *, );

258 
	`SSL_£t_fd
(
SSL
 *, );

259 
SSL
 *
	`SSL_Ãw
(
SSL_CTX
 *);

260 
SSL_CTX
 *
	`SSL_CTX_Ãw
(
SSL_METHOD
 *);

261 
SSL_METHOD
 *
	`SSLv23_£rv”_m‘hod
();

262 
	`SSL_lib¿ry_š™
();

263 
	`SSL_lßd_”rÜ_¡ršgs
();

264 
	`SSL_CTX_u£_Priv©eKey_fe
(
SSL_CTX
 *, const *, );

265 
	`SSL_CTX_u£_û¹ifiÿ‹_fe
(
SSL_CTX
 *, const *, );

266 
	`SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
(
SSL_CTX
 *, const *);

267 
	`SSL_CTX_£t_deçuÉ_·sswd_cb
(
SSL_CTX
 *, 
mg_ÿÎback_t
);

268 
	`SSL_CTX_ä“
(
SSL_CTX
 *);

269 
	`ERR_g‘_”rÜ
();

270 *
	`ERR_”rÜ_¡ršg
(, *);

271 
	`CRYPTO_num_locks
();

272 
	`CRYPTO_£t_lockšg_ÿÎback
((*)(, , const *, ));

273 
	`CRYPTO_£t_id_ÿÎback
((*)());

276 
	ss¦_func
 {

277 cÚ¡ *
Çme
;

278 (*
±r
)();

281 
	#SSL_ä“
 (* ((*)(
SSL
 *)è
s¦_sw
[0].
±r
)

	)

282 
	#SSL_acû±
 (* ((*)(
SSL
 *)è
s¦_sw
[1].
±r
)

	)

283 
	#SSL_cÚÃù
 (* ((*)(
SSL
 *)è
s¦_sw
[2].
±r
)

	)

284 
	#SSL_»ad
 (* ((*)(
SSL
 *, *, )è
s¦_sw
[3].
±r
)

	)

285 
	#SSL_wr™e
 (* ((*)(
SSL
 *, cÚ¡ *,)è
s¦_sw
[4].
±r
)

	)

286 
	#SSL_g‘_”rÜ
 (* ((*)(
SSL
 *, )è
s¦_sw
[5])

	)

287 
	#SSL_£t_fd
 (* ((*)(
SSL
 *, 
SOCKET
)è
s¦_sw
[6].
±r
)

	)

288 
	#SSL_Ãw
 (* (
SSL
 * (*)(
SSL_CTX
 *)è
s¦_sw
[7].
±r
)

	)

289 
	#SSL_CTX_Ãw
 (* (
SSL_CTX
 * (*)(
SSL_METHOD
 *)è
s¦_sw
[8].
±r
)

	)

290 
	#SSLv23_£rv”_m‘hod
 (* (
SSL_METHOD
 * (*)()è
s¦_sw
[9].
±r
)

	)

291 
	#SSL_lib¿ry_š™
 (* ((*)()è
s¦_sw
[10].
±r
)

	)

292 
	#SSL_CTX_u£_Priv©eKey_fe
 (* ((*)(
SSL_CTX
 *, \

	)

293 cÚ¡ *, )è
s¦_sw
[11].
±r
)

294 
	#SSL_CTX_u£_û¹ifiÿ‹_fe
 (* ((*)(
SSL_CTX
 *, \

	)

295 cÚ¡ *, )è
s¦_sw
[12].
±r
)

296 
	#SSL_CTX_£t_deçuÉ_·sswd_cb
 \

	)

297 (* ((*)(
SSL_CTX
 *, 
mg_ÿÎback_t
)è
s¦_sw
[13].
±r
)

298 
	#SSL_CTX_ä“
 (* ((*)(
SSL_CTX
 *)è
s¦_sw
[14].
±r
)

	)

299 
	#SSL_lßd_”rÜ_¡ršgs
 (* ((*)()è
s¦_sw
[15].
±r
)

	)

300 
	#SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
 \

	)

301 (* ((*)(
SSL_CTX
 *, cÚ¡ *)è
s¦_sw
[16].
±r
)

303 
	#CRYPTO_num_locks
 (* ((*)()è
üy±o_sw
[0].
±r
)

	)

304 
	#CRYPTO_£t_lockšg_ÿÎback
 \

	)

305 (* ((*)((*)(, , cÚ¡ *, ))è
üy±o_sw
[1].
±r
)

306 
	#CRYPTO_£t_id_ÿÎback
 \

	)

307 (* ((*)((*)())è
üy±o_sw
[2].
±r
)

308 
	#ERR_g‘_”rÜ
 (* ((*)()è
s¦_sw
[3].
±r
)

	)

309 
	#ERR_”rÜ_¡ršg
 (* (* (*)(, *)è
s¦_sw
[4].
±r
)

	)

315 
s¦_func
 
s¦_sw
[] = {

316 {"SSL_ä“", 
NULL
},

317 {"SSL_acû±", 
NULL
},

318 {"SSL_cÚÃù", 
NULL
},

319 {"SSL_»ad", 
NULL
},

320 {"SSL_wr™e", 
NULL
},

321 {"SSL_g‘_”rÜ", 
NULL
},

322 {"SSL_£t_fd", 
NULL
},

323 {"SSL_Ãw", 
NULL
},

324 {"SSL_CTX_Ãw", 
NULL
},

325 {"SSLv23_£rv”_m‘hod", 
NULL
},

326 {"SSL_lib¿ry_š™", 
NULL
},

327 {"SSL_CTX_u£_Priv©eKey_fe", 
NULL
},

328 {"SSL_CTX_u£_û¹ifiÿ‹_fe",
NULL
},

329 {"SSL_CTX_£t_deçuÉ_·sswd_cb",
NULL
},

330 {"SSL_CTX_ä“", 
NULL
},

331 {"SSL_lßd_”rÜ_¡ršgs", 
NULL
},

332 {"SSL_CTX_u£_û¹ifiÿ‹_chaš_fe", 
NULL
},

333 {
NULL
, NULL}

334 
	}
};

337 
s¦_func
 
	güy±o_sw
[] = {

338 {"CRYPTO_num_locks", 
NULL
},

339 {"CRYPTO_£t_lockšg_ÿÎback", 
NULL
},

340 {"CRYPTO_£t_id_ÿÎback", 
NULL
},

341 {"ERR_g‘_”rÜ", 
NULL
},

342 {"ERR_”rÜ_¡ršg", 
NULL
},

343 {
NULL
, NULL}

347 cÚ¡ *
	gmÚth_Çmes
[] = {

354 
	su§
 {

355 
sockËn_t
 
	mËn
;

357 
sockaddr
 
	m§
;

358 
sockaddr_š
 
	msš
;

359 } 
	mu
;

363 
	svec
 {

364 cÚ¡ *
	m±r
;

365 
size_t
 
	mËn
;

369 
	smg¡©
 {

370 
	mis_dœeùÜy
;

371 
št64_t
 
	msize
;

372 
time_t
 
	mmtime
;

377 
	ssock‘
 {

378 
sock‘
 *
	mÃxt
;

379 
SOCKET
 
	msock
;

380 
u§
 
	ml§
;

381 
u§
 
	mr§
;

382 
	mis_s¦
;

383 
	mis_´oxy
;

387 
	mCGI_EXTENSIONS
, 
	mCGI_ENVIRONMENT
, 
	mPUT_DELETE_PASSWORDS_FILE
, 
	mCGI_INTERPRETER
,

388 
	mPROTECT_URI
, 
	mAUTHENTICATION_DOMAIN
, 
	mSSI_EXTENSIONS
, 
	mACCESS_LOG_FILE
,

389 
	mSSL_CHAIN_FILE
, 
	mENABLE_DIRECTORY_LISTING
, 
	mERROR_LOG_FILE
,

390 
	mGLOBAL_PASSWORDS_FILE
, 
	mINDEX_FILES
,

391 
	mENABLE_KEEP_ALIVE
, 
	mACCESS_CONTROL_LIST
, 
	mMAX_REQUEST_SIZE
,

392 
	mEXTRA_MIME_TYPES
, 
	mLISTENING_PORTS
,

393 
	mDOCUMENT_ROOT
, 
	mSSL_CERTIFICATE
, 
	mNUM_THREADS
, 
	mRUN_AS_USER
,

394 
	mNUM_OPTIONS


397 cÚ¡ *
	gcÚfig_İtiÚs
[] = {

399 "E", "cgi_’vœÚm’t", 
NULL
,

400 "G", "put_d–‘e_·sswÜds_fe", 
NULL
,

401 "I", "cgi_š‹½»‹r", 
NULL
,

402 "P", "´Ùeù_uri", 
NULL
,

405 "a", "acûss_log_fe", 
NULL
,

406 "c", "s¦_chaš_fe", 
NULL
,

408 "e", "”rÜ_log_fe", 
NULL
,

409 "g", "glob®_·sswÜds_fe", 
NULL
,

412 "l", "acûss_cÚŒŞ_li¡", 
NULL
,

414 "m", "exŒa_mime_ty³s", 
NULL
,

417 "s", "s¦_û¹ifiÿ‹", 
NULL
,

419 "u", "run_as_u£r", 
NULL
,

420 
NULL


422 
	#ENTRIES_PER_CONFIG_OPTION
 3

	)

424 
	smg_cÚ‹xt
 {

425 
	m¡İ_æag
;

426 
SSL_CTX
 *
	ms¦_ùx
;

427 *
	mcÚfig
[
NUM_OPTIONS
];

428 
mg_ÿÎback_t
 
	mu£r_ÿÎback
;

429 *
	mu£r_d©a
;

431 
sock‘
 *
	mli¡’šg_sock‘s
;

433 
	mnum_th»ads
;

434 
±h»ad_mu‹x_t
 
	mmu‹x
;

435 
±h»ad_cÚd_t
 
	mcÚd
;

437 
sock‘
 
	mqueue
[20];

438 
	msq_h—d
;

439 
	msq_
;

440 
±h»ad_cÚd_t
 
	msq_fuÎ
;

441 
±h»ad_cÚd_t
 
	msq_em±y
;

444 
	smg_cÚÃùiÚ
 {

445 
mg_cÚÃùiÚ
 *
	m³”
;

446 
mg_»que¡_šfo
 
	m»que¡_šfo
;

447 
mg_cÚ‹xt
 *
	mùx
;

448 
SSL
 *
	ms¦
;

449 
sock‘
 
	mş›Á
;

450 
time_t
 
	mbœth_time
;

451 
št64_t
 
	mnum_by‹s_£Á
;

452 
št64_t
 
	mcÚ‹Á_Ën
;

453 
št64_t
 
	mcÚsumed_cÚ‹Á
;

454 *
	mbuf
;

455 
	mbuf_size
;

456 
	m»que¡_Ën
;

457 
	md©a_Ën
;

458 *
	mauth_h—d”
;

461 cÚ¡ **
	$mg_g‘_v®id_İtiÚ_Çmes
() {

462  
cÚfig_İtiÚs
;

463 
	}
}

465 *
	$ÿÎ_u£r
(
mg_cÚÃùiÚ
 *
cÚn
, 
mg_ev’t
 
ev’t
) {

466 
cÚn
->
»que¡_šfo
.
u£r_d©a
 = cÚn->
ùx
->user_data;

467  
cÚn
->
ùx
->
u£r_ÿÎback
 =ğ
NULL
 ? NULL :

468 
cÚn
->
ùx
->
	`u£r_ÿÎback
(
ev’t
, cÚn, &cÚn->
»que¡_šfo
);

469 
	}
}

471 
	$g‘_İtiÚ_šdex
(cÚ¡ *
Çme
) {

472 
i
;

474 
i
 = 0; 
cÚfig_İtiÚs
[i] !ğ
NULL
; i +ğ
ENTRIES_PER_CONFIG_OPTION
) {

475 ià(
	`¡rcmp
(
cÚfig_İtiÚs
[
i
], 
Çme
) == 0 ||

476 
	`¡rcmp
(
cÚfig_İtiÚs
[
i
 + 1], 
Çme
) == 0) {

477  
i
 / 
ENTRIES_PER_CONFIG_OPTION
;

481 
	}
}

483 cÚ¡ *
	$mg_g‘_İtiÚ
(cÚ¡ 
mg_cÚ‹xt
 *
ùx
, cÚ¡ *
Çme
) {

484 
i
;

485 ià((
i
 = 
	`g‘_İtiÚ_šdex
(
Çme
)) == -1) {

486  
NULL
;

487 } ià(
ùx
->
cÚfig
[
i
] =ğ
NULL
) {

490  
ùx
->
cÚfig
[
i
];

492 
	}
}

495 
	$üy
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
fmt
, ...) {

496 
buf
[
BUFSIZ
];

497 
va_li¡
 
­
;

498 
FILE
 *
å
;

499 
time_t
 
time¡amp
;

501 
	`va_¡¬t
(
­
, 
fmt
);

502 (è
	`v¢´štf
(
buf
, (buf), 
fmt
, 
­
);

503 
	`va_’d
(
­
);

508 
cÚn
->
»que¡_šfo
.
log_mes§ge
 = 
buf
;

509 ià(
	`ÿÎ_u£r
(
cÚn
, 
MG_EVENT_LOG
è=ğ
NULL
) {

510 
å
 = 
cÚn
->
ùx
->
cÚfig
[
ERROR_LOG_FILE
] =ğ
NULL
 ? NULL :

511 
	`mg_fİ’
(
cÚn
->
ùx
->
cÚfig
[
ERROR_LOG_FILE
], "a+");

513 ià(
å
 !ğ
NULL
) {

514 
	`æockfe
(
å
);

515 
time¡amp
 = 
	`time
(
NULL
);

517 (è
	`årštf
(
å
,

519 (è
time¡amp
,

520 
	`š‘_Áß
(
cÚn
->
ş›Á
.
r§
.
u
.
sš
.
sš_addr
));

522 ià(
cÚn
->
»que¡_šfo
.
»que¡_m‘hod
 !ğ
NULL
) {

523 (è
	`årštf
(
å
, "%s %s: ",

524 
cÚn
->
»que¡_šfo
.
»que¡_m‘hod
,

525 
cÚn
->
»que¡_šfo
.
uri
);

528 (è
	`årštf
(
å
, "%s", 
buf
);

529 
	`åutc
('\n', 
å
);

530 
	`fuÆockfe
(
å
);

531 ià(
å
 !ğ
¡d”r
) {

532 
	`fşo£
(
å
);

536 
cÚn
->
»que¡_šfo
.
log_mes§ge
 = 
NULL
;

537 
	}
}

540 cÚ¡ *
	$s¦_”rÜ
() {

541 
”r
;

542 
”r
 = 
	`ERR_g‘_”rÜ
();

543  
”r
 =ğ0 ? "" : 
	`ERR_”rÜ_¡ršg
Ó¼, 
NULL
);

544 
	}
}

548 
mg_cÚÃùiÚ
 *
	$fc
(
mg_cÚ‹xt
 *
ùx
) {

549 
mg_cÚÃùiÚ
 
çke_cÚÃùiÚ
;

550 
çke_cÚÃùiÚ
.
ùx
 = ctx;

551  &
çke_cÚÃùiÚ
;

552 
	}
}

554 cÚ¡ *
	$mg_v”siÚ
() {

555  
MONGOOSE_VERSION
;

556 
	}
}

558 
	$mg_¡¾ıy
(*
d¡
, cÚ¡ *
¤c
, 
size_t
 
n
) {

559 ; *
¤c
 !ğ'\0' && 
n
 > 1;‚--) {

560 *
d¡
++ = *
¤c
++;

562 *
d¡
 = '\0';

563 
	}
}

565 
	$low”ÿ£
(cÚ¡ *
s
) {

566  
	`tŞow”
(* (cÚ¡ *è
s
);

567 
	}
}

569 
	$mg_¡ºÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
, 
size_t
 
Ën
) {

570 
diff
 = 0;

572 ià(
Ën
 > 0)

574 
diff
 = 
	`low”ÿ£
(
s1
++è-†ow”ÿ£(
s2
++);

575 } 
diff
 =ğ0 && 
s1
[-1] !ğ'\0' && --
Ën
 > 0);

577  
diff
;

578 
	}
}

580 
	$mg_¡rÿ£cmp
(cÚ¡ *
s1
, cÚ¡ *
s2
) {

581 
diff
;

584 
diff
 = 
	`low”ÿ£
(
s1
++è-†ow”ÿ£(
s2
++);

585 } 
diff
 =ğ0 && 
s1
[-1] != '\0');

587  
diff
;

588 
	}
}

590 * 
	$mg_¡ºdup
(cÚ¡ *
±r
, 
size_t
 
Ën
) {

591 *
p
;

593 ià((
p
 = (*è
	`m®loc
(
Ën
 + 1)è!ğ
NULL
) {

594 
	`mg_¡¾ıy
(
p
, 
±r
, 
Ën
 + 1);

597  
p
;

598 
	}
}

600 * 
	$mg_¡rdup
(cÚ¡ *
¡r
) {

601  
	`mg_¡ºdup
(
¡r
, 
	`¡¾’
(str));

602 
	}
}

608 
	$mg_v¢´štf
(
mg_cÚÃùiÚ
 *
cÚn
, *
buf
, 
size_t
 
buæ’
,

609 cÚ¡ *
fmt
, 
va_li¡
 
­
) {

610 
n
;

612 ià(
buæ’
 == 0)

615 
n
 = 
	`v¢´štf
(
buf
, 
buæ’
, 
fmt
, 
­
);

617 ià(
n
 < 0) {

618 
	`üy
(
cÚn
, "vsnprintfƒrror");

619 
n
 = 0;

620 } ià(
n
 >ğ(è
buæ’
) {

621 
	`üy
(
cÚn
, "truncating vsnprintf buffer: [%.*s]",

622 
n
 > 200 ? 200 :‚, 
buf
);

623 
n
 = (è
buæ’
 - 1;

625 
buf
[
n
] = '\0';

627  
n
;

628 
	}
}

630 
	$mg_¢´štf
(
mg_cÚÃùiÚ
 *
cÚn
, *
buf
, 
size_t
 
buæ’
,

631 cÚ¡ *
fmt
, ...) {

632 
va_li¡
 
­
;

633 
n
;

635 
	`va_¡¬t
(
­
, 
fmt
);

636 
n
 = 
	`mg_v¢´štf
(
cÚn
, 
buf
, 
buæ’
, 
fmt
, 
­
);

637 
	`va_’d
(
­
);

639  
n
;

640 
	}
}

646 *
	$sk_quÙed
(**
buf
, cÚ¡ *
d–im™”s
, cÚ¡ *
wh™e¥aû
, 
quÙech¬
) {

647 *
p
, *
begš_wÜd
, *
’d_wÜd
, *
’d_wh™e¥aû
;

649 
begš_wÜd
 = *
buf
;

650 
’d_wÜd
 = 
begš_wÜd
 + 
	`¡rc¥n
(begš_wÜd, 
d–im™”s
);

653 ià(
’d_wÜd
 > 
begš_wÜd
) {

654 
p
 = 
’d_wÜd
 - 1;

655 *
p
 =ğ
quÙech¬
) {

657 ià(*
’d_wÜd
 == '\0') {

658 *
p
 = '\0';

661 
size_t
 
’d_off
 = 
	`¡rc¥n
(
’d_wÜd
 + 1, 
d–im™”s
);

662 
	`memmove
 (
p
, 
’d_wÜd
, 
’d_off
 + 1);

663 
p
 +ğ
’d_off
;

664 
’d_wÜd
 +ğ
’d_off
 + 1;

667 
p
++;… < 
’d_wÜd
;…++) {

668 *
p
 = '\0';

672 ià(*
’d_wÜd
 == '\0') {

673 *
buf
 = 
’d_wÜd
;

675 
’d_wh™e¥aû
 = 
’d_wÜd
 + 1 + 
	`¡r¥n
Ónd_wÜd + 1, 
wh™e¥aû
);

677 
p
 = 
’d_wÜd
;… < 
’d_wh™e¥aû
;…++) {

678 *
p
 = '\0';

681 *
buf
 = 
’d_wh™e¥aû
;

684  
begš_wÜd
;

685 
	}
}

688 *
	$sk
(**
buf
, cÚ¡ *
d–im™”s
) {

689  
	`sk_quÙed
(
buf
, 
d–im™”s
, delimiters, 0);

690 
	}
}

694 cÚ¡ *
	$g‘_h—d”
(cÚ¡ 
mg_»que¡_šfo
 *
ri
,

695 cÚ¡ *
Çme
) {

696 
i
;

698 
i
 = 0; i < 
ri
->
num_h—d”s
; i++)

699 ià(!
	`mg_¡rÿ£cmp
(
Çme
, 
ri
->
h‰p_h—d”s
[
i
].name))

700  
ri
->
h‰p_h—d”s
[
i
].
v®ue
;

702  
NULL
;

703 
	}
}

705 cÚ¡ *
	$mg_g‘_h—d”
(cÚ¡ 
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
Çme
) {

706  
	`g‘_h—d”
(&
cÚn
->
»que¡_šfo
, 
Çme
);

707 
	}
}

715 cÚ¡ *
	$Ãxt_İtiÚ
(cÚ¡ *
li¡
, 
vec
 *
v®
,

716 
vec
 *
eq_v®
) {

717 ià(
li¡
 =ğ
NULL
 || *list == '\0') {

719 
li¡
 = 
NULL
;

721 
v®
->
±r
 = 
li¡
;

722 ià((
li¡
 = 
	`¡rchr
(
v®
->
±r
, ',')è!ğ
NULL
) {

724 
v®
->
Ën
 = 
li¡
 - v®->
±r
;

725 
li¡
++;

728 
li¡
 = 
v®
->
±r
 + 
	`¡¾’
(val->ptr);

729 
v®
->
Ën
 = 
li¡
 - v®->
±r
;

732 ià(
eq_v®
 !ğ
NULL
) {

737 
eq_v®
->
Ën
 = 0;

738 
eq_v®
->
±r
 = (cÚ¡ *è
	`memchr
(
v®
->±r, '=', v®->
Ën
);

739 ià(
eq_v®
->
±r
 !ğ
NULL
) {

740 
eq_v®
->
±r
++;

741 
eq_v®
->
Ën
 = 
v®
->
±r
 + val->len -ƒq_val->ptr;

742 
v®
->
Ën
 = (
eq_v®
->
±r
 - val->ptr) - 1;

747  
li¡
;

748 
	}
}

750 #ià!
defšed
(
NO_CGI
)

751 
	$m©ch_ex‹nsiÚ
(cÚ¡ *
·th
, cÚ¡ *
ext_li¡
) {

752 
vec
 
ext_vec
;

753 
size_t
 
·th_Ën
;

755 
·th_Ën
 = 
	`¡¾’
(
·th
);

757 (
ext_li¡
 = 
	`Ãxt_İtiÚ
Óxt_li¡, &
ext_vec
, 
NULL
)) != NULL)

758 ià(
ext_vec
.
Ën
 < 
·th_Ën
 &&

759 
	`mg_¡ºÿ£cmp
(
·th
 + 
·th_Ën
 - 
ext_vec
.
Ën
,

760 
ext_vec
.
±r
,ƒxt_vec.
Ën
) == 0)

764 
	}
}

770 
	$should_k“p_®ive
(cÚ¡ 
mg_cÚÃùiÚ
 *
cÚn
) {

771 cÚ¡ *
h‰p_v”siÚ
 = 
cÚn
->
»que¡_šfo
.http_version;

772 cÚ¡ *
h—d”
 = 
	`mg_g‘_h—d”
(
cÚn
, "Connection");

773  (
h—d”
 =ğ
NULL
 && 
h‰p_v”siÚ
 && !
	`¡rcmp
(http_version, "1.1")) ||

774 (
h—d”
 !ğ
NULL
 && !
	`mg_¡rÿ£cmp
(header, "keep-alive"));

775 
	}
}

777 cÚ¡ *
	$sugge¡_cÚÃùiÚ_h—d”
(cÚ¡ 
mg_cÚÃùiÚ
 *
cÚn
) {

778  
	`should_k“p_®ive
(
cÚn
) ? "keep-alive" : "close";

779 
	}
}

781 
	$£nd_h‰p_”rÜ
(
mg_cÚÃùiÚ
 *
cÚn
, 
¡©us
,

782 cÚ¡ *
»asÚ
, cÚ¡ *
fmt
, ...) {

783 
buf
[
BUFSIZ
];

784 
va_li¡
 
­
;

785 
Ën
;

787 
cÚn
->
»que¡_šfo
.
¡©us_code
 = 
¡©us
;

789 ià(
	`ÿÎ_u£r
(
cÚn
, 
MG_HTTP_ERROR
è=ğ
NULL
) {

790 
buf
[0] = '\0';

791 
Ën
 = 0;

794 ià(
¡©us
 > 199 && status != 204 && status != 304) {

795 
Ën
 = 
	`mg_¢´štf
(
cÚn
, 
buf
, (buf), "E¼Ü %d: %s", 
¡©us
, 
»asÚ
);

796 
	`üy
(
cÚn
, "%s", 
buf
);

797 
buf
[
Ën
++] = '\n';

799 
	`va_¡¬t
(
­
, 
fmt
);

800 
Ën
 +ğ
	`mg_v¢´štf
(
cÚn
, 
buf
 +†’, (bufè-†’, 
fmt
, 
­
);

801 
	`va_’d
(
­
);

803 
	`DEBUG_TRACE
(("[%s]", 
buf
));

805 
	`mg_´štf
(
cÚn
, "HTTP/1.1 %d %s\r\n"

808 "CÚÃùiÚ: %s\r\n\r\n", 
¡©us
, 
»asÚ
, 
Ën
,

809 
	`sugge¡_cÚÃùiÚ_h—d”
(
cÚn
));

810 
cÚn
->
num_by‹s_£Á
 +ğ
	`mg_´štf
(cÚn, "%s", 
buf
);

812 
	}
}

814 #ifdeà
_WIN32


815 
	$±h»ad_mu‹x_š™
(
±h»ad_mu‹x_t
 *
mu‹x
, *
unu£d
) {

816 
unu£d
 = 
NULL
;

817 *
mu‹x
 = 
	`C»©eMu‹x
(
NULL
, 
FALSE
, NULL);

818  *
mu‹x
 =ğ
NULL
 ? -1 : 0;

819 
	}
}

821 
	$±h»ad_mu‹x_de¡roy
(
±h»ad_mu‹x_t
 *
mu‹x
) {

822  
	`Clo£HªdË
(*
mu‹x
) == 0 ? -1 : 0;

823 
	}
}

825 
	$±h»ad_mu‹x_lock
(
±h»ad_mu‹x_t
 *
mu‹x
) {

826  
	`Wa™FÜSšgËObjeù
(*
mu‹x
, 
INFINITE
è=ğ
WAIT_OBJECT_0
? 0 : -1;

827 
	}
}

829 
	$±h»ad_mu‹x_uÆock
(
±h»ad_mu‹x_t
 *
mu‹x
) {

830  
	`R–—£Mu‹x
(*
mu‹x
) == 0 ? -1 : 0;

831 
	}
}

833 
	$±h»ad_cÚd_š™
(
±h»ad_cÚd_t
 *
cv
, cÚ¡ *
unu£d
) {

834 
unu£d
 = 
NULL
;

835 
cv
->
sigÇl
 = 
	`C»©eEv’t
(
NULL
, 
FALSE
, FALSE, NULL);

836 
cv
->
brßdÿ¡
 = 
	`C»©eEv’t
(
NULL
, 
TRUE
, 
FALSE
, NULL);

837  
cv
->
sigÇl
 !ğ
NULL
 && cv->
brßdÿ¡
 != NULL ? 0 : -1;

838 
	}
}

840 
	$±h»ad_cÚd_wa™
(
±h»ad_cÚd_t
 *
cv
, 
±h»ad_mu‹x_t
 *
mu‹x
) {

841 
HANDLE
 
hªdËs
[] = {
cv
->
sigÇl
, cv->
brßdÿ¡
};

842 
	`R–—£Mu‹x
(*
mu‹x
);

843 
	`Wa™FÜMuÉËObjeùs
(2, 
hªdËs
, 
FALSE
, 
INFINITE
);

844  
	`R–—£Mu‹x
(*
mu‹x
) == 0 ? -1 : 0;

845 
	}
}

847 
	$±h»ad_cÚd_sigÇl
(
±h»ad_cÚd_t
 *
cv
) {

848  
	`S‘Ev’t
(
cv
->
sigÇl
) == 0 ? -1 : 0;

849 
	}
}

851 
	$±h»ad_cÚd_brßdÿ¡
(
±h»ad_cÚd_t
 *
cv
) {

854  
	`Pul£Ev’t
(
cv
->
brßdÿ¡
) == 0 ? -1 : 0;

855 
	}
}

857 
	$±h»ad_cÚd_de¡roy
(
±h»ad_cÚd_t
 *
cv
) {

858  
	`Clo£HªdË
(
cv
->
sigÇl
è&& Clo£HªdË(cv->
brßdÿ¡
) ? 0 : -1;

859 
	}
}

861 
±h»ad_t
 
	$±h»ad_£lf
() {

862  
	`G‘Cu¼’tTh»adId
();

863 
	}
}

866 
	$chªge_¦ashes_to_back¦ashes
(*
·th
) {

867 
i
;

869 
i
 = 0; 
·th
[i] != '\0'; i++) {

870 ià(
·th
[
i
] == '/')

871 
·th
[
i
] = '\\';

873 ià(
·th
[
i
] == '\\' && i > 0)

874 
·th
[
i
 + 1] == '\\' ||…ath[i + 1] == '/')

875 (è
	`memmove
(
·th
 + 
i
 + 1,

876 
·th
 + 
i
 + 2, 
	`¡¾’
(path + i + 1));

878 
	}
}

882 
	$to_unicode
(cÚ¡ *
·th
, 
wch¬_t
 *
wbuf
, 
size_t
 
wbuf_Ën
) {

883 
buf
[
PATH_MAX
], *
p
;

885 
	`mg_¡¾ıy
(
buf
, 
·th
, (buf));

886 
	`chªge_¦ashes_to_back¦ashes
(
buf
);

889 
p
 = 
buf
 + 
	`¡¾’
(buf) - 1;

892 
p
 > 
buf
 && *p == '\\' &&…[-1] != ':') {

893 *
p
-- = '\0';

900 ià(*
p
 == 0x20 ||

901 (*
p
 =ğ0x2&&… > 
buf
) ||

902 *
p
 == 0x2b ||

903 (*
p
 & ~0x7f)) {

904 (è
	`årštf
(
¡d”r
, "Rejeùšg su¥iciou ·th: [%s]", 
buf
);

905 
buf
[0] = '\0';

908 (è
	`MuÉiBy‹ToWideCh¬
(
CP_UTF8
, 0, 
buf
, -1, 
wbuf
, (è
wbuf_Ën
);

909 
	}
}

911 #ià
defšed
(
_WIN32_WCE
)

912 
time_t
 
	$time
(
time_t
 *
±ime
) {

913 
time_t
 
t
;

914 
SYSTEMTIME
 
¡
;

915 
FILETIME
 
á
;

917 
	`G‘Sy¡emTime
(&
¡
);

918 
	`Sy¡emTimeToFeTime
(&
¡
, &
á
);

919 
t
 = 
	`SYS2UNIX_TIME
(
á
.
dwLowD©eTime
, ft.
dwHighD©eTime
);

921 ià(
±ime
 !ğ
NULL
) {

922 *
±ime
 = 
t
;

925  
t
;

926 
	}
}

928 
time_t
 
	$mktime
(
tm
 *
±m
) {

929 
SYSTEMTIME
 
¡
;

930 
FILETIME
 
á
, 
lá
;

932 
¡
.
wY—r
 = 
±m
->
tm_y—r
 + 1900;

933 
¡
.
wMÚth
 = 
±m
->
tm_mÚ
 + 1;

934 
¡
.
wDay
 = 
±m
->
tm_mday
;

935 
¡
.
wHour
 = 
±m
->
tm_hour
;

936 
¡
.
wMšu‹
 = 
±m
->
tm_mš
;

937 
¡
.
wSecÚd
 = 
±m
->
tm_£c
;

938 
¡
.
wMli£cÚds
 = 0;

940 
	`Sy¡emTimeToFeTime
(&
¡
, &
á
);

941 
	`LoÿlFeTimeToFeTime
(&
á
, &
lá
);

942  (
time_t
è((
	`MAKEUQUAD
(
lá
.
dwLowD©eTime
,†á.
dwHighD©eTime
) -

943 
EPOCH_DIFF
è/ 
RATE_DIFF
);

944 
	}
}

946 
tm
 *
	$loÿÉime
(cÚ¡ 
time_t
 *
±ime
, 
tm
 *
±m
) {

947 
št64_t
 
t
 = ((št64_tè*
±ime
è* 
RATE_DIFF
 + 
EPOCH_DIFF
;

948 
FILETIME
 
á
, 
lá
;

949 
SYSTEMTIME
 
¡
;

950 
TIME_ZONE_INFORMATION
 
tzšfo
;

952 ià(
±m
 =ğ
NULL
) {

953  
NULL
;

956 * (
št64_t
 *è&
á
 = 
t
;

957 
	`FeTimeToLoÿlFeTime
(&
á
, &
lá
);

958 
	`FeTimeToSy¡emTime
(&
lá
, &
¡
);

959 
±m
->
tm_y—r
 = 
¡
.
wY—r
 - 1900;

960 
±m
->
tm_mÚ
 = 
¡
.
wMÚth
 - 1;

961 
±m
->
tm_wday
 = 
¡
.
wDayOfW“k
;

962 
±m
->
tm_mday
 = 
¡
.
wDay
;

963 
±m
->
tm_hour
 = 
¡
.
wHour
;

964 
±m
->
tm_mš
 = 
¡
.
wMšu‹
;

965 
±m
->
tm_£c
 = 
¡
.
wSecÚd
;

966 
±m
->
tm_yday
 = 0;

967 
±m
->
tm_isd¡
 =

968 
	`G‘TimeZÚeInfÜm©iÚ
(&
tzšfo
è=ğ
TIME_ZONE_ID_DAYLIGHT
 ? 1 : 0;

970  
±m
;

971 
	}
}

973 
size_t
 
	$¡ráime
(*
d¡
, 
size_t
 
d¡_size
, cÚ¡ *
fmt
,

974 cÚ¡ 
tm
 *tm) {

975 (è
	`¢´štf
(
d¡
, 
d¡_size
, "implement strftime() for WinCE");

977 
	}
}

980 
	$mg_»Çme
(cÚ¡ * 
ŞdÇme
, cÚ¡ * 
ÃwÇme
) {

981 
wch¬_t
 
wŞdbuf
[
PATH_MAX
];

982 
wch¬_t
 
wÃwbuf
[
PATH_MAX
];

984 
	`to_unicode
(
ŞdÇme
, 
wŞdbuf
, 
	`ARRAY_SIZE
(woldbuf));

985 
	`to_unicode
(
ÃwÇme
, 
wÃwbuf
, 
	`ARRAY_SIZE
(wnewbuf));

987  
	`MoveFeW
(
wŞdbuf
, 
wÃwbuf
) ? 0 : -1;

988 
	}
}

991 
FILE
 *
	$mg_fİ’
(cÚ¡ *
·th
, cÚ¡ *
mode
) {

992 
wch¬_t
 
wbuf
[
PATH_MAX
], 
wmode
[20];

994 
	`to_unicode
(
·th
, 
wbuf
, 
	`ARRAY_SIZE
(wbuf));

995 
	`MuÉiBy‹ToWideCh¬
(
CP_UTF8
, 0, 
mode
, -1, 
wmode
, 
	`ARRAY_SIZE
(wmode));

997  
	`_wfİ’
(
wbuf
, 
wmode
);

998 
	}
}

1000 
	$mg_¡©
(cÚ¡ *
·th
, 
mg¡©
 *
¡p
) {

1001 
ok
 = -1;

1002 
wch¬_t
 
wbuf
[
PATH_MAX
];

1003 
WIN32_FILE_ATTRIBUTE_DATA
 
šfo
;

1005 
	`to_unicode
(
·th
, 
wbuf
, 
	`ARRAY_SIZE
(wbuf));

1007 ià(
	`G‘FeA‰ribu‹sExW
(
wbuf
, 
G‘FeExInfoSnd¬d
, &
šfo
) != 0) {

1008 
¡p
->
size
 = 
	`MAKEUQUAD
(
šfo
.
nFeSizeLow
, info.
nFeSizeHigh
);

1009 
¡p
->
mtime
 = 
	`SYS2UNIX_TIME
(
šfo
.
áLa¡Wr™eTime
.
dwLowD©eTime
,

1010 
šfo
.
áLa¡Wr™eTime
.
dwHighD©eTime
);

1011 
¡p
->
is_dœeùÜy
 =

1012 
šfo
.
dwFeA‰ribu‹s
 & 
FILE_ATTRIBUTE_DIRECTORY
;

1013 
ok
 = 0;

1016  
ok
;

1017 
	}
}

1019 
	$mg_»move
(cÚ¡ *
·th
) {

1020 
wch¬_t
 
wbuf
[
PATH_MAX
];

1021 
	`to_unicode
(
·th
, 
wbuf
, 
	`ARRAY_SIZE
(wbuf));

1022  
	`D–‘eFeW
(
wbuf
) ? 0 : -1;

1023 
	}
}

1025 
	$mg_mkdœ
(cÚ¡ *
·th
, 
mode
) {

1026 
buf
[
PATH_MAX
];

1027 
wch¬_t
 
wbuf
[
PATH_MAX
];

1029 
mode
 = 0;

1030 
	`mg_¡¾ıy
(
buf
, 
·th
, (buf));

1031 
	`chªge_¦ashes_to_back¦ashes
(
buf
);

1033 (è
	`MuÉiBy‹ToWideCh¬
(
CP_UTF8
, 0, 
buf
, -1, 
wbuf
, (wbuf));

1035  
	`C»©eDœeùÜyW
(
wbuf
, 
NULL
) ? 0 : -1;

1036 
	}
}

1039 
DIR
 * 
	$İ’dœ
(cÚ¡ *
Çme
) {

1040 
DIR
 *
dœ
 = 
NULL
;

1041 
wch¬_t
 
w·th
[
PATH_MAX
];

1042 
DWORD
 
©Œs
;

1044 ià(
Çme
 =ğ
NULL
) {

1045 
	`S‘La¡E¼Ü
(
ERROR_BAD_ARGUMENTS
);

1046 } ià((
dœ
 = (
DIR
 *è
	`m®loc
((*dœ))è=ğ
NULL
) {

1047 
	`S‘La¡E¼Ü
(
ERROR_NOT_ENOUGH_MEMORY
);

1049 
	`to_unicode
(
Çme
, 
w·th
, 
	`ARRAY_SIZE
(wpath));

1050 
©Œs
 = 
	`G‘FeA‰ribu‹sW
(
w·th
);

1051 ià(
©Œs
 != 0xFFFFFFFF &&

1052 ((
©Œs
 & 
FILE_ATTRIBUTE_DIRECTORY
) == FILE_ATTRIBUTE_DIRECTORY)) {

1053 (è
	`wcsÿt
(
w·th
, 
L
"\\*");

1054 
dœ
->
hªdË
 = 
	`FšdFœ¡FeW
(
w·th
, &dœ->
šfo
);

1055 
dœ
->
»suÉ
.
d_Çme
[0] = '\0';

1057 
	`ä“
(
dœ
);

1058 
dœ
 = 
NULL
;

1062  
dœ
;

1063 
	}
}

1065 
	$şo£dœ
(
DIR
 *
dœ
) {

1066 
»suÉ
 = 0;

1068 ià(
dœ
 !ğ
NULL
) {

1069 ià(
dœ
->
hªdË
 !ğ
INVALID_HANDLE_VALUE
)

1070 
»suÉ
 = 
	`FšdClo£
(
dœ
->
hªdË
) ? 0 : -1;

1072 
	`ä“
(
dœ
);

1074 
»suÉ
 = -1;

1075 
	`S‘La¡E¼Ü
(
ERROR_BAD_ARGUMENTS
);

1078  
»suÉ
;

1079 
	}
}

1081 
dœ’t
 * 
	$»addœ
(
DIR
 *
dœ
) {

1082 
dœ’t
 *
»suÉ
 = 0;

1084 ià(
dœ
) {

1085 ià(
dœ
->
hªdË
 !ğ
INVALID_HANDLE_VALUE
) {

1086 
»suÉ
 = &
dœ
->result;

1087 (è
	`WideCh¬ToMuÉiBy‹
(
CP_UTF8
, 0,

1088 
dœ
->
šfo
.
cFeName
, -1, 
»suÉ
->
d_Çme
,

1089 (
»suÉ
->
d_Çme
), 
NULL
, NULL);

1091 ià(!
	`FšdNextFeW
(
dœ
->
hªdË
, &dœ->
šfo
)) {

1092 (è
	`FšdClo£
(
dœ
->
hªdË
);

1093 
dœ
->
hªdË
 = 
INVALID_HANDLE_VALUE
;

1097 
	`S‘La¡E¼Ü
(
ERROR_FILE_NOT_FOUND
);

1100 
	`S‘La¡E¼Ü
(
ERROR_BAD_ARGUMENTS
);

1103  
»suÉ
;

1104 
	}
}

1106 
	#£t_şo£_Ú_exec
(
fd
)

1107 

	)

1108 
	$¡¬t_th»ad
(
mg_cÚ‹xt
 *
ùx
, 
mg_th»ad_func_t
 
func
,

1109 *
·¿m
) {

1110 
HANDLE
 
hTh»ad
;

1111 
ùx
 = 
NULL
;

1113 
hTh»ad
 = 
	`C»©eTh»ad
(
NULL
, 0, (
LPTHREAD_START_ROUTINE
è
func
, 
·¿m
, 0,

1114 
NULL
);

1115 ià(
hTh»ad
 !ğ
NULL
) {

1116 (è
	`Clo£HªdË
(
hTh»ad
);

1119  
hTh»ad
 =ğ
NULL
 ? -1 : 0;

1120 
	}
}

1122 
HANDLE
 
	$dlİ’
(cÚ¡ *
dÎ_Çme
, 
æags
) {

1123 
wch¬_t
 
wbuf
[
PATH_MAX
];

1124 
æags
 = 0;

1125 
	`to_unicode
(
dÎ_Çme
, 
wbuf
, 
	`ARRAY_SIZE
(wbuf));

1126  
	`LßdLib¿ryW
(
wbuf
);

1127 
	}
}

1129 #ià!
defšed
(
NO_CGI
)

1130 
	#SIGKILL
 0

	)

1131 
	$kl
(
pid_t
 
pid
, 
sig_num
) {

1132 (è
	`T”mš©eProûss
(
pid
, 
sig_num
);

1133 (è
	`Clo£HªdË
(
pid
);

1135 
	}
}

1137 
pid_t
 
	$¥awn_´oûss
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
´og
,

1138 *
’vblk
, *
’vp
[], 
fd_¡dš
,

1139 
fd_¡dout
, cÚ¡ *
dœ
) {

1140 
HANDLE
 
me
;

1141 *
p
, *
š‹½
, 
cmdlše
[
PATH_MAX
], 
buf
[PATH_MAX];

1142 
FILE
 *
å
;

1143 
STARTUPINFOA
 
si
;

1144 
PROCESS_INFORMATION
 
pi
;

1146 
’vp
 = 
NULL
;

1148 (è
	`mem£t
(&
si
, 0, (si));

1149 (è
	`mem£t
(&
pi
, 0, (pi));

1152 
si
.
cb
 = (si);

1153 
si
.
dwFÏgs
 = 
STARTF_USESTDHANDLES
 | 
STARTF_USESHOWWINDOW
;

1154 
si
.
wShowWšdow
 = 
SW_HIDE
;

1156 
me
 = 
	`G‘Cu¼’tProûss
();

1157 (è
	`Du¶iÿ‹HªdË
(
me
, (
HANDLE
è
	`_g‘_osfhªdË
(
fd_¡dš
), me,

1158 &
si
.
hStdIÅut
, 0, 
TRUE
, 
DUPLICATE_SAME_ACCESS
);

1159 (è
	`Du¶iÿ‹HªdË
(
me
, (
HANDLE
è
	`_g‘_osfhªdË
(
fd_¡dout
), me,

1160 &
si
.
hStdOuut
, 0, 
TRUE
, 
DUPLICATE_SAME_ACCESS
);

1163 
š‹½
 = 
cÚn
->
ùx
->
cÚfig
[
CGI_INTERPRETER
];

1164 ià(
š‹½
 =ğ
NULL
) {

1165 
buf
[2] = '\0';

1166 ià((
å
 = 
	`fİ’
(
cmdlše
, "r")è!ğ
NULL
) {

1167 (è
	`fg‘s
(
buf
, (buf), 
å
);

1168 ià(
buf
[0] != '#' || buf[1] != '!') {

1170 
buf
[2] = '\0';

1173 
p
 = &
buf
[
	`¡¾’
(bufè- 1];… > buà&& 
	`is¥aû
(*p);…--) {

1174 *
p
 = '\0';

1177 (è
	`fşo£
(
å
);

1179 
š‹½
 = 
buf
 + 2;

1182 (è
	`mg_¢´štf
(
cÚn
, 
cmdlše
, (cmdline), "%s%s%s%c%s",

1183 
š‹½
, iÁ”p[0] =ğ'\0' ? "" : " ", 
dœ
, 
DIRSEP
, 
´og
);

1185 
	`DEBUG_TRACE
(("RuÂšg [%s]", 
cmdlše
));

1186 ià(
	`C»©eProûssA
(
NULL
, 
cmdlše
, NULL, NULL, 
TRUE
,

1187 
CREATE_NEW_PROCESS_GROUP
, 
’vblk
, 
dœ
, &
si
, &
pi
) == 0) {

1188 
	`üy
(
cÚn
, "%s: CreateProcess(%s): %d",

1189 
__func__
, 
cmdlše
, 
ERRNO
);

1190 
pi
.
hProûss
 = (
pid_t
) -1;

1192 (è
	`şo£
(
fd_¡dš
);

1193 (è
	`şo£
(
fd_¡dout
);

1196 (è
	`Clo£HªdË
(
si
.
hStdOuut
);

1197 (è
	`Clo£HªdË
(
si
.
hStdIÅut
);

1198 (è
	`Clo£HªdË
(
pi
.
hTh»ad
);

1200  (
pid_t
è
pi
.
hProûss
;

1201 
	}
}

1204 
	$£t_nÚ_blockšg_mode
(
SOCKET
 
sock
) {

1205 
Ú
 = 1;

1206  
	`ioùlsock‘
(
sock
, 
FIONBIO
, &
Ú
);

1207 
	}
}

1210 
	$mg_¡©
(cÚ¡ *
·th
, 
mg¡©
 *
¡p
) {

1211 
¡©
 
¡
;

1212 
ok
;

1214 ià(
	`¡©
(
·th
, &
¡
) == 0) {

1215 
ok
 = 0;

1216 
¡p
->
size
 = 
¡
.
¡_size
;

1217 
¡p
->
mtime
 = 
¡
.
¡_mtime
;

1218 
¡p
->
is_dœeùÜy
 = 
	`S_ISDIR
(
¡
.
¡_mode
);

1220 
ok
 = -1;

1223  
ok
;

1224 
	}
}

1226 
	$£t_şo£_Ú_exec
(
fd
) {

1227 (è
	`fú
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
);

1228 
	}
}

1230 
	$¡¬t_th»ad
(
mg_cÚ‹xt
 *
ùx
, 
mg_th»ad_func_t
 
func
,

1231 *
·¿m
) {

1232 
±h»ad_t
 
th»ad_id
;

1233 
±h»ad_©Œ_t
 
©Œ
;

1234 
»tv®
;

1236 (è
	`±h»ad_©Œ_š™
(&
©Œ
);

1237 (è
	`±h»ad_©Œ_£td‘ach¡©e
(&
©Œ
, 
PTHREAD_CREATE_DETACHED
);

1241 ià((
»tv®
 = 
	`±h»ad_ü—‹
(&
th»ad_id
, &
©Œ
, 
func
, 
·¿m
)) != 0) {

1242 
	`üy
(
	`fc
(
ùx
), "%s: %s", 
__func__
, 
	`¡»¼Ü
(
»tv®
));

1245  
»tv®
;

1246 
	}
}

1248 #iâdeà
NO_CGI


1249 
pid_t
 
	$¥awn_´oûss
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
´og
,

1250 *
’vblk
, *
’vp
[], 
fd_¡dš
,

1251 
fd_¡dout
, cÚ¡ *
dœ
) {

1252 
pid_t
 
pid
;

1253 cÚ¡ *
š‹½
;

1255 
’vblk
 = 
NULL
;

1257 ià((
pid
 = 
	`fÜk
()) == -1) {

1259 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, 
h‰p_500_”rÜ
, "fÜk(): %s", 
	`¡»¼Ü
(
ERRNO
));

1260 } ià(
pid
 == 0) {

1262 ià(
	`chdœ
(
dœ
) != 0) {

1263 
	`üy
(
cÚn
, "%s: chdœ(%s): %s", 
__func__
, 
dœ
, 
	`¡»¼Ü
(
ERRNO
));

1264 } ià(
	`dup2
(
fd_¡dš
, 0) == -1) {

1265 
	`üy
(
cÚn
, "%s: dup2(%d, 0): %s", 
__func__
, 
fd_¡dš
, 
	`¡»¼Ü
(
ERRNO
));

1266 } ià(
	`dup2
(
fd_¡dout
, 1) == -1) {

1267 
	`üy
(
cÚn
, "%s: dup2(%d, 1): %s", 
__func__
, 
fd_¡dout
, 
	`¡»¼Ü
(
ERRNO
));

1269 (è
	`dup2
(
fd_¡dout
, 2);

1270 (è
	`şo£
(
fd_¡dš
);

1271 (è
	`şo£
(
fd_¡dout
);

1274 
š‹½
 = 
cÚn
->
ùx
->
cÚfig
[
CGI_INTERPRETER
];

1275 ià(
š‹½
 =ğ
NULL
) {

1276 (è
	`exeşe
(
´og
,…rog, 
NULL
, 
’vp
);

1277 
	`üy
(
cÚn
, "%s:ƒxeşe(%s): %s", 
__func__
, 
´og
, 
	`¡»¼Ü
(
ERRNO
));

1279 (è
	`exeşe
(
š‹½
, iÁ”p, 
´og
, 
NULL
, 
’vp
);

1280 
	`üy
(
cÚn
, "%s:ƒxeşe(% %s): %s", 
__func__
, 
š‹½
, 
´og
,

1281 
	`¡»¼Ü
(
ERRNO
));

1284 
	`ex™
(
EXIT_FAILURE
);

1287 (è
	`şo£
(
fd_¡dš
);

1288 (è
	`şo£
(
fd_¡dout
);

1291  
pid
;

1292 
	}
}

1295 
	$£t_nÚ_blockšg_mode
(
SOCKET
 
sock
) {

1296 
æags
;

1298 
æags
 = 
	`fú
(
sock
, 
F_GETFL
, 0);

1299 (è
	`fú
(
sock
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
);

1302 
	}
}

1307 
št64_t
 
	$push
(
FILE
 *
å
, 
SOCKET
 
sock
, 
SSL
 *
s¦
, cÚ¡ *
buf
,

1308 
št64_t
 
Ën
) {

1309 
št64_t
 
£Á
;

1310 
n
, 
k
;

1312 
£Á
 = 0;

1313 
£Á
 < 
Ën
) {

1316 
k
 = 
Ën
 - 
£Á
 > 
INT_MAX
 ? INT_MAX : () (len - sent);

1318 ià(
s¦
 !ğ
NULL
) {

1319 
n
 = 
	`SSL_wr™e
(
s¦
, 
buf
 + 
£Á
, 
k
);

1320 } ià(
å
 !ğ
NULL
) {

1321 
n
 = (è
	`fwr™e
(
buf
 + 
£Á
, 1, (
size_t
)
k
, 
å
);

1322 ià(
	`ã¼Ü
(
å
))

1323 
n
 = -1;

1325 
n
 = (è
	`£nd
(
sock
, 
buf
 + 
£Á
, (
size_t
)
k
, 0);

1328 ià(
n
 < 0)

1331 
£Á
 +ğ
n
;

1334  
£Á
;

1335 
	}
}

1339 
	$puÎ
(
FILE
 *
å
, 
SOCKET
 
sock
, 
SSL
 *
s¦
, *
buf
, 
Ën
) {

1340 
Ä—d
;

1342 ià(
s¦
 !ğ
NULL
) {

1343 
Ä—d
 = 
	`SSL_»ad
(
s¦
, 
buf
, 
Ën
);

1344 } ià(
å
 !ğ
NULL
) {

1348 
Ä—d
 = (è
	`»ad
(
	`f’o
(
å
), 
buf
, (
size_t
è
Ën
);

1349 ià(
	`ã¼Ü
(
å
))

1350 
Ä—d
 = -1;

1352 
Ä—d
 = (è
	`»cv
(
sock
, 
buf
, (
size_t
è
Ën
, 0);

1355  
Ä—d
;

1356 
	}
}

1358 
	$mg_»ad
(
mg_cÚÃùiÚ
 *
cÚn
, *
buf
, 
size_t
 
Ën
) {

1359 
n
, 
bufã»d_Ën
, 
Ä—d
;

1360 cÚ¡ *
bufã»d
;

1362 
	`as£¹
(
cÚn
->
cÚ‹Á_Ën
 >ğcÚn->
cÚsumed_cÚ‹Á
);

1363 
	`DEBUG_TRACE
(("%°%zu %Îd %Îd", 
buf
, 
Ën
,

1364 
cÚn
->
cÚ‹Á_Ën
, cÚn->
cÚsumed_cÚ‹Á
));

1365 
Ä—d
 = 0;

1366 ià(
cÚn
->
cÚsumed_cÚ‹Á
 < cÚn->
cÚ‹Á_Ën
) {

1369 
št64_t
 
to_»ad
 = 
cÚn
->
cÚ‹Á_Ën
 - cÚn->
cÚsumed_cÚ‹Á
;

1370 ià(
to_»ad
 < (
št64_t
è
Ën
) {

1371 
Ën
 = (è
to_»ad
;

1375 
bufã»d
 = 
cÚn
->
buf
 + cÚn->
»que¡_Ën
 + cÚn->
cÚsumed_cÚ‹Á
;

1376 
bufã»d_Ën
 = 
cÚn
->
d©a_Ën
 - cÚn->
»que¡_Ën
;

1377 
	`as£¹
(
bufã»d_Ën
 >= 0);

1380 ià(
cÚn
->
cÚsumed_cÚ‹Á
 < (
št64_t
è
bufã»d_Ën
) {

1381 
bufã»d_Ën
 -ğ(è
cÚn
->
cÚsumed_cÚ‹Á
;

1382 ià(
Ën
 < (
size_t
è
bufã»d_Ën
) {

1383 
bufã»d_Ën
 = (è
Ën
;

1385 
	`memıy
(
buf
, 
bufã»d
, (
size_t
)
bufã»d_Ën
);

1386 
Ën
 -ğ
bufã»d_Ën
;

1387 
buf
 = (*èbuà+ 
bufã»d_Ën
;

1388 
cÚn
->
cÚsumed_cÚ‹Á
 +ğ
bufã»d_Ën
;

1389 
Ä—d
 = 
bufã»d_Ën
;

1393 
Ën
 > 0) {

1394 
n
 = 
	`puÎ
(
NULL
, 
cÚn
->
ş›Á
.
sock
, cÚn->
s¦
, (*è
buf
, (è
Ën
);

1395 ià(
n
 <= 0) {

1398 
buf
 = (*èbuà+ 
n
;

1399 
cÚn
->
cÚsumed_cÚ‹Á
 +ğ
n
;

1400 
Ä—d
 +ğ
n
;

1401 
Ën
 -ğ
n
;

1404  
Ä—d
;

1405 
	}
}

1407 
	$mg_wr™e
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

1408  (è
	`push
(
NULL
, 
cÚn
->
ş›Á
.
sock
, cÚn->
s¦
,

1409 (cÚ¡ *è
buf
, (
št64_t
è
Ën
);

1410 
	}
}

1412 
	$mg_´štf
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
fmt
, ...) {

1413 
buf
[
BUFSIZ
];

1414 
Ën
;

1415 
va_li¡
 
­
;

1417 
	`va_¡¬t
(
­
, 
fmt
);

1418 
Ën
 = 
	`mg_v¢´štf
(
cÚn
, 
buf
, (buf), 
fmt
, 
­
);

1419 
	`va_’d
(
­
);

1421  
	`mg_wr™e
(
cÚn
, 
buf
, (
size_t
)
Ën
);

1422 
	}
}

1429 
size_t
 
	$u¾_decode
(cÚ¡ *
¤c
, 
size_t
 
¤c_Ën
, *
d¡
,

1430 
size_t
 
d¡_Ën
, 
is_fÜm_u¾_’coded
) {

1431 
size_t
 
i
, 
j
;

1432 
a
, 
b
;

1433 
	#HEXTOI
(
x
è(
	`isdig™
(xè? x - '0' : x - 'W')

	)

1435 
i
 = 
j
 = 0; i < 
¤c_Ën
 && j < 
d¡_Ën
 - 1; i++, j++) {

1436 ià(
¤c
[
i
] == '%' &&

1437 
	`isxdig™
(* (cÚ¡ *è(
¤c
 + 
i
 + 1)) &&

1438 
	`isxdig™
(* (cÚ¡ *è(
¤c
 + 
i
 + 2))) {

1439 
a
 = 
	`tŞow”
(* (cÚ¡ *è(
¤c
 + 
i
 + 1));

1440 
b
 = 
	`tŞow”
(* (cÚ¡ *è(
¤c
 + 
i
 + 2));

1441 
d¡
[
j
] = (è((
	`HEXTOI
(
a
è<< 4è| HEXTOI(
b
));

1442 
i
 += 2;

1443 } ià(
is_fÜm_u¾_’coded
 && 
¤c
[
i
] == '+') {

1444 
d¡
[
j
] = ' ';

1446 
d¡
[
j
] = 
¤c
[
i
];

1450 
d¡
[
j
] = '\0';

1452  
j
;

1453 
	}
}

1459 
	$mg_g‘_v¬
(cÚ¡ *
buf
, 
size_t
 
buf_Ën
, cÚ¡ *
Çme
,

1460 *
d¡
, 
size_t
 
d¡_Ën
) {

1461 cÚ¡ *
p
, *
e
, *
s
;

1462 
size_t
 
Çme_Ën
, 
Ën
;

1464 
Çme_Ën
 = 
	`¡¾’
(
Çme
);

1465 
e
 = 
buf
 + 
buf_Ën
;

1466 
Ën
 = -1;

1467 
d¡
[0] = '\0';

1470 
p
 = 
buf
;… !ğ
NULL
 &&… + 
Çme_Ën
 < 
e
;…++) {

1471 ià((
p
 =ğ
buf
 ||…[-1] =ğ'&'è&&…[
Çme_Ën
] == '=' &&

1472 !
	`mg_¡ºÿ£cmp
(
Çme
, 
p
, 
Çme_Ën
)) {

1475 
p
 +ğ
Çme_Ën
 + 1;

1478 
s
 = (cÚ¡ *è
	`memchr
(
p
, '&', (
size_t
)(
e
 -…));

1479 ià(
s
 =ğ
NULL
) {

1480 
s
 = 
e
;

1482 
	`as£¹
(
s
 >ğ
p
);

1485 ià((
size_t
è(
s
 - 
p
è< 
d¡_Ën
) {

1486 
Ën
 = 
	`u¾_decode
(
p
, (
size_t
)(
s
 -…), 
d¡
, 
d¡_Ën
, 1);

1492  (è
Ën
;

1493 
	}
}

1495 
	$mg_g‘_cook›
(cÚ¡ 
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
cook›_Çme
,

1496 *
d¡
, 
size_t
 
d¡_size
) {

1497 cÚ¡ *
s
, *
p
, *
’d
;

1498 
Çme_Ën
, 
Ën
 = -1;

1500 
d¡
[0] = '\0';

1501 ià((
s
 = 
	`mg_g‘_h—d”
(
cÚn
, "Cook›")è=ğ
NULL
) {

1505 
Çme_Ën
 = (è
	`¡¾’
(
cook›_Çme
);

1506 
’d
 = 
s
 + 
	`¡¾’
(s);

1508 ; (
s
 = 
	`¡r¡r
(s, 
cook›_Çme
)è!ğ
NULL
; s +ğ
Çme_Ën
)

1509 ià(
s
[
Çme_Ën
] == '=') {

1510 
s
 +ğ
Çme_Ën
 + 1;

1511 ià((
p
 = 
	`¡rchr
(
s
, ' ')è=ğ
NULL
)

1512 
p
 = 
’d
;

1513 ià(
p
[-1] == ';')

1514 
p
--;

1515 ià(*
s
 =ğ'"' && 
p
[-1] == '"' &&… > s + 1) {

1516 
s
++;

1517 
p
--;

1519 ià((
size_t
è(
p
 - 
s
è< 
d¡_size
) {

1520 
Ën
 = (è((
p
 - 
s
) + 1);

1521 
	`mg_¡¾ıy
(
d¡
, 
s
, (
size_t
)
Ën
);

1526  
Ën
;

1527 
	}
}

1532 
	$g‘_docum’t_roÙ
(cÚ¡ 
mg_cÚÃùiÚ
 *
cÚn
,

1533 
vec
 *
docum’t_roÙ
) {

1534 cÚ¡ *
roÙ
, *
uri
;

1535 
Ën_of_m©ched_uri
;

1536 
vec
 
uri_vec
, 
·th_vec
;

1538 
uri
 = 
cÚn
->
»que¡_šfo
.uri;

1539 
Ën_of_m©ched_uri
 = 0;

1540 
roÙ
 = 
	`Ãxt_İtiÚ
(
cÚn
->
ùx
->
cÚfig
[
DOCUMENT_ROOT
], 
docum’t_roÙ
, 
NULL
);

1542 (
roÙ
 = 
	`Ãxt_İtiÚ
ÔoÙ, &
uri_vec
, &
·th_vec
)è!ğ
NULL
) {

1543 ià(
	`memcmp
(
uri
, 
uri_vec
.
±r
, uri_vec.
Ën
) == 0) {

1544 *
docum’t_roÙ
 = 
·th_vec
;

1545 
Ën_of_m©ched_uri
 = (è
uri_vec
.
Ën
;

1550  
Ën_of_m©ched_uri
;

1551 
	}
}

1553 
	$cÚv”t_uri_to_fe_Çme
(
mg_cÚÃùiÚ
 *
cÚn
,

1554 cÚ¡ *
uri
, *
buf
,

1555 
size_t
 
buf_Ën
) {

1556 
vec
 vec;

1557 
m©ch_Ën
;

1559 
m©ch_Ën
 = 
	`g‘_docum’t_roÙ
(
cÚn
, &
vec
);

1560 
	`mg_¢´štf
(
cÚn
, 
buf
, 
buf_Ën
, "%.*s%s", 
vec
.
Ën
, vec.
±r
, 
uri
 + 
m©ch_Ën
);

1562 #ifdeà
_WIN32


1563 
	`chªge_¦ashes_to_back¦ashes
(
buf
);

1566 
	`DEBUG_TRACE
(("[%s] -> [%s], [%.*s]", 
uri
, 
buf
, (è
vec
.
Ën
, vec.
±r
));

1567 
	}
}

1569 
s¦ize
(
mg_cÚÃùiÚ
 *
cÚn
, (*
func
)(
SSL
 *)) {

1570  (
cÚn
->
s¦
 = 
	`SSL_Ãw
(cÚn->
ùx
->
s¦_ùx
)è!ğ
NULL
 &&

1571 
	`SSL_£t_fd
(
cÚn
->
s¦
, cÚn->
ş›Á
.
sock
) == 1 &&

1572 
	`func
(
cÚn
->
s¦
) == 1;

1573 
	}
}

1575 
mg_cÚÃùiÚ
 *
	$mg_cÚÃù
(
mg_cÚÃùiÚ
 *
cÚn
,

1576 cÚ¡ *
ho¡
, 
pÜt
, 
u£_s¦
) {

1577 
mg_cÚÃùiÚ
 *
ÃwcÚn
 = 
NULL
;

1578 
sockaddr_š
 
sš
;

1579 
ho¡’t
 *
he
;

1580 
sock
;

1582 ià(
cÚn
->
ùx
->
s¦_ùx
 =ğ
NULL
 && 
u£_s¦
) {

1583 
	`üy
(
cÚn
, "%s: SSL i nÙ in™Ÿlized", 
__func__
);

1584 } ià((
he
 = 
	`g‘ho¡byÇme
(
ho¡
)è=ğ
NULL
) {

1585 
	`üy
(
cÚn
, "%s: g‘ho¡byÇme(%s): %s", 
__func__
, 
ho¡
, 
	`¡»¼Ü
(
ERRNO
));

1586 } ià((
sock
 = 
	`sock‘
(
PF_INET
, 
SOCK_STREAM
, 0)è=ğ
INVALID_SOCKET
) {

1587 
	`üy
(
cÚn
, "%s: sock‘: %s", 
__func__
, 
	`¡»¼Ü
(
ERRNO
));

1589 
sš
.
sš_çmy
 = 
AF_INET
;

1590 
sš
.
sš_pÜt
 = 
	`htÚs
((
ušt16_t
è
pÜt
);

1591 
sš
.
sš_addr
 = * (
š_addr
 *è
he
->
h_addr_li¡
[0];

1592 ià(
	`cÚÃù
(
sock
, (
sockaddr
 *è&
sš
, (sin)) != 0) {

1593 
	`üy
(
cÚn
, "%s: cÚÃù(%s:%d): %s", 
__func__
, 
ho¡
, 
pÜt
,

1594 
	`¡»¼Ü
(
ERRNO
));

1595 
	`şo£sock‘
(
sock
);

1596 } ià((
ÃwcÚn
 = (
mg_cÚÃùiÚ
*è
	`ÿÎoc
(1, (*ÃwcÚn))è=ğ
NULL
) {

1597 
	`üy
(
cÚn
, "%s: c®loc: %s", 
__func__
, 
	`¡»¼Ü
(
ERRNO
));

1598 
	`şo£sock‘
(
sock
);

1600 
ÃwcÚn
->
ş›Á
.
sock
 = sock;

1601 
ÃwcÚn
->
ş›Á
.
r§
.
u
.
sš
 = sin;

1602 ià(
u£_s¦
) {

1603 
	`s¦ize
(
ÃwcÚn
, 
SSL_cÚÃù
);

1608  
ÃwcÚn
;

1609 
	}
}

1615 
	$g‘_»que¡_Ën
(cÚ¡ *
buf
, 
buæ’
) {

1616 cÚ¡ *
s
, *
e
;

1617 
Ën
 = 0;

1619 
	`DEBUG_TRACE
(("buf: %p,†’: %d", 
buf
, 
buæ’
));

1620 
s
 = 
buf
, 
e
 = s + 
buæ’
 - 1; 
Ën
 <= 0 && s <ƒ; s++)

1622 ià(!
	`i¥ršt
(* (cÚ¡ *è
s
) && *s != '\r' &&

1623 *
s
 != '\n' && * (const *) s < 128) {

1624 
Ën
 = -1;

1625 } ià(
s
[0] == '\n' && s[1] == '\n') {

1626 
Ën
 = (è(
s
 - 
buf
) + 2;

1627 } ià(
s
[0] =ğ'\n' && &s[1] < 
e
 &&

1628 
s
[1] == '\r' && s[2] == '\n') {

1629 
Ën
 = (è(
s
 - 
buf
) + 3;

1632  
Ën
;

1633 
	}
}

1636 
	$mÚth_numb”_to_mÚth_Çme
(cÚ¡ *
s
) {

1637 
size_t
 
i
;

1639 
i
 = 0; i < 
	`ARRAY_SIZE
(
mÚth_Çmes
); i++)

1640 ià(!
	`¡rcmp
(
s
, 
mÚth_Çmes
[
i
]))

1641  (è
i
;

1644 
	}
}

1647 
time_t
 
	$·r£_d©e_¡ršg
(cÚ¡ *
s
) {

1648 
time_t
 
cu¼’t_time
;

1649 
tm
m, *
tmp
;

1650 
mÚ
[32];

1651 
£c
, 
mš
, 
hour
, 
mday
, 
mÚth
, 
y—r
;

1653 (è
	`mem£t
(&
tm
, 0, (tm));

1654 
£c
 = 
mš
 = 
hour
 = 
mday
 = 
mÚth
 = 
y—r
 = 0;

1656 ià(((
	`ssÿnf
(
s
, "%d/%3s/%d %d:%d:%d",

1657 &
mday
, 
mÚ
, &
y—r
, &
hour
, &
mš
, &
£c
) == 6) ||

1658 (
	`ssÿnf
(
s
, "%d %3s %d %d:%d:%d",

1659 &
mday
, 
mÚ
, &
y—r
, &
hour
, &
mš
, &
£c
) == 6) ||

1660 (
	`ssÿnf
(
s
, "%*3s, %d %3s %d %d:%d:%d",

1661 &
mday
, 
mÚ
, &
y—r
, &
hour
, &
mš
, &
£c
) == 6) ||

1662 (
	`ssÿnf
(
s
, "%d-%3s-%d %d:%d:%d",

1663 &
mday
, 
mÚ
, &
y—r
, &
hour
, &
mš
, &
£c
) == 6)) &&

1664 (
mÚth
 = 
	`mÚth_numb”_to_mÚth_Çme
(
mÚ
)) != -1) {

1665 
tm
.
tm_mday
 = 
mday
;

1666 
tm
.
tm_mÚ
 = 
mÚth
;

1667 
tm
.
tm_y—r
 = 
y—r
;

1668 
tm
.
tm_hour
 = 
hour
;

1669 
tm
.
tm_mš
 = 
mš
;

1670 
tm
.
tm_£c
 = 
£c
;

1673 ià(
tm
.
tm_y—r
 > 1900) {

1674 
tm
.
tm_y—r
 -= 1900;

1675 } ià(
tm
.
tm_y—r
 < 70) {

1676 
tm
.
tm_y—r
 += 100;

1680 
cu¼’t_time
 = 
	`time
(
NULL
);

1681 
tmp
 = 
	`loÿÉime
(&
cu¼’t_time
);

1682 
tm
.
tm_isd¡
 = 
tmp
->tm_isdst;

1684  
	`mktime
(&
tm
);

1685 
	}
}

1689 
	$»move_doubË_dÙs_ªd_doubË_¦ashes
(*
s
) {

1690 *
p
 = 
s
;

1692 *
s
 != '\0') {

1693 *
p
++ = *
s
++;

1694 ià(
s
[-1] == '/' || s[-1] == '\\') {

1696 *
s
 == '/' || *s == '\\') {

1697 
s
++;

1701 *
s
 == '.' && s[1] == '.') {

1702 
s
 += 2;

1706 *
p
 = '\0';

1707 
	}
}

1710 cÚ¡ *
	mex‹nsiÚ
;

1711 
size_t
 
	mext_Ën
;

1712 cÚ¡ *
	mmime_ty³
;

1713 
size_t
 
	mmime_ty³_Ën
;

1714 } 
	gbutš_mime_ty³s
[] = {

1753 {
NULL
, 0, NULL, 0}

1758 
	$g‘_mime_ty³
(
mg_cÚ‹xt
 *
ùx
, cÚ¡ *
·th
,

1759 
vec
 *vec) {

1760 
vec
 
ext_vec
, 
mime_vec
;

1761 cÚ¡ *
li¡
, *
ext
;

1762 
size_t
 
i
, 
·th_Ën
;

1764 
·th_Ën
 = 
	`¡¾’
(
·th
);

1768 
li¡
 = 
ùx
->
cÚfig
[
EXTRA_MIME_TYPES
];

1769 (
li¡
 = 
	`Ãxt_İtiÚ
Öi¡, &
ext_vec
, &
mime_vec
)è!ğ
NULL
) {

1771 
ext
 = 
·th
 + 
·th_Ën
 - 
ext_vec
.
Ën
;

1772 ià(
	`mg_¡ºÿ£cmp
(
ext
, 
ext_vec
.
±r
,ƒxt_vec.
Ën
) == 0) {

1773 *
vec
 = 
mime_vec
;

1779 
i
 = 0; 
butš_mime_ty³s
[i].
ex‹nsiÚ
 !ğ
NULL
; i++) {

1780 
ext
 = 
·th
 + (
·th_Ën
 - 
butš_mime_ty³s
[
i
].
ext_Ën
);

1781 ià(
·th_Ën
 > 
butš_mime_ty³s
[
i
].
ext_Ën
 &&

1782 
	`mg_¡rÿ£cmp
(
ext
, 
butš_mime_ty³s
[
i
].
ex‹nsiÚ
) == 0) {

1783 
vec
->
±r
 = 
butš_mime_ty³s
[
i
].
mime_ty³
;

1784 
vec
->
Ën
 = 
butš_mime_ty³s
[
i
].
mime_ty³_Ën
;

1790 
vec
->
±r
 = "text/plain";

1791 
vec
->
Ën
 = 10;

1792 
	}
}

1794 #iâdeà
HAVE_MD5


1795 
	sMD5CÚ‹xt
 {

1796 
ušt32_t
 
	mbuf
[4];

1797 
ušt32_t
 
	mb™s
[2];

1798 
	mš
[64];

1799 } 
	tMD5_CTX
;

1801 #ià
defšed
(
__BYTE_ORDER
) && (__BYTE_ORDER == 1234)

1802 
	#by‹Rev”£
(
buf
, 
Ën
)

1803 #–£

	)

1804 
	$by‹Rev”£
(*
buf
, 
lÚgs
) {

1805 
ušt32_t
 
t
;

1807 
t
 = (
ušt32_t
è((è
buf
[3] << 8 | buf[2]) << 16 |

1808 ((è
buf
[1] << 8 | buf[0]);

1809 *(
ušt32_t
 *è
buf
 = 
t
;

1810 
buf
 += 4;

1811 } --
lÚgs
);

1812 
	}
}

1815 
	#F1
(
x
, 
y
, 
z
è(z ^ (x & (y ^ z)))

	)

1816 
	#F2
(
x
, 
y
, 
z
è
	`F1
(z, x, y)

	)

1817 
	#F3
(
x
, 
y
, 
z
è(x ^ y ^ z)

	)

1818 
	#F4
(
x
, 
y
, 
z
è(y ^ (x | ~z))

	)

1820 
	#MD5STEP
(
f
, 
w
, 
x
, 
y
, 
z
, 
d©a
, 
s
è\

	)

1821 Ğ
	gw
 +ğ
f
(
x
, 
y
, 
z
è+ 
	gd©a
, w = 
w
<<
s
 | w>>(32-s), w += x )

1825 
	$MD5In™
(
MD5_CTX
 *
ùx
) {

1826 
ùx
->
buf
[0] = 0x67452301;

1827 
ùx
->
buf
[1] = 0xefcdab89;

1828 
ùx
->
buf
[2] = 0x98badcfe;

1829 
ùx
->
buf
[3] = 0x10325476;

1831 
ùx
->
b™s
[0] = 0;

1832 
ùx
->
b™s
[1] = 0;

1833 
	}
}

1835 
	$MD5T¿nsfÜm
(
ušt32_t
 
buf
[4], ušt32_ˆcÚ¡ 
š
[16]) {

1836 
ušt32_t
 
a
, 
b
, 
c
, 
d
;

1838 
a
 = 
buf
[0];

1839 
b
 = 
buf
[1];

1840 
c
 = 
buf
[2];

1841 
d
 = 
buf
[3];

1843 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 0xd76aa478, 7);

1844 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[1] + 0xe8c7b756, 12);

1845 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 0x242070db, 17);

1846 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[3] + 0xc1bdceee, 22);

1847 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[4] + 0xf57c0faf, 7);

1848 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[5] + 0x4787c62a, 12);

1849 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[6] + 0xa8304613, 17);

1850 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[7] + 0xfd469501, 22);

1851 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[8] + 0x698098d8, 7);

1852 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[9] + 0x8b44f7af, 12);

1853 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[10] + 0xffff5bb1, 17);

1854 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[11] + 0x895cd7be, 22);

1855 
	`MD5STEP
(
F1
, 
a
, 
b
, 
c
, 
d
, 
š
[12] + 0x6b901122, 7);

1856 
	`MD5STEP
(
F1
, 
d
, 
a
, 
b
, 
c
, 
š
[13] + 0xfd987193, 12);

1857 
	`MD5STEP
(
F1
, 
c
, 
d
, 
a
, 
b
, 
š
[14] + 0xa679438e, 17);

1858 
	`MD5STEP
(
F1
, 
b
, 
c
, 
d
, 
a
, 
š
[15] + 0x49b40821, 22);

1860 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 0xf61e2562, 5);

1861 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[6] + 0xc040b340, 9);

1862 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[11] + 0x265e5a51, 14);

1863 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[0] + 0xe9b6c7aa, 20);

1864 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[5] + 0xd62f105d, 5);

1865 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[10] + 0x02441453, 9);

1866 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[15] + 0xd8a1e681, 14);

1867 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[4] + 0xe7d3fbc8, 20);

1868 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[9] + 0x21e1cde6, 5);

1869 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[14] + 0xc33707d6, 9);

1870 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[3] + 0xf4d50d87, 14);

1871 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[8] + 0x455a14ed, 20);

1872 
	`MD5STEP
(
F2
, 
a
, 
b
, 
c
, 
d
, 
š
[13] + 0xa9e3e905, 5);

1873 
	`MD5STEP
(
F2
, 
d
, 
a
, 
b
, 
c
, 
š
[2] + 0xfcefa3f8, 9);

1874 
	`MD5STEP
(
F2
, 
c
, 
d
, 
a
, 
b
, 
š
[7] + 0x676f02d9, 14);

1875 
	`MD5STEP
(
F2
, 
b
, 
c
, 
d
, 
a
, 
š
[12] + 0x8d2a4c8a, 20);

1877 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[5] + 0xfffa3942, 4);

1878 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[8] + 0x8771f681, 11);

1879 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[11] + 0x6d9d6122, 16);

1880 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[14] + 0xfde5380c, 23);

1881 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[1] + 0xa4beea44, 4);

1882 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[4] + 0x4bdecfa9, 11);

1883 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[7] + 0xf6bb4b60, 16);

1884 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[10] + 0xbebfbc70, 23);

1885 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[13] + 0x289b7ec6, 4);

1886 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[0] + 0xeaa127fa, 11);

1887 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[3] + 0xd4ef3085, 16);

1888 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[6] + 0x04881d05, 23);

1889 
	`MD5STEP
(
F3
, 
a
, 
b
, 
c
, 
d
, 
š
[9] + 0xd9d4d039, 4);

1890 
	`MD5STEP
(
F3
, 
d
, 
a
, 
b
, 
c
, 
š
[12] + 0xe6db99e5, 11);

1891 
	`MD5STEP
(
F3
, 
c
, 
d
, 
a
, 
b
, 
š
[15] + 0x1fa27cf8, 16);

1892 
	`MD5STEP
(
F3
, 
b
, 
c
, 
d
, 
a
, 
š
[2] + 0xc4ac5665, 23);

1894 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[0] + 0xf4292244, 6);

1895 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[7] + 0x432aff97, 10);

1896 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[14] + 0xab9423a7, 15);

1897 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[5] + 0xfc93a039, 21);

1898 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[12] + 0x655b59c3, 6);

1899 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[3] + 0x8f0ccc92, 10);

1900 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[10] + 0xffeff47d, 15);

1901 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[1] + 0x85845dd1, 21);

1902 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[8] + 0x6fa87e4f, 6);

1903 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[15] + 0xfe2ce6e0, 10);

1904 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[6] + 0xa3014314, 15);

1905 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[13] + 0x4e0811a1, 21);

1906 
	`MD5STEP
(
F4
, 
a
, 
b
, 
c
, 
d
, 
š
[4] + 0xf7537e82, 6);

1907 
	`MD5STEP
(
F4
, 
d
, 
a
, 
b
, 
c
, 
š
[11] + 0xbd3af235, 10);

1908 
	`MD5STEP
(
F4
, 
c
, 
d
, 
a
, 
b
, 
š
[2] + 0x2ad7d2bb, 15);

1909 
	`MD5STEP
(
F4
, 
b
, 
c
, 
d
, 
a
, 
š
[9] + 0xeb86d391, 21);

1911 
buf
[0] +ğ
a
;

1912 
buf
[1] +ğ
b
;

1913 
buf
[2] +ğ
c
;

1914 
buf
[3] +ğ
d
;

1915 
	}
}

1917 
	$MD5Upd©e
(
MD5_CTX
 *
ùx
, cÚ¡ *
buf
, 
Ën
) {

1918 
ušt32_t
 
t
;

1920 
t
 = 
ùx
->
b™s
[0];

1921 ià((
ùx
->
b™s
[0] = 
t
 + ((
ušt32_t
è
Ën
 << 3)) <)

1922 
ùx
->
b™s
[1]++;

1923 
ùx
->
b™s
[1] +ğ
Ën
 >> 29;

1925 
t
 = (t >> 3) & 0x3f;

1927 ià(
t
) {

1928 *
p
 = (*è
ùx
->
š
 + 
t
;

1930 
t
 = 64 -;

1931 ià(
Ën
 < 
t
) {

1932 
	`memıy
(
p
, 
buf
, 
Ën
);

1935 
	`memıy
(
p
, 
buf
, 
t
);

1936 
	`by‹Rev”£
(
ùx
->
š
, 16);

1937 
	`MD5T¿nsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

1938 
buf
 +ğ
t
;

1939 
Ën
 -ğ
t
;

1942 
Ën
 >= 64) {

1943 
	`memıy
(
ùx
->
š
, 
buf
, 64);

1944 
	`by‹Rev”£
(
ùx
->
š
, 16);

1945 
	`MD5T¿nsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

1946 
buf
 += 64;

1947 
Ën
 -= 64;

1950 
	`memıy
(
ùx
->
š
, 
buf
, 
Ën
);

1951 
	}
}

1953 
	$MD5Fš®
(
dige¡
[16], 
MD5_CTX
 *
ùx
) {

1954 
couÁ
;

1955 *
p
;

1957 
couÁ
 = (
ùx
->
b™s
[0] >> 3) & 0x3F;

1959 
p
 = 
ùx
->
š
 + 
couÁ
;

1960 *
p
++ = 0x80;

1961 
couÁ
 = 64 - 1 - count;

1962 ià(
couÁ
 < 8) {

1963 
	`mem£t
(
p
, 0, 
couÁ
);

1964 
	`by‹Rev”£
(
ùx
->
š
, 16);

1965 
	`MD5T¿nsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

1966 
	`mem£t
(
ùx
->
š
, 0, 56);

1968 
	`mem£t
(
p
, 0, 
couÁ
 - 8);

1970 
	`by‹Rev”£
(
ùx
->
š
, 14);

1972 ((
ušt32_t
 *è
ùx
->
š
)[14] = ctx->
b™s
[0];

1973 ((
ušt32_t
 *è
ùx
->
š
)[15] = ctx->
b™s
[1];

1975 
	`MD5T¿nsfÜm
(
ùx
->
buf
, (
ušt32_t
 *èùx->
š
);

1976 
	`by‹Rev”£
((*è
ùx
->
buf
, 4);

1977 
	`memıy
(
dige¡
, 
ùx
->
buf
, 16);

1978 
	`mem£t
((*è
ùx
, 0, (ctx));

1979 
	}
}

1984 
	$bš2¡r
(*
to
, cÚ¡ *
p
, 
size_t
 
Ën
) {

1985 cÚ¡ *
hex
 = "0123456789abcdef";

1987 ; 
Ën
--; 
p
++) {

1988 *
to
++ = 
hex
[
p
[0] >> 4];

1989 *
to
++ = 
hex
[
p
[0] & 0x0f];

1991 *
to
 = '\0';

1992 
	}
}

1995 
	$mg_md5
(*
buf
, ...) {

1996 
hash
[16];

1997 cÚ¡ *
p
;

1998 
va_li¡
 
­
;

1999 
MD5_CTX
 
ùx
;

2001 
	`MD5In™
(&
ùx
);

2003 
	`va_¡¬t
(
­
, 
buf
);

2004 (
p
 = 
	`va_¬g
(
­
, cÚ¡ *)è!ğ
NULL
) {

2005 
	`MD5Upd©e
(&
ùx
, (cÚ¡ *è
p
, (è
	`¡¾’
(p));

2007 
	`va_’d
(
­
);

2009 
	`MD5Fš®
(
hash
, &
ùx
);

2010 
	`bš2¡r
(
buf
, 
hash
, (hash));

2011 
	}
}

2014 
	$check_·sswÜd
(
mg_cÚÃùiÚ
 *
cÚn
) {

2015 
ha2
[32 + 1], 
ex³ùed_»¥Ú£
[32 + 1];

2016 
mg_auth_h—d”
 *
ah
 = 
cÚn
->
»que¡_šfo
.ah;

2019 ià(
cÚn
->
»que¡_šfo
.
»que¡_m‘hod
 =ğ
NULL
 || 
ah
 == NULL ||

2020 
ah
->
nÚû
 =ğ
NULL
 ||‡h->
nc
 == NULL ||

2021 
ah
->
úÚû
 =ğ
NULL
 ||‡h->
qİ
 =ğNULL ||‡h->
uri
 == NULL ||

2022 
ah
->
»¥Ú£
 =ğ
NULL
) {

2029 
	`¡¾’
(
ah
->
»¥Ú£
) != 32

2035 
	`mg_md5
(
ha2
, 
cÚn
->
»que¡_šfo
.
»que¡_m‘hod
, ":", 
ah
->
uri
, 
NULL
);

2036 
	`mg_md5
(
ex³ùed_»¥Ú£
, 
ah
->
ha1
, ":",‡h->
nÚû
, ":",‡h->
nc
,

2037 ":", 
ah
->
úÚû
, ":",‡h->
qİ
, ":", 
ha2
, 
NULL
);

2039  
	`mg_¡rÿ£cmp
(
ah
->
»¥Ú£
, 
ex³ùed_»¥Ú£
) == 0;

2040 
	}
}

2044 
FILE
 *
	$İ’_auth_fe
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
·th
) {

2045 
mg_cÚ‹xt
 *
ùx
 = 
cÚn
->ctx;

2046 
Çme
[
PATH_MAX
];

2047 cÚ¡ *
p
, *
e
;

2048 
mg¡©
 
¡
;

2049 
FILE
 *
å
;

2051 ià(
ùx
->
cÚfig
[
GLOBAL_PASSWORDS_FILE
] !ğ
NULL
) {

2053 
å
 = 
	`mg_fİ’
(
ùx
->
cÚfig
[
GLOBAL_PASSWORDS_FILE
], "r");

2054 ià(
å
 =ğ
NULL
)

2055 
	`üy
(
	`fc
(
ùx
), "fopen(%s): %s",

2056 
ùx
->
cÚfig
[
GLOBAL_PASSWORDS_FILE
], 
	`¡»¼Ü
(
ERRNO
));

2057 } ià(!
	`mg_¡©
(
·th
, &
¡
è&& st.
is_dœeùÜy
) {

2058 (è
	`mg_¢´štf
(
cÚn
, 
Çme
, (name), "%s%c%s",

2059 
·th
, 
DIRSEP
, 
PASSWORDS_FILE_NAME
);

2060 
å
 = 
	`mg_fİ’
(
Çme
, "r");

2063 
p
 = 
·th
, 
e
 =… + 
	`¡¾’
(p) - 1;ƒ >…;ƒ--)

2064 ià(
	`IS_DIRSEP_CHAR
(*
e
))

2066 (è
	`mg_¢´štf
(
cÚn
, 
Çme
, (name), "%.*s%c%s",

2067 (è(
e
 - 
p
),…, 
DIRSEP
, 
PASSWORDS_FILE_NAME
);

2068 
å
 = 
	`mg_fİ’
(
Çme
, "r");

2071  
å
;

2072 
	}
}

2074 
	$·r£_auth_h—d”
(
mg_cÚÃùiÚ
 *
cÚn
) {

2075 *
Çme
, *
v®ue
, *
s
;

2076 cÚ¡ *
auth_h—d”
;

2078 ià((
auth_h—d”
 = 
	`mg_g‘_h—d”
(
cÚn
, "AuthÜiz©iÚ")è=ğ
NULL
 ||

2079 
	`mg_¡ºÿ£cmp
(
auth_h—d”
, "Digest ", 7) != 0) {

2084 
cÚn
->
auth_h—d”
 = 
	`mg_¡rdup
(auth_header + 7);

2085 
s
 = 
cÚn
->
auth_h—d”
;

2087 
cÚn
->
»que¡_šfo
.
ah
 = (
mg_auth_h—d”
*è
	`ÿÎoc
(1, (mg_auth_header));

2092 
	`is¥aû
(* (*è
s
)) {

2093 
s
++;

2095 
Çme
 = 
	`sk_quÙed
(&
s
, "=", " ", 0);

2097 ià(
s
[0] == '\"') {

2098 
s
++;

2099 
v®ue
 = 
	`sk_quÙed
(&
s
, "\"", " ", '\\');

2100 ià(
s
[0] == ',') {

2101 
s
++;

2106 
v®ue
 = 
	`sk_quÙed
(&
s
, ", ", " ", 0);

2108 ià(*
Çme
 == '\0') {

2112 ià(!
	`¡rcmp
(
Çme
, "username")) {

2113 
cÚn
->
»que¡_šfo
.
ah
->
u£r
 = 
v®ue
;

2114 } ià(!
	`¡rcmp
(
Çme
, "cnonce")) {

2115 
cÚn
->
»que¡_šfo
.
ah
->
úÚû
 = 
v®ue
;

2116 } ià(!
	`¡rcmp
(
Çme
, "response")) {

2117 
cÚn
->
»que¡_šfo
.
ah
->
»¥Ú£
 = 
v®ue
;

2118 } ià(!
	`¡rcmp
(
Çme
, "uri")) {

2119 
cÚn
->
»que¡_šfo
.
ah
->
uri
 = 
v®ue
;

2120 } ià(!
	`¡rcmp
(
Çme
, "qop")) {

2121 
cÚn
->
»que¡_šfo
.
ah
->
qİ
 = 
v®ue
;

2122 } ià(!
	`¡rcmp
(
Çme
, "nc")) {

2123 
cÚn
->
»que¡_šfo
.
ah
->
nc
 = 
v®ue
;

2124 } ià(!
	`¡rcmp
(
Çme
, "nonce")) {

2125 
cÚn
->
»que¡_šfo
.
ah
->
nÚû
 = 
v®ue
;

2130 ià(
cÚn
->
»que¡_šfo
.
ah
->
u£r
 !ğ
NULL
) {

2131 
cÚn
->
»que¡_šfo
.
»mÙe_u£r
 = 
	`mg_¡rdup
(cÚn->»que¡_šfo.
ah
->
u£r
);

2134 
	`ä“
(
cÚn
->
»que¡_šfo
.
ah
);

2135 
cÚn
->
»que¡_šfo
.
ah
 = 
NULL
;

2136 
	`ä“
(
cÚn
->
auth_h—d”
);

2137 
cÚn
->
auth_h—d”
 = 
NULL
;

2139 
	}
}

2142 
	$authÜize_äom_fe
(
mg_cÚÃùiÚ
 *
cÚn
, 
FILE
 *
å
) {

2143 
lše
[256], 
f_u£r
[256], 
ha1
[256], 
f_domaš
[256];

2145 ià(
cÚn
->
»que¡_šfo
.
ah
 =ğ
NULL
)

2149 
	`fg‘s
(
lše
, Öše), 
å
è!ğ
NULL
) {

2150 ià(
	`ssÿnf
(
lše
, "%[^:]:%[^:]:%s", 
f_u£r
, 
f_domaš
, 
ha1
) != 3) {

2154 ià(!
	`¡rcmp
(
cÚn
->
»que¡_šfo
.
ah
->
u£r
, 
f_u£r
) &&

2155 !
	`¡rcmp
(
cÚn
->
ùx
->
cÚfig
[
AUTHENTICATION_DOMAIN
], 
f_domaš
)) {

2156 
cÚn
->
»que¡_šfo
.
ah
->
ha1
 = 
	`mg_¡rdup
(ha1);

2157  
	`check_·sswÜd
(
cÚn
);

2162 
	}
}

2165 
	$check_authÜiz©iÚ
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
·th
) {

2166 
FILE
 *
å
;

2167 
âame
[
PATH_MAX
];

2168 
vec
 
uri_vec
, 
f’ame_vec
;

2169 cÚ¡ *
li¡
;

2170 
authÜized
;

2173 ià(
cÚn
->
»que¡_šfo
.
ah
 !ğ
NULL
 &&

2174 
cÚn
->
»que¡_šfo
.
ah
->
ha1
 !ğ
NULL
) {

2175  
	`check_·sswÜd
(
cÚn
);

2178 
å
 = 
NULL
;

2179 
authÜized
 = 1;

2181 
li¡
 = 
cÚn
->
ùx
->
cÚfig
[
PROTECT_URI
];

2182 (
li¡
 = 
	`Ãxt_İtiÚ
Öi¡, &
uri_vec
, &
f’ame_vec
)è!ğ
NULL
) {

2183 ià(!
	`memcmp
(
cÚn
->
»que¡_šfo
.
uri
, 
uri_vec
.
±r
, uri_vec.
Ën
)) {

2184 (è
	`mg_¢´štf
(
cÚn
, 
âame
, (fname), "%.*s",

2185 
f’ame_vec
.
Ën
, f’ame_vec.
±r
);

2186 ià((
å
 = 
	`mg_fİ’
(
âame
, "r")è=ğ
NULL
) {

2187 
	`üy
(
cÚn
, "%s: cªnÙ o³À%s: %s", 
__func__
, 
âame
, 
	`¡»¼Ü
(
”ºo
));

2193 ià(
å
 =ğ
NULL
) {

2194 
å
 = 
	`İ’_auth_fe
(
cÚn
, 
·th
);

2197 ià(
å
 !ğ
NULL
) {

2198 
authÜized
 = 
	`authÜize_äom_fe
(
cÚn
, 
å
);

2199 (è
	`fşo£
(
å
);

2202  
authÜized
;

2203 
	}
}

2205 
	$mg_£nd_authÜiz©iÚ_»que¡
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
nÚû
) {

2206 
cÚn
->
»que¡_šfo
.
¡©us_code
 = 401;

2207 (è
	`mg_´štf
(
cÚn
,

2211 
cÚn
->
ùx
->
cÚfig
[
AUTHENTICATION_DOMAIN
]);

2212 ià(
nÚû
 =ğ
NULL
)

2213 (è
	`mg_´štf
(
cÚn
, "%lu", (è
	`time
(
NULL
));

2215 (è
	`mg_´štf
(
cÚn
, "%s", 
nÚû
);

2216 (è
	`mg_´štf
(
cÚn
, "\"\r\n\r\n");

2217 
	}
}

2219 
	$is_authÜized_fÜ_put
(
mg_cÚÃùiÚ
 *
cÚn
) {

2220 
FILE
 *
å
;

2221 
»t
 = 0;

2225 
å
 = 
cÚn
->
ùx
->
cÚfig
[
PUT_DELETE_PASSWORDS_FILE
] =ğ
NULL
 ? NULL :

2226 
	`mg_fİ’
(
cÚn
->
ùx
->
cÚfig
[
PUT_DELETE_PASSWORDS_FILE
], "r");

2228 ià(
å
 !ğ
NULL
) {

2229 
»t
 = 
	`authÜize_äom_fe
(
cÚn
, 
å
);

2230 (è
	`fşo£
(
å
);

2233  
»t
;

2234 
	}
}

2236 
	$mg_modify_·sswÜds_fe
(
mg_cÚ‹xt
 *
ùx
, cÚ¡ *
âame
,

2237 cÚ¡ *
u£r
, cÚ¡ *
·ss
) {

2238 
found
;

2239 
lše
[512], 
u
[512], 
d
[512], 
ha1
[33], 
tmp
[
PATH_MAX
];

2240 cÚ¡ *
domaš
;

2241 
FILE
 *
å
, *
å2
;

2243 
found
 = 0;

2244 
å
 = 
å2
 = 
NULL
;

2245 
domaš
 = 
ùx
->
cÚfig
[
AUTHENTICATION_DOMAIN
];

2248 ià(
·ss
[0] == '\0') {

2249 
·ss
 = 
NULL
;

2252 (è
	`¢´štf
(
tmp
, Ñmp), "%s.tmp", 
âame
);

2255 ià((
å
 = 
	`mg_fİ’
(
âame
, "a+")è!ğ
NULL
) {

2256 (è
	`fşo£
(
å
);

2260 ià((
å
 = 
	`mg_fİ’
(
âame
, "r")è=ğ
NULL
) {

2261 
	`üy
(
	`fc
(
ùx
), "CªnÙ o³À%s: %s", 
âame
, 
	`¡»¼Ü
(
”ºo
));

2263 } ià((
å2
 = 
	`mg_fİ’
(
tmp
, "w+")è=ğ
NULL
) {

2264 
	`üy
(
	`fc
(
ùx
), "CªnÙ o³À%s: %s", 
tmp
, 
	`¡»¼Ü
(
”ºo
));

2269 
	`fg‘s
(
lše
, Öše), 
å
è!ğ
NULL
) {

2270 ià(
	`ssÿnf
(
lše
, "%[^:]:%[^:]:%*s", 
u
, 
d
) != 2) {

2274 ià(!
	`¡rcmp
(
u
, 
u£r
è&& !¡rcmp(
d
, 
domaš
)) {

2275 
found
++;

2276 ià(
·ss
 !ğ
NULL
) {

2277 
	`mg_md5
(
ha1
, 
u£r
, ":", 
domaš
, ":", 
·ss
, 
NULL
);

2278 
	`årštf
(
å2
, "%s:%s:%s\n", 
u£r
, 
domaš
, 
ha1
);

2281 (è
	`årštf
(
å2
, "%s", 
lše
);

2286 ià(!
found
 && 
·ss
 !ğ
NULL
) {

2287 
	`mg_md5
(
ha1
, 
u£r
, ":", 
domaš
, ":", 
·ss
, 
NULL
);

2288 (è
	`årštf
(
å2
, "%s:%s:%s\n", 
u£r
, 
domaš
, 
ha1
);

2292 (è
	`fşo£
(
å
);

2293 (è
	`fşo£
(
å2
);

2296 (è
	`mg_»move
(
âame
);

2297 (è
	`mg_»Çme
(
tmp
, 
âame
);

2300 
	}
}

2302 
	sde
 {

2303 
mg_cÚÃùiÚ
 *
	mcÚn
;

2304 *
	mfe_Çme
;

2305 
mg¡©
 
	m¡
;

2308 
	$u¾_’code
(cÚ¡ *
¤c
, *
d¡
, 
size_t
 
d¡_Ën
) {

2309 cÚ¡ *
dÚt_esÿ³
 = "._-$,;~()";

2310 cÚ¡ *
hex
 = "0123456789abcdef";

2311 cÚ¡ *
’d
 = 
d¡
 + 
d¡_Ën
 - 1;

2313 ; *
¤c
 !ğ'\0' && 
d¡
 < 
’d
; src++, dst++) {

2314 ià(
	`i§Êum
(*(cÚ¡ *è
¤c
) ||

2315 
	`¡rchr
(
dÚt_esÿ³
, * (cÚ¡ *è
¤c
è!ğ
NULL
) {

2316 *
d¡
 = *
¤c
;

2317 } ià(
d¡
 + 2 < 
’d
) {

2318 
d¡
[0] = '%';

2319 
d¡
[1] = 
hex
[(* (cÚ¡ *è
¤c
) >> 4];

2320 
d¡
[2] = 
hex
[(* (cÚ¡ *è
¤c
) & 0xf];

2321 
d¡
 += 2;

2325 *
d¡
 = '\0';

2326 
	}
}

2328 
	$´št_dœ_’Œy
(
de
 *de) {

2329 
size
[64], 
mod
[64], 
h»f
[
PATH_MAX
];

2331 ià(
de
->
¡
.
is_dœeùÜy
) {

2332 (è
	`mg_¢´štf
(
de
->
cÚn
, 
size
, (size), "%s", "[DIRECTORY]");

2336 ià(
de
->
¡
.
size
 < 1024) {

2337 (è
	`mg_¢´štf
(
de
->
cÚn
, 
size
, (size),

2338 "%lu", (è
de
->
¡
.
size
);

2339 } ià(
de
->
¡
.
size
 < 1024 * 1024) {

2340 (è
	`mg_¢´štf
(
de
->
cÚn
, 
size
, (size),

2341 "%.1fk", (è
de
->
¡
.
size
 / 1024.0);

2342 } ià(
de
->
¡
.
size
 < 1024 * 1024 * 1024) {

2343 (è
	`mg_¢´štf
(
de
->
cÚn
, 
size
, (size),

2344 "%.1fM", (è
de
->
¡
.
size
 / 1048576);

2346 (è
	`mg_¢´štf
(
de
->
cÚn
, 
size
, (size),

2347 "%.1fG", (è
de
->
¡
.
size
 / 1073741824);

2350 (è
	`¡ráime
(
mod
, (mod), "%d-%b-%Y %H:%M", 
	`loÿÉime
(&
de
->
¡
.
mtime
));

2351 
	`u¾_’code
(
de
->
fe_Çme
, 
h»f
, (href));

2352 
de
->
cÚn
->
num_by‹s_£Á
 +ğ
	`mg_´štf
(de->conn,

2355 
de
->
cÚn
->
»que¡_šfo
.
uri
, 
h»f
, de->
¡
.
is_dœeùÜy
 ? "/" : "",

2356 
de
->
fe_Çme
, de->
¡
.
is_dœeùÜy
 ? "/" : "", 
mod
, 
size
);

2357 
	}
}

2363 
WINCDECL
 
	$com·»_dœ_’Œ›s
(cÚ¡ *
p1
, cÚ¡ *
p2
) {

2364 cÚ¡ 
de
 *
a
 = (cÚ¡ d*è
p1
, *
b
 = (cÚ¡ d*è
p2
;

2365 cÚ¡ *
qu”y_¡ršg
 = 
a
->
cÚn
->
»que¡_šfo
.query_string;

2366 
cmp_»suÉ
 = 0;

2368 ià(
qu”y_¡ršg
 =ğ
NULL
) {

2369 
qu”y_¡ršg
 = "na";

2372 ià(
a
->
¡
.
is_dœeùÜy
 && !
b
->st.is_directory) {

2374 } ià(!
a
->
¡
.
is_dœeùÜy
 && 
b
->st.is_directory) {

2376 } ià(*
qu”y_¡ršg
 == 'n') {

2377 
cmp_»suÉ
 = 
	`¡rcmp
(
a
->
fe_Çme
, 
b
->file_name);

2378 } ià(*
qu”y_¡ršg
 == 's') {

2379 
cmp_»suÉ
 = 
a
->
¡
.
size
 =ğ
b
->st.size ? 0 :

2380 
a
->
¡
.
size
 > 
b
->st.size ? 1 : -1;

2381 } ià(*
qu”y_¡ršg
 == 'd') {

2382 
cmp_»suÉ
 = 
a
->
¡
.
mtime
 =ğ
b
->st.mtime ? 0 :

2383 
a
->
¡
.
mtime
 > 
b
->st.mtime ? 1 : -1;

2386  
qu”y_¡ršg
[1] =ğ'd' ? -
cmp_»suÉ
 : cmp_result;

2387 
	}
}

2389 
	$hªdË_dœeùÜy_»que¡
(
mg_cÚÃùiÚ
 *
cÚn
,

2390 cÚ¡ *
dœ
) {

2391 
dœ’t
 *
dp
;

2392 
DIR
 *
dœp
;

2393 
de
 *
’Œ›s
 = 
NULL
;

2394 
·th
[
PATH_MAX
];

2395 
i
, 
sÜt_dœeùiÚ
, 
num_’Œ›s
 = 0, 
¬r_size
 = 128;

2397 ià((
dœp
 = 
	`İ’dœ
(
dœ
)è=ğ
NULL
) {

2398 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, "Cannot open directory",

2399 "E¼Ü: o³ndœ(%s): %s", 
·th
, 
	`¡»¼Ü
(
ERRNO
));

2403 (è
	`mg_´štf
(
cÚn
, "%s",

2408 
sÜt_dœeùiÚ
 = 
cÚn
->
»que¡_šfo
.
qu”y_¡ršg
 !ğ
NULL
 &&

2409 
cÚn
->
»que¡_šfo
.
qu”y_¡ršg
[1] == 'd' ? 'a' : 'd';

2411 (
dp
 = 
	`»addœ
(
dœp
)è!ğ
NULL
) {

2414 ià(!
	`¡rcmp
(
dp
->
d_Çme
, ".") ||

2415 !
	`¡rcmp
(
dp
->
d_Çme
, "..") ||

2416 !
	`¡rcmp
(
dp
->
d_Çme
, 
PASSWORDS_FILE_NAME
))

2419 ià(
’Œ›s
 =ğ
NULL
 || 
num_’Œ›s
 >ğ
¬r_size
) {

2420 
¬r_size
 *= 2;

2421 
’Œ›s
 = (
de
 *è
	`»®loc
(entries,

2422 
¬r_size
 * (
’Œ›s
[0]));

2425 ià(
’Œ›s
 =ğ
NULL
) {

2426 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, "Cannot open directory",

2431 
	`mg_¢´štf
(
cÚn
, 
·th
, Õ©h), "%s%c%s", 
dœ
, 
DIRSEP
, 
dp
->
d_Çme
);

2438 ià(
	`mg_¡©
(
·th
, &
’Œ›s
[
num_’Œ›s
].
¡
) != 0) {

2439 
	`mem£t
(&
’Œ›s
[
num_’Œ›s
].
¡
, 0, (entries[num_entries].st));

2442 
’Œ›s
[
num_’Œ›s
].
cÚn
 = conn;

2443 
’Œ›s
[
num_’Œ›s
].
fe_Çme
 = 
	`mg_¡rdup
(
dp
->
d_Çme
);

2444 
num_’Œ›s
++;

2446 (è
	`şo£dœ
(
dœp
);

2448 
cÚn
->
num_by‹s_£Á
 +ğ
	`mg_´štf
(conn,

2456 
cÚn
->
»que¡_šfo
.
uri
, conn->request_info.uri,

2457 
sÜt_dœeùiÚ
, sort_direction, sort_direction);

2460 
cÚn
->
num_by‹s_£Á
 +ğ
	`mg_´štf
(conn,

2463 
cÚn
->
»que¡_šfo
.
uri
, "..", "Parent directory", "-", "-");

2466 
	`qsÜt
(
’Œ›s
, (
size_t
)
num_’Œ›s
, ÓÁr›s[0]), 
com·»_dœ_’Œ›s
);

2467 
i
 = 0; i < 
num_’Œ›s
; i++) {

2468 
	`´št_dœ_’Œy
(&
’Œ›s
[
i
]);

2469 
	`ä“
(
’Œ›s
[
i
].
fe_Çme
);

2471 
	`ä“
(
’Œ›s
);

2473 
cÚn
->
num_by‹s_£Á
 +ğ
	`mg_´štf
(conn, "%s", "</table></body></html>");

2474 
cÚn
->
»que¡_šfo
.
¡©us_code
 = 200;

2475 
	}
}

2478 
	$£nd_fe_d©a
(
mg_cÚÃùiÚ
 *
cÚn
, 
FILE
 *
å
, 
št64_t
 
Ën
) {

2479 
buf
[
BUFSIZ
];

2480 
to_»ad
, 
num_»ad
, 
num_wr™‹n
;

2482 
Ën
 > 0) {

2484 
to_»ad
 = (
buf
);

2485 ià((
št64_t
è
to_»ad
 > 
Ën
)

2486 
to_»ad
 = (è
Ën
;

2489 ià((
num_»ad
 = (è
	`ä—d
(
buf
, 1, (
size_t
)
to_»ad
, 
å
)) == 0)

2493 ià((
num_wr™‹n
 = 
	`mg_wr™e
(
cÚn
, 
buf
, (
size_t
)
num_»ad
)) !=‚um_read)

2497 
cÚn
->
num_by‹s_£Á
 +ğ
num_wr™‹n
;

2498 
Ën
 -ğ
num_wr™‹n
;

2500 
	}
}

2502 
	$·r£_¿nge_h—d”
(cÚ¡ *
h—d”
, 
št64_t
 *
a
, iÁ64_ˆ*
b
) {

2503  
	`ssÿnf
(
h—d”
, "by‹s=%" 
INT64_FMT
 "-%" INT64_FMT, 
a
, 
b
);

2504 
	}
}

2506 
	$hªdË_fe_»que¡
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
·th
,

2507 
mg¡©
 *
¡p
) {

2508 
d©e
[64], 
lm
[64], 
‘ag
[64], 
¿nge
[64];

2509 cÚ¡ *
fmt
 = "%a, %d %b %Y %H:%M:%S %Z", *
msg
 = "OK", *
hdr
;

2510 
time_t
 
cu¹ime
 = 
	`time
(
NULL
);

2511 
št64_t
 
ş
, 
r1
, 
r2
;

2512 
vec
 
mime_vec
;

2513 
FILE
 *
å
;

2514 
n
;

2516 
	`g‘_mime_ty³
(
cÚn
->
ùx
, 
·th
, &
mime_vec
);

2517 
ş
 = 
¡p
->
size
;

2518 
cÚn
->
»que¡_šfo
.
¡©us_code
 = 200;

2519 
¿nge
[0] = '\0';

2521 ià((
å
 = 
	`mg_fİ’
(
·th
, "rb")è=ğ
NULL
) {

2522 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, 
h‰p_500_”rÜ
,

2523 "fİ’(%s): %s", 
·th
, 
	`¡»¼Ü
(
ERRNO
));

2526 
	`£t_şo£_Ú_exec
(
	`f’o
(
å
));

2529 
r1
 = 
r2
 = 0;

2530 
hdr
 = 
	`mg_g‘_h—d”
(
cÚn
, "Range");

2531 ià(
hdr
 !ğ
NULL
 && (
n
 = 
	`·r£_¿nge_h—d”
(hdr, &
r1
, &
r2
)) > 0) {

2532 
cÚn
->
»que¡_šfo
.
¡©us_code
 = 206;

2533 (è
	`f£eko
(
å
, (
off_t
è
r1
, 
SEEK_SET
);

2534 
ş
 = 
n
 =ğ2 ? 
r2
 - 
r1
 + 1: cl -„1;

2535 (è
	`mg_¢´štf
(
cÚn
, 
¿nge
, (range),

2537 "%" 
INT64_FMT
 "-%"

2538 
INT64_FMT
 "/%" INT64_FMT "\r\n",

2539 
r1
,„1 + 
ş
 - 1, 
¡p
->
size
);

2540 
msg
 = "Partial Content";

2544 (è
	`¡ráime
(
d©e
, (d©e), 
fmt
, 
	`loÿÉime
(&
cu¹ime
));

2545 (è
	`¡ráime
(
lm
, Öm), 
fmt
, 
	`loÿÉime
(&
¡p
->
mtime
));

2546 (è
	`mg_¢´štf
(
cÚn
, 
‘ag
, (etag), "%lx.%lx",

2547 (è
¡p
->
mtime
, (è¡p->
size
);

2549 (è
	`mg_´štf
(
cÚn
,

2555 "CÚ‹Á-L’gth: %" 
INT64_FMT
 "\r\n"

2559 
cÚn
->
»que¡_šfo
.
¡©us_code
, 
msg
, 
d©e
, 
lm
, 
‘ag
,

2560 
mime_vec
.
Ën
, mime_vec.
±r
, 
ş
, 
	`sugge¡_cÚÃùiÚ_h—d”
(
cÚn
), 
¿nge
);

2562 ià(
	`¡rcmp
(
cÚn
->
»que¡_šfo
.
»que¡_m‘hod
, "HEAD") != 0) {

2563 
	`£nd_fe_d©a
(
cÚn
, 
å
, 
ş
);

2565 (è
	`fşo£
(
å
);

2566 
	}
}

2570 
	$·r£_h‰p_h—d”s
(**
buf
, 
mg_»que¡_šfo
 *
ri
) {

2571 
i
;

2573 
i
 = 0; i < (è
	`ARRAY_SIZE
(
ri
->
h‰p_h—d”s
); i++) {

2574 
ri
->
h‰p_h—d”s
[
i
].
Çme
 = 
	`sk_quÙed
(
buf
, ":", " ", 0);

2575 
ri
->
h‰p_h—d”s
[
i
].
v®ue
 = 
	`sk
(
buf
, "\r\n");

2576 ià(
ri
->
h‰p_h—d”s
[
i
].
Çme
[0] == '\0')

2578 
ri
->
num_h—d”s
 = 
i
 + 1;

2580 
	}
}

2582 
	$is_v®id_h‰p_m‘hod
(cÚ¡ *
m‘hod
) {

2583  !
	`¡rcmp
(
m‘hod
, "GET") || !strcmp(method, "POST") ||

2584 !
	`¡rcmp
(
m‘hod
, "HEAD") || !strcmp(method, "CONNECT") ||

2585 !
	`¡rcmp
(
m‘hod
, "PUT") || !strcmp(method, "DELETE");

2586 
	}
}

2589 
	$·r£_h‰p_»que¡
(*
buf
, 
mg_»que¡_šfo
 *
ri
) {

2590 
¡©us
 = 0;

2593 *
buf
 !ğ'\0' && 
	`is¥aû
(* (*) buf)) {

2594 
buf
++;

2597 
ri
->
»que¡_m‘hod
 = 
	`sk
(&
buf
, " ");

2598 
ri
->
uri
 = 
	`sk
(&
buf
, " ");

2599 
ri
->
h‰p_v”siÚ
 = 
	`sk
(&
buf
, "\r\n");

2601 ià(
	`is_v®id_h‰p_m‘hod
(
ri
->
»que¡_m‘hod
) &&

2602 
	`¡ºcmp
(
ri
->
h‰p_v”siÚ
, "HTTP/", 5) == 0) {

2603 
ri
->
h‰p_v”siÚ
 += 5;

2604 
	`·r£_h‰p_h—d”s
(&
buf
, 
ri
);

2605 
¡©us
 = 1;

2608  
¡©us
;

2609 
	}
}

2616 
	$»ad_»que¡
(
FILE
 *
å
, 
SOCKET
 
sock
, 
SSL
 *
s¦
, *
buf
, 
bufsiz
,

2617 *
Ä—d
) {

2618 
n
, 
»que¡_Ën
;

2620 
»que¡_Ën
 = 0;

2621 *
Ä—d
 < 
bufsiz
 && 
»que¡_Ën
 == 0) {

2622 
n
 = 
	`puÎ
(
å
, 
sock
, 
s¦
, 
buf
 + *
Ä—d
, 
bufsiz
 - *nread);

2623 ià(
n
 <= 0) {

2626 *
Ä—d
 +ğ
n
;

2627 
»que¡_Ën
 = 
	`g‘_»que¡_Ën
(
buf
, *
Ä—d
);

2631  
»que¡_Ën
;

2632 
	}
}

2637 
	$sub¡™u‹_šdex_fe
(
mg_cÚÃùiÚ
 *
cÚn
, *
·th
,

2638 
size_t
 
·th_Ën
, 
mg¡©
 *
¡p
) {

2639 cÚ¡ *
li¡
 = 
cÚn
->
ùx
->
cÚfig
[
INDEX_FILES
];

2640 
mg¡©
 
¡
;

2641 
vec
 
f’ame_vec
;

2642 
size_t
 
n
 = 
	`¡¾’
(
·th
);

2643 
found
 = 0;

2648 
n
 > 0 && 
	`IS_DIRSEP_CHAR
(
·th
[n - 1])) {

2649 
n
--;

2651 
·th
[
n
] = 
DIRSEP
;

2655 (
li¡
 = 
	`Ãxt_İtiÚ
Öi¡, &
f’ame_vec
, 
NULL
)) != NULL) {

2658 ià(
f’ame_vec
.
Ën
 > 
·th_Ën
 - 
n
)

2662 (è
	`mg_¡¾ıy
(
·th
 + 
n
 + 1, 
f’ame_vec
.
±r
, f’ame_vec.
Ën
 + 1);

2665 ià(
	`mg_¡©
(
·th
, &
¡
) == 0) {

2667 *
¡p
 = 
¡
;

2668 
found
 = 1;

2674 ià(!
found
) {

2675 
·th
[
n
] = '\0';

2678  
found
;

2679 
	}
}

2682 
	$is_nÙ_modif›d
(cÚ¡ 
mg_cÚÃùiÚ
 *
cÚn
,

2683 cÚ¡ 
mg¡©
 *
¡p
) {

2684 cÚ¡ *
ims
 = 
	`mg_g‘_h—d”
(
cÚn
, "If-Modified-Since");

2685  
ims
 !ğ
NULL
 && 
¡p
->
mtime
 <ğ
	`·r£_d©e_¡ršg
(ims);

2686 
	}
}

2688 
	$fÜw¬d_body_d©a
(
mg_cÚÃùiÚ
 *
cÚn
, 
FILE
 *
å
,

2689 
SOCKET
 
sock
, 
SSL
 *
s¦
) {

2690 cÚ¡ *
ex³ù
, *
bufã»d
;

2691 
buf
[
BUFSIZ
];

2692 
to_»ad
, 
Ä—d
, 
bufã»d_Ën
, 
sucûss
 = 0;

2694 
ex³ù
 = 
	`mg_g‘_h—d”
(
cÚn
, "Expect");

2695 
	`as£¹
(
å
 !ğ
NULL
);

2697 ià(
cÚn
->
cÚ‹Á_Ën
 == -1) {

2698 
	`£nd_h‰p_”rÜ
(
cÚn
, 411, "Length Required", "");

2699 } ià(
ex³ù
 !ğ
NULL
 && 
	`mg_¡rÿ£cmp
(expect, "100-continue")) {

2700 
	`£nd_h‰p_”rÜ
(
cÚn
, 417, "Expectation Failed", "");

2702 ià(
ex³ù
 !ğ
NULL
) {

2703 (è
	`mg_´štf
(
cÚn
, "%s", "HTTP/1.1 100 Continue\r\n\r\n");

2706 
bufã»d
 = 
cÚn
->
buf
 + cÚn->
»que¡_Ën
;

2707 
bufã»d_Ën
 = 
cÚn
->
d©a_Ën
 - cÚn->
»que¡_Ën
;

2708 
	`as£¹
(
bufã»d_Ën
 >= 0);

2709 
	`as£¹
(
cÚn
->
cÚsumed_cÚ‹Á
 == 0);

2711 ià(
bufã»d_Ën
 > 0) {

2712 ià((
št64_t
è
bufã»d_Ën
 > 
cÚn
->
cÚ‹Á_Ën
) {

2713 
bufã»d_Ën
 = (è
cÚn
->
cÚ‹Á_Ën
;

2715 
	`push
(
å
, 
sock
, 
s¦
, 
bufã»d
, (
št64_t
è
bufã»d_Ën
);

2716 
cÚn
->
cÚsumed_cÚ‹Á
 +ğ
bufã»d_Ën
;

2719 
cÚn
->
cÚsumed_cÚ‹Á
 < cÚn->
cÚ‹Á_Ën
) {

2720 
to_»ad
 = (
buf
);

2721 ià((
št64_t
è
to_»ad
 > 
cÚn
->
cÚ‹Á_Ën
 - cÚn->
cÚsumed_cÚ‹Á
) {

2722 
to_»ad
 = (è(
cÚn
->
cÚ‹Á_Ën
 - cÚn->
cÚsumed_cÚ‹Á
);

2724 
Ä—d
 = 
	`puÎ
(
NULL
, 
cÚn
->
ş›Á
.
sock
, cÚn->
s¦
, 
buf
, 
to_»ad
);

2725 ià(
Ä—d
 <ğ0 || 
	`push
(
å
, 
sock
, 
s¦
, 
buf
,‚read) !=‚read) {

2728 
cÚn
->
cÚsumed_cÚ‹Á
 +ğ
Ä—d
;

2731 ià(
cÚn
->
cÚsumed_cÚ‹Á
 =ğcÚn->
cÚ‹Á_Ën
) {

2732 
sucûss
 = 1;

2736 ià(!
sucûss
) {

2737 
	`£nd_h‰p_”rÜ
(
cÚn
, 577, 
h‰p_500_”rÜ
, "");

2741  
sucûss
;

2742 
	}
}

2744 #ià!
defšed
(
NO_CGI
)

2753 
	scgi_’v_block
 {

2754 
mg_cÚÃùiÚ
 *
	mcÚn
;

2755 
	mbuf
[
CGI_ENVIRONMENT_SIZE
];

2756 
	mËn
;

2757 *
	mv¬s
[
MAX_CGI_ENVIR_VARS
];

2758 
	mnv¬s
;

2763 *
	$add’v
(
cgi_’v_block
 *
block
, cÚ¡ *
fmt
, ...) {

2764 
n
, 
¥aû
;

2765 *
added
;

2766 
va_li¡
 
­
;

2769 
¥aû
 = (è((
block
->
buf
è- block->
Ën
 - 2);

2770 
	`as£¹
(
¥aû
 >= 0);

2773 
added
 = 
block
->
buf
 + block->
Ën
;

2776 
	`va_¡¬t
(
­
, 
fmt
);

2777 
n
 = 
	`mg_v¢´štf
(
block
->
cÚn
, 
added
, (
size_t
è
¥aû
, 
fmt
, 
­
);

2778 
	`va_’d
(
­
);

2781 ià(
n
 > 0 &&‚ < 
¥aû
 &&

2782 
block
->
nv¬s
 < (è
	`ARRAY_SIZE
(block->
v¬s
) - 2) {

2784 
block
->
v¬s
[block->
nv¬s
++] = block->
buf
 + block->
Ën
;

2786 
block
->
Ën
 +ğ
n
 + 1;

2789  
added
;

2790 
	}
}

2792 
	$´•¬e_cgi_’vœÚm’t
(
mg_cÚÃùiÚ
 *
cÚn
,

2793 cÚ¡ *
´og
,

2794 
cgi_’v_block
 *
blk
) {

2795 cÚ¡ *
s
, *
¦ash
;

2796 
vec
 
v¬_vec
, 
roÙ
;

2797 *
p
;

2798 
i
;

2800 
blk
->
Ën
 = blk->
nv¬s
 = 0;

2801 
blk
->
cÚn
 = conn;

2803 
	`g‘_docum’t_roÙ
(
cÚn
, &
roÙ
);

2805 
	`add’v
(
blk
, "SERVER_NAME=%s", 
cÚn
->
ùx
->
cÚfig
[
AUTHENTICATION_DOMAIN
]);

2806 
	`add’v
(
blk
, "SERVER_ROOT=%.*s", 
roÙ
.
Ën
,„oÙ.
±r
);

2807 
	`add’v
(
blk
, "DOCUMENT_ROOT=%.*s", 
roÙ
.
Ën
,„oÙ.
±r
);

2810 
	`add’v
(
blk
, "%s", "GATEWAY_INTERFACE=CGI/1.1");

2811 
	`add’v
(
blk
, "%s", "SERVER_PROTOCOL=HTTP/1.1");

2812 
	`add’v
(
blk
, "%s", "REDIRECT_STATUS=200");

2813 
	`add’v
(
blk
, "SERVER_PORT=%d", 
	`Áohs
(
cÚn
->
ş›Á
.
l§
.
u
.
sš
.
sš_pÜt
));

2814 
	`add’v
(
blk
, "REQUEST_METHOD=%s", 
cÚn
->
»que¡_šfo
.
»que¡_m‘hod
);

2815 
	`add’v
(
blk
, "REMOTE_ADDR=%s",

2816 
	`š‘_Áß
(
cÚn
->
ş›Á
.
r§
.
u
.
sš
.
sš_addr
));

2817 
	`add’v
(
blk
, "REMOTE_PORT=%d", 
cÚn
->
»que¡_šfo
.
»mÙe_pÜt
);

2818 
	`add’v
(
blk
, "REQUEST_URI=%s", 
cÚn
->
»que¡_šfo
.
uri
);

2821 
	`as£¹
(
cÚn
->
»que¡_šfo
.
uri
[0] == '/');

2822 
¦ash
 = 
	`¡¼chr
(
cÚn
->
»que¡_šfo
.
uri
, '/');

2823 ià((
s
 = 
	`¡¼chr
(
´og
, '/')è=ğ
NULL
)

2824 
s
 = 
´og
;

2825 
	`add’v
(
blk
, "SCRIPT_NAME=%.*s%s", 
¦ash
 - 
cÚn
->
»que¡_šfo
.
uri
,

2826 
cÚn
->
»que¡_šfo
.
uri
, 
s
);

2828 
	`add’v
(
blk
, "SCRIPT_FILENAME=%s", 
´og
);

2829 
	`add’v
(
blk
, "PATH_TRANSLATED=%s", 
´og
);

2830 
	`add’v
(
blk
, "HTTPS=%s", 
cÚn
->
s¦
 =ğ
NULL
 ? "off" : "on");

2832 ià((
s
 = 
	`mg_g‘_h—d”
(
cÚn
, "CÚ‹Á-Ty³")è!ğ
NULL
)

2833 
	`add’v
(
blk
, "CONTENT_TYPE=%s", 
s
);

2835 ià(
cÚn
->
»que¡_šfo
.
qu”y_¡ršg
 !ğ
NULL
)

2836 
	`add’v
(
blk
, "QUERY_STRING=%s", 
cÚn
->
»que¡_šfo
.
qu”y_¡ršg
);

2838 ià((
s
 = 
	`mg_g‘_h—d”
(
cÚn
, "CÚ‹Á-L’gth")è!ğ
NULL
)

2839 
	`add’v
(
blk
, "CONTENT_LENGTH=%s", 
s
);

2841 ià((
s
 = 
	`g‘’v
("PATH")è!ğ
NULL
)

2842 
	`add’v
(
blk
, "PATH=%s", 
s
);

2844 #ià
	`defšed
(
_WIN32
)

2845 ià((
s
 = 
	`g‘’v
("COMSPEC")è!ğ
NULL
)

2846 
	`add’v
(
blk
, "COMSPEC=%s", 
s
);

2847 ià((
s
 = 
	`g‘’v
("SYSTEMROOT")è!ğ
NULL
)

2848 
	`add’v
(
blk
, "SYSTEMROOT=%s", 
s
);

2850 ià((
s
 = 
	`g‘’v
("LD_LIBRARY_PATH")è!ğ
NULL
)

2851 
	`add’v
(
blk
, "LD_LIBRARY_PATH=%s", 
s
);

2854 ià((
s
 = 
	`g‘’v
("PERLLIB")è!ğ
NULL
)

2855 
	`add’v
(
blk
, "PERLLIB=%s", 
s
);

2857 ià(
cÚn
->
»que¡_šfo
.
»mÙe_u£r
 !ğ
NULL
) {

2858 
	`add’v
(
blk
, "REMOTE_USER=%s", 
cÚn
->
»que¡_šfo
.
»mÙe_u£r
);

2859 
	`add’v
(
blk
, "%s", "AUTH_TYPE=Digest");

2863 
i
 = 0; i < 
cÚn
->
»que¡_šfo
.
num_h—d”s
; i++) {

2864 
p
 = 
	`add’v
(
blk
, "HTTP_%s=%s",

2865 
cÚn
->
»que¡_šfo
.
h‰p_h—d”s
[
i
].
Çme
,

2866 
cÚn
->
»que¡_šfo
.
h‰p_h—d”s
[
i
].
v®ue
);

2869 ; *
p
 != '=' && *p != '\0';…++) {

2870 ià(*
p
 == '-')

2871 *
p
 = '_';

2872 *
p
 = (è
	`touµ”
(* (*)…);

2877 
s
 = 
cÚn
->
ùx
->
cÚfig
[
CGI_ENVIRONMENT
];

2878 (
s
 = 
	`Ãxt_İtiÚ
(s, &
v¬_vec
, 
NULL
)) != NULL) {

2879 
	`add’v
(
blk
, "%.*s", 
v¬_vec
.
Ën
, v¬_vec.
±r
);

2882 
blk
->
v¬s
[blk->
nv¬s
++] = 
NULL
;

2883 
blk
->
buf
[blk->
Ën
++] = '\0';

2885 
	`as£¹
(
blk
->
nv¬s
 < (è
	`ARRAY_SIZE
(blk->
v¬s
));

2886 
	`as£¹
(
blk
->
Ën
 > 0);

2887 
	`as£¹
(
blk
->
Ën
 < (è(blk->
buf
));

2888 
	}
}

2890 
	$hªdË_cgi_»que¡
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
´og
) {

2891 
h—d”s_Ën
, 
d©a_Ën
, 
i
, 
fd_¡dš
[2], 
fd_¡dout
[2];

2892 cÚ¡ *
¡©us
;

2893 
buf
[
BUFSIZ
], *
pbuf
, 
dœ
[
PATH_MAX
], *
p
;

2894 
mg_»que¡_šfo
 
ri
;

2895 
cgi_’v_block
 
blk
;

2896 
FILE
 *
š
, *
out
;

2897 
pid_t
 
pid
;

2899 
	`´•¬e_cgi_’vœÚm’t
(
cÚn
, 
´og
, &
blk
);

2904 (è
	`mg_¢´štf
(
cÚn
, 
dœ
, (dœ), "%s", 
´og
);

2905 ià((
p
 = 
	`¡¼chr
(
dœ
, 
DIRSEP
)è!ğ
NULL
) {

2906 *
p
++ = '\0';

2908 
dœ
[0] = '.', dir[1] = '\0';

2909 
p
 = (*è
´og
;

2912 
pid
 = (
pid_t
) -1;

2913 
fd_¡dš
[0] = fd_¡dš[1] = 
fd_¡dout
[0] = fd_stdout[1] = -1;

2914 
š
 = 
out
 = 
NULL
;

2916 ià(
	`pe
(
fd_¡dš
è!ğ0 ||…e(
fd_¡dout
) != 0) {

2917 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, 
h‰p_500_”rÜ
,

2918 "CªnÙ c»©CGI…e: %s", 
	`¡»¼Ü
(
ERRNO
));

2919 
dÚe
;

2920 } ià((
pid
 = 
	`¥awn_´oûss
(
cÚn
, 
p
, 
blk
.
buf
, blk.
v¬s
,

2921 
fd_¡dš
[0], 
fd_¡dout
[1], 
dœ
)è=ğ(
pid_t
) -1) {

2922 
dÚe
;

2923 } ià((
š
 = 
	`fdİ’
(
fd_¡dš
[1], "wb")è=ğ
NULL
 ||

2924 (
out
 = 
	`fdİ’
(
fd_¡dout
[0], "rb")è=ğ
NULL
) {

2925 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, 
h‰p_500_”rÜ
,

2926 "fİ’: %s", 
	`¡»¼Ü
(
ERRNO
));

2927 
dÚe
;

2930 
	`£tbuf
(
š
, 
NULL
);

2931 
	`£tbuf
(
out
, 
NULL
);

2937 
fd_¡dš
[0] = 
fd_¡dout
[1] = -1;

2940 ià(!
	`¡rcmp
(
cÚn
->
»que¡_šfo
.
»que¡_m‘hod
, "POST") &&

2941 !
	`fÜw¬d_body_d©a
(
cÚn
, 
š
, 
INVALID_SOCKET
, 
NULL
)) {

2942 
dÚe
;

2949 
d©a_Ën
 = 0;

2950 
h—d”s_Ën
 = 
	`»ad_»que¡
(
out
, 
INVALID_SOCKET
, 
NULL
,

2951 
buf
, (buf), &
d©a_Ën
);

2952 ià(
h—d”s_Ën
 <= 0) {

2953 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, 
h‰p_500_”rÜ
,

2955 
d©a_Ën
, 
buf
);

2956 
dÚe
;

2958 
pbuf
 = 
buf
;

2959 
buf
[
h—d”s_Ën
 - 1] = '\0';

2960 
	`·r£_h‰p_h—d”s
(&
pbuf
, &
ri
);

2963 
¡©us
 = 
	`g‘_h—d”
(&
ri
, "Status");

2964 
cÚn
->
»que¡_šfo
.
¡©us_code
 = 
¡©us
 =ğ
NULL
 ? 200 : 
	`©oi
(status);

2965 (è
	`mg_´štf
(
cÚn
, "HTTP/1.1 %d OK\r\n", cÚn->
»que¡_šfo
.
¡©us_code
);

2968 
i
 = 0; i < 
ri
.
num_h—d”s
; i++) {

2969 
	`mg_´štf
(
cÚn
, "%s: %s\r\n",

2970 
ri
.
h‰p_h—d”s
[
i
].
Çme
,„i.h‰p_h—d”s[i].
v®ue
);

2972 (è
	`mg_wr™e
(
cÚn
, "\r\n", 2);

2975 
cÚn
->
num_by‹s_£Á
 +ğ
	`mg_wr™e
(cÚn, 
buf
 + 
h—d”s_Ën
,

2976 (
size_t
)(
d©a_Ën
 - 
h—d”s_Ën
));

2979 
	`£nd_fe_d©a
(
cÚn
, 
out
, 
INT64_MAX
);

2981 
dÚe
:

2982 ià(
pid
 !ğ(
pid_t
) -1) {

2983 
	`kl
(
pid
, 
SIGKILL
);

2984 #ià!
	`defšed
(
_WIN32
)

2985 dØ{} 
	`wa™pid
(-1, &
i
, 
WNOHANG
) > 0);

2988 ià(
fd_¡dš
[0] != -1) {

2989 (è
	`şo£
(
fd_¡dš
[0]);

2991 ià(
fd_¡dout
[1] != -1) {

2992 (è
	`şo£
(
fd_¡dout
[1]);

2995 ià(
š
 !ğ
NULL
) {

2996 (è
	`fşo£
(
š
);

2997 } ià(
fd_¡dš
[1] != -1) {

2998 (è
	`şo£
(
fd_¡dš
[1]);

3001 ià(
out
 !ğ
NULL
) {

3002 (è
	`fşo£
(
out
);

3003 } ià(
fd_¡dout
[0] != -1) {

3004 (è
	`şo£
(
fd_¡dout
[0]);

3006 
	}
}

3012 
	$put_dœ
(cÚ¡ *
·th
) {

3013 
buf
[
PATH_MAX
];

3014 cÚ¡ *
s
, *
p
;

3015 
mg¡©
 
¡
;

3016 
size_t
 
Ën
;

3018 
s
 = 
p
 = 
·th
 + 2; (°ğ
	`¡rchr
(s, '/')è!ğ
NULL
; s = ++p) {

3019 
Ën
 = 
p
 - 
·th
;

3020 
	`as£¹
(
Ën
 < (
buf
));

3021 (è
	`memıy
(
buf
, 
·th
, 
Ën
);

3022 
buf
[
Ën
] = '\0';

3025 ià(
	`mg_¡©
(
buf
, &
¡
è=ğ-1 && 
	`mg_mkdœ
(buf, 0755) != 0) {

3030 ià(
p
[1] == '\0') {

3036 
	}
}

3038 
	$put_fe
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
·th
) {

3039 
mg¡©
 
¡
;

3040 cÚ¡ *
¿nge
;

3041 
št64_t
 
r1
, 
r2
;

3042 
FILE
 *
å
;

3043 
rc
;

3045 
cÚn
->
»que¡_šfo
.
¡©us_code
 = 
	`mg_¡©
(
·th
, &
¡
) == 0 ? 200 : 201;

3047 ià((
rc
 = 
	`put_dœ
(
·th
)) == 0) {

3048 
	`mg_´štf
(
cÚn
, "HTTP/1.1 %d OK\r\n\r\n", cÚn->
»que¡_šfo
.
¡©us_code
);

3049 } ià(
rc
 == -1) {

3050 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, 
h‰p_500_”rÜ
,

3051 "put_dœ(%s): %s", 
·th
, 
	`¡»¼Ü
(
ERRNO
));

3052 } ià((
å
 = 
	`mg_fİ’
(
·th
, "wb+")è=ğ
NULL
) {

3053 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, 
h‰p_500_”rÜ
,

3054 "fİ’(%s): %s", 
·th
, 
	`¡»¼Ü
(
ERRNO
));

3056 
	`£t_şo£_Ú_exec
(
	`f’o
(
å
));

3057 
¿nge
 = 
	`mg_g‘_h—d”
(
cÚn
, "Content-Range");

3058 
r1
 = 
r2
 = 0;

3059 ià(
¿nge
 !ğ
NULL
 && 
	`·r£_¿nge_h—d”
Ôªge, &
r1
, &
r2
) > 0) {

3060 
cÚn
->
»que¡_šfo
.
¡©us_code
 = 206;

3062 (è
	`f£eko
(
å
, (
off_t
è
r1
, 
SEEK_SET
);

3064 ià(
	`fÜw¬d_body_d©a
(
cÚn
, 
å
, 
INVALID_SOCKET
, 
NULL
))

3065 (è
	`mg_´štf
(
cÚn
, "HTTP/1.1 %d OK\r\n\r\n",

3066 
cÚn
->
»que¡_šfo
.
¡©us_code
);

3067 (è
	`fşo£
(
å
);

3069 
	}
}

3071 
£nd_ssi_fe
(
mg_cÚÃùiÚ
 *, cÚ¡ *, 
FILE
 *, );

3073 
	$do_ssi_šşude
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
ssi
,

3074 *
g
, 
šşude_Ëv–
) {

3075 
fe_Çme
[
BUFSIZ
], 
·th
[
PATH_MAX
], *
p
;

3076 
vec
 
roÙ
;

3077 
is_ssi
;

3078 
FILE
 *
å
;

3080 
	`g‘_docum’t_roÙ
(
cÚn
, &
roÙ
);

3084 ià(
	`ssÿnf
(
g
, " vœtu®=\"%[^\"]\"", 
fe_Çme
) == 1) {

3086 (è
	`mg_¢´štf
(
cÚn
, 
·th
, (path), "%.*s%c%s",

3087 
roÙ
.
Ën
,„oÙ.
±r
, 
DIRSEP
, 
fe_Çme
);

3088 } ià(
	`ssÿnf
(
g
, " fe=\"%[^\"]\"", 
fe_Çme
) == 1) {

3091 (è
	`mg_¢´štf
(
cÚn
, 
·th
, Õ©h), "%s", 
fe_Çme
);

3092 } ià(
	`ssÿnf
(
g
, " \"%[^\"]\"", 
fe_Çme
) == 1) {

3094 (è
	`mg_¢´štf
(
cÚn
, 
·th
, Õ©h), "%s", 
ssi
);

3095 ià((
p
 = 
	`¡¼chr
(
·th
, 
DIRSEP
)è!ğ
NULL
) {

3096 
p
[1] = '\0';

3098 (è
	`mg_¢´štf
(
cÚn
, 
·th
 + 
	`¡¾’
(path),

3099 (
·th
è- 
	`¡¾’
Õ©h), "%s", 
fe_Çme
);

3101 
	`üy
(
cÚn
, "Bad SSI #šşude: [%s]", 
g
);

3105 ià((
å
 = 
	`mg_fİ’
(
·th
, "rb")è=ğ
NULL
) {

3106 
	`üy
(
cÚn
, "Cannot open SSI #include: [%s]: fopen(%s): %s",

3107 
g
, 
·th
, 
	`¡»¼Ü
(
ERRNO
));

3109 
	`£t_şo£_Ú_exec
(
	`f’o
(
å
));

3110 
is_ssi
 = 
	`m©ch_ex‹nsiÚ
(
·th
, 
cÚn
->
ùx
->
cÚfig
[
SSI_EXTENSIONS
]);

3111 ià(
is_ssi
) {

3112 
	`£nd_ssi_fe
(
cÚn
, 
·th
, 
å
, 
šşude_Ëv–
 + 1);

3114 
	`£nd_fe_d©a
(
cÚn
, 
å
, 
INT64_MAX
);

3116 (è
	`fşo£
(
å
);

3118 
	}
}

3120 #ià!
defšed
(
NO_POPEN
)

3121 
	$do_ssi_exec
(
mg_cÚÃùiÚ
 *
cÚn
, *
g
) {

3122 
cmd
[
BUFSIZ
];

3123 
FILE
 *
å
;

3125 ià(
	`ssÿnf
(
g
, " \"%[^\"]\"", 
cmd
) != 1) {

3126 
	`üy
(
cÚn
, "Bad SSI #exec: [%s]", 
g
);

3127 } ià((
å
 = 
	`pİ’
(
cmd
, "r")è=ğ
NULL
) {

3128 
	`üy
(
cÚn
, "CªnÙ SSI #exec: [%s]: %s", 
cmd
, 
	`¡»¼Ü
(
ERRNO
));

3130 
	`£nd_fe_d©a
(
cÚn
, 
å
, 
INT64_MAX
);

3131 (è
	`pşo£
(
å
);

3133 
	}
}

3136 
	$£nd_ssi_fe
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
·th
,

3137 
FILE
 *
å
, 
šşude_Ëv–
) {

3138 
buf
[
BUFSIZ
];

3139 
ch
, 
Ën
, 
š_ssi_g
;

3141 ià(
šşude_Ëv–
 > 10) {

3142 
	`üy
(
cÚn
, "SSI #šşudËv– i toØd“°(%s)", 
·th
);

3146 
š_ssi_g
 = 0;

3147 
Ën
 = 0;

3149 (
ch
 = 
	`fg‘c
(
å
)è!ğ
EOF
) {

3150 ià(
š_ssi_g
 && 
ch
 == '>') {

3151 
š_ssi_g
 = 0;

3152 
buf
[
Ën
++] = (è
ch
;

3153 
buf
[
Ën
] = '\0';

3154 
	`as£¹
(
Ën
 <ğ(è(
buf
));

3155 ià(
Ën
 < 6 || 
	`memcmp
(
buf
, "<!--#", 5) != 0) {

3157 (è
	`mg_wr™e
(
cÚn
, 
buf
, (
size_t
)
Ën
);

3159 ià(!
	`memcmp
(
buf
 + 5, "include", 7)) {

3160 
	`do_ssi_šşude
(
cÚn
, 
·th
, 
buf
 + 12, 
šşude_Ëv–
);

3161 #ià!
	`defšed
(
NO_POPEN
)

3162 } ià(!
	`memcmp
(
buf
 + 5, "exec", 4)) {

3163 
	`do_ssi_exec
(
cÚn
, 
buf
 + 9);

3166 
	`üy
(
cÚn
, "%s: unknowÀSSI " "commªd: \"%s\"", 
·th
, 
buf
);

3169 
Ën
 = 0;

3170 } ià(
š_ssi_g
) {

3171 ià(
Ën
 =ğ5 && 
	`memcmp
(
buf
, "<!--#", 5) != 0) {

3173 
š_ssi_g
 = 0;

3174 } ià(
Ën
 =ğ(è(
buf
) - 2) {

3175 
	`üy
(
cÚn
, "%s: SSIag i toØÏrge", 
·th
);

3176 
Ën
 = 0;

3178 
buf
[
Ën
++] = 
ch
 & 0xff;

3179 } ià(
ch
 == '<') {

3180 
š_ssi_g
 = 1;

3181 ià(
Ën
 > 0) {

3182 (è
	`mg_wr™e
(
cÚn
, 
buf
, (
size_t
)
Ën
);

3184 
Ën
 = 0;

3185 
buf
[
Ën
++] = 
ch
 & 0xff;

3187 
buf
[
Ën
++] = 
ch
 & 0xff;

3188 ià(
Ën
 =ğ(è(
buf
)) {

3189 (è
	`mg_wr™e
(
cÚn
, 
buf
, (
size_t
)
Ën
);

3190 
Ën
 = 0;

3196 ià(
Ën
 > 0) {

3197 (è
	`mg_wr™e
(
cÚn
, 
buf
, (
size_t
)
Ën
);

3199 
	}
}

3201 
	$hªdË_ssi_fe_»que¡
(
mg_cÚÃùiÚ
 *
cÚn
,

3202 cÚ¡ *
·th
) {

3203 
FILE
 *
å
;

3205 ià((
å
 = 
	`mg_fİ’
(
·th
, "rb")è=ğ
NULL
) {

3206 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, 
h‰p_500_”rÜ
, "fİ’(%s): %s", 
·th
,

3207 
	`¡»¼Ü
(
ERRNO
));

3209 
	`£t_şo£_Ú_exec
(
	`f’o
(
å
));

3210 
	`mg_´štf
(
cÚn
, "HTTP/1.1 200 OK\r\n"

3212 
	`sugge¡_cÚÃùiÚ_h—d”
(
cÚn
));

3213 
	`£nd_ssi_fe
(
cÚn
, 
·th
, 
å
, 0);

3214 (è
	`fşo£
(
å
);

3216 
	}
}

3222 
	$hªdË_»que¡
(
mg_cÚÃùiÚ
 *
cÚn
) {

3223 
mg_»que¡_šfo
 *
ri
 = &
cÚn
->
»que¡_šfo
;

3224 
·th
[
PATH_MAX
];

3225 
uri_Ën
;

3226 
mg¡©
 
¡
;

3228 ià((
cÚn
->
»que¡_šfo
.
qu”y_¡ršg
 = 
	`¡rchr
(
ri
->
uri
, '?')è!ğ
NULL
) {

3229 * 
cÚn
->
»que¡_šfo
.
qu”y_¡ršg
++ = '\0';

3231 
uri_Ën
 = (è
	`¡¾’
(
ri
->
uri
);

3232 (è
	`u¾_decode
(
ri
->
uri
, (
size_t
)
uri_Ën
,„i->uri, (size_t)(uri_len + 1), 0);

3233 
	`»move_doubË_dÙs_ªd_doubË_¦ashes
(
ri
->
uri
);

3234 
	`cÚv”t_uri_to_fe_Çme
(
cÚn
, 
ri
->
uri
, 
·th
, (path));

3236 
	`DEBUG_TRACE
(("%s", 
ri
->
uri
));

3238 
	`·r£_auth_h—d”
(
cÚn
);

3240 ià(
	`ÿÎ_u£r
(
cÚn
, 
MG_AUTHENTICATE
è!ğ
NULL
) {

3242 } ià(!
	`check_authÜiz©iÚ
(
cÚn
, 
·th
)) {

3243 
	`mg_£nd_authÜiz©iÚ_»que¡
(
cÚn
, 
NULL
);

3244 } ià(
	`ÿÎ_u£r
(
cÚn
, 
MG_NEW_REQUEST
è!ğ
NULL
) {

3246 } ià(
	`¡r¡r
(
·th
, 
PASSWORDS_FILE_NAME
)) {

3248 
	`£nd_h‰p_”rÜ
(
cÚn
, 403, "Forbidden", "Access Forbidden");

3249 } ià(
cÚn
->
ùx
->
cÚfig
[
DOCUMENT_ROOT
] =ğ
NULL
) {

3250 
	`£nd_h‰p_”rÜ
(
cÚn
, 404, "Not Found", "Not Found");

3251 } ià((!
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "PUT") ||

3252 !
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "DELETE")) &&

3253 (
cÚn
->
ùx
->
cÚfig
[
PUT_DELETE_PASSWORDS_FILE
] =ğ
NULL
 ||

3254 !
	`is_authÜized_fÜ_put
(
cÚn
))) {

3255 
	`mg_£nd_authÜiz©iÚ_»que¡
(
cÚn
, 
NULL
);

3256 } ià(!
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "PUT")) {

3257 
	`put_fe
(
cÚn
, 
·th
);

3258 } ià(!
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "DELETE")) {

3259 ià(
	`mg_»move
(
·th
) == 0) {

3260 
	`£nd_h‰p_”rÜ
(
cÚn
, 200, "OK", "");

3262 
	`£nd_h‰p_”rÜ
(
cÚn
, 500, 
h‰p_500_”rÜ
, "»move(%s): %s", 
·th
,

3263 
	`¡»¼Ü
(
ERRNO
));

3265 } ià(
	`mg_¡©
(
·th
, &
¡
) != 0) {

3266 
	`£nd_h‰p_”rÜ
(
cÚn
, 404, "Not Found", "%s", "File‚ot found");

3267 } ià(
¡
.
is_dœeùÜy
 && 
ri
->
uri
[
uri_Ën
 - 1] != '/') {

3268 (è
	`mg_´štf
(
cÚn
,

3270 "LoÿtiÚ: %s/\r\n\r\n", 
ri
->
uri
);

3271 } ià(
¡
.
is_dœeùÜy
 &&

3272 !
	`sub¡™u‹_šdex_fe
(
cÚn
, 
·th
, Õ©h), &
¡
)) {

3273 ià(!
	`mg_¡rÿ£cmp
(
cÚn
->
ùx
->
cÚfig
[
ENABLE_DIRECTORY_LISTING
], "yes")) {

3274 
	`hªdË_dœeùÜy_»que¡
(
cÚn
, 
·th
);

3276 
	`£nd_h‰p_”rÜ
(
cÚn
, 403, "Directory Listing Denied",

3279 } ià(
	`m©ch_ex‹nsiÚ
(
·th
, 
cÚn
->
ùx
->
cÚfig
[
CGI_EXTENSIONS
])) {

3280 ià(
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "POST") &&

3281 
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "GET")) {

3282 
	`£nd_h‰p_”rÜ
(
cÚn
, 501, "Not Implemented",

3283 "M‘hod % i nÙ im¶em’‹d", 
ri
->
»que¡_m‘hod
);

3285 
	`hªdË_cgi_»que¡
(
cÚn
, 
·th
);

3287 } ià(
	`m©ch_ex‹nsiÚ
(
·th
, 
cÚn
->
ùx
->
cÚfig
[
SSI_EXTENSIONS
])) {

3288 
	`hªdË_ssi_fe_»que¡
(
cÚn
, 
·th
);

3289 } ià(
	`is_nÙ_modif›d
(
cÚn
, &
¡
)) {

3290 
	`£nd_h‰p_”rÜ
(
cÚn
, 304, "Not Modified", "");

3292 
	`hªdË_fe_»que¡
(
cÚn
, 
·th
, &
¡
);

3294 
	}
}

3296 
	$şo£_®l_li¡’šg_sock‘s
(
mg_cÚ‹xt
 *
ùx
) {

3297 
sock‘
 *
¥
, *
tmp
;

3298 
¥
 = 
ùx
->
li¡’šg_sock‘s
; s°!ğ
NULL
; s°ğ
tmp
) {

3299 
tmp
 = 
¥
->
Ãxt
;

3300 (è
	`şo£sock‘
(
¥
->
sock
);

3301 
	`ä“
(
¥
);

3303 
	}
}

3307 
	$·r£_pÜt_¡ršg
(cÚ¡ 
vec
 *vec, 
sock‘
 *
so
) {

3308 
u§
 *u§ = &
so
->
l§
;

3309 
a
, 
b
, 
c
, 
d
, 
pÜt
, 
Ën
;

3312 
	`mem£t
(
so
, 0, (*so));

3314 ià(
	`ssÿnf
(
vec
->
±r
, "%d.%d.%d.%d:%d%n", &
a
, &
b
, &
c
, &
d
, &
pÜt
, &
Ën
) == 5) {

3316 
u§
->
u
.
sš
.
sš_addr
.
s_addr
 = 
	`htÚl
((
a
 << 24è| (
b
 << 16è| (
c
 << 8è| 
d
);

3317 } ià(
	`ssÿnf
(
vec
->
±r
, "%d%n", &
pÜt
, &
Ën
) == 1) {

3319 
u§
->
u
.
sš
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

3323 
	`as£¹
(
Ën
 > 0 &&†’ <ğ(è
vec
->len);

3325 ià(
	`¡rchr
("¥,", 
vec
->
±r
[
Ën
]è=ğ
NULL
) {

3329 
so
->
is_s¦
 = 
vec
->
±r
[
Ën
] == 's';

3330 
so
->
is_´oxy
 = 
vec
->
±r
[
Ën
] == 'p';

3331 
u§
->
Ën
 = (u§->
u
.
sš
);

3332 
u§
->
u
.
sš
.
sš_çmy
 = 
AF_INET
;

3333 
u§
->
u
.
sš
.
sš_pÜt
 = 
	`htÚs
((
ušt16_t
è
pÜt
);

3336 
	}
}

3338 
	$£t_pÜts_İtiÚ
(
mg_cÚ‹xt
 *
ùx
) {

3339 cÚ¡ *
li¡
 = 
ùx
->
cÚfig
[
LISTENING_PORTS
];

3340 
»u£addr
 = 1, 
sucûss
 = 1;

3341 
SOCKET
 
sock
;

3342 
vec
 vec;

3343 
sock‘
 
so
, *
li¡’”
;

3345 
sucûss
 && (
li¡
 = 
	`Ãxt_İtiÚ
Öi¡, &
vec
, 
NULL
)) != NULL) {

3346 ià(!
	`·r£_pÜt_¡ršg
(&
vec
, &
so
)) {

3347 
	`üy
(
	`fc
(
ùx
), "%s: %.*s: invalid…ort spec. Expecting†ist of: %s",

3348 
__func__
, 
vec
.
Ën
, vec.
±r
, "[IP_ADDRESS:]PORT[s|p]");

3349 
sucûss
 = 0;

3350 } ià(
so
.
is_s¦
 && 
ùx
->
s¦_ùx
 =ğ
NULL
) {

3351 
	`üy
(
	`fc
(
ùx
), "Cannot‡dd SSL socket, is -ssl_cert option set?");

3352 
sucûss
 = 0;

3353 } ià((
sock
 = 
	`sock‘
(
PF_INET
, 
SOCK_STREAM
, 6)è=ğ
INVALID_SOCKET
 ||

3354 #ià!
	`defšed
(
_WIN32
)

3357 
	`£tsockİt
(
sock
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
»u£addr
,

3358 (
»u£addr
)) != 0 ||

3360 
	`bšd
(
sock
, &
so
.
l§
.
u
.
§
, so.l§.
Ën
) != 0 ||

3361 
	`li¡’
(
sock
, 20) != 0) {

3362 
	`şo£sock‘
(
sock
);

3363 
	`üy
(
	`fc
(
ùx
), "%s: cªnÙ bšdØ%.*s: %s", 
__func__
,

3364 
vec
.
Ën
, vec.
±r
, 
	`¡»¼Ü
(
ERRNO
));

3365 
sucûss
 = 0;

3366 } ià((
li¡’”
 = ((
sock‘
*è
	`ÿÎoc
(1, (*li¡’”)))è=ğ
NULL
) {

3367 
	`şo£sock‘
(
sock
);

3368 
	`üy
(
	`fc
(
ùx
), "%s: %s", 
__func__
, 
	`¡»¼Ü
(
ERRNO
));

3369 
sucûss
 = 0;

3371 *
li¡’”
 = 
so
;

3372 
li¡’”
->
sock
 = sock;

3373 
	`£t_şo£_Ú_exec
(
li¡’”
->
sock
);

3374 
li¡’”
->
Ãxt
 = 
ùx
->
li¡’šg_sock‘s
;

3375 
ùx
->
li¡’šg_sock‘s
 = 
li¡’”
;

3379 ià(!
sucûss
) {

3380 
	`şo£_®l_li¡’šg_sock‘s
(
ùx
);

3383  
sucûss
;

3384 
	}
}

3386 
	$log_h—d”
(cÚ¡ 
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
h—d”
,

3387 
FILE
 *
å
) {

3388 cÚ¡ *
h—d”_v®ue
;

3390 ià((
h—d”_v®ue
 = 
	`mg_g‘_h—d”
(
cÚn
, 
h—d”
)è=ğ
NULL
) {

3391 (è
	`årštf
(
å
, "%s", " -");

3393 (è
	`årštf
(
å
, " \"%s\"", 
h—d”_v®ue
);

3395 
	}
}

3397 
	$log_acûss
(cÚ¡ 
mg_cÚÃùiÚ
 *
cÚn
) {

3398 cÚ¡ 
mg_»que¡_šfo
 *
ri
;

3399 
FILE
 *
å
;

3400 
d©e
[64];

3402 
å
 = 
cÚn
->
ùx
->
cÚfig
[
ACCESS_LOG_FILE
] =ğ
NULL
 ? NULL :

3403 
	`mg_fİ’
(
cÚn
->
ùx
->
cÚfig
[
ACCESS_LOG_FILE
], "a+");

3405 ià(
å
 =ğ
NULL
)

3408 (è
	`¡ráime
(
d©e
, (date), "%d/%b/%Y:%H:%M:%S %z",

3409 
	`loÿÉime
(&
cÚn
->
bœth_time
));

3411 
ri
 = &
cÚn
->
»que¡_šfo
;

3413 
	`æockfe
(
å
);

3415 (è
	`årštf
(
å
,

3416 "% - % [%s] \"% % HTTP/%s\" %d %" 
INT64_FMT
,

3417 
	`š‘_Áß
(
cÚn
->
ş›Á
.
r§
.
u
.
sš
.
sš_addr
),

3418 
ri
->
»mÙe_u£r
 =ğ
NULL
 ? "-" :„i->remote_user,

3419 
d©e
,

3420 
ri
->
»que¡_m‘hod
 ?„i->request_method : "-",

3421 
ri
->
uri
 ?„i->uri : "-",

3422 
ri
->
h‰p_v”siÚ
,

3423 
cÚn
->
»que¡_šfo
.
¡©us_code
, cÚn->
num_by‹s_£Á
);

3424 
	`log_h—d”
(
cÚn
, "Reã»r", 
å
);

3425 
	`log_h—d”
(
cÚn
, "U£r-Ag’t", 
å
);

3426 (è
	`åutc
('\n', 
å
);

3427 (è
	`fæush
(
å
);

3429 
	`fuÆockfe
(
å
);

3430 (è
	`fşo£
(
å
);

3431 
	}
}

3433 
	$isby‹
(
n
) {

3434  
n
 >= 0 &&‚ <= 255;

3435 
	}
}

3439 
	$check_aş
(
mg_cÚ‹xt
 *
ùx
, cÚ¡ 
u§
 *usa) {

3440 
a
, 
b
, 
c
, 
d
, 
n
, 
mask
, 
®lowed
;

3441 
æag
;

3442 
ušt32_t
 
aş_subÃt
, 
aş_mask
, 
»mÙe_
;

3443 
vec
 vec;

3444 cÚ¡ *
li¡
 = 
ùx
->
cÚfig
[
ACCESS_CONTROL_LIST
];

3446 ià(
li¡
 =ğ
NULL
) {

3450 (è
	`memıy
(&
»mÙe_
, &
u§
->
u
.
sš
.
sš_addr
, (remote_ip));

3453 
®lowed
 = '-';

3455 (
li¡
 = 
	`Ãxt_İtiÚ
Öi¡, &
vec
, 
NULL
)) != NULL) {

3456 
mask
 = 32;

3458 ià(
	`ssÿnf
(
vec
.
±r
, "%c%d.%d.%d.%d%n", &
æag
, &
a
, &
b
, &
c
, &
d
, &
n
) != 5) {

3459 
	`üy
(
	`fc
(
ùx
), "%s: subÃˆmu¡ b[+|-]x.x.x.x[/x]", 
__func__
);

3461 } ià(
æag
 != '+' && flag != '-') {

3462 
	`üy
(
	`fc
(
ùx
), "%s: fÏg mu¡ b+ o¸-: [%s]", 
__func__
, 
vec
.
±r
);

3464 } ià(!
	`isby‹
(
a
)||!isby‹(
b
)||!isby‹(
c
)||!isby‹(
d
)) {

3465 
	`üy
(
	`fc
(
ùx
), "%s: bad i°add»ss: [%s]", 
__func__
, 
vec
.
±r
);

3467 } ià(
	`ssÿnf
(
vec
.
±r
 + 
n
, "/%d", &
mask
) == 0) {

3469 } ià(
mask
 < 0 || mask > 32) {

3470 
	`üy
(
	`fc
(
ùx
), "%s: bad subÃˆmask: %d [%s]", 
__func__
, 
n
, 
vec
.
±r
);

3474 
aş_subÃt
 = (
a
 << 24è| (
b
 << 16è| (
c
 << 8è| 
d
;

3475 
aş_mask
 = 
mask
 ? 0xffffffffU << (32 - mask) : 0;

3477 ià(
aş_subÃt
 =ğ(
	`Áohl
(
»mÙe_
è& 
aş_mask
)) {

3478 
®lowed
 = 
æag
;

3482  
®lowed
 == '+';

3483 
	}
}

3485 
	$add_to_£t
(
SOCKET
 
fd
, 
fd_£t
 *
£t
, *
max_fd
) {

3486 
	`FD_SET
(
fd
, 
£t
);

3487 ià(
fd
 > (
SOCKET
è*
max_fd
) {

3488 *
max_fd
 = (è
fd
;

3490 
	}
}

3492 #ià!
defšed
(
_WIN32
)

3493 
	$£t_uid_İtiÚ
(
mg_cÚ‹xt
 *
ùx
) {

3494 
·sswd
 *
pw
;

3495 cÚ¡ *
uid
 = 
ùx
->
cÚfig
[
RUN_AS_USER
];

3496 
sucûss
 = 0;

3498 ià(
uid
 =ğ
NULL
) {

3499 
sucûss
 = 1;

3501 ià((
pw
 = 
	`g‘pwÇm
(
uid
)è=ğ
NULL
) {

3502 
	`üy
(
	`fc
(
ùx
), "%s: unknowÀu£¸[%s]", 
__func__
, 
uid
);

3503 } ià(
	`£tgid
(
pw
->
pw_gid
) == -1) {

3504 
	`üy
(
	`fc
(
ùx
), "%s: s‘gid(%s): %s", 
__func__
, 
uid
, 
	`¡»¼Ü
(
”ºo
));

3505 } ià(
	`£tuid
(
pw
->
pw_uid
) == -1) {

3506 
	`üy
(
	`fc
(
ùx
), "%s: s‘uid(%s): %s", 
__func__
, 
uid
, 
	`¡»¼Ü
(
”ºo
));

3508 
sucûss
 = 1;

3512  
sucûss
;

3513 
	}
}

3516 #ià!
defšed
(
NO_SSL
)

3517 
±h»ad_mu‹x_t
 *
	gs¦_mu‹xes
;

3519 
	$s¦_lockšg_ÿÎback
(
mode
, 
mu‹x_num
, cÚ¡ *
fe
,

3520 
lše
) {

3521 
lše
 = 0;

3522 
fe
 = 
NULL
;

3524 ià(
mode
 & 
CRYPTO_LOCK
) {

3525 (è
	`±h»ad_mu‹x_lock
(&
s¦_mu‹xes
[
mu‹x_num
]);

3527 (è
	`±h»ad_mu‹x_uÆock
(&
s¦_mu‹xes
[
mu‹x_num
]);

3529 
	}
}

3531 
	$s¦_id_ÿÎback
() {

3532  (è
	`±h»ad_£lf
();

3533 
	}
}

3535 #ià!
defšed
(
NO_SSL_DL
)

3536 
	$lßd_dÎ
(
mg_cÚ‹xt
 *
ùx
, cÚ¡ *
dÎ_Çme
,

3537 
s¦_func
 *
sw
) {

3538 uniÚ {*
p
; (*
å
)();} 
u
;

3539 *
dÎ_hªdË
;

3540 
s¦_func
 *
å
;

3542 ià((
dÎ_hªdË
 = 
	`dlİ’
(
dÎ_Çme
, 
RTLD_LAZY
)è=ğ
NULL
) {

3543 
	`üy
(
	`fc
(
ùx
), "%s: cªnÙ†ßd %s", 
__func__
, 
dÎ_Çme
);

3547 
å
 = 
sw
; fp->
Çme
 !ğ
NULL
; fp++) {

3548 #ifdeà
_WIN32


3550 
u
.
å
 = ((*)()è
	`dlsym
(
dÎ_hªdË
, fp->
Çme
);

3554 
u
.
p
 = 
	`dlsym
(
dÎ_hªdË
, 
å
->
Çme
);

3556 ià(
u
.
å
 =ğ
NULL
) {

3557 
	`üy
(
	`fc
(
ùx
), "%s: %s: cªnÙ fšd %s", 
__func__
, 
dÎ_Çme
, 
å
->
Çme
);

3560 
å
->
±r
 = 
u
.fp;

3565 
	}
}

3569 
	$£t_s¦_İtiÚ
(
mg_cÚ‹xt
 *
ùx
) {

3570 
SSL_CTX
 *
CTX
;

3571 
i
, 
size
;

3572 cÚ¡ *
³m
 = 
ùx
->
cÚfig
[
SSL_CERTIFICATE
];

3573 cÚ¡ *
chaš
 = 
ùx
->
cÚfig
[
SSL_CHAIN_FILE
];

3575 ià(
³m
 =ğ
NULL
) {

3579 #ià!
	`defšed
(
NO_SSL_DL
)

3580 ià(!
	`lßd_dÎ
(
ùx
, 
SSL_LIB
, 
s¦_sw
) ||

3581 !
	`lßd_dÎ
(
ùx
, 
CRYPTO_LIB
, 
üy±o_sw
)) {

3587 
	`SSL_lib¿ry_š™
();

3588 
	`SSL_lßd_”rÜ_¡ršgs
();

3590 ià((
CTX
 = 
	`SSL_CTX_Ãw
(
	`SSLv23_£rv”_m‘hod
())è=ğ
NULL
) {

3591 
	`üy
(
	`fc
(
ùx
), "SSL_CTX_Ãwƒ¼Ü: %s", 
	`s¦_”rÜ
());

3592 } ià(
ùx
->
u£r_ÿÎback
 !ğ
NULL
) {

3593 
ùx
->
	`u£r_ÿÎback
(
MG_INIT_SSL
, (
mg_cÚÃùiÚ
 *è
CTX
, 
NULL
);

3596 ià(
CTX
 !ğ
NULL
 && 
	`SSL_CTX_u£_û¹ifiÿ‹_fe
(CTX, 
³m
,

3597 
SSL_FILETYPE_PEM
) == 0) {

3598 
	`üy
(
	`fc
(
ùx
), "%s: cªnÙ o³À%s: %s", 
__func__
, 
³m
, 
	`s¦_”rÜ
());

3600 } ià(
CTX
 !ğ
NULL
 && 
	`SSL_CTX_u£_Priv©eKey_fe
(CTX, 
³m
,

3601 
SSL_FILETYPE_PEM
) == 0) {

3602 
	`üy
(
	`fc
(
ùx
), "%s: cªnÙ o³À%s: %s", 
NULL
, 
³m
, 
	`s¦_”rÜ
());

3606 ià(
CTX
 !ğ
NULL
 && 
chaš
 != NULL &&

3607 
	`SSL_CTX_u£_û¹ifiÿ‹_chaš_fe
(
CTX
, 
chaš
) == 0) {

3608 
	`üy
(
	`fc
(
ùx
), "%s: cªnÙ o³À%s: %s", 
NULL
, 
chaš
, 
	`s¦_”rÜ
());

3614 
size
 = (è((
±h»ad_mu‹x_t
è* 
	`CRYPTO_num_locks
());

3615 ià((
s¦_mu‹xes
 = (
±h»ad_mu‹x_t
 *è
	`m®loc
((
size_t
)
size
)è=ğ
NULL
) {

3616 
	`üy
(
	`fc
(
ùx
), "%s: cªnÙ‡Îoÿ‹ mu‹xes: %s", 
__func__
, 
	`s¦_”rÜ
());

3620 
i
 = 0; i < 
	`CRYPTO_num_locks
(); i++) {

3621 
	`±h»ad_mu‹x_š™
(&
s¦_mu‹xes
[
i
], 
NULL
);

3624 
	`CRYPTO_£t_lockšg_ÿÎback
(&
s¦_lockšg_ÿÎback
);

3625 
	`CRYPTO_£t_id_ÿÎback
(&
s¦_id_ÿÎback
);

3628 
ùx
->
s¦_ùx
 = 
CTX
;

3631 
	}
}

3634 
	$£t_g·ss_İtiÚ
(
mg_cÚ‹xt
 *
ùx
) {

3635 
mg¡©
 mgstat;

3636 cÚ¡ *
·th
 = 
ùx
->
cÚfig
[
GLOBAL_PASSWORDS_FILE
];

3637  
·th
 =ğ
NULL
 || 
	`mg_¡©
Õ©h, &
mg¡©
) == 0;

3638 
	}
}

3640 
	$£t_aş_İtiÚ
(
mg_cÚ‹xt
 *
ùx
) {

3641 
u§
 
çke
;

3642 
	`mem£t
(&
çke
, 0, (fake));

3643  
	`check_aş
(
ùx
, &
çke
) != -1;

3644 
	}
}

3646 
	$»£t_³r_»que¡_©Œibu‹s
(
mg_cÚÃùiÚ
 *
cÚn
) {

3647 
mg_»que¡_šfo
 *
ri
 = &
cÚn
->
»que¡_šfo
;

3650 ià(
ri
->
»mÙe_u£r
 !ğ
NULL
) {

3651 
	`ä“
((*è
ri
->
»mÙe_u£r
);

3653 ià(
ri
->
ah
 !ğ
NULL
) {

3654 ià(
ri
->
ah
->
ha1
 !ğ
NULL
) {

3655 
	`ä“
((*è
ri
->
ah
->
ha1
);

3657 ià(
ri
->
ah
->
ex³ùed_»¥Ú£
 !ğ
NULL
) {

3658 
	`ä“
((*è
ri
->
ah
->
ex³ùed_»¥Ú£
);

3660 
	`ä“
((*è
ri
->
ah
);

3662 
ri
->
»mÙe_u£r
 =„i->
»que¡_m‘hod
 =„i->
uri
 =„i->
h‰p_v”siÚ
 = 
NULL
;

3663 
ri
->
ah
 = 
NULL
;

3664 
ri
->
num_h—d”s
 = 0;

3665 
ri
->
¡©us_code
 = -1;

3667 ià(
cÚn
->
auth_h—d”
 !ğ
NULL
) {

3668 
	`ä“
((*è
cÚn
->
auth_h—d”
);

3670 
cÚn
->
auth_h—d”
 = 
NULL
;

3671 
cÚn
->
num_by‹s_£Á
 = cÚn->
cÚsumed_cÚ‹Á
 = 0;

3672 
cÚn
->
cÚ‹Á_Ën
 = -1;

3673 
cÚn
->
»que¡_Ën
 = cÚn->
d©a_Ën
 = 0;

3674 
	}
}

3676 
	$şo£_sock‘_g¿ûfuÎy
(
SOCKET
 
sock
) {

3677 
buf
[
BUFSIZ
];

3678 
n
;

3681 (è
	`shutdown
(
sock
, 
SHUT_WR
);

3682 
	`£t_nÚ_blockšg_mode
(
sock
);

3690 
n
 = 
	`puÎ
(
NULL
, 
sock
, NULL, 
buf
, (buf));

3691 } 
n
 > 0);

3694 (è
	`şo£sock‘
(
sock
);

3695 
	}
}

3697 
	$şo£_cÚÃùiÚ
(
mg_cÚÃùiÚ
 *
cÚn
) {

3698 ià(
cÚn
->
s¦
) {

3699 
	`SSL_ä“
(
cÚn
->
s¦
);

3700 
cÚn
->
s¦
 = 
NULL
;

3703 ià(
cÚn
->
ş›Á
.
sock
 !ğ
INVALID_SOCKET
) {

3704 
	`şo£_sock‘_g¿ûfuÎy
(
cÚn
->
ş›Á
.
sock
);

3706 
	}
}

3708 
	$disÿrd_cu¼’t_»que¡_äom_bufãr
(
mg_cÚÃùiÚ
 *
cÚn
) {

3709 *
bufã»d
;

3710 
bufã»d_Ën
, 
body_Ën
;

3712 
bufã»d
 = 
cÚn
->
buf
 + cÚn->
»que¡_Ën
;

3713 
bufã»d_Ën
 = 
cÚn
->
d©a_Ën
 - cÚn->
»que¡_Ën
;

3714 
	`as£¹
(
bufã»d_Ën
 >= 0);

3716 ià(
cÚn
->
cÚ‹Á_Ën
 == -1) {

3717 
body_Ën
 = 0;

3718 } ià(
cÚn
->
cÚ‹Á_Ën
 < (
št64_t
è
bufã»d_Ën
) {

3719 
body_Ën
 = (è
cÚn
->
cÚ‹Á_Ën
;

3721 
body_Ën
 = 
bufã»d_Ën
;

3724 
cÚn
->
d©a_Ën
 -ğcÚn->
»que¡_Ën
 + 
body_Ën
;

3725 
	`memmove
(
cÚn
->
buf
, cÚn->buà+ cÚn->
»que¡_Ën
 + 
body_Ën
, (
size_t
)cÚn->
d©a_Ën
);

3726 
	}
}

3728 
	$·r£_u¾
(cÚ¡ *
u¾
, *
ho¡
, *
pÜt
) {

3729 
Ën
;

3731 ià(
u¾
 =ğ
NULL
) {

3735 ià(!
	`¡ºcmp
(
u¾
, "http://", 7)) {

3736 
u¾
 += 7;

3739 ià(
	`ssÿnf
(
u¾
, "%1024[^:]:%d/%n", 
ho¡
, 
pÜt
, &
Ën
) == 2) {

3741 
	`ssÿnf
(
u¾
, "%1024[^/]/%n", 
ho¡
, &
Ën
);

3742 *
pÜt
 = 80;

3744 
	`DEBUG_TRACE
(("Ho¡:%s,…Üt:%d", 
ho¡
, *
pÜt
));

3746  
Ën
 > 0 && 
u¾
[len - 1] == '/' ?†en - 1 :†en;

3747 
	}
}

3749 
	$hªdË_´oxy_»que¡
(
mg_cÚÃùiÚ
 *
cÚn
) {

3750 
mg_»que¡_šfo
 *
ri
 = &
cÚn
->
»que¡_šfo
;

3751 
ho¡
[1025], 
buf
[
BUFSIZ
];

3752 
pÜt
, 
is_s¦
, 
Ën
, 
i
, 
n
;

3754 
	`DEBUG_TRACE
(("URL: %s", 
ri
->
uri
));

3755 ià(
cÚn
->
»que¡_šfo
.
uri
[0] == '/' ||

3756 (
Ën
 = 
	`·r£_u¾
(
ri
->
uri
, 
ho¡
, &
pÜt
)) == 0) {

3760 ià(
cÚn
->
³”
 =ğ
NULL
) {

3761 
is_s¦
 = !
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "CONNECT");

3762 ià((
cÚn
->
³”
 = 
	`mg_cÚÃù
(cÚn, 
ho¡
, 
pÜt
, 
is_s¦
)è=ğ
NULL
) {

3765 
cÚn
->
³”
->
ş›Á
.
is_s¦
 = is_ssl;

3769 
	`mg_´štf
(
cÚn
->
³”
, "% % HTTP/%s\r\n", 
ri
->
»que¡_m‘hod
,„i->
uri
 + 
Ën
,

3770 
ri
->
h‰p_v”siÚ
);

3773 
i
 = 0; i < 
ri
->
num_h—d”s
; i++) {

3774 
	`mg_´štf
(
cÚn
->
³”
, "%s: %s\r\n", 
ri
->
h‰p_h—d”s
[
i
].
Çme
,

3775 
ri
->
h‰p_h—d”s
[
i
].
v®ue
);

3778 
	`mg_wr™e
(
cÚn
->
³”
, "\r\n", 2);

3781 ià(!
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "POST")) {

3782 
	`fÜw¬d_body_d©a
(
cÚn
, 
NULL
, cÚn->
³”
->
ş›Á
.
sock
, cÚn->³”->
s¦
);

3786 (
n
 = 
	`puÎ
(
NULL
, 
cÚn
->
³”
->
ş›Á
.
sock
, cÚn->³”->
s¦
,

3787 
buf
, (buf))) > 0) {

3788 ià(
	`mg_wr™e
(
cÚn
, 
buf
, (
size_t
)
n
) !=‚) {

3793 ià(!
cÚn
->
³”
->
ş›Á
.
is_s¦
) {

3794 
	`şo£_cÚÃùiÚ
(
cÚn
->
³”
);

3795 
	`ä“
(
cÚn
->
³”
);

3796 
cÚn
->
³”
 = 
NULL
;

3798 
	}
}

3800 
	$is_v®id_uri
(cÚ¡ *
uri
) {

3803  (
uri
[0] == '/' || (uri[0] == '*' && uri[1] == '\0'));

3804 
	}
}

3806 
	$´oûss_Ãw_cÚÃùiÚ
(
mg_cÚÃùiÚ
 *
cÚn
) {

3807 
mg_»que¡_šfo
 *
ri
 = &
cÚn
->
»que¡_šfo
;

3808 
k“p_®ive_’abËd
;

3809 cÚ¡ *
ş
;

3811 
k“p_®ive_’abËd
 = !
	`¡rcmp
(
cÚn
->
ùx
->
cÚfig
[
ENABLE_KEEP_ALIVE
], "yes");

3814 
	`»£t_³r_»que¡_©Œibu‹s
(
cÚn
);

3817 ià((
cÚn
->
»que¡_Ën
 = 
	`g‘_»que¡_Ën
(cÚn->
buf
, cÚn->
d©a_Ën
)) == 0) {

3818 
cÚn
->
»que¡_Ën
 = 
	`»ad_»que¡
(
NULL
, cÚn->
ş›Á
.
sock
, cÚn->
s¦
,

3819 
cÚn
->
buf
, cÚn->
buf_size
, &cÚn->
d©a_Ën
);

3821 
	`as£¹
(
cÚn
->
d©a_Ën
 >ğcÚn->
»que¡_Ën
);

3822 ià(
cÚn
->
»que¡_Ën
 =ğ0 && cÚn->
d©a_Ën
 =ğcÚn->
buf_size
) {

3823 
	`£nd_h‰p_”rÜ
(
cÚn
, 413, "Request Too Large", "");

3825 } ià(
cÚn
->
»que¡_Ën
 <= 0) {

3830 
cÚn
->
buf
[cÚn->
»que¡_Ën
 - 1] = '\0';

3831 ià(!
	`·r£_h‰p_»que¡
(
cÚn
->
buf
, 
ri
) ||

3832 (!
cÚn
->
ş›Á
.
is_´oxy
 && !
	`is_v®id_uri
(
ri
->
uri
))) {

3834 
	`£nd_h‰p_”rÜ
(
cÚn
, 400, "Bad Request",

3835 "CªnÙ…¬£ HTTP„eque¡: [%.*s]", 
cÚn
->
d©a_Ën
, cÚn->
buf
);

3836 } ià(
	`¡rcmp
(
ri
->
h‰p_v”siÚ
, "1.0") &&

3837 
	`¡rcmp
(
ri
->
h‰p_v”siÚ
, "1.1")) {

3839 
	`£nd_h‰p_”rÜ
(
cÚn
, 505, "HTTP version‚ot supported", "");

3840 
	`log_acûss
(
cÚn
);

3843 
ş
 = 
	`g‘_h—d”
(
ri
, "Content-Length");

3844 
cÚn
->
cÚ‹Á_Ën
 = 
ş
 =ğ
NULL
 ? -1 : 
	`¡¹Şl
(cl, NULL, 10);

3845 
cÚn
->
bœth_time
 = 
	`time
(
NULL
);

3846 ià(
cÚn
->
ş›Á
.
is_´oxy
) {

3847 
	`hªdË_´oxy_»que¡
(
cÚn
);

3849 
	`hªdË_»que¡
(
cÚn
);

3851 
	`log_acûss
(
cÚn
);

3852 
	`disÿrd_cu¼’t_»que¡_äom_bufãr
(
cÚn
);

3855 } 
cÚn
->
³”
 || (
k“p_®ive_’abËd
 && 
	`should_k“p_®ive
(conn)));

3856 
	`»£t_³r_»que¡_©Œibu‹s
(
cÚn
);

3857 
	}
}

3860 
	$cÚsume_sock‘
(
mg_cÚ‹xt
 *
ùx
, 
sock‘
 *
¥
) {

3861 (è
	`±h»ad_mu‹x_lock
(&
ùx
->
mu‹x
);

3862 
	`DEBUG_TRACE
(("going idle"));

3865 
ùx
->
sq_h—d
 =ğùx->
sq_
 && ctx->
¡İ_æag
 == 0) {

3866 
	`±h»ad_cÚd_wa™
(&
ùx
->
sq_fuÎ
, &ùx->
mu‹x
);

3870 ià(
ùx
->
¡İ_æag
) {

3871 (è
	`±h»ad_mu‹x_uÆock
(&
ùx
->
mu‹x
);

3874 
	`as£¹
(
ùx
->
sq_h—d
 > ctx->
sq_
);

3877 *
¥
 = 
ùx
->
queue
[ùx->
sq_
 % 
	`ARRAY_SIZE
(ctx->queue)];

3878 
ùx
->
sq_
++;

3879 
	`DEBUG_TRACE
(("g¿bbed sock‘ %d, gošg busy", 
¥
->
sock
));

3882 
ùx
->
sq_
 > (è
	`ARRAY_SIZE
(ùx->
queue
)) {

3883 
ùx
->
sq_
 -ğ(è
	`ARRAY_SIZE
(ùx->
queue
);

3884 
ùx
->
sq_h—d
 -ğ(è
	`ARRAY_SIZE
(ùx->
queue
);

3887 (è
	`±h»ad_cÚd_sigÇl
(&
ùx
->
sq_em±y
);

3888 (è
	`±h»ad_mu‹x_uÆock
(&
ùx
->
mu‹x
);

3891 
	}
}

3893 
	$wÜk”_th»ad
(
mg_cÚ‹xt
 *
ùx
) {

3894 
mg_cÚÃùiÚ
 *
cÚn
;

3895 
buf_size
 = 
	`©oi
(
ùx
->
cÚfig
[
MAX_REQUEST_SIZE
]);

3897 
cÚn
 = (
mg_cÚÃùiÚ
*è
	`ÿÎoc
(1, (*cÚnè+ 
buf_size
);

3898 
cÚn
->
buf_size
 = buf_size;

3899 
cÚn
->
buf
 = (*) (conn + 1);

3900 
	`as£¹
(
cÚn
 !ğ
NULL
);

3902 
ùx
->
¡İ_æag
 =ğ0 && 
	`cÚsume_sock‘
(ùx, &
cÚn
->
ş›Á
)) {

3903 
cÚn
->
bœth_time
 = 
	`time
(
NULL
);

3904 
cÚn
->
ùx
 = ctx;

3909 
cÚn
->
»que¡_šfo
.
»mÙe_pÜt
 = 
	`Áohs
(cÚn->
ş›Á
.
r§
.
u
.
sš
.
sš_pÜt
);

3910 
	`memıy
(&
cÚn
->
»que¡_šfo
.
»mÙe_
,

3911 &
cÚn
->
ş›Á
.
r§
.
u
.
sš
.
sš_addr
.
s_addr
, 4);

3912 
cÚn
->
»que¡_šfo
.
»mÙe_
 = (
ušt32_t
è
	`Áohl
(conn->request_info.remote_ip);

3913 
cÚn
->
»que¡_šfo
.
is_s¦
 = cÚn->
ş›Á
.is_ssl;

3915 ià(!
cÚn
->
ş›Á
.
is_s¦
 ||

3916 (
cÚn
->
ş›Á
.
is_s¦
 && 
	`s¦ize
(cÚn, 
SSL_acû±
))) {

3917 
	`´oûss_Ãw_cÚÃùiÚ
(
cÚn
);

3920 
	`şo£_cÚÃùiÚ
(
cÚn
);

3922 
	`ä“
(
cÚn
);

3925 (è
	`±h»ad_mu‹x_lock
(&
ùx
->
mu‹x
);

3926 
ùx
->
num_th»ads
--;

3927 (è
	`±h»ad_cÚd_sigÇl
(&
ùx
->
cÚd
);

3928 
	`as£¹
(
ùx
->
num_th»ads
 >= 0);

3929 (è
	`±h»ad_mu‹x_uÆock
(&
ùx
->
mu‹x
);

3931 
	`DEBUG_TRACE
(("exiting"));

3932 
	}
}

3935 
	$´oduû_sock‘
(
mg_cÚ‹xt
 *
ùx
, cÚ¡ 
sock‘
 *
¥
) {

3936 (è
	`±h»ad_mu‹x_lock
(&
ùx
->
mu‹x
);

3939 
ùx
->
sq_h—d
 - ctx->
sq_
 >ğ(è
	`ARRAY_SIZE
(ùx->
queue
)) {

3940 (è
	`±h»ad_cÚd_wa™
(&
ùx
->
sq_em±y
, &ùx->
mu‹x
);

3942 
	`as£¹
(
ùx
->
sq_h—d
 - ctx->
sq_
 < (è
	`ARRAY_SIZE
(ùx->
queue
));

3945 
ùx
->
queue
[ùx->
sq_h—d
 % 
	`ARRAY_SIZE
(ùx->queue)] = *
¥
;

3946 
ùx
->
sq_h—d
++;

3947 
	`DEBUG_TRACE
(("queued sock‘ %d", 
¥
->
sock
));

3949 (è
	`±h»ad_cÚd_sigÇl
(&
ùx
->
sq_fuÎ
);

3950 (è
	`±h»ad_mu‹x_uÆock
(&
ùx
->
mu‹x
);

3951 
	}
}

3953 
	$acû±_Ãw_cÚÃùiÚ
(cÚ¡ 
sock‘
 *
li¡’”
,

3954 
mg_cÚ‹xt
 *
ùx
) {

3955 
sock‘
 
acû±ed
;

3956 
®lowed
;

3958 
acû±ed
.
r§
.
Ën
 = ×cû±ed.r§.
u
.
sš
);

3959 
acû±ed
.
l§
 = 
li¡’”
->lsa;

3960 
acû±ed
.
sock
 = 
	`acû±
(
li¡’”
->sock, &acû±ed.
r§
.
u
.
§
, &acû±ed.r§.
Ën
);

3961 ià(
acû±ed
.
sock
 !ğ
INVALID_SOCKET
) {

3962 
®lowed
 = 
	`check_aş
(
ùx
, &
acû±ed
.
r§
);

3963 ià(
®lowed
) {

3965 
	`DEBUG_TRACE
(("acû±ed sock‘ %d", 
acû±ed
.
sock
));

3966 
acû±ed
.
is_s¦
 = 
li¡’”
->is_ssl;

3967 
acû±ed
.
is_´oxy
 = 
li¡’”
->is_proxy;

3968 
	`´oduû_sock‘
(
ùx
, &
acû±ed
);

3970 
	`üy
(
	`fc
(
ùx
), "%s: %s is‚ot‡llowedo connect",

3971 
__func__
, 
	`š‘_Áß
(
acû±ed
.
r§
.
u
.
sš
.
sš_addr
));

3972 (è
	`şo£sock‘
(
acû±ed
.
sock
);

3975 
	}
}

3977 
	$ma¡”_th»ad
(
mg_cÚ‹xt
 *
ùx
) {

3978 
fd_£t
 
»ad_£t
;

3979 
timev®
 
tv
;

3980 
sock‘
 *
¥
;

3981 
max_fd
;

3983 
ùx
->
¡İ_æag
 == 0) {

3984 
	`FD_ZERO
(&
»ad_£t
);

3985 
max_fd
 = -1;

3988 
¥
 = 
ùx
->
li¡’šg_sock‘s
; s°!ğ
NULL
; s°ğ¥->
Ãxt
) {

3989 
	`add_to_£t
(
¥
->
sock
, &
»ad_£t
, &
max_fd
);

3992 
tv
.
tv_£c
 = 0;

3993 
tv
.
tv_u£c
 = 200 * 1000;

3995 ià(
	`£Ëù
(
max_fd
 + 1, &
»ad_£t
, 
NULL
, NULL, &
tv
) < 0) {

3996 #ifdeà
_WIN32


4000 
	`¦“p
(1);

4003 
¥
 = 
ùx
->
li¡’šg_sock‘s
; s°!ğ
NULL
; s°ğ¥->
Ãxt
) {

4004 ià(
	`FD_ISSET
(
¥
->
sock
, &
»ad_£t
)) {

4005 
	`acû±_Ãw_cÚÃùiÚ
(
¥
, 
ùx
);

4010 
	`DEBUG_TRACE
(("stopping workers"));

4013 
	`şo£_®l_li¡’šg_sock‘s
(
ùx
);

4016 
	`±h»ad_cÚd_brßdÿ¡
(&
ùx
->
sq_fuÎ
);

4019 (è
	`±h»ad_mu‹x_lock
(&
ùx
->
mu‹x
);

4020 
ùx
->
num_th»ads
 > 0) {

4021 (è
	`±h»ad_cÚd_wa™
(&
ùx
->
cÚd
, &ùx->
mu‹x
);

4023 (è
	`±h»ad_mu‹x_uÆock
(&
ùx
->
mu‹x
);

4026 (è
	`±h»ad_mu‹x_de¡roy
(&
ùx
->
mu‹x
);

4027 (è
	`±h»ad_cÚd_de¡roy
(&
ùx
->
cÚd
);

4028 (è
	`±h»ad_cÚd_de¡roy
(&
ùx
->
sq_em±y
);

4029 (è
	`±h»ad_cÚd_de¡roy
(&
ùx
->
sq_fuÎ
);

4032 
ùx
->
¡İ_æag
 = 2;

4034 
	`DEBUG_TRACE
(("exiting"));

4035 
	}
}

4037 
	$ä“_cÚ‹xt
(
mg_cÚ‹xt
 *
ùx
) {

4038 
i
;

4041 
i
 = 0; i < 
NUM_OPTIONS
; i++) {

4042 ià(
ùx
->
cÚfig
[
i
] !ğ
NULL
)

4043 
	`ä“
(
ùx
->
cÚfig
[
i
]);

4047 ià(
ùx
->
s¦_ùx
 !ğ
NULL
) {

4048 
	`SSL_CTX_ä“
(
ùx
->
s¦_ùx
);

4050 #iâdeà
NO_SSL


4051 ià(
s¦_mu‹xes
 !ğ
NULL
) {

4052 
	`ä“
(
s¦_mu‹xes
);

4057 
	`ä“
(
ùx
);

4058 
	}
}

4060 
	$mg_¡İ
(
mg_cÚ‹xt
 *
ùx
) {

4061 
ùx
->
¡İ_æag
 = 1;

4064 
ùx
->
¡İ_æag
 != 2) {

4065 (è
	`¦“p
(0);

4067 
	`ä“_cÚ‹xt
(
ùx
);

4069 #ià
	`defšed
(
_WIN32
)

4070 (è
	`WSACËªup
();

4072 
	}
}

4074 
mg_cÚ‹xt
 *
	$mg_¡¬t
(
mg_ÿÎback_t
 
u£r_ÿÎback
, *
u£r_d©a
,

4075 cÚ¡ **
İtiÚs
) {

4076 
mg_cÚ‹xt
 *
ùx
;

4077 cÚ¡ *
Çme
, *
v®ue
, *
deçuÉ_v®ue
;

4078 
i
;

4080 #ià
	`defšed
(
_WIN32
)

4081 
WSADATA
 
d©a
;

4082 
	`WSAS¹up
(
	`MAKEWORD
(2,2), &
d©a
);

4087 
ùx
 = (
mg_cÚ‹xt
*è
	`ÿÎoc
(1, (*ctx));

4088 
ùx
->
u£r_ÿÎback
 = user_callback;

4089 
ùx
->
u£r_d©a
 = user_data;

4091 
İtiÚs
 && (
Çme
 = *İtiÚs++è!ğ
NULL
) {

4092 ià((
i
 = 
	`g‘_İtiÚ_šdex
(
Çme
)) == -1) {

4093 
	`üy
(
	`fc
(
ùx
), "Inv®id o±iÚ: %s", 
Çme
);

4094 
	`ä“_cÚ‹xt
(
ùx
);

4095  
NULL
;

4096 } ià((
v®ue
 = *
İtiÚs
++è=ğ
NULL
) {

4097 
	`üy
(
	`fc
(
ùx
), "%s: o±iÚ v®uÿÂÙ bNULL", 
Çme
);

4098 
	`ä“_cÚ‹xt
(
ùx
);

4099  
NULL
;

4101 
ùx
->
cÚfig
[
i
] = 
	`mg_¡rdup
(
v®ue
);

4102 
	`DEBUG_TRACE
(("[%s] -> [%s]", 
Çme
, 
v®ue
));

4106 
i
 = 0; 
cÚfig_İtiÚs
[˜* 
ENTRIES_PER_CONFIG_OPTION
] !ğ
NULL
; i++) {

4107 
deçuÉ_v®ue
 = 
cÚfig_İtiÚs
[
i
 * 
ENTRIES_PER_CONFIG_OPTION
 + 2];

4108 ià(
ùx
->
cÚfig
[
i
] =ğ
NULL
 && 
deçuÉ_v®ue
 != NULL) {

4109 
ùx
->
cÚfig
[
i
] = 
	`mg_¡rdup
(
deçuÉ_v®ue
);

4110 
	`DEBUG_TRACE
(("Setting default: [%s] -> [%s]",

4111 
cÚfig_İtiÚs
[
i
 * 
ENTRIES_PER_CONFIG_OPTION
 + 1],

4112 
deçuÉ_v®ue
));

4118 ià(!
	`£t_g·ss_İtiÚ
(
ùx
) ||

4119 #ià!
	`defšed
(
NO_SSL
)

4120 !
	`£t_s¦_İtiÚ
(
ùx
) ||

4122 !
	`£t_pÜts_İtiÚ
(
ùx
) ||

4123 #ià!
	`defšed
(
_WIN32
)

4124 !
	`£t_uid_İtiÚ
(
ùx
) ||

4126 !
	`£t_aş_İtiÚ
(
ùx
)) {

4127 
	`ä“_cÚ‹xt
(
ùx
);

4128  
NULL
;

4131 #ià!
	`defšed
(
_WIN32
)

4134 (è
	`sigÇl
(
SIGPIPE
, 
SIG_IGN
);

4137 (è
	`±h»ad_mu‹x_š™
(&
ùx
->
mu‹x
, 
NULL
);

4138 (è
	`±h»ad_cÚd_š™
(&
ùx
->
cÚd
, 
NULL
);

4139 (è
	`±h»ad_cÚd_š™
(&
ùx
->
sq_em±y
, 
NULL
);

4140 (è
	`±h»ad_cÚd_š™
(&
ùx
->
sq_fuÎ
, 
NULL
);

4143 
	`¡¬t_th»ad
(
ùx
, (
mg_th»ad_func_t
è
ma¡”_th»ad
, ctx);

4146 
i
 = 0; i < 
	`©oi
(
ùx
->
cÚfig
[
NUM_THREADS
]); i++) {

4147 ià(
	`¡¬t_th»ad
(
ùx
, (
mg_th»ad_func_t
è
wÜk”_th»ad
, ctx) != 0) {

4148 
	`üy
(
	`fc
(
ùx
), "CªnÙ s¹ wÜk”h»ad: %d", 
ERRNO
);

4150 
ùx
->
num_th»ads
++;

4154  
ùx
;

4155 
	}
}

4157 *
	$mg_»ad_u£r_d©a
(
mg_cÚÃùiÚ
 *
cÚn
)

4159  
cÚn
->
ùx
->
u£r_d©a
;

4161 
	}
}

	@external/vpiotr-mongoose-cpp/mongoose.h

21 #iâdeà
MONGOOSE_HEADER_INCLUDED


22 
	#MONGOOSE_HEADER_INCLUDED


	)

24 #ifdeà
__ılu¥lus


28 
mg_cÚ‹xt
;

29 
mg_cÚÃùiÚ
;

32 
	smg_auth_h—d”
 {

33 cÚ¡ *
u£r
, *
uri
, *
úÚû
, *
»¥Ú£
, *
qİ
, *
nc
, *
nÚû
;

36 *
ha1
;

37 *
ex³ùed_»¥Ú£
;

41 
	smg_»que¡_šfo
 {

42 *
u£r_d©a
;

43 *
»que¡_m‘hod
;

44 *
uri
;

45 *
h‰p_v”siÚ
;

46 *
qu”y_¡ršg
;

47 *
»mÙe_u£r
;

48 *
log_mes§ge
;

49 
»mÙe_
;

50 
»mÙe_pÜt
;

51 
¡©us_code
;

52 
is_s¦
;

53 
num_h—d”s
;

54 
	smg_h—d”
 {

55 *
Çme
;

56 *
v®ue
;

57 } 
h‰p_h—d”s
[64];

58 
mg_auth_h—d”
 *
ah
;

62 
	emg_ev’t
 {

63 
MG_NEW_REQUEST
,

64 
MG_HTTP_ERROR
,

65 
MG_EVENT_LOG
,

66 
MG_INIT_SSL
,

68 
MG_AUTHENTICATE
,

88 * (*
	tmg_ÿÎback_t
)(
	tmg_ev’t
 
	tev’t
,

89 
	tmg_cÚÃùiÚ
 *
	tcÚn
,

90 cÚ¡ 
	tmg_»que¡_šfo
 *
	t»que¡_šfo
);

113 
mg_cÚ‹xt
 *
mg_¡¬t
(
mg_ÿÎback_t
 
ÿÎback
, *
u£r_d©a
,

114 cÚ¡ **
İtiÚs
);

122 
mg_¡İ
(
mg_cÚ‹xt
 *);

131 cÚ¡ *
mg_g‘_İtiÚ
(cÚ¡ 
mg_cÚ‹xt
 *
ùx
, cÚ¡ *
Çme
);

137 cÚ¡ **
mg_g‘_v®id_İtiÚ_Çmes
();

152 
mg_modify_·sswÜds_fe
(
mg_cÚ‹xt
 *
ùx
,

153 cÚ¡ *
·sswÜds_fe_Çme
, cÚ¡ *
u£r
, cÚ¡ *
·sswÜd
);

156 
mg_wr™e
(
mg_cÚÃùiÚ
 *, cÚ¡ *
buf
, 
size_t
 
Ën
);

165 
mg_´štf
(
mg_cÚÃùiÚ
 *, cÚ¡ *
fmt
, ...);

169 
mg_»ad
(
mg_cÚÃùiÚ
 *, *
buf
, 
size_t
 
Ën
);

177 
mg_£nd_authÜiz©iÚ_»que¡
(
mg_cÚÃùiÚ
 *
cÚn
, cÚ¡ *
nÚû
);

184 cÚ¡ *
mg_g‘_h—d”
(cÚ¡ 
mg_cÚÃùiÚ
 *, cÚ¡ *
Çme
);

203 
mg_g‘_v¬
(cÚ¡ *
d©a
, 
size_t
 
d©a_Ën
,

204 cÚ¡ *
v¬_Çme
, *
buf
, 
size_t
 
buf_Ën
);

217 
mg_g‘_cook›
(cÚ¡ 
mg_cÚÃùiÚ
 *,

218 cÚ¡ *
cook›_Çme
, *
buf
, 
size_t
 
buf_Ën
);

222 cÚ¡ *
mg_v”siÚ
();

231 
mg_md5
(*
buf
, ...);

235 *
mg_»ad_u£r_d©a
(
mg_cÚÃùiÚ
 *
cÚn
);

237 #ifdeà
__ılu¥lus


	@external/vpiotr-mongoose-cpp/test/embed.c

24 
	~<¡dlib.h
>

25 
	~<¡dio.h
>

26 
	~<¡ršg.h
>

27 #iâdeà
_WIN32


28 
	~<uni¡d.h
>

31 
	~"mÚgoo£.h
"

33 #ià!
defšed
(
LISTENING_PORT
)

34 
	#LISTENING_PORT
 "23456"

	)

37 cÚ¡ *
	g¡ªd¬d_»¶y
 = "HTTP/1.1 200 OK\r\n"

41 
	$‹¡_g‘_v¬
(
mg_cÚÃùiÚ
 *
cÚn
,

42 cÚ¡ 
mg_»que¡_šfo
 *
ri
) {

43 *
v¬
, *
buf
;

44 
size_t
 
buf_Ën
;

45 cÚ¡ *
ş
;

46 
v¬_Ën
;

48 
	`mg_´štf
(
cÚn
, "%s", 
¡ªd¬d_»¶y
);

50 
buf_Ën
 = 0;

51 
v¬
 = 
buf
 = 
NULL
;

52 
ş
 = 
	`mg_g‘_h—d”
(
cÚn
, "Content-Length");

53 
	`mg_´štf
(
cÚn
, "ş: %p\n", 
ş
);

54 ià((!
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "POST") ||

55 !
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "PUT"))

56 && 
ş
 !ğ
NULL
) {

57 
buf_Ën
 = 
	`©oi
(
ş
);

58 
buf
 = 
	`m®loc
(
buf_Ën
);

60 ià(
buf_Ën
 > 2) {

61 
	`mg_»ad
(
cÚn
, 
buf
, 2);

62 
	`mg_»ad
(
cÚn
, 
buf
 + 2, 
buf_Ën
 - 2);

64 
	`mg_»ad
(
cÚn
, 
buf
, 
buf_Ën
);

66 } ià(
ri
->
qu”y_¡ršg
 !ğ
NULL
) {

67 
buf_Ën
 = 
	`¡¾’
(
ri
->
qu”y_¡ršg
);

68 
buf
 = 
	`m®loc
(
buf_Ën
 + 1);

69 
	`¡rıy
(
buf
, 
ri
->
qu”y_¡ršg
);

71 
v¬
 = 
	`m®loc
(
buf_Ën
 + 1);

72 
v¬_Ën
 = 
	`mg_g‘_v¬
(
buf
, 
buf_Ën
, "my_v¬", 
v¬
, buf_len + 1);

73 
	`mg_´štf
(
cÚn
, "V®ue: [%s]\n", 
v¬
);

74 
	`mg_´štf
(
cÚn
, "V®usize: [%d]\n", 
v¬_Ën
);

75 
	`ä“
(
buf
);

76 
	`ä“
(
v¬
);

77 
	}
}

79 
	$‹¡_g‘_h—d”
(
mg_cÚÃùiÚ
 *
cÚn
,

80 cÚ¡ 
mg_»que¡_šfo
 *
ri
) {

81 cÚ¡ *
v®ue
;

82 
i
;

84 
	`mg_´štf
(
cÚn
, "%s", 
¡ªd¬d_»¶y
);

85 
	`´štf
("HTTP h—d”s: %d\n", 
ri
->
num_h—d”s
);

86 
i
 = 0; i < 
ri
->
num_h—d”s
; i++) {

87 
	`´štf
("[%s]: [%s]\n", 
ri
->
h‰p_h—d”s
[
i
].
Çme
,„i->h‰p_h—d”s[i].
v®ue
);

90 
v®ue
 = 
	`mg_g‘_h—d”
(
cÚn
, "Host");

91 ià(
v®ue
 !ğ
NULL
) {

92 
	`mg_´štf
(
cÚn
, "V®ue: [%s]", 
v®ue
);

94 
	}
}

96 
	$‹¡_g‘_»que¡_šfo
(
mg_cÚÃùiÚ
 *
cÚn
,

97 cÚ¡ 
mg_»que¡_šfo
 *
ri
) {

98 
i
;

100 
	`mg_´štf
(
cÚn
, "%s", 
¡ªd¬d_»¶y
);

102 
	`mg_´štf
(
cÚn
, "M‘hod: [%s]\n", 
ri
->
»que¡_m‘hod
);

103 
	`mg_´štf
(
cÚn
, "URI: [%s]\n", 
ri
->
uri
);

104 
	`mg_´štf
(
cÚn
, "HTTP v”siÚ: [%s]\n", 
ri
->
h‰p_v”siÚ
);

106 
i
 = 0; i < 
ri
->
num_h—d”s
; i++) {

107 
	`mg_´štf
(
cÚn
, "HTTP header [%s]: [%s]\n",

108 
ri
->
h‰p_h—d”s
[
i
].
Çme
,

109 
ri
->
h‰p_h—d”s
[
i
].
v®ue
);

112 
	`mg_´štf
(
cÚn
, "Query string: [%s]\n",

113 
ri
->
qu”y_¡ršg
 ?„i->query_string: "");

114 
	`mg_´štf
(
cÚn
, "RemÙIP: [%lu]\n", 
ri
->
»mÙe_
);

115 
	`mg_´štf
(
cÚn
, "RemÙpÜt: [%d]\n", 
ri
->
»mÙe_pÜt
);

116 
	`mg_´štf
(
cÚn
, "Remote user: [%s]\n",

117 
ri
->
»mÙe_u£r
 ?„i->remote_user : "");

118 
	}
}

120 
	$‹¡_”rÜ
(
mg_cÚÃùiÚ
 *
cÚn
,

121 cÚ¡ 
mg_»que¡_šfo
 *
ri
) {

122 
	`mg_´štf
(
cÚn
, "HTTP/1.1 %d XX\r\n"

123 "CÚÁeùiÚ: clo£\r\n\r\n", 
ri
->
¡©us_code
);

124 
	`mg_´štf
(
cÚn
, "E¼Ü: [%d]", 
ri
->
¡©us_code
);

125 
	}
}

127 
	$‹¡_po¡
(
mg_cÚÃùiÚ
 *
cÚn
,

128 cÚ¡ 
mg_»que¡_šfo
 *
ri
) {

129 cÚ¡ *
ş
;

130 *
buf
;

131 
Ën
;

133 
	`mg_´štf
(
cÚn
, "%s", 
¡ªd¬d_»¶y
);

134 ià(
	`¡rcmp
(
ri
->
»que¡_m‘hod
, "POST") == 0 &&

135 (
ş
 = 
	`mg_g‘_h—d”
(
cÚn
, "CÚ‹Á-L’gth")è!ğ
NULL
) {

136 
Ën
 = 
	`©oi
(
ş
);

137 ià((
buf
 = 
	`m®loc
(
Ën
)è!ğ
NULL
) {

138 
	`mg_wr™e
(
cÚn
, 
buf
, 
Ën
);

139 
	`ä“
(
buf
);

142 
	}
}

144 cÚ¡ 
	s‹¡_cÚfig
 {

145 
mg_ev’t
 
	mev’t
;

146 cÚ¡ *
	muri
;

147 (*
	mfunc
)(
	mmg_cÚÃùiÚ
 *, cÚ¡ 
	mmg_»que¡_šfo
 *);

148 } 
	g‹¡_cÚfig
[] = {

149 {
MG_NEW_REQUEST
, "/‹¡_g‘_h—d”", &
‹¡_g‘_h—d”
},

150 {
MG_NEW_REQUEST
, "/‹¡_g‘_v¬", &
‹¡_g‘_v¬
},

151 {
MG_NEW_REQUEST
, "/‹¡_g‘_»que¡_šfo", &
‹¡_g‘_»que¡_šfo
},

152 {
MG_NEW_REQUEST
, "/‹¡_po¡", &
‹¡_po¡
},

153 {
MG_HTTP_ERROR
, "", &
‹¡_”rÜ
},

154 {0, 
NULL
, NULL}

157 *
	$ÿÎback
(
mg_ev’t
 
ev’t
,

158 
mg_cÚÃùiÚ
 *
cÚn
,

159 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

160 
i
;

162 
i
 = 0; 
‹¡_cÚfig
[i].
uri
 !ğ
NULL
; i++) {

163 ià(
ev’t
 =ğ
‹¡_cÚfig
[
i
].event &&

164 (
ev’t
 =ğ
MG_HTTP_ERROR
 ||

165 !
	`¡rcmp
(
»que¡_šfo
->
uri
, 
‹¡_cÚfig
[
i
].uri))) {

166 
‹¡_cÚfig
[
i
].
	`func
(
cÚn
, 
»que¡_šfo
);

171  
NULL
;

172 
	}
}

174 
	$maš
() {

175 
mg_cÚ‹xt
 *
ùx
;

176 cÚ¡ *
İtiÚs
[] = {"li¡’šg_pÜts", 
LISTENING_PORT
, 
NULL
};

178 
ùx
 = 
	`mg_¡¬t
(
ÿÎback
, 
NULL
, 
İtiÚs
);

179 
	`·u£
();

181 
	}
}

	@external/vpiotr-mongoose-cpp/test/mongotest.cpp

12 
	~<io¡»am
>

13 
	~<time.h
>

14 
	~<s¡»am
>

16 
	~"mÚgıp.h
"

19 
usšg
 
Çme¥aû
 
	gmÚgoo£
;

20 
usšg
 
Çme¥aû
 
	g¡d
;

22 
	g‹m¶©e
 <
şass
 
	gT
>

23 
šlše
 
	g¡d
::
¡ršg
 
	$toSŒšg
 (cÚ¡ 
T
& 
t
)

25 
¡d
::
¡ršg¡»am
 
ss
;

26 
ss
 << 
t
;

27  
ss
.
	`¡r
();

28 
	}
}

30 
¡ršg
 
	$ToSŒšg
(

)

32 
¡ršg
 
»s
;

33 
wÜkIp
, 
a
, 
b
, 
c
, 
d
;

34 
wÜkIp
 = 

;

35 
d
 = 
wÜkIp
 % 0x100;

36 
wÜkIp
 = workIp >> 8;

37 
c
 = 
wÜkIp
 % 0x100;

38 
wÜkIp
 = workIp >> 8;

39 
b
 = 
wÜkIp
 % 0x100;

40 
wÜkIp
 = workIp >> 8;

41 
a
 = 
wÜkIp
;

42 
»s
 = 
	`toSŒšg
(
a
)+"."+toSŒšg(
b
)+"."+toSŒšg(
c
)+"."+toSŒšg(
d
);

43  
»s
;

44 
	}
}

46 şas 
	cTe¡MÚgoS”v”
: 
public
 
MÚgoo£S”v”
 {

47 
public
:

48 
	$Te¡MÚgoS”v”
(): 
	$MÚgoo£S”v”
() {}

49 
vœtu®
 ~
	$Te¡MÚgoS”v”
(è{
	}
}

50 
´Ùeùed
:

51 
vœtu®
 
boŞ
 
	$hªdËEv’t
(
S”v”HªdlšgEv’t
 
ev’tCode
, 
MÚgoo£CÚÃùiÚ
 &
cÚÃùiÚ
, cÚ¡ 
MÚgoo£Reque¡
 &
»que¡
, 
MÚgoo£Re¥Ú£
 &
»¥Ú£
) {

52 
boŞ
 
»s
 = 
çl£
;

54 ià(
ev’tCode
 =ğ
MG_NEW_REQUEST
) {

55 ià(
»que¡
.
	`g‘Uri
(è=ğ
	`¡ršg
("/info")) {

56 
	`hªdËInfo
(
»que¡
, 
»¥Ú£
);

57 
»s
 = 
Œue
;

61  
»s
;

62 
	}
}

64 
	$hªdËInfo
(cÚ¡ 
MÚgoo£Reque¡
 &
»que¡
, 
MÚgoo£Re¥Ú£
 &
»¥Ú£
) {

65 
»¥Ú£
.
	`£tStus
(200);

66 
»¥Ú£
.
	`£tCÚÃùiÚAlive
(
çl£
);

67 
»¥Ú£
.
	`£tCacheDi§bËd
();

68 
»¥Ú£
.
	`£tCÚ‹ÁTy³
("text/html");

69 
»¥Ú£
.
	`addCÚ‹Á
(
	`g’”©eInfoCÚ‹Á
(
»que¡
));

70 
»¥Ú£
.
	`wr™e
();

71 
	}
}

73 cÚ¡ 
¡ršg
 
	$g’”©eInfoCÚ‹Á
(cÚ¡ 
MÚgoo£Reque¡
 &
»que¡
) {

74 
¡ršg
 
»suÉ
;

75 
»suÉ
 = "<h1>Sample Info Page</h1>";

76 
»suÉ
 +ğ"<b¸/>Reque¡ URI: " + 
»que¡
.
	`g‘Uri
();

77 
»suÉ
 +ğ"<b¸/>You¸IP: " + 
	`ToSŒšg
(
»que¡
.
	`g‘RemÙeIp
());

79 
time_t
 
tim
;

80 
	`time
(&
tim
);

82 
»suÉ
 +ğ"<b¸/>Cu¼’ˆd©&ime: " + 
	`toSŒšg
(
	`ùime
(&
tim
));

83 
»suÉ
 += "<br /><br /><a href=\"/\">Index…age</a>";

85  
»suÉ
;

86 
	}
}

89 
	$maš
()

91 
Te¡MÚgoS”v”
 
£rv”
;

93 
£rv”
.
	`£tO±iÚ
("document_root", "html");

94 
£rv”
.
	`£tO±iÚ
("listening_ports", "8080");

95 
£rv”
.
	`£tO±iÚ
("num_threads", "5");

97 
£rv”
.
	`¡¬t
();

99 
cout
 << "Te¡ s”v” s¹ed,…»s ’‹¸tØqu™..." << 
’dl
;

100 
cš
.
	`ignÜe
();

102 
£rv”
.
	`¡İ
();

103 
cout
 << "Te¡ s”v” stİ³d" << 
’dl
;

104 
	}
}

	@graphchi_basic_includes.hpp

32 #iâdeà
GRAPHCHI_DEF_ALLBASIC_INCLUDES


33 
	#GRAPHCHI_DEF_ALLBASIC_INCLUDES


	)

35 
	~<omp.h
>

36 
	~<s¡»am
>

38 
	~"­i/chif’ames.hµ
"

39 
	~"­i/g¿phchi_cÚ‹xt.hµ
"

40 
	~"­i/g¿phchi_´og¿m.hµ
"

41 
	~"­i/g¿ph_objeùs.hµ
"

42 
	~"­i/ischeduËr.hµ
"

43 
	~"­i/v”‹x_agg»g©Ü.hµ
"

45 
	~"’gše/g¿phchi_’gše.hµ
"

47 
	~"logg”/logg”.hµ
"

49 
	~"m‘rics/m‘rics.hµ
"

50 
	~"m‘rics/»ps/basic_»pÜ‹r.hµ
"

51 
	~"m‘rics/»ps/fe_»pÜ‹r.hµ
"

52 
	~"m‘rics/»ps/html_»pÜ‹r.hµ
"

54 
	~"´•roûssšg/cÚv”siÚs.hµ
"

56 
	~"ut/cmdİts.hµ
"

59 
Çme¥aû
 
	gg¿phchi
 {

64 
VARIABLE_IS_NOT_USED
 
m‘rics_»pÜt
(
m‘rics
 &
m
);

65 
VARIABLE_IS_NOT_USED
 
m‘rics_»pÜt
(
m‘rics
 &
m
) {

66 
	g¡d
::
¡ršg
 
»pÜ‹rs
 = 
g‘_İtiÚ_¡ršg
("metrics.reporter", "console");

67 * 
	gü•s
 = (*)
»pÜ‹rs
.
c_¡r
();

68 cÚ¡ * 
	gd–ims
 = ",";

69 * 
	gt
 = 
¡¹ok
(
ü•s
, 
d–ims
);

71 
	gt
 !ğ
NULL
) {

72 
¡d
::
¡ršg
 
»²ame
(
t
);

73 ià(
	g»²ame
 =ğ"basic" || 
»²ame
 == "console") {

74 
basic_»pÜ‹r
 
»p
;

75 
	gm
.
»pÜt
(
»p
);

76 } ià(
	g»²ame
 == "file") {

77 
fe_»pÜ‹r
 
»p
(
g‘_İtiÚ_¡ršg
("metrics.reporter.filename", "metrics.txt"));

78 
	gm
.
»pÜt
(
»p
);

79 } ià(
	g»²ame
 == "html") {

80 
html_»pÜ‹r
 
»p
(
g‘_İtiÚ_¡ršg
("metrics.reporter.htmlfile", "metrics.html"));

81 
	gm
.
»pÜt
(
»p
);

83 
log¡»am
(
LOG_WARNING
è<< "Could‚Ù fšd m‘ric »pÜ‹¸w™h‚am[" << 
	g»²ame
 << "], ignÜšg." << 
	g¡d
::
’dl
;

85 
	gt
 = 
¡¹ok
(
NULL
, 
d–ims
);

	@graphchi_types.hpp

18 #iâdeà
DEF_GRAPHCHI_TYPES


19 
	#DEF_GRAPHCHI_TYPES


	)

22 
	~<¡dšt.h
>

24 
Çme¥aû
 
	gg¿phchi
 {

26 
ušt32_t
 
	tvid_t
;

33 
	g‹m¶©e
 <
ty³Çme
 
	gET
>

34 
	sPaœCÚš”
 {

35 
ET
 
	gËá
;

36 
ET
 
	gright
;

38 
PaœCÚš”
() {

39 
	gËá
 = 
ET
();

40 
	gright
 = 
ET
();

43 
PaœCÚš”
(
ET
 
a
, ET 
b
) {

44 
	gËá
 = 
a
;

45 
	gright
 = 
b
;

48 
	gET
 & 
Şdv®
(
™”
) {

49  (
	g™”
 % 2 =ğ0 ? 
Ëá
 : 
right
);

52 
£t_Ãwv®
(
™”
, 
ET
 
x
) {

53 ià(
	g™”
 % 2 == 0) {

54 
right
 = 
x
;

56 
	gËá
 = 
x
;

61 
	ssh¬d_šdex
 {

62 
vid_t
 
	gv”‹xid
;

63 
size_t
 
	gf•os
;

64 
size_t
 
	gedgecouÁ”
;

65 
sh¬d_šdex
(
vid_t
 
v”‹xid
, 
size_t
 
f•os
, size_ˆ
edgecouÁ”
) : vertexid(vertexid), filepos(filepos),ƒdgecounter(edgecounter) {}

	@httpadmin/chi_httpadmin.hpp

10 #iâdeà
CHI_HTTPADMIN_DEF


11 
	#CHI_HTTPADMIN_DEF


	)

13 
	~<as£¹.h
>

14 
	~<¡ršg.h
>

15 
	~<time.h
>

16 
	~<¡d¬g.h
>

17 
	~<¡ršg
>

19 
	~"ex‹º®/vpiÙr-mÚgoo£-ıp/mÚgoo£.h
"

22 
	~"ex‹º®/vpiÙr-mÚgoo£-ıp/mÚgoo£.c
"

24 
Çme¥aû
 
g¿phchi
 {

26 şas 
	ccu¡om_»que¡_hªdËr
 {

28 
public
:

29 
vœtu®
 
¡d
::
¡ršg
 
hªdË
(cÚ¡ * 
»q
) = 0;

30 
vœtu®
 
boŞ
 
»¥Úds_to
(cÚ¡ * 
»q
) = 0;

33 
¡d
::
veùÜ
<
cu¡om_»que¡_hªdËr
 *> 
»qhªdËrs
;

35 
	$»gi¡”_h‰p_»que¡_hªdËr
(
cu¡om_»que¡_hªdËr
 * 
rh
) {

36 
»qhªdËrs
.
	`push_back
(
rh
);

37 
	}
}

40 cÚ¡ *
ajax_»¶y_¡¬t
 =

46 cÚ¡ *
İtiÚs
[] = {

50 
NULL


53 
	$g‘_qsv¬
(cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
,

54 cÚ¡ *
Çme
, *
d¡
, 
size_t
 
d¡_Ën
) {

55 cÚ¡ *
qs
 = 
»que¡_šfo
->
qu”y_¡ršg
;

56 
	`mg_g‘_v¬
(
qs
, 
	`¡¾’
(q =ğ
NULL
 ? "" : qs), 
Çme
, 
d¡
, 
d¡_Ën
);

57 
	}
}

62 
	$hªdË_jsÚp
(
mg_cÚÃùiÚ
 *
cÚn
,

63 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

64 
cb
[64];

66 
	`g‘_qsv¬
(
»que¡_šfo
, "ÿÎback", 
cb
, (cb));

67 ià(
cb
[0] != '\0') {

68 
	`mg_´štf
(
cÚn
, "%s(", 
cb
);

71  
cb
[0] == '\0' ? 0 : 1;

72 
	}
}

74 
£nd
(
¡d
::
¡ršg
 
jsÚ_šfo
, 
mg_cÚÃùiÚ
 * 
cÚn
,

75 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

76 
mg_´štf
(
cÚn
, "%s", 
ajax_»¶y_¡¬t
);

77 cÚ¡ * 
c¡r
 = 
jsÚ_šfo
.
c_¡r
();

78 
Ën
 = ()
¡¾’
(
c¡r
);

79 
is_jsÚp
 = 
hªdË_jsÚp
(
cÚn
, 
»que¡_šfo
);

83 
num_wr™‹n
 = 0;

85 
Ën
 > 0) {

86 ià((
num_wr™‹n
 = 
mg_wr™e
(
cÚn
, 
c¡r
, (
size_t
)
Ën
)) !=†en)

88 
Ën
 -ğ
num_wr™‹n
;

89 
c¡r
 +ğ
num_wr™‹n
;

92 ià(
is_jsÚp
) {

93 
mg_´štf
(
cÚn
, "%s", ")");

98 
‹m¶©e
 <
ty³Çme
 
ENGINE
>

99 
	$ajax_£nd_mes§ge
(
mg_cÚÃùiÚ
 *
cÚn
,

100 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

101 
ENGINE
 * 
’gše
 = (ENGINE*è
»que¡_šfo
->
u£r_d©a
;

103 
¡d
::
¡ršg
 
jsÚ_šfo
 = 
’gše
->
	`g‘_šfo_jsÚ
();

104 
	`£nd
(
jsÚ_šfo
, 
cÚn
, 
»que¡_šfo
);

105 
	}
}

110 
‹m¶©e
 <
ty³Çme
 
ENGINE
>

111 *
	$ev’t_hªdËr
(
mg_ev’t
 
ev’t
,

112 
mg_cÚÃùiÚ
 *
cÚn
,

113 cÚ¡ 
mg_»que¡_šfo
 *
»que¡_šfo
) {

114 *
´oûs£d
 = (*) "yes";

116 ià(
ev’t
 =ğ
MG_NEW_REQUEST
) {

117 ià(
	`¡rcmp
(
»que¡_šfo
->
uri
, "/ajax/getinfo") == 0) {

118 
ajax_£nd_mes§ge
<
ENGINE
>(
cÚn
, 
»que¡_šfo
);

120 
boŞ
 
found
 = 
çl£
;

121 
¡d
::
veùÜ
<
cu¡om_»que¡_hªdËr
 *>::
™”©Ü
 
™
=
»qhªdËrs
.
	`begš
();

122 
™
 !ğ
»qhªdËrs
.
	`’d
(); ++it) {

123 
cu¡om_»que¡_hªdËr
 * 
rh
 = *
™
;

124 ià(
rh
->
	`»¥Úds_to
(
»que¡_šfo
->
uri
)) {

125 
¡d
::
¡ršg
 
»¥Ú£
 = 
rh
->
	`hªdË
(
»que¡_šfo
->
uri
);

126 
	`£nd
(
»¥Ú£
, 
cÚn
, 
»que¡_šfo
);

127 
found
 = 
Œue
;

132 ià(!
found
è
´oûs£d
 = 
NULL
;

135 
´oûs£d
 = 
NULL
;

138  
´oûs£d
;

139 
	}
}

142 
‹m¶©e
 <
ty³Çme
 
ENGINE
>

143 
	$¡¬t_h‰·dmš
(
ENGINE
 * 
’gše
) {

144 
mg_cÚ‹xt
 *
ùx
;

146 
ùx
 = 
	`mg_¡¬t
(&
ev’t_hªdËr
<
ENGINE
>, (*)
’gše
, 
İtiÚs
);

147 
	`as£¹
(
ùx
 !ğ
NULL
);

148 
¡d
::
cout
 << "S¹ed HTTP‡dmš s”v”. " << std::
’dl
;

149 
	}
}

	@httpadmin/plotter.hpp

31 #iâdeà
DEF_GRAPHCHI_GNUPLOTTER


32 
	#DEF_GRAPHCHI_GNUPLOTTER


	)

34 
	~<c¡dio
>

35 
	~<¡dlib.h
>

36 
	~<¡ršg
>

38 
	~"g¿phchi_basic_šşudes.hµ
"

40 
Çme¥aû
 
	gg¿phchi
 {

42 
size_t
 
	gš™Ÿl_edges
 = 0;

45 
	g¡d
::
¡ršg
 
¶ÙdœeùÜy
();

46 
	g¡d
::
¡ršg
 
¶ÙdœeùÜy
() {

49 
š™_¶Ù
(
¡d
::
¡ršg
 
¶ÙÇme
);

50 
š™_¶Ù
(
¡d
::
¡ršg
 
¶ÙÇme
) {

51 
¡d
::
¡ršg
 
d©ªame
 = 
¶ÙdœeùÜy
(è+ 
¶ÙÇme
 + ".dat";

52 
FILE
 * 
	gdf
 = 
fİ’
(
d©ªame
.
c_¡r
(), "w");

53 
fşo£
(
df
);

54 
	g¡d
::
cout
 << "---------- In™Ÿlized ------------" << 
¡d
::
’dl
;

57 
	g‹m¶©e
 <
ty³Çme
 
	gENGINE
>

58 
addv®
(
ENGINE
 * 
’gše
, 
¡d
::
¡ršg
 
¶ÙÇme
, 
v®
) {

59 
	gg¿phchi_cÚ‹xt
 &
	gcÚ‹xt
 = 
’gše
->
g‘_cÚ‹xt
();

60 
	g¡d
::
¡ršg
 
d©ªame
 = 
¶ÙdœeùÜy
(è+ 
¶ÙÇme
 + ".dat";

61 
FILE
 * 
	gdf
 = 
fİ’
(
d©ªame
.
c_¡r
(), "a");

62 
as£¹
(
df
 !ğ
NULL
);

63 
årštf
(
df
, "%là%lf\n", 
cÚ‹xt
.
ruÁime
(), 
v®
);

64 
fşo£
(
df
);

68 
d¿w¶Ù
(
¡d
::
¡ršg
 
¶ÙÇme
, 
size_t
 
lookback_£cs
);

69 
d¿w¶Ù
(
¡d
::
¡ršg
 
¶ÙÇme
, 
size_t
 
lookback_£cs
) {

70 
	g¡d
::
¡ršg
 
¶Ùfe
 = 
¶ÙdœeùÜy
(è+ 
¶ÙÇme
 + ".dat";

72 
	g¡d
::
¡ršg¡»am
 
ss
;

73 
	gss
 << "python2.6 ";

74 
	gss
 << 
¶ÙdœeùÜy
(è+ "¶Ù‹r.py " + 
	g¶Ùfe
 + "†astsecs ";

75 
	gss
 << 
	glookback_£cs
;

77 
	g¡d
::
¡ršg
 
cmd
 = 
ss
.
¡r
();

78 
log¡»am
(
LOG_DEBUG
è<< "Executšg: " << 
	gcmd
 << 
	g¡d
::
’dl
;

79 
sy¡em
(
cmd
.
c_¡r
());

82 
	g‹m¶©e
 <
ty³Çme
 
	gENGINE
>

83 
š™_¶Ùs
(
ENGINE
 * 
’gše
) {

84 
š™_¶Ù
("edges");

85 
š™_¶Ù
("bufedges");

86 
š™_¶Ù
("updates");

87 
š™_¶Ù
("ingests");

88 
š™_¶Ù
("deltas");

90 
	gš™Ÿl_edges
 = 
’gše
->
num_edges_§ã
();

93 
	gÏ¡_upd©e_time
 = 0;

94 
size_t
 
	gÏ¡_edges
 = 0;

95 
size_t
 
	gÏ¡_upd©es
 = 0;

96 
size_t
 
	gšge¡ed_edges
 = 0;

99 
£t_šge¡ed_edges
(
size_t
 
n
);

100 
£t_šge¡ed_edges
(
size_t
 
n
) {

101 
	gšge¡ed_edges
 = 
n
;

104 
	g‹m¶©e
 <
ty³Çme
 
	gENGINE
>

105 
upd©e_¶Ùd©a
(
ENGINE
 * 
’gše
) {

106 
addv®
(
’gše
, "edges", (ëngše->
num_edges_§ã
());

107 
addv®
(
’gše
, "buãdges", (ëngše->
num_bufã»d_edges
());

108 
	g¹
 = 
’gše
->
g‘_cÚ‹xt
().
ruÁime
(è- 
Ï¡_upd©e_time
;

110 ià(
	gÏ¡_upd©e_time
 > 0) {

111 
addv®
(
’gše
, "šge¡s", (
šge¡ed_edges
 - 
Ï¡_edges
è/ 
¹
);

112 
addv®
(
’gše
, "upd©es", (’gše->
num_upd©es
(è- 
Ï¡_upd©es
è/ 
¹
);

113 
addv®
(
’gše
, "d–s",ƒngše->
g‘_cÚ‹xt
().
Ï¡_d–sum
);

115 ià(
	gÏ¡_upd©e_time
 == 0) {

116 
Ï¡_edges
 = 
šge¡ed_edges
;

117 
	gÏ¡_upd©e_time
 = 
’gše
->
g‘_cÚ‹xt
().
ruÁime
();

118 
	gÏ¡_upd©es
 = 
’gše
->
num_upd©es
();

122 
d¿w¶Ùs
();

123 
d¿w¶Ùs
() {

124 
d¿w¶Ù
("edges", 1800);

125 
d¿w¶Ù
("bufedges", 1800);

126 
d¿w¶Ù
("updates", 300);

127 
d¿w¶Ù
("ingests", 500);

128 
d¿w¶Ù
("deltas", 7200);

	@io/stripedio.hpp

31 #iâdeà
DEF_STRIPEDIO_HPP


32 
	#DEF_STRIPEDIO_HPP


	)

34 
	~<io¡»am
>

36 
	~<fú.h
>

37 
	~<uni¡d.h
>

38 
	~<as£¹.h
>

39 
	~<¡dšt.h
>

40 
	~<±h»ad.h
>

41 
	~<”ºo.h
>

42 
	~<sys/mmª.h
>

45 
	~<veùÜ
>

47 
	~"logg”/logg”.hµ
"

48 
	~"m‘rics/m‘rics.hµ
"

49 
	~"ut/synchrÚized_queue.hµ
"

50 
	~"ut/iout.hµ
"

51 
	~"ut/cmdİts.hµ
"

53 
	#CACHED_SESSION_ID
 (-1)

	)

56 
Çme¥aû
 
	gg¿phchi
 {

58 
size_t
 
g‘_fesize
(
¡d
::
¡ršg
 
f’ame
);

63 
	sio_desütÜ
 {

64 
	g¡d
::
¡ršg
 
f’ame
;

65 
	g¡d
::
veùÜ
<> 
»addescs
;

66 
	g¡d
::
veùÜ
<> 
wr™edescs
;

68 
	g¡¬t_m¶ex
;

69 
boŞ
 
	gİ’
;

70 
boŞ
 
	gcom´es£d
;

73 
	smm­_šfo
 {

74 * 
	g±r
;

75 
size_t
 
	gËngth
;

76 
	gfedesc
;

80 
	eBLOCK_ACTION
 { 
	gREAD
, 
	gWRITE
 };

83 
	s»fcouÁ±r
 {

84 * 
	g±r
;

85 vŞ©
	gcouÁ
;

86 
»fcouÁ±r
(* 
±r
, 
couÁ
) :…tr(ptr), count(count) {}

90 
şass
 
	g¡redio
;

92 
	siÙask
 {

93 
BLOCK_ACTION
 
	gaùiÚ
;

94 
	gfd
;

95 
	g£ssiÚ
;

96 
»fcouÁ±r
 * 
	g±r
;

97 
size_t
 
	gËngth
;

98 
size_t
 
	goff£t
;

99 
size_t
 
	g±roff£t
;

100 
boŞ
 
	gä“_aá”
;

101 
¡redio
 * 
	giomgr
;

102 
boŞ
 
	gcom´es£d
;

103 
boŞ
 
	gşo£fd
;

104 vŞ©* 
	gdÚ•Œ
;

106 
iÙask
(è: 
aùiÚ
(
READ
), 
fd
(0), 
£ssiÚ
(0), 
±r
(
NULL
), 
Ëngth
(0), 
off£t
(0), 
±roff£t
(0), 
ä“_aá”
(
çl£
), 
iomgr
(NULL), 
com´es£d
(çl£), 
şo£fd
(çl£), 
dÚ•Œ
(NULL) {}

107 
iÙask
(
¡redio
 * 
iomgr
, 
BLOCK_ACTION
 
aù
, 
fd
, 
£ssiÚ
, 
»fcouÁ±r
 * 
±r
, 
size_t
 
Ëngth
, size_ˆ
off£t
, size_ˆ
±roff£t
, 
boŞ
 
ä“_aá”
, boŞ 
com´es£d
, boŞ 
şo£fd
=
çl£
) :

108 
aùiÚ
(
aù
), 
fd
(fd), 
£ssiÚ
(£ssiÚ), 
±r
ÕŒ),
Ëngth
Ö’gth), 
off£t
(off£t), 
±roff£t
ÕŒoff£t), 
ä“_aá”
(ä“_aá”), 
iomgr
(iomgr),
com´es£d
(com´es£d), 
şo£fd
(closefd) {

109 ià(
	gşo£fd
è
as£¹
(
ä“_aá”
);

110 
	gdÚ•Œ
 = 
NULL
;

114 
	sthršfo
 {

115 
	gsynchrÚized_queue
<
	giÙask
> * 
	g»adqueue
;

116 
	gsynchrÚized_queue
<
	giÙask
> * 
	gcomm™queue
;

117 
	gsynchrÚized_queue
<
	giÙask
> * 
	g´ioqueue
;

119 
boŞ
 
	gruÂšg
;

120 
m‘rics
 * 
	gm
;

121 vŞ©
	g³ndšg_wr™es
;

122 vŞ©
	g³ndšg_»ads
;

123 
	gm¶ex
;

127 * 
io_th»ad_loİ
(* 
_šfo
);

129 
	s¡re_chunk
 {

130 
	gm¶ex_th»ad
;

131 
size_t
 
	goff£t
;

132 
size_t
 
	gËn
;

133 
¡re_chunk
(
m¶ex_th»ad
, 
size_t
 
off£t
, size_ˆ
Ën
) : mplex_thread(mplex_thread), offset(offset),†en(len) {}

136 
	sÿched_block
 {

137 
size_t
 
	gËn
;

138 * 
	gd©a
;

139 
boŞ
 
	gwas_com´es£d
;

141 
ÿched_block
(
size_t
 
Ën
, * 
d©a
, 
boŞ
 
was_com´es£d
) :†en(len), data(data), was_compressed(was_compressed) {}

143 ~
ÿched_block
() {

144 
ä“
(
d©a
);

145 
	gd©a
 = 
NULL
;

153 şas 
	cblock_ÿche
 {

154 
size_t
 
	gÿche_budg‘_by‹s
;

155 
size_t
 
	gÿche_size
;

156 
mu‹x
 
	glock
;

157 
boŞ
 
	gfuÎ
;

158 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gÿched_block
 *> 
	gÿchem­
;

160 
size_t
 
	gh™s
, 
	gmis£s
;

162 
	gpublic
:

164 
block_ÿche
(
size_t
 
ÿche_budg‘_by‹s
è: cache_budg‘_by‹s(ÿche_budg‘_by‹s), 
ÿche_size
(0), 
fuÎ
(
çl£
) {

165 
	gh™s
 = 
mis£s
 = 0;

168 ~
block_ÿche
() {

169 ià(
	gh™s
 + 
	gmis£s
 > 0) {

170 
log¡»am
(
LOG_INFO
è<< "Cach¡©s: h™s=" << 
	gh™s
 << " mis£s=" << 
	gmis£s
 << 
	g¡d
::
’dl
;

171 
log¡»am
(
LOG_INFO
è<< " -- iÀtÙ® had " << (
	gÿche_size
 / 1024 / 1024è<< " MB iÀÿche." << 
	g¡d
::
’dl
;

173 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gÿched_block
 *>::
™”©Ü
 
™
 = 
ÿchem­
.
begš
();

174 ; 
	g™
 !ğ
ÿchem­
.
’d
(); ++it) {

175 
d–‘e
 
	g™
->
	g£cÚd
;

181 
boŞ
 
cÚsid”_ÿchšg
(
¡d
::
¡ršg
 
f’ame
, * 
d©a
, 
size_t
 
Ën
, boŞ 
was_com´ess£d
) {

182 
boŞ
 
	gdid_ÿche
 = 
çl£
;

183 ià(!
	gfuÎ
 && 
	gËn
 + 
	gÿche_size
 <ğ
ÿche_budg‘_by‹s
) {

184 
lock
.lock();

185 ià(
	gËn
 + 
	gÿche_size
 <ğ
ÿche_budg‘_by‹s
) {

186 
ÿche_size
 +ğ
Ën
;

187 
	gdid_ÿche
 = 
Œue
;

188 ià(
	gÿchem­
.
size
() % 40 == 0) {

189 
log¡»am
(
LOG_DEBUG
è<< "Cachsize: " << 
ÿche_size
 << " / " << 
ÿche_budg‘_by‹s
 << 
¡d
::
’dl
;

191 
	gÿchem­
.
š£¹
(
¡d
::
·œ
<¡d::
¡ršg
, 
ÿched_block
*>(
f’ame
, 
Ãw
 cached_block(
Ën
, 
d©a
, 
was_com´ess£d
)));

193 ià(
	gÿche_size
 > 
	gÿche_budg‘_by‹s
) {

194 
	gfuÎ
 = 
Œue
;

196 
	glock
.
uÆock
();

198  
	gdid_ÿche
;

201 * 
g‘_ÿched
(
¡d
::
¡ršg
 
f’ame
) {

202 
boŞ
 
acquœed_mu‹x
 = 
çl£
;

203 ià(!
	gfuÎ
) {

204 
	gacquœed_mu‹x
 = 
Œue
;

205 
	glock
.
lock
();

208 * 
	g»t
 = 
NULL
;

209 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gÿched_block
 *>::
™”©Ü
 
lookup
 = 
ÿchem­
.
fšd
(
f’ame
);

210 ià(
	glookup
 !ğ
ÿchem­
.
’d
()) {

211 
»t
 = 
lookup
->
£cÚd
->
d©a
;

212 
	gh™s
++;

214 
	gmis£s
++;

217 ià(
	gacquœed_mu‹x
) {

218 
	glock
.
uÆock
();

220  
	g»t
;

222 
ä›nd
 
şass
 
	g¡redio
;

226 şas 
	c¡redio
 {

228 
	g¡d
::
veùÜ
<
io_desütÜ
 *> 
£ssiÚs
;

229 
mu‹x
 
	gmlock
;

230 
	g¡resize
;

231 
	gmuÉËx
;

232 
	g¡d
::
¡ršg
 
muÉËx_roÙ
;

234 
	gsynchrÚized_queue
<
	giÙask
> * 
	gm¶ex_»adsks
;

235 
	gsynchrÚized_queue
<
	giÙask
> * 
	gm¶ex_wr™‘asks
;

236 
	gsynchrÚized_queue
<
	giÙask
> * 
	gm¶ex_´iÙasks
;

238 
	g¡d
::
veùÜ
< 
±h»ad_t
 > 
th»ads
;

239 
	g¡d
::
veùÜ
< 
thršfo
 * > 
th»ad_šfos
;

240 
	gm‘rics
 &
	gm
;

242 
	gniÙh»ads
;

244 
block_ÿche
 
	gÿche
;

247 
	g´iv©e
:

249 
mu‹x
 
mm­lock
;

250 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gmm­_šfo
> 
	gmm­ed
;

252 
	gpublic
:

253 
¡redio
Ğ
m‘rics
 &
_m
è: 
m
(_m), 
ÿche
(0) {

254 
	g¡resize
 = 
g‘_İtiÚ_št
("io.stripesize", 1024 * 1024 / 2);

256 
	gmuÉËx
 = 
g‘_İtiÚ_št
("multiplex", 1);

257 ià(
	gmuÉËx
>1) {

258 
	gmuÉËx_roÙ
 = 
g‘_İtiÚ_¡ršg
("multiplex_root", "<not-set>");

259 
log¡»am
(
LOG_FATAL
è<< "MuÉËxšg fe i cu¼’y‚Ù suµÜ‹d! L‘‡kyrŞa@cs.cmu.edu know iàyou‚“dhi suµÜˆ:)." << 
	g¡d
::
’dl
;

260 
as£¹
(
muÉËx
 == 1);

262 
	gmuÉËx_roÙ
 = "";

263 
	g¡resize
 = 1024*1024*1024;

265 
	gm
.
£t
("¡resize", (
size_t
)
¡resize
);

268 
	gniÙh»ads
 = 
g‘_İtiÚ_št
("niothreads", 1);

269 
	gm
.
£t
("niÙh»ads", (
size_t
)
niÙh»ads
);

271 
log¡»am
(
LOG_DEBUG
è<< "S¹ io-mªag” w™h " << 
	gniÙh»ads
 << "h»ads." << 
	g¡d
::
’dl
;

274 
	gm¶ex_»adsks
 = 
Ãw
 
synchrÚized_queue
<
iÙask
>[
muÉËx
 * 
niÙh»ads
];

275 
	gm¶ex_wr™‘asks
 = 
Ãw
 
synchrÚized_queue
<
iÙask
>[
muÉËx
 * 
niÙh»ads
];

276 
	gm¶ex_´iÙasks
 = 
Ãw
 
synchrÚized_queue
<
iÙask
>[
muÉËx
 * 
niÙh»ads
];

278 
	gk
 = 0;

279 
	gi
=0; i < 
	gmuÉËx
; i++) {

280 
	gj
=0; j < 
	gniÙh»ads
; j++) {

281 
thršfo
 * 
	gùh»adšfo
 = 
Ãw
hrinfo();

282 
	gùh»adšfo
->
	gcomm™queue
 = &
m¶ex_wr™‘asks
[
k
];

283 
	gùh»adšfo
->
	g»adqueue
 = &
m¶ex_»adsks
[
k
];

284 
	gùh»adšfo
->
	g´ioqueue
 = &
m¶ex_´iÙasks
[
k
];

285 
	gùh»adšfo
->
	gruÂšg
 = 
Œue
;

286 
	gùh»adšfo
->
	g³ndšg_wr™es
 = 0;

287 
	gùh»adšfo
->
	g³ndšg_»ads
 = 0;

288 
	gùh»adšfo
->
	gm¶ex
 = 
i
;

289 
	gùh»adšfo
->
	gm
 = &
m
;

290 
	gth»ad_šfos
.
push_back
(
ùh»adšfo
);

292 
±h»ad_t
 
	giÙh»ad
;

293 
	g»t
 = 
±h»ad_ü—‹
(&
iÙh»ad
, 
NULL
, 
io_th»ad_loİ
, 
ùh»adšfo
);

294 
	gth»ads
.
push_back
(
iÙh»ad
);

295 
as£¹
(
»t
>=0);

296 
	gk
++;

301 ~
¡redio
() {

302 
	gm¶ex
 = (è
th»ad_šfos
.
size
();

304 
	gi
=0; i<
	gm¶ex
; i++) {

305 
	gth»ad_šfos
[
i
]->
	gruÂšg
=
çl£
;

307 
size_t
 
	gÁh»ads
 = 
th»ads
.
size
();

308 
	gi
=0; i<
	gÁh»ads
; i++) {

309 
±h»ad_još
(
th»ads
[
i
], 
NULL
);

311 
	gi
=0; i<
	gm¶ex
; i++) {

312 
d–‘e
 
	gth»ad_šfos
[
i
];

315 
	gj
=0; j<()
	g£ssiÚs
.
size
(); j++) {

316 ià(
	g£ssiÚs
[
j
] !ğ
NULL
) {

317 
şo£_£ssiÚ
(
j
);

318 
d–‘e
 
	g£ssiÚs
[
j
];

319 
	g£ssiÚs
[
j
] = 
NULL
;

323 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gmm­_šfo
>::
™”©Ü
 
mm™
 = 
mm­ed
.
begš
();

324 ; 
	gmm™
 !ğ
mm­ed
.
’d
(); ++mmit) {

325 
mm­_šfo
 
	gmšfo
 = 
mm™
->
£cÚd
;

326 
munm­
((*)
mšfo
.
±r
, mšfo.
Ëngth
);

327 
şo£
(
mšfo
.
fedesc
);

329 
	gmm­ed
.
ş—r
();

332 
£t_ÿche_budg‘
(
size_t
 
c
) {

333 
	gÿche
.
	gÿche_budg‘_by‹s
 = 
c
;

334 
	gÿche
.
	gfuÎ
 = 
çl£
;

337 
	gblock_ÿche
 & 
g‘_block_ÿche
() {

338  
	gÿche
;

344 
comm™_ÿched_blocks
() {

345 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gÿched_block
 *>::
™”©Ü
 
™
 = 
ÿche
.
ÿchem­
.
begš
();

346 ; 
	g™
 !ğ
ÿche
.
ÿchem­
.
’d
(); ++it) {

347 
	g¡d
::
¡ršg
 
âame
 = 
™
->
fœ¡
;

348 
ÿched_block
 * 
	gblock
 = 
™
->
£cÚd
;

350 
	g£ssiÚ
 = 
İ’_£ssiÚ
(
âame
, 
çl£
, 
block
->
was_com´es£d
);

351 
pwr™—_now
(
£ssiÚ
, 
block
->
d©a
, block->
Ën
, 0);

352 
şo£_£ssiÚ
(
£ssiÚ
);

357 
boŞ
 
muÉËxed
() {

358  
	gmuÉËx
>1;

361 
´št_£ssiÚ
(
£ssiÚ
) {

362 
	gi
=0; i<
	gmuÉËx
; i++) {

363 
	g¡d
::
cout
 << "muÉËx: " << 
muÉËx
 << 
¡d
::
’dl
;

364 
	g¡d
::
cout
 << "R—d desc: " << 
£ssiÚs
[
£ssiÚ
]->
»addescs
[
i
] << 
¡d
::
’dl
;

367 
	gi
=0; i<()
	g£ssiÚs
[
£ssiÚ
]->
	gwr™edescs
.
size
(); i++) {

368 
	g¡d
::
cout
 << "muÉËx: " << 
muÉËx
 << 
¡d
::
’dl
;

369 
	g¡d
::
cout
 << "R—d desc: " << 
£ssiÚs
[
£ssiÚ
]->
wr™edescs
[
i
] << 
¡d
::
’dl
;

376 
hash
(
¡d
::
¡ršg
 
f’ame
) {

377 cÚ¡ * 
c¡r
 = 
f’ame
.
c_¡r
();

378 
	ghash
 = 1;

379 
	gl
 = (è
¡¾’
(
c¡r
);

380 
	gi
=0; i<
	gl
; i++) {

381 
	ghash
 = 31*
hash
 + 
c¡r
[
i
];

383  
	g¡d
::
abs
(
hash
);

386 
İ’_£ssiÚ
(
¡d
::
¡ršg
 
f’ame
, 
boŞ
 
»adÚly
=
çl£
, boŞ 
com´es£d
=false) {

387 
mlock
.
lock
();

389 
	g£ssiÚ_id
 = (è
£ssiÚs
.
size
();

390 
io_desütÜ
 * 
	giodesc
 = 
Ãw
 io_descriptor();

391 
	giodesc
->
	gİ’
 = 
Œue
;

392 
	giodesc
->
	gcom´es£d
 = 
com´es£d
;

393 
	giodesc
->
	gf’ame
 = 
f’ame
;

394 
	giodesc
->
	g¡¬t_m¶ex
 = 
hash
(
f’ame
è% 
muÉËx
;

395 
	g£ssiÚs
.
push_back
(
iodesc
);

396 
	gmlock
.
uÆock
();

400 
	gi
=0; i<
	gmuÉËx
; i++) {

401 
	g¡d
::
¡ršg
 
âame
 = 
muÉËx´efix
(
i
è+ 
f’ame
;

402 
	gj
=0; j<
	gniÙh»ads
+(
	gmuÉËx
 == 1 ? 1 : 0); j++) {

403 
	grddesc
 = 
İ’
(
âame
.
c_¡r
(), (
»adÚly
 ? 
O_RDONLY
 : 
O_RDWR
));

404 ià(
	grddesc
 < 0è
log¡»am
(
LOG_ERROR
è<< "Could‚Ù o³n: " << 
	gâame
 << " sessiÚ: " << 
	g£ssiÚ_id


405 << "ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
	g¡d
::
’dl
;

406 
as£¹
(
rddesc
>=0);

407 
	giodesc
->
	g»addescs
.
push_back
(
rddesc
);

408 #ifdeà
F_NOCACHE


409 ià(!
	g»adÚly
)

410 
fú
(
rddesc
, 
F_NOCACHE
, 1);

412 ià(!
	g»adÚly
) {

413 
	gwrdesc
 = 
rddesc
;

415 ià(
	gwrdesc
 < 0è
log¡»am
(
LOG_ERROR
è<< "Could‚Ù o³ÀfÜ wr™šg: " << 
	gâame
 << " sessiÚ: " << 
	g£ssiÚ_id


416 << "ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
	g¡d
::
’dl
;

417 
as£¹
(
wrdesc
>=0);

418 #ifdeà
F_NOCACHE


419 
fú
(
wrdesc
, 
F_NOCACHE
, 1);

422 
	giodesc
->
	gwr™edescs
.
push_back
(
wrdesc
);

426 
	giodesc
->
	gf’ame
 = 
f’ame
;

427  
	g£ssiÚ_id
;

430 
şo£_£ssiÚ
(
£ssiÚ
) {

431 
	gmlock
.
lock
();

435 
boŞ
 
	gwasİ’
;

436 
io_desütÜ
 * 
	giodesc
 = 
£ssiÚs
[
£ssiÚ
];

437 
	gwasİ’
 = 
iodesc
->
İ’
;

438 
	giodesc
->
	gİ’
 = 
çl£
;

439 
	gmlock
.
uÆock
();

440 ià(
	gwasİ’
) {

441 
	g¡d
::
veùÜ
<>::
™”©Ü
 
™
=
iodesc
->
»addescs
.
begš
(); 
	g™
!=iodesc->»addescs.
’d
(); ++it) {

442 
şo£
(*
™
);

447 
fœ¡_·ss_fšished
() {

449 
	gÿche
.
	gfuÎ
 = 
Œue
;

452 
	g¡d
::
¡ršg
 & 
g‘_£ssiÚ_f’ame
(
£ssiÚ
) {

453  
£ssiÚs
[
£ssiÚ
]->
f’ame
;

456 
m¶ex_fÜ_off£t
(
£ssiÚ
, 
size_t
 
off
) {

457  ((è(
	goff
 / 
	g¡resize
è+ 
	g£ssiÚs
[
£ssiÚ
]->
	g¡¬t_m¶ex
è% 
	gmuÉËx
;

461 
	g¡d
::
veùÜ
< 
¡re_chunk
 > 
¡re_off£ts
(
£ssiÚ
, 
size_t
 
nby‹s
, size_ˆ
off
) {

462 
size_t
 
	g’d
 = 
off
+
nby‹s
;

463 
size_t
 
	gidx
 = 
off
;

464 
size_t
 
	gbufoff
 = 0;

465 
	g¡d
::
veùÜ
<
¡re_chunk
> 
¡r–i¡
;

466 
	gidx
<
	g’d
) {

467 
size_t
 
	gblockoff
 = 
idx
 % 
¡resize
;

468 
size_t
 
	gblockËn
 = 
¡d
::
mš
(
¡resize
-
blockoff
, 
’d
-
idx
);

470 
	gm¶ex_th»ad
 = (è
m¶ex_fÜ_off£t
(
£ssiÚ
, 
idx
è* 
	gniÙh»ads
 + (è(
¿ndom
() %‚iothreads);

471 
	g¡r–i¡
.
push_back
(
¡re_chunk
(
m¶ex_th»ad
, 
bufoff
, 
blockËn
));

473 
	gbufoff
 +ğ
blockËn
;

474 
	gidx
 +ğ
blockËn
;

476  
	g¡r–i¡
;

479 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

480 
´—da_async
(
£ssiÚ
, 
T
 * 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
, vŞ©* 
dÚ•Œ
 = 
NULL
) {

481 
¡d
::
veùÜ
<
¡re_chunk
> 
¡r–i¡
 = 
¡re_off£ts
(
£ssiÚ
, 
nby‹s
, 
off
);

482 ià(
com´es£d_£ssiÚ
(
£ssiÚ
)) {

483 
as£¹
(
¡r–i¡
.
size
() == 1);

484 
as£¹
(
off
 == 0);

486 
»fcouÁ±r
 * 
	g»åŒ
 = 
Ãw
„efcouÁ±r((*)
tbuf
, ()
¡r–i¡
.
size
());

487 
	gi
=0; i<()
	g¡r–i¡
.
size
(); i++) {

488 
¡re_chunk
 
	gchunk
 = 
¡r–i¡
[
i
];

489 
__sync_add_ªd_ãtch
(&
th»ad_šfos
[
chunk
.
m¶ex_th»ad
]->
³ndšg_»ads
, 1);

490 
iÙask
 
	gsk
 = iÙask(
this
, 
READ
, 
£ssiÚs
[
£ssiÚ
]->
»addescs
[
chunk
.
m¶ex_th»ad
],

491 
£ssiÚ
,

492 
»åŒ
, 
chunk
.
Ën
, chunk.
off£t
+
off
, chunk.off£t, 
çl£
,

493 
com´es£d_£ssiÚ
(
£ssiÚ
));

494 
	gsk
.
	gdÚ•Œ
 = 
dÚ•Œ
;

495 
	gm¶ex_»adsks
[
chunk
.
m¶ex_th»ad
].
push
(
sk
);

503 
boŞ
 
com´es£d_£ssiÚ
(
£ssiÚ
) {

504  
	g£ssiÚs
[
£ssiÚ
]->
	gcom´es£d
;

511 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

512 
pwr™—_async
(
£ssiÚ
, 
T
 * 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
, 
boŞ
 
ä“_aá”
, boŞ 
şo£_fd
=
çl£
) {

513 
¡d
::
veùÜ
<
¡re_chunk
> 
¡r–i¡
 = 
¡re_off£ts
(
£ssiÚ
, 
nby‹s
, 
off
);

514 
»fcouÁ±r
 * 
	g»åŒ
 = 
Ãw
„efcouÁ±r((*)
tbuf
, (è
¡r–i¡
.
size
());

515 ià(
com´es£d_£ssiÚ
(
£ssiÚ
)) {

516 
as£¹
(
¡r–i¡
.
size
() == 1);

517 
as£¹
(
off
 == 0);

519 
	gi
=0; i<()
	g¡r–i¡
.
size
(); i++) {

520 
¡re_chunk
 
	gchunk
 = 
¡r–i¡
[
i
];

521 
__sync_add_ªd_ãtch
(&
th»ad_šfos
[
chunk
.
m¶ex_th»ad
]->
³ndšg_wr™es
, 1);

522 
	gm¶ex_wr™‘asks
[
chunk
.
m¶ex_th»ad
].
push
(
iÙask
(
this
, 
WRITE
, 
£ssiÚs
[
£ssiÚ
]->
wr™edescs
[chunk.mplex_thread], session,

523 
»åŒ
, 
chunk
.
Ën
, chunk.
off£t
+
off
, chunk.off£t, 
ä“_aá”
, 
com´es£d_£ssiÚ
(
£ssiÚ
),

524 
şo£_fd
));

528 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

529 
´—da_now
(
£ssiÚ
, 
T
 * 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
, 
boŞ
 
dupfd
=
çl£
) {

530 
m‘rics_’Œy
 
me
 = 
m
.
¡¬t_time
();

531 ià(
com´es£d_£ssiÚ
(
£ssiÚ
)) {

533 
as£¹
(
off
 == 0);

534 
»ad_com´es£d
(
£ssiÚs
[
£ssiÚ
]->
»addescs
[0], 
tbuf
, 
nby‹s
);

535 
	gm
.
¡İ_time
(
me
, "´—da_now", 
çl£
);

539 ià(
	gmuÉËx
 > 1) {

540 
	g¡d
::
veùÜ
<
¡re_chunk
> 
¡r–i¡
 = 
¡re_off£ts
(
£ssiÚ
, 
nby‹s
, 
off
);

541 
size_t
 
	gcheckËn
=0;

542 
»fcouÁ±r
 * 
	g»åŒ
 = 
Ãw
„efcouÁ±r((*)
tbuf
, (è
¡r–i¡
.
size
());

543 
	g»åŒ
->
	gcouÁ
++;

544 
	gi
=0; i < ()
	g¡r–i¡
.
size
(); i++) {

545 
¡re_chunk
 
	gchunk
 = 
¡r–i¡
[
i
];

546 
__sync_add_ªd_ãtch
(&
th»ad_šfos
[
chunk
.
m¶ex_th»ad
]->
³ndšg_»ads
, 1);

549 
	gm¶ex_´iÙasks
[
chunk
.
m¶ex_th»ad
].
push
(
iÙask
(
this
, 
READ
, 
£ssiÚs
[
£ssiÚ
]->
»addescs
[chunk.mplex_thread], session,

550 
»åŒ
, 
chunk
.
Ën
, chunk.
off£t
+
off
, chunk.off£t, 
çl£
,

551 
çl£
));

552 
	gcheckËn
 +ğ
chunk
.
Ën
;

554 
as£¹
(
checkËn
 =ğ
nby‹s
);

557 
	g»åŒ
->
	gcouÁ
>1) {

558 
u¦“p
(5000);

560 
d–‘e
 
	g»åŒ
;

562 ià(!
	gdupfd
) {

563 
´—da
(
£ssiÚs
[
£ssiÚ
]->
»addescs
[
th»ads
.
size
()], 
tbuf
, 
nby‹s
, 
off
);

565 
	gfedesc
 = 
dup
(
£ssiÚs
[
£ssiÚ
]->
»addescs
[
th»ads
.
size
()]);

566 
´—da
(
fedesc
, 
tbuf
, 
nby‹s
, 
off
);

567 
şo£
(
fedesc
);

571 
	gm
.
¡İ_time
(
me
, "´—da_now", 
çl£
);

574 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

575 
pwr™—_now
(
£ssiÚ
, 
T
 * 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
) {

576 
m‘rics_’Œy
 
	gme
 = 
m
.
¡¬t_time
();

578 ià(
com´es£d_£ssiÚ
(
£ssiÚ
)) {

580 
as£¹
(
off
 == 0);

581 
wr™e_com´es£d
(
£ssiÚs
[
£ssiÚ
]->
wr™edescs
[0], 
tbuf
, 
nby‹s
);

582 
	gm
.
¡İ_time
(
me
, "pwr™—_now", 
çl£
);

586 
	g¡d
::
veùÜ
<
¡re_chunk
> 
¡r–i¡
 = 
¡re_off£ts
(
£ssiÚ
, 
nby‹s
, 
off
);

587 
size_t
 
	gcheckËn
=0;

589 
	gi
=0; i<()
	g¡r–i¡
.
size
(); i++) {

590 
¡re_chunk
 
	gchunk
 = 
¡r–i¡
[
i
];

591 
pwr™—
(
£ssiÚs
[
£ssiÚ
]->
wr™edescs
[
chunk
.
m¶ex_th»ad
], (*)
tbuf
+chunk.
off£t
, chunk.
Ën
, chunk.off£t+
off
);

592 
	gcheckËn
 +ğ
chunk
.
Ën
;

594 
as£¹
(
checkËn
 =ğ
nby‹s
);

595 
	gm
.
¡İ_time
(
me
, "pwr™—_now", 
çl£
);

606 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

607 
mªaged_pwr™—_async
(
£ssiÚ
, 
T
 ** 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
, 
boŞ
 
ä“_aá”
, boŞ 
şo£_fd
=
çl£
) {

608 
pwr™—_async
(
£ssiÚ
, *
tbuf
, 
nby‹s
, 
off
, 
ä“_aá”
, 
şo£_fd
);

611 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

612 
mªaged_´—da_now
(
£ssiÚ
, 
T
 ** 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
) {

613 
´—da_now
(
£ssiÚ
, *
tbuf
, 
nby‹s
, 
off
);

616 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

617 
mªaged_pwr™—_now
(
£ssiÚ
, 
T
 ** 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
) {

618 
pwr™—_now
(
£ssiÚ
, *
tbuf
, 
nby‹s
, 
off
);

621 
	g‹m¶©e
<
ty³Çme
 
	gT
>

622 
mªaged_m®loc
(
£ssiÚ
, 
T
 ** 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
noff
) {

623 *
	gtbuf
 = (
T
*è
m®loc
(
nby‹s
);

629 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

630 
mªaged_´—da_async
(
£ssiÚ
, 
T
 ** 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
, vŞ©* 
dÚ•Œ
 = 
NULL
) {

631 
´—da_async
(
£ssiÚ
, *
tbuf
, 
nby‹s
, 
off
, 
dÚ•Œ
);

634 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

635 
mªaged_»Ëa£
(
£ssiÚ
, 
T
 ** 
±r
) {

636 
as£¹
(*
±r
 !ğ
NULL
);

637 
ä“
(*
±r
);

638 *
	g±r
 = 
NULL
;

642 
Œunÿ‹
(
£ssiÚ
, 
size_t
 
nby‹s
) {

643 
as£¹
(
muÉËx
 <= 1);

644 
	g¡©
 = 
árunÿ‹
(
£ssiÚs
[
£ssiÚ
]->
wr™edescs
[0], 
nby‹s
);

645 ià(
	g¡©
 != 0) {

646 
log¡»am
(
LOG_ERROR
è<< "Could‚Ùrunÿ‹ " << 
£ssiÚs
[
£ssiÚ
]->
f’ame
 <<

647 "ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

648 
as£¹
(
çl£
);

652 
wa™_fÜ_»ads
() {

653 
m‘rics_’Œy
 
	gme
 = 
m
.
¡¬t_time
();

654 
	gloİs
 = 0;

655 
	gm¶ex
 = (è
th»ad_šfos
.
size
();

656 
	gi
=0; i<
	gm¶ex
; i++) {

657 
	gth»ad_šfos
[
i
]->
	g³ndšg_»ads
 > 0) {

658 
u¦“p
(10000);

659 
	gloİs
++;

662 
	gm
.
¡İ_time
(
me
, "¡redio_wa™_fÜ_»ads", 
çl£
);

665 
wa™_fÜ_wr™es
() {

666 
m‘rics_’Œy
 
	gme
 = 
m
.
¡¬t_time
();

667 
	gm¶ex
 = (è
th»ad_šfos
.
size
();

668 
	gi
=0; i<
	gm¶ex
; i++) {

669 
	gth»ad_šfos
[
i
]->
	g³ndšg_wr™es
>0) {

670 
u¦“p
(10000);

673 
	gm
.
¡İ_time
(
me
, "¡redio_wa™_fÜ_wr™es", 
çl£
);

677 
	g¡d
::
¡ršg
 
muÉËx´efix
(
¡re
) {

678 ià(
muÉËx
 > 1) {

679 
m¡r
[255];

680 
¥rštf
(
m¡r
, "%d/", 1+
¡re
%
muÉËx
);

681  
	gmuÉËx_roÙ
 + 
	g¡d
::
¡ršg
(
m¡r
);

685 
	g¡d
::
¡ršg
 
muÉËx´efix_¿ndom
() {

686  
muÉËx´efix
(()
¿ndom
(è% 
muÉËx
);

693 
	gpublic
:

694 * 
g‘_mm­ed_fe
(
¡d
::
¡ršg
 &
f’ame
, 
boŞ
 
wr™e
) {

695 
	g¡d
::
¡ršg
 
ÿchekey
 = (
wr™e
 ? 
f’ame
 + "?w" : filename);

696 * 
	g±r
 = 
NULL
;

697 
	gmm­lock
.
lock
();

699 ià(
	gmm­ed
.
fšd
(
ÿchekey
è=ğ
mm­ed
.
’d
()) {

700 
log¡»am
(
LOG_DEBUG
è<< "Mm­: " << 
f’ame
 << 
¡d
::
’dl
;

702 
size_t
 
	gmm­_Ëngth
 = 
g‘_fesize
(
f’ame
);

703 
	gfedesc
 = 
İ’
(
f’ame
.
c_¡r
(), (
wr™e
 ? 
O_RDWR
 : 
O_RDONLY
));

704 
	g±r
 = 
mm­
(
NULL
, 
mm­_Ëngth
, (
wr™e
 ? 
PROT_READ
 | 
PROT_WRITE
 : PROT_READ), 
MAP_SHARED
, 
fedesc
, 0);

705 ià(!
	g±r
) {

706 
log¡»am
(
LOG_FATAL
è<< "Could‚Ù mm­ " << 
	gf’ame
 << 
	g¡d
::
’dl
;

708 
as£¹
(
±r
);

709 
mm­_šfo
 
	gmšfo
;

710 
	gmšfo
.
	g±r
 = 
±r
;

711 
	gmšfo
.
	gËngth
 = 
mm­_Ëngth
;

712 
	gmšfo
.
	gfedesc
 = 
fedesc
;

713 
	gmm­ed
[
ÿchekey
] = 
mšfo
;

715 
	g±r
 = 
mm­ed
[
ÿchekey
].
±r
;

717 
	gmm­lock
.
uÆock
();

718  
	g±r
;

724 * 
	$io_th»ad_loİ
(* 
_šfo
) {

725 
iÙask
 
sk
;

726 
thršfo
 * 
šfo
 = (thršfo*)
_šfo
;

727 
Áasks
 = 0;

729 
šfo
->
ruÂšg
) {

730 
boŞ
 
sucûss
;

731 ià(
šfo
->
³ndšg_»ads
>0) {

732 
sucûss
 = 
šfo
->
´ioqueue
->
	`§ãpİ
(&
sk
);

733 ià(!
sucûss
) {

734 
sucûss
 = 
šfo
->
»adqueue
->
	`§ãpİ
(&
sk
);

737 
sucûss
 = 
šfo
->
comm™queue
->
	`§ãpİ
(&
sk
);

739 ià(
sucûss
) {

740 ++
Áasks
;

741 ià(
sk
.
aùiÚ
 =ğ
WRITE
) {

742 
m‘rics_’Œy
 
me
 = 
šfo
->
m
->
	`¡¬t_time
();

744 ià(
sk
.
com´es£d
) {

745 
	`as£¹
(
sk
.
off£t
 == 0);

746 
	`wr™e_com´es£d
(
sk
.
fd
,ask.
±r
->±r,ask.
Ëngth
);

748 
	`pwr™—
(
sk
.
fd
,ask.
±r
->±¸+ask.
±roff£t
,ask.
Ëngth
,ask.
off£t
);

750 ià(
sk
.
ä“_aá”
) {

752 ià(
	`__sync_sub_ªd_ãtch
(&
sk
.
±r
->
couÁ
, 1) == 0) {

753 
	`ä“
(
sk
.
±r
->ptr);

754 
d–‘e
 
sk
.
±r
;

755 ià(
sk
.
şo£fd
) {

756 
sk
.
iomgr
->
	`şo£_£ssiÚ
Ñask.
£ssiÚ
);

761 
	`__sync_sub_ªd_ãtch
(&
šfo
->
³ndšg_wr™es
, 1);

762 
šfo
->
m
->
	`¡İ_time
(
me
, "commit_thr");

764 ià(
sk
.
com´es£d
) {

765 
	`as£¹
(
sk
.
off£t
 == 0);

766 
	`»ad_com´es£d
(
sk
.
fd
,ask.
±r
->±r,ask.
Ëngth
);

769 
	`´—da
(
sk
.
fd
,ask.
±r
->±r+sk.
±roff£t
,ask.
Ëngth
,ask.
off£t
);

771 
	`__sync_sub_ªd_ãtch
(&
šfo
->
³ndšg_»ads
, 1);

772 ià(
	`__sync_sub_ªd_ãtch
(&
sk
.
±r
->
couÁ
, 1) == 0) {

773 
	`ä“
(
sk
.
±r
);

774 ià(
sk
.
şo£fd
) {

775 
sk
.
iomgr
->
	`şo£_£ssiÚ
Ñask.
£ssiÚ
);

779 ià(
sk
.
dÚ•Œ
 !ğ
NULL
) {

780 
	`__sync_sub_ªd_ãtch
(
sk
.
dÚ•Œ
, 1);

783 
	`u¦“p
(50000);

787  
NULL
;

788 
	}
}

792 
size_t
 
g‘_fesize
(
¡d
::
¡ršg
 
f’ame
) {

793 
¡d
::
¡ršg
 
âame
 = 
f’ame
;

794 
	gf
 = 
İ’
(
âame
.
c_¡r
(), 
O_RDONLY
);

796 ià(
	gf
 < 0) {

797 
log¡»am
(
LOG_ERROR
è<< "Could‚Ù o³Àf" << 
	gf’ame
 << "ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
	g¡d
::
’dl
;

798 
as£¹
(
çl£
);

801 
off_t
 
	gsz
 = 
l£ek
(
f
, 0, 
SEEK_END
);

802 
şo£
(
f
);

803  
	gsz
;

	@logger/logger.hpp

49 #iâdeà
GRAPHCHI_LOG_LOG_HPP


50 
	#GRAPHCHI_LOG_LOG_HPP


	)

51 
	~<f¡»am
>

52 
	~<s¡»am
>

53 
	~<c¡dlib
>

54 
	~<io¡»am
>

55 
	~<ÿs£¹
>

56 
	~<c¡ršg
>

57 
	~<c¡d¬g
>

58 
	~<±h»ad.h
>

71 
	#LOG_NONE
 5

	)

72 
	#LOG_FATAL
 4

	)

73 
	#LOG_ERROR
 3

	)

74 
	#LOG_WARNING
 2

	)

75 
	#LOG_INFO
 1

	)

76 
	#LOG_DEBUG
 0

	)

85 #iâdeà
OUTPUTLEVEL


86 
	#OUTPUTLEVEL
 
LOG_DEBUG


	)

89 
	#COLOROUTPUT


	)

100 #ià
OUTPUTLEVEL
 =ğ
LOG_NONE


102 
	#logg”
(
lvl
,
fmt
,...)

	)

103 
	#logbuf
(
lvl
,
fmt
,...)

	)

104 
	#log¡»am


	)

107 
	#logg”
(
lvl
,
fmt
,...) \

108 (
log_di¥©ch
<(
lvl
 >ğ
OUTPUTLEVEL
)>::
	`exec
Övl,
__FILE__
, 
__func__
 ,
__LINE__
,
fmt
,##
__VA_ARGS__
))

	)

111 
	#logbuf
(
lvl
,
buf
,
Ën
) \

112 (
log_di¥©ch
<(
lvl
 >ğ
OUTPUTLEVEL
)>::
	`exec
Övl,
__FILE__
, \

113 
__func__
 ,
__LINE__
,
buf
,
Ën
))

	)

115 
	#log¡»am
(
lvl
) \

116 (
log_¡»am_di¥©ch
<(
lvl
 >ğ
OUTPUTLEVEL
)>::
	`exec
Övl,
__FILE__
, 
__func__
 ,
__LINE__
è)

	)

119 cÚ¡ * 
	gmes§ges
[] = { "DEBUG: ",

125 
Çme¥aû
 
	glogg”_im¶
 {

126 
	s¡»ambuff_s_’Œy
 {

127 
	g¡d
::
¡ršg¡»am
 
¡»ambufãr
;

128 
boŞ
 
	g¡»amaùive
;

137 şas 
	cfe_logg”
{

138 
	mpublic
:

150 
	$£t_log_to_cÚsŞe
(
boŞ
 
cÚsŞ–og
) {

151 
log_to_cÚsŞe
 = 
cÚsŞ–og
;

155 
¡d
::
¡ršg
 
	$g‘_log_fe
() {

156  
log_fe
;

157 
	}
}

160 
boŞ
 
	$g‘_log_to_cÚsŞe
() {

161  
log_to_cÚsŞe
;

162 
	}
}

165 
	$g‘_log_Ëv–
() {

166  
log_Ëv–
;

167 
	}
}

170 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

171 
	gfe_logg”
& 
	gİ”©Ü
<<(
T
 
	ga
) {

173 
	glogg”_im¶
::
¡»ambuff_s_’Œy
* 
¡»ambuãÁry
 = 
»š‹½»t_ÿ¡
<
logg”_im¶
::streambuff_tls_entry*>(

174 
±h»ad_g‘¥ecific
(
¡»ambuffkey
));

175 ià(
	g¡»ambuãÁry
 !ğ
NULL
) {

176 
¡d
::
¡ršg¡»am
& 
¡»ambufãr
 = 
¡»ambuãÁry
->streambuffer;

177 
	gboŞ
& 
	g¡»amaùive
 = 
¡»ambuãÁry
->
¡»amaùive
;

179 ià(
	g¡»amaùive
è
	g¡»ambufãr
 << 
	ga
;

181  *
	gthis
;

184 
	gfe_logg”
& 
	gİ”©Ü
<<(cÚ¡ * 
	ga
) {

186 
	glogg”_im¶
::
¡»ambuff_s_’Œy
* 
¡»ambuãÁry
 = 
»š‹½»t_ÿ¡
<
logg”_im¶
::streambuff_tls_entry*>(

187 
±h»ad_g‘¥ecific
(
¡»ambuffkey
));

188 ià(
	g¡»ambuãÁry
 !ğ
NULL
) {

189 
¡d
::
¡ršg¡»am
& 
¡»ambufãr
 = 
¡»ambuãÁry
->streambuffer;

190 
	gboŞ
& 
	g¡»amaùive
 = 
¡»ambuãÁry
->
¡»amaùive
;

192 ià(
	g¡»amaùive
) {

193 
	g¡»ambufãr
 << 
	ga
;

194 ià(
	ga
[
¡¾’
(
a
)-1] == '\n') {

195 
¡»am_æush
();

199  *
	gthis
;

202 
	gfe_logg”
& 
	gİ”©Ü
<<(
	g¡d
::
o¡»am
& (*
f
)(
¡d
::ostream&)){

204 
logg”_im¶
::
¡»ambuff_s_’Œy
* 
¡»ambuãÁry
 = 
»š‹½»t_ÿ¡
<logger_impl::streambuff_tls_entry*>(

205 
±h»ad_g‘¥ecific
(
¡»ambuffkey
));

206 ià(
	g¡»ambuãÁry
 !ğ
NULL
) {

207 
¡d
::
¡ršg¡»am
& 
¡»ambufãr
 = 
¡»ambuãÁry
->streambuffer;

208 
	gboŞ
& 
	g¡»amaùive
 = 
¡»ambuãÁry
->
¡»amaùive
;

210 
	g¡d
::
	to¡»am
& (*
	t’dÉy³
)(
	t¡d
::ostream&);

211 ià(
	g¡»amaùive
) {

212 ià(
’dÉy³
(
f
è=ğ’dÉy³(
¡d
::
’dl
)) {

213 
¡»ambufãr
 << "\n";

214 
¡»am_æush
();

215 if(
	g¡»amlogËv–
 =ğ
LOG_FATAL
) {

216 
throw
 "log fatal";

222  *
	gthis
;

229 
	$£t_log_Ëv–
(
Ãw_log_Ëv–
) {

230 
log_Ëv–
 = 
Ãw_log_Ëv–
;

231 
	}
}

239 
	$¡»ambuffde¡ruùÜ
(* 
v
){

240 
logg”_im¶
::
¡»ambuff_s_’Œy
* 
t
 =

241 
»š‹½»t_ÿ¡
<
logg”_im¶
::
¡»ambuff_s_’Œy
*>(
v
);

242 
d–‘e
 
t
;

243 
	}
}

250 
	$fe_logg”
() {

251 
log_fe
 = "";

252 
log_to_cÚsŞe
 = 
Œue
;

253 
log_Ëv–
 = 
LOG_DEBUG
;

254 
	`±h»ad_mu‹x_š™
(&
mut
, 
NULL
);

255 
	`±h»ad_key_ü—‹
(&
¡»ambuffkey
, 
¡»ambuffde¡ruùÜ
);

256 
	}
}

258 ~
	$fe_logg”
() {

259 ià(
fout
.
	`good
()) {

260 
fout
.
	`æush
();

261 
fout
.
	`şo£
();

264 
	`±h»ad_mu‹x_de¡roy
(&
mut
);

265 
	}
}

267 
boŞ
 
£t_log_fe
(
¡d
::
¡ršg
 
fe
) {

269 ià(
fout
.
good
()) {

270 
fout
.
æush
();

271 
	gfout
.
şo£
();

272 
	glog_fe
 = "";

275 ià(
	gfe
.
Ëngth
() > 0) {

276 
	gfout
.
İ’
(
fe
.
c_¡r
());

277 ià(
	gfout
.
ç
()è 
	gçl£
;

278 
	glog_fe
 = 
fe
;

280  
	gŒue
;

285 
	#RESET
 0

	)

286 
	#BRIGHT
 1

	)

287 
	#DIM
 2

	)

288 
	#UNDERLINE
 3

	)

289 
	#BLINK
 4

	)

290 
	#REVERSE
 7

	)

291 
	#HIDDEN
 8

	)

293 
	#BLACK
 0

	)

294 
	#RED
 1

	)

295 
	#GREEN
 2

	)

296 
	#YELLOW
 3

	)

297 
	#BLUE
 4

	)

298 
	#MAGENTA
 5

	)

299 
	#CYAN
 6

	)

300 
	#WHITE
 7

	)

302 
	$‹xtcŞÜ
(
FILE
* 
hªdË
, 
©Œ
, 
fg
)

304 
commªd
[13];

306 
	`¥rštf
(
commªd
, "%c[%d;%dm", 0x1B, 
©Œ
, 
fg
 + 30);

307 
	`årštf
(
hªdË
, "%s", 
commªd
);

308 
	}
}

310 
	$»£t_cŞÜ
(
FILE
* 
hªdË
)

312 
commªd
[20];

314 
	`¥rštf
(
commªd
, "%c[0m", 0x1B);

315 
	`årštf
(
hªdË
, "%s", 
commªd
);

316 
	}
}

320 
	$_log
(
lš–ogËv–
,cÚ¡ * 
fe
,cÚ¡ * 
funùiÚ
,

321 
lše
,cÚ¡ * 
fmt
, 
va_li¡
 
­
 ){

323 ià(
lš–ogËv–
 >ğ0 &&†š–ogËv– <ğ3 &&†š–ogËv– >ğ
log_Ëv–
){

326 
fe
 = ((
	`¡¼chr
(file, '/') ? : file- 1) + 1);

328 
¡r
[1024];

331 
by‹swr™‹n
 = 
	`¢´štf
(
¡r
,1024, "%s%s(%s:%d): ",

332 
mes§ges
[
lš–ogËv–
],
fe
,
funùiÚ
,
lše
);

335 
by‹swr™‹n
 +ğ
	`v¢´štf
(
¡r
 + by‹swr™‹n,1024 - by‹swr™‹n,
fmt
,
­
);

337 
¡r
[
by‹swr™‹n
] = '\n';

338 
¡r
[
by‹swr™‹n
+1] = 0;

340 ià(
fout
.
	`good
()) {

341 
	`±h»ad_mu‹x_lock
(&
mut
);

342 
fout
 << 
¡r
;;

343 
	`±h»ad_mu‹x_uÆock
(&
mut
);

345 ià(
log_to_cÚsŞe
) {

346 #ifdeà
COLOROUTPUT


347 ià(
lš–ogËv–
 =ğ
LOG_FATAL
) {

348 
	`‹xtcŞÜ
(
¡d”r
, 
BRIGHT
, 
RED
);

350 ià(
lš–ogËv–
 =ğ
LOG_ERROR
) {

351 
	`‹xtcŞÜ
(
¡d”r
, 
BRIGHT
, 
RED
);

353 ià(
lš–ogËv–
 =ğ
LOG_WARNING
) {

354 
	`‹xtcŞÜ
(
¡d”r
, 
BRIGHT
, 
GREEN
);

357 
¡d
::
û¼
 << 
¡r
;;

358 #ifdeà
COLOROUTPUT


359 
	`»£t_cŞÜ
(
¡d”r
);

363 
	}
}

367 
	$_logbuf
(
lš–ogËv–
,cÚ¡ * 
fe
,cÚ¡ * 
funùiÚ
,

368 
lše
,cÚ¡ * 
buf
, 
Ën
) {

370 ià(
lš–ogËv–
 >ğ0 &&†š–ogËv– <ğ3 &&†š–ogËv– >ğ
log_Ëv–
){

373 
fe
 = ((
	`¡¼chr
(file, '/') ? : file- 1) + 1);

376 
size_t
 
h—d”Ën
 = 
	`¢´štf
(
NULL
,0,"%s%s(%s:%d): ",

377 
mes§ges
[
lš–ogËv–
],
fe
,
funùiÚ
,
lše
);

379 ià(
h—d”Ën
> 2047) {

380 
¡d
::
û¼
 << "Header†engthƒxceed buffer†ength!";

383 
¡r
[2048];

384 cÚ¡ *
Ãwlše
="\n";

386 
by‹swr™‹n
 = 
	`¢´štf
(
¡r
,2047,"%s%s(%s:%d): ",

387 
mes§ges
[
lš–ogËv–
],
fe
,
funùiÚ
,
lše
);

388 
	`_log¿w
(
lš–ogËv–
,
¡r
, 
by‹swr™‹n
);

389 
	`_log¿w
(
lš–ogËv–
,
buf
, 
Ën
);

390 
	`_log¿w
(
lš–ogËv–
,
Ãwlše
, ()
	`¡¾’
(newline));

393 
	}
}

395 
	$_log¿w
(
lš–ogËv–
, cÚ¡ * 
buf
, 
Ën
) {

396 ià(
fout
.
	`good
()) {

397 
	`±h»ad_mu‹x_lock
(&
mut
);

398 
fout
.
	`wr™e
(
buf
,
Ën
);

399 
	`±h»ad_mu‹x_uÆock
(&
mut
);

401 ià(
log_to_cÚsŞe
) {

402 #ifdeà
COLOROUTPUT


403 ià(
lš–ogËv–
 =ğ
LOG_FATAL
) {

404 
	`‹xtcŞÜ
(
¡d”r
, 
BRIGHT
, 
RED
);

406 ià(
lš–ogËv–
 =ğ
LOG_ERROR
) {

407 
	`‹xtcŞÜ
(
¡d”r
, 
BRIGHT
, 
RED
);

409 ià(
lš–ogËv–
 =ğ
LOG_WARNING
) {

410 
	`‹xtcŞÜ
(
¡d”r
, 
BRIGHT
, 
GREEN
);

412 ià(
lš–ogËv–
 =ğ
LOG_DEBUG
) {

413 
	`‹xtcŞÜ
(
¡d”r
, 
BRIGHT
, 
YELLOW
);

417 
¡d
::
û¼
.
	`wr™e
(
buf
,
Ën
);

418 #ifdeà
COLOROUTPUT


419 
	`»£t_cŞÜ
(
¡d”r
);

422 
	}
}

424 
	gfe_logg”
& 
	$¡¬t_¡»am
(
lš–ogËv–
,cÚ¡ * 
fe
,cÚ¡ * 
funùiÚ
, 
lše
) {

426 
logg”_im¶
::
¡»ambuff_s_’Œy
* 
¡»ambuãÁry
 = 
»š‹½»t_ÿ¡
<logger_impl::streambuff_tls_entry*>(

427 
	`±h»ad_g‘¥ecific
(
¡»ambuffkey
));

429 ià(
¡»ambuãÁry
 =ğ
NULL
) {

430 
¡»ambuãÁry
 = 
Ãw
 
logg”_im¶
::
¡»ambuff_s_’Œy
;

431 
	`±h»ad_£t¥ecific
(
¡»ambuffkey
, 
¡»ambuãÁry
);

433 
¡d
::
¡ršg¡»am
& 
¡»ambufãr
 = 
¡»ambuãÁry
->streambuffer;

434 
boŞ
& 
¡»amaùive
 = 
¡»ambuãÁry
->streamactive;

436 
fe
 = ((
	`¡¼chr
(file, '/') ? : file- 1) + 1);

438 ià(
lš–ogËv–
 >ğ
log_Ëv–
){

439 ià(
¡»ambufãr
.
	`¡r
().
	`Ëngth
() == 0) {

440 
¡»ambufãr
 << 
mes§ges
[
lš–ogËv–
] << 
fe


441 << "(" << 
funùiÚ
 << ":" <<
lše
<<"): ";

443 
¡»amaùive
 = 
Œue
;

444 
¡»amlogËv–
 = 
lš–ogËv–
;

447 
¡»amaùive
 = 
çl£
;

449  *
this
;

450 
	}
}

454 
	$¡»am_æush
() {

456 
logg”_im¶
::
¡»ambuff_s_’Œy
* 
¡»ambuãÁry
 = 
»š‹½»t_ÿ¡
<logger_impl::streambuff_tls_entry*>(

457 
	`±h»ad_g‘¥ecific
(
¡»ambuffkey
));

458 ià(
¡»ambuãÁry
 !ğ
NULL
) {

459 
¡d
::
¡ršg¡»am
& 
¡»ambufãr
 = 
¡»ambuãÁry
->streambuffer;

461 
¡»ambufãr
.
	`æush
();

462 
	`_log¿w
(
¡»amlogËv–
,

463 
¡»ambufãr
.
	`¡r
().
	`c_¡r
(),

464 ()(
¡»ambufãr
.
	`¡r
().
	`Ëngth
()));

465 
¡»ambufãr
.
	`¡r
("");

467 
	}
}

468 
	g´iv©e
:

469 
¡d
::
of¡»am
 
fout
;

470 
	g¡d
::
¡ršg
 
log_fe
;

472 
±h»ad_key_t
 
	g¡»ambuffkey
;

474 
	g¡»amlogËv–
;

475 
±h»ad_mu‹x_t
 
	gmut
;

477 
boŞ
 
	glog_to_cÚsŞe
;

478 
	glog_Ëv–
;

483 
	gfe_logg”
& 
glob®_logg”
();

488 
	g‹m¶©e
 <
boŞ
 
	gdo¡uff
>

489 
	slog_di¥©ch
 {};

491 
	g‹m¶©e
 <>

492 
	glog_di¥©ch
<
	gŒue
> {

493 
šlše
 
exec
(
logËv–
,cÚ¡ * 
fe
,cÚ¡ * 
funùiÚ
,

494 
lše
,cÚ¡ * 
fmt
, ... ) {

495 
va_li¡
 
	g¬gp
;

496 
va_¡¬t
(
¬gp
, 
fmt
);

497 
glob®_logg”
().
_log
(
logËv–
, 
fe
, 
funùiÚ
, 
lše
, 
fmt
, 
¬gp
);

498 
va_’d
(
¬gp
);

502 
	g‹m¶©e
 <>

503 
	glog_di¥©ch
<
	gçl£
> {

504 
šlše
 
exec
(
logËv–
,cÚ¡ * 
fe
,cÚ¡ * 
funùiÚ
,

505 
lše
,cÚ¡ * 
fmt
, ... ) {}

509 
	snuÎ_¡»am
 {

510 
	m‹m¶©e
<
ty³Çme
 
	mT
>

511 
šlše
 
nuÎ_¡»am
 
	mİ”©Ü
<<(
T
 
	mt
) { ‚ull_stream(); }

512 
šlše
 
nuÎ_¡»am
 
	mİ”©Ü
<<(cÚ¡ * 
	ma
) { ‚ull_stream(); }

513 
šlše
 
nuÎ_¡»am
 
	mİ”©Ü
<<(
	m¡d
::
o¡»am
& (*
f
)(
¡d
::ostream&)) { ‚ull_stream(); }

517 
	g‹m¶©e
 <
boŞ
 
	gdo¡uff
>

518 
	slog_¡»am_di¥©ch
 {};

520 
	g‹m¶©e
 <>

521 
	glog_¡»am_di¥©ch
<
	gŒue
> {

522 
šlše
 
	gfe_logg”
& 
exec
(
lš–ogËv–
,cÚ¡ * 
fe
,cÚ¡ * 
funùiÚ
, 
lše
) {

523  
glob®_logg”
().
¡¬t_¡»am
(
lš–ogËv–
, 
fe
, 
funùiÚ
, 
lše
);

527 
	g‹m¶©e
 <>

528 
	glog_¡»am_di¥©ch
<
	gçl£
> {

529 
šlše
 
nuÎ_¡»am
 
exec
(
lš–ogËv–
,cÚ¡ * 
fe
,cÚ¡ * 
funùiÚ
, 
lše
) {

530  
nuÎ_¡»am
();

534 
‹xtcŞÜ
(
FILE
* 
hªdË
, 
©Œ
, 
fg
);

535 
»£t_cŞÜ
(
FILE
* 
hªdË
);

537 
	gfe_logg”
& 
	$glob®_logg”
() {

538 
fe_logg”
 
l
;

539  
l
;

540 
	}
}

	@metrics/imetrics_reporter.hpp

32 #iâdeà
DEF_GRAPHCHI_IMETRICS_REPORTER


33 
	#DEF_GRAPHCHI_IMETRICS_REPORTER


	)

35 
	~<m­
>

38 
Çme¥aû
 
	gg¿phchi
 {

39 şas 
	cim‘rics_»pÜ‹r
 {

41 
	gpublic
:

42 
vœtu®
 
do_»pÜt
(
¡d
::
¡ršg
 
Çme
, std::¡ršg 
id
, std::
m­
<¡d::¡ršg, 
m‘rics_’Œy
> & 
’Œ›s
) = 0;

	@metrics/metrics.hpp

30 #iâdeà
DEF_METRICS_HPP


31 
	#DEF_METRICS_HPP


	)

33 
	~<c¡ršg
>

34 
	~<m­
>

35 
	~<veùÜ
>

36 
	~<lim™s
>

37 
	~<as£¹.h
>

38 
	~<sys/time.h
>

40 
	~"ut/±h»ad_toŞs.hµ
"

41 
	~"ut/cmdİts.hµ
"

43 
Çme¥aû
 
	gg¿phchi
 {

46 
	em‘riùy³
 {
	gREAL
, 
	gINTEGER
, 
	gTIME
, 
	gSTRING
, 
	gVECTOR
};

52 
	sm‘rics_’Œy
 {

53 
size_t
 
	gcouÁ
;

54 
	gv®ue
;

55 
	gmšv®ue
;

56 
	gcumv®ue
;

57 
	gmaxv®ue
;

58 
m‘riùy³
 
	gv®ty³
;

59 
	g¡d
::
¡ršg
 
¡ršgv®
;

60 
	g¡d
::
veùÜ
<> 
v
;

61 
timev®
 
	g¡¬t_time
;

62 
	gÏ¡time
;

64 
m‘rics_’Œy
() {}

66 
šlše
 
m‘rics_’Œy
(
fœ¡v®ue
, 
m‘riùy³
 
_v®ty³
) {

67 
	gmšv®ue
 = 
fœ¡v®ue
;

68 
	gmaxv®ue
 = 
fœ¡v®ue
;

69 
	gv®ue
 = 
fœ¡v®ue
;

70 
	gv®ty³
 = 
_v®ty³
;

71 
	gcumv®ue
 = 
v®ue
;

72 
	gcouÁ
 = 1;

73 ià(
	gv®ty³
 =ğ
VECTOR
è
v
.
push_back
(
fœ¡v®ue
);

75 
šlše
 
m‘rics_’Œy
(
¡d
::
¡ršg
 
sv®ue
) {

76 
v®ty³
 = 
STRING
;

77 
	g¡ršgv®
 = 
sv®ue
;

79 
šlše
 
m‘rics_’Œy
(
m‘riùy³
 
_v®ty³
) {

80 
	gv®ty³
 = 
_v®ty³
;

81 
	gcouÁ
 = 0;

82 
	gcumv®ue
 = 0;

83 
	gv®ue
 = 0;

84 
	gmšv®ue
 = 
¡d
::
num”ic_lim™s
<>::
max
();

85 
	gmaxv®ue
 = 
¡d
::
num”ic_lim™s
<>::
mš
();

87 
šlše
 
adj
(
v
) {

88 ià(
	gcouÁ
 == 0) {

89 
mšv®ue
 = 
v
;

90 
	gmaxv®ue
 = 
v
;

92 
	gmšv®ue
 = 
¡d
::
mš
(
v
,
mšv®ue
);

93 
	gmaxv®ue
 = 
¡d
::
max
(
v
,
maxv®ue
);

98 
šlše
 
add
(
x
) {

99 
adj
(
x
);

100 
	gv®ue
 +ğ
x
;

101 
	gcumv®ue
 +ğ
x
;

102 ++
	gcouÁ
;

103 ià(
	gv®ty³
 =ğ
VECTOR
) {

104 
v
.
push_back
(
x
);

111 
šlše
 
£t
(
v
) {

112 
adj
(
v
);

113 
	gv®ue
 = 
v
;

114 
	gcumv®ue
 +ğ
v
;

116 
šlše
 
£t
(
¡d
::
¡ršg
 
s
) {

117 
¡ršgv®
 = 
s
;

120 
šlše
 
add_veùÜ_’Œy
(
size_t
 
i
, 
x
) {

121 ià(
	gv
.
size
(è< 
	gi
 + 1èv.
»size
(
i
 + 1);

122 
	gcouÁ
 = 
v
.
size
();

123 
	gv®ue
 +ğ
x
;

124 
	gcumv®ue
 +ğ
x
;

125 
	gv
[
i
] +ğ
x
;

126 
adj
(
v
[
i
]);

129 
šlše
 
£t_veùÜ_’Œy
(
size_t
 
i
, 
x
) {

130 ià(
	gv
.
size
(è< 
	gi
 + 1èv.
»size
(
i
 + 1);

131 
	gcouÁ
 = 
v
.
size
();

132 
	gv®ue
 = 
v®ue
 - 
v
[
i
] + 
x
;

133 
	gcumv®ue
 = 
cumv®ue
 - 
v
[
i
] + 
x
;

134 
	gv
[
i
] = 
x
;

136 
	gmšv®ue
 = 
x
; 
	gmaxv®ue
 = x;

137 
size_t
 
	gi
 = 0; i < 
	gv
.
size
(); ++i) {

138 
adj
(
v
[
i
]);

142 
šlše
 
tim”_¡¬t
() {

143 
g‘timeofday
(&
¡¬t_time
, 
NULL
);

146 
šlše
 
tim”_¡İ
() {

147 
timev®
 
	g’d
;

148 
g‘timeofday
(&
’d
, 
NULL
);

149 
	gÏ¡time
 = 
’d
.
tv_£c
 - 
¡¬t_time
.tv_£ø+ (()Ónd.
tv_u£c
 - start_time.tv_usec)) / 1.0E6;

150 
add
(
Ï¡time
);

154 şas 
	cim‘rics_»pÜ‹r
 {

156 
	gpublic
:

157 
vœtu®
 ~
im‘rics_»pÜ‹r
() {}

158 
vœtu®
 
do_»pÜt
(
¡d
::
¡ršg
 
Çme
, std::¡ršg 
id
, std::
m­
<¡d::¡ršg, 
m‘rics_’Œy
> & 
’Œ›s
) = 0;

165 şas 
	cm‘rics
 {

167 
	g¡d
::
¡ršg
 
Çme
, 
	gid’t
;

168 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gm‘rics_’Œy
> 
	g’Œ›s
;

169 
mu‹x
 
	gmlock
;

171 
	gpublic
:

172 
šlše
 
m‘rics
(
¡d
::
¡ršg
 
_Çme
 = "", std::¡ršg 
_id
 = ""è: 
Çme
(_Çme), 
id’t
 (_id) {

173 
	gthis
->
£t
("­p", 
_Çme
);

176 
šlše
 
ş—r
() {

177 
	g’Œ›s
.
ş—r
();

181 
šlše
 
	g¡d
::
¡ršg
 
™”key
(
¡d
::¡ršg 
key
, 
™”
) {

182 
	gs
[256];

183 
¥rštf
(
s
, "%s.%d", 
key
.
c_¡r
(), 
™”
);

184  
	g¡d
::
¡ršg
(
s
);

190 
šlše
 
add
(
¡d
::
¡ršg
 
key
, 
v®ue
, 
m‘riùy³
 
ty³
 = 
REAL
) {

191 
mlock
.
lock
();

192 ià(
	g’Œ›s
.
couÁ
(
key
) == 0) {

193 
’Œ›s
[
key
] = 
m‘rics_’Œy
(
v®ue
, 
ty³
);

195 
	g’Œ›s
[
key
].
add
(
v®ue
);

197 
	gmlock
.
uÆock
();

200 
šlše
 
add_to_veùÜ
(
¡d
::
¡ršg
 
key
, 
v®ue
) {

201 ià(
	g’Œ›s
.
couÁ
(
key
) == 0) {

202 
’Œ›s
[
key
] = 
m‘rics_’Œy
(
v®ue
, 
VECTOR
);

204 
	g’Œ›s
[
key
].
add
(
v®ue
);

208 
šlše
 
add_veùÜ_’Œy
(
¡d
::
¡ršg
 
key
, 
size_t
 
idx
, 
v®ue
) {

209 ià(
	g’Œ›s
.
couÁ
(
key
) == 0) {

210 
’Œ›s
[
key
] = 
m‘rics_’Œy
(
VECTOR
);

212 
	g’Œ›s
[
key
].
add_veùÜ_’Œy
(
idx
, 
v®ue
);

215 
šlše
 
£t
(
¡d
::
¡ršg
 
key
, 
size_t
 
v®ue
) {

216 
£t
(
key
, ()
v®ue
, 
INTEGER
);

220 
šlše
 
£t
(
¡d
::
¡ršg
 
key
, 
v®ue
) {

221 
£t
(
key
, ()
v®ue
, 
INTEGER
);

224 
šlše
 
£t
(
¡d
::
¡ršg
 
key
, 
v®ue
, 
m‘riùy³
 
ty³
 = 
REAL
) {

225 ià(
’Œ›s
.
couÁ
(
key
) == 0) {

226 
’Œ›s
[
key
] = 
m‘rics_’Œy
(
v®ue
, 
ty³
);

228 
	g’Œ›s
[
key
].
£t
(
v®ue
);

232 
šlše
 
£t_š‹g”
(
¡d
::
¡ršg
 
key
, 
size_t
 
v®ue
) {

233 ià(
	g’Œ›s
.
couÁ
(
key
) == 0) {

234 
’Œ›s
[
key
] = 
m‘rics_’Œy
(()
v®ue
, 
INTEGER
);

236 
	g’Œ›s
[
key
].
£t
(()
v®ue
);

240 
šlše
 
£t
(
¡d
::
¡ršg
 
key
, std::¡ršg 
s
) {

241 ià(
’Œ›s
.
couÁ
(
key
) == 0) {

242 
’Œ›s
[
key
] = 
m‘rics_’Œy
(
s
);

244 
	g’Œ›s
[
key
].
£t
(
s
);

248 
šlše
 
£t_veùÜ_’Œy_š‹g”
(
¡d
::
¡ršg
 
key
, 
size_t
 
idx
, size_ˆ
v®ue
) {

249 
£t_veùÜ_’Œy
(
key
, 
idx
, ()(
v®ue
));

252 
šlše
 
£t_veùÜ_’Œy
(
¡d
::
¡ršg
 
key
, 
size_t
 
idx
, 
v®ue
) {

253 
	gmlock
.
lock
();

255 ià(
	g’Œ›s
.
couÁ
(
key
) == 0) {

256 
’Œ›s
[
key
] = 
m‘rics_’Œy
(
VECTOR
);

258 
	g’Œ›s
[
key
].
£t_veùÜ_’Œy
(
idx
, 
v®ue
);

259 
	gmlock
.
uÆock
();

262 
šlše
 
¡¬t_time
(
¡d
::
¡ršg
 
key
) {

263 
mlock
.
lock
();

265 ià(
	g’Œ›s
.
couÁ
(
key
) == 0) {

266 
’Œ›s
[
key
] = 
m‘rics_’Œy
(
TIME
);

268 
	g’Œ›s
[
key
].
tim”_¡¬t
();

269 
	gmlock
.
uÆock
();

273 
m‘rics_’Œy
 
¡¬t_time
() {

274 
m‘rics_’Œy
 
me
(
TIME
);

275 
	gme
.
tim”_¡¬t
();

276  
	gme
;

281 
šlše
 
¡İ_time
(
m‘rics_’Œy
 
me
, 
¡d
::
¡ršg
 
key
, 
boŞ
 
show
=
çl£
) {

282 
me
.
tim”_¡İ
();

283 
	gmlock
.
lock
();

285 ià(
	g’Œ›s
.
couÁ
(
key
) == 0) {

286 
’Œ›s
[
key
] = 
m‘rics_’Œy
(
TIME
);

288 
	g’Œ›s
[
key
].
add
(
me
.
Ï¡time
);

289 ià(
	gshow
)

290 
	g¡d
::
cout
 << 
key
 << ": " << 
me
.
Ï¡time
 << " secs." << 
¡d
::
’dl
;

291 
	gmlock
.
uÆock
();

295 
šlše
 
¡İ_time
(
m‘rics_’Œy
 
me
, 
¡d
::
¡ršg
 
key
, 
™”num
, 
boŞ
 
show
=
çl£
) {

296 
me
.
tim”_¡İ
();

297 
	gmlock
.
lock
();

299 
	gt
 = 
me
.
Ï¡time
;

300 ià(
	g’Œ›s
.
couÁ
(
key
) == 0) {

301 
’Œ›s
[
key
] = 
m‘rics_’Œy
(
TIME
);

303 
	g’Œ›s
[
key
].
add
(
t
);

304 ià(
	gshow
)

305 
	g¡d
::
cout
 << 
key
 << ": " << 
me
.
Ï¡time
 << " secs." << 
¡d
::
’dl
;

307 
	gs
[256];

308 
¥rštf
(
s
, "%s.%d", 
key
.
c_¡r
(), 
™”num
);

309 
	g¡d
::
¡ršg
 
ikey
(
s
);

310 ià(
	g’Œ›s
.
couÁ
(
ikey
) == 0) {

311 
’Œ›s
[
ikey
] = 
m‘rics_’Œy
(
TIME
);

313 
	g’Œ›s
[
ikey
].
add
(
t
);

315 
	gmlock
.
uÆock
();

320 
šlše
 
¡İ_time
(
¡d
::
¡ršg
 
key
, 
boŞ
 
show
 = 
çl£
) {

321 
’Œ›s
[
key
].
tim”_¡İ
();

322 ià(
	gshow
)

323 
	g¡d
::
cout
 << 
key
 << ": " << 
’Œ›s
[key].
Ï¡time
 << " secs." << 
¡d
::
’dl
;

326 
šlše
 
m‘rics_’Œy
 
g‘
(
¡d
::
¡ršg
 
key
) {

327  
’Œ›s
[
key
];

331 
»pÜt
(
im‘rics_»pÜ‹r
 & 
»pÜ‹r
) {

332 ià(
	gÇme
 != "") {

333 
»pÜ‹r
.
do_»pÜt
(
Çme
, 
id’t
, 
’Œ›s
);

	@metrics/reps/basic_reporter.hpp

32 #iâdeà
GRAPHCHI_BASIC_REPORTER


33 
	#GRAPHCHI_BASIC_REPORTER


	)

35 
	~<io¡»am
>

36 
	~<m­
>

38 
	~"m‘rics/m‘rics.hµ
"

45 
Çme¥aû
 
	gg¿phchi
 {

47 şas 
	cbasic_»pÜ‹r
 : 
public
 
im‘rics_»pÜ‹r
 {

49 
public
:

50 
vœtu®
 ~
basic_»pÜ‹r
() {}

51 
vœtu®
 
do_»pÜt
(
¡d
::
¡ršg
 
Çme
, std::¡ršg 
id’t
, std::
m­
<¡d::¡ršg, 
m‘rics_’Œy
> & 
’Œ›s
) {

53 ià(
	gid’t
 !ğ
Çme
) {

54 
¡d
::
cout
 << std::
’dl
 << " ==ğREPORT FOR " << 
Çme
 << "(" << 
id’t
 << ") ===" << std::endl;

56 
	g¡d
::
cout
 << 
¡d
::
’dl
 << " ==ğREPORT FOR " << 
Çme
 << " ===" << std::endl;

60 
	ground
=0;„ound<4;„ound++) {

61 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gm‘rics_’Œy
>::
™”©Ü
 
™
;

62 
	gc
 = 0;

64 
	g™
 = 
’Œ›s
.
begš
(); iˆ!ğ’Œ›s.
’d
(); ++it) {

65 
m‘rics_’Œy
 
	g’t
 = 
™
->
£cÚd
;

66 
	g’t
.
	gv®ty³
) {

67 
	gREAL
:

68 
INTEGER
:

69 ià(
round
 == 0) {

70 ià(
c
++ =ğ0è
¡d
::
cout
 << "[Num”ic]" << std::
’dl
;

71 
	g¡d
::
cout
 << 
™
->
fœ¡
 << ":\t\t";

72 ià(
	g’t
.
	gcouÁ
 > 1) {

73 
	g¡d
::
cout
 << 
’t
.
v®ue
 << "\t(couÁ: " <<ƒÁ.
couÁ
 << ", mš: " <<ƒÁ.
mšv®ue
 <<

74 ", max: " << 
’t
.
maxv®ue
 << ",‡vg: "

75 << 
’t
.
cumv®ue
/(ëÁ.
couÁ
 << ")" << 
¡d
::
’dl
;

77 
	g¡d
::
cout
 << 
’t
.
v®ue
 << 
¡d
::
’dl
;

81 
	gTIME
:

82 ià(
round
 == 1) {

83 ià(
c
++ =ğ0è
¡d
::
cout
 << "[Timšgs]" << std::
’dl
;

84 
	g¡d
::
cout
 << 
™
->
fœ¡
 << ":\t\t";

85 ià(
	g’t
.
	gcouÁ
>1) {

86 
	g¡d
::
cout
 << 
’t
.
v®ue
 << "s\ˆ(couÁ: " <<ƒÁ.
couÁ
 << ", mš: " <<ƒÁ.
mšv®ue
 <<

87 "s, " << "max: " << 
’t
.
maxv®ue
 << ",‡vg: "

88 << 
’t
.
cumv®ue
/(ëÁ.
couÁ
 << "s)" << 
¡d
::
’dl
;

90 
	g¡d
::
cout
 << 
’t
.
v®ue
 << " s" << 
¡d
::
’dl
;

94 
	gSTRING
:

95 ià(
round
 == 2) {

96 ià(
c
++ =ğ0è
¡d
::
cout
 << "[Oth”]" << std::
’dl
;

97 
	g¡d
::
cout
 << 
™
->
fœ¡
 << ":\t";

98 
	g¡d
::
cout
 << 
’t
.
¡ršgv®
 << 
¡d
::
’dl
;

101 
	gVECTOR
:

102 ià(
round
 == 3) {

103 ià(
c
++ =ğ0è
¡d
::
cout
 << "[Num”ic]" << std::
’dl
;

104 
	g¡d
::
cout
 << 
™
->
fœ¡
 << ":\t\t";

105 ià(
	g’t
.
	gcouÁ
 > 1) {

106 
	g¡d
::
cout
 << 
’t
.
v®ue
 << "\t(couÁ: " <<ƒÁ.
couÁ
 << ", mš: " <<ƒÁ.
mšv®ue
 <<

107 ", max: " << 
’t
.
maxv®ue
 << ",‡vg: "

108 << 
’t
.
cumv®ue
/(ëÁ.
couÁ
 << ")" << 
¡d
::
’dl
;

110 
	g¡d
::
cout
 << 
’t
.
v®ue
 << 
¡d
::
’dl
;

112 
	g¡d
::
cout
 << 
™
->
fœ¡
 << ".values:\t\t";

113 
size_t
 
	gj
=0; j<
	g’t
.
	gv
.
size
(); j++è
	g¡d
::
cout
 << 
’t
.
v
[
j
] << ",";

114 
	g¡d
::
cout
 << 
¡d
::
’dl
;

	@metrics/reps/file_reporter.hpp

30 #iâdeà
DEF_GRAPHCHI_FILE_REPORTER


31 
	#DEF_GRAPHCHI_FILE_REPORTER


	)

33 
	~<f¡»am
>

34 
	~<c¡dio
>

36 
	~"m‘rics/m‘rics.hµ
"

37 
	~"ut/cmdİts.hµ
"

41 
Çme¥aû
 
	gg¿phchi
 {

43 şas 
	cfe_»pÜ‹r
 : 
public
 
im‘rics_»pÜ‹r
 {

44 
´iv©e
:

45 
fe_»pÜ‹r
() {}

47 
¡d
::
¡ršg
 
f’ame
;

48 
FILE
 * 
	gf
;

49 
	gpublic
:

52 
fe_»pÜ‹r
(
¡d
::
¡ršg
 
âame
è: 
f’ame
(fname) {

54 
f
 = 
fİ’
(
âame
.
c_¡r
(), "w");

55 
as£¹
(
f
 !ğ
NULL
);

58 
	gvœtu®
 ~
fe_»pÜ‹r
() {}

60 
vœtu®
 
do_»pÜt
(
¡d
::
¡ršg
 
Çme
, std::¡ršg 
id’t
, std::
m­
<¡d::¡ršg, 
m‘rics_’Œy
> & 
’Œ›s
) {

61 ià(
	gid’t
 !ğ
Çme
) {

62 
årštf
(
f
, "[%s:%s]\n", 
Çme
.
c_¡r
(), 
id’t
.c_str());

64 
årštf
(
f
, "[%s]\n", 
Çme
.
c_¡r
());

66 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gm‘rics_’Œy
>::
™”©Ü
 
™
;

68 
	g™
 = 
’Œ›s
.
begš
(); iˆ!ğ’Œ›s.
’d
(); ++it) {

69 
m‘rics_’Œy
 
	g’t
 = 
™
->
£cÚd
;

70 
	g’t
.
	gv®ty³
) {

71 
	gINTEGER
:

73 
årštf
(
f
, "%s.%s=%ld\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), (è(
’t
.
v®ue
));

74 
årštf
(
f
, "%s.%s.couÁ=%lu\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), 
’t
.
couÁ
);

75 
årštf
(
f
, "%s.%s.mš=%ld\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), (è(
’t
.
mšv®ue
));

76 
årštf
(
f
, "%s.%s.max=%ld\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), (è(
’t
.
maxv®ue
));

77 
årštf
(
f
, "%s.%s.avg=%lf\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), 
’t
.
cumv®ue
/’t.
couÁ
);

79 
	gREAL
:

80 
TIME
:

81 
årštf
(
f
, "%s.%s=%lf\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), (
’t
.
v®ue
));

82 
årštf
(
f
, "%s.%s.couÁ=%lu\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), 
’t
.
couÁ
);

83 
årštf
(
f
, "%s.%s.mš=%lf\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), (
’t
.
mšv®ue
));

84 
årštf
(
f
, "%s.%s.max=%lf\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), (
’t
.
maxv®ue
));

85 
årštf
(
f
, "%s.%s.avg=%lf\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), 
’t
.
cumv®ue
/’t.
couÁ
);

87 
	gSTRING
:

88 
årštf
(
f
, "%s.%s=%s\n", 
id’t
.
c_¡r
(), 
™
->
fœ¡
.c_¡r(), it->
£cÚd
.
¡ršgv®
.c_str());

90 
	gVECTOR
:

95 
fæush
(
f
);

96 
fşo£
(
f
);

99 ià(
g‘_İtiÚ_št
("metrics.insert_to_db", 0) == 1) {

100 
¡d
::
¡ršg
 
cmd
 = "pythÚ2.7 b’chtodb.py " + 
f’ame
;

101 
	g”r
 = 
sy¡em
(
cmd
.
c_¡r
());

102 ià(
	g”r
 != 0) {

103 
¡d
::
cout
 << "E¼Ü„uÂšghpythÚ süt." << std::
’dl
;

	@metrics/reps/html_reporter.hpp

31 #iâdeà
GRAPHCHI_HTML_REPORTER


32 
	#GRAPHCHI_HTML_REPORTER


	)

34 
	~<c¡dio
>

36 
	~"m‘rics/m‘rics.hµ
"

43 
Çme¥aû
 
	gg¿phchi
 {

45 şas 
	chtml_»pÜ‹r
 : 
public
 
im‘rics_»pÜ‹r
 {

46 
´iv©e
:

47 
html_»pÜ‹r
() {}

49 
¡d
::
¡ršg
 
f’ame
;

50 
FILE
 * 
	gf
;

51 
	gpublic
:

54 
html_»pÜ‹r
(
¡d
::
¡ršg
 
âame
è: 
f’ame
(fname) {

56 
f
 = 
fİ’
(
âame
.
c_¡r
(), "w");

57 
as£¹
(
f
 !ğ
NULL
);

58 
årštf
(
f
, "<html><head><title>GraphCHI Metrics Report</title>");

59 
årštf
(
f
, "<style>\n");

60 
årštf
(
f
, "table { border: 1px solid #999999; font:‚ormal 80%%/140%%‡rial, helvetica, sans-serif; color: #555; background: #fff;}d,h {border: 1px dotted #bbb;…adding: .5em; width:100px} ");

61 
årštf
(
f
, "</style></head><body>");

64 
	gvœtu®
 ~
html_»pÜ‹r
() {

65 
årštf
(
f
, "</body></html>");

66 
fşo£
(
f
);

69 
vœtu®
 
do_»pÜt
(
¡d
::
¡ršg
 
Çme
, std::¡ršg 
id’t
, std::
m­
<¡d::¡ršg, 
m‘rics_’Œy
> & 
’Œ›s
) {

70 ià(
	gid’t
 !ğ
Çme
) {

71 
årštf
(
f
, "<h3>%s:%s</h3>\n", 
Çme
.
c_¡r
(), 
id’t
.c_str());

73 
årštf
(
f
, "<h3>%s</h3>\n", 
Çme
.
c_¡r
());

78 
	ground
=0;„ound<4;„ound++) {

79 
	g¡d
::
m­
<
¡d
::
¡ršg
, 
	gm‘rics_’Œy
>::
™”©Ü
 
™
;

80 
	gc
 = 0;

81 
årštf
(
f
, "<!-- Round %d -->\n", 
round
);

82 
årštf
(
f
, "\n<p>");

83 
	g™
 = 
’Œ›s
.
begš
(); iˆ!ğ’Œ›s.
’d
(); ++it) {

84 
m‘rics_’Œy
 
	g’t
 = 
™
->
£cÚd
;

85 
	g’t
.
	gv®ty³
) {

86 
	gINTEGER
:

87 ià(
round
 == 0) {

88 ià(
c
++ == 0)

89 
årštf
(
f
, "<table><tr><th>Key</th><th>Value</th><th>Count</th><th>Min</th><th>Max</th><th>Average</th></tr>");

91 
årštf
(
f
, "<Œ><td>%s</td>\n", 
™
->
fœ¡
.
c_¡r
());

93 
årštf
(
f
, "<td>%ld</td>\n", (è
’t
.
v®ue
);

94 ià(
	g’t
.
	gcouÁ
 > 1) {

95 
årštf
(
f
, "<td>%ld</td>\n", (è
’t
.
couÁ
);

96 
årštf
(
f
, "<td>%ld</td>\n", (è
’t
.
mšv®ue
);

97 
årštf
(
f
, "<td>%ld</td>\n", (è
’t
.
maxv®ue
);

98 
årštf
(
f
, "<td>%.3lf</td>\n", 
’t
.
cumv®ue
/(ëÁ.
couÁ
);

99 } 
årštf
(
f
, "<td colspan=4>&nbsp;</td>");

100 
årštf
(
f
, "</tr>");

103 
	gREAL
:

104 ià(
round
 == 0) {

105 ià(
c
++ == 0)

106 
årštf
(
f
, "<table><tr><th>Key</th><th>Value</th><th>Count</th><th>Min</th><th>Max</th><th>Average</th></tr>");

108 
	gTIME
:

109 ià(
’t
.
v®ty³
 =ğ
TIME
 && 
round
 == 1) {

110 ià(
c
++ == 0)

111 
årštf
(
f
, "<table><tr><th>Key</th><th>Value (sec)</th><th>Count</th><th>Min (sec)</th><th>Max (sec)</th><th>Average (sec)</th></tr>\n");

113 ià((
	ground
 =ğ0 && 
’t
.
v®ty³
 =ğ
REAL
)||(
round
 =ğ1 &&ƒÁ.v®ty³ =ğ
TIME
)) {

114 
årštf
(
f
, "<Œ><td>%s</td>\n", 
™
->
fœ¡
.
c_¡r
());

116 
årštf
(
f
, "<td>%lf</td>\n", 
’t
.
v®ue
);

117 ià(
	g’t
.
	gcouÁ
 > 1) {

118 
årštf
(
f
, "<td>%ld</td>\n", (è
’t
.
couÁ
);

119 
årštf
(
f
, "<td>%.3lf</td>\n", 
’t
.
mšv®ue
);

120 
årštf
(
f
, "<td>%.3lf</td>\n", 
’t
.
maxv®ue
);

121 
årštf
(
f
, "<td>%.3lf</td>\n", 
’t
.
cumv®ue
/(ëÁ.
couÁ
);

122 } 
årštf
(
f
, "<td colspan=4>&nbsp;</td>");

123 
årštf
(
f
, "</tr>");

126 
	gSTRING
:

127 ià(
round
 == 2) {

128 ià(
c
++ == 0)

129 
årštf
(
f
, "<table><tr><th>Key</th><th>Value</th></tr>\n");

130 
årštf
(
f
, "<Œ><td>%s</td><td width=400>%s</td>\n", 
™
->
fœ¡
.
c_¡r
(), 
’t
.
¡ršgv®
.c_str());

131 
årštf
(
f
, "</tr>");

135 
	gVECTOR
:

136 ià(
round
 == 3) {

142 ià(
	gc
>0è
årštf
(
f
, "</table>");

143 
årštf
(
f
, " </p>");

146 
fæush
(
f
);

	@metrics/reps/null_reporter.hpp

28 #iâdeà
GRAPHLAB_NULL_REPORTER


29 
	#GRAPHLAB_NULL_REPORTER


	)

31 
	~"m‘rics/m‘rics.hµ
"

38 
Çme¥aû
 
	gg¿phchi
 {

40 şas 
	cnuÎ_»pÜ‹r
 : 
public
 
im‘rics_»pÜ‹r
 {

42 
public
:

43 
vœtu®
 ~
nuÎ_»pÜ‹r
();

44 
vœtu®
 
do_»pÜt
(
¡d
::
¡ršg
 
Çme
, std::¡ršg 
id’t
, std::
m­
<¡d::¡ršg, 
m‘rics_’Œy
> & 
’Œ›s
) {

	@output/output.hpp

30 #iâdeà
DEF_OUTPUT_HPP


31 
	#DEF_OUTPUT_HPP


	)

33 
	~"g¿phchi_ty³s.hµ
"

34 
	~"ut/±h»ad_toŞs.hµ
"

35 
	~<f¡»am
>

37 
Çme¥aû
 
	gg¿phchi
 {

39 
	g‹m¶©e
 <
ty³Çme
 
	gVT
,y³Çm
	gET
>

40 şas 
	ciouut
{

42 
	gpublic
:

43 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
) = 0;

47 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
v®ue
) = 0;

49 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
v®ue
) = 0;

51 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
v®ue
) = 0;

53 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
size_t
 
v®ue
) = 0;

57 
vœtu®
 
ouut_v®ue
(
vid_t
 
vid
, 
VT
 
v®ue
) = 0;

61 
vœtu®
 
şo£
() = 0;

66 
	g‹m¶©e
 <
ty³Çme
 
	gVT
,y³Çm
	gET
>

67 
şass
 
	gbasic_‹xt_ouut
 : 
public
 
iouut
<
VT
, 
	gET
> {

69 
	g¡d
::
of¡»am
 
¡rm
;

70 
	g¡d
::
¡ršg
 
d–im™”
;

71 
mu‹x
 
	glock
;

73 
	gpublic
:

75 
basic_‹xt_ouut
(
¡d
::
¡ršg
 
f’ame
, std::¡ršg 
d–im™”
="\t"è: 
¡rm
(f’ame.
c_¡r
(),¡d::
of¡»am
::
out
),

76 
d–im™”
(delimiter) {

79 ~
basic_‹xt_ouut
() {

80 
	g¡rm
.
şo£
();

84 
	g´Ùeùed
:

85 
‹m¶©e
 <
ty³Çme
 
T
>

86 
_ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
T
 
v®
) {

87 
	glock
.
lock
();

88 
	g¡rm
 << 
	gäom
 << 
	gd–im™”
 << 
	gto
 << d–im™” << 
	gv®
 << "\n";

89 
	glock
.
uÆock
();

92 
	gpublic
:

93 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
) {

94 
	glock
.
lock
();

95 
	g¡rm
 << 
	gäom
 << 
	gd–im™”
 << 
	gto
 << "\n";

96 
	glock
.
uÆock
();

102 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
v®ue
) {

103 
_ouut_edge
(
äom
, 
to
, 
v®ue
);

106 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
v®ue
) {

107 
_ouut_edge
(
äom
, 
to
, 
v®ue
);

111 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
v®ue
) {

112 
_ouut_edge
(
äom
, 
to
, 
v®ue
);

115 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
size_t
 
v®ue
) {

116 
_ouut_edge
(
äom
, 
to
, 
v®ue
);

119 
ouut_edgev®
(
vid_t
 
äom
, vid_ˆ
to
, 
ET
 
v®ue
) {

120 
as£¹
(
çl£
);

124 
ouut_v®ue
(
vid_t
 
vid
, 
VT
 
v®ue
) {

125 
	glock
.
lock
();

126 
	g¡rm
 << 
	gvid
 << 
	gd–im™”
 << 
	gv®ue
 << "\n";

127 
	glock
.
uÆock
();

132 
şo£
() {

133 
	g¡rm
.
şo£
();

	@preprocessing/blocksplitter.cpp

28 
	~<io¡»am
>

29 
	~<¡dlib.h
>

30 
	~<¡ršg
>

31 
	~<as£¹.h
>

32 
	~<uni¡d.h
>

33 
	~<f¡»am
>

34 
	~<sys/¡©.h
>

36 
	~"­i/chif’ames.hµ
"

37 
	~"io/¡redio.hµ
"

38 
	~"logg”/logg”.hµ
"

39 
	~"ut/iout.hµ
"

40 
	~"ut/cmdİts.hµ
"

41 
	~"´•roûssšg/cÚv”siÚs.hµ
"

42 
	~"´•roûssšg/sh¬d”.hµ
"

44 
usšg
 
Çme¥aû
 
	gg¿phchi
;

47 
	tEdgeD©aTy³
;

49 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

50 
	`g¿phchi_š™
(
¬gc
, 
¬gv
);

52 
	`glob®_logg”
().
	`£t_log_Ëv–
(
LOG_DEBUG
);

55 
¡d
::
¡ršg
 
f’ame
 = 
	`g‘_İtiÚ_¡ršg
("file");

56 
nsh¬ds
 = 
cÚv”t_if_nÙexi¡s
<
EdgeD©aTy³
>(
f’ame
, 
	`g‘_İtiÚ_¡ršg
("nshards", "auto"));

57 
size_t
 
blocksize
ğ
	`g‘_İtiÚ_lÚg
("blocksize", 1024 * 1024);

59 * 
buf
 = (*è
	`m®loc
(
blocksize
);

60 
p
=0;… < 
nsh¬ds
;…++) {

61 
¡d
::
¡ršg
 
sh¬d_f’ame
 = 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
f’ame
, 
p
, 
nsh¬ds
);

62 
f
 = 
	`İ’
(
sh¬d_f’ame
.
	`c_¡r
(), 
O_RDONLY
);

63 
size_t
 
fsize
 = 
	`g‘_fesize
(
sh¬d_f’ame
);

65 
size_t
 
nblocks
 = 
fsize
 / 
blocksize
 + (fsize % blocksize != 0);

66 
size_t
 
idx
 = 0;

67 
¡d
::
¡ršg
 
block_dœÇme
 = 
	`dœÇme_sh¬d_ed©a_block
(
sh¬d_f’ame
, 
blocksize
);

68 
	`log¡»am
(
LOG_INFO
è<< "GošgØü—‹: " << 
block_dœÇme
 << 
¡d
::
’dl
;

69 
”r
 = 
	`mkdœ
(
block_dœÇme
.
	`c_¡r
(), 0777);

70 ià(
”r
 != 0) {

71 
	`log¡»am
(
LOG_ERROR
è<< 
	`¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

74 
i
=0; i < 
nblocks
; i++) {

75 
size_t
 
Ën
 = 
¡d
::
	`mš
(
blocksize
, 
fsize
 - 
idx
);

76 
	`´—da
(
f
, 
buf
, 
Ën
, 
idx
);

78 
¡d
::
¡ršg
 
block_f’ame
 = 
	`f’ame_sh¬d_ed©a_block
(
sh¬d_f’ame
, 
i
, 
blocksize
);

79 
bf
 = 
	`İ’
(
block_f’ame
.
	`c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

80 
	`wr™e_com´es£d
(
bf
, 
buf
, 
Ën
);

81 
	`şo£
(
bf
);

83 
idx
 +ğ
blocksize
;

85 
	`şo£
(
f
);

87 
¡d
::
¡ršg
 
sizef’ame
 = 
sh¬d_f’ame
 + ".size";

88 
¡d
::
of¡»am
 
	`ofs
(
sizef’ame
.
	`c_¡r
());

89 
ofs
 << 
fsize
;

90 
ofs
.
	`şo£
();

92 
	}
}

	@preprocessing/conversions.hpp

28 #iâdeà
GRAPHCHI_CONVERSIONS_DEF


29 
	#GRAPHCHI_CONVERSIONS_DEF


	)

31 
	~<fú.h
>

32 
	~<uni¡d.h
>

33 
	~<sys/ty³s.h
>

34 
	~<dœ’t.h
>

35 
	~<sys/¡©.h
>

37 
	~<f¡»am
>

38 
	~<io¡»am
>

42 
	~"g¿phchi_ty³s.hµ
"

43 
	~"logg”/logg”.hµ
"

44 
	~"´•roûssšg/sh¬d”.hµ
"

50 #ifdeà
__GNUC__


51 
	#VARIABLE_IS_NOT_USED
 
	`__©Œibu‹__
 ((
unu£d
))

	)

53 
	#VARIABLE_IS_NOT_USED


	)

56 
Çme¥aû
 
	gg¿phchi
 {

58 
	sdummy
 {

61 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

62 
	sdummyC
 {

63 
İ”©Ü
 
T
() {  T(); }

67 
VARIABLE_IS_NOT_USED
 
·r£
(&
x
, cÚ¡ * 
s
);

68 
VARIABLE_IS_NOT_USED
 
·r£
(&
x
, cÚ¡ * 
s
);

69 
VARIABLE_IS_NOT_USED
 
·r£
(&
x
, cÚ¡ * 
s
);

70 
VARIABLE_IS_NOT_USED
 
·r£
(&
x
, cÚ¡ * 
s
);

71 
VARIABLE_IS_NOT_USED
 
·r£
(&
x
, cÚ¡ * 
s
);

72 
VARIABLE_IS_NOT_USED
 
·r£
(
boŞ
 &
x
, cÚ¡ * 
s
);

73 
VARIABLE_IS_NOT_USED
 
·r£
(&
x
, cÚ¡ * 
s
);

74 
VARIABLE_IS_NOT_USED
 
·r£
(&
x
, cÚ¡ * 
s
);

75 
FIXLINE
(* 
s
);

77 
·r£
(&
x
, cÚ¡ * 
s
) {

78 
	gx
 = 
©oi
(
s
);

81 
·r£
(&
x
, cÚ¡ * 
s
) {

82 
	gx
 = (è
¡¹oul
(
s
, 
NULL
, 10);

85 
·r£
(&
x
, cÚ¡ * 
s
) {

86 
	gx
 = (è
©of
(
s
);

89 
·r£
(
dummy
 &
x
, cÚ¡ *
s
) {}

95 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

96 
·r£
(
PaœCÚš”
<
T
> &
x
, cÚ¡ * 
s
) {

97 
·r£
(
x
.
Ëá
, 
s
);

98 
·r£
(
x
.
right
, 
s
);

101 
·r£
(&
x
, cÚ¡ * 
s
) {

102 
	gx
 = 
©Ş
(
s
);

105 
·r£
(&
x
, cÚ¡ * 
s
) {

106 
	gx
 = 
s
[0];

109 
·r£
(
boŞ
 &
x
, cÚ¡ * 
s
) {

110 
	gx
 = 
©oi
(
s
) == 1;

113 
·r£
(&
x
, cÚ¡ * 
s
) {

114 
	gx
 = 
©of
(
s
);

117 
·r£
(&
x
, cÚ¡ * 
s
) {

118 
	gx
 = (è
©oi
(
s
);

121 #ifdeà
DYNAMICEDATA


122 
VARIABLE_IS_NOT_USED
 
·r£_muÉË
(
¡d
::
veùÜ
<
dummy
> &
v®ues
, * 
s
);

123 
VARIABLE_IS_NOT_USED
 
·r£_muÉË
(
¡d
::
veùÜ
<
dummy
> & 
v®ues
, * 
s
) {

124 
as£¹
(
çl£
);

130 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

131 
·r£_muÉË
(
ty³Çme
 
¡d
::
veùÜ
<
T
> & 
v®ues
, * 
s
) {

132 
	gd–ims
[] = ":";

133 * 
	gt
;

134 
	gt
 = 
¡¹ok
(
s
, 
d–ims
);

135 
T
 
	gx
;

136 
·r£
(
x
, (cÚ¡ *è
t
);

137 
	gv®ues
.
push_back
(
x
);

138 (
	gt
 = 
¡¹ok
(
NULL
, 
d–ims
)) != NULL) {

139 
·r£
(
x
, (cÚ¡ *è
t
);

140 
	gv®ues
.
push_back
(
x
);

148 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

149 
·r£
(
T
 &
x
, cÚ¡ * 
s
) {

150 
log¡»am
(
LOG_FATAL
) << "You‚eedo define…arse<your-type>(your-type &x, const char *s) function"

151 << "ØsuµÜˆ·rsšghedgv®ue." << 
	g¡d
::
’dl
;

152 
as£¹
(
çl£
);

158 
šlše
 
FIXLINE
(* 
s
) {

159 
	gËn
 = (è
¡¾’
(
s
)-1;

160 if(
	gs
[
Ën
] =ğ'\n'è
s
[len] = 0;

165 
VARIABLE_IS_NOT_USED
 
g‘dœ
 (
¡d
::
¡ršg
 
dœ
, std::
veùÜ
<¡d::¡ršg> &
fes
);

166 
VARIABLE_IS_NOT_USED
 
g‘dœ
 (
¡d
::
¡ršg
 
dœ
, std::
veùÜ
<¡d::¡ršg> &
fes
)

168 
DIR
 *
dp
;

169 
dœ’t
 *
	gdœp
;

170 if((
	gdp
 = 
İ’dœ
(
dœ
.
c_¡r
())è=ğ
NULL
) {

171 
¡d
::
cout
 << "E¼Ü(" << 
”ºo
 << "èİ’šg " << 
dœ
 << std::
’dl
;

172  
	g”ºo
;

175 (
	gdœp
 = 
»addœ
(
dp
)è!ğ
NULL
) {

176 
fes
.
push_back
(
¡d
::
¡ršg
(
dœp
->
d_Çme
));

178 
şo£dœ
(
dp
);

182 
VARIABLE_IS_NOT_USED
 
	g¡d
::
¡ršg
 
g‘_dœÇme
(
¡d
::¡ršg 
¬g
);

183 
VARIABLE_IS_NOT_USED
 
	g¡d
::
¡ršg
 
g‘_dœÇme
(
¡d
::¡ršg 
¬g
) {

184 
size_t
 
a
 = 
¬g
.
fšd_Ï¡_of
("/");

185 ià(
	ga
 !ğ
¬g
.
Åos
) {

186 
¡d
::
¡ršg
 
dœ
 = 
¬g
.
sub¡r
(0, 
a
);

187  
	gdœ
;

189 
as£¹
(
çl£
);

194 
	g¡d
::
¡ršg
 
VARIABLE_IS_NOT_USED
 
g‘_f’ame
(
¡d
::¡ršg 
¬g
);

195 
	g¡d
::
¡ršg
 
VARIABLE_IS_NOT_USED
 
g‘_f’ame
(
¡d
::¡ršg 
¬g
) {

196 
size_t
 
a
 = 
¬g
.
fšd_Ï¡_of
("/");

197 ià(
	ga
 !ğ
¬g
.
Åos
) {

198 
¡d
::
¡ršg
 
f
 = 
¬g
.
sub¡r
(
a
 + 1);

199  
	gf
;

201 
as£¹
(
çl£
);

210 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
,y³Çm
	gFš®EdgeD©aTy³
>

211 
cÚv”t_edg–i¡
(
¡d
::
¡ršg
 
šputfe
, 
sh¬d”
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
> &
sh¬d”obj
, 
boŞ
 
muÉiv®ue_edges
=
çl£
) {

213 
FILE
 * 
šf
 = 
fİ’
(
šputfe
.
c_¡r
(), "r");

214 
size_t
 
	gby‹¤—d
 = 0;

215 
size_t
 
	glš’um
 = 0;

216 ià(
	gšf
 =ğ
NULL
) {

217 
log¡»am
(
LOG_FATAL
è<< "Could‚Ù†ßd :" << 
šputfe
 << "ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

219 
as£¹
(
šf
 !ğ
NULL
);

221 
log¡»am
(
LOG_INFO
è<< "R—dšg iÀedgli¡ fÜm©!" << 
	g¡d
::
’dl
;

222 
	gs
[1024];

223 
fg‘s
(
s
, 1024, 
šf
è!ğ
NULL
) {

224 
lš’um
++;

225 ià(
	glš’um
 % 10000000 == 0) {

226 
log¡»am
(
LOG_DEBUG
è<< "R—d " << 
lš’um
 << "†šes, " << 
by‹¤—d
 / 1024 / 1024. << " MB" << 
¡d
::
’dl
;

228 
FIXLINE
(
s
);

229 
	gby‹¤—d
 +ğ
¡¾’
(
s
);

230 ià(
	gs
[0] == '#') ;

231 ià(
	gs
[0] == '%') ;

233 
	gd–ims
[] = "\t, ";

234 * 
	gt
;

235 
	gt
 = 
¡¹ok
(
s
, 
d–ims
);

236 ià(
	gt
 =ğ
NULL
) {

237 
log¡»am
(
LOG_ERROR
) << "Input file is‚ot in„ight format. "

239 << "Cu¼’ˆlše: \"" << 
s
 << "\"\n";

240 
as£¹
(
çl£
);

242 
vid_t
 
	gäom
 = 
©oi
(
t
);

243 
	gt
 = 
¡¹ok
(
NULL
, 
d–ims
);

244 ià(
	gt
 =ğ
NULL
) {

245 
log¡»am
(
LOG_ERROR
) << "Input file is‚ot in„ight format. "

247 << "Cu¼’ˆlše: \"" << 
s
 << "\"\n";

248 
as£¹
(
çl£
);

250 
vid_t
 
	gto
 = 
©oi
(
t
);

253 
	gt
 = 
¡¹ok
(
NULL
, 
d–ims
);

255 ià(!
	gmuÉiv®ue_edges
) {

256 
EdgeD©aTy³
 
	gv®
;

257 ià(
	gt
 !ğ
NULL
) {

258 
·r£
(
v®
, (cÚ¡ *è
t
);

260 ià(
	gäom
 !ğ
to
) {

261 ià(
t
 !ğ
NULL
) {

262 
sh¬d”obj
.
´•roûssšg_add_edge
(
äom
, 
to
, 
v®
);

264 
	gsh¬d”obj
.
´•roûssšg_add_edge
(
äom
, 
to
);

268 #ifdeà
DYNAMICEDATA


269 
	g¡d
::
veùÜ
<
EdgeD©aTy³
> 
v®s
;

271 
·r£_muÉË
(
v®s
, (*è
t
);

272 ià(
	gäom
 !ğ
to
) {

273 ià(
v®s
.
size
() == 0) {

275 
log¡»am
(
LOG_FATAL
è<< "EachƒdgÃed ©†—¡ oÃ v®ue." << 
¡d
::
’dl
;

276 
as£¹
(
v®s
.
size
() > 0);

278 
	gsh¬d”obj
.
´•roûssšg_add_edge_muÉiv®
(
äom
, 
to
, 
v®s
);

282 
log¡»am
(
LOG_FATAL
è<< "TØsuµÜˆmuÉiv®ue-edges, dyÇmiøedgd©¨Ãed tØbu£d." << 
	g¡d
::
’dl
;

283 
as£¹
(
çl£
);

287 
fşo£
(
šf
);

296 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
,y³Çm
	gFš®EdgeD©aTy³
>

297 
cÚv”t_adjli¡
(
¡d
::
¡ršg
 
šputfe
, 
sh¬d”
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
> &
sh¬d”obj
) {

298 
FILE
 * 
	gšf
 = 
fİ’
(
šputfe
.
c_¡r
(), "r");

299 ià(
	gšf
 =ğ
NULL
) {

300 
log¡»am
(
LOG_FATAL
è<< "Could‚Ù†ßd :" << 
šputfe
 << "ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

302 
as£¹
(
šf
 !ğ
NULL
);

303 
log¡»am
(
LOG_INFO
è<< "R—dšg iÀadjaûncy†i¡ fÜm©!" << 
	g¡d
::
’dl
;

305 
	gmaxËn
 = 100000000;

306 * 
	gs
 = (*è
m®loc
(
maxËn
);

308 
size_t
 
	gby‹¤—d
 = 0;

310 
	gd–ims
[] = " \t";

311 
size_t
 
	glš’um
 = 0;

312 
size_t
 
	gÏ¡log
 = 0;

314 
fg‘s
(
s
, 
maxËn
, 
šf
è!ğ
NULL
) {

315 
lš’um
++;

316 ià(
	gby‹¤—d
 - 
	gÏ¡log
 >= 500000000) {

317 
log¡»am
(
LOG_DEBUG
è<< "R—d " << 
lš’um
 << "†šes, " << 
by‹¤—d
 / 1024 / 1024. << " MB" << 
¡d
::
’dl
;

318 
	gÏ¡log
 = 
by‹¤—d
;

320 
FIXLINE
(
s
);

321 
	gby‹¤—d
 +ğ
¡¾’
(
s
);

323 ià(
	gs
[0] == '#') ;

324 ià(
	gs
[0] == '%') ;

325 * 
	gt
 = 
¡¹ok
(
s
, 
d–ims
);

326 
vid_t
 
	gäom
 = 
©oi
(
t
);

327 
	gt
 = 
¡¹ok
(
NULL
,
d–ims
);

328 ià(
	gt
 !ğ
NULL
) {

329 
vid_t
 
num
 = 
©oi
(
t
);

330 
vid_t
 
	gi
 = 0;

331 (
	gt
 = 
¡¹ok
(
NULL
,
d–ims
)) != NULL) {

332 
vid_t
 
to
 = 
©oi
(
t
);

333 ià(
	gäom
 !ğ
to
) {

334 
sh¬d”obj
.
´•roûssšg_add_edge
(
äom
, 
to
, 
EdgeD©aTy³
());

336 
	gi
++;

338 ià(
	gnum
 !ğ
i
) {

339 
log¡»am
(
LOG_ERROR
è<< "Mism©ch wh’„—dšg‡djaûncy†i¡: " << 
num
 << " !ğ" << 
i
 << " s: " << 
¡d
::
¡ršg
(
s
)

340 << " oÀlše: " << 
lš’um
 << 
¡d
::
’dl
;

345 
ä“
(
s
);

346 
fşo£
(
šf
);

356 
	g¡d
::
veùÜ
<
vid_t
> 
VARIABLE_IS_NOT_USED
 
·r£Lše
(
¡d
::
¡ršg
 
lše
);

357 
	g¡d
::
veùÜ
<
vid_t
> 
VARIABLE_IS_NOT_USED
 
·r£Lše
(
¡d
::
¡ršg
 
lše
) {

359 
¡d
::
¡ršg¡»am
 
¡»am
(
lše
);

360 
	g¡d
::
¡ršg
 
tok’
;

361 
	gd–im
 = ' ';

362 
	g¡d
::
veùÜ
<
vid_t
> 
adjaûnc›s
;

365 
	g¡d
::
g‘lše
(
¡»am
, 
tok’
, 
d–im
)) {

366 ià(
	gtok’
.
size
() != 0) {

367 
vid_t
 
v
 = 
©oi
(
tok’
.
c_¡r
());

368 
	gadjaûnc›s
.
push_back
(
v
);

372  
	gadjaûnc›s
;

380 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
,y³Çm
	gFš®EdgeD©aTy³
>

381 
cÚv”t_m‘is
(
¡d
::
¡ršg
 
šputP©h
, 
sh¬d”
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
> &
sh¬d”obj
) {

383 
	g¡d
::
cout
 << "[INFO]„—dšg METIS g¿ph fe" << 
¡d
::
’dl
;

385 
	g¡d
::
if¡»am
 
g¿phFe
(
šputP©h
.
c_¡r
());

387 ià(! 
	gg¿phFe
.
good
()) {

388 
log¡»am
(
LOG_FATAL
è<< "Could‚Ù†ßd :" << 
	gšputP©h
 << "ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
	g¡d
::
’dl
;

391 
	g¡d
::
¡ršg
 
lše
;

394 
	gn
 = 0;

395 
	gm
 = 0;

396 
	gweigh‹d
;

398 ià(
	g¡d
::
g‘lše
(
g¿phFe
, 
lše
)) {

399 
	glše
[0] == '%') {

400 
¡d
::
g‘lše
(
g¿phFe
, 
lše
);

403 
	g¡d
::
veùÜ
<
ušt
> 
tok’s
 = 
·r£Lše
(
lše
);

404 
	gn
 = 
tok’s
[0];

405 
	gm
 = 
tok’s
[1];

406 ià(
	gtok’s
.
size
() == 2) {

407 
weigh‹d
 = 0;

408 } ià(
	gtok’s
.
size
() == 3) {

409 
weigh‹d
 = 
tok’s
[2];

410 ià(
	gweigh‹d
 != 0) {

411 
log¡»am
(
LOG_FATAL
è<< "nodªdƒdgweight cu¼’y‚Ù suµÜ‹d by…¬£r" << 
¡d
::
’dl
;

415 
log¡»am
(
LOG_FATAL
è<< "g‘tšg METIS fh—d” faed" << 
	g¡d
::
’dl
;

418 
log¡»am
(
LOG_INFO
è<< "»adšg g¿ph w™h‚=" << 
	gn
 << ", m=" << 
	gm
 << 
	g¡d
::
’dl
;

420 
vid_t
 
	gu
 = 0;

423 
	gg¿phFe
.
good
()) {

425 
	g¡d
::
g‘lše
(
g¿phFe
, 
lše
);

426 } 
	glše
[0] == '%');

429 
	g¡d
::
veùÜ
<
vid_t
> 
adjaûnc›s
 = 
·r£Lše
(
lše
);

430 
	g¡d
::
veùÜ
<
vid_t
>::
™”©Ü
 
™
=
adjaûnc›s
.
begš
(); 
	g™
 !ğadjaûnc›s.
’d
(); ++it) {

431 
vid_t
 
	gv
 = *
™
;

432 ià(
	gu
 <ğ
v
) {

433 
sh¬d”obj
.
´•roûssšg_add_edge
(
u
, 
v
, 
EdgeD©aTy³
());

437 
	gu
++;

446 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
,y³Çm
	gFš®EdgeD©aTy³
>

447 
cÚv”t_ÿssov¬y
(
¡d
::
¡ršg
 
ba£f’ame
, 
sh¬d”
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
> &
sh¬d”obj
) {

448 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
·¹s
;

449 
	g¡d
::
¡ršg
 
dœÇme
 = 
g‘_dœÇme
(
ba£f’ame
);

450 
	g¡d
::
¡ršg
 
´efix
 = 
g‘_f’ame
(
ba£f’ame
);

452 
	g¡d
::
cout
 << "dœ=[" << 
dœÇme
 << "]…»fix=[" << 
´efix
 << "]" << 
¡d
::
’dl
;

453 
g‘dœ
(
dœÇme
, 
·¹s
);

455 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>::
™”©Ü
 
™
=
·¹s
.
begš
(); 
	g™
 !ğ·¹s.
’d
(); ++it) {

456 
	g¡d
::
¡ršg
 
šputfe
 = *
™
;

457 ià(
	gšputfe
.
fšd
(
´efix
è=ğ0 && 
šputfe
.fšd("tmp"è=ğšputfe.
Åos
) {

458 
¡d
::
cout
 << "GošgØ´oûss: " << 
šputfe
 << std::
’dl
;

462 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>::
™”©Ü
 
™
=
·¹s
.
begš
(); 
	g™
 !ğ·¹s.
’d
(); ++it) {

463 
	g¡d
::
¡ršg
 
šputfe
 = *
™
;

464 ià(
	gšputfe
.
fšd
(
´efix
è=ğ0 && 
šputfe
.fšd(".tmp"è=ğšputfe.
Åos
) {

465 
šputfe
 = 
dœÇme
 + "/" + inputfile;

466 
	g¡d
::
cout
 << "Proûss: " << 
šputfe
 << 
¡d
::
’dl
;

467 
FILE
 * 
	gšf
 = 
fİ’
(
šputfe
.
c_¡r
(), "r");

468 ià(
	gšf
 =ğ
NULL
) {

469 
log¡»am
(
LOG_FATAL
è<< "Could‚Ù†ßd :" << 
šputfe
 << "ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

471 
as£¹
(
šf
 !ğ
NULL
);

472 
log¡»am
(
LOG_INFO
è<< "R—dšg iÀÿssov¬y fÜm©!" << 
	g¡d
::
’dl
;

474 
	gmaxËn
 = 100000000;

475 * 
	gs
 = (*è
m®loc
(
maxËn
);

477 
size_t
 
	gby‹¤—d
 = 0;

479 
	gd–ims
[] = " \t";

480 
size_t
 
	glš’um
 = 0;

481 
size_t
 
	gÏ¡log
 = 0;

482 
fg‘s
(
s
, 
maxËn
, 
šf
è!ğ
NULL
) {

483 
lš’um
++;

484 ià(
	gby‹¤—d
 - 
	gÏ¡log
 >= 500000000) {

485 
log¡»am
(
LOG_DEBUG
è<< "R—d " << 
lš’um
 << "†šes, " << 
by‹¤—d
 / 1024 / 1024. << " MB" << 
¡d
::
’dl
;

486 
	gÏ¡log
 = 
by‹¤—d
;

488 
FIXLINE
(
s
);

489 
	gby‹¤—d
 +ğ
¡¾’
(
s
);

491 ià(
	gs
[0] == '#') ;

492 ià(
	gs
[0] == '%') ;

493 * 
	gt
 = 
¡¹ok
(
s
, 
d–ims
);

494 
vid_t
 
	gäom
 = 
©oi
(
t
);

495 
	gt
 = 
¡¹ok
(
NULL
,
d–ims
);

496 ià(
	gt
 !ğ
NULL
) {

497 
vid_t
 
num
 = 
©oi
(
t
);

500 
	glš’um
 +ğ
num
 + 1;

501 
vid_t
 
	gi
=0; i < 
	gnum
; i++) {

502 
	gs
 = 
fg‘s
(
s
, 
maxËn
, 
šf
);

503 
FIXLINE
(
s
);

504 
vid_t
 
	gto
 = 
©oi
(
s
);

505 ià(
	gäom
 !ğ
to
) {

506 
sh¬d”obj
.
´•roûssšg_add_edge
(
äom
, 
to
, 
EdgeD©aTy³
());

512 
ä“
(
s
);

513 
fşo£
(
šf
);

522 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
,y³Çm
	gFš®EdgeD©aTy³
>

523 
cÚv”t_bšedg–i¡
(
¡d
::
¡ršg
 
ba£f’ame
, 
sh¬d”
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
> &
sh¬d”obj
) {

524 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
·¹s
;

525 
	g¡d
::
¡ršg
 
dœÇme
 = 
g‘_dœÇme
(
ba£f’ame
);

526 
	g¡d
::
¡ršg
 
´efix
 = 
g‘_f’ame
(
ba£f’ame
);

528 
	g¡d
::
cout
 << "dœ=[" << 
dœÇme
 << "]…»fix=[" << 
´efix
 << "]" << 
¡d
::
’dl
;

529 
g‘dœ
(
dœÇme
, 
·¹s
);

531 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>::
™”©Ü
 
™
=
·¹s
.
begš
(); 
	g™
 !ğ·¹s.
’d
(); ++it) {

532 
	g¡d
::
¡ršg
 
šputfe
 = *
™
;

533 ià(
	gšputfe
.
fšd
(
´efix
è=ğ0 && 
šputfe
.fšd("tmp"è=ğšputfe.
Åos
) {

534 
¡d
::
cout
 << "GošgØ´oûss: " << 
šputfe
 << std::
’dl
;

538 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>::
™”©Ü
 
™
=
·¹s
.
begš
(); 
	g™
 !ğ·¹s.
’d
(); ++it) {

539 
	g¡d
::
¡ršg
 
šputfe
 = *
™
;

540 ià(
	gšputfe
.
fšd
(
´efix
è=ğ0 && 
šputfe
.fšd(".tmp"è=ğšputfe.
Åos
) {

541 
šputfe
 = 
dœÇme
 + "/" + inputfile;

542 
	g¡d
::
cout
 << "Proûss: " << 
šputfe
 << 
¡d
::
’dl
;

543 
FILE
 * 
	gšf
 = 
fİ’
(
šputfe
.
c_¡r
(), "r");

545 !
ãof
(
šf
)) {

546 
vid_t
 
	gäom
;

547 
vid_t
 
	gto
;

549 
size_t
 
	g»s1
 = 
ä—d
(&
äom
, (
vid_t
), 1, 
šf
);

550 
size_t
 
	g»s2
 = 
ä—d
(&
to
, (
vid_t
), 1, 
šf
);

552 
as£¹
(
»s1
 > 0 && 
»s2
 > 0);

553 ià(
	gäom
 !ğ
to
) {

554 
sh¬d”obj
.
´•roûssšg_add_edge
(
äom
, 
to
, 
EdgeD©aTy³
());

557 
fşo£
(
šf
);

563 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
,y³Çm
	gFš®EdgeD©aTy³
>

564 
cÚv”t_bšedg–i¡v®
(
¡d
::
¡ršg
 
ba£f’ame
, 
sh¬d”
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
> &
sh¬d”obj
) {

565 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
·¹s
;

566 
	g¡d
::
¡ršg
 
dœÇme
 = 
g‘_dœÇme
(
ba£f’ame
);

567 
	g¡d
::
¡ršg
 
´efix
 = 
g‘_f’ame
(
ba£f’ame
);

569 
	g¡d
::
cout
 << "dœ=[" << 
dœÇme
 << "]…»fix=[" << 
´efix
 << "]" << 
¡d
::
’dl
;

570 
g‘dœ
(
dœÇme
, 
·¹s
);

572 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>::
™”©Ü
 
™
=
·¹s
.
begš
(); 
	g™
 !ğ·¹s.
’d
(); ++it) {

573 
	g¡d
::
¡ršg
 
šputfe
 = *
™
;

574 ià(
	gšputfe
.
fšd
(
´efix
è=ğ0 && 
šputfe
.fšd("tmp"è=ğšputfe.
Åos
) {

575 
¡d
::
cout
 << "GošgØ´oûss: " << 
šputfe
 << std::
’dl
;

579 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
>::
™”©Ü
 
™
=
·¹s
.
begš
(); 
	g™
 !ğ·¹s.
’d
(); ++it) {

580 
	g¡d
::
¡ršg
 
šputfe
 = *
™
;

581 ià(
	gšputfe
.
fšd
(
´efix
è=ğ0 && 
šputfe
.fšd(".tmp"è=ğšputfe.
Åos
) {

582 
šputfe
 = 
dœÇme
 + "/" + inputfile;

583 
	g¡d
::
cout
 << "Proûss: " << 
šputfe
 << 
¡d
::
’dl
;

584 
FILE
 * 
	gšf
 = 
fİ’
(
šputfe
.
c_¡r
(), "r");

586 !
ãof
(
šf
)) {

587 
vid_t
 
	gäom
;

588 
vid_t
 
	gto
;

589 
EdgeD©aTy³
 
	gedgev®
;

591 
size_t
 
	g»s1
 = 
ä—d
(&
äom
, (
vid_t
), 1, 
šf
);

592 
size_t
 
	g»s2
 = 
ä—d
(&
to
, (
vid_t
), 1, 
šf
);

593 
size_t
 
	g»s3
 = 
ä—d
(&
edgev®
, (
EdgeD©aTy³
), 1, 
šf
);

594 
as£¹
(
»s1
 > 0 && 
»s2
 > 0 && 
»s3
 > 0);

595 ià(
	gäom
 !ğ
to
) {

596 
sh¬d”obj
.
´•roûssšg_add_edge
(
äom
, 
to
, 
edgev®
);

599 
fşo£
(
šf
);

611 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
,y³Çm
	gFš®EdgeD©aTy³
>

612 
cÚv”t
(
¡d
::
¡ršg
 
ba£f’ame
, std::¡ršg 
nsh¬ds_¡ršg
) {

613 
sh¬d”
<
EdgeD©aTy³
, 
	gFš®EdgeD©aTy³
> 
sh¬d”obj
(
ba£f’ame
);

615 
	g¡d
::
¡ršg
 
fe_ty³_¡r
 = 
g‘_İtiÚ_¡ršg_š‹¿ùive
("filetype", "edgelist,‡djlist, binedgelist, metis");

616 ià(
	gfe_ty³_¡r
 !ğ"adjli¡" && 
fe_ty³_¡r
 != "edgelist" && file_type_str != "binedgelist" &&

617 
fe_ty³_¡r
 != "multivalueedgelist" && file_type_str != "metis") {

618 
log¡»am
(
LOG_ERROR
è<< "You‚“dØ¥ecify f‘y³: 'edg–i¡', 'adjli¡', 'bšedg–i¡', o¸'m‘is'." << 
¡d
::
’dl
;

619 
as£¹
(
çl£
);

623 
	gsh¬d”obj
.
¡¬t_´•roûssšg
();

625 ià(
	gfe_ty³_¡r
 == "adjlist") {

626 
cÚv”t_adjli¡
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
>(
ba£f’ame
, 
sh¬d”obj
);

627 } ià(
	gfe_ty³_¡r
 == "edgelist") {

628 
cÚv”t_edg–i¡
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
>(
ba£f’ame
, 
sh¬d”obj
);

629 #ifdeà
DYNAMICEDATA


630 } ià(
	gfe_ty³_¡r
 == "multivalueedgelist" ) {

631 
cÚv”t_edg–i¡
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
>(
ba£f’ame
, 
sh¬d”obj
, 
Œue
);

633 } ià(
	gfe_ty³_¡r
 == "binedgelist") {

634 
cÚv”t_bšedg–i¡v®
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
>(
ba£f’ame
, 
sh¬d”obj
);

635 } ià(
	gfe_ty³_¡r
 == "metis") {

636 
cÚv”t_m‘is
<
EdgeD©aTy³
, 
Fš®EdgeD©aTy³
>(
ba£f’ame
, 
sh¬d”obj
);

638 
as£¹
(
çl£
);

642 
	gsh¬d”obj
.
’d_´•roûssšg
();

644 
vid_t
 
	gmax_v”‹x_id
 = 
g‘_İtiÚ_št
("maxvertex", 0);

645 ià(
	gmax_v”‹x_id
 > 0) {

646 
	gsh¬d”obj
.
£t_max_v”‹x_id
(
max_v”‹x_id
);

649 
	gnsh¬ds
 = 
sh¬d”obj
.
execu‹_sh¬dšg
(
nsh¬ds_¡ršg
);

650 
log¡»am
(
LOG_INFO
è<< "SucûssfuÎy fšished sh¬dšg fÜ " << 
	gba£f’ame
 << 
	g¡d
::
’dl
;

651 
log¡»am
(
LOG_INFO
è<< "C»©ed " << 
	gnsh¬ds
 << " sh¬ds." << 
	g¡d
::
’dl
;

652  
	gnsh¬ds
;

660 
VARIABLE_IS_NOT_USED
 
cÚv”t_nÚe
(
¡d
::
¡ršg
 
ba£f’ame
, std::¡ršg 
nsh¬ds_¡ršg
);

661 
VARIABLE_IS_NOT_USED
 
cÚv”t_nÚe
(
¡d
::
¡ršg
 
ba£f’ame
, std::¡ršg 
nsh¬ds_¡ršg
) {

662 
sh¬d”
<
dummy
> 
sh¬d”obj
(
ba£f’ame
);

663 
	gsh¬d”obj
.
£t_no_edgev®ues
();

665 
	g¡d
::
¡ršg
 
fe_ty³_¡r
 = 
g‘_İtiÚ_¡ršg_š‹¿ùive
("filetype", "edgelist,‡djlist, cassovary, binedgelist");

666 ià(
	gfe_ty³_¡r
 !ğ"adjli¡" && 
fe_ty³_¡r
 != "edgelist" && file_type_str != "cassovary" && file_type_str != "binedgelist" && file_type_str != "metis") {

667 
log¡»am
(
LOG_ERROR
è<< "You‚“dØ¥ecify f‘y³: 'edg–i¡' o¸'adjli¡'." << 
¡d
::
’dl
;

668 
as£¹
(
çl£
);

672 
	gsh¬d”obj
.
¡¬t_´•roûssšg
();

674 ià(
	gfe_ty³_¡r
 == "adjlist") {

675 
cÚv”t_adjli¡
<
dummy
>(
ba£f’ame
, 
sh¬d”obj
);

676 } ià(
	gfe_ty³_¡r
 == "edgelist") {

677 
cÚv”t_edg–i¡
<
dummy
>(
ba£f’ame
, 
sh¬d”obj
);

678 } ià(
	gfe_ty³_¡r
 == "cassovary") {

679 
cÚv”t_ÿssov¬y
<
dummy
>(
ba£f’ame
, 
sh¬d”obj
);

680 } ià(
	gfe_ty³_¡r
 == "binedgelist") {

681 
cÚv”t_bšedg–i¡
<
dummy
>(
ba£f’ame
, 
sh¬d”obj
);

682 } ià(
	gfe_ty³_¡r
 == "metis") {

683 
cÚv”t_m‘is
<
dummy
>(
ba£f’ame
, 
sh¬d”obj
);

687 
	gsh¬d”obj
.
’d_´•roûssšg
();

689 ià(
g‘_İtiÚ_št
("skipsharding", 0) == 1) {

690 
¡d
::
cout
 << "Sk sh¬dšg..." << std::
’dl
;

691 
ex™
(0);

694 
vid_t
 
	gmax_v”‹x_id
 = 
g‘_İtiÚ_št
("maxvertex", 0);

695 ià(
	gmax_v”‹x_id
 > 0) {

696 
	gsh¬d”obj
.
£t_max_v”‹x_id
(
max_v”‹x_id
);

699 
	gnsh¬ds
 = 
sh¬d”obj
.
execu‹_sh¬dšg
(
nsh¬ds_¡ršg
);

700 
log¡»am
(
LOG_INFO
è<< "SucûssfuÎy fšished sh¬dšg fÜ " << 
	gba£f’ame
 << 
	g¡d
::
’dl
;

701 
log¡»am
(
LOG_INFO
è<< "C»©ed " << 
	gnsh¬ds
 << " sh¬ds." << 
	g¡d
::
’dl
;

702  
	gnsh¬ds
;

705 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

706 
cÚv”t_if_nÙexi¡s_nov®ues
(
¡d
::
¡ršg
 
ba£f’ame
, std::¡ršg 
nsh¬ds_¡ršg
, 
boŞ
 &
didexi¡
) {

707 
	gnsh¬ds
;

710 ià((
	gnsh¬ds
 = 
fšd_sh¬ds
<
EdgeD©aTy³
>(
ba£f’ame
, 
	gnsh¬ds_¡ršg
))) {

711 
log¡»am
(
LOG_INFO
è<< "Found…»´oûs£d fe fÜ " << 
	gba£f’ame
 << ",‚um sh¬ds=" << 
	gnsh¬ds
 << 
	g¡d
::
’dl
;

712 
	gdidexi¡
 = 
Œue
;

713 ià(
	gcheck_Üigfe_modifiÿtiÚ_—¾›r
<
	gEdgeD©aTy³
>(
	gba£f’ame
, 
	gnsh¬ds
)) {

714  
	gnsh¬ds
;

718 
	gdidexi¡
 = 
çl£
;

720 
log¡»am
(
LOG_INFO
è<< "Did‚Ù fšd…»´oûs£d sh¬d fÜ " << 
	gba£f’ame
 << 
	g¡d
::
’dl
;

722 
log¡»am
(
LOG_INFO
è<< "(Edge-v®usize: " << (
	gEdgeD©aTy³
è<< ")" << 
	g¡d
::
’dl
;

723 
log¡»am
(
LOG_INFO
è<< "WÈŒy c»©them‚ow..." << 
	g¡d
::
’dl
;

724 
	gnsh¬ds
 = 
cÚv”t
<
dummyC
<
EdgeD©aTy³
>, 
	gEdgeD©aTy³
>(
	gba£f’ame
, 
	gnsh¬ds_¡ršg
);

725  
	gnsh¬ds
;

728 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

729 
cÚv”t_if_nÙexi¡s
(
¡d
::
¡ršg
 
ba£f’ame
, std::¡ršg 
nsh¬ds_¡ršg
, 
boŞ
 &
didexi¡
) {

730 
	gnsh¬ds
;

733 ià((
	gnsh¬ds
 = 
fšd_sh¬ds
<
EdgeD©aTy³
>(
ba£f’ame
, 
	gnsh¬ds_¡ršg
))) {

734 
log¡»am
(
LOG_INFO
è<< "Found…»´oûs£d fe fÜ " << 
	gba£f’ame
 << ",‚um sh¬ds=" << 
	gnsh¬ds
 << 
	g¡d
::
’dl
;

735 
	gdidexi¡
 = 
Œue
;

736 ià(
	gcheck_Üigfe_modifiÿtiÚ_—¾›r
<
	gEdgeD©aTy³
>(
	gba£f’ame
, 
	gnsh¬ds
)) {

737  
	gnsh¬ds
;

741 
	gdidexi¡
 = 
çl£
;

743 
log¡»am
(
LOG_INFO
è<< "Did‚Ù fšd…»´oûs£d sh¬d fÜ " << 
	gba£f’ame
 << 
	g¡d
::
’dl
;

745 
log¡»am
(
LOG_INFO
è<< "(Edge-v®usize: " << (
	gEdgeD©aTy³
è<< ")" << 
	g¡d
::
’dl
;

746 
log¡»am
(
LOG_INFO
è<< "WÈŒy c»©them‚ow..." << 
	g¡d
::
’dl
;

747 
	gnsh¬ds
 = 
cÚv”t
<
EdgeD©aTy³
, 
	gEdgeD©aTy³
>(
	gba£f’ame
, 
	gnsh¬ds_¡ršg
);

748  
	gnsh¬ds
;

752 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
,y³Çm
	gFš®EdgeTy³
>

753 
cÚv”t_if_nÙexi¡s
(
¡d
::
¡ršg
 
ba£f’ame
, std::¡ršg 
nsh¬ds_¡ršg
, 
boŞ
 &
didexi¡
) {

754 
	gnsh¬ds
;

757 ià((
	gnsh¬ds
 = 
fšd_sh¬ds
<
Fš®EdgeTy³
>(
ba£f’ame
, 
	gnsh¬ds_¡ršg
))) {

758 
log¡»am
(
LOG_INFO
è<< "Found…»´oûs£d fe fÜ " << 
	gba£f’ame
 << ",‚um sh¬ds=" << 
	gnsh¬ds
 << 
	g¡d
::
’dl
;

759 
	gdidexi¡
 = 
Œue
;

760 ià(
	gcheck_Üigfe_modifiÿtiÚ_—¾›r
<
	gFš®EdgeTy³
>(
	gba£f’ame
, 
	gnsh¬ds
)) {

761  
	gnsh¬ds
;

765 
	gdidexi¡
 = 
çl£
;

767 
log¡»am
(
LOG_INFO
è<< "Did‚Ù fšd…»´oûs£d sh¬d fÜ " << 
	gba£f’ame
 << 
	g¡d
::
’dl
;

768 
log¡»am
(
LOG_INFO
è<< "(Edge-v®usize: " << (
	gFš®EdgeTy³
è<< ")" << 
	g¡d
::
’dl
;

769 
log¡»am
(
LOG_INFO
è<< "WÈŒy c»©them‚ow..." << 
	g¡d
::
’dl
;

770 
	gnsh¬ds
 = 
cÚv”t
<
EdgeD©aTy³
, 
	gFš®EdgeTy³
>(
	gba£f’ame
, 
	gnsh¬ds_¡ršg
);

771  
	gnsh¬ds
;

774 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
,y³Çm
	gFš®EdgeTy³
>

775 
cÚv”t_if_nÙexi¡s
(
¡d
::
¡ršg
 
ba£f’ame
, std::¡ršg 
nsh¬ds_¡ršg
) {

776 
boŞ
 
b
;

777  
	gcÚv”t_if_nÙexi¡s
<
	gEdgeD©aTy³
, 
	gFš®EdgeTy³
>(
	gba£f’ame
, 
	gnsh¬ds_¡ršg
, 
	gb
);

780 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

781 
cÚv”t_if_nÙexi¡s
(
¡d
::
¡ršg
 
ba£f’ame
, std::¡ršg 
nsh¬ds_¡ršg
) {

782 
boŞ
 
b
;

783  
	gcÚv”t_if_nÙexi¡s
<
	gEdgeD©aTy³
, EdgeD©aTy³>(
	gba£f’ame
, 
	gnsh¬ds_¡ršg
, 
	gb
);

786 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

787 
cÚv”t_if_nÙexi¡s_nov®ues
(
¡d
::
¡ršg
 
ba£f’ame
, std::¡ršg 
nsh¬ds_¡ršg
) {

788 
boŞ
 
b
;

789  
	gcÚv”t_if_nÙexi¡s_nov®ues
<
	gEdgeD©aTy³
>(
	gba£f’ame
, 
	gnsh¬ds_¡ršg
, 
	gb
);

	@preprocessing/sharder.hpp

35 #iâdeà
GRAPHCHI_SHARDER_DEF


36 
	#GRAPHCHI_SHARDER_DEF


	)

39 
	~<io¡»am
>

40 
	~<c¡dio
>

41 
	~<fú.h
>

42 
	~<uni¡d.h
>

43 
	~<sys/¡©.h
>

45 
	~<veùÜ
>

46 
	~<omp.h
>

47 
	~<”ºo.h
>

48 
	~<s¡»am
>

49 
	~<¡ršg
>

51 
	~"­i/chif’ames.hµ
"

52 
	~"­i/g¿phchi_cÚ‹xt.hµ
"

53 
	~"g¿phchi_ty³s.hµ
"

54 
	~"io/¡redio.hµ
"

55 
	~"logg”/logg”.hµ
"

56 
	~"’gše/auxd©a/deg»e_d©a.hµ
"

57 
	~"m‘rics/m‘rics.hµ
"

58 
	~"m‘rics/»ps/basic_»pÜ‹r.hµ
"

59 
	~"sh¬ds/memÜysh¬d.hµ
"

60 
	~"sh¬ds/¦idšgsh¬d.hµ
"

61 
	~"ouut/ouut.hµ
"

62 
	~"ut/iout.hµ
"

63 
	~"ut/¿dixSÜt.hµ
"

64 
	~"ut/kwaym”ge.hµ
"

65 #ifdeà
DYNAMICEDATA


66 
	~"ut/qsÜt.hµ
"

68 
Çme¥aû
 
	gg¿phchi
 {

69 
	g‹m¶©e
 <
ty³Çme
 
	gVT
,y³Çm
	gET
,y³Çm
	gETFš®
> 
şass
 
	gsh¬ded_g¿ph_ouut
;

72 
	#SHARDER_BUFSIZE
 (64 * 1024 * 1024)

	)

74 
	eProcPha£
 { 
	gCOMPUTE_INTERVALS
=1, 
	gSHOVEL
=2 };

76 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

77 şas 
	cDu¶iÿ‹EdgeF‹r
 {

78 
	gpublic
:

79 
vœtu®
 
boŞ
 
acû±Fœ¡
(
EdgeD©aTy³
& 
fœ¡
, EdgeD©aTy³& 
£cÚd
) = 0;

83 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

84 
	sedge_w™h_v®ue
 {

85 
vid_t
 
	g¤c
;

86 
vid_t
 
	gd¡
;

87 
EdgeD©aTy³
 
	gv®ue
;

89 #ifdeà
DYNAMICEDATA


92 
boŞ
 
	gis_chivec_v®ue
;

93 
ušt16_t
 
	gv®šdex
;

95 
edge_w™h_v®ue
() {}

97 
edge_w™h_v®ue
(
vid_t
 
¤c
, vid_ˆ
d¡
, 
EdgeD©aTy³
 
v®ue
) : src(src), dst(dst), value(value) {

98 #ifdeà
DYNAMICEDATA


99 
	gis_chivec_v®ue
 = 
çl£
;

100 
	gv®šdex
 = 0;

105 
boŞ
 
	gİ”©Ü
< (
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> &
	gx2
) {

106  (
	gd¡
 < 
	gx2
.dst);

110 
boŞ
 
¡İ³r
(è{  
	g¤c
 =ğ0 && 
d¡
 == 0; }

113 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

114 
boŞ
 
edge_t_¤c_Ëss
(cÚ¡ 
edge_w™h_v®ue
<
EdgeD©aTy³
> &
a
, cÚ¡ƒdge_w™h_v®ue<EdgeD©aTy³> &
b
) {

115 ià(
	ga
.
	g¤c
 =ğ
b
.
¤c
) {

116 #ifdeà
DYNAMICEDATA


117 ià(
a
.
d¡
 =ğ
b
.dst) {

118  
a
.
v®šdex
 < 
b
.valindex;

121  
	ga
.
	gd¡
 < 
	gb
.dst;

123  
	ga
.
	g¤c
 < 
	gb
.src;

126 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

127 
boŞ
 
edge_t_d¡_Ëss
(cÚ¡ 
edge_w™h_v®ue
<
EdgeD©aTy³
> &
a
, cÚ¡ƒdge_w™h_v®ue<EdgeD©aTy³> &
b
) {

128  
	ga
.
	gd¡
 < 
	gb
.dst;

131 
	g‹m¶©e
 <
şass
 
	gEdgeD©aTy³
>

132 
	sd¡F
 {

133 
šlše
 
vid_t
 
İ”©Ü
(è(
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> 
	ga
è{‡.
	gd¡
;}

138 
	g‹m¶©e
 <
şass
 
	gEdgeD©aTy³
>

139 
	sd¡SrcF
 {

140 
size_t
 
	gmaxv”‹x
;

141 
d¡SrcF
(
vid_t
 
maxv”‹x
) : maxvertex(maxvertex + 1) {}

142 
šlše
 
size_t
 
İ”©Ü
(è(
edge_w™h_v®ue
<
EdgeD©aTy³
> 
a
è{ size_t×.
d¡
è* 
maxv”‹x
 +‡.
¤c
;}

145 
	g‹m¶©e
 <
şass
 
	gEdgeD©aTy³
>

146 
	s¤cF
 {
šlše
 
vid_t
 
İ”©Ü
(è(
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> 
	ga
è{‡.
	g¤c
;} };

150 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

151 
	ssh¬d_æushšfo
 {

152 
	g¡d
::
¡ršg
 
shov–Çme
;

153 
size_t
 
	gnumedges
;

154 
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> * 
	gbufãr
;

155 
vid_t
 
	gmax_v”‹x
;

156 
	gDu¶iÿ‹EdgeF‹r
<
	gEdgeD©aTy³
> * 
	gdu¶iÿ‹_f‹r
;

158 
sh¬d_æushšfo
(
¡d
::
¡ršg
 
shov–Çme
, 
vid_t
 
max_v”‹x
, 
size_t
 
numedges
, 
edge_w™h_v®ue
<
EdgeD©aTy³
> * 
bufãr
, 
Du¶iÿ‹EdgeF‹r
<EdgeD©aTy³> * 
du¶iÿ‹_f‹r
) :

159 
shov–Çme
(shov–Çme), 
numedges
Òumedges), 
bufãr
(bufãr), 
max_v”‹x
(max_v”‹x), 
du¶iÿ‹_f‹r
(duplicate_filter) {}

161 
æush
() {

165 ià(
	gdu¶iÿ‹_f‹r
 !ğ
NULL
) {

167 
log¡»am
(
LOG_INFO
è<< "SÜtšg shov–: " << 
shov–Çme
 << ", max:" << 
max_v”‹x
 << 
¡d
::
’dl
;

168 
iSÜt
(
bufãr
, (
štT
)
numedges
, iÁT(
max_v”‹x
)*štT(max_v”‹x)+štT(max_v”‹x), 
d¡SrcF
<
EdgeD©aTy³
>(max_vertex));

169 
log¡»am
(
LOG_INFO
è<< "SÜˆdÚe." << 
	gshov–Çme
 << 
	g¡d
::
’dl
;

171 
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> * 
	gtmpbuf
 = (
edge_w™h_v®ue
<
EdgeD©aTy³
> *è
ÿÎoc
(Ódge_w™h_v®ue<EdgeD©aTy³>), 
numedges
);

172 
size_t
 
	gi
 = 1;

173 
	gtmpbuf
[0] = 
bufãr
[0];

174 
size_t
 
	gj
=1; j<
	gnumedges
; j++) {

175 
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> 
	g´ev
 = 
tmpbuf
[
i
 - 1];

176 
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> 
	gcur
 = 
bufãr
[
j
];

177 ià(
	g´ev
.
	g¤c
 =ğ
cur
.
¤c
 && 
´ev
.
d¡
 == cur.dst) {

178 ià(
du¶iÿ‹_f‹r
->
acû±Fœ¡
(
cur
.
v®ue
, 
´ev
.value)) {

180 
tmpbuf
[
i
 - 1] = 
cur
;

183 
	gtmpbuf
[
i
++] = 
cur
;

186 
	g¡d
::
cout
 << "P»-du¶iÿ‹ f‹¸whshov–šg: " << 
numedges
 << " --> " << 
i
 << 
¡d
::
’dl
;

187 
	gnumedges
 = 
i
;

188 
ä“
(
bufãr
);

189 
	gbufãr
 = 
tmpbuf
;

191 
log¡»am
(
LOG_INFO
è<< "SÜtšg shov–: " << 
	gshov–Çme
 << ", max:" << 
	gmax_v”‹x
 << 
	g¡d
::
’dl
;

192 
iSÜt
(
bufãr
, (
štT
)
numedges
, (štT)
max_v”‹x
, 
d¡F
<
EdgeD©aTy³
>());

193 
log¡»am
(
LOG_INFO
è<< "SÜˆdÚe." << 
	gshov–Çme
 << 
	g¡d
::
’dl
;

198 
	gf
 = 
İ’
(
shov–Çme
.
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

199 
wr™—
(
f
, 
bufãr
, 
numedges
 * (
edge_w™h_v®ue
<
EdgeD©aTy³
>));

200 
şo£
(
f
);

201 
ä“
(
bufãr
);

206 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

207 * 
	$sh¬d_æush_run
(* 
_šfo
) {

208 
sh¬d_æushšfo
<
EdgeD©aTy³
> * 
sk
 = (sh¬d_æushšfo<EdgeD©aTy³>*)
_šfo
;

209 
sk
->
	`æush
();

210  
NULL
;

211 
	}
}

214 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

215 
	gshov–_m”ge_sourû
 : 
public
 
m”ge_sourû
<
edge_w™h_v®ue
<
EdgeD©aTy³
> > {

217 
size_t
 
bufsize_by‹s
;

218 
size_t
 
	gbufsize_edges
;

219 
	g¡d
::
¡ršg
 
shov–fe
;

220 
size_t
 
	gidx
;

221 
size_t
 
	gbufidx
;

222 
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> * 
	gbufãr
;

223 
	gf
;

224 
size_t
 
	gnumedges
;

226 
shov–_m”ge_sourû
(
size_t
 
bufsize_by‹s
, 
¡d
::
¡ršg
 
shov–fe
) : bufsize_bytes(bufsize_bytes),

227 
shov–fe
(shov–fe), 
idx
(0), 
bufidx
(0) {

228 
as£¹
(
bufsize_by‹s
 % (
edge_w™h_v®ue
<
EdgeD©aTy³
>) == 0);

229 
	gf
 = 
İ’
(
shov–fe
.
c_¡r
(), 
O_RDONLY
);

231 ià(
	gf
 < 0) {

232 
log¡»am
(
LOG_ERROR
è<< "Could‚Ù o³Àshov– fe: " << 
	gshov–fe
 << 
	g¡d
::
’dl
;

233 
´štf
("E¼Ü: %d, %s\n", 
”ºo
, 
¡»¼Ü
(errno));

236 
as£¹
(
f
>=0);

238 
	gbufãr
 = (
edge_w™h_v®ue
<
EdgeD©aTy³
> *è
m®loc
(
bufsize_by‹s
);

239 
	gnumedges
 = (
g‘_fesize
(
shov–fe
è/ (
edge_w™h_v®ue
<
EdgeD©aTy³
> ));

240 
	gbufsize_edges
 = (
bufsize_by‹s
 / (
edge_w™h_v®ue
<
EdgeD©aTy³
>));

241 
lßd_Ãxt
();

244 
	gvœtu®
 ~
shov–_m”ge_sourû
() {

245 ià(
	gbufãr
 !ğ
NULL
è
ä“
(
bufãr
);

246 
	gbufãr
 = 
NULL
;

249 
fšish
() {

250 
şo£
(
f
);

251 
»move
(
shov–fe
.
c_¡r
());

253 
ä“
(
bufãr
);

254 
	gbufãr
 = 
NULL
;

257 
lßd_Ãxt
() {

258 
size_t
 
	gËn
 = 
¡d
::
mš
(
bufsize_by‹s
, ((
numedges
 - 
idx
è* (
edge_w™h_v®ue
<
EdgeD©aTy³
>)));

259 
´—da
(
f
, 
bufãr
, 
Ën
, 
idx
 * (
edge_w™h_v®ue
<
EdgeD©aTy³
>));

260 
	gbufidx
 = 0;

263 
boŞ
 
has_mÜe
() {

264  
	gidx
 < 
	gnumedges
;

267 
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> 
Ãxt
() {

268 ià(
	gbufidx
 =ğ
bufsize_edges
) {

269 
lßd_Ãxt
();

271 
	gidx
++;

272 ià(
	gidx
 =ğ
numedges
) {

273 
edge_w™h_v®ue
<
EdgeD©aTy³
> 
x
 = 
bufãr
[
bufidx
++];

274 
fšish
();

275  
	gx
;

277  
	gbufãr
[
bufidx
++];

281 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
,y³Çm
	gFš®EdgeD©aTy³
=
EdgeD©aTy³
>

282 
şass
 
sh¬d”
 : 
public
 
m”ge_sšk
<
edge_w™h_v®ue
<
EdgeD©aTy³
> > {

284 
edge_w™h_v®ue
<
	tEdgeD©aTy³
> 
	tedge_t
;

286 
	g´Ùeùed
:

287 
¡d
::
¡ršg
 
ba£f’ame
;

289 
vid_t
 
	gmax_v”‹x_id
;

292 
	gnsh¬ds
;

293 
	g¡d
::
veùÜ
< 
¡d
::
·œ
<
vid_t
, 
	gvid_t
> > 
	gš‹rv®s
;

295 
	gpha£
;

297 
	gv”‹xchunk
;

298 
size_t
 
	gÃdges
;

299 
	g¡d
::
¡ršg
 
´efix
;

301 
	gcom´es£d_block_size
;

303 * 
	gbuåŒs
;

304 
size_t
 
	gbufsize
;

305 
size_t
 
	gedged©asize
;

306 
size_t
 
	gebufãr_size
;

307 
size_t
 
	gedges_³r_block
;

309 
vid_t
 
	gf‹r_max_v”‹x
;

311 
	gDu¶iÿ‹EdgeF‹r
<
	gEdgeD©aTy³
> * 
	gdu¶iÿ‹_edge_f‹r
;

313 
boŞ
 
	gno_edgev®ues
;

314 #ifdeà
DYNAMICEDATA


315 
edge_t
 
	gÏ¡_added_edge
;

318 
m‘rics
 
	gm
;

321 
size_t
 
	gcurshov–_idx
;

322 
size_t
 
	gshov–size
;

323 
	gnumshov–s
;

324 
size_t
 
	gshov–ed_edges
;

325 
boŞ
 
	gshov–_sÜ‹d
;

326 
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> * 
	gcurshov–_bufãr
;

327 
	g¡d
::
veùÜ
<
±h»ad_t
> 
shov–th»ads
;

328 
	g¡d
::
veùÜ
<
sh¬d_æushšfo
<
EdgeD©aTy³
> *> 
shov–sks
;

330 
	gpublic
:

332 
sh¬d”
(
¡d
::
¡ršg
 
ba£f’ame
è: ba£f’ame(ba£f’ame), 
m
("sharder") {

334 
	gedged©asize
 = (
Fš®EdgeD©aTy³
);

335 
	gno_edgev®ues
 = 
çl£
;

336 
	gcom´es£d_block_size
 = 1024 * 1024;

337 
	gf‹r_max_v”‹x
 = 0;

338 
	gcurshov–_bufãr
 = 
NULL
;

339 
	gcom´es£d_block_size
 % (
	gFš®EdgeD©aTy³
è!ğ0è
com´es£d_block_size
++;

340 
	gedges_³r_block
 = 
com´es£d_block_size
 / (
Fš®EdgeD©aTy³
);

341 
	gdu¶iÿ‹_edge_f‹r
 = 
NULL
;

345 
	gvœtu®
 ~
sh¬d”
() {

346 ià(
	gcurshov–_bufãr
 =ğ
NULL
è
ä“
(
curshov–_bufãr
);

349 
£t_du¶iÿ‹_f‹r
(
Du¶iÿ‹EdgeF‹r
<
EdgeD©aTy³
> * 
f‹r
) {

350 
	gthis
->
	gdu¶iÿ‹_edge_f‹r
 = 
f‹r
;

353 
£t_max_v”‹x_id
(
vid_t
 
maxid
) {

354 
	gf‹r_max_v”‹x
 = 
maxid
;

357 
£t_no_edgev®ues
() {

358 
	gno_edgev®ues
 = 
Œue
;

364 
¡¬t_´•roûssšg
() {

365 
	gm
.
¡¬t_time
("preprocessing");

366 
	gnumshov–s
 = 0;

367 
	gshov–size
 = (1024È* 1024È* 
size_t
(
g‘_İtiÚ_št
("membudg‘_mb", 1024)è/ 4È/ (
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
>));

368 
	gcurshov–_idx
 = 0;

370 
log¡»am
(
LOG_INFO
è<< "S¹šg…»´oûssšg, shov– size: " << 
	gshov–size
 << 
	g¡d
::
’dl
;

372 
	gcurshov–_bufãr
 = (
edge_w™h_v®ue
<
EdgeD©aTy³
> *è
ÿÎoc
(
shov–size
, (edge_with_value<EdgeDataType>));

374 
as£¹
(
curshov–_bufãr
 !ğ
NULL
);

376 
	gshov–th»ads
.
ş—r
();

379 
	gmax_v”‹x_id
 = 0;

380 
	gshov–ed_edges
 = 0;

386 
’d_´•roûssšg
() {

387 
	gm
.
¡İ_time
("preprocessing");

388 
æush_shov–
(
çl£
);

391 
æush_shov–
(
boŞ
 
async
=
Œue
) {

393 
sh¬d_æushšfo
<
EdgeD©aTy³
> * 
æushšfo
 = 
Ãw
 sh¬d_æushšfo<EdgeD©aTy³>(
shov–_f’ame
(
numshov–s
), 
	gmax_v”‹x_id
, 
	gcurshov–_idx
, 
	gcurshov–_bufãr
, 
	gdu¶iÿ‹_edge_f‹r
);

394 
	gshov–sks
.
push_back
(
æushšfo
);

396 ià(!
	gasync
) {

397 
	gcurshov–_bufãr
 = 
NULL
;

398 
	gæushšfo
->
æush
();

401 
log¡»am
(
LOG_INFO
è<< "Wa™šg shov–šgh»ads..." << 
	g¡d
::
’dl
;

402 
	gi
=0; i < ()
	gshov–th»ads
.
size
(); i++) {

403 
±h»ad_još
(
shov–th»ads
[
i
], 
NULL
);

406 ià(
	gshov–th»ads
.
size
() > 2) {

407 
log¡»am
(
LOG_INFO
è<< "ToØmªy out¡ªdšg shov–šgh»ads..." << 
	g¡d
::
’dl
;

409 
	gi
=0; i < ()
	gshov–th»ads
.
size
(); i++) {

410 
±h»ad_još
(
shov–th»ads
[
i
], 
NULL
);

412 
	gshov–th»ads
.
ş—r
();

414 
	gcurshov–_bufãr
 = (
edge_w™h_v®ue
<
EdgeD©aTy³
> *è
ÿÎoc
(
shov–size
, (edge_with_value<EdgeDataType>));

415 
±h»ad_t
 
	gt
;

416 
	g»t
 = 
±h»ad_ü—‹
(&
t
, 
NULL
, 
sh¬d_æush_run
<
EdgeD©aTy³
>, (*)
æushšfo
);

417 
	gshov–th»ads
.
push_back
(
t
);

418 
as£¹
(
»t
>=0);

420 
	gnumshov–s
++;

421 
	gcurshov–_idx
=0;

427 
´•roûssšg_add_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
EdgeD©aTy³
 
v®
, 
boŞ
 
šput_v®ue
=
çl£
) {

428 ià(
äom
 =ğ
to
) {

432 
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> 
e
(
äom
, 
to
, 
v®
);

433 #ifdeà
DYNAMICEDATA


434 
	ge
.
	gis_chivec_v®ue
 = 
šput_v®ue
;

435 ià(
	ge
.
	g¤c
 =ğ
Ï¡_added_edge
.
¤c
 && 
e
.
d¡
 ==†ast_added_edge.dst) {

436 
e
.
v®šdex
 = 
Ï¡_added_edge
.valindex + 1;

438 
	gÏ¡_added_edge
 = 
e
;

440 
	gcurshov–_bufãr
[
curshov–_idx
++] = 
e
;

441 ià(
	gcurshov–_idx
 =ğ
shov–size
) {

442 
æush_shov–
();

445 
	gmax_v”‹x_id
 = 
¡d
::
max
(¡d::max(
äom
, 
to
), 
max_v”‹x_id
);

448 #ifdeà
DYNAMICEDATA


449 
´•roûssšg_add_edge_muÉiv®
(
vid_t
 
äom
, vid_ˆ
to
, 
¡d
::
veùÜ
<
EdgeD©aTy³
> & 
v®s
) {

450 
ty³Çme
 
¡d
::
veùÜ
<
EdgeD©aTy³
>::
™”©Ü
 
™”
;

451 
	g™”
=
v®s
.
begš
(); i‹¸!ğv®s.
’d
(); ++iter) {

452 
´•roûssšg_add_edge
(
äom
, 
to
, *
™”
, 
Œue
);

454 
	gmax_v”‹x_id
 = 
¡d
::
max
(¡d::max(
äom
, 
to
), 
max_v”‹x_id
);

462 
´•roûssšg_add_edge
(
vid_t
 
äom
, vid_ˆ
to
) {

463 
´•roûssšg_add_edge
(
äom
, 
to
, 
EdgeD©aTy³
());

466 
size_t
 
	gcu¿djf•os
;

469 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

470 
bwr™e
(
f
, * 
buf
, * &
buåŒ
, 
T
 
v®
) {

471 
	gcu¿djf•os
 +ğ(
T
);

472 ià(
	gbuåŒ
 + (
	gT
è- 
	gbuf
 >ğ
SHARDER_BUFSIZE
) {

473 
wr™—
(
f
, 
buf
, 
buåŒ
 - buf);

474 
	gbuåŒ
 = 
buf
;

476 *((
	gT
*)
	gbuåŒ
èğ
v®
;

477 
	gbuåŒ
 +ğ(
T
);

480 
	gblockid
;

482 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

483 
ed©a_æush
(* 
buf
, * 
buåŒ
, 
¡d
::
¡ršg
 & 
sh¬d_f’ame
, 
size_t
 
tÙby‹s
) {

484 
	gËn
 = (è(
buåŒ
 - 
buf
);

486 
	gm
.
¡¬t_time
("edata_flush");

488 
	g¡d
::
¡ršg
 
block_f’ame
 = 
f’ame_sh¬d_ed©a_block
(
sh¬d_f’ame
, 
blockid
, 
com´es£d_block_size
);

489 
	gf
 = 
İ’
(
block_f’ame
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

490 
wr™e_com´es£d
(
f
, 
buf
, 
Ën
);

491 
şo£
(
f
);

493 
	gm
.
¡İ_time
("edata_flush");

496 #ifdeà
DYNAMICEDATA


498 
wr™e_block_uncom´es£d_size
(
block_f’ame
, 
Ën
);

502 
	gblockid
++;

505 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

506 
bwr™e_ed©a
(* &
buf
, * &
buåŒ
, 
T
 
v®
, 
size_t
 & 
tÙby‹s
, 
¡d
::
¡ršg
 & 
sh¬d_f’ame
,

507 
size_t
 & 
edgecouÁ”
) {

508 ià(
	gno_edgev®ues
) ;

510 ià(
	gedgecouÁ”
 =ğ
edges_³r_block
) {

511 
ed©a_æush
<
T
>(
buf
, 
buåŒ
, 
sh¬d_f’ame
, 
tÙby‹s
);

512 
	gbuåŒ
 = 
buf
;

513 
	gedgecouÁ”
 = 0;

517 ià(
	gbuåŒ
 - 
	gbuf
 + (
	gT
è> 
	gebufãr_size
) {

518 
	gebufãr_size
 *= 2;

519 
log¡»am
(
LOG_DEBUG
è<< "Inü—£d bufã¸sizto: " << 
	gebufãr_size
 << 
	g¡d
::
’dl
;

520 
size_t
 
	g±roff
 = 
buåŒ
 - 
buf
;

521 
	gbuf
 = (*è
»®loc
(
buf
, 
ebufãr_size
);

522 
	gbuåŒ
 = 
buf
 + 
±roff
;

525 
	gtÙby‹s
 +ğ(
T
);

526 *((
	gT
*)
	gbuåŒ
èğ
v®
;

527 
	gbuåŒ
 +ğ(
T
);

535 
execu‹_sh¬dšg
(
¡d
::
¡ršg
 
nsh¬ds_¡ršg
) {

536 
m
.
¡¬t_time
("execute_sharding");

538 
d‘”mše_numb”_of_sh¬ds
(
nsh¬ds_¡ršg
);

539 
wr™e_sh¬ds
();

541 
	gm
.
¡İ_time
("execute_sharding");

544 
basic_»pÜ‹r
 
	gbasiü•
;

545 
	gm
.
»pÜt
(
basiü•
);

547  
	gnsh¬ds
;

553 
	g´Ùeùed
:

555 
vœtu®
 
d‘”mše_numb”_of_sh¬ds
(
¡d
::
¡ršg
 
nsh¬ds_¡ršg
) {

557 
shov–ed_edges
 = 0;

558 
	gi
=0; i<()
	gshov–sks
.
size
(); i++) {

559 
	gshov–ed_edges
 +ğ
shov–sks
[
i
]->
numedges
;

560 
d–‘e
 
	gshov–sks
[
i
];

563 ià(
	gnsh¬ds_¡ršg
.
fšd
("auto"è!ğ
¡d
::
¡ršg
::
Åos
 || 
nsh¬ds_¡ršg
 == "0") {

564 
log¡»am
(
LOG_INFO
è<< "D‘”mššg‚umb” oàsh¬d autom©iÿÎy." << 
¡d
::
’dl
;

566 
	gmembudg‘_mb
 = 
g‘_İtiÚ_št
("membudget_mb", 1024);

567 
log¡»am
(
LOG_INFO
è<< "Assumšg‡vaabË memÜy i " << 
	gmembudg‘_mb
 << " megaby‹s. " << 
	g¡d
::
’dl
;

568 
log¡»am
(
LOG_INFO
è<< " (Thi ÿÀbdefšed w™h cÚfigu¿tiÚ…¬am‘” 'membudg‘_mb')" << 
	g¡d
::
’dl
;

570 
size_t
 
	gnumedges
 = 
shov–ed_edges
;

572 
	gmax_sh¬dsize
 = 
membudg‘_mb
 * 1024. * 1024. / 8;

573 
log¡»am
(
LOG_INFO
è<< "D‘”mššg maximum sh¬d size: " << (
	gmax_sh¬dsize
 / 1024. / 1024.è<< " MB." << 
	g¡d
::
’dl
;

575 
	gnsh¬ds
 = (èĞ1 + (
numedges
 * (
Fš®EdgeD©aTy³
è/ 
max_sh¬dsize
) + 0.5);

577 #ifdeà
DYNAMICEDATA


579 
	gnsh¬ds
 = (èĞ2 + 4 * (
numedges
 * (
Fš®EdgeD©aTy³
è/ 
max_sh¬dsize
) + 0.5);

583 
	gnsh¬ds
 = 
©oi
(
nsh¬ds_¡ršg
.
c_¡r
());

585 
as£¹
(
nsh¬ds
 > 0);

586 
log¡»am
(
LOG_INFO
è<< "Numb” oàsh¬d tØbü—‹d: " << 
	gnsh¬ds
 << 
	g¡d
::
’dl
;

590 
	g´Ùeùed
:

592 
Úe_sh¬d_š‹rv®s
() {

593 
as£¹
(
nsh¬ds
 == 1);

594 
	g¡d
::
¡ršg
 
âame
 = 
f’ame_š‹rv®s
(
ba£f’ame
, 
nsh¬ds
);

595 
FILE
 * 
	gf
 = 
fİ’
(
âame
.
c_¡r
(), "w");

596 
	gš‹rv®s
.
push_back
(
¡d
::
·œ
<
vid_t
,vid_t>(0, 
max_v”‹x_id
));

597 
årštf
(
f
, "%u\n", 
max_v”‹x_id
);

598 
fşo£
(
f
);

601 
	g¡d
::
¡ršg
 
numv_f’ame
 = 
ba£f’ame
 + ".numvertices";

602 
	gf
 = 
fİ’
(
numv_f’ame
.
c_¡r
(), "w");

603 
årštf
(
f
, "%u\n", 1 + 
max_v”‹x_id
);

604 
fşo£
(
f
);

606 
as£¹
(
nsh¬ds
 =ğ()
š‹rv®s
.
size
());

610 
	g¡d
::
¡ršg
 
shov–_f’ame
(
idx
) {

611 
¡d
::
¡ršg¡»am
 
ss
;

612 
	gss
 << 
	gba£f’ame
 << (
	gEdgeD©aTy³
è<< "." << 
	gidx
 << ".shovel";

613  
	gss
.
¡r
();

617 
	gÏ¡·¹
;

618 
deg»e
 * 
	gdeg»es
;

620 
vœtu®
 
fšish_sh¬d
(
sh¬d
, 
edge_t
 * 
shov–buf
, 
size_t
 
shov–size
) {

621 
	gm
.
¡¬t_time
("shard_final");

622 
	gblockid
 = 0;

623 
size_t
 
	gedgecouÁ”
 = 0;

624 
	gcu¿djf•os
 = 0;

625 
log¡»am
(
LOG_INFO
è<< "S¹šg fš®…roûssšg fÜ sh¬d: " << 
	gsh¬d
 << 
	g¡d
::
’dl
;

627 
	g¡d
::
¡ršg
 
âame
 = 
f’ame_sh¬d_adj
(
ba£f’ame
, 
sh¬d
, 
nsh¬ds
);

628 
	g¡d
::
¡ršg
 
edâame
 = 
f’ame_sh¬d_ed©a
<
Fš®EdgeD©aTy³
>(
ba£f’ame
, 
	gsh¬d
, 
	gnsh¬ds
);

629 
	g¡d
::
¡ršg
 
edblockdœÇme
 = 
dœÇme_sh¬d_ed©a_block
(
edâame
, 
com´es£d_block_size
);

632 ià(!
	gno_edgev®ues
)

633 
mkdœ
(
edblockdœÇme
.
c_¡r
(), 0777);

634 
size_t
 
	gnumedges
 = 
shov–size
 / (
edge_t
);

636 
log¡»am
(
LOG_DEBUG
è<< "Shov– size:" << 
	gshov–size
 << "ƒdges: " << 
	gnumedges
 << 
	g¡d
::
’dl
;

638 
	gm
.
¡¬t_time
("finish_shard.sort");

639 #iâdeà
DYNAMICEDATA


640 
iSÜt
(
shov–buf
, ()
numedges
, 
max_v”‹x_id
, 
¤cF
<
EdgeD©aTy³
>());

642 
quickSÜt
(
shov–buf
, ()
numedges
, 
edge_t_¤c_Ëss
<
EdgeD©aTy³
>);

644 
	gm
.
¡İ_time
("finish_shard.sort");

647 ià(
	gdu¶iÿ‹_edge_f‹r
 !ğ
NULL
 && 
numedges
 > 0) {

648 
edge_t
 * 
tmpbuf
 = (edge_t*è
ÿÎoc
(
numedges
, (edge_t));

649 
size_t
 
	gi
 = 1;

650 
	gtmpbuf
[0] = 
shov–buf
[0];

651 
size_t
 
	gj
=1; j<
	gnumedges
; j++) {

652 
edge_t
 
	g´ev
 = 
tmpbuf
[
i
 - 1];

653 
edge_t
 
	gcur
 = 
shov–buf
[
j
];

655 ià(
	g´ev
.
	g¤c
 =ğ
cur
.
¤c
 && 
´ev
.
d¡
 == cur.dst) {

656 ià(
du¶iÿ‹_edge_f‹r
->
acû±Fœ¡
(
cur
.
v®ue
, 
´ev
.value)) {

658 
tmpbuf
[
i
 - 1] = 
cur
;

661 
	gtmpbuf
[
i
++] = 
cur
;

664 
	gnumedges
 = 
i
;

665 
log¡»am
(
LOG_DEBUG
è<< "Aá” du¶iÿ‹ƒlimš©iÚ: " << 
	gnumedges
 << "ƒdges" << 
	g¡d
::
’dl
;

666 
ä“
(
shov–buf
);

667 
	gshov–buf
 = 
tmpbuf
; 
	gtmpbuf
 = 
NULL
;

671 
	g¡d
::
¡ršg
 
šdexfe
 = 
f’ame_sh¬d_adjidx
(
âame
);

672 
	gidxf
 = 
İ’
(
šdexfe
.
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

673 
size_t
 
	gÏ¡_šdex_ouut
 = 0;

674 
size_t
 
	gšdex_š‹rv®_edges
 = 1024 * 1024;

677 
	gf
 = 
İ’
(
âame
.
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

678 ià(
	gf
 < 0) {

679 
log¡»am
(
LOG_ERROR
è<< "Could‚Ù o³À" << 
	gâame
 << "ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
	g¡d
::
’dl
;

681 
as£¹
(
f
 >= 0);

682 
	gŒ”r
 = 
árunÿ‹
(
f
, 0);

683 
as£¹
(
Œ”r
 == 0);

685 * 
	gbuf
 = (*è
m®loc
(
SHARDER_BUFSIZE
);

686 * 
	gbuåŒ
 = 
buf
;

688 * 
	gebuf
 = (*è
m®loc
(
com´es£d_block_size
);

689 
	gebufãr_size
 = 
com´es£d_block_size
;

690 * 
	gebuåŒ
 = 
ebuf
;

692 
vid_t
 
	gcurvid
=0;

693 #ifdeà
DYNAMICEDATA


694 
vid_t
 
	gÏ¡d¡
 = 0xffffffff;

695 
	gjumpov”
 = 0;

696 
size_t
 
	gnum_uniq_edges
 = 0;

697 
size_t
 
	gÏ¡_edge_couÁ
 = 0;

699 
size_t
 
	gi¡¬t
 = 0;

700 
size_t
 
	gtÙ_ed©aby‹s
 = 0;

701 
size_t
 
	gi
=0; i <ğ
numedges
; i++) {

702 ià(
	gi
 % 10000000 =ğ0è
log¡»am
(
LOG_DEBUG
è<< 
i
 << " / " << 
numedges
 << 
¡d
::
’dl
;

703 #ifdeà
DYNAMICEDATA


704 
	gi
 +ğ
jumpov”
;

705 
	gjumpov”
 = 0;

707 
edge_t
 
	gedge
 = (
i
 < 
numedges
 ? 
shov–buf
[i] :ƒdge_t(0, 0, 
EdgeD©aTy³
()));

709 #ifdeà
DYNAMICEDATA


711 ià(
	gÏ¡d¡
 =ğ
edge
.
d¡
 &&ƒdge.
¤c
 =ğ
curvid
) {

713 
log¡»am
(
LOG_ERROR
è<< "Du¶iÿ‹ƒdgšh¡»am -‡bÜtšg" << 
¡d
::
’dl
;

714 
as£¹
(
çl£
);

716 
	gÏ¡d¡
 = 
edge
.
d¡
;

719 ià(!
	gedge
.
¡İ³r
()) {

720 #iâdeà
DYNAMICEDATA


721 
	gbwr™e_ed©a
<
	gFš®EdgeD©aTy³
>(
	gebuf
, 
	gebuåŒ
, 
Fš®EdgeD©aTy³
(
edge
.
v®ue
), 
	gtÙ_ed©aby‹s
, 
	gedâame
, 
	gedgecouÁ”
);

724 ià(
	gedge
.
	gis_chivec_v®ue
) {

726 
	gcouÁ
 = 1;

727 
	gshov–buf
[
i
 + 
couÁ
].
	gv®šdex
 == count) { count++; }

729 
as£¹
(
couÁ
 < 32768);

731 
ty³Çme
 
	gchiveùÜ
<
	gEdgeD©aTy³
>::
sizewÜd_t
 
szw
;

732 ((
	gušt16_t
 *è&
	gszw
)[0] = (
ušt16_t
)
couÁ
;

733 ((
	gušt16_t
 *è&
	gszw
)[1] = (
ušt16_t
)
couÁ
;

734 
	gbwr™e_ed©a
<
ty³Çme
 
	gchiveùÜ
<
	gEdgeD©aTy³
>::
sizewÜd_t
>(
ebuf
, 
	gebuåŒ
, 
	gszw
, 
	gtÙ_ed©aby‹s
, 
	gedâame
, 
	gedgecouÁ”
);

735 
	gj
=0; j < 
	gcouÁ
; j++) {

736 
	gbwr™e_ed©a
<
	gEdgeD©aTy³
>(
	gebuf
, 
	gebuåŒ
, 
EdgeD©aTy³
(
shov–buf
[
i
 + 
j
].
v®ue
), 
	gtÙ_ed©aby‹s
, 
	gedâame
, 
	gedgecouÁ”
);

738 
	gjumpov”
 = 
couÁ
 - 1;

741 
	gbwr™e_ed©a
<>(
	gebuf
, 
	gebuåŒ
, 0, 
	gtÙ_ed©aby‹s
, 
	gedâame
, 
	gedgecouÁ”
);

743 
	gnum_uniq_edges
++;

746 
	gedgecouÁ”
++;

748 ià(
	gdeg»es
 !ğ
NULL
 && 
edge
.
¤c
 !ğedge.
d¡
) {

749 
deg»es
[
edge
.
¤c
].
outdeg»e
++;

750 
	gdeg»es
[
edge
.
d¡
].
	gšdeg»e
++;

753 ià((
	gedge
.
	g¤c
 !ğ
curvid
è|| 
edge
.
¡İ³r
()) {

755 #iâdeà
DYNAMICEDATA


756 
size_t
 
couÁ
 = 
i
 - 
i¡¬t
;

758 
size_t
 
	gcouÁ
 = 
num_uniq_edges
 - 1 - 
Ï¡_edge_couÁ
;

759 
	gÏ¡_edge_couÁ
 = 
num_uniq_edges
 - 1;

760 ià(
	gedge
.
¡İ³r
()è
	gcouÁ
++;

762 
as£¹
(
couÁ
>0 || 
curvid
==0);

765 ià(
	gi¡¬t
 - 
	gÏ¡_šdex_ouut
 >ğ
šdex_š‹rv®_edges
) {

766 
size_t
 
curåos
 = 
cu¿djf•os
;

767 
sh¬d_šdex
 
sidx
(
curvid
, 
curåos
, 
i¡¬t
);

768 
size_t
 
	ga
 = 
wr™e
(
idxf
, &
sidx
, (
sh¬d_šdex
));

769 
as£¹
(
a
>0);

770 
	gÏ¡_šdex_ouut
 = 
i¡¬t
;

774 ià(
	gcouÁ
>0) {

775 ià(
	gcouÁ
 < 255) {

776 
ušt8_t
 
	gx
 = (ušt8_t)
couÁ
;

777 
	gbwr™e
<
	gušt8_t
>(
	gf
, 
	gbuf
, 
	gbuåŒ
, 
	gx
);

779 
	gbwr™e
<
	gušt8_t
>(
	gf
, 
	gbuf
, 
	gbuåŒ
, 0xff);

780 
	gbwr™e
<
	gušt32_t
>(
	gf
, 
	gbuf
, 
	gbuåŒ
, (ušt32_t)
	gcouÁ
);

784 #iâdeà
DYNAMICEDATA


788 
size_t
 
	gj
=
i¡¬t
; j < 
	gi
; j++) {

789 
bwr™e
(
f
, 
buf
, 
buåŒ
, 
shov–buf
[
j
].
d¡
);

795 
size_t
 
	gj
=
i¡¬t
; j < 
	gi
; j++) {

796 ià(
	gj
 =ğ
i¡¬t
 || 
shov–buf
[
j
 - 1].
d¡
 != shovelbuf[j].dst) {

797 
bwr™e
(
f
, 
buf
, 
buåŒ
, 
shov–buf
[
j
].
d¡
);

801 
	gi¡¬t
 = 
i
;

802 #ifdeà
DYNAMICEDATA


803 
	gi¡¬t
 +ğ
jumpov”
;

807 ià(!
	gedge
.
¡İ³r
()) {

808 ià(
	gedge
.
	g¤c
 - 
	gcurvid
 > 1 || (
	gi
 =ğ0 && 
edge
.
¤c
>0)) {

809 
nz
 = 
edge
.
¤c
 - 
curvid
 - 1;

810 ià(
	gi
 =ğ0 && 
edge
.
¤c
 > 0è
nz
 =ƒdge.src;

812 
	gbwr™e
<
	gušt8_t
>(
	gf
, 
	gbuf
, 
	gbuåŒ
, 0);

813 
	gnz
--;

814 
	gŠz
 = 
¡d
::
mš
(254, 
nz
);

815 
	gbwr™e
<
	gušt8_t
>(
	gf
, 
	gbuf
, 
	gbuåŒ
, (ušt8_tè
	gŠz
);

816 
	gnz
 -ğ
Šz
;

817 } 
	gnz
>0);

820 
	gcurvid
 = 
edge
.
¤c
;

825 
wr™—
(
f
, 
buf
, 
buåŒ
 - buf);

826 
ä“
(
buf
);

827 
ä“
(
shov–buf
);

828 
şo£
(
f
);

829 
şo£
(
idxf
);

832 ià(!
	gno_edgev®ues
) {

833 
	ged©a_æush
<
	gFš®EdgeD©aTy³
>(
	gebuf
, 
	gebuåŒ
, 
	gedâame
, 
	gtÙ_ed©aby‹s
);

835 
	g¡d
::
¡ršg
 
sizef’ame
 = 
edâame
 + ".size";

836 
	g¡d
::
of¡»am
 
ofs
(
sizef’ame
.
c_¡r
());

837 #iâdeà
DYNAMICEDATA


838 
	gofs
 << 
	gtÙ_ed©aby‹s
;

840 
	gofs
 << 
num_uniq_edges
 * ();

843 
	gofs
.
şo£
();

845 
ä“
(
ebuf
);

847 
	gm
.
¡İ_time
("shard_final");

852 
size_t
 
	gedges_³r_sh¬d
;

853 
size_t
 
	gcur_sh¬d_couÁ”
;

854 
size_t
 
	gsh¬d_ÿ·c™y
;

855 
size_t
 
	gsh¬ded_edges
;

856 
	gsh¬dnum
;

857 
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> * 
	gsškbufãr
;

858 
vid_t
 
	g´evvid
;

859 
vid_t
 
	gthis_š‹rv®_¡¬t
;

861 
vœtu®
 
add
(
edge_w™h_v®ue
<
EdgeD©aTy³
> 
v®
) {

862 ià(
	gcur_sh¬d_couÁ”
 >ğ
edges_³r_sh¬d
 && 
v®
.
d¡
 !ğ
´evvid
) {

863 
ü—‹Ãxtsh¬d
();

866 ià(
	gcur_sh¬d_couÁ”
 =ğ
sh¬d_ÿ·c™y
) {

868 
log¡»am
(
LOG_WARNING
è<< "Sh¬d " << 
sh¬dnum
 << " ov”æowšg! " << 
cur_sh¬d_couÁ”
 << " / " << 
sh¬d_ÿ·c™y
 << 
¡d
::
’dl
;

869 
	gsh¬d_ÿ·c™y
 = (
size_t
è(1.2 * 
sh¬d_ÿ·c™y
);

870 
	gsškbufãr
 = (
edge_w™h_v®ue
<
EdgeD©aTy³
>*è
»®loc
(
sškbufãr
, 
sh¬d_ÿ·c™y
 * (edge_with_value<EdgeDataType>));

873 
	gsškbufãr
[
cur_sh¬d_couÁ”
++] = 
v®
;

874 
	g´evvid
 = 
v®
.
d¡
;

875 
	gsh¬ded_edges
++;

878 
ü—‹Ãxtsh¬d
() {

879 
as£¹
(
sh¬dnum
 < 
nsh¬ds
);

880 
	gš‹rv®s
.
push_back
(
¡d
::
·œ
<
vid_t
, vid_t>(
this_š‹rv®_¡¬t
, (
sh¬dnum
 =ğ
nsh¬ds
 - 1 ? 
max_v”‹x_id
 : 
´evvid
)));

881 
	gthis_š‹rv®_¡¬t
 = 
´evvid
 + 1;

882 
fšish_sh¬d
(
sh¬dnum
++, 
sškbufãr
, 
cur_sh¬d_couÁ”
 * (
edge_w™h_v®ue
<
EdgeD©aTy³
>));

883 
	gsškbufãr
 = (
edge_w™h_v®ue
<
EdgeD©aTy³
> *è
m®loc
(
sh¬d_ÿ·c™y
 * (edge_with_value<EdgeDataType>));

884 
	gcur_sh¬d_couÁ”
 = 0;

887 
log¡»am
(
LOG_INFO
è<< "Remaššgƒdges: " << (
	gshov–ed_edges
 - 
	gsh¬ded_edges
è<< "„emaššg sh¬ds:" << (
	gnsh¬ds
 - 
	gsh¬dnum
)

888 << "ƒdge ³¸sh¬d=" << 
	gedges_³r_sh¬d
 << 
	g¡d
::
’dl
;

889 ià(
	gsh¬dnum
 < 
	gnsh¬ds
è
	gedges_³r_sh¬d
 = (
shov–ed_edges
 - 
sh¬ded_edges
è/ (
nsh¬ds
 - 
sh¬dnum
);

890 
log¡»am
(
LOG_INFO
è<< "Edge ³¸sh¬d: " << 
	gedges_³r_sh¬d
 << 
	g¡d
::
’dl
;

894 
vœtu®
 
dÚe
() {

895 
ü—‹Ãxtsh¬d
();

896 ià(
	gshov–ed_edges
 !ğ
sh¬ded_edges
) {

897 
log¡»am
(
LOG_INFO
è<< "Shov–ed " << 
shov–ed_edges
 << " buˆsh¬ded " << 
sh¬ded_edges
 << "ƒdges" << 
¡d
::
’dl
;

899 ià(
	gdu¶iÿ‹_edge_f‹r
 =ğ
NULL
)

900 
as£¹
(
shov–ed_edges
 =ğ
sh¬ded_edges
);

903 
log¡»am
(
LOG_INFO
è<< "C»©ed " << 
	gsh¬dnum
 << " sh¬ds, fÜ " << 
	gsh¬ded_edges
 << "ƒdges";

904 
as£¹
(
sh¬dnum
 <ğ
nsh¬ds
);

905 
ä“
(
sškbufãr
);

906 
	gsškbufãr
 = 
NULL
;

909 
	g¡d
::
¡ršg
 
âame
 = 
f’ame_š‹rv®s
(
ba£f’ame
, 
nsh¬ds
);

910 
FILE
 * 
	gf
 = 
fİ’
(
âame
.
c_¡r
(), "w");

912 ià(
	gf
 =ğ
NULL
) {

913 
log¡»am
(
LOG_ERROR
è<< "Could‚Ù o³Àfe: " << 
âame
 << "ƒrror: " <<

914 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

916 
as£¹
(
f
 !ğ
NULL
);

917 
	gi
=0; i<()
	gš‹rv®s
.
size
(); i++) {

918 
årštf
(
f
, "%u\n", 
š‹rv®s
[
i
].
£cÚd
);

920 
fşo£
(
f
);

923 
	g¡d
::
¡ršg
 
numv_f’ame
 = 
ba£f’ame
 + ".numvertices";

924 
	gf
 = 
fİ’
(
numv_f’ame
.
c_¡r
(), "w");

925 
årštf
(
f
, "%u\n", 1 + 
max_v”‹x_id
);

926 
fşo£
(
f
);

938 
vœtu®
 
wr™e_sh¬ds
() {

940 
size_t
 
	gmembudg‘_mb
 = (size_tè
g‘_İtiÚ_št
("membudget_mb", 1024);

944 
boŞ
 
	gcouÁ_deg»es_šmem
 = 
membudg‘_mb
 * 1024 * 1024 / 3 > 
max_v”‹x_id
 * (
deg»e
);

945 
	gdeg»es
 = 
NULL
;

946 #ifdeà
DYNAMICEDATA


947 ià(!
	gcouÁ_deg»es_šmem
) {

951 
log¡»am
(
LOG_WARNING
è<< "DyÇmiøedgd©¨suµÜˆÚly sh¬dšg wh’hv”‹x deg»e ÿÀbcompu‹d in-memÜy." << 
	g¡d
::
’dl
;

952 
log¡»am
(
LOG_WARNING
è<< "Iàth´og¿m g‘ v”y slow (¡¬t sw­pšg),hd©¨sizi toØbig." << 
	g¡d
::
’dl
;

953 
	gcouÁ_deg»es_šmem
 = 
Œue
;

956 ià(
	gcouÁ_deg»es_šmem
) {

957 
	gdeg»es
 = (
deg»e
 *è
ÿÎoc
(1 + 
max_v”‹x_id
, (degree));

961 
	gsh¬ded_edges
 = 0;

962 
	gedges_³r_sh¬d
 = 
shov–ed_edges
 / 
nsh¬ds
 + 1;

963 
	gsh¬d_ÿ·c™y
 = 
edges_³r_sh¬d
 / 2 * 3;

964 
	gsh¬dnum
 = 0;

965 
	gthis_š‹rv®_¡¬t
 = 0;

966 
	gsškbufãr
 = (
edge_w™h_v®ue
<
EdgeD©aTy³
> *è
ÿÎoc
(
sh¬d_ÿ·c™y
, (edge_with_value<EdgeDataType>));

967 
log¡»am
(
LOG_INFO
è<< "Edge ³¸sh¬d: " << 
	gedges_³r_sh¬d
 << "‚sh¬ds=" << 
	gnsh¬ds
 << "Ù®: " << 
	gshov–ed_edges
 << 
	g¡d
::
’dl
;

968 
	gcur_sh¬d_couÁ”
 = 0;

971 
size_t
 
	gB
 = 
membudg‘_mb
 * 1024 * 1024 / 2 / 
numshov–s
;

972 
	gB
 % (
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
>è!ğ0è
B
++;

973 
log¡»am
(
LOG_INFO
è<< "Bufã¸sizš m”gpha£: " << 
	gB
 << 
	g¡d
::
’dl
;

974 
	g´evvid
 = (-1);

975 
	g¡d
::
veùÜ
< 
m”ge_sourû
<
edge_w™h_v®ue
<
EdgeD©aTy³
> > *> 
sourûs
;

976 
	gi
=0; i < 
	gnumshov–s
; i++) {

977 
	gsourûs
.
push_back
(
Ãw
 
shov–_m”ge_sourû
<
EdgeD©aTy³
>(
B
, 
shov–_f’ame
(
i
)));

980 
	gkway_m”ge
<
	gedge_w™h_v®ue
<
	gEdgeD©aTy³
> > 
m”g”
(
sourûs
, 
this
);

981 
	gm”g”
.
m”ge
();

984 
	gi
=0; i < ()
	gsourûs
.
size
(); i++) {

985 
d–‘e
 (
shov–_m”ge_sourû
<
EdgeD©aTy³
> *)
	gsourûs
[
i
];

989 ià(!
	gcouÁ_deg»es_šmem
) {

990 #iâdeà
DYNAMICEDATA


992 
ü—‹_deg»e_fe
();

996 
	g¡d
::
¡ršg
 
deg»eâame
 = 
f’ame_deg»e_d©a
(
ba£f’ame
);

997 
	gdeg»eOutF
 = 
İ’
(
deg»eâame
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

998 ià(
	gdeg»eOutF
 < 0) {

999 
log¡»am
(
LOG_ERROR
è<< "Could‚Ù c»©e: " << 
	gdeg»eOutF
 << 
	g¡d
::
’dl
;

1000 
as£¹
(
deg»eOutF
 >= 0);

1003 
wr™—
(
deg»eOutF
, 
deg»es
, (
deg»e
è* (1 + 
max_v”‹x_id
));

1004 
ä“
(
deg»es
);

1005 
şo£
(
deg»eOutF
);

1011 
	tdummy_t
;

1013 
	g¦idšg_sh¬d
<, 
	tdummy_t
> 
	t¦idšgsh¬d_t
;

1014 
	gmemÜy_sh¬d
<, 
	tdummy_t
> 
	tmemsh¬d_t
;

1017 #iâdeà
DYNAMICEDATA


1018 
ü—‹_deg»e_fe
() {

1020 
¡redio
 * 
	giomgr
 = 
Ãw
 sŒedio(
m
);

1021 
	g¡d
::
veùÜ
<
¦idšgsh¬d_t
 * > 
¦idšg_sh¬ds
;

1023 
	gsubwšdow
 = 5000000;

1024 
	gm
.
£t
("subwšdow", (
size_t
)
subwšdow
);

1026 
	glßdth»ads
 = 4;

1028 
	gm
.
¡¬t_time
("degrees.runtime");

1031 
	gblocksize
 = 
com´es£d_block_size
;

1033 
	gp
=0;… < 
	gnsh¬ds
;…++) {

1034 
log¡»am
(
LOG_INFO
è<< "In™Ÿliz¡»amšg sh¬d: " << 
	gp
 << 
	g¡d
::
’dl
;

1035 
	g¦idšg_sh¬ds
.
push_back
(

1036 
Ãw
 
¦idšgsh¬d_t
(
iomgr
, 
f’ame_sh¬d_ed©a
<
dummy_t
>(
ba£f’ame
, 
p
, 
nsh¬ds
),

1037 
f’ame_sh¬d_adj
(
ba£f’ame
, 
p
, 
nsh¬ds
), 
š‹rv®s
[p].
fœ¡
,

1038 
š‹rv®s
[
p
].
£cÚd
,

1039 
blocksize
, 
m
, 
Œue
,rue));

1042 
g¿phchi_cÚ‹xt
 
	ggšfo
;

1043 
	ggšfo
.
	gnv”tiûs
 = 1 + 
š‹rv®s
[
nsh¬ds
 - 1].
£cÚd
;

1044 
	ggšfo
.
	gscheduËr
 = 
NULL
;

1046 
	g¡d
::
¡ršg
 
ouutâame
 = 
f’ame_deg»e_d©a
(
ba£f’ame
);

1048 
	gdeg»eOutF
 = 
İ’
(
ouutâame
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

1049 ià(
	gdeg»eOutF
 < 0) {

1050 
log¡»am
(
LOG_ERROR
è<< "Could‚Ù c»©e: " << 
	gdeg»eOutF
 << 
	g¡d
::
’dl
;

1052 
as£¹
(
deg»eOutF
 >= 0);

1053 
	gŒ”r
 = 
árunÿ‹
(
deg»eOutF
, 
gšfo
.
nv”tiûs
 * () * 2);

1054 
as£¹
(
Œ”r
 == 0);

1055 ià(
	gŒ”r
 != 0) {

1056 
log¡»am
(
LOG_FATAL
è<< "Could‚Ùrunÿ‹!" << 
¡d
::
’dl
;

1057 
ex™
(0);

1060 
	gwšdow
=0; wšdow<
	gnsh¬ds
; window++) {

1061 
m‘rics_’Œy
 
	gmwi
 = 
m
.
¡¬t_time
();

1063 
vid_t
 
	gš‹rv®_¡
 = 
š‹rv®s
[
wšdow
].
fœ¡
;

1064 
vid_t
 
	gš‹rv®_’
 = 
š‹rv®s
[
wšdow
].
£cÚd
;

1067 
	g¦idšg_sh¬ds
[
wšdow
]->
æush
();

1070 
memsh¬d_t
 
memsh¬d
(
iomgr
, 
f’ame_sh¬d_ed©a
<
Fš®EdgeD©aTy³
>(
ba£f’ame
, 
wšdow
, 
nsh¬ds
), 
f’ame_sh¬d_adj
(basefilename, window,‚shards),

1071 
š‹rv®_¡
, 
š‹rv®_’
, 
blocksize
, 
m
);

1072 
	gmemsh¬d
.
	gÚly_adjaûncy
 = 
Œue
;

1073 
log¡»am
(
LOG_INFO
è<< "IÁ”v®: " << 
	gš‹rv®_¡
 << " " << 
	gš‹rv®_’
 << 
	g¡d
::
’dl
;

1075 
vid_t
 
	gsubš‹rv®_¡
=
š‹rv®_¡
; subš‹rv®_¡ <ğ
š‹rv®_’
; ) {

1076 
vid_t
 
	gsubš‹rv®_’
 = 
¡d
::
mš
(
š‹rv®_’
, 
subš‹rv®_¡
 + 
subwšdow
);

1077 
log¡»am
(
LOG_INFO
è<< "(Deg»´oc.èSub-wšdow: [" << 
	gsubš‹rv®_¡
 << " - " << 
	gsubš‹rv®_’
 << "]" << 
	g¡d
::
’dl
;

1078 
as£¹
(
subš‹rv®_’
 >ğ
subš‹rv®_¡
 && subš‹rv®_’ <ğ
š‹rv®_’
);

1081 
m‘rics_’Œy
 
	gm’
 = 
m
.
¡¬t_time
();

1082 
	gnv”tiûs
 = 
subš‹rv®_’
 - 
subš‹rv®_¡
 + 1;

1083 
	g¡d
::
veùÜ
< 
g¿phchi_v”‹x
<, 
	gdummy_t
> > 
v”tiûs
(
nv”tiûs
, g¿phchi_v”‹x<, 
dummy_t
>());

1086 
	gi
=0; i < 
	gnv”tiûs
; i++) {

1087 
	gv”tiûs
[
i
] = 
g¿phchi_v”‹x
<, 
	gdummy_t
>(
	gsubš‹rv®_¡
 + 
	gi
, 
	gNULL
, NULL, 0, 0);

1088 
	gv”tiûs
[
i
].
	gscheduËd
 = 
Œue
;

1091 
m‘rics_’Œy
 
	gme
 = 
m
.
¡¬t_time
();

1092 
omp_£t_num_th»ads
(
lßdth»ads
);

1093 #´agm¨
omp
 
·¿Î–
 

1094 
	gp
=-1;… < 
	gnsh¬ds
;…++) {

1095 ià(
	gp
 == (-1)) {

1097 ià(
memsh¬d
.
lßded
(è=ğ
çl£
) {

1098 
memsh¬d
.
lßd
();

1102 
	gmemsh¬d
.
lßd_v”tiûs
(
subš‹rv®_¡
, 
subš‹rv®_’
, 
v”tiûs
);

1105 ià(
	gp
 !ğ
wšdow
) {

1106 
¦idšg_sh¬ds
[
p
]->
»ad_Ãxt_v”tiûs
(
nv”tiûs
, 
subš‹rv®_¡
, 
v”tiûs
, 
çl£
);

1111 
	gm
.
¡İ_time
(
me
, "¡»am_ah—d", 
wšdow
);

1114 
m‘rics_’Œy
 
	gmev
 = 
m
.
¡¬t_time
();

1117 * 
	gvbuf
 = (*è
m®loc
(
nv”tiûs
 * () * 2);

1119 
	gi
=0; i<
	gnv”tiûs
; i++) {

1120 
	gvbuf
[2 * 
i
] = 
v”tiûs
[i].
num_šedges
();

1121 
	gvbuf
[2 * 
i
 +1] = 
v”tiûs
[i].
num_ou‹dges
();

1123 
pwr™—
(
deg»eOutF
, 
vbuf
, 
nv”tiûs
 * (è* 2, 
subš‹rv®_¡
 * () * 2);

1125 
ä“
(
vbuf
);

1128 
	gsubš‹rv®_¡
 = 
subš‹rv®_’
+1;

1131 
	g¦idšg_sh¬ds
[
wšdow
]->
£t_off£t
(
memsh¬d
.
off£t_fÜ_¡»am_cÚt
(), memsh¬d.
off£t_vid_fÜ_¡»am_cÚt
(),

1132 
memsh¬d
.
ed©a_±r_fÜ_¡»am_cÚt
());

1134 
şo£
(
deg»eOutF
);

1135 
	gm
.
¡İ_time
("degrees.runtime");

1136 
d–‘e
 
	giomgr
;

1140 
	g‹m¶©e
 <
ty³Çme
 
	gA
,y³Çm
	gB
,y³Çm
	gC
> 
ä›nd
 
şass
 
	gsh¬ded_g¿ph_ouut
;

1147 
	g‹m¶©e
 <
ty³Çme
 
	gVT
,y³Çm
	gET
,y³Çm
	gETFš®
=
ET
>

1148 
şass
 
sh¬ded_g¿ph_ouut
 : 
public
 
iouut
<
VT
, 
	gET
> {

1150 
	gsh¬d”
<
	gETFš®
> * 
	gsh¬d”obj
;

1151 
mu‹x
 
	glock
;

1152 
size_t
 
	gnum_edges_
;

1154 
	gpublic
:

1155 
sh¬ded_g¿ph_ouut
(
¡d
::
¡ršg
 
f’ame
, 
Du¶iÿ‹EdgeF‹r
<
ETFš®
> * 
f‹r
 = 
NULL
è: 
num_edges_
(0) {

1156 
sh¬d”obj
 = 
Ãw
 
sh¬d”
<
ETFš®
>(
f’ame
);

1157 
	gsh¬d”obj
->
£t_du¶iÿ‹_f‹r
(
f‹r
);

1158 
	gsh¬d”obj
->
¡¬t_´•roûssšg
();

1161 ~
sh¬ded_g¿ph_ouut
() {

1162 
d–‘e
 
	gsh¬d”obj
;

1163 
	gsh¬d”obj
 = 
NULL
;

1168 
	gpublic
:

1169 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
) {

1170 
as£¹
(
çl£
);

1174 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
v®ue
) {

1175 
as£¹
(
çl£
);

1178 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
v®ue
) {

1179 
as£¹
(
çl£
);

1183 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
v®ue
) {

1184 
as£¹
(
çl£
);

1187 
vœtu®
 
ouut_edge
(
vid_t
 
äom
, vid_ˆ
to
, 
size_t
 
v®ue
) {

1188 
as£¹
(
çl£
);

1191 
ouut_edgev®
(
vid_t
 
äom
, vid_ˆ
to
, 
ETFš®
 
v®ue
) {

1192 
	glock
.
lock
();

1193 
	gsh¬d”obj
->
´•roûssšg_add_edge
(
äom
, 
to
, 
v®ue
);

1194 
	gnum_edges_
++;

1195 
	glock
.
uÆock
();

1200 
ouut_v®ue
(
vid_t
 
vid
, 
VT
 
v®ue
) {

1201 
as£¹
(
çl£
);

1205 
şo£
() {

1208 
size_t
 
num_edges
() {

1209  
	gnum_edges_
;

1212 
size_t
 
fšish_sh¬dšg
() {

1213 
	gsh¬d”obj
->
’d_´•roûssšg
();

1215 
	gsh¬d”obj
->
execu‹_sh¬dšg
("auto");

1216  
	gsh¬d”obj
->
	gnsh¬ds
;

	@preprocessing/sharder_basic.cpp

29 
	~<io¡»am
>

30 
	~<¡dlib.h
>

31 
	~<¡ršg
>

32 
	~<as£¹.h
>

34 
	~"logg”/logg”.hµ
"

35 
	~"´•roûssšg/cÚv”siÚs.hµ
"

36 
	~"´•roûssšg/sh¬d”.hµ
"

37 
	~"ut/cmdİts.hµ
"

39 
usšg
 
Çme¥aû
 
	gg¿phchi
;

43 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

44 
	`g¿phchi_š™
(
¬gc
, 
¬gv
);

46 
	`glob®_logg”
().
	`£t_log_Ëv–
(
LOG_DEBUG
);

48 
¡d
::
¡ršg
 
ba£fe
 = 
	`g‘_İtiÚ_¡ršg_š‹¿ùive
("file", "[pathohe input graph]");

49 
¡d
::
¡ršg
 
edge_d©a_ty³
 = 
	`g‘_İtiÚ_¡ršg_š‹¿ùive
("edgedatatype", "int, uint, short, float, char, double, boolean,†ong, float-float, int-int,‚one");

50 
¡d
::
¡ršg
 
nsh¬ds_¡r
 = 
	`g‘_İtiÚ_¡ršg_š‹¿ùive
("nshards", "Number of shardso create, or 'auto'");

52 ià(
edge_d©a_ty³
 == "float") {

53 
cÚv”t
<, >(
ba£fe
, 
nsh¬ds_¡r
);

54 } ià(
edge_d©a_ty³
 == "float-float") {

55 
cÚv”t
<
PaœCÚš”
<>, PaœCÚš”<> >(
ba£fe
, 
nsh¬ds_¡r
);

56 } ià(
edge_d©a_ty³
 == "int") {

57 
cÚv”t
<, >(
ba£fe
, 
nsh¬ds_¡r
);

58 } ià(
edge_d©a_ty³
 == "uint") {

59 
cÚv”t
<, >(
ba£fe
, 
nsh¬ds_¡r
);

60 } ià(
edge_d©a_ty³
 == "int-int") {

61 
cÚv”t
<
PaœCÚš”
<>, PaœCÚš”<> >(
ba£fe
, 
nsh¬ds_¡r
);

62 } ià(
edge_d©a_ty³
 == "short") {

63 
cÚv”t
<, >(
ba£fe
, 
nsh¬ds_¡r
);

64 } ià(
edge_d©a_ty³
 == "double") {

65 
cÚv”t
<, >(
ba£fe
, 
nsh¬ds_¡r
);

66 } ià(
edge_d©a_ty³
 == "char") {

67 
cÚv”t
<, >(
ba£fe
, 
nsh¬ds_¡r
);

68 } ià(
edge_d©a_ty³
 == "boolean") {

69 
cÚv”t
<
boŞ
, boŞ>(
ba£fe
, 
nsh¬ds_¡r
);

70 } ià(
edge_d©a_ty³
 == "long") {

71 
cÚv”t
<, >(
ba£fe
, 
nsh¬ds_¡r
);

72 } ià(
edge_d©a_ty³
 == "none") {

73 
	`cÚv”t_nÚe
(
ba£fe
, 
nsh¬ds_¡r
);

75 
	`log¡»am
(
LOG_ERROR
) << "You‚eedo specifyƒdgedatatype. Currently supported: int, short, float, char, double, boolean,†ong.";

80 
	}
}

	@preprocessing/util/orderbydegree.hpp

11 #iâdeà
DEF_GRAPHCHI_ORDERBYDEGREE


12 
	#DEF_GRAPH


	)

14 
Çme¥aû
 
	gg¿phchi
 {

16 
	sv”‹x_deg»e
 {

17 
	gdeg
;

18 
vid_t
 
	gid
;

19 
v”‹x_deg»e
() {}

20 
v”‹x_deg»e
(
deg
, 
vid_t
 
id
) : deg(deg), id(id) {}

22 
boŞ
 
v”‹x_deg»e_Ëss
(cÚ¡ 
v”‹x_deg»e
 &
a
, cÚ¡ v”‹x_deg»&
b
);

23 
boŞ
 
v”‹x_deg»e_Ëss
(cÚ¡ 
v”‹x_deg»e
 &
a
, cÚ¡ v”‹x_deg»&
b
) {

24  
	ga
.
	gdeg
 < 
	gb
.deg || (a.deg =ğ
b
.
deg
 && 
a
.
id
 < b.id);

31 
	g‹m¶©e
 <
ty³Çme
 
	gVT
,y³Çm
	gET
>

32 
şass
 
	g¥ecŸl_sh¬dšg_v”‹x
 : 
public
 
g¿phchi_v”‹x
<
VT
, 
	gET
> {

33 
	gpublic
:

35 
sh¬d”
<
ET
, 
	gET
> * 
	gsh¬d”obj
;

36 
vid_t
 * 
	gŒª¦©‘abË
;

37 
¥ecŸl_sh¬dšg_v”‹x
() {}

38 
¥ecŸl_sh¬dšg_v”‹x
(
sh¬d”
<
ET
, ET> * 
_sh¬d”obj
, 
vid_t
 
_id
, vid_ˆ* 
_Œª¦©‘abË
è: 
g¿phchi_v”‹x
<
VT
, 
	gET
> (
	g_id
, 
	gNULL
, NULL, 0, 0) {

39 
	gthis
->
	gsh¬d”obj
 = 
_sh¬d”obj
;

40 
	gthis
->
	gŒª¦©‘abË
 = 
_Œª¦©‘abË
;

44 
add_šedge
(
vid_t
 
¤c
, 
ET
 * 
±r
, 
boŞ
 
¥ecŸl_edge
) {

45 
	gsh¬d”obj
->
´•roûssšg_add_edge
(
Œª¦©‘abË
[
¤c
],¿n¦©‘abË[
this
->
id
()]);

50 
add_ou‹dge
(
vid_t
 
d¡
, 
ET
 * 
±r
, 
boŞ
 
¥ecŸl_edge
) {

58 
	g‹m¶©e
 <
ty³Çme
 
	gEdgeD©aTy³
>

59 
Üd”_by_deg»e
(
¡d
::
¡ršg
 &
ba£_f’ame
, 
nsh¬ds
, 
m‘rics
 &
m
) {

61 
	g¡d
::
¡ršg
 
deg»e_f’ame
 = 
f’ame_deg»e_d©a
(
ba£_f’ame
);

63 
deg»e
 * 
	gdeg»es
;

64 
	gf
 = 
İ’
(
deg»e_f’ame
.
c_¡r
(), 
O_RDONLY
);

65 
as£¹
(
f
);

67 
size_t
 
	gnv”ts
 = 
»adfuÎ
<
deg»e
>(
f
, &
	gdeg»es
è/ (
	gdeg»e
);

68 
log¡»am
(
LOG_INFO
è<< "S¹šgØÜd” by deg»es,‚umb” oàv”tiûs: " << 
	gnv”ts
 << 
	g¡d
::
’dl
;

71 
v”‹x_deg»e
 * 
	gdeg¬¿y
 = 
Ãw
 v”‹x_deg»e[
nv”ts
];

72 
vid_t
 
	gi
=0; i < 
	gnv”ts
; i++) {

73 
	gdeg¬¿y
[
i
].
	gid
 = i;

74 
	gdeg¬¿y
[
i
].
	gdeg
 = 
deg»es
[i].
šdeg»e
 + deg»es[i].
outdeg»e
;

77 
d–‘e
 
	gdeg»es
;

78 
	gdeg»es
 = 
NULL
;

80 
log¡»am
(
LOG_INFO
è<< "SÜtšg deg»es... " << 
	g¡d
::
’dl
;

83 
quickSÜt
(
deg¬¿y
, ()
nv”ts
, 
v”‹x_deg»e_Ëss
);

86 
vid_t
 * 
	gŒª¦©e_bË
 = 
Ãw
 vid_t[
nv”ts
];

87 
vid_t
 
	gi
=0; i<
	gnv”ts
; i++) {

88 
	gŒª¦©e_bË
[
deg¬¿y
[
i
].
	gid
] = i;

90 
	gd–‘e
[] 
	gdeg¬¿y
;

92 
log¡»am
(
LOG_INFO
è<< "C»©ed¿n¦©iÚabË. " << 
	g¡d
::
’dl
;

94 
	g¡d
::
¡ršg
 
Œª¦©e_bË_fe
 = 
ba£_f’ame
 + ".vertexmap";

95 
	gdf
 = 
İ’
(
Œª¦©e_bË_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

96 ià(
	gdf
 < 0è
log¡»am
(
LOG_ERROR
è<< "Could‚Ù wr™v”‹x m­: " << 
	gŒª¦©e_bË_fe
 <<

97 "ƒ¼Ü: " << 
¡»¼Ü
(
”ºo
è<< 
	g¡d
::
’dl
;

98 
as£¹
(
df
 >= 0);

99 
pwr™—
(
df
, 
Œª¦©e_bË
, 
nv”ts
 * (
vid_t
), 0);

100 
şo£
(
df
);

102 
log¡»am
(
LOG_INFO
è<< "T¿n¦©iÚ m­ saved iÁØfe: " << 
	gŒª¦©e_bË_fe
 << 
	g¡d
::
’dl
;

106 
¡redio
 * 
	giomgr
 = 
Ãw
 sŒedio(
m
);

109 
	g¡d
::
veùÜ
<
¡d
::
·œ
<
vid_t
, 
	gvid_t
> > 
	gš‹rv®s
;

110 
lßd_v”‹x_š‹rv®s
(
ba£_f’ame
, 
nsh¬ds
, 
š‹rv®s
);

112 
	g¡d
::
¡ršg
 
cÚv”‹df’ame
 = 
ba£_f’ame
 + "_degord";

115 
	gsh¬d”
<
	gEdgeD©aTy³
, EdgeD©aTy³> 
sh¬d”obj
(
cÚv”‹df’ame
);

116 
	gsh¬d”obj
.
¡¬t_´•roûssšg
();

119 
	gp
=0;…<
	gnsh¬ds
;…++) {

120 
log¡»am
(
LOG_INFO
è<< "R•roûssšg sh¬d " << 
	gp
 << 
	g¡d
::
’dl
;

121 
size_t
 
	gnv”tiûs
 = 
š‹rv®s
[
p
].
£cÚd
 - iÁ”v®s[p].
fœ¡
 + 1;

122 
	g¡d
::
veùÜ
<
¥ecŸl_sh¬dšg_v”‹x
<, 
	gEdgeD©aTy³
> > 
v”tiûs
(
nv”tiûs
, s³cŸl_sh¬dšg_v”‹x<, 
EdgeD©aTy³
>());

123 
size_t
 
	gj
=0; j<
	gv”tiûs
.
size
(); j++) {

124 
	gv”tiûs
[
j
] = 
¥ecŸl_sh¬dšg_v”‹x
<, 
	gEdgeD©aTy³
>(&
	gsh¬d”obj
, (
	gvid_t
è(
	gš‹rv®s
[
p
].
	gfœ¡
 + 
	gj
), 
	gŒª¦©e_bË
);

125 
	gv”tiûs
[
j
].
	gscheduËd
 = 
Œue
;

127 
	gmemÜy_sh¬d
<, 
	gEdgeD©aTy³
, 
	g¥ecŸl_sh¬dšg_v”‹x
<, EdgeD©aTy³> > 
memsh¬d
(
iomgr
, 
f’ame_sh¬d_ed©a
<
EdgeD©aTy³
>(
ba£_f’ame
, 
p
, 
nsh¬ds
),

128 
f’ame_sh¬d_adj
(
ba£_f’ame
, 
p
, 
nsh¬ds
),

129 
š‹rv®s
[
p
].
fœ¡
, iÁ”v®s[p].
£cÚd
, 1024 * 1024, 
m
);

130 
	gmemsh¬d
.
	gÚly_adjaûncy
 = 
Œue
;

131 
	gmemsh¬d
.
di§bË_·¿Î–_lßdšg
();

132 
	gmemsh¬d
.
lßd
();

133 
	gmemsh¬d
.
lßd_v”tiûs
(
š‹rv®s
[
p
].
fœ¡
, iÁ”v®s[p].
£cÚd
, 
v”tiûs
);

136 
	gsh¬d”obj
.
’d_´•roûssšg
();

137 
d–‘e
 
	giomgr
;

138 
	gd–‘e
[] 
	gŒª¦©e_bË
;

141 
	g¡d
::
¡ršg¡»am
 
ss
; 
	gss
 << 
	gnsh¬ds
;

142  
	gsh¬d”obj
.
execu‹_sh¬dšg
(
ss
.
¡r
());

	@shards/dynamicdata/dynamicblock.hpp

29 #iâdeà
g¿phchi_xcode_dyÇmicblock_hµ


30 
	#g¿phchi_xcode_dyÇmicblock_hµ


	)

32 
	~<¡dšt.h
>

34 
Çme¥aû
 
	gg¿phchi
 {

36 
g‘_block_uncom´es£d_size
(
¡d
::
¡ršg
 
blockf’ame
, 
deçuÉsize
);

37 
g‘_block_uncom´es£d_size
(
¡d
::
¡ršg
 
blockf’ame
, 
deçuÉsize
) {

38 
	g¡d
::
¡ršg
 
szf’ame
 = 
blockf’ame
 + ".bsize";

39 
FILE
 * 
	gf
 = 
fİ’
(
szf’ame
.
c_¡r
(), "r");

40 ià(
	gf
 !ğ
NULL
) {

41 
sz
;

42 
ä—d
(&
sz
, 1, (), 
f
);

43 
fşo£
(
f
);

44  
	gsz
;

46  
	gdeçuÉsize
;

50 
wr™e_block_uncom´es£d_size
(
¡d
::
¡ršg
 
blockf’ame
, 
size
);

51 
wr™e_block_uncom´es£d_size
(
¡d
::
¡ršg
 
blockf’ame
, 
size
) {

52 
	g¡d
::
¡ršg
 
szf’ame
 = 
blockf’ame
 + ".bsize";

53 
FILE
 * 
	gf
 = 
fİ’
(
szf’ame
.
c_¡r
(), "w");

54 
fwr™e
(&
size
, 1, (), 
f
);

55 
fşo£
(
f
);

57 ià(
	gsize
 > 20000000) {

58 
log¡»am
(
LOG_DEBUG
è<< "Block " << 
	gblockf’ame
 << " size:" << 
	gsize
 << 
	g¡d
::
’dl
;

62 
d–‘e_block_uncom´es£d_sizefe
(
¡d
::
¡ršg
 
blockf’ame
);

63 
d–‘e_block_uncom´es£d_sizefe
(
¡d
::
¡ršg
 
blockf’ame
) {

64 
¡d
::
¡ršg
 
szf’ame
 = 
blockf’ame
 + ".bsize";

65 
	g”r
 = 
»move
(
szf’ame
.
c_¡r
());

66 ià(
	g”r
 != 0) {

73 
	g‹m¶©e
 <
ty³Çme
 
	gET
>

74 
	sdyÇmicd©a_block
 {

75 
	gn™ems
;

76 
ušt8_t
 * 
	gd©a
;

77 
ET
 * 
	gchivecs
;

79 
dyÇmicd©a_block
(è: 
d©a
(
NULL
), 
chivecs
(NULL) {}

81 
dyÇmicd©a_block
(
n™ems
, 
ušt8_t
 * 
d©a
, 
d©asize
) :‚items(nitems){

82 
chivecs
 = 
Ãw
 
ET
[
n™ems
];

83 
ušt8_t
 * 
	g±r
 = 
d©a
;

84 
	gi
=0; i < 
	gn™ems
; i++) {

85 
as£¹
(
±r
 - 
d©a
 <ğ
d©asize
);

86 
ty³Çme
 
	gET
::
sizewÜd_t
 * 
sz
 = (Ñy³Çm
ET
::sizewÜd_ˆ*è
±r
);

87 
	g±r
 +ğ(
ty³Çme
 
ET
::
sizewÜd_t
);

88 
	gchivecs
[
i
] = 
ET
(((
ušt16_t
 *)
sz
)[0], ((ušt16_ˆ*)sz)[1], (
ty³Çme
 ET::
–em’t_ty³_t
 *è
±r
);

89 
	g±r
 +ğ(è((
ušt16_t
 *)
sz
)[1] * (
ty³Çme
 
ET
::
–em’t_ty³_t
);

93 
ET
 * 
edgevec
(
i
) {

94 
as£¹
(
i
 < 
n™ems
);

95 
as£¹
(
chivecs
 !ğ
NULL
);

96  &
	gchivecs
[
i
];

99 
wr™e
(
ušt8_t
 ** 
outd©a
, & 
size
) {

101 
	gsize
 = 0;

102 
	gi
=0; i < 
	gn™ems
; i++) {

103 
	gsize
 +ğ
chivecs
[
i
].
ÿ·c™y
(è* (
ty³Çme
 
ET
::
–em’t_ty³_t
è+ Ñy³ÇmET::
sizewÜd_t
);

106 *
	goutd©a
 = (
ušt8_t
 *è
m®loc
(
size
);

107 
ušt8_t
 * 
	g±r
 = *
outd©a
;

108 
	gi
=0; i < 
	gn™ems
; i++) {

109 
	gET
 & 
	gvec
 = 
chivecs
[
i
];

110 ((
	gušt16_t
 *è
	g±r
)[0] = 
vec
.
size
();

111 ((
	gušt16_t
 *è
	g±r
)[1] = 
vec
.
ÿ·c™y
();

113 
	g±r
 +ğ(
ty³Çme
 
ET
::
sizewÜd_t
);

114 
	gvec
.
wr™e
((
ty³Çme
 
ET
::
–em’t_ty³_t
 *è
±r
);

115 
	g±r
 +ğ
vec
.
ÿ·c™y
(è* (
ty³Çme
 
ET
::
–em’t_ty³_t
);

119 ~
dyÇmicd©a_block
() {

120 ià(
	gchivecs
 !ğ
NULL
) {

121 
d–‘e
 [] 
chivecs
;

	@shards/dynamicdata/memoryshard.hpp

30 #iâdeà
DEF_GRAPHCHI_MEMSHARD


31 
	#DEF_GRAPHCHI_MEMSHARD


	)

34 
	~<io¡»am
>

35 
	~<c¡dio
>

36 
	~<s¡»am
>

37 
	~<veùÜ
>

38 
	~<fú.h
>

39 
	~<uni¡d.h
>

40 
	~<as£¹.h
>

41 
	~<¡ršg
>

43 
	~"­i/g¿ph_objeùs.hµ
"

44 
	~"m‘rics/m‘rics.hµ
"

45 
	~"io/¡redio.hµ
"

46 
	~"g¿phchi_ty³s.hµ
"

47 
	~"sh¬ds/dyÇmicd©a/dyÇmicblock.hµ
"

49 
Çme¥aû
 
	gg¿phchi
 {

52 
	g‹m¶©e
 <
ty³Çme
 
	gVT
,y³Çm
	gET
,y³Çm
	gsv”‹x_t
 = 
g¿phchi_v”‹x
<
VT
, ET> >

53 şas 
	cmemÜy_sh¬d
 {

55 
¡redio
 * 
	giomgr
;

57 
	g¡d
::
¡ršg
 
f’ame_ed©a
;

58 
	g¡d
::
¡ršg
 
f’ame_adj
;

60 
vid_t
 
	g¿nge_¡
;

61 
vid_t
 
	g¿nge_’d
;

62 
size_t
 
	gadjfesize
;

63 
size_t
 
	ged©afesize
;

65 
size_t
 
	gedg•Œ
;

66 
vid_t
 
	g¡»amšg_off£t_vid
;

67 
size_t
 
	g¡»amšg_off£t
;

68 
size_t
 
	g¿nge_¡¬t_off£t
;

69 
size_t
 
	g¿nge_¡¬t_edge_±r
;

70 
size_t
 
	g¡»amšg_off£t_edge_±r
;

71 
ušt8_t
 * 
	gadjd©a
;

72 ** 
	gedged©a
;

73 
	g¡d
::
veùÜ
<
size_t
> 
blocksizes
;

74 
	g¡d
::
veùÜ
< 
dyÇmicd©a_block
<
ET
> * > 
dyÇmicblocks
;

75 
ušt64_t
 
	gchunkid
;

77 
	g¡d
::
veùÜ
<> 
block_ed©a£ssiÚs
;

78 
	gadj_£ssiÚ
;

80 
boŞ
 
	gis_lßded
;

81 
size_t
 
	gblocksize
;

82 
	gm‘rics
 &
	gm
;

84 
boŞ
 
	gdi§bË_async_wr™es
;

87 
	gpublic
:

88 
boŞ
 
Úly_adjaûncy
;

91 
memÜy_sh¬d
(
¡redio
 * 
iomgr
,

92 
¡d
::
¡ršg
 
_f’ame_ed©a
,

93 
¡d
::
¡ršg
 
_f’ame_adj
,

94 
vid_t
 
_¿nge_¡¬t
,

95 
vid_t
 
_¿nge_’d
,

96 
size_t
 
_blocksize
,

97 
m‘rics
 &
_m
è: 
iomgr
(iomgr), 
f’ame_ed©a
(
_f’ame_ed©a
),

98 
f’ame_adj
(
_f’ame_adj
),

99 
¿nge_¡
(
_¿nge_¡¬t
), 
¿nge_’d
(
_¿nge_’d
), 
blocksize
(
_blocksize
), 
m
(
_m
) {

100 
	gadjd©a
 = 
NULL
;

101 
	gÚly_adjaûncy
 = 
çl£
;

102 
	gis_lßded
 = 
çl£
;

103 
	gdi§bË_async_wr™es
ğ
çl£
;

104 
	gadj_£ssiÚ
 = -1;

105 
	gedged©a
 = 
NULL
;

109 ~
memÜy_sh¬d
() {

110 
	gnblocks
 = (è
block_ed©a£ssiÚs
.
size
();

112 
	gi
=0; i < 
	gnblocks
; i++) {

113 ià(
	gedged©a
[
i
] !ğ
NULL
) {

114 
iomgr
->
mªaged_»Ëa£
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i]);

115 
	giomgr
->
şo£_£ssiÚ
(
block_ed©a£ssiÚs
[
i
]);

118 ià(
	gdyÇmicblocks
[
i
] !ğ
NULL
)

119 
d–‘e
 
dyÇmicblocks
[
i
];

120 
	gdyÇmicblocks
[
i
] = 
NULL
;

122 
	gdyÇmicblocks
.
ş—r
();

123 ià(
	gadj_£ssiÚ
 >= 0) {

124 ià(
adjd©a
 !ğ
NULL
è
iomgr
->
mªaged_»Ëa£
(
adj_£ssiÚ
, &adjdata);

125 
	giomgr
->
şo£_£ssiÚ
(
adj_£ssiÚ
);

127 ià(
	gedged©a
 !ğ
NULL
)

128 
ä“
(
edged©a
);

129 
	gedged©a
 = 
NULL
;

133 
£t_di§bË_async_wr™es
(
boŞ
 
b
) {

134 
	gdi§bË_async_wr™es
 = 
b
;

138 
wr™e_ªd_»Ëa£_block
(
i
) {

139 
	g¡d
::
¡ršg
 
block_f’ame
 = 
f’ame_sh¬d_ed©a_block
(
f’ame_ed©a
, 
i
, 
blocksize
);

141 
	gdyÇmicd©a_block
<
	gET
> * 
	gdynblock
 = 
dyÇmicblocks
[
i
];

142 ià(
	gdynblock
 !ğ
NULL
) {

143 
ušt8_t
 * 
outd©a
;

144 
	goutsize
;

145 
	gdynblock
->
wr™e
(&
outd©a
, 
outsize
);

146 
wr™e_block_uncom´es£d_size
(
block_f’ame
, 
outsize
);

147 
	giomgr
->
mªaged_pwr™—_now
(
block_ed©a£ssiÚs
[
i
], &
outd©a
, 
outsize
, 0);

148 
	giomgr
->
mªaged_»Ëa£
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i]);

149 
	giomgr
->
şo£_£ssiÚ
(
block_ed©a£ssiÚs
[
i
]);

150 
ä“
(
outd©a
);

151 
d–‘e
 
	gdynblock
;

153 
	gdyÇmicblocks
[
i
] = 
NULL
;

157 
comm™
(
boŞ
 
comm™_šedges
, boŞ 
comm™_ou‹dges
) {

158 ià(
	gblock_ed©a£ssiÚs
.
size
(è=ğ0 || 
Úly_adjaûncy
) ;

159 
as£¹
(
is_lßded
);

160 
m‘rics_’Œy
 
	gcm
 = 
m
.
¡¬t_time
();

168 
	gnblocks
 = (è
block_ed©a£ssiÚs
.
size
();

170 ià(
	gcomm™_šedges
) {

171 
	gi
=0; i < 
	gnblocks
; i++) {

173 
wr™e_ªd_»Ëa£_block
(
i
);

174 
	gedged©a
[
i
] = 
NULL
;

176 } ià(
	gcomm™_ou‹dges
) {

177 
size_t
 
	gÏ¡
 = 
¡»amšg_off£t_edge_±r
;

178 ià(
	gÏ¡
 == 0){

180 
Ï¡
 = 
ed©afesize
;

183 
	g¡¬tblock
 = (è(
¿nge_¡¬t_edge_±r
 / 
blocksize
);

184 
	g’dblock
 = (è(
Ï¡
 / 
blocksize
);

185 
	gi
=0; i < 
	gnblocks
; i++) {

186 ià(
	gi
 >ğ
¡¬tblock
 && 
i
 <ğ
’dblock
) {

187 
wr™e_ªd_»Ëa£_block
(
i
);

189 
	giomgr
->
mªaged_»Ëa£
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i]);

191 
	gedged©a
[
i
] = 
NULL
;

192 
	giomgr
->
şo£_£ssiÚ
(
block_ed©a£ssiÚs
[
i
]);

195 
	gm
.
¡İ_time
(
cm
, "memshard_commit");

197 
	giomgr
->
mªaged_»Ëa£
(
adj_£ssiÚ
, &
adjd©a
);

199 
	gi
=0; i < 
	gnblocks
; i++) {

200 ià(
	gedged©a
[
i
] !ğ
NULL
) {

201 
iomgr
->
mªaged_»Ëa£
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i]);

204 
	gblock_ed©a£ssiÚs
.
ş—r
();

205 
	gis_lßded
 = 
çl£
;

208 
boŞ
 
lßded
() {

209  
	gis_lßded
;

212 
	g´iv©e
:

215 
lßd_ed©a
() {

216 
boŞ
 
async_šedged©a_lßdšg
 = 
çl£
;

217 
as£¹
(
blocksize
 % () == 0);

218 
	gnblocks
 = (è(
ed©afesize
 / 
blocksize
 + (edatafilesize % blocksize != 0));

219 
	gedged©a
 = (**è
ÿÎoc
(
nblocks
, (*));

220 
size_t
 
	gcom´es£dsize
 = 0;

221 
	gblockid
 = 0;

224 
	gŒue
) {

225 
	g¡d
::
¡ršg
 
block_f’ame
 = 
f’ame_sh¬d_ed©a_block
(
f’ame_ed©a
, 
blockid
, 
blocksize
);

226 ià(
fe_exi¡s
(
block_f’ame
)) {

227 
size_t
 
	gfsize
 = 
g‘_block_uncom´es£d_size
(
block_f’ame
, 
¡d
::
mš
(
ed©afesize
 - 
blocksize
 * 
blockid
, blocksize));

228 
	gcom´es£dsize
 +ğ
g‘_fesize
(
block_f’ame
);

229 
	gblock£ssiÚ
 = 
iomgr
->
İ’_£ssiÚ
(
block_f’ame
, 
çl£
, 
Œue
);

230 
	gblock_ed©a£ssiÚs
.
push_back
(
block£ssiÚ
);

231 
	gblocksizes
.
push_back
(
fsize
);

232 
	gedged©a
[
blockid
] = 
NULL
;

233 
	giomgr
->
mªaged_m®loc
(
block£ssiÚ
, &
edged©a
[
blockid
], 
fsize
, 0);

234 ià(
	gasync_šedged©a_lßdšg
) {

235 
as£¹
(
çl£
);

237 
	giomgr
->
mªaged_´—da_now
(
block£ssiÚ
, &
edged©a
[
blockid
], 
fsize
, 0);

239 
	gdyÇmicblocks
.
push_back
(
NULL
);

241 
	gblockid
++;

244 ià(
	gblockid
 == 0) {

245 
log¡»am
(
LOG_ERROR
è<< "Sh¬d block fdid‚Ùƒxi¡s:" << 
block_f’ame
 << 
¡d
::
’dl
;

250 
as£¹
(
blockid
 =ğ
nblocks
);

251 
log¡»am
(
LOG_DEBUG
è<< "Com´es£d/fuÎ size: " << 
	gcom´es£dsize
 * 1.0 / 
	ged©afesize
 <<

252 "‚umb” oàblocks: " << 
	gnblocks
 << 
	g¡d
::
’dl
;

256 
check_block_š™Ÿlized
(
blockid
) {

257 ià(
	gdyÇmicblocks
[
blockid
] =ğ
NULL
) {

258 
¡d
::
¡ršg
 
block_f’ame
 = 
f’ame_sh¬d_ed©a_block
(
f’ame_ed©a
, 
blockid
, 
blocksize
);

259 
size_t
 
	gfsize
 = 
g‘_block_uncom´es£d_size
(
block_f’ame
, 
¡d
::
mš
(
ed©afesize
 - 
blocksize
 * 
blockid
, blocksize));

260 
	gÃdges
 = 
¡d
::
mš
(
ed©afesize
 - 
blocksize
 * 
blockid
, blocksize) / ();

261 
	gdyÇmicblocks
[
blockid
] = 
Ãw
 
dyÇmicd©a_block
<
ET
>(
Ãdges
, (
	gušt8_t
*è
	gedged©a
[blockid], 
	gfsize
);

266 
	gpublic
:

269 
lßd
() {

270 
is_lßded
 = 
Œue
;

271 
	gadjfesize
 = 
g‘_fesize
(
f’ame_adj
);

272 
	ged©afesize
 = 
g‘_sh¬d_ed©a_fesize
<
ET
>(
f’ame_ed©a
);

274 #ifdeà
SUPPORT_DELETIONS


275 
	gasync_šedged©a_lßdšg
 = 
çl£
;

281 
	gadj_£ssiÚ
 = 
iomgr
->
İ’_£ssiÚ
(
f’ame_adj
, 
Œue
);

282 
	giomgr
->
mªaged_m®loc
(
adj_£ssiÚ
, &
adjd©a
, 
adjfesize
, 0);

284 
size_t
 
	gbufsize
 = 16 * 1204 * 1024;

285 
	gn
 = (è(
adjfesize
 / 
bufsize
 + 1);

287 #´agm¨
omp
 
·¿Î–
 

288 
	gi
=0; i < 
	gn
; i++) {

289 
size_t
 
	gtÜ—d
 = 
¡d
::
mš
(
adjfesize
 - 
i
 * 
bufsize
, (size_t)bufsize);

290 
	giomgr
->
´—da_now
(
adj_£ssiÚ
, 
adjd©a
 + 
i
 * 
bufsize
, 
tÜ—d
, i * bufsize, 
Œue
);

295 ià(!
	gÚly_adjaûncy
) {

296 
lßd_ed©a
();

304 
lßd_v”tiûs
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
¡d
::
veùÜ
<
sv”‹x_t
> & 
´—Îoc
, 
boŞ
 
šedges
=
Œue
, boŞ 
ou‹dges
=true) {

306 
m
.
¡¬t_time
("memoryshard_create_edges");

308 
as£¹
(
adjd©a
 !ğ
NULL
);

311 
ušt8_t
 * 
	g±r
 = 
adjd©a
;

312 
ušt8_t
 * 
	g’d
 = 
±r
 + 
adjfesize
;

313 
vid_t
 
	gvid
 = 0;

314 
	gedg•Œ
 = 0;

316 
	g¡»amšg_off£t
 = 0;

317 
	g¡»amšg_off£t_vid
 = 0;

318 
	g¡»amšg_off£t_edge_±r
 = 0;

319 
	g¿nge_¡¬t_off£t
 = 
adjfesize
;

320 
	g¿nge_¡¬t_edge_±r
 = 
ed©afesize
;

322 
boŞ
 
	g£toff£t
 = 
çl£
;

323 
boŞ
 
	g£Œªgeoff£t
 = 
çl£
;

324 
	g±r
 < 
	g’d
) {

325 ià(!
	g£toff£t
 && 
	gvid
 > 
	g¿nge_’d
) {

328 
	g¡»amšg_off£t
 = 
±r
-
adjd©a
;

329 
	g¡»amšg_off£t_vid
 = 
vid
;

330 
	g¡»amšg_off£t_edge_±r
 = 
edg•Œ
;

331 
	g£toff£t
 = 
Œue
;

333 ià(!
	g£Œªgeoff£t
 && 
	gvid
>=
¿nge_¡
) {

334 
¿nge_¡¬t_off£t
 = 
±r
-
adjd©a
;

335 
	g¿nge_¡¬t_edge_±r
 = 
edg•Œ
;

336 
	g£Œªgeoff£t
 = 
Œue
;

339 
ušt8_t
 
	gns
 = *
±r
;

340 
	gn
;

342 
	g±r
 +ğ(
ušt8_t
);

344 ià(
	gns
 == 0x00) {

346 
ušt8_t
 
nz
 = *
±r
;

347 
	g±r
 +ğ(
ušt8_t
);

348 
	gvid
++;

349 
	gvid
 +ğ
nz
;

353 ià(
	gns
 == 0xff) {

354 
n
 = *((
ušt32_t
*)
±r
);

355 
	g±r
 +ğ(
ušt32_t
);

357 
	gn
 = 
ns
;

359 
sv”‹x_t
* 
	gv”‹x
 = 
NULL
;

361 ià(
	gvid
>=
wšdow_¡
 && 
vid
 <=
wšdow_’
) {

362 
v”‹x
 = &
´—Îoc
[
vid
-
wšdow_¡
];

363 ià(!
	gv”‹x
->
	gscheduËd
èv”‹x = 
NULL
;

365 
boŞ
 
	gªy_edges
 = 
çl£
;

366 --
	gn
>=0) {

367 
blockid
 = (è(
edg•Œ
 / 
blocksize
);

369 
vid_t
 
	grg‘
 = *((vid_t*è
±r
);

370 
	g±r
 +ğ(
vid_t
);

371 ià(
	gv”‹x
 !ğ
NULL
 && 
ou‹dges
)

373 
check_block_š™Ÿlized
(
blockid
);

374 
	gv”‹x
->
add_ou‹dge
(
rg‘
, (
Úly_adjaûncy
 ? 
NULL
 : 
dyÇmicblocks
[
blockid
]->
edgevec
((
edg•Œ
 % 
blocksize
)/())), 
çl£
);

377 ià(
	grg‘
 >ğ
wšdow_¡
) {

378 ià(
rg‘
 <ğ
wšdow_’
) {

379 ià(
šedges
) {

380 
sv”‹x_t
 & 
d¡v”‹x
 = 
´—Îoc
[
rg‘
 - 
wšdow_¡
];

381 ià(
	gd¡v”‹x
.
	gscheduËd
) {

382 
	gªy_edges
 = 
Œue
;

384 
check_block_š™Ÿlized
(
blockid
);

385 
ET
 * 
	g•Œ
 = (
Úly_adjaûncy
 ? 
NULL
 : 
dyÇmicblocks
[
blockid
]->
edgevec
((
edg•Œ
 % 
blocksize
)/()));

387 
	gd¡v”‹x
.
add_šedge
(
vid
, (
Úly_adjaûncy
 ? 
NULL
 : 
•Œ
), 
çl£
);

388 
	gd¡v”‹x
.
	g·¿Î–_§ã
 = 
d¡v”‹x
.
·¿Î–_§ã
 && (
v”‹x
 =ğ
NULL
);

393 ià(
	gv”‹x
 =ğ
NULL
) {

394 
±r
 +ğ(
vid_t
è* 
n
;

395 
	gedg•Œ
 +ğ(
n
 + 1) * ();

400 
	gedg•Œ
 += ();

404 ià(
	gªy_edges
 && 
	gv”‹x
 !ğ
NULL
) {

405 
v”‹x
->
·¿Î–_§ã
 = 
çl£
;

407 
	gvid
++;

409 
	gm
.
¡İ_time
("memÜysh¬d_ü—‹_edges", 
çl£
);

412 
size_t
 
off£t_fÜ_¡»am_cÚt
() {

413  
	g¡»amšg_off£t
;

415 
vid_t
 
off£t_vid_fÜ_¡»am_cÚt
() {

416  
	g¡»amšg_off£t_vid
;

418 
size_t
 
ed©a_±r_fÜ_¡»am_cÚt
() {

419  
	g¡»amšg_off£t_edge_±r
;

	@shards/dynamicdata/slidingshard.hpp

30 #iâdeà
DEF_GRAPHCHI_SLIDINGSHARD


31 
	#DEF_GRAPHCHI_SLIDINGSHARD


	)

34 
	~<io¡»am
>

35 
	~<c¡dio
>

36 
	~<s¡»am
>

37 
	~<veùÜ
>

38 
	~<fú.h
>

39 
	~<uni¡d.h
>

40 
	~<as£¹.h
>

41 
	~<¡ršg
>

43 
	~"­i/g¿ph_objeùs.hµ
"

44 
	~"m‘rics/m‘rics.hµ
"

45 
	~"logg”/logg”.hµ
"

46 
	~"io/¡redio.hµ
"

47 
	~"g¿phchi_ty³s.hµ
"

49 
	~"­i/dyÇmicd©a/chiveùÜ.hµ
"

50 
	~"sh¬ds/dyÇmicd©a/dyÇmicblock.hµ
"

53 
Çme¥aû
 
	gg¿phchi
 {

58 
	g‹m¶©e
 <
ty³Çme
 
	gET
>

59 
	ssblock
 {

61 
	gwr™edesc
;

62 
	g»addesc
;

63 
size_t
 
	goff£t
;

64 
size_t
 
	g’d
;

65 
ušt8_t
 * 
	gd©a
;

66 
ušt8_t
 * 
	g±r
;

67 
boŞ
 
	gaùive
;

68 
boŞ
 
	gis_ed©a_block
;

69 
	g¡d
::
¡ršg
 
blockf’ame
;

70 
	gdyÇmicd©a_block
<
	gET
> * 
	gdynblock
;

72 
sblock
(è: 
wr™edesc
(0), 
»addesc
(0), 
aùive
(
çl£
è{ 
	gd©a
 = 
NULL
; 
	gdynblock
 = NULL; }

73 
sblock
(
wdesc
, 
rdesc
, 
boŞ
 
is_ed©a_block
=
çl£
è: 
wr™edesc
(wdesc), 
»addesc
Ôdesc), 
aùive
(false),

74 
is_ed©a_block
(is_ed©a_block){ 
	gd©a
 = 
NULL
; 
	gdynblock
 = NULL; }

75 
sblock
(
wdesc
, 
rdesc
, 
boŞ
 
is_ed©a_block
, 
¡d
::
¡ršg
 
blockf’ame
è: 
wr™edesc
(wdesc), 
»addesc
Ôdesc), 
aùive
(
çl£
),

76 
is_ed©a_block
(is_ed©a_block), 
blockf’ame
(blockfilename) {

77 
as£¹
(
is_ed©a_block
 =ğ
Œue
);

78 
	gd©a
 = 
NULL
;

79 
	gdynblock
 = 
NULL
;

82 
comm™_async
(
¡redio
 * 
iomgr
) {

83 
comm™_now
(
iomgr
);

84 
»Ëa£
(
iomgr
);

87 
comm™_now
(
¡redio
 * 
iomgr
) {

88 ià(
	gaùive
 && 
	gd©a
 !ğ
NULL
 && 
wr™edesc
 >= 0) {

89 
size_t
 
Ën
 = 
±r
-
d©a
;

90 ià(
	gËn
 > 
	g’d
-
	goff£t
èËÀğ
’d
-
off£t
;

91 ià(
	gis_ed©a_block
) {

92 
ušt8_t
 * 
	goutd©a
 = 
NULL
;

93 
	g»®size
;

94 
	gdynblock
->
wr™e
(&
outd©a
, 
»®size
);

95 
wr™e_block_uncom´es£d_size
(
blockf’ame
, 
»®size
);

96 
	giomgr
->
mªaged_pwr™—_now
(
wr™edesc
, &
outd©a
, 
»®size
, 0);

97 
ä“
(
outd©a
);

99 
	giomgr
->
mªaged_pwr™—_now
(
wr™edesc
, &
d©a
, 
Ën
, 
off£t
);

103 
»ad_async
(
¡redio
 * 
iomgr
) {

104 
as£¹
(
çl£
);

106 
»ad_now
(
¡redio
 * 
iomgr
) {

107 ià(
	gis_ed©a_block
) {

108 
	g»®size
 = 
g‘_block_uncom´es£d_size
(
blockf’ame
, 
’d
-
off£t
);

109 
	giomgr
->
mªaged_´—da_now
(
»addesc
, &
d©a
, 
»®size
, 0);

110 
	gÃdges
 = (
’d
 - 
off£t
) / ();

111 
	gdynblock
 = 
Ãw
 
dyÇmicd©a_block
<
ET
>(
Ãdges
, (
	gušt8_t
 *è
	gd©a
, 
	g»®size
);

113 
	giomgr
->
mªaged_´—da_now
(
»addesc
, &
d©a
, 
’d
 - 
off£t
, offset);

117 
»Ëa£
(
¡redio
 * 
iomgr
) {

118 ià(
	gd©a
 !ğ
NULL
) {

119 
iomgr
->
mªaged_»Ëa£
(
»addesc
, &
d©a
);

121 ià(
	gis_ed©a_block
) {

122 
	giomgr
->
şo£_£ssiÚ
(
»addesc
);

124 ià(
	gdynblock
 !ğ
NULL
) {

125 
d–‘e
 
dynblock
;

126 
	gdynblock
 = 
NULL
;

128 
	gd©a
 = 
NULL
;

134 
	sšdex’Œy
 {

135 
size_t
 
	gadjoff£t
, 
	ged©aoff£t
;

136 
šdex’Œy
(
size_t
 
a
, size_ˆ
e
è: 
adjoff£t
×), 
ed©aoff£t
(e) {}

144 
	g‹m¶©e
 <
ty³Çme
 
	gVT
,y³Çm
	gET
,y³Çm
	gsv”‹x_t
 = 
g¿phchi_v”‹x
<
VT
, ET>,y³Çm
	gET¥ecŸl
 = 
ET
>

145 şas 
	c¦idšg_sh¬d
 {

147 
¡redio
 * 
iomgr
;

149 
	g¡d
::
¡ršg
 
f’ame_ed©a
;

150 
	g¡d
::
¡ršg
 
f’ame_adj
;

151 
vid_t
 
	g¿nge_¡
, 
	g¿nge_’d
;

152 
size_t
 
	gblocksize
;

154 
vid_t
 
	gcurvid
;

155 
size_t
 
	gadjoff£t
, 
	ged©aoff£t
, 
	gadjfesize
, 
	ged©afesize
;

156 
size_t
 
	gwšdow_¡¬t_ed©aoff£t
;

158 
	g¡d
::
veùÜ
<
sblock
<
ET
> > 
aùiveblocks
;

159 
	gadjfe_£ssiÚ
;

160 
	gwr™edesc
;

161 
	gsblock
<
	gET
> * 
	gcurblock
;

162 
	gsblock
<
	gET
> * 
	gcu¿djblock
;

163 
	gm‘rics
 &
	gm
;

165 
	g¡d
::
m­
<, 
	gšdex’Œy
> 
	g¥¬£_šdex
;

166 
boŞ
 
	gdi§bË_wr™es
;

167 
boŞ
 
	gdi§bË_async_wr™es
;

168 
boŞ
 
	gasync_ed©a_lßdšg
;

172 
	gpublic
:

173 
boŞ
 
Úly_adjaûncy
;

175 
¦idšg_sh¬d
(
¡redio
 * 
iomgr
, 
¡d
::
¡ršg
 
_f’ame_ed©a
, std::¡ršg 
_f’ame_adj
, 
vid_t
 
_¿nge_¡
, vid_ˆ
_¿nge_’
, 
size_t
 
_blocksize
, 
m‘rics
 &
_m
,

176 
boŞ
 
_di§bË_wr™es
=
çl£
, boŞ 
Úlyadj
 = false) :

177 
iomgr
(iomgr),

178 
f’ame_ed©a
(
_f’ame_ed©a
),

179 
f’ame_adj
(
_f’ame_adj
),

180 
¿nge_¡
(
_¿nge_¡
),

181 
¿nge_’d
(
_¿nge_’
),

182 
blocksize
(
_blocksize
),

183 
m
(
_m
),

184 
di§bË_wr™es
(
_di§bË_wr™es
) {

185 
	gcurvid
 = 0;

186 
	gadjoff£t
 = 0;

187 
	ged©aoff£t
 = 0;

188 
	gdi§bË_wr™es
 = 
çl£
;

189 
	gÚly_adjaûncy
 = 
Úlyadj
;

190 
	gcurblock
 = 
NULL
;

191 
	gcu¿djblock
 = 
NULL
;

192 
	gwšdow_¡¬t_ed©aoff£t
 = 0;

193 
	gdi§bË_async_wr™es
 = 
çl£
;

195 
	gblocksize
 % (è!ğ0è
blocksize
++;

196 
as£¹
(
blocksize
 % ()==0);

198 
	gadjfesize
 = 
g‘_fesize
(
f’ame_adj
);

199 
	ged©afesize
 = 
g‘_sh¬d_ed©a_fesize
<>(
f’ame_ed©a
);

200 ià(!
	gÚly_adjaûncy
) {

201 
log¡»am
(
LOG_DEBUG
è<< "TÙ®ƒdgd©¨size: " << 
	ged©afesize
 << 
	g¡d
::
’dl
;

206 
	gadjfe_£ssiÚ
 = 
iomgr
->
İ’_£ssiÚ
(
f’ame_adj
, 
Œue
);

207 
§ve_off£t
();

209 
	gasync_ed©a_lßdšg
 = 
çl£
;

213 ~
¦idšg_sh¬d
() {

214 
»Ëa£_´iÜ_to_off£t
(
Œue
);

215 ià(
	gcurblock
 !ğ
NULL
) {

216 
curblock
->
»Ëa£
(
iomgr
);

217 
d–‘e
 
	gcurblock
;

218 
	gcurblock
 = 
NULL
;

220 ià(
	gcu¿djblock
 !ğ
NULL
) {

221 
cu¿djblock
->
»Ëa£
(
iomgr
);

222 
d–‘e
 
	gcu¿djblock
;

223 
	gcu¿djblock
 = 
NULL
;

227 
	giomgr
->
şo£_£ssiÚ
(
adjfe_£ssiÚ
);

231 
size_t
 
num_edges
() {

232  
	ged©afesize
 / (
	gET
);

235 
	g´Ùeùed
:

236 
size_t
 
g‘_adjoff£t
(è{  
adjoff£t
; }

237 
size_t
 
g‘_ed©aoff£t
(è{  
	ged©aoff£t
; }

239 
§ve_off£t
() {

242 
	g¥¬£_šdex
.
š£¹
(
¡d
::
·œ
<, 
šdex’Œy
>(-(()
curvid
), index’Œy(
adjoff£t
, 
ed©aoff£t
)));

245 
move_şo£_to
(
vid_t
 
v
) {

246 ià(
	gcurvid
 >ğ
v
) ;

248 
	g¡d
::
m­
<,
	gšdex’Œy
>::
™”©Ü
 
low”bd_™”
 = 
¥¬£_šdex
.
low”_bound
(-(()
v
));

249 
	gşo£¡_vid
 = -(()
low”bd_™”
->
fœ¡
);

250 
as£¹
(
şo£¡_vid
>=0);

251 
šdex’Œy
 
	gşo£¡_off£t
 = 
low”bd_™”
->
£cÚd
;

252 
as£¹
(
şo£¡_vid
 <ğ()
v
);

253 ià(
	gşo£¡_vid
 > ()
	gcurvid
) {

254 
log¡»am
(
LOG_DEBUG
)

255 << "Slidšg sh¬d, s¹: " << 
	g¿nge_¡
 << " movedo: " << 
	gşo£¡_vid
 << " " << 
	gşo£¡_off£t
.
	gadjoff£t
 << ",‡sked fÜ : " << 
	gv
 << " wa š: curvidğ" << 
	gcurvid
 << " " <<‡djoff£ˆ<< 
	g¡d
::
’dl
;

256 ià(
	gcurblock
 !ğ
NULL
)

257 
curblock
->
±r
 +ğ
şo£¡_off£t
.
ed©aoff£t
 -ƒdataoffset;

258 ià(
	gcu¿djblock
 !ğ
NULL
)

259 
cu¿djblock
->
±r
 +ğ
şo£¡_off£t
.
adjoff£t
 -‡djoffset;

260 
	gcurvid
 = (
vid_t
)
şo£¡_vid
;

261 
	gadjoff£t
 = 
şo£¡_off£t
.
adjoff£t
;

262 
	ged©aoff£t
 = 
şo£¡_off£t
.
ed©aoff£t
;

271 
šlše
 
check_curblock
(
size_t
 
tÜ—d
) {

272 ià(
	gcurblock
 =ğ
NULL
 || 
curblock
->
’d
 < 
ed©aoff£t
+
tÜ—d
) {

273 ià(
curblock
 !ğ
NULL
) {

274 ià(!
curblock
->
aùive
) {

275 
curblock
->
»Ëa£
(
iomgr
);

279 
	g¡d
::
¡ršg
 
blockf’ame
 = 
f’ame_sh¬d_ed©a_block
(
f’ame_ed©a
, (è(
ed©aoff£t
 / 
blocksize
), blocksize);

280 
	ged©a_£ssiÚ
 = 
iomgr
->
İ’_£ssiÚ
(
blockf’ame
, 
çl£
, 
Œue
);

281 
	gsblock
<
	gET
> 
Ãwblock
(
ed©a_£ssiÚ
,ƒd©a_£ssiÚ, 
Œue
, 
blockf’ame
);

285 
	gÃwblock
.
	goff£t
 = (
ed©aoff£t
 / 
blocksize
) * blocksize;

286 
size_t
 
	gcÜ»ùiÚ
 = 
ed©aoff£t
 - 
Ãwblock
.
off£t
;

287 
	gÃwblock
.
	g’d
 = 
¡d
::
mš
(
ed©afesize
, 
Ãwblock
.
off£t
 + 
blocksize
);

288 
as£¹
(
Ãwblock
.
’d
 >ğÃwblock.
off£t
);

289 
	g»®size
 = 
g‘_block_uncom´es£d_size
(
blockf’ame
, 
Ãwblock
.
’d
 -‚ewblock.
off£t
);

290 
	giomgr
->
mªaged_m®loc
(
ed©a_£ssiÚ
, &
Ãwblock
.
d©a
, 
»®size
,‚ewblock.
off£t
);

291 
	gÃwblock
.
	g±r
 = 
Ãwblock
.
d©a
 + 
cÜ»ùiÚ
;

292 
	gaùiveblocks
.
push_back
(
Ãwblock
);

293 
	gcurblock
 = &
aùiveblocks
[aùiveblocks.
size
()-1];

294 
	gcurblock
->
	gaùive
 = 
Œue
;

295 
	gcurblock
->
»ad_now
(
iomgr
);

299 
šlše
 
check_adjblock
(
size_t
 
tÜ—d
) {

300 ià(
	gcu¿djblock
 =ğ
NULL
 || 
cu¿djblock
->
’d
 <ğ
adjoff£t
 + 
tÜ—d
) {

301 ià(
cu¿djblock
 !ğ
NULL
) {

302 
cu¿djblock
->
»Ëa£
(
iomgr
);

303 
d–‘e
 
	gcu¿djblock
;

304 
	gcu¿djblock
 = 
NULL
;

306 
	gsblock
<
	gET
> * 
	gÃwblock
 = 
Ãw
 
sblock
<
ET
>(0, 
	gadjfe_£ssiÚ
);

307 
	gÃwblock
->
	goff£t
 = 
adjoff£t
;

308 
	gÃwblock
->
	g’d
 = 
¡d
::
mš
(
adjfesize
, 
adjoff£t
+
blocksize
);

309 
as£¹
(
Ãwblock
->
’d
 > 0);

310 
as£¹
(
Ãwblock
->
’d
 >ğÃwblock->
off£t
);

311 
	giomgr
->
mªaged_m®loc
(
adjfe_£ssiÚ
, &
Ãwblock
->
d©a
,‚ewblock->
’d
 -‚ewblock->
off£t
, 
adjoff£t
);

312 
	gÃwblock
->
	g±r
 = 
Ãwblock
->
d©a
;

313 
m‘rics_’Œy
 
	gme
 = 
m
.
¡¬t_time
();

314 
	giomgr
->
mªaged_´—da_now
(
adjfe_£ssiÚ
, &
Ãwblock
->
d©a
,‚ewblock->
’d
 -‚ewblock->
off£t
, 
adjoff£t
);

315 
	gm
.
¡İ_time
(
me
, "blockload");

316 
	gcu¿djblock
 = 
Ãwblock
;

320 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

321 
šlše
 
U
 
»ad_v®
() {

322 
check_adjblock
((
U
));

323 
U
 
	g»s
 = *((U*)
cu¿djblock
->
±r
);

324 
	gadjoff£t
 +ğ(
U
);

325 
	gcu¿djblock
->
	g±r
 +ğ(
U
);

326  
	g»s
;

329 
šlše
 
ET
 * 
»ad_edg•Œ
() {

330 ià(
	gÚly_adjaûncy
è 
	gNULL
;

331 
check_curblock
(());

332 
	ged©aoff£t
 += ();

333 
	gblockedgeidx
 = (
curblock
->
±r
 - curblock->
d©a
) / ();

334 
	gcurblock
->
	g±r
 += ();

335 
as£¹
(
curblock
->
dynblock
 !ğ
NULL
);

336  
	gcurblock
->
	gdynblock
->
edgevec
(
blockedgeidx
);

339 
šlše
 
sk
(
n
, 
sz
) {

340 
size_t
 
	gtÙ
 = 
n
 * 
sz
;

341 
	gadjoff£t
 +ğ
tÙ
;

342 ià(
	gcu¿djblock
 !ğ
NULL
)

343 
cu¿djblock
->
±r
 +ğ
tÙ
;

344 
	ged©aoff£t
 +ğ(è* 
n
;

345 ià(
	gcurblock
 !ğ
NULL
)

346 
curblock
->
±r
 +ğ(è* 
n
;

349 
	gpublic
:

353 
»ad_Ãxt_v”tiûs
(
nvecs
, 
vid_t
 
¡¬t
, 
¡d
::
veùÜ
<
sv”‹x_t
> & 
´—Îoc
, 
boŞ
 
»cÜd_šdex
=
çl£
, boŞ 
di§bË_wr™es
=false) {

356 
m‘rics_’Œy
 
me
 = 
m
.
¡¬t_time
();

357 ià(!
	g»cÜd_šdex
)

358 
move_şo£_to
(
¡¬t
);

361 
	gcurblock
 = 
NULL
;

362 
»Ëa£_´iÜ_to_off£t
(
çl£
, 
di§bË_wr™es
);

363 
as£¹
(
aùiveblocks
.
size
() <= 1);

366 ià(!
	gaùiveblocks
.
em±y
(è&& !
	gÚly_adjaûncy
) {

367 
	gcurblock
 = &
aùiveblocks
[0];

369 
vid_t
 
	gÏ¡»c
 = 
¡¬t
;

370 
	gwšdow_¡¬t_ed©aoff£t
 = 
ed©aoff£t
;

372 
	gi
=(()
curvid
è- (()
¡¬t
); i<
	gnvecs
; i++) {

373 ià(
	gadjoff£t
 >ğ
adjfesize
) ;

377 
	gn
;

378 ià(
	g»cÜd_šdex
 && (
	gsize_t
)(
	gcurvid
 - 
	gÏ¡»c
è>ğ(
size_t
è
¡d
::
max
(()100000, 
nvecs
/16)) {

379 
§ve_off£t
();

380 
	gÏ¡»c
 = 
curvid
;

382 
ušt8_t
 
	gns
 = 
»ad_v®
<uint8_t>();

383 ià(
	gns
 == 0x00) {

384 
curvid
++;

385 
ušt8_t
 
	gnz
 = 
»ad_v®
<uint8_t>();

386 
	gcurvid
 +ğ
nz
;

387 
	gi
 +ğ
nz
;

391 ià(
	gns
 == 0xff) {

392 
n
 = 
»ad_v®
<
ušt32_t
>();

394 
	gn
 = 
ns
;

397 ià(
	gi
<0) {

399 
sk
(
n
, (
vid_t
));

401 
	gsv”‹x_t
& 
	gv”‹x
 = 
´—Îoc
[
i
];

402 
as£¹
(
v”‹x
.
id
(è=ğ
curvid
);

404 ià(
	gv”‹x
.
	gscheduËd
) {

406 --
	gn
 >= 0) {

407 
boŞ
 
¥ecŸl_edge
 = 
çl£
;

408 
vid_t
 
	grg‘
 = ((
ET
è=ğ(
ET¥ecŸl
è? 
»ad_v®
<vid_t>(è: 
Œª¦©e_edge
Ô—d_v®<vid_t>(), 
¥ecŸl_edge
));

409 
ET
 * 
	gev®ue
 = 
»ad_edg•Œ
();

412 
	gv”‹x
.
add_ou‹dge
(
rg‘
, 
ev®ue
, 
¥ecŸl_edge
);

414 ià(!((
	grg‘
 >ğ
¿nge_¡
 && 
rg‘
 <ğ
¿nge_’d
))) {

415 
log¡»am
(
LOG_ERROR
è<< "E¼Ü : " << 
rg‘
 << "‚Ù iÀ[" << 
¿nge_¡
 << " - " << 
¿nge_’d
 << "]" << 
¡d
::
’dl
;

416 
	giomgr
->
´št_£ssiÚ
(
adjfe_£ssiÚ
);

418 
as£¹
(
rg‘
 >ğ
¿nge_¡
 &&¬g‘ <ğ
¿nge_’d
);

423 
sk
(
n
, (
vid_t
));

426 
	gcurvid
++;

428 
	gm
.
¡İ_time
(
me
, "read_next_vertices");

429 
	gcurblock
 = 
NULL
;

436 
comm™
(
sblock
<
ET
> &
b
, 
boŞ
 
synchrÚou¦y
, boŞ 
di§bË_wr™es
=
çl£
) {

437 ià(
di§bË_async_wr™es
è
synchrÚou¦y
 = 
Œue
;

438 ià(
	gsynchrÚou¦y
) {

439 
m‘rics_’Œy
 
	gme
 = 
m
.
¡¬t_time
();

440 ià(!
	gdi§bË_wr™es
è
	gb
.
comm™_now
(
iomgr
);

441 
	gm
.
¡İ_time
(
me
, "commit");

442 
	gb
.
»Ëa£
(
iomgr
);

444 ià(!
	gdi§bË_wr™es
è
	gb
.
comm™_async
(
iomgr
);

445 
	gb
.
»Ëa£
(
iomgr
);

449 
š™d©a
() {

450 
log¡»am
(
LOG_FATAL
è<< "š™d©a(ènÙ im¶em’‹d fÜ dyÇmiøedgd©a" << 
	g¡d
::
’dl
;

451 
as£¹
(
çl£
);

458 
æush
() {

459 
»Ëa£_´iÜ_to_off£t
(
Œue
);

460 ià(
	gcu¿djblock
 !ğ
NULL
) {

461 
cu¿djblock
->
»Ëa£
(
iomgr
);

462 
d–‘e
 
	gcu¿djblock
;

463 
	gcu¿djblock
 = 
NULL
;

470 
£t_off£t
(
size_t
 
Ãwoff
, 
vid_t
 
_curvid
, size_ˆ
edg•Œ
) {

471 
	gthis
->
	gadjoff£t
 = 
Ãwoff
;

472 
	gthis
->
	gcurvid
 = 
_curvid
;

473 
	gthis
->
	ged©aoff£t
 = 
edg•Œ
;

474 ià(
	gcu¿djblock
 !ğ
NULL
) {

475 
cu¿djblock
->
»Ëa£
(
iomgr
);

476 
d–‘e
 
	gcu¿djblock
;

477 
	gcu¿djblock
 = 
NULL
;

484 
»Ëa£_´iÜ_to_off£t
(
boŞ
 
®l
=
çl£
, boŞ 
di§bË_wr™es
=false) {

485 
i
=()
aùiveblocks
.
size
(è- 1; 
	gi
 >= 0; i--) {

486 
	gsblock
<
	gET
> &
	gb
 = 
aùiveblocks
[
i
];

487 ià(
	gb
.
	g’d
 <ğ
ed©aoff£t
 || 
®l
) {

488 
comm™
(
b
, 
®l
, 
di§bË_wr™es
);

489 
	gaùiveblocks
.
”a£
(
aùiveblocks
.
begš
(è+ ()
i
);

494 
£t_di§bË_async_wr™es
(
boŞ
 
b
) {

495 
	gdi§bË_async_wr™es
 = 
b
;

499 
	g¡d
::
¡ršg
 
g‘_šfo_jsÚ
() {

500 
¡d
::
¡ršg¡»am
 
jsÚ
;

501 
	gjsÚ
 << "\"size\": ";

502 
	gjsÚ
 << 
	ged©afesize
 << 
	g¡d
::
’dl
;

503 
	gjsÚ
 << ", \"windowStart\": ";

504 
	gjsÚ
 << 
	gwšdow_¡¬t_ed©aoff£t
;

505 
	gjsÚ
 << ", \"windowEnd\": ";

506 
	gjsÚ
 << 
	ged©aoff£t
;

507 
	gjsÚ
 << ", \"intervalStart\": ";

508 
	gjsÚ
 << 
	g¿nge_¡
;

509 
	gjsÚ
 << ", \"intervalEnd\": ";

510 
	gjsÚ
 << 
	g¿nge_’d
;

511  
	gjsÚ
.
¡r
();

	@shards/memoryshard.hpp

29 #ifdeà
DYNAMICEDATA


30 
	~"sh¬ds/dyÇmicd©a/memÜysh¬d.hµ
"

33 #iâdeà
DEF_GRAPHCHI_MEMSHARD


34 
	#DEF_GRAPHCHI_MEMSHARD


	)

37 
	~<io¡»am
>

38 
	~<c¡dio
>

39 
	~<s¡»am
>

40 
	~<veùÜ
>

41 
	~<fú.h
>

42 
	~<uni¡d.h
>

43 
	~<as£¹.h
>

44 
	~<¡ršg
>

46 
	~"­i/g¿ph_objeùs.hµ
"

47 
	~"m‘rics/m‘rics.hµ
"

48 
	~"io/¡redio.hµ
"

49 
	~"g¿phchi_ty³s.hµ
"

52 
Çme¥aû
 
	gg¿phchi
 {

56 
	g‹m¶©e
 <
ty³Çme
 
	gVT
,y³Çm
	gET
,y³Çm
	gsv”‹x_t
 = 
g¿phchi_v”‹x
<
VT
, ET> >

57 şas 
	cmemÜy_sh¬d
 {

59 
¡redio
 * 
	giomgr
;

61 
	g¡d
::
¡ršg
 
f’ame_ed©a
;

62 
	g¡d
::
¡ršg
 
f’ame_adj
;

64 
vid_t
 
	g¿nge_¡
;

65 
vid_t
 
	g¿nge_’d
;

66 
size_t
 
	gadjfesize
;

67 
size_t
 
	ged©afesize
;

69 
vid_t
 
	g¡»amšg_off£t_vid
;

70 
size_t
 
	g¡»amšg_off£t
;

71 
size_t
 
	g¿nge_¡¬t_off£t
;

72 
size_t
 
	g¿nge_¡¬t_edge_±r
;

73 
size_t
 
	g¡»amšg_off£t_edge_±r
;

74 
ušt8_t
 * 
	gadjd©a
;

75 ** 
	gedged©a
;

76 * 
	gdÚ•Œ
;

77 
	g¡d
::
veùÜ
<
size_t
> 
blocksizes
;

78 
ušt64_t
 
	gchunkid
;

80 
	g¡d
::
veùÜ
<> 
block_ed©a£ssiÚs
;

81 
	gadj_£ssiÚ
;

83 
boŞ
 
	gasync_ed©a_lßdšg
;

84 
boŞ
 
	gis_lßded
;

85 
boŞ
 
	gdi§bË_async_wr™es
;

86 
boŞ
 
	g’abË_·¿Î–_lßdšg
;

87 
size_t
 
	gblocksize
;

88 
	gm‘rics
 &
	gm
;

89 
	g¡d
::
veùÜ
<
sh¬d_šdex
> 
šdex
;

91 
	gpublic
:

92 
boŞ
 
Úly_adjaûncy
;

94 
memÜy_sh¬d
(
¡redio
 * 
iomgr
,

95 
¡d
::
¡ršg
 
_f’ame_ed©a
,

96 
¡d
::
¡ršg
 
_f’ame_adj
,

97 
vid_t
 
_¿nge_¡¬t
,

98 
vid_t
 
_¿nge_’d
,

99 
size_t
 
_blocksize
,

100 
m‘rics
 &
_m
è: 
iomgr
(iomgr), 
f’ame_ed©a
(
_f’ame_ed©a
),

101 
f’ame_adj
(
_f’ame_adj
),

102 
¿nge_¡
(
_¿nge_¡¬t
), 
¿nge_’d
(
_¿nge_’d
), 
blocksize
(
_blocksize
), 
m
(
_m
) {

103 
	gadjd©a
 = 
NULL
;

104 
	gÚly_adjaûncy
 = 
çl£
;

105 
	gis_lßded
 = 
çl£
;

106 
	gadj_£ssiÚ
 = -1;

107 
	gedged©a
 = 
NULL
;

108 
	gdÚ•Œ
 = 
NULL
;

109 
	g’abË_·¿Î–_lßdšg
 = 
Œue
;

110 
	gdi§bË_async_wr™es
 = 
çl£
;

111 
	gasync_ed©a_lßdšg
 = !
sv”‹x_t
().
computiÚ®_edges
();

112 #ifdeà
SUPPORT_DELETIONS


113 
	gasync_ed©a_lßdšg
 = 
çl£
;

117 ~
memÜy_sh¬d
() {

118 
	gnblocks
 = (è
block_ed©a£ssiÚs
.
size
();

120 
	gi
=0; i < 
	gnblocks
; i++) {

121 ià(
	gedged©a
[
i
] !ğ
NULL
 && 
block_ed©a£ssiÚs
[i] !ğ
CACHED_SESSION_ID
) {

122 
iomgr
->
mªaged_»Ëa£
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i]);

123 
	giomgr
->
şo£_£ssiÚ
(
block_ed©a£ssiÚs
[
i
]);

126 ià(
	gadj_£ssiÚ
 >= 0) {

127 ià(
adjd©a
 !ğ
NULL
è
iomgr
->
mªaged_»Ëa£
(
adj_£ssiÚ
, &adjdata);

128 
	giomgr
->
şo£_£ssiÚ
(
adj_£ssiÚ
);

130 ià(
	gedged©a
 !ğ
NULL
)

131 
ä“
(
edged©a
);

132 
	gedged©a
 = 
NULL
;

133 ià(
	gdÚ•Œ
 !ğ
NULL
) {

134 
ä“
(
dÚ•Œ
);

138 
£t_di§bË_async_wr™es
(
boŞ
 
b
) {

139 
	gdi§bË_async_wr™es
 = 
b
;

142 
di§bË_·¿Î–_lßdšg
() {

143 
	g’abË_·¿Î–_lßdšg
 = 
çl£
;

146 
comm™
(
boŞ
 
comm™_šedges
, boŞ 
comm™_ou‹dges
) {

147 ià(
	gblock_ed©a£ssiÚs
.
size
(è=ğ0 || 
Úly_adjaûncy
) ;

148 
as£¹
(
is_lßded
);

149 
m‘rics_’Œy
 
	gcm
 = 
m
.
¡¬t_time
();

157 
	gnblocks
 = (è
block_ed©a£ssiÚs
.
size
();

159 ià(
	gcomm™_šedges
) {

160 
	g¡¬t_¡»am_block
 = (è(
¿nge_¡¬t_edge_±r
 / 
blocksize
);

162 #´agm¨
omp
 
·¿Î–
 

163 
	gi
=0; i < 
	gnblocks
; i++) {

166 ià(
	gi
 >ğ
¡¬t_¡»am_block
 || 
di§bË_async_wr™es
) {

167 ià(
block_ed©a£ssiÚs
[
i
] !ğ
CACHED_SESSION_ID
) {

169 ià(
çl£
 =ğ
iomgr
->
g‘_block_ÿche
().
cÚsid”_ÿchšg
(

170 
iomgr
->
g‘_£ssiÚ_f’ame
(
block_ed©a£ssiÚs
[
i
]), 
edged©a
[i], 
blocksizes
[i], 
Œue
)) {

171 
	giomgr
->
mªaged_pwr™—_now
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i], 
blocksizes
[i], 0);

172 
	giomgr
->
mªaged_»Ëa£
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i]);

173 
	giomgr
->
şo£_£ssiÚ
(
block_ed©a£ssiÚs
[
i
]);

175 
	giomgr
->
şo£_£ssiÚ
(
block_ed©a£ssiÚs
[
i
]);

176 
	gblock_ed©a£ssiÚs
[
i
] = 
CACHED_SESSION_ID
;

179 
	gedged©a
[
i
] = 
NULL
;

182 ià(
	gblock_ed©a£ssiÚs
[
i
] !ğ
CACHED_SESSION_ID
) {

183 
iomgr
->
mªaged_pwr™—_async
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i], 
blocksizes
[i], 0, 
Œue
,rue);

185 
	gedged©a
[
i
] = 
NULL
;

188 } ià(
	gcomm™_ou‹dges
) {

189 
size_t
 
	gÏ¡
 = 
¡»amšg_off£t_edge_±r
;

190 ià(
	gÏ¡
 == 0){

192 
Ï¡
 = 
ed©afesize
;

195 
	g¡¬tblock
 = (è(
¿nge_¡¬t_edge_±r
 / 
blocksize
);

196 
	g’dblock
 = (è(
Ï¡
 / 
blocksize
);

197 #´agm¨
omp
 
·¿Î–
 

198 
	gi
=0; i < 
	gnblocks
; i++) {

199 ià(
	gblock_ed©a£ssiÚs
[
i
] !ğ
CACHED_SESSION_ID
) {

200 ià(
çl£
 =ğ
iomgr
->
g‘_block_ÿche
().
cÚsid”_ÿchšg
(

201 
iomgr
->
g‘_£ssiÚ_f’ame
(
block_ed©a£ssiÚs
[
i
]), 
edged©a
[i], 
blocksizes
[i], 
Œue
)) {

202 ià(
	gi
 >ğ
¡¬tblock
 && 
i
 <ğ
’dblock
) {

203 
iomgr
->
mªaged_pwr™—_now
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i], 
blocksizes
[i], 0);

205 
	giomgr
->
mªaged_»Ëa£
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i]);

206 
	giomgr
->
şo£_£ssiÚ
(
block_ed©a£ssiÚs
[
i
]);

208 
	giomgr
->
şo£_£ssiÚ
(
block_ed©a£ssiÚs
[
i
]);

209 
	gblock_ed©a£ssiÚs
[
i
] = 
CACHED_SESSION_ID
;

212 
	gedged©a
[
i
] = 
NULL
;

215 
	gi
=0; i < 
	gnblocks
; i++) {

216 ià(
	gblock_ed©a£ssiÚs
[
i
] !ğ
CACHED_SESSION_ID
) {

217 
iomgr
->
şo£_£ssiÚ
(
block_ed©a£ssiÚs
[
i
]);

222 
	gm
.
¡İ_time
(
cm
, "memshard_commit");

224 
	giomgr
->
mªaged_»Ëa£
(
adj_£ssiÚ
, &
adjd©a
);

226 
	gi
=0; i < 
	gnblocks
; i++) {

227 ià(
	gedged©a
[
i
] !ğ
NULL
) {

228 ià(
block_ed©a£ssiÚs
[
i
] !ğ
CACHED_SESSION_ID
) {

229 
iomgr
->
mªaged_»Ëa£
(
block_ed©a£ssiÚs
[
i
], &
edged©a
[i]);

233 
	gblock_ed©a£ssiÚs
.
ş—r
();

234 
	gis_lßded
 = 
çl£
;

237 
boŞ
 
lßded
() {

238  
	gis_lßded
;

241 
	g´iv©e
:

246 
¡d
::
veùÜ
<
sh¬d_šdex
> 
lßd_šdex
() {

247 
¡d
::
¡ršg
 
šdexfe
 = 
f’ame_sh¬d_adjidx
(
f’ame_adj
);

248 ià(!
fe_exi¡s
(
šdexfe
)) {

249 
log¡»am
(
LOG_DEBUG
è<< "CªnÙ fšd index: " << 
	gšdexfe
 << 
	g¡d
::
’dl
;

251 
	g¡d
::
veùÜ
<
sh¬d_šdex
> 
sšgËtÚidx
;

252 
	gsšgËtÚidx
.
push_back
(
sh¬d_šdex
(0, 0, 0));

253  
	gsšgËtÚidx
;

256 
sh¬d_šdex
 * 
	gidx¿w
;

257 
	gf
 = 
İ’
(
šdexfe
.
c_¡r
(), 
O_RDONLY
);

258 
size_t
 
	gsz
 = 
»adfuÎ
(
f
, &
idx¿w
);

260 
	gnidx
 = (è(
sz
 / (
sh¬d_šdex
));

261 
	g¡d
::
veùÜ
<
sh¬d_šdex
> 
idx
;

262 
	gidx
.
push_back
(
sh¬d_šdex
(0, 0, 0));

263 
	gi
=0; i<
	gnidx
; i++) {

264 
	gidx
.
push_back
(
idx¿w
[
i
]);

267 
ä“
(
idx¿w
);

268 
şo£
(
f
);

269  
	gidx
;

272 
lßd_ed©a
() {

273 
as£¹
(
blocksize
 % (
ET
) == 0);

274 
	gnblocks
 = (è(
ed©afesize
 / 
blocksize
 + (edatafilesize % blocksize != 0));

275 
	gedged©a
 = (**è
ÿÎoc
(
nblocks
, (*));

276 
size_t
 
	gcom´es£dsize
 = 0;

277 
	gblockid
 = 0;

279 ià(!
	gasync_ed©a_lßdšg
) {

280 
	gdÚ•Œ
 = (*è
m®loc
(
nblocks
 * ());

281 
	gi
=0; i < 
	gnblocks
; i++è
	gdÚ•Œ
[
i
] = 1;

284 
	gblockid
 < 
	gnblocks
) {

285 
	g¡d
::
¡ršg
 
block_f’ame
 = 
f’ame_sh¬d_ed©a_block
(
f’ame_ed©a
, 
blockid
, 
blocksize
);

286 ià(
fe_exi¡s
(
block_f’ame
)) {

287 
size_t
 
	gfsize
 = 
¡d
::
mš
(
ed©afesize
 - 
blocksize
 * 
blockid
, blocksize);

289 
	gcom´es£dsize
 +ğ
g‘_fesize
(
block_f’ame
);

290 
	gblocksizes
.
push_back
(
fsize
);

293 * 
	gÿchedblock
 = 
iomgr
->
g‘_block_ÿche
().
g‘_ÿched
(
block_f’ame
);

294 ià(
	gÿchedblock
 !ğ
NULL
) {

296 
block_ed©a£ssiÚs
.
push_back
(
CACHED_SESSION_ID
);

297 
	gedged©a
[
blockid
] = (*)
ÿchedblock
;

298 ià(!
	gasync_ed©a_lßdšg
) {

299 
	gdÚ•Œ
[
blockid
] = 0;

302 
	gblock£ssiÚ
 = 
iomgr
->
İ’_£ssiÚ
(
block_f’ame
, 
çl£
, 
Œue
);

303 
	gblock_ed©a£ssiÚs
.
push_back
(
block£ssiÚ
);

305 
	gedged©a
[
blockid
] = 
NULL
;

306 
	giomgr
->
mªaged_m®loc
(
block£ssiÚ
, &
edged©a
[
blockid
], 
fsize
, 0);

307 ià(
	gasync_ed©a_lßdšg
) {

308 
	giomgr
->
mªaged_´—da_async
(
block£ssiÚ
, &
edged©a
[
blockid
], 
fsize
, 0);

310 
	giomgr
->
mªaged_´—da_async
(
block£ssiÚ
, &
edged©a
[
blockid
], 
fsize
, 0, (vŞ©*)&
dÚ•Œ
[blockid]);

313 
	gblockid
++;

316 ià(
	gblockid
 == 0) {

317 
log¡»am
(
LOG_ERROR
è<< "Sh¬d block fdid‚Ùƒxi¡s:" << 
block_f’ame
 << 
¡d
::
’dl
;

319 ià(
	gblockid
 < 
	gnblocks
) {

320 
log¡»am
(
LOG_ERROR
è<< "Did‚Ù fšd block " << 
	gblock_f’ame
 << 
	g¡d
::
’dl
;

321 
log¡»am
(
LOG_ERROR
è<< "GošgØex™..." << 
	g¡d
::
’dl
;

327 
log¡»am
(
LOG_DEBUG
è<< "Com´es£d/fuÎ size: " << 
	gcom´es£dsize
 * 1.0 / 
	ged©afesize
 <<

328 "‚umb” oàblocks: " << 
	gnblocks
 << 
	g¡d
::
’dl
;

329 
as£¹
(
blockid
 =ğ
nblocks
);

334 
	gpublic
:

337 
lßd
() {

338 
is_lßded
 = 
Œue
;

339 
	gadjfesize
 = 
g‘_fesize
(
f’ame_adj
);

341 #ifdeà
SUPPORT_DELETIONS


342 
	gasync_ed©a_lßdšg
 = 
çl£
;

348 
	gadj_£ssiÚ
 = 
iomgr
->
İ’_£ssiÚ
(
f’ame_adj
, 
Œue
);

349 
	giomgr
->
mªaged_m®loc
(
adj_£ssiÚ
, &
adjd©a
, 
adjfesize
, 0);

352 
size_t
 
	gbufsize
 = 16 * 1024 * 1024;

353 
	gn
 = (è(
adjfesize
 / 
bufsize
 + 1);

355 #´agm¨
omp
 
·¿Î–
 

356 
	gi
=0; i < 
	gn
; i++) {

357 
size_t
 
	gtÜ—d
 = 
¡d
::
mš
(
adjfesize
 - 
i
 * 
bufsize
, (size_t)bufsize);

358 
	giomgr
->
´—da_now
(
adj_£ssiÚ
, 
adjd©a
 + 
i
 * 
bufsize
, 
tÜ—d
, i * bufsize, 
Œue
);

363 ià(!
	gÚly_adjaûncy
) {

364 
	ged©afesize
 = 
g‘_sh¬d_ed©a_fesize
<
ET
>(
f’ame_ed©a
);

365 
lßd_ed©a
();

371 
	g¡»amšg_off£t
 = 0;

372 
	g¡»amšg_off£t_vid
 = 0;

373 
	g¡»amšg_off£t_edge_±r
 = 0;

374 
	g¿nge_¡¬t_off£t
 = 
adjfesize
;

375 
	g¿nge_¡¬t_edge_±r
 = 
ed©afesize
;

379 
	gšdex
 = 
lßd_šdex
();

384 
lßd_v”tiûs
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
¡d
::
veùÜ
<
sv”‹x_t
> & 
´—Îoc
, 
boŞ
 
šedges
=
Œue
, boŞ 
ou‹dges
=true) {

386 
m
.
¡¬t_time
("memoryshard_create_edges");

388 
as£¹
(
adjd©a
 !ğ
NULL
);

390 
	gnblocks
 = (è(
ed©afesize
 / 
blocksize
 + (edatafilesize % blocksize != 0));

392 
boŞ
 
	g£toff£t
 = 
çl£
;

393 
boŞ
 
	g£Œªgeoff£t
 = 
çl£
;

395 ià(!
	g’abË_·¿Î–_lßdšg
) {

396 
	gšdex
.
ş—r
();

397 
	gšdex
.
push_back
(
sh¬d_šdex
(0, 0, 0));

400 #´agm¨
omp
 
·¿Î–
 
scheduË
(
dyÇmic
, 1)

401 
	gchunk
=0; chunk < ()
	gšdex
.
size
(); chunk++) {

403 
ušt8_t
 * 
	g±r
 = 
adjd©a
 + 
šdex
[
chunk
].
f•os
;

404 
ušt8_t
 * 
	g’d
 = 
adjd©a
 + (
chunk
 < (è
šdex
.
size
(è- 1 ? index[chunk + 1].
f•os
 : 
adjfesize
);

405 
vid_t
 
	gvid
 = 
šdex
[
chunk
].
v”‹xid
;

406 
vid_t
 
	gvid’
 = (
chunk
 < (è
šdex
.
size
(è- 1 ? index[chunk + 1].
v”‹xid
 : 0xffffffffu);

407 
size_t
 
	gedg•Œ
 = 
šdex
[
chunk
].
edgecouÁ”
 * (
ET
);

408 
size_t
 
	gedg•Œ_’d
 = (
chunk
 < (è
šdex
.
size
(è- 1 ? index[chunk + 1].
edgecouÁ”
 * (
ET
è: 
ed©afesize
);

410 
boŞ
 
	gcÚšs_¿nge_’d
 = 
vid
 < 
¿nge_’d
 && 
vid’
 >„ange_end;

411 
boŞ
 
	gcÚšs_¿nge_¡
 = 
vid
 <ğ
¿nge_¡
 && 
vid’
 >„ange_st;

415 ià(!
	gšedges
 && (
	gvid
 > 
	gwšdow_’
 || 
	gvid’
 < 
	gwšdow_¡
)) {

419 ià(!
	gasync_ed©a_lßdšg
 && !
	gÚly_adjaûncy
) {

421 
	gblid
=()
edg•Œ
/
blocksize
; blid<=()(
edg•Œ_’d
 /blocksize); blid++) {

422 ià(
	gblid
 < 
	gnblocks
) {

423 
	gdÚ•Œ
[
blid
] !ğ0è{ 
u¦“p
(10); }

429 
	g±r
 < 
	g’d
) {

430 ià(
	gcÚšs_¿nge_’d
) {

431 ià(!
	g£toff£t
 && 
	gvid
 > 
	g¿nge_’d
) {

434 
	g¡»amšg_off£t
 = 
±r
-
adjd©a
;

435 
	g¡»amšg_off£t_vid
 = 
vid
;

436 
	g¡»amšg_off£t_edge_±r
 = 
edg•Œ
;

437 
	g£toff£t
 = 
Œue
;

440 ià(
	gcÚšs_¿nge_¡
) {

441 ià(!
	g£Œªgeoff£t
 && 
	gvid
 >ğ
¿nge_¡
) {

442 
¿nge_¡¬t_off£t
 = 
±r
-
adjd©a
;

443 
	g¿nge_¡¬t_edge_±r
 = 
edg•Œ
;

444 
	g£Œªgeoff£t
 = 
Œue
;

448 
ušt8_t
 
	gns
 = *
±r
;

449 
	gn
;

451 
	g±r
 +ğ(
ušt8_t
);

453 ià(
	gns
 == 0x00) {

455 
ušt8_t
 
nz
 = *
±r
;

456 
	g±r
 +ğ(
ušt8_t
);

457 
	gvid
++;

458 
	gvid
 +ğ
nz
;

462 ià(
	gns
 == 0xff) {

463 
n
 = *((
ušt32_t
*)
±r
);

464 
	g±r
 +ğ(
ušt32_t
);

466 
	gn
 = 
ns
;

468 
sv”‹x_t
* 
	gv”‹x
 = 
NULL
;

470 ià(
	gvid
>=
wšdow_¡
 && 
vid
 <=
wšdow_’
) {

471 
v”‹x
 = &
´—Îoc
[
vid
-
wšdow_¡
];

472 ià(!
	gv”‹x
->
	gscheduËd
èv”‹x = 
NULL
;

474 
boŞ
 
	gªy_edges
 = 
çl£
;

475 --
	gn
>=0) {

476 
blockid
 = (è(
edg•Œ
 / 
blocksize
);

478 
vid_t
 
	grg‘
 = *((vid_t*è
±r
);

479 
	g±r
 +ğ(
vid_t
);

480 ià(
	gv”‹x
 !ğ
NULL
 && 
ou‹dges
)

482 * 
•Œ
 = (
Úly_adjaûncy
 ? 
NULL
 : &(
edged©a
[
blockid
][
edg•Œ
 % 
blocksize
]));

483 
	gv”‹x
->
add_ou‹dge
(
rg‘
, (
Úly_adjaûncy
 ? 
NULL
 : (
ET
*è
•Œ
), 
çl£
);

486 ià(
	grg‘
 >ğ
wšdow_¡
) {

487 ià(
rg‘
 <ğ
wšdow_’
) {

488 ià(
šedges
) {

489 
sv”‹x_t
 & 
d¡v”‹x
 = 
´—Îoc
[
rg‘
 - 
wšdow_¡
];

490 ià(
	gd¡v”‹x
.
	gscheduËd
) {

491 
	gªy_edges
 = 
Œue
;

493 * 
	g•Œ
 = (
Úly_adjaûncy
 ? 
NULL
 : &(
edged©a
[
blockid
][
edg•Œ
 % 
blocksize
]));

495 
	gd¡v”‹x
.
add_šedge
(
vid
, (
Úly_adjaûncy
 ? 
NULL
 : (
ET
*è
•Œ
), 
çl£
);

496 
	gd¡v”‹x
.
	g·¿Î–_§ã
 = 
d¡v”‹x
.
·¿Î–_§ã
 && (
v”‹x
 =ğ
NULL
);

501 ià(
	gv”‹x
 =ğ
NULL
) {

502 
±r
 +ğ(
vid_t
è* 
n
;

503 
	gedg•Œ
 +ğ(
n
 + 1è* (
ET
);

508 
	gedg•Œ
 +ğ(
ET
);

512 ià(
	gªy_edges
 && 
	gv”‹x
 !ğ
NULL
) {

513 
v”‹x
->
·¿Î–_§ã
 = 
çl£
;

515 
	gvid
++;

518 
	gm
.
¡İ_time
("memÜysh¬d_ü—‹_edges", 
çl£
);

521 
size_t
 
off£t_fÜ_¡»am_cÚt
() {

522  
	g¡»amšg_off£t
;

524 
vid_t
 
off£t_vid_fÜ_¡»am_cÚt
() {

525  
	g¡»amšg_off£t_vid
;

527 
size_t
 
ed©a_±r_fÜ_¡»am_cÚt
() {

528  
	g¡»amšg_off£t_edge_±r
;

	@shards/slidingshard.hpp

30 #ifdeà
DYNAMICEDATA


31 
	~"sh¬ds/dyÇmicd©a/¦idšgsh¬d.hµ
"

34 #iâdeà
DEF_GRAPHCHI_SLIDINGSHARD


35 
	#DEF_GRAPHCHI_SLIDINGSHARD


	)

38 
	~<io¡»am
>

39 
	~<c¡dio
>

40 
	~<s¡»am
>

41 
	~<veùÜ
>

42 
	~<fú.h
>

43 
	~<uni¡d.h
>

44 
	~<as£¹.h
>

45 
	~<¡ršg
>

47 
	~"­i/g¿ph_objeùs.hµ
"

48 
	~"m‘rics/m‘rics.hµ
"

49 
	~"logg”/logg”.hµ
"

50 
	~"io/¡redio.hµ
"

51 
	~"g¿phchi_ty³s.hµ
"

54 
Çme¥aû
 
	gg¿phchi
 {

59 
	ssblock
 {

61 
	gwr™edesc
;

62 
	g»addesc
;

63 
size_t
 
	goff£t
;

64 
size_t
 
	g’d
;

65 
ušt8_t
 * 
	gd©a
;

66 
ušt8_t
 * 
	g±r
;

67 
boŞ
 
	gaùive
;

68 
boŞ
 
	gis_ed©a_block
;

70 
sblock
(è: 
wr™edesc
(0), 
»addesc
(0), 
aùive
(
çl£
è{ 
	gd©a
 = 
NULL
; }

71 
sblock
(
wdesc
, 
rdesc
, 
boŞ
 
is_ed©a_block
=
çl£
è: 
wr™edesc
(wdesc), 
»addesc
Ôdesc), 
aùive
(false),

72 
is_ed©a_block
(is_ed©a_block){ 
	gd©a
 = 
NULL
; }

74 
comm™_async
(
¡redio
 * 
iomgr
) {

75 ià(
	g»addesc
 !ğ
CACHED_SESSION_ID
) {

76 ià(
aùive
 && 
d©a
 !ğ
NULL
 && 
wr™edesc
 >= 0) {

77 ià(
is_ed©a_block
) {

78 
¡d
::
¡ršg
 
blockf’ame
 = 
iomgr
->
g‘_£ssiÚ_f’ame
(
»addesc
);

79 ià(
	gçl£
 =ğ
iomgr
->
g‘_block_ÿche
().
cÚsid”_ÿchšg
(
blockf’ame
, 
d©a
, 
’d
 - 
off£t
, 
Œue
)) {

80 
	giomgr
->
mªaged_pwr™—_async
(
wr™edesc
, &
d©a
, 
’d
-
off£t
, 0, 
Œue
,rue);

82 
	g»addesc
 = 
wr™edesc
 = 
CACHED_SESSION_ID
;

84 
	gd©a
 = 
NULL
;

86 
	giomgr
->
mªaged_pwr™—_async
(
wr™edesc
, &
d©a
, 
’d
-
off£t
, off£t, 
Œue
);

92 
comm™_now
(
¡redio
 * 
iomgr
) {

93 ià(
	g»addesc
 !ğ
CACHED_SESSION_ID
) {

94 ià(
aùive
 && 
d©a
 !ğ
NULL
 && 
wr™edesc
 >= 0) {

95 
size_t
 
Ën
 = 
±r
-
d©a
;

96 ià(
	gËn
 > 
	g’d
-
	goff£t
èËÀğ
’d
-
off£t
;

97 ià(
	gis_ed©a_block
) {

98 
	g¡d
::
¡ršg
 
blockf’ame
 = 
iomgr
->
g‘_£ssiÚ_f’ame
(
»addesc
);

99 ià(
	gçl£
 =ğ
iomgr
->
g‘_block_ÿche
().
cÚsid”_ÿchšg
(
blockf’ame
, 
d©a
, 
’d
 - 
off£t
, 
Œue
)) {

100 
	giomgr
->
mªaged_pwr™—_now
(
wr™edesc
, &
d©a
, 
’d
 - 
off£t
, 0);

102 
	g»addesc
 = 
wr™edesc
 = 
CACHED_SESSION_ID
;

105 
	giomgr
->
mªaged_pwr™—_now
(
wr™edesc
, &
d©a
, 
Ën
, 
off£t
);

110 
»ad_async
(
¡redio
 * 
iomgr
) {

111 ià(
	g»addesc
 !ğ
CACHED_SESSION_ID
) {

112 ià(
is_ed©a_block
) {

113 
iomgr
->
mªaged_´—da_async
(
»addesc
, &
d©a
, (
’d
 - 
off£t
), 0);

115 
	giomgr
->
mªaged_´—da_async
(
»addesc
, &
d©a
, 
’d
 - 
off£t
, offset);

120 
»ad_now
(
¡redio
 * 
iomgr
) {

121 ià(
	g»addesc
 !ğ
CACHED_SESSION_ID
) {

122 ià(
is_ed©a_block
) {

123 
iomgr
->
mªaged_´—da_now
(
»addesc
, &
d©a
, 
’d
-
off£t
, 0);

125 
	giomgr
->
mªaged_´—da_now
(
»addesc
, &
d©a
, 
’d
-
off£t
, offset);

130 
»Ëa£
(
¡redio
 * 
iomgr
) {

131 ià(
	gd©a
 !ğ
NULL
 && 
»addesc
 !ğ
CACHED_SESSION_ID
) {

132 ià(
is_ed©a_block
) {

134 
iomgr
->
mªaged_»Ëa£
(
»addesc
, &
d©a
);

135 
	giomgr
->
şo£_£ssiÚ
(
»addesc
);

137 
	giomgr
->
mªaged_»Ëa£
(
»addesc
, &
d©a
);

141 
	gd©a
 = 
NULL
;

147 
	sšdex’Œy
 {

148 
size_t
 
	gadjoff£t
, 
	ged©aoff£t
;

149 
šdex’Œy
(
size_t
 
a
, size_ˆ
e
è: 
adjoff£t
×), 
ed©aoff£t
(e) {}

156 
	g‹m¶©e
 <
ty³Çme
 
	gVT
,y³Çm
	gET
,y³Çm
	gsv”‹x_t
 = 
g¿phchi_v”‹x
<
VT
, ET>,y³Çm
	gET¥ecŸl
 = 
ET
>

157 şas 
	c¦idšg_sh¬d
 {

159 
¡redio
 * 
iomgr
;

161 
	g¡d
::
¡ršg
 
f’ame_ed©a
;

162 
	g¡d
::
¡ršg
 
f’ame_adj
;

163 
vid_t
 
	g¿nge_¡
, 
	g¿nge_’d
;

164 
size_t
 
	gblocksize
;

166 
vid_t
 
	gcurvid
;

167 
size_t
 
	gadjoff£t
, 
	ged©aoff£t
, 
	gadjfesize
, 
	ged©afesize
;

168 
size_t
 
	gwšdow_¡¬t_ed©aoff£t
;

170 
	g¡d
::
veùÜ
<
sblock
> 
aùiveblocks
;

171 
	gadjfe_£ssiÚ
;

172 
	gwr™edesc
;

173 
sblock
 * 
	gcurblock
;

174 
sblock
 * 
	gcu¿djblock
;

175 
	gm‘rics
 &
	gm
;

177 
	g¡d
::
m­
<, 
	gšdex’Œy
> 
	g¥¬£_šdex
;

178 
boŞ
 
	gdi§bË_wr™es
;

179 
boŞ
 
	gasync_ed©a_lßdšg
;

180 
boŞ
 
	gdi§bË_async_wr™es
;

184 
	gpublic
:

185 
boŞ
 
Úly_adjaûncy
;

187 
¦idšg_sh¬d
(
¡redio
 * 
iomgr
, 
¡d
::
¡ršg
 
_f’ame_ed©a
, std::¡ršg 
_f’ame_adj
, 
vid_t
 
_¿nge_¡
, vid_ˆ
_¿nge_’
, 
size_t
 
_blocksize
, 
m‘rics
 &
_m
,

188 
boŞ
 
_di§bË_wr™es
=
çl£
, boŞ 
Úlyadj
 = false) :

189 
iomgr
(iomgr),

190 
f’ame_ed©a
(
_f’ame_ed©a
),

191 
f’ame_adj
(
_f’ame_adj
),

192 
¿nge_¡
(
_¿nge_¡
),

193 
¿nge_’d
(
_¿nge_’
),

194 
blocksize
(
_blocksize
),

195 
m
(
_m
),

196 
di§bË_wr™es
(
_di§bË_wr™es
) {

197 
	gcurvid
 = 0;

198 
	gadjoff£t
 = 0;

199 
	ged©aoff£t
 = 0;

200 
	gdi§bË_wr™es
 = 
çl£
;

201 
	gÚly_adjaûncy
 = 
Úlyadj
;

202 
	gcurblock
 = 
NULL
;

203 
	gcu¿djblock
 = 
NULL
;

204 
	gwšdow_¡¬t_ed©aoff£t
 = 0;

205 
	gdi§bË_async_wr™es
 = 
çl£
;

207 
	gblocksize
 % (
	gET
è!ğ0è
blocksize
++;

208 
as£¹
(
blocksize
 % (
ET
)==0);

210 
	gadjfesize
 = 
g‘_fesize
(
f’ame_adj
);

211 ià(!
	gÚly_adjaûncy
) {

212 
	ged©afesize
 = 
g‘_sh¬d_ed©a_fesize
<
ET
>(
f’ame_ed©a
);

213 
log¡»am
(
LOG_DEBUG
è<< "TÙ®ƒdgd©¨size: " << 
	ged©afesize
 << ", " << 
	gf’ame_ed©a


214 << "sizeof(ET): " << (
	gET
è<< 
	g¡d
::
’dl
;

219 
	gadjfe_£ssiÚ
 = 
iomgr
->
İ’_£ssiÚ
(
f’ame_adj
, 
Œue
);

220 
§ve_off£t
();

222 
	gasync_ed©a_lßdšg
 = !
sv”‹x_t
().
computiÚ®_edges
();

223 #ifdeà
SUPPORT_DELETIONS


224 
	gasync_ed©a_lßdšg
 = 
çl£
;

228 ~
¦idšg_sh¬d
() {

229 
»Ëa£_´iÜ_to_off£t
(
Œue
);

230 ià(
	gcurblock
 !ğ
NULL
) {

231 
curblock
->
»Ëa£
(
iomgr
);

232 
d–‘e
 
	gcurblock
;

233 
	gcurblock
 = 
NULL
;

235 ià(
	gcu¿djblock
 !ğ
NULL
) {

236 
cu¿djblock
->
»Ëa£
(
iomgr
);

237 
d–‘e
 
	gcu¿djblock
;

238 
	gcu¿djblock
 = 
NULL
;

240 
	giomgr
->
şo£_£ssiÚ
(
adjfe_£ssiÚ
);

244 
size_t
 
num_edges
() {

245  
	ged©afesize
 / (
	gET
);

249 
š™d©a
() {

250 
log¡»am
(
LOG_DEBUG
è<< "In™Ÿlizedgd©a: " << 
	gf’ame_ed©a
 << 
	g¡d
::
’dl
;

251 
ET
 * 
	gš™block
 = (ET *è
m®loc
(
blocksize
);

252 
	gi
=0; i < (è(
	gblocksize
/(
	gET
)); i++è
	gš™block
[
i
] = 
ET
();

253 
size_t
 
	goff
=0; ofà< 
	ged©afesize
; ofà+ğ
blocksize
) {

254 
¡d
::
¡ršg
 
blockf’ame
 = 
f’ame_sh¬d_ed©a_block
(
f’ame_ed©a
, (è(
off
 / 
blocksize
), blocksize);

255 
size_t
 
	gËn
 = 
¡d
::
mš
(
blocksize
, 
ed©afesize
 - 
off
);

256 
	gf
 = 
İ’
(
blockf’ame
.
c_¡r
(), 
O_WRONLY
);

257 
pwr™—
(
f
, 
š™block
, 
Ën
, 0);

258 
şo£
(
f
);

260 
ä“
(
š™block
);

263 
	g´Ùeùed
:

264 
size_t
 
g‘_adjoff£t
(è{  
adjoff£t
; }

265 
size_t
 
g‘_ed©aoff£t
(è{  
	ged©aoff£t
; }

267 
§ve_off£t
() {

270 
	g¥¬£_šdex
.
š£¹
(
¡d
::
·œ
<, 
šdex’Œy
>(-(()
curvid
), index’Œy(
adjoff£t
, 
ed©aoff£t
)));

273 
move_şo£_to
(
vid_t
 
v
) {

274 ià(
	gcurvid
 >ğ
v
) ;

276 
	g¡d
::
m­
<,
	gšdex’Œy
>::
™”©Ü
 
low”bd_™”
 = 
¥¬£_šdex
.
low”_bound
(-(()
v
));

277 
	gşo£¡_vid
 = -(()
low”bd_™”
->
fœ¡
);

278 
as£¹
(
şo£¡_vid
>=0);

279 
šdex’Œy
 
	gşo£¡_off£t
 = 
low”bd_™”
->
£cÚd
;

280 
as£¹
(
şo£¡_vid
 <ğ()
v
);

281 ià(
	gşo£¡_vid
 > ()
	gcurvid
) {

282 
log¡»am
(
LOG_DEBUG
)

283 << "Slidšg sh¬d, s¹: " << 
	g¿nge_¡
 << " movedo: " << 
	gşo£¡_vid
 << " " << 
	gşo£¡_off£t
.
	gadjoff£t
 << ",‡sked fÜ : " << 
	gv
 << " wa š: curvidğ" << 
	gcurvid
 << " " <<‡djoff£ˆ<< 
	g¡d
::
’dl
;

285 ià(
	gcurblock
 !ğ
NULL
)

286 
curblock
->
±r
 +ğ
şo£¡_off£t
.
ed©aoff£t
 -ƒdataoffset;

287 ià(
	gcu¿djblock
 !ğ
NULL
)

288 
cu¿djblock
->
±r
 +ğ
şo£¡_off£t
.
adjoff£t
 -‡djoffset;

289 
	gcurvid
 = (
vid_t
)
şo£¡_vid
;

290 
	gadjoff£t
 = 
şo£¡_off£t
.
adjoff£t
;

291 
	ged©aoff£t
 = 
şo£¡_off£t
.
ed©aoff£t
;

300 
šlše
 
check_curblock
(
size_t
 
tÜ—d
) {

301 ià(
	gcurblock
 =ğ
NULL
 || 
curblock
->
’d
 < 
ed©aoff£t
+
tÜ—d
) {

302 ià(
curblock
 !ğ
NULL
) {

303 ià(!
curblock
->
aùive
) {

304 
curblock
->
»Ëa£
(
iomgr
);

305 } ià(
sv”‹x_t
().
computiÚ®_edges
()) {

307 
	gcurblock
->
comm™_now
(
iomgr
);

308 
	gcurblock
->
»Ëa£
(
iomgr
);

312 
	g¡d
::
¡ršg
 
blockf’ame
 = 
f’ame_sh¬d_ed©a_block
(
f’ame_ed©a
, (è(
ed©aoff£t
 / 
blocksize
), blocksize);

314 * 
	gÿchedblock
 = 
iomgr
->
g‘_block_ÿche
().
g‘_ÿched
(
blockf’ame
);

317 
	ged©a_£ssiÚ
 = (
ÿchedblock
 =ğ
NULL
 ? 
iomgr
->
İ’_£ssiÚ
(
blockf’ame
, 
çl£
, 
Œue
è: 
CACHED_SESSION_ID
);

318 
sblock
 
Ãwblock
(
ed©a_£ssiÚ
,ƒd©a_£ssiÚ, 
Œue
);

322 
	gÃwblock
.
	goff£t
 = (
ed©aoff£t
 / 
blocksize
) * blocksize;

323 
size_t
 
	gcÜ»ùiÚ
 = 
ed©aoff£t
 - 
Ãwblock
.
off£t
;

324 
	gÃwblock
.
	g’d
 = 
¡d
::
mš
(
ed©afesize
, 
Ãwblock
.
off£t
 + 
blocksize
);

325 
as£¹
(
Ãwblock
.
’d
 >ğÃwblock.
off£t
);

326 ià(
	gÿchedblock
 =ğ
NULL
) {

327 
iomgr
->
mªaged_m®loc
(
ed©a_£ssiÚ
, &
Ãwblock
.
d©a
,‚ewblock.
’d
 -‚ewblock.
off£t
,‚ewblock.offset);

329 
	gÃwblock
.
	gd©a
 = (
ušt8_t
*)
ÿchedblock
;

331 
	gÃwblock
.
	g±r
 = 
Ãwblock
.
d©a
 + 
cÜ»ùiÚ
;

332 
	gaùiveblocks
.
push_back
(
Ãwblock
);

333 
	gcurblock
 = &
aùiveblocks
[aùiveblocks.
size
()-1];

337 
šlše
 
check_adjblock
(
size_t
 
tÜ—d
) {

338 ià(
	gcu¿djblock
 =ğ
NULL
 || 
cu¿djblock
->
’d
 <ğ
adjoff£t
 + 
tÜ—d
) {

339 ià(
cu¿djblock
 !ğ
NULL
) {

340 
cu¿djblock
->
»Ëa£
(
iomgr
);

341 
d–‘e
 
	gcu¿djblock
;

342 
	gcu¿djblock
 = 
NULL
;

344 
sblock
 * 
	gÃwblock
 = 
Ãw
 sblock(0, 
adjfe_£ssiÚ
);

345 
	gÃwblock
->
	goff£t
 = 
adjoff£t
;

346 
	gÃwblock
->
	g’d
 = 
¡d
::
mš
(
adjfesize
, 
adjoff£t
+
blocksize
);

347 
as£¹
(
Ãwblock
->
’d
 > 0);

348 
as£¹
(
Ãwblock
->
’d
 >ğÃwblock->
off£t
);

349 
	giomgr
->
mªaged_m®loc
(
adjfe_£ssiÚ
, &
Ãwblock
->
d©a
,‚ewblock->
’d
 -‚ewblock->
off£t
, 
adjoff£t
);

350 
	gÃwblock
->
	g±r
 = 
Ãwblock
->
d©a
;

351 
m‘rics_’Œy
 
	gme
 = 
m
.
¡¬t_time
();

352 
	giomgr
->
mªaged_´—da_now
(
adjfe_£ssiÚ
, &
Ãwblock
->
d©a
,‚ewblock->
’d
 -‚ewblock->
off£t
, 
adjoff£t
);

353 
	gm
.
¡İ_time
(
me
, "blockload");

354 
	gcu¿djblock
 = 
Ãwblock
;

358 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

359 
šlše
 
U
 
»ad_v®
() {

360 
check_adjblock
((
U
));

361 
U
 
	g»s
 = *((U*)
cu¿djblock
->
±r
);

362 
	gadjoff£t
 +ğ(
U
);

363 
	gcu¿djblock
->
	g±r
 +ğ(
U
);

364  
	g»s
;

367 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

368 
šlše
 
U
 * 
»ad_edg•Œ
() {

369 ià(
	gÚly_adjaûncy
è 
	gNULL
;

370 
check_curblock
((
U
));

371 
U
 * 
	g»¥Œ
 = ((U*)
curblock
->
±r
);

372 
	ged©aoff£t
 +ğ(
U
);

373 
	gcurblock
->
	g±r
 +ğ(
U
);

374  
	g»¥Œ
;

377 
šlše
 
sk
(
n
, 
sz
) {

378 
size_t
 
	gtÙ
 = 
n
 * 
sz
;

379 
	gadjoff£t
 +ğ
tÙ
;

380 ià(
	gcu¿djblock
 !ğ
NULL
)

381 
cu¿djblock
->
±r
 +ğ
tÙ
;

382 
	ged©aoff£t
 +ğ(
ET
)*
n
;

383 ià(
	gcurblock
 !ğ
NULL
)

384 
curblock
->
±r
 +ğ(
ET
)*
n
;

387 
	gpublic
:

391 
»ad_Ãxt_v”tiûs
(
nvecs
, 
vid_t
 
¡¬t
, 
¡d
::
veùÜ
<
sv”‹x_t
> & 
´—Îoc
, 
boŞ
 
»cÜd_šdex
=
çl£
, boŞ 
di§bË_wr™es
=false) {

392 
m‘rics_’Œy
 
me
 = 
m
.
¡¬t_time
();

394 ià(!
	g»cÜd_šdex
)

395 
move_şo£_to
(
¡¬t
);

398 
	gcurblock
 = 
NULL
;

399 
»Ëa£_´iÜ_to_off£t
(
çl£
, 
di§bË_wr™es
);

400 
as£¹
(
aùiveblocks
.
size
() <= 1);

403 ià(!
	gaùiveblocks
.
em±y
(è&& !
	gÚly_adjaûncy
) {

404 
	gcurblock
 = &
aùiveblocks
[0];

406 
vid_t
 
	gÏ¡»c
 = 
¡¬t
;

407 
	gwšdow_¡¬t_ed©aoff£t
 = 
ed©aoff£t
;

409 
	gi
=(()
curvid
è- (()
¡¬t
); i<
	gnvecs
; i++) {

410 ià(
	gadjoff£t
 >ğ
adjfesize
) ;

414 
	gn
;

415 ià(
	g»cÜd_šdex
 && (
	gsize_t
)(
	gcurvid
 - 
	gÏ¡»c
è>ğ(
size_t
è
¡d
::
max
(()100000, 
nvecs
/16)) {

416 
§ve_off£t
();

417 
	gÏ¡»c
 = 
curvid
;

419 
ušt8_t
 
	gns
 = 
»ad_v®
<uint8_t>();

420 ià(
	gns
 == 0x00) {

421 
curvid
++;

422 
ušt8_t
 
	gnz
 = 
»ad_v®
<uint8_t>();

423 
	gcurvid
 +ğ
nz
;

424 
	gi
 +ğ
nz
;

428 ià(
	gns
 == 0xff) {

429 
n
 = 
»ad_v®
<
ušt32_t
>();

431 
	gn
 = 
ns
;

434 ià(
	gi
<0) {

436 
sk
(
n
, (
vid_t
));

438 
	gsv”‹x_t
& 
	gv”‹x
 = 
´—Îoc
[
i
];

440 ià(
	gv”‹x
.
	gscheduËd
) {

442 --
	gn
 >= 0) {

443 
boŞ
 
¥ecŸl_edge
 = 
çl£
;

444 
vid_t
 
	grg‘
 = ((
ET
è=ğ(
ET¥ecŸl
è? 
»ad_v®
<vid_t>(è: 
Œª¦©e_edge
Ô—d_v®<vid_t>(), 
¥ecŸl_edge
));

445 
ET
 * 
	gev®ue
 = (
¥ecŸl_edge
 ? (ET*)
»ad_edg•Œ
<
ET¥ecŸl
>():„ead_edgeptr<ET>());

447 ià(!
	gÚly_adjaûncy
) {

448 ià(!
	gcurblock
->
	gaùive
) {

449 ià(
	gasync_ed©a_lßdšg
) {

450 
	gcurblock
->
»ad_async
(
iomgr
);

452 
	gcurblock
->
»ad_now
(
iomgr
);

456 
	gcurblock
->
	gaùive
 = 
Œue
;

458 
	gv”‹x
.
add_ou‹dge
(
rg‘
, 
ev®ue
, 
¥ecŸl_edge
);

460 ià(!((
	grg‘
 >ğ
¿nge_¡
 && 
rg‘
 <ğ
¿nge_’d
))) {

461 
log¡»am
(
LOG_ERROR
è<< "E¼Ü : " << 
rg‘
 << "‚Ù iÀ[" << 
¿nge_¡
 << " - " << 
¿nge_’d
 << "]" << 
¡d
::
’dl
;

462 
	giomgr
->
´št_£ssiÚ
(
adjfe_£ssiÚ
);

464 
as£¹
(
rg‘
 >ğ
¿nge_¡
 &&¬g‘ <ğ
¿nge_’d
);

469 
sk
(
n
, (
vid_t
));

472 
	gcurvid
++;

474 
	gm
.
¡İ_time
(
me
, "read_next_vertices");

475 
	gcurblock
 = 
NULL
;

482 
comm™
(
sblock
 &
b
, 
boŞ
 
synchrÚou¦y
, boŞ 
di§bË_wr™es
=
çl£
) {

483 ià(
di§bË_async_wr™es
è
synchrÚou¦y
 = 
Œue
;

484 ià(
	gsynchrÚou¦y
) {

485 
m‘rics_’Œy
 
	gme
 = 
m
.
¡¬t_time
();

486 ià(!
	gdi§bË_wr™es
è
	gb
.
comm™_now
(
iomgr
);

487 
	gm
.
¡İ_time
(
me
, "commit");

488 
	gb
.
»Ëa£
(
iomgr
);

490 ià(!
	gdi§bË_wr™es
è
	gb
.
comm™_async
(
iomgr
);

491 
	gb
.
»Ëa£
(
iomgr
);

498 
æush
() {

499 
»Ëa£_´iÜ_to_off£t
(
Œue
);

500 ià(
	gcu¿djblock
 !ğ
NULL
) {

501 
cu¿djblock
->
»Ëa£
(
iomgr
);

502 
d–‘e
 
	gcu¿djblock
;

503 
	gcu¿djblock
 = 
NULL
;

510 
£t_off£t
(
size_t
 
Ãwoff
, 
vid_t
 
_curvid
, size_ˆ
edg•Œ
) {

511 
	gthis
->
	gadjoff£t
 = 
Ãwoff
;

512 
	gthis
->
	gcurvid
 = 
_curvid
;

513 
	gthis
->
	ged©aoff£t
 = 
edg•Œ
;

514 ià(
	gcu¿djblock
 !ğ
NULL
) {

515 
cu¿djblock
->
»Ëa£
(
iomgr
);

516 
d–‘e
 
	gcu¿djblock
;

517 
	gcu¿djblock
 = 
NULL
;

524 
»Ëa£_´iÜ_to_off£t
(
boŞ
 
®l
=
çl£
, boŞ 
di§bË_wr™es
=false) {

525 
i
=()
aùiveblocks
.
size
(è- 1; 
	gi
 >= 0; i--) {

526 
	gsblock
 &
	gb
 = 
aùiveblocks
[
i
];

527 ià(
	gb
.
	g’d
 <ğ
ed©aoff£t
 || 
®l
) {

528 
comm™
(
b
, 
®l
, 
di§bË_wr™es
);

529 
	gaùiveblocks
.
”a£
(
aùiveblocks
.
begš
(è+ ()
i
);

534 
£t_di§bË_async_wr™es
(
boŞ
 
b
) {

535 
	gdi§bË_async_wr™es
 = 
b
;

538 
	g¡d
::
¡ršg
 
g‘_šfo_jsÚ
() {

539 
¡d
::
¡ršg¡»am
 
jsÚ
;

540 
	gjsÚ
 << "\"size\": ";

541 
	gjsÚ
 << 
	ged©afesize
 << 
	g¡d
::
’dl
;

542 
	gjsÚ
 << ", \"windowStart\": ";

543 
	gjsÚ
 << 
	gwšdow_¡¬t_ed©aoff£t
;

544 
	gjsÚ
 << ", \"windowEnd\": ";

545 
	gjsÚ
 << 
	ged©aoff£t
;

546 
	gjsÚ
 << ", \"intervalStart\": ";

547 
	gjsÚ
 << 
	g¿nge_¡
;

548 
	gjsÚ
 << ", \"intervalEnd\": ";

549 
	gjsÚ
 << 
	g¿nge_’d
;

550  
	gjsÚ
.
¡r
();

	@tests/basic_dynamicengine_smoketest.cpp

32 
	~<¡ršg
>

34 
	~"g¿phchi_basic_šşudes.hµ
"

35 
	~"’gše/dyÇmic_g¿phs/g¿phchi_dyÇmicg¿ph_’gše.hµ
"

37 
usšg
 
Çme¥aû
 
	gg¿phchi
;

43 
vid_t
 
	tV”‹xD©aTy³
;

44 
vid_t
 
	tEdgeD©aTy³
;

51 
	gSmokeTe¡Prog¿m
 : 
public
 
G¿phChiProg¿m
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
> {

57 
upd©e
(
g¿phchi_v”‹x
<
V”‹xD©aTy³
, 
EdgeD©aTy³
> &
v”‹x
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

58 ià(
	ggcÚ‹xt
.
	g™”©iÚ
 == 0) {

59 
i
=0; 
	gi
 < 
	gv”‹x
.
num_ou‹dges
(); i++) {

60 
	gv”‹x
.
ou‹dge
(
i
)->
£t_d©a
(
v”‹x
.
id
());

63 
	gi
=0; i < 
	gv”‹x
.
num_šedges
(); i++) {

64 
	gg¿phchi_edge
<
	gvid_t
> * 
	gedge
 = 
v”‹x
.
šedge
(
i
);

65 
vid_t
 
	gšedged©a
 = 
edge
->
g‘_d©a
();

66 
vid_t
 
	gex³ùed
 = 
edge
->
v”‹x_id
(è+ 
gcÚ‹xt
.
™”©iÚ
 - (edge->v”‹x_id(è> 
v”‹x
.
id
());

67 ià(
	gšedged©a
 !ğ
ex³ùed
) {

68 
as£¹
(
çl£
);

71 
	gi
=0; i < 
	gv”‹x
.
num_ou‹dges
(); i++) {

72 
	gv”‹x
.
ou‹dge
(
i
)->
£t_d©a
(
v”‹x
.
id
(è+ 
gcÚ‹xt
.
™”©iÚ
);

75 
	gv”‹x
.
£t_d©a
(
gcÚ‹xt
.
™”©iÚ
 + 1);

81 
befÜe_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

87 
aá”_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

93 
befÜe_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

99 
aá”_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

107 
şass
 
	gV”‹xD©aCheck”
 : 
public
 
VC®lback
<
V”‹xD©aTy³
> {

108 
™”s
;

109 
	gpublic
:

110 
size_t
 
tÙ®
;

112 
V”‹xD©aCheck”
(
™”s
è: i‹rs(™”s), 
tÙ®
(0) {}

113 
ÿÎback
(
vid_t
 
v”‹x_id
, 
V”‹xD©aTy³
 &
vecv®ue
) {

114 
as£¹
(
vecv®ue
 =ğ
™”s
);

115 
	gtÙ®
 +ğ
™”s
;

119 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

122 
	`g¿phchi_š™
(
¬gc
, 
¬gv
);

126 
m‘rics
 
	`m
("smoketest-dynamic-engine");

129 
¡d
::
¡ršg
 
f’ame
 = 
	`g‘_İtiÚ_¡ršg
("file");

130 
n™”s
 = 
	`g‘_İtiÚ_št
("niters", 4);

131 
boŞ
 
scheduËr
 = 
çl£
;

134 
nsh¬ds
 = 
cÚv”t_if_nÙexi¡s
<
EdgeD©aTy³
>(
f’ame
,

135 
	`g‘_İtiÚ_¡ršg
("nshards", "auto"));

138 
SmokeTe¡Prog¿m
 
´og¿m
;

139 
g¿phchi_dyÇmicg¿ph_’gše
<
V”‹xD©aTy³
, 
EdgeD©aTy³
> 
	`’gše
(
f’ame
, 
nsh¬ds
, 
scheduËr
, 
m
);

140 
’gše
.
	`run
(
´og¿m
, 
n™”s
);

143 
V”‹xD©aCheck”
 
	`vcheck”
(
n™”s
);

144 
	`fÜ—ch_v”tiûs
(
f’ame
, 0, 
’gše
.
	`num_v”tiûs
(), 
vcheck”
);

145 
	`as£¹
(
vcheck”
.
tÙ®
 =ğ
’gše
.
	`num_v”tiûs
(è* 
n™”s
);

148 
	`m‘rics_»pÜt
(
m
);

150 
	`log¡»am
(
LOG_INFO
è<< "DyÇmiøEngšSmok‘e¡…as£d sucûssfuÎy! You¸sy¡em i wÜkšg!" << 
¡d
::
’dl
;

152 
	}
}

	@tests/basic_dynamicengine_smoketest2.cpp

32 
	~<¡ršg
>

34 
	#SUPPORT_DELETIONS
 1

	)

36 
	~"g¿phchi_basic_šşudes.hµ
"

37 
	~"’gše/dyÇmic_g¿phs/g¿phchi_dyÇmicg¿ph_’gše.hµ
"

39 
usšg
 
Çme¥aû
 
	gg¿phchi
;

45 
vid_t
 
	tV”‹xD©aTy³
;

46 
vid_t
 
	tEdgeD©aTy³
;

54 
	gSmokeTe¡Prog¿m2
 : 
public
 
G¿phChiProg¿m
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
> {

56 vŞ©
size_t
 
	gnd–‘ed
;

61 
upd©e
(
g¿phchi_v”‹x
<
V”‹xD©aTy³
, 
EdgeD©aTy³
> &
v”‹x
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

62 
	gnšedges
 = 0;

63 ià(
	ggcÚ‹xt
.
	g™”©iÚ
 == 0) {

64 
i
=0; 
	gi
 < 
	gv”‹x
.
num_šedges
(); i++) {

65 
	gv”‹x
.
šedge
(
i
)->
£t_d©a
(
v”‹x
.
id
());

66 
	gnšedges
++;

71 ià(
	gv”‹x
.
g‘_d©a
(è!ğ
v”‹x
.
num_šedges
()) {

72 
log¡»am
(
LOG_ERROR
è<< "Disü•ªcy iÀedgcouÁs: " << 
v”‹x
.
g‘_d©a
(è<< " !ğ" << v”‹x.
num_šedges
(è<< 
¡d
::
’dl
;

74 
as£¹
(
v”‹x
.
g‘_d©a
(è=ğv”‹x.
num_šedges
());

76 
	gi
=0; i < 
	gv”‹x
.
num_ou‹dges
(); i++) {

77 
	gg¿phchi_edge
<
	gvid_t
> * 
	gedge
 = 
v”‹x
.
ou‹dge
(
i
);

78 
vid_t
 
	gou‹dged©a
 = 
edge
->
g‘_d©a
();

79 
vid_t
 
	gex³ùed
 = 
edge
->
v”‹x_id
(è+ 
gcÚ‹xt
.
™”©iÚ
 - (edge->v”‹x_id(è> 
v”‹x
.
id
());

80 ià(!
is_d–‘ed_edge_v®ue
(
edge
->
g‘_d©a
())) {

81 ià(
	gou‹dged©a
 !ğ
ex³ùed
) {

82 
log¡»am
(
LOG_ERROR
è<< 
ou‹dged©a
 << " !ğ" << 
ex³ùed
 << 
¡d
::
’dl
;

83 
as£¹
(
çl£
);

87 
	gi
=0; i < 
	gv”‹x
.
num_šedges
(); i++) {

88 
	gv”‹x
.
šedge
(
i
)->
£t_d©a
(
v”‹x
.
id
(è+ 
gcÚ‹xt
.
™”©iÚ
);

90 ià(
	g¡d
::
¿nd
() % 4 == 1) {

91 
v”‹x
.
»move_šedge
(
i
);

92 
__sync_add_ªd_ãtch
(&
nd–‘ed
, 1);

94 
	gnšedges
++;

99 ià(
	ggcÚ‹xt
.
	g™”©iÚ
 =ğ
gcÚ‹xt
.
num_™”©iÚs
 - 1) {

100 
v”‹x
.
£t_d©a
(
gcÚ‹xt
.
™”©iÚ
 + 1);

102 
	gv”‹x
.
£t_d©a
(
nšedges
);

109 
befÜe_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

110 
	gnd–‘ed
 = 0;

116 
aá”_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

117 ià(
	ggcÚ‹xt
.
	g™”©iÚ
 > 0)

118 
as£¹
(
nd–‘ed
 > 0);

119 
log¡»am
(
LOG_INFO
è<< "D–‘ed: " << 
	gnd–‘ed
 << 
	g¡d
::
’dl
;

125 
befÜe_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

131 
aá”_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

139 
şass
 
	gV”‹xD©aCheck”
 : 
public
 
VC®lback
<
V”‹xD©aTy³
> {

140 
™”s
;

141 
	gpublic
:

142 
size_t
 
tÙ®
;

144 
V”‹xD©aCheck”
(
™”s
è: i‹rs(™”s), 
tÙ®
(0) {}

145 
ÿÎback
(
vid_t
 
v”‹x_id
, 
V”‹xD©aTy³
 &
vecv®ue
) {

146 
as£¹
(
vecv®ue
 =ğ
™”s
);

147 
	gtÙ®
 +ğ
™”s
;

151 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

154 
	`g¿phchi_š™
(
¬gc
, 
¬gv
);

158 
m‘rics
 
	`m
("smoketest-dynamic-engine2");

161 
¡d
::
¡ršg
 
f’ame
 = 
	`g‘_İtiÚ_¡ršg
("file");

162 
n™”s
 = 
	`g‘_İtiÚ_št
("niters", 4);

163 
boŞ
 
scheduËr
 = 
çl£
;

166 
nsh¬ds
 = 
cÚv”t_if_nÙexi¡s
<
EdgeD©aTy³
>(
f’ame
,

167 
	`g‘_İtiÚ_¡ršg
("nshards", "auto"));

170 
SmokeTe¡Prog¿m2
 
´og¿m
;

171 
g¿phchi_dyÇmicg¿ph_’gše
<
V”‹xD©aTy³
, 
EdgeD©aTy³
> 
	`’gše
(
f’ame
, 
nsh¬ds
, 
scheduËr
, 
m
);

172 
’gše
.
	`run
(
´og¿m
, 
n™”s
);

175 
V”‹xD©aCheck”
 
	`vcheck”
(
n™”s
);

176 
	`fÜ—ch_v”tiûs
(
f’ame
, 0, 
’gše
.
	`num_v”tiûs
(), 
vcheck”
);

177 
	`as£¹
(
vcheck”
.
tÙ®
 =ğ
’gše
.
	`num_v”tiûs
(è* 
n™”s
);

180 
	`m‘rics_»pÜt
(
m
);

182 
	`log¡»am
(
LOG_INFO
è<< "DyÇmiøEngšSmok‘e¡…as£d sucûssfuÎy! You¸sy¡em i wÜkšg!" << 
¡d
::
’dl
;

184 
	}
}

	@tests/basic_smoketest.cpp

32 
	~<¡ršg
>

34 
	~"g¿phchi_basic_šşudes.hµ
"

36 
usšg
 
Çme¥aû
 
	gg¿phchi
;

42 
vid_t
 
	tV”‹xD©aTy³
;

43 
vid_t
 
	tEdgeD©aTy³
;

50 
	gSmokeTe¡Prog¿m
 : 
public
 
G¿phChiProg¿m
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
> {

56 
upd©e
(
g¿phchi_v”‹x
<
V”‹xD©aTy³
, 
EdgeD©aTy³
> &
v”‹x
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

57 ià(
	ggcÚ‹xt
.
	g™”©iÚ
 == 0) {

58 
i
=0; 
	gi
 < 
	gv”‹x
.
num_ou‹dges
(); i++) {

59 
	gv”‹x
.
ou‹dge
(
i
)->
£t_d©a
(
v”‹x
.
id
());

62 
	gi
=0; i < 
	gv”‹x
.
num_šedges
(); i++) {

63 
	gg¿phchi_edge
<
	gvid_t
> * 
	gedge
 = 
v”‹x
.
šedge
(
i
);

64 
vid_t
 
	gšedged©a
 = 
edge
->
g‘_d©a
();

65 
vid_t
 
	gex³ùed
 = 
edge
->
v”‹x_id
(è+ 
gcÚ‹xt
.
™”©iÚ
 - (edge->v”‹x_id(è> 
v”‹x
.
id
());

66 ià(
	gšedged©a
 !ğ
ex³ùed
) {

67 
as£¹
(
çl£
);

70 
	gi
=0; i < 
	gv”‹x
.
num_ou‹dges
(); i++) {

71 
	gv”‹x
.
ou‹dge
(
i
)->
£t_d©a
(
v”‹x
.
id
(è+ 
gcÚ‹xt
.
™”©iÚ
);

74 
	gv”‹x
.
£t_d©a
(
gcÚ‹xt
.
™”©iÚ
 + 1);

80 
befÜe_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

86 
aá”_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

92 
befÜe_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

98 
aá”_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

106 
şass
 
	gV”‹xD©aCheck”
 : 
public
 
VC®lback
<
V”‹xD©aTy³
> {

107 
™”s
;

108 
	gpublic
:

109 
size_t
 
tÙ®
;

111 
V”‹xD©aCheck”
(
™”s
è: i‹rs(™”s), 
tÙ®
(0) {}

112 
ÿÎback
(
vid_t
 
v”‹x_id
, 
V”‹xD©aTy³
 &
vecv®ue
) {

113 
as£¹
(
vecv®ue
 =ğ(
V”‹xD©aTy³
)
™”s
);

114 
	gtÙ®
 +ğ(
size_t
è
™”s
;

118 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

121 
	`g¿phchi_š™
(
¬gc
, 
¬gv
);

125 
m‘rics
 
	`m
("smoketest");

128 
¡d
::
¡ršg
 
f’ame
 = 
	`g‘_İtiÚ_¡ršg
("file");

129 
n™”s
 = 
	`g‘_İtiÚ_št
("niters", 4);

130 
boŞ
 
scheduËr
 = 
çl£
;

133 
nsh¬ds
 = 
cÚv”t_if_nÙexi¡s
<
EdgeD©aTy³
>(
f’ame
,

134 
	`g‘_İtiÚ_¡ršg
("nshards", "auto"));

137 
SmokeTe¡Prog¿m
 
´og¿m
;

138 
g¿phchi_’gše
<
V”‹xD©aTy³
, 
EdgeD©aTy³
> 
	`’gše
(
f’ame
, 
nsh¬ds
, 
scheduËr
, 
m
);

139 
’gše
.
	`run
(
´og¿m
, 
n™”s
);

142 
V”‹xD©aCheck”
 
	`vcheck”
(
n™”s
);

143 
	`fÜ—ch_v”tiûs
(
f’ame
, 0, 
’gše
.
	`num_v”tiûs
(), 
vcheck”
);

144 
	`as£¹
(
vcheck”
.
tÙ®
 =ğ
’gše
.
	`num_v”tiûs
(è* 
n™”s
);

147 
	`m‘rics_»pÜt
(
m
);

149 
	`log¡»am
(
LOG_INFO
è<< "Smok‘e¡…as£d sucûssfuÎy! You¸sy¡em i wÜkšg!" << 
¡d
::
’dl
;

151 
	}
}

	@tests/bulksync_functional_test.cpp

29 
	#RANDOMRESETPROB
 0.15

	)

31 
	~<¡ršg
>

32 
	~<f¡»am
>

33 
	~<cm©h
>

35 
	~"ut/cmdİts.hµ
"

36 
	~"­i/g¿phchi_cÚ‹xt.hµ
"

37 
	~"­i/g¿ph_objeùs.hµ
"

38 
	~"­i/ischeduËr.hµ
"

39 
	~"­i/funùiÚ®/funùiÚ®_­i.hµ
"

40 
	~"m‘rics/m‘rics.hµ
"

41 
	~"m‘rics/»ps/basic_»pÜ‹r.hµ
"

42 
	~"ut/tİli¡.hµ
"

44 
usšg
 
Çme¥aû
 
	gg¿phchi
;

46 
	gsmok‘e¡_´og¿m
 : 
public
 
funùiÚ®_k”Ãl
<, > {

49 
š™Ÿl_v®ue
(
g¿phchi_cÚ‹xt
 &
šfo
, 
v”‹x_šfo
& 
myv”‹x
) {

54 
»£t
() {

60 
İ_ÃighbÜv®
(
g¿phchi_cÚ‹xt
 &
šfo
, 
v”‹x_šfo
& 
myv”‹x
, 
vid_t
 
nbid
, 
nbv®
) {

61 
as£¹
(
nbv®
 =ğ(è
šfo
.
™”©iÚ
 - 1);

62  
	gnbv®
;

66 
¶us
(
curv®
, 
tßdd
) {

67 
as£¹
(
curv®
 =ğ0 || 
tßdd
 == curval);

68  
	gtßdd
;

72 
compu‹_v”‹xv®ue
(
g¿phchi_cÚ‹xt
 &
gšfo
, 
v”‹x_šfo
& 
myv”‹x
, 
nbv®sum
) {

73  
	ggšfo
.
	g™”©iÚ
;

77 
v®ue_to_ÃighbÜ
(
g¿phchi_cÚ‹xt
 &
šfo
, 
v”‹x_šfo
& 
myv”‹x
, 
vid_t
 
nbid
, 
myv®
) {

78 
as£¹
(
myv®
 =ğ(è
šfo
.
™”©iÚ
);

79  
	gmyv®
;

84 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

85 
	`g¿phchi_š™
(
¬gc
, 
¬gv
);

86 
m‘rics
 
	`m
("test-functional");

88 
¡d
::
¡ršg
 
f’ame
 = 
	`g‘_İtiÚ_¡ršg
("file");

89 
n™”s
 = 
	`g‘_İtiÚ_št
("niters", 5);

90 
¡d
::
¡ršg
 
mode
 = 
	`g‘_İtiÚ_¡ršg
("mode", "semisync");

92 
	`log¡»am
(
LOG_INFO
è<< "RuÂšg bulk synøsmok‹¡." << 
¡d
::
’dl
;

93 
run_funùiÚ®_unweigh‹d_synchrÚous
<
smok‘e¡_´og¿m
>(
f’ame
, 
n™”s
, 
m
);

95 
	`log¡»am
(
LOG_INFO
è<< "Smok‘e¡…as£d sucûssfuÎy! You¸sy¡em i wÜkšg!" << 
¡d
::
’dl
;

97 
	}
}

	@tests/dynamicdata_smoketest.cpp

30 
	#DYNAMICEDATA
 1

	)

32 
	~<¡ršg
>

34 
	~"g¿phchi_basic_šşudes.hµ
"

35 
	~"­i/dyÇmicd©a/chiveùÜ.hµ
"

37 
usšg
 
Çme¥aû
 
	gg¿phchi
;

43 
vid_t
 
	tV”‹xD©aTy³
;

44 
	gchiveùÜ
<
	tvid_t
> 
	tEdgeD©aTy³
;

49 
	gDyÇmicD©aSmokeTe¡Prog¿m
 : 
public
 
G¿phChiProg¿m
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
> {

55 
upd©e
(
g¿phchi_v”‹x
<
V”‹xD©aTy³
, 
EdgeD©aTy³
 > &
v”‹x
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

56 ià(
	ggcÚ‹xt
.
	g™”©iÚ
 == 0) {

57 
i
=0; 
	gi
 < 
	gv”‹x
.
num_ou‹dges
(); i++) {

58 
	gchiveùÜ
<
	gvid_t
> * 
	geveùÜ
 = 
v”‹x
.
ou‹dge
(
i
)->
g‘_veùÜ
();

59 
	geveùÜ
->
ş—r
();

60 
as£¹
(
eveùÜ
->
size
() == 0);

62 
	geveùÜ
->
add
(
v”‹x
.
id
());

63 
as£¹
(
eveùÜ
->
size
() == 1);

64 
as£¹
(
eveùÜ
->
g‘
(0è=ğ
v”‹x
.
id
());

68 
	gi
=0; i < 
	gv”‹x
.
num_šedges
(); i++) {

69 
	gg¿phchi_edge
<
	gEdgeD©aTy³
> * 
	gedge
 = 
v”‹x
.
šedge
(
i
);

70 
	gchiveùÜ
<
	gvid_t
> * 
	geveùÜ
 = 
edge
->
g‘_veùÜ
();

71 
as£¹
(
eveùÜ
->
size
(è>ğ
gcÚ‹xt
.
™”©iÚ
);

72 
	gj
=0; j < 
	geveùÜ
->
size
(); j++) {

73 
vid_t
 
	gex³ùed
 = 
edge
->
v”‹x_id
(è+ 
j
;

74 
vid_t
 
	ghas
 = 
eveùÜ
->
g‘
(
j
);

75 ià(
	ghas
 !ğ
ex³ùed
) {

76 
¡d
::
cout
 << "Mism©ch: " << 
has
 << " !ğ" << 
ex³ùed
 << std::
’dl
;

78 
as£¹
(
has
 =ğ
ex³ùed
);

81 
	gi
=0; i < 
	gv”‹x
.
num_ou‹dges
(); i++) {

82 
	gv”‹x
.
ou‹dge
(
i
)->
g‘_veùÜ
()->
add
(
v”‹x
.
id
(è+ 
gcÚ‹xt
.
™”©iÚ
);

85 
	gv”‹x
.
£t_d©a
(
gcÚ‹xt
.
™”©iÚ
 + 1);

91 
befÜe_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

97 
aá”_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

103 
befÜe_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

109 
aá”_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

117 
şass
 
	gV”‹xD©aCheck”
 : 
public
 
VC®lback
<
V”‹xD©aTy³
> {

118 
™”s
;

119 
	gpublic
:

120 
size_t
 
tÙ®
;

122 
V”‹xD©aCheck”
(
™”s
è: i‹rs(™”s), 
tÙ®
(0) {}

123 
ÿÎback
(
vid_t
 
v”‹x_id
, 
V”‹xD©aTy³
 &
vecv®ue
) {

124 
as£¹
(
vecv®ue
 =ğ(
V”‹xD©aTy³
)
™”s
);

125 
	gtÙ®
 +ğ(
size_t
è
™”s
;

129 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

132 
	`g¿phchi_š™
(
¬gc
, 
¬gv
);

136 
m‘rics
 
	`m
("dynamicdata-smoketest");

139 
¡d
::
¡ršg
 
f’ame
 = 
	`g‘_İtiÚ_¡ršg
("file");

140 
n™”s
 = 
	`g‘_İtiÚ_št
("niters", 4);

141 
boŞ
 
scheduËr
 = 
çl£
;

143 
nsh¬ds
 = 
cÚv”t_if_nÙexi¡s
<
vid_t
>(
f’ame
, 
	`g‘_İtiÚ_¡ršg
("nshards", "auto"));

146 
DyÇmicD©aSmokeTe¡Prog¿m
 
´og¿m
;

147 
g¿phchi_’gše
<
V”‹xD©aTy³
, 
EdgeD©aTy³
> 
	`’gše
(
f’ame
, 
nsh¬ds
, 
scheduËr
, 
m
);

148 
’gše
.
	`run
(
´og¿m
, 
n™”s
);

151 
V”‹xD©aCheck”
 
	`vcheck”
(
n™”s
);

152 
	`fÜ—ch_v”tiûs
(
f’ame
, 0, 
’gše
.
	`num_v”tiûs
(), 
vcheck”
);

153 
	`as£¹
(
vcheck”
.
tÙ®
 =ğ
’gše
.
	`num_v”tiûs
(è* 
n™”s
);

156 
	`m‘rics_»pÜt
(
m
);

158 
	`log¡»am
(
LOG_INFO
è<< "Smok‘e¡…as£d sucûssfuÎy! You¸sy¡em i wÜkšg!" << 
¡d
::
’dl
;

160 
	}
}

	@tests/test_dynamicedata_loader.cpp

31 
	#DYNAMICEDATA
 1

	)

32 
	#DYNAMICVERTEXDATA
 1

	)

34 
	~<¡ršg
>

36 
	~"g¿phchi_basic_šşudes.hµ
"

37 
	~"­i/dyÇmicd©a/chiveùÜ.hµ
"

39 
usšg
 
Çme¥aû
 
	gg¿phchi
;

45 
	gchiveùÜ
<
	tsize_t
> 
	tV”‹xD©aTy³
;

46 
	gchiveùÜ
<
	tvid_t
> 
	tEdgeD©aTy³
;

48 
size_t
 
	gchecksum
 = 0;

49 
size_t
 
	gshouldbe
 = 0;

54 
	gDyÇmicD©aLßd”Te¡Prog¿m
 : 
public
 
G¿phChiProg¿m
<
V”‹xD©aTy³
, 
	gEdgeD©aTy³
> {

56 
mu‹x
 
	glock
;

61 
upd©e
(
g¿phchi_v”‹x
<
V”‹xD©aTy³
, 
EdgeD©aTy³
 > &
v”‹x
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

62 
	gi
=0; i < 
	gv”‹x
.
num_edges
(); i++) {

63 
	gchiveùÜ
<
	gvid_t
> * 
	geveùÜ
 = 
v”‹x
.
edge
(
i
)->
g‘_veùÜ
();

64 
as£¹
(
eveùÜ
 !ğ
NULL
);

68 
	gnum–ems
 = ((
v”‹x
.
id
(è+ v”‹x.
edge
(
i
)->
v”‹x_id
()) % 3 == 1 ? 3 : 1);

70 
	gk
=0; k < 
	gnum–ems
 ; k++) {

72 
vid_t
 
	gex³ùed
 = 
v”‹x
.
id
(è+ v”‹x.
edge
(
i
)->
v”‹x_id
(è+ 
k
;

73 ià(
	gex³ùed
 !ğ
eveùÜ
->
g‘
(
k
)) {

74 
log¡»am
(
LOG_ERROR
è<< "V”‹x " << 
v”‹x
.
id
(è<< ",ƒdgd¡: " << v”‹x.
edge
(
i
)->
v”‹x_id
(è<< 
¡d
::
’dl
;

75 
log¡»am
(
LOG_ERROR
è<< "Mism©ch (" << 
	gk
 << "):ƒx³ùed " << 
	gex³ùed
 << " buˆhad " << 
	geveùÜ
->
g‘
(
k
è<< 
	g¡d
::
’dl
;

77 
as£¹
(
eveùÜ
->
g‘
(
k
è=ğ
ex³ùed
);

80 
	glock
.
lock
();

81 
	gchecksum
 +ğ
eveùÜ
->
g‘
(0);

82 
	glock
.
uÆock
();

86 
	gchiveùÜ
<
	gsize_t
> * 
	gvveùÜ
 = 
v”‹x
.
g‘_veùÜ
();

87 
	gnum™ems
 = 
v”‹x
.
id
() % 10;

88 
	gi
=0; i<
	gnum™ems
; i++) {

89 
	gvveùÜ
->
add
(
v”‹x
.
id
(è* 982192È+ 
i
);

93 
	gi
=0; i<
	gnum™ems
; i++) {

94 
size_t
 
	gx
 = 
vveùÜ
->
g‘
(
i
);

95 
size_t
 
	gex³ùed
 = 
v”‹x
.
id
(è* 982192È+ 
i
;

96 
as£¹
(
x
 =ğ
ex³ùed
);

103 
befÜe_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

109 
aá”_™”©iÚ
(
™”©iÚ
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

115 
befÜe_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

121 
aá”_exec_š‹rv®
(
vid_t
 
wšdow_¡
, vid_ˆ
wšdow_’
, 
g¿phchi_cÚ‹xt
 &
gcÚ‹xt
) {

127 
g’”©ed©a
(
¡d
::
¡ršg
 
f’ame
);

128 
g’”©ed©a
(
¡d
::
¡ršg
 
f’ame
) {

129 
¡d
::
cout
 << "G’”©šg d©a..." << std::
’dl
;

130 cÚ¡ * 
	gâame
 = 
f’ame
.
c_¡r
();

131 
FILE
 * 
	gf
 = 
fİ’
(
âame
, "w");

132 
£t_cÚf
("filetype", "edgelist");

133 
	gshouldbe
 = 0;

134 
	gtÙ®V”tiûs
 = 200000;

135 
	gi
=0; i < 
	gtÙ®V”tiûs
; i++) {

136 
	gÃdges
 = 
¿ndom
() % 50;

137 
	gj
=0; j < 
	gÃdges
; j++) {

138 
	gd¡
 = (
tÙ®V”tiûs
 / 
Ãdges
è* 
j
 + 
i
 %‚edges;

139 ià(
	gd¡
 !ğ
i
) {

140 ià((
i
 + 
d¡
) % 3 == 1) {

141 
årštf
(
f
, "%d\t%d\t%d:%d:%d\n", 
i
, 
d¡
, i + dst, i + dst + 1, i + dst + 2);

143 
årštf
(
f
, "%d\t%d\t%d\n", 
i
, 
d¡
, i + dst);

146 
	gshouldbe
 +ğ2 * (
i
 + 
d¡
);

150 
fşo£
(
f
);

153 
şass
 
	gV”‹xV®id©Ü
 : 
public
 
VC®lback
<
chiveùÜ
<
size_t
> > {

154 
public
:

155 
vœtu®
 
ÿÎback
(
vid_t
 
v”‹x_id
, 
chiveùÜ
<
size_t
> &
vec
) {

156 
	gnum™ems
 = 
v”‹x_id
 % 10;

157 
as£¹
(
vec
.
size
(è=ğ
num™ems
);

159 
	gj
=0; j < 
	gnum™ems
; j++) {

160 
size_t
 
	gx
 = 
vec
.
g‘
(
j
);

161 
as£¹
(
x
 =ğ
v”‹x_id
 * 982192È+ (
size_t
)
j
);

170 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

173 
	`g¿phchi_š™
(
¬gc
, 
¬gv
);

177 
m‘rics
 
	`m
("test-dynamicedata");

181 
¡d
::
¡ršg
 
f’ame
 = "/tmp/__chi_dyntest/testgraph";

182 
	`mkdœ
("/tmp/__chi_dyntest", 0777);

183 
n™”s
 = 1;

184 
boŞ
 
scheduËr
 = 
çl£
;

187 
	`g’”©ed©a
(
f’ame
);

188 
	`£t_cÚf
("filetype", "multivalueedgelist");

189 
nsh¬ds
 = 
cÚv”t_if_nÙexi¡s
<
vid_t
>(
f’ame
, "3");

190 
checksum
 = 0;

193 
DyÇmicD©aLßd”Te¡Prog¿m
 
´og¿m
;

194 
g¿phchi_’gše
<
V”‹xD©aTy³
, 
EdgeD©aTy³
> 
	`’gše
(
f’ame
, 
nsh¬ds
, 
scheduËr
, 
m
);

195 
’gše
.
	`£t_»£t_v”‹xd©a
(
Œue
);

196 
’gše
.
	`run
(
´og¿m
, 
n™”s
);

199 
¡d
::
cout
 << "Checksum: " << 
checksum
 << ",ƒx³ùšg: " << 
shouldbe
 << std::
’dl
;

200 
	`as£¹
(
shouldbe
 =ğ
checksum
);

203 
V”‹xV®id©Ü
 
v®id©Ü
;

204 
	`fÜ—ch_v”tiûs
(
f’ame
, 0, 
’gše
.
	`num_v”tiûs
(), 
v®id©Ü
);

208 
d–‘e_sh¬ds
<
EdgeD©aTy³
>(
f’ame
, 3);

212 
	`m‘rics_»pÜt
(
m
);

214 
	`log¡»am
(
LOG_INFO
è<< "Te¡…as£d sucûssfuÎy! You¸sy¡em i wÜkšg!" << 
¡d
::
’dl
;

216 
	}
}

	@util/atomic.hpp

1 #iâdeà
ATOMIC_HPP


2 
	#ATOMIC_HPP


	)

6 
Çme¥aû
 
	gg¿phchi
 {

13 
	g‹m¶©e
<
ty³Çme
 
	gT
>

14 şas 
	c©omic
{

15 
	gpublic
:

16 vŞ©
T
 
v®ue
;

17 
©omic
(cÚ¡ 
T
& 
v®ue
 = 0) : value(value) { }

18 
T
 
šc
(è{  
__sync_add_ªd_ãtch
(&
v®ue
, 1); }

19 
T
 
dec
(è{  
__sync_sub_ªd_ãtch
(&
v®ue
, 1); }

23 
İ”©Ü
 
T
(ècÚ¡ {  
	gv®ue
; }

26 
T
 
	gİ”©Ü
++(è{  
šc
(); }

29 
T
 
	gİ”©Ü
--(è{  
dec
(); }

32 
T
 
šc
(cÚ¡ T 
v®
è{  
__sync_add_ªd_ãtch
(&
v®ue
, val); }

35 
T
 
dec
(cÚ¡ T 
v®
è{  
__sync_sub_ªd_ãtch
(&
v®ue
, val); }

38 
T
 
	gİ”©Ü
+=(cÚ¡ T 
v®
è{  
šc
(val); }

41 
T
 
	gİ”©Ü
-=(cÚ¡ T 
v®
è{  
dec
(val); }

44 
T
 
šc_»t_Ï¡
(è{  
__sync_ãtch_ªd_add
(&
v®ue
, 1); }

47 
T
 
dec_»t_Ï¡
(è{  
__sync_ãtch_ªd_sub
(&
v®ue
, 1); }

50 
T
 
	gİ”©Ü
++(è{  
šc_»t_Ï¡
(); }

53 
T
 
	gİ”©Ü
--(è{  
dec_»t_Ï¡
(); }

56 
T
 
šc_»t_Ï¡
(cÚ¡ T 
v®
è{  
__sync_ãtch_ªd_add
(&
v®ue
, val); }

59 
T
 
dec_»t_Ï¡
(cÚ¡ T 
v®
è{  
__sync_ãtch_ªd_sub
(&
v®ue
, val); }

62 
T
 
exchªge
(cÚ¡ T 
v®
è{  
__sync_lock_‹¡_ªd_£t
(&
v®ue
, val); }

76 
	g‹m¶©e
<
ty³Çme
 
	gT
>

77 
boŞ
 
	$©omic_com·»_ªd_sw­
(
T
& 
a
, cÚ¡ T &
Şdv®
, cÚ¡ T &
Ãwv®
) {

78  
	`__sync_boŞ_com·»_ªd_sw­
(&
a
, 
Şdv®
, 
Ãwv®
);

79 
	}
};

82 
	g‹m¶©e
 <>

83 
šlše
 
boŞ
 
	$©omic_com·»_ªd_sw­
(& 
a
, cÚ¡ &
Şdv®
, cÚ¡ &
Ãwv®
) {

84  
	`__sync_boŞ_com·»_ªd_sw­
(
»š‹½»t_ÿ¡
<
ušt64_t
*>(&
a
),

85 *
»š‹½»t_ÿ¡
<cÚ¡ 
ušt64_t
*>(&
Şdv®
),

86 *
»š‹½»t_ÿ¡
<cÚ¡ 
ušt64_t
*>(&
Ãwv®
));

87 
	}
};

89 
	g‹m¶©e
 <>

90 
šlše
 
boŞ
 
	$©omic_com·»_ªd_sw­
(& 
a
, cÚ¡ &
Şdv®
, cÚ¡ &
Ãwv®
) {

91  
	`__sync_boŞ_com·»_ªd_sw­
(
»š‹½»t_ÿ¡
<
ušt32_t
*>(&
a
),

92 *
»š‹½»t_ÿ¡
<cÚ¡ 
ušt32_t
*>(&
Şdv®
),

93 *
»š‹½»t_ÿ¡
<cÚ¡ 
ušt32_t
*>(&
Ãwv®
));

94 
	}
};

96 
	g‹m¶©e
<
ty³Çme
 
	gT
>

97 
	$©omic_exchªge
(
T
& 
a
, T& 
b
) {

98 
b
 =
	`__sync_lock_‹¡_ªd_£t
(&
a
, b);

99 
	}
};

	@util/binary_minheap.hpp

29 #iâdeà
DEF_MINHEAP_GRAPHCHI


30 
	#DEF_MINHEAP_GRAPHCHI


	)

32 
	~<as£¹.h
>

33 
	~<¡dlib.h
>

36 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

37 şas 
	cbš¬y_mšh—p
 {

38 
T
 * 
	mv®ues
;

39 
	mÿ·c™y
;

40 
	msz
;

41 
	mpublic
:

42 
	$bš¬y_mšh—p
(
ÿ·c™y
è: 
	`ÿ·c™y
(ÿ·c™y), 
	$sz
(0) {

43 
v®ues
 = (
T
*è
	`ÿÎoc
(
ÿ·c™y
, (T));

46 ~
	$bš¬y_mšh—p
() {

47 
d–‘e
 
v®ues
;

48 
	}
}

50 
šlše
 
	$·»Á
(
i
è{  (i+1)/2-1; 
	}
}

51 
šlše
 
	$Ëá
(
i
è{  i*2 + 1; 
	}
}

52 
šlše
 
	$right
(
i
è{  i*2 + 2; 
	}
}

53 
šlše
 
	$šüH—pSize
(è{ 
sz
++; 
	`as£¹
(sz <ğ
ÿ·c™y
); 
	}
}

54 
šlše
 
	$deüH—pSize
(è{ 
sz
--; 
	`as£¹
(sz >ğ0); 
	}
}

56 
	$š£¹
(
T
 
–em’t
) {

57 
	`šüH—pSize
();

59 
pos
 = 
sz
 - 1;

60 ; 
pos
 > 0 && 
–em’t
 < 
v®ues
[
	`·»Á
(pos)];…os=parent(pos))

61 
v®ues
[
pos
] = v®ues[
	`·»Á
(pos)];

62 
v®ues
[
pos
] = 
–em’t
;

63 
	}
}

65 
boŞ
 
	$em±y
(è{  
sz
 =ğ0; 
	}
}

67 
	$mšH—pify
(
i
) {

68 
l
 = 
	`Ëá
(
i
);

69 
r
 = 
	`right
(
i
);

70 
sm®Ë¡
;

71 ià(
l
 < 
sz
 && 
v®ues
[l] < v®ues[
i
]è
sm®Ë¡
 =†;

72 
sm®Ë¡
 = 
i
;

73 ià(
r
 < 
sz
 && 
v®ues
[r] < v®ues[
sm®Ë¡
]) smallest =„;

74 ià(
sm®Ë¡
 !ğ
i
) {

76 
T
 
tmp
 = 
v®ues
[
i
];

77 
v®ues
[
i
] = v®ues[
sm®Ë¡
];

78 
v®ues
[
sm®Ë¡
] = 
tmp
;

79 
	`mšH—pify
(
sm®Ë¡
);

81 
	}
}

83 
T
 
	$mš
(è{  
v®ues
[0]; 
	}
}

84 
	$exŒaùMš
() {

85 
v®ues
[0] = v®ues[
sz
 - 1];

86 
	`deüH—pSize
();

87 
	`mšH—pify
(0);

88 
	}
}

	@util/cmdopts.hpp

29 #iâdeà
GRAPHCHI_CMDOPTS_DEF


30 
	#GRAPHCHI_CMDOPTS_DEF


	)

33 
	~<¡ršg
>

34 
	~<io¡»am
>

35 
	~<¡dšt.h
>

37 
	~"­i/chif’ames.hµ
"

38 
	~"ut/cÚfigfe.hµ
"

40 
Çme¥aû
 
	gg¿phchi
 {

44 #ifdeà
__GNUC__


45 
	#VARIABLE_IS_NOT_USED
 
	`__©Œibu‹__
 ((
unu£d
))

	)

47 
	#VARIABLE_IS_NOT_USED


	)

50 
boŞ
 
	g_cmd_cÚfigu»d
 = 
çl£
;

52 
	g_¬gc
;

53 **
	g_¬gv
;

54 
	g¡d
::
m­
<
¡d
::
¡ršg
, std::¡ršg> 
cÚf
;

57 
VARIABLE_IS_NOT_USED
 
£t_cÚf
(
¡d
::
¡ršg
 
key
, std::¡ršg 
v®ue
) {

58 
cÚf
[
key
] = 
v®ue
;

62 
	g¡d
::
¡ršg
 
VARIABLE_IS_NOT_USED
 
g‘_cÚfig_İtiÚ_¡ršg
(cÚ¡ *
İtiÚ_Çme
) {

63 ià(
cÚf
.
fšd
(
İtiÚ_Çme
è!ğcÚf.
’d
()) {

64  
cÚf
[
İtiÚ_Çme
];

66 
	g¡d
::
cout
 << "ERROR: could‚Ù fšd o±iÚ " << 
İtiÚ_Çme
 << " from config.";

67 
as£¹
(
çl£
);

71 
	g¡d
::
¡ršg
 
VARIABLE_IS_NOT_USED
 
g‘_cÚfig_İtiÚ_¡ršg
(cÚ¡ *
İtiÚ_Çme
,

72 
¡d
::
¡ršg
 
deçuÉ_v®ue
) {

73 ià(
cÚf
.
fšd
(
İtiÚ_Çme
è!ğcÚf.
’d
()) {

74  
cÚf
[
İtiÚ_Çme
];

76  
	gdeçuÉ_v®ue
;

80 
VARIABLE_IS_NOT_USED
 
g‘_cÚfig_İtiÚ_št
(cÚ¡ *
İtiÚ_Çme
, 
deçuÉ_v®ue
) {

81 ià(
	gcÚf
.
fšd
(
İtiÚ_Çme
è!ğ
cÚf
.
’d
()) {

82  
©oi
(
cÚf
[
İtiÚ_Çme
].
c_¡r
());

84  
	gdeçuÉ_v®ue
;

88 
VARIABLE_IS_NOT_USED
 
g‘_cÚfig_İtiÚ_št
(cÚ¡ *
İtiÚ_Çme
) {

89 ià(
	gcÚf
.
fšd
(
İtiÚ_Çme
è!ğ
cÚf
.
’d
()) {

90  
©oi
(
cÚf
[
İtiÚ_Çme
].
c_¡r
());

92 
	g¡d
::
cout
 << "ERROR: could‚Ù fšd o±iÚ " << 
İtiÚ_Çme
 << " from config.";

93 
as£¹
(
çl£
);

97 
ušt64_t
 
VARIABLE_IS_NOT_USED
 
g‘_cÚfig_İtiÚ_lÚg
(cÚ¡ *
İtiÚ_Çme
, ušt64_ˆ
deçuÉ_v®ue
) {

98 ià(
	gcÚf
.
fšd
(
İtiÚ_Çme
è!ğ
cÚf
.
’d
()) {

99  
©Ş
(
cÚf
[
İtiÚ_Çme
].
c_¡r
());

101  
	gdeçuÉ_v®ue
;

104 
VARIABLE_IS_NOT_USED
 
g‘_cÚfig_İtiÚ_doubË
(cÚ¡ *
İtiÚ_Çme
, 
deçuÉ_v®ue
) {

105 ià(
	gcÚf
.
fšd
(
İtiÚ_Çme
è!ğ
cÚf
.
’d
()) {

106  
©of
(
cÚf
[
İtiÚ_Çme
].
c_¡r
());

108  
	gdeçuÉ_v®ue
;

112 
£t_¬gc
(
¬gc
, cÚ¡ ** 
¬gv
);

113 
£t_¬gc
(
¬gc
, cÚ¡ ** 
¬gv
) {

114 
	g_¬gc
 = 
¬gc
;

115 
	g_¬gv
 = (**)
¬gv
;

116 
	g_cmd_cÚfigu»d
 = 
Œue
;

117 
	gcÚf
 = 
lßdcÚfig
(
f’ame_cÚfig_loÿl
(), 
f’ame_cÚfig
());

120 
	g¡d
::
¡ršg
 
´efix
 = "--";

121 
	gi
 = 1; i < 
	g¬gc
; i++) {

122 
	g¡d
::
¡ršg
 
¬g
 = 
¡d
::¡ršg(
_¬gv
[
i
]);

124 ià(
	g¬g
.
sub¡r
(0, 
´efix
.
size
()) ==…refix) {

125 
¬g
 =‡rg.
sub¡r
(
´efix
.
size
());

126 
size_t
 
	ga
 = 
¬g
.
fšd_fœ¡_of
("=", 0);

127 ià(
	ga
 !ğ
¬g
.
Åos
) {

128 
¡d
::
¡ršg
 
key
 = 
¬g
.
sub¡r
(0, 
a
);

129 
	g¡d
::
¡ršg
 
v®
 = 
¬g
.
sub¡r
(
a
 + 1);

131 
	g¡d
::
cout
 << "[" << 
key
 << "]" << " => " << "[" << 
v®
 << "]" << 
¡d
::
’dl
;

132 
	gcÚf
[
key
] = 
v®
;

139 
g¿phchi_š™
(
¬gc
, cÚ¡ ** 
¬gv
);

140 
g¿phchi_š™
(
¬gc
, cÚ¡ ** 
¬gv
) {

141 
£t_¬gc
(
¬gc
, 
¬gv
);

144 
check_cmd_š™
() {

145 ià(!
	g_cmd_cÚfigu»d
) {

146 
	g¡d
::
cout
 << "ERROR: commªd†šİtiÚ nÙ in™Ÿlized." << 
¡d
::
’dl
;

147 
	g¡d
::
cout
 << " You‚“dØÿÎ s‘_¬gc(èšhbegšnšg oàth´og¿m." << 
¡d
::
’dl
;

154 
	g¡d
::
¡ršg
 
VARIABLE_IS_NOT_USED
 
g‘_İtiÚ_¡ršg
(cÚ¡ *
İtiÚ_Çme
,

155 
¡d
::
¡ršg
 
deçuÉ_v®ue
)

157 
check_cmd_š™
();

158 
	gi
;

160 
	gi
 = 
_¬gc
 - 2; i >= 0; i -= 1)

161 ià(
¡rcmp
(
_¬gv
[
i
], 
İtiÚ_Çme
) == 0)

162  
¡d
::
¡ršg
(
_¬gv
[
i
 + 1]);

163  
g‘_cÚfig_İtiÚ_¡ršg
(
İtiÚ_Çme
, 
deçuÉ_v®ue
);

166 
	g¡d
::
¡ršg
 
VARIABLE_IS_NOT_USED
 
g‘_İtiÚ_¡ršg
(cÚ¡ *
İtiÚ_Çme
)

168 
i
;

169 
check_cmd_š™
();

171 
	gi
 = 
_¬gc
 - 2; i >= 0; i -= 1)

172 ià(
¡rcmp
(
_¬gv
[
i
], 
İtiÚ_Çme
) == 0)

173  
¡d
::
¡ršg
(
_¬gv
[
i
 + 1]);

174  
g‘_cÚfig_İtiÚ_¡ršg
(
İtiÚ_Çme
);

177 
	g¡d
::
¡ršg
 
VARIABLE_IS_NOT_USED
 
g‘_İtiÚ_¡ršg_š‹¿ùive
(cÚ¡ *
İtiÚ_Çme
, 
¡d
::¡ršg 
İtiÚs
)

179 
i
;

180 
check_cmd_š™
();

182 
	gi
 = 
_¬gc
 - 2; i >= 0; i -= 1)

183 ià(
¡rcmp
(
_¬gv
[
i
], 
İtiÚ_Çme
) == 0)

184  
¡d
::
¡ršg
(
_¬gv
[
i
 + 1]);

185 ià(
	gcÚf
.
fšd
(
İtiÚ_Çme
è!ğ
cÚf
.
’d
()) {

186  
cÚf
[
İtiÚ_Çme
];

189 
	g¡d
::
cout
 << "PËa£ƒÁ” v®ufÜ commªd-lš¬gum’ˆ[" << 
¡d
::
¡ršg
(
İtiÚ_Çme
è<< "]"<< std::
’dl
;

190 
	g¡d
::
cout
 << " (O±iÚ ¬e: " << 
İtiÚs
 << ")" << 
¡d
::
’dl
;

192 
	g¡d
::
¡ršg
 
v®
;

193 
	g¡d
::
cš
 >> 
v®
;

195  
	gv®
;

202 
VARIABLE_IS_NOT_USED
 
g‘_İtiÚ_št
(cÚ¡ *
İtiÚ_Çme
, 
deçuÉ_v®ue
)

204 
	gi
;

205 
check_cmd_š™
();

207 
	gi
 = 
_¬gc
 - 2; i >= 0; i -= 1)

208 ià(
¡rcmp
(
_¬gv
[
i
], 
İtiÚ_Çme
) == 0)

209  
©oi
(
_¬gv
[
i
 + 1]);

211  
g‘_cÚfig_İtiÚ_št
(
İtiÚ_Çme
, 
deçuÉ_v®ue
);

214 
VARIABLE_IS_NOT_USED
 
g‘_İtiÚ_št
(cÚ¡ *
İtiÚ_Çme
)

216 
	gi
;

217 
check_cmd_š™
();

219 
	gi
 = 
_¬gc
 - 2; i >= 0; i -= 1)

220 ià(
¡rcmp
(
_¬gv
[
i
], 
İtiÚ_Çme
) == 0)

221  
©oi
(
_¬gv
[
i
 + 1]);

223  
g‘_cÚfig_İtiÚ_št
(
İtiÚ_Çme
);

229 
ušt64_t
 
VARIABLE_IS_NOT_USED
 
g‘_İtiÚ_lÚg
(cÚ¡ *
İtiÚ_Çme
, ušt64_ˆ
deçuÉ_v®ue
)

231 
	gi
;

232 
check_cmd_š™
();

234 
	gi
 = 
_¬gc
 - 2; i >= 0; i -= 1)

235 ià(
¡rcmp
(
_¬gv
[
i
], 
İtiÚ_Çme
) == 0)

236  
©Ş
(
_¬gv
[
i
 + 1]);

237  
g‘_cÚfig_İtiÚ_lÚg
(
İtiÚ_Çme
, 
deçuÉ_v®ue
);

240 
VARIABLE_IS_NOT_USED
 
g‘_İtiÚ_æßt
(cÚ¡ *
İtiÚ_Çme
, 
deçuÉ_v®ue
)

242 
	gi
;

243 
check_cmd_š™
();

245 
	gi
 = 
_¬gc
 - 2; i >= 0; i -= 1)

246 ià(
¡rcmp
(
_¬gv
[
i
], 
İtiÚ_Çme
) == 0)

247  ()
©of
(
_¬gv
[
i
 + 1]);

248  (è
g‘_cÚfig_İtiÚ_doubË
(
İtiÚ_Çme
, 
deçuÉ_v®ue
);

	@util/configfile.hpp

30 #iâdeà
GRAPHCHI_CONFIGFILE_DEF


31 
	#GRAPHCHI_CONFIGFILE_DEF


	)

33 
	~<io¡»am
>

34 
	~<c¡dio
>

35 
	~<¡ršg
>

36 
	~<m­
>

37 
	~<as£¹.h
>

39 
Çme¥aû
 
	gg¿phchi
 {

43 cÚ¡ 
	g¡d
::
¡ršg
 
wh™eS·ûs
( " \f\n\r\t\v" );

46 
ŒimRight
Ğ
¡d
::
¡ršg
 &
¡r
,

47 cÚ¡ 
¡d
::
¡ršg
& 
ŒimCh¬s
 )

49 
¡d
::
¡ršg
::
size_ty³
 
pos
 = 
¡r
.
fšd_Ï¡_nÙ_of
Ğ
ŒimCh¬s
 );

50 
	g¡r
.
”a£
Ğ
pos
 + 1 );

54 
ŒimLeá
Ğ
¡d
::
¡ršg
 &
¡r
,

55 cÚ¡ 
¡d
::
¡ršg
& 
ŒimCh¬s
 )

57 
¡d
::
¡ršg
::
size_ty³
 
pos
 = 
¡r
.
fšd_fœ¡_nÙ_of
Ğ
ŒimCh¬s
 );

58 
	g¡r
.
”a£
Ğ0, 
pos
 );

62 
	g¡d
::
¡ršg
 
Œim
Ğ
¡d
::¡ršg 
¡r
)

64 
¡d
::
¡ršg
 
ŒimCh¬s
 = " \f\n\r\t\v";

65 
ŒimRight
Ğ
¡r
, 
ŒimCh¬s
 );

66 
ŒimLeá
Ğ
¡r
, 
ŒimCh¬s
 );

67  
	g¡r
;

72 
_FIXLINE
(* 
s
) {

73 
	gËn
 = ()
¡¾’
(
s
)-1;

74 if(
	gs
[
Ën
] =ğ'\n'è
s
[len] = 0;

83 
	g¡d
::
m­
<
¡d
::
¡ršg
, std::¡ršg> 
lßdcÚfig
(¡d::¡ršg 
f’ame
, std::¡ršg 
£cÚd¬y_f’ame
) {

84 
FILE
 * 
f
 = 
fİ’
(
f’ame
.
c_¡r
(), "r");

85 ià(
	gf
 =ğ
NULL
) {

86 
f
 = 
fİ’
(
£cÚd¬y_f’ame
.
c_¡r
(), "r");

87 ià(
	gf
 =ğ
NULL
) {

88 
¡d
::
cout
 << "ERROR: Could‚Ù„—d cÚfigu¿tiÚ fe: " << 
f’ame
 << std::
’dl
;

89 
	g¡d
::
cout
 << "PËa£ defš’vœÚm’ˆv¬ŸbË GRAPHCHI_ROOT o¸ruÀth´og¿m fromh© dœeùÜy." << 
¡d
::
’dl
;

91 
as£¹
(
f
 !ğ
NULL
);

94 
	gs
[4096];

95 
	g¡d
::
m­
<
¡d
::
¡ršg
, std::¡ršg> 
cÚf
;

98 
fg‘s
(
s
, 4096, 
f
è!ğ
NULL
) {

99 
_FIXLINE
(
s
);

100 ià(
	gs
[0] == '#') ;

101 ià(
	gs
[0] == '%') ;

103 
	gd–ims
[] = "=";

104 * 
	gt
;

105 
	gt
 = 
¡¹ok
(
s
, 
d–ims
);

106 cÚ¡ * 
	gckey
 = 
t
;

107 
	gt
 = 
¡¹ok
(
NULL
, 
d–ims
);

108 cÚ¡ * 
	gcv®
 = 
t
;

110 ià(
	gckey
 !ğ
NULL
 && 
cv®
 != NULL) {

111 
¡d
::
¡ršg
 
key
 = 
Œim
(¡d::¡ršg(
ckey
));

112 
	g¡d
::
¡ršg
 
v®
 = 
Œim
(
¡d
::¡ršg(
cv®
));

113 
	gcÚf
[
key
] = 
v®
;

118  
	gcÚf
;

	@util/dense_bitset.hpp

4 #iâdeà
DENSE_BITSET_HPP


5 
	#DENSE_BITSET_HPP


	)

6 
	~<c¡dio
>

7 
	~<c¡dlib
>

8 
	~<¡dšt.h
>

10 
Çme¥aû
 
	gg¿phchi
 {

11 şas 
	cd’£_b™£t
 {

12 
	gpublic
:

13 
d’£_b™£t
(è: 
¬¿y
(
NULL
), 
Ën
(0) {

14 
g’”©e_b™_masks
();

17 
d’£_b™£t
(
size_t
 
size
è: 
¬¿y
(
NULL
), 
Ën
(size) {

18 
»size
(
size
);

19 
ş—r
();

20 
g’”©e_b™_masks
();

24 
	gvœtu®
 ~
d’£_b™£t
(è{
ä“
(
¬¿y
);}

26 
»size
(
size_t
 
n
) {

27 
	gËn
 = 
n
;

29 
	g¬¾’
 = 
n
 / (8*(
size_t
)) + 1;

30 
	g¬¿y
 = (
size_t
*)
»®loc
(
¬¿y
, (size_tè* 
¬¾’
);

33 
ş—r
() {

34 
size_t
 
	gi
 = 0;˜< 
	g¬¾’
; ++iè
	g¬¿y
[
i
] = 0;

37 
£Î
() {

38 
mem£t
(
¬¿y
, 0xff, 
¬¾’
 * (
size_t
));

41 
šlše
 
boŞ
 
g‘
(
ušt32_t
 
b
) const{

42 
ušt32_t
 
	g¬½os
, 
	gb™pos
;

43 
b™_to_pos
(
b
, 
¬½os
, 
b™pos
);

44  
	g¬¿y
[
¬½os
] & (
size_t
(1è<< size_t(
b™pos
));

48 
šlše
 
boŞ
 
£t_b™
(
ušt32_t
 
b
) {

50 
ušt32_t
 
	g¬½os
, 
	gb™pos
;

51 
b™_to_pos
(
b
, 
¬½os
, 
b™pos
);

52 cÚ¡ 
size_t
 
mask
(size_t(1è<< size_t(
b™pos
));

53  
__sync_ãtch_ªd_Ü
(
¬¿y
 + 
¬½os
, 
mask
è& 
	gmask
;

57 
šlše
 
boŞ
 
£t
(
ušt32_t
 
b
, boŞ 
v®ue
) {

58 ià(
	gv®ue
è 
£t_b™
(
b
);

59  
ş—r_b™
(
b
);

63 
šlše
 
boŞ
 
ş—r_b™
(
ušt32_t
 
b
) {

65 
ušt32_t
 
	g¬½os
, 
	gb™pos
;

66 
b™_to_pos
(
b
, 
¬½os
, 
b™pos
);

67 cÚ¡ 
size_t
 
‹¡_mask
(size_t(1è<< size_t(
b™pos
));

68 cÚ¡ 
size_t
 
ş—r_mask
(~
‹¡_mask
);

69  
__sync_ãtch_ªd_ªd
(
¬¿y
 + 
¬½os
, 
ş—r_mask
è& 
	g‹¡_mask
;

72 
šlše
 
ş—r_b™s
(
ušt32_t
 
äomb
, ušt32_ˆ
tob
) {

74 cÚ¡ 
size_t
 
	gb™¥”wÜd
 = (size_t)*8;

75 (
	gäomb
%
	gb™¥”wÜd
 != 0)) {

76 
ş—r_b™
(
äomb
);

77 ià(
	gäomb
>=
tob
) ;

78 
	gäomb
++;

81 (
	gtob
%
	gb™¥”wÜd
 != 0)) {

82 
ş—r_b™
(
tob
);

83 if(
	gtob
<=
äomb
) ;

84 
	gtob
--;

86 
ş—r_b™
(
tob
);

88 
ušt32_t
 
	gäom_¬½os
 = 
äomb
 / (8 * (è(
size_t
));

89 
ušt32_t
 
	gto_¬½os
 = 
tob
 / (8 * (è(
size_t
));

90 
mem£t
(&
¬¿y
[
äom_¬½os
], 0, (
to_¬½os
-äom_¬½osè* (è(
size_t
));

94 
šlše
 
size_t
 
size
() const {

95  
	gËn
;

98 
	g´iv©e
:

101 
šlše
 
b™_to_pos
(
ušt32_t
 
b
, ušt32_ˆ&
¬½os
, ušt32_ˆ&
b™pos
) {

103 
	g¬½os
 = 
b
 / (8 * ()(
size_t
));

104 
	gb™pos
 = 
b
 & (8 * ()(
size_t
) - 1);

107 
g’”©e_b™_masks
() {

108 
	gb–ow_£Ëùedb™
[0] = 
size_t
(-2);

109 
size_t
 
	gi
 = 0;˜< 8 * (
	gsize_t
) ; ++i) {

110 
	g£Ëùb™
[
i
] = 
size_t
(1) << i;

111 
	gnÙ£Ëùb™
[
i
] = ~
£Ëùb™
[i];

112 ià(
	gi
 > 0è
	gb–ow_£Ëùedb™
[
i
] = 
b–ow_£Ëùedb™
[i-1] - 
£Ëùb™
[i];

117 
šlše
 
size_t
 
Ãxt_b™_š_block
(cÚ¡ 
ušt32_t
 &
b
, cÚ¡ size_ˆ&
block
) {

119 
size_t
 
	gx
 = 
block
 & 
b–ow_£Ëùedb™
[
b
] ;

120 ià(
	gx
 == 0)  0;

121  
__butš_ùzl
(
x
);

125 
šlše
 
size_t
 
fœ¡_b™_š_block
(cÚ¡ size_ˆ&
block
) {

127 ià(
	gblock
 == 0)  0;

128  
__butš_ùzl
(
block
);

131 
size_t
* 
	g¬¿y
;

132 
size_t
 
	gËn
;

133 
size_t
 
	g¬¾’
;

135 
size_t
 
	g£Ëùb™
[8 * (size_t)];

136 
size_t
 
	gnÙ£Ëùb™
[8 * (size_t)];

137 
size_t
 
	gb–ow_£Ëùedb™
[8 * (size_t)];

	@util/erdosrenyi.cpp

9 
	~<¡dlib.h
>

10 
	~<c¡dio
>

11 
	~<sys/time.h
>

12 
	~<time.h
>

14 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

15 ià(
¬gc
 < 4) {

16 
	`´štf
("Usage:ƒrdosrenyi‚ameprefix‚…\n");

20 cÚ¡ * 
Çm•»fix
 = 
¬gv
[1];

21 
n
 = 
	`©oi
(
¬gv
[2]);

22 
p
 = 
	`©of
(
¬gv
[3]);

24 
	`´štf
("Numb” oàv”tiûs=%d,ƒdg´obab™y=%lf\n", 
n
, 
p
);

26 
f’ame
[1024];

27 
	`¥rštf
(
f’ame
, "”do¤’yi_%s_%d_%.4f.edg–i¡", 
Çm•»fix
, 
n
, 
p
);

29 
timev®
 
‰
;

30 
	`g‘timeofday
(&
‰
, 
NULL
);

32 
	`¤ªdom
(
	`time
(
NULL
è+ ()
‰
.
tv_u£c
);

34 
size_t
 
K
 = 10000;

36 
FILE
 * 
f
 = 
	`fİ’
(
f’ame
, "w");

38 
size_t
 
couÁ
 = 0;

39 
size_t
 
acû±ed
 = 0;

41 
size_t
 
lim
 = (size_tè(
p
 * 
K
);

43 
i
=0; i < 
n
; i++) {

44 
j
=
i
+1; j < 
n
; j++) {

45 
couÁ
++;

46 
size_t
 
r
 = 
	`¿ndom
();

47 ià(
r
 % 
K
 < 
lim
) {

48 
acû±ed
++;

49 ià(
	`¿nd
() % 2 == 0) {

50 
	`årštf
(
f
, "%d\t%d\n", 
i
, 
j
);

52 
	`årštf
(
f
, "%d\t%d\n", 
j
, 
i
);

58 
	`fşo£
(
f
);

60 
	`´štf
("couÁ: %lu,‡cû±ed: %lf\n", 
couÁ
, (
acû±ed
)/(count));

61 
	}
}

	@util/graphgenerators.cpp

9 
	~"g¿phg’”©Üs.h
"

13 
	~<¡dlib.h
>

14 
	~<c¡dio
>

15 
	~<sys/time.h
>

16 
	~<time.h
>

18 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

19 ià(
¬gc
 < 3) {

20 
	`´štf
("Usage: generateype‚\n");

24 
¡d
::
¡ršg
 
ty³
 = 
¬gv
[1];

25 
n
 = 
	`©oi
(
¬gv
[2]);

28 
f’ame
[1024];

29 
	`¥rštf
(
f’ame
, "%s_%d.edg–i¡", 
ty³
.
	`c_¡r
(), 
n
);

30 
FILE
 * 
f
 = 
	`fİ’
(
f’ame
, "w");

32 ià(
ty³
 == "chain") {

33 
x
=0; x<
n
 - 1; x++) {

34 
	`årštf
(
f
, "%d %d\n", 
x
, x + 1);

38 ià(
ty³
 == "grid") {

39 
x
=0; x<
n
; x++) {

40 
y
=0; y<
n
; y++) {

41 
vid
 = 
y
 * 
n
 + 
x
;

42 ià(
x
 < 
n
 - 1)

43 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 1);

44 ià(
y
 < 
n
 -1)

45 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 
n
);

52 ià(
ty³
 == "crossgrid") {

53 
x
=0; x<
n
; x++) {

54 
y
=0; y<
n
; y++) {

55 
vid
 = 
y
 * 
n
 + 
x
;

56 ià(
x
 < 
n
 - 1)

57 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 1);

58 ià(
y
 < 
n
 - 1)

59 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 
n
);

60 ià(
x
 < 
n
 - 1 && 
y
 <‚ -1) {

62 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 
n
 + 1);

64 ià(
x
 < 
n
 - 1 && 
y
 > 0) {

66 
	`årštf
(
f
, "%d %d\n", 
vid
, vid -
n
 + 1);

72 ià(
ty³
 == "cubegrid") {

73 
x
=0; x<
n
; x++) {

74 
y
=0; y<
n
; y++) {

75 
z
=0; z<
n
; z++) {

76 
vid
 = 
z
 * 
n
 *‚ + 
y
 *‚ + 
x
;

77 ià(
x
 < 
n
 - 1)

78 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 1);

79 ià(
y
 < 
n
 -1)

80 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 
n
);

81 ià(
z
 < 
n
 - 1)

82 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 
n
 *‚);

88 ià(
ty³
 == "quadgrid") {

89 
x
=0; x<
n
; x++) {

90 
y
=0; y<
n
; y++) {

91 
z
=0; z<
n
; z++) {

92 
w
=0; w<
n
; w++) {

93 
vid
 = 
w
 * 
n
 *‚ *‚ + 
z
 *‚ *‚ + 
y
 *‚ + 
x
;

94 ià(
x
 < 
n
 - 1)

95 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 1);

96 ià(
y
 < 
n
 -1)

97 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 
n
);

98 ià(
z
 < 
n
 - 1)

99 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 
n
 *‚);

100 ià(
w
 < 
n
 - 1)

101 
	`årštf
(
f
, "%d %d\n", 
vid
, vid + 
n
 *‚ *‚);

110 
	`fşo£
(
f
);

111 
	}
}

	@util/graphgenerators.h

9 #iâdeà
__g¿phchi_xcode__g¿phg’”©Üs__


10 
	#__g¿phchi_xcode__g¿phg’”©Üs__


	)

12 
	~<io¡»am
>

	@util/ioutil.hpp

28 #iâdeà
DEF_IOUTIL_HPP


29 
	#DEF_IOUTIL_HPP


	)

31 
	~<uni¡d.h
>

32 
	~<as£¹.h
>

33 
	~<¡dlib.h
>

34 
	~<”ºo.h
>

35 
	~<zlib.h
>

39 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

40 
	$´—da
(
f
, 
T
 * 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
) {

41 
size_t
 
Ä—d
 = 0;

42 * 
buf
 = (*)
tbuf
;

43 
Ä—d
<
nby‹s
) {

44 
ssize_t
 
a
 = 
	`´—d
(
f
, 
buf
, 
nby‹s
 - 
Ä—d
, 
off
 +‚read);

45 ià(
a
 == (-1)) {

46 
¡d
::
cout
 << "E¼Ü, could‚Ù„—d: " << 
	`¡»¼Ü
(
”ºo
è<< "; fe-desc: " << 
f
 << std::
’dl
;

47 
¡d
::
cout
 << "P»ad‡rgum’ts: " << 
f
 << "buf: " << 
tbuf
 << "‚by‹s: " << 
nby‹s
 << " off: " << 
off
 << std::
’dl
;

48 
	`as£¹
(
a
 != (-1));

50 
	`as£¹
(
a
>0);

51 
buf
 +ğ
a
;

52 
Ä—d
 +ğ
a
;

54 
	`as£¹
(
Ä—d
 <ğ
nby‹s
);

55 
	}
}

57 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

58 
	$´—da_Œunc
(
f
, 
T
 * 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
) {

59 
size_t
 
Ä—d
 = 0;

60 * 
buf
 = (*)
tbuf
;

61 
Ä—d
<
nby‹s
) {

62 
size_t
 
a
 = 
	`´—d
(
f
, 
buf
, 
nby‹s
-
Ä—d
, 
off
+nread);

63 ià(
a
 == 0) {

66 
	`mem£t
(
buf
, 0, 
nby‹s
-
Ä—d
);

69 
buf
 +ğ
a
;

70 
Ä—d
 +ğ
a
;

73 
	}
}

75 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

76 
size_t
 
	$»adfuÎ
(
f
, 
T
 ** 
buf
) {

77 
off_t
 
sz
 = 
	`l£ek
(
f
, 0, 
SEEK_END
);

78 
	`l£ek
(
f
, 0, 
SEEK_SET
);

79 *
buf
 = (
T
*)
	`m®loc
(
sz
);

80 
	`´—da
(
f
, *
buf
, 
sz
, 0);

81  
sz
;

82 
	}
}

84 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

85 
	$pwr™—
(
f
, 
T
 * 
tbuf
, 
size_t
 
nby‹s
, size_ˆ
off
) {

86 
size_t
 
nwr™‹n
 = 0;

87 
	`as£¹
(
f
>0);

88 * 
buf
 = (*)
tbuf
;

89 
nwr™‹n
<
nby‹s
) {

90 
size_t
 
a
 = 
	`pwr™e
(
f
, 
buf
, 
nby‹s
-
nwr™‹n
, 
off
+nwritten);

91 ià(
a
 =ğ
	`size_t
(-1)) {

92 
	`log¡»am
(
LOG_ERROR
è<< "f:" << 
f
 << "‚by‹s: " << 
nby‹s
 << " wr™‹n: " << 
nwr™‹n
 << " off:" <<

93 
off
 << " f: " << 
f
 << "ƒ¼Ü:" << 
	`¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

94 
	`as£¹
(
çl£
);

96 
	`as£¹
(
a
>0);

97 
buf
 +ğ
a
;

98 
nwr™‹n
 +ğ
a
;

100 
	}
}

105 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

106 
check¬¿y_fesize
(
¡d
::
¡ršg
 
âame
, 
size_t
 
ÃËm’ts
) {

108 
	gf
 = 
İ’
(
âame
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 
S_IROTH
 | 
S_IWOTH
 | 
S_IWUSR
 | 
S_IRUSR
);

109 ià(
	gf
 < 1) {

110 
log¡»am
(
LOG_ERROR
è<< "E¼Ü in™Ÿlizšghd©a-fe: " << 
	gâame
 << "ƒ¼Ü:" << 
¡»¼Ü
(
”ºo
è<< 
	g¡d
::
’dl
; }

111 
as£¹
(
f
>0);

112 
	g”r
 = 
árunÿ‹
(
f
, 
ÃËm’ts
 * (
T
));

113 ià(
	g”r
 != 0) {

114 
log¡»am
(
LOG_ERROR
è<< "E¼Ü iÀadju¡šg fsize: " << 
âame
 << "Øsize: " << 
ÃËm’ts
 * (
T
)

115 << "ƒ¼Ü:" << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

117 
as£¹
(
”r
 == 0);

118 
şo£
(
f
);

121 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

122 
	$wr™—
(
f
, 
T
 * 
tbuf
, 
size_t
 
nby‹s
) {

123 
size_t
 
nwr™‹n
 = 0;

124 * 
buf
 = (*)
tbuf
;

125 
nwr™‹n
<
nby‹s
) {

126 
size_t
 
a
 = 
	`wr™e
(
f
, 
buf
, 
nby‹s
-
nwr™‹n
);

127 
	`as£¹
(
a
>0);

128 ià(
a
 =ğ
	`size_t
(-1)) {

129 
	`log¡»am
(
LOG_ERROR
è<< "Could‚Ù wr™" << (
nby‹s
-
nwr™‹n
è<< " by‹s!" << "ƒ¼Ü:" << 
	`¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

130 
	`as£¹
(
çl£
);

132 
buf
 +ğ
a
;

133 
nwr™‹n
 +ğ
a
;

136 
	}
}

144 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

145 
size_t
 
	$wr™e_com´es£d
(
f
, 
T
 * 
tbuf
, 
size_t
 
nby‹s
) {

147 #iâdeà
GRAPHCHI_DISABLE_COMPRESSION


148 * 
buf
 = (*)
tbuf
;

149 
»t
;

150 
have
;

151 
z_¡»am
 
¡rm
;

152 
CHUNK
 = (è
¡d
::
	`max
((
size_t
)1024 * 1024, 
nby‹s
);

153 * 
out
 = (*è
	`m®loc
(
CHUNK
);

154 
	`l£ek
(
f
, 0, 
SEEK_SET
);

157 
¡rm
.
z®loc
 = 
Z_NULL
;

158 
¡rm
.
zä“
 = 
Z_NULL
;

159 
¡rm
.
İaque
 = 
Z_NULL
;

160 
»t
 = 
	`deæ©eIn™
(&
¡rm
, 
Z_BEST_SPEED
);

161 ià(
»t
 !ğ
Z_OK
)

162 
	`as£¹
(
çl£
);

165 
¡rm
.
ava_š
 = (è
nby‹s
;

166 
¡rm
.
Ãxt_š
 = 
buf
;

168 
Œ”r
 = 
	`árunÿ‹
(
f
, 0);

169 
	`as£¹
 (
Œ”r
 == 0);

170 
size_t
 
tÙwr™‹n
 = 0;

175 
¡rm
.
ava_out
 = 
CHUNK
;

176 
¡rm
.
Ãxt_out
 = 
out
;

177 
»t
 = 
	`deæ©e
(&
¡rm
, 
Z_FINISH
);

178 
	`as£¹
(
»t
 !ğ
Z_STREAM_ERROR
);

179 
have
 = 
CHUNK
 - 
¡rm
.
ava_out
;

180 ià(
	`wr™e
(
f
, 
out
, 
have
) != have) {

181 ()
	`deæ©eEnd
(&
¡rm
);

182 
	`as£¹
(
çl£
);

184 
tÙwr™‹n
 +ğ
have
;

185 } 
¡rm
.
ava_out
 == 0);

186 
	`as£¹
(
¡rm
.
ava_š
 == 0);

188 
	`as£¹
(
»t
 =ğ
Z_STREAM_END
);

191 ()
	`deæ©eEnd
(&
¡rm
);

192 
	`ä“
(
out
);

193  
tÙwr™‹n
;

195 
	`wr™—
(
f
, 
tbuf
, 
nby‹s
);

196  
nby‹s
;

199 
	}
}

202 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

203 
	$»ad_com´es£d
(
f
, 
T
 * 
tbuf
, 
size_t
 
nby‹s
) {

204 #iâdeà
GRAPHCHI_DISABLE_COMPRESSION


205 * 
buf
 = (*)
tbuf
;

206 
»t
;

207 
have
;

208 
z_¡»am
 
¡rm
;

209 
CHUNK
 = (è
¡d
::
	`max
((
size_t
)1024 * 1024, 
nby‹s
);

211 
size_t
 
fsize
 = 
	`l£ek
(
f
, 0, 
SEEK_END
);

213 * 
š
 = (*è
	`m®loc
(
fsize
);

214 
	`l£ek
(
f
, 0, 
SEEK_SET
);

217 
¡rm
.
z®loc
 = 
Z_NULL
;

218 
¡rm
.
zä“
 = 
Z_NULL
;

219 
¡rm
.
İaque
 = 
Z_NULL
;

220 
¡rm
.
ava_š
 = 0;

221 
¡rm
.
Ãxt_š
 = 
Z_NULL
;

222 
»t
 = 
	`šæ©eIn™
(&
¡rm
);

223 ià(
»t
 !ğ
Z_OK
)

224 
	`as£¹
(
çl£
);

228 
ssize_t
 
a
 = 0;

230 
a
 = 
	`»ad
(
f
, 
š
 + 
¡rm
.
ava_š
, 
fsize
 - strm.avail_in);

231 
¡rm
.
ava_š
 +ğ(è
a
;

232 
	`as£¹
(
a
 !ğ(
ssize_t
)(-1));

233 } 
a
 > 0);

235 ià(
¡rm
.
ava_š
 == 0)

237 
¡rm
.
Ãxt_š
 = 
š
;

241 
¡rm
.
ava_out
 = 
CHUNK
;

242 
¡rm
.
Ãxt_out
 = 
buf
;

243 
»t
 = 
	`šæ©e
(&
¡rm
, 
Z_NO_FLUSH
);

244 
	`as£¹
(
»t
 !ğ
Z_STREAM_ERROR
);

245 
»t
) {

246 
Z_NEED_DICT
:

247 
»t
 = 
Z_DATA_ERROR
;

248 
Z_DATA_ERROR
:

249 
Z_MEM_ERROR
:

250 
	`as£¹
(
çl£
);

252 
have
 = 
CHUNK
 - 
¡rm
.
ava_out
;

253 
buf
 +ğ
have
;

254 } 
¡rm
.
ava_out
 == 0);

257 } 
»t
 !ğ
Z_STREAM_END
);

260 ()
	`šæ©eEnd
(&
¡rm
);

261 
	`ä“
(
š
);

263 
	`´—da
(
f
, 
tbuf
, 
nby‹s
, 0);

265 
	}
}

	@util/kwaymerge.hpp

30 #iâdeà
DEF_KWAYMERGE_GRAPHCHI


31 
	#DEF_KWAYMERGE_GRAPHCHI


	)

33 
	~<as£¹.h
>

34 
	~<¡dlib.h
>

36 
	~<veùÜ
>

37 
	~"bš¬y_mšh—p.hµ
"

40 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

41 şas 
	cm”ge_sourû
 {

42 
	mpublic
:

43 
vœtu®
 
boŞ
 
has_mÜe
() = 0;

44 
vœtu®
 
T
 
Ãxt
() = 0;

46 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

47 şas 
	cm”ge_sšk
 {

48 
	mpublic
:

49 
vœtu®
 
add
(
T
 
v®
) = 0;

50 
vœtu®
 
dÚe
() = 0;

53 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

54 
	sv®ue_sourû
 {

55 
	msourûidx
;

56 
T
 
	mv®ue
;

57 
v®ue_sourû
(
sourûidx
, 
T
 
v®ue
) : sourceidx(sourceidx), value(value) {}

59 
boŞ
 
	mİ”©Ü
< (
	mv®ue_sourû
 &
	mx2
)

61  
	mv®ue
 < 
	mx2
.value;

66 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

67 şas 
	ckway_m”ge
 {

68 
	m¡d
::
veùÜ
<
m”ge_sourû
<
T
> *> 
sourûs
;

69 
	mm”ge_sšk
<
	mT
> * 
	msšk
;

70 
	mK
;

71 
	mbš¬y_mšh—p
<
	mv®ue_sourû
<
	mT
> > 
	mt
;

73 
	mpublic
:

74 
kway_m”ge
(
¡d
::
veùÜ
<
m”ge_sourû
<
T
> *> 
sourûs
, 
m”ge_sšk
<T> * 
sšk
): sourûs(sourûs), sšk(sšk), 
t
(()sourûs.
	$size
()) {

75 
K
 = (è
sourûs
.
	`size
();

78 ~
	$kway_m”ge
() {

79 
sšk
 = 
NULL
;

80 
	}
}

82 
	$m”ge
() {

83 
aùive_sourûs
 =()
sourûs
.
	`size
();

85 
i
=0; i<
aùive_sourûs
; i++) {

86 
t
.
	`š£¹
(
v®ue_sourû
<
T
>(
i
, 
sourûs
[i]->
	`Ãxt
()));

89 
aùive_sourûs
 > 0 || !
t
.
	`em±y
()) {

90 
v®ue_sourû
<
T
> 
vv
 = 
t
.
	`mš
();

91 
t
.
	`exŒaùMš
();

92 ià(
sourûs
[
vv
.
sourûidx
]->
	`has_mÜe
()) {

93 
t
.
	`š£¹
(
v®ue_sourû
<
T
>(
vv
.
sourûidx
, 
sourûs
[vv.sourûidx]->
	`Ãxt
()));

95 
aùive_sourûs
--;

97 
sšk
->
	`add
(
vv
.
v®ue
);

99 
sšk
->
	`dÚe
();

100 
	}
}

	@util/labelanalysis.hpp

33 
	~<veùÜ
>

34 
	~<®gÜ™hm
>

35 
	~<”ºo.h
>

36 
	~<as£¹.h
>

37 
	~<f¡»am
>

39 
	~"io/¡redio.hµ
"

40 
	~"logg”/logg”.hµ
"

41 
	~"ut/m”ge.hµ
"

42 
	~"ut/iout.hµ
"

43 
	~"ut/qsÜt.hµ
"

44 
	~"­i/chif’ames.hµ
"

45 
	~"’gše/auxd©a/v”‹x_d©a.hµ
"

48 #iâdeà
DEF_GRAPHCHI_LABELANALYSIS


49 
	#DEF_GRAPHCHI_LABELANALYSIS


	)

51 
usšg
 
Çme¥aû
 
	gg¿phchi
;

53 
	g‹m¶©e
 <
ty³Çme
 
	gLab–Ty³
>

54 
	sÏb–couÁ_‰
 {

55 
Lab–Ty³
 
	mÏb–
;

56 
	mcouÁ
;

57 
Ïb–couÁ_‰
(
Lab–Ty³
 
l
, 
c
è: 
Ïb–
Ö), 
couÁ
(c) {}

58 
Ïb–couÁ_‰
() {}

61 
	g‹m¶©e
 <
ty³Çme
 
	gLab–Ty³
>

62 
boŞ
 
Ïb–_couÁ_g»©”
(cÚ¡ 
Ïb–couÁ_‰
<
Lab–Ty³
> &
a
, cÚ¡†ab–couÁ_‰<Lab–Ty³> &
b
) {

63  
	ga
.
	gcouÁ
 > 
	gb
.count;

66 
	g‹m¶©e
 <
ty³Çme
 
	gLab–Ty³
>

67 
ª®yze_Ïb–s
(
¡d
::
¡ršg
 
ba£f’ame
, 
´š‰İ
 = 20) {

68 
Ïb–couÁ_‰
<
	tLab–Ty³
> 
	tÏb–couÁ_t
;

74 
m‘rics
 
m
("labelanalysis");

75 
¡redio
 * 
	giomgr
 = 
Ãw
 sŒedio(
m
);

78 
vid_t
 
	g»adwšdow
 = 1024 * 1024;

79 
vid_t
 
	gnumv”tiûs
 = (vid_tè
g‘_num_v”tiûs
(
ba£f’ame
);

80 
	gv”‹x_d©a_¡Üe
<
	gLab–Ty³
> * 
	gv”‹xd©a
 =

81 
Ãw
 
v”‹x_d©a_¡Üe
<
Lab–Ty³
>(
ba£f’ame
, 
	gnumv”tiûs
, 
	giomgr
);

83 
	g¡d
::
veùÜ
<
Ïb–couÁ_t
> 
cu¾ab–s
;

84 
boŞ
 
	gfœ¡
 = 
Œue
;

85 
vid_t
 
	gcurvid
 = 0;

86 
Lab–Ty³
 * 
	gbufãr
 = (Lab–Ty³*è
ÿÎoc
(
»adwšdow
, (LabelType));

89 
vid_t
 
	g¡
 = 0;

90 
vid_t
 
	g’
 = 
numv”tiûs
 - 1;

92 
	g¡
 <ğ
numv”tiûs
 - 1) {

93 
’
 = 
¡
 + 
»adwšdow
 - 1;

94 ià(
	g’
 >ğ
numv”tiûs
 - 1è
’
 =‚umvertices - 1;

97 
	gv”‹xd©a
->
lßd
(
¡
, 
’
);

99 
	gÁ
 = 
’
 - 
¡
 + 1;

102 
	gi
=0; i < 
	gÁ
; i++) {

103 
Lab–Ty³
 
	gl
 = *
v”‹xd©a
->
v”‹x_d©a_±r
(
i
 + 
¡
);

104 ià(
	gl
 =ğ
curvid
è
bufãr
[
i
] = 0xffffffff;

105 
	gbufãr
[
i
] = 
l
;

106 
	gcurvid
++;

110 
quickSÜt
(
bufãr
, 
Á
, 
¡d
::
Ëss
<
Lab–Ty³
>());

113 
	g¡d
::
veùÜ
<
Ïb–couÁ_t
> 
ÃwÏb–s
;

114 
	gÃwÏb–s
.
»£rve
(
Á
);

115 
Lab–Ty³
 
	gÏ¡Ïb–
 = LabelType(0xffffffff);

116 
	gi
=0; i < 
	gÁ
; i++) {

117 ià(
	gbufãr
[
i
] !ğ
Lab–Ty³
(0xffffffff)) {

118 ià(
bufãr
[
i
] !ğ
Ï¡Ïb–
) {

119 
ÃwÏb–s
.
push_back
(
Ïb–couÁ_t
(
bufãr
[
i
], 1));

121 
	gÃwÏb–s
[
ÃwÏb–s
.
size
(è- 1].
	gcouÁ
 ++;

123 
	gÏ¡Ïb–
 = 
bufãr
[
i
];

127 ià(
	gfœ¡
) {

128 
	gi
=0; i < ()
	gÃwÏb–s
.
size
(); i++) {

129 
	gcu¾ab–s
.
push_back
(
ÃwÏb–s
[
i
]);

134 
	gş
 = 0;

135 
	gÆ
 = 0;

136 
	g¡d
::
veùÜ
< 
Ïb–couÁ_t
 > 
m”ged
;

137 
	gm”ged
.
»£rve
(
cu¾ab–s
.
size
(è+ 
ÃwÏb–s
.size());

138 
	gş
 < ()
	gcu¾ab–s
.
size
(è&& 
	gÆ
 < ()
	gÃwÏb–s
.size()) {

139 ià(
	gÃwÏb–s
[
Æ
].
	gÏb–
 =ğ
cu¾ab–s
[
ş
].
Ïb–
) {

140 
m”ged
.
push_back
(
Ïb–couÁ_t
(
ÃwÏb–s
[
Æ
].
Ïb–
,‚ewÏb–s[Æ].
couÁ
 + 
cu¾ab–s
[
ş
].count));

141 
	gÆ
++; 
	gş
++;

143 ià(
	gÃwÏb–s
[
Æ
].
	gÏb–
 < 
	gcu¾ab–s
[
ş
].label) {

144 
	gm”ged
.
push_back
(
ÃwÏb–s
[
Æ
]);

145 
	gÆ
++;

147 
	gm”ged
.
push_back
(
cu¾ab–s
[
ş
]);

148 
	gş
++;

152 
	gş
 < ()
	gcu¾ab–s
.
size
()è
	gm”ged
.
push_back
(
cu¾ab–s
[
ş
++]);

153 
	gÆ
 < ()
	gÃwÏb–s
.
size
()è
	gm”ged
.
push_back
(
ÃwÏb–s
[
Æ
++]);

155 
	gcu¾ab–s
 = 
m”ged
;

158 
	gfœ¡
 = 
çl£
;

159 
	g¡
 +ğ
»adwšdow
;

163 
	g¡d
::
sÜt
(
cu¾ab–s
.
begš
(), cu¾ab–s.
’d
(), 
Ïb–_couÁ_g»©”
<
Lab–Ty³
>);

166 
	g¡d
::
¡ršg
 
ouŠame
 = 
ba£f’ame
 + ".components";

167 
	g¡d
::
of¡»am
 
»sf
;

168 
	g»sf
.
İ’
(
ouŠame
.
c_¡r
());

169 ià(
	g»sf
 =ğ
NULL
) {

170 
log¡»am
(
LOG_ERROR
è<< "Could‚Ù wr™Ïb– ouutf: " << 
ouŠame
 << 
¡d
::
’dl
;

173 
	gi
=0; i < (è
	gcu¾ab–s
.
size
(); i++) {

174 
	g»sf
 << 
	gcu¾ab–s
[
i
].
	gÏb–
 << "," << cu¾ab–s[i].
	gcouÁ
 + 1 << 
	g¡d
::
’dl
;

176 
	g»sf
.
şo£
();

178 
	g¡d
::
cout
 << "TÙ®‚umb” oàdifã»Á†ab– (compÚ’ts/commun™›s): " << 
cu¾ab–s
.
size
(è<< 
¡d
::
’dl
;

179 
	g¡d
::
cout
 << "Li¡ oàÏb– wa wr™‹ÀtØfe: " << 
ouŠame
 << 
¡d
::
’dl
;

181 
	gi
=0; i < ()
	g¡d
::
mš
((
size_t
)
´š‰İ
, 
cu¾ab–s
.
size
()); i++) {

182 
	g¡d
::
cout
 << (
i
+1è<< ".†ab–: " << 
cu¾ab–s
[i].
Ïb–
 << ", size: " << cu¾ab–s[i].
couÁ
 + 1 << 
¡d
::
’dl
;

185 
ä“
(
bufãr
);

187 
d–‘e
 
	gv”‹xd©a
;

188 
d–‘e
 
	giomgr
;

	@util/merge.hpp

25 #iâdeà
DEF_MERGE


26 
	#DEF_MERGE


	)

28 
	g‹m¶©e
 <
şass
 
	gET
, cÏs 
	gF
>

29 
	$m”ge
(
ET
* 
S1
, 
l1
, ET* 
S2
, 
l2
, ET* 
R
, 
F
 
f
) {

30 
ET
* 
pR
 = 
R
;

31 
ET
* 
pS1
 = 
S1
;

32 
ET
* 
pS2
 = 
S2
;

33 
ET
* 
eS1
 = 
S1
+
l1
;

34 
ET
* 
eS2
 = 
S2
+
l2
;

35 
Œue
) {

36 *
pR
++ = 
	`f
(*
pS2
,*
pS1
) ? *pS2++ : *pS1++;

37 ià(
pS1
==
eS1
è{
¡d
::
	`cİy
(
pS2
,
eS2
,
pR
); ;}

38 ià(
pS2
==
eS2
è{
¡d
::
	`cİy
(
pS1
,
eS1
,
pR
); ;}

40 
	}
}

	@util/pthread_tools.hpp

1 #iâdeà
DEF_PTHREAD_TOOLS_HPP


2 
	#DEF_PTHREAD_TOOLS_HPP


	)

6 
	~<c¡dlib
>

7 
	~<memÜy.h
>

8 
	~<±h»ad.h
>

9 
	~<£m­hÜe.h
>

10 
	~<sched.h
>

11 
	~<sigÇl.h
>

12 
	~<sys/time.h
>

13 
	~<veùÜ
>

14 
	~<ÿs£¹
>

15 
	~<li¡
>

16 
	~<io¡»am
>

18 #undeà
_POSIX_SPIN_LOCKS


19 
	#_POSIX_SPIN_LOCKS
 -1

	)

27 
Çme¥aû
 
	gg¿phchi
 {

37 şas 
	cmu‹x
 {

38 
	g´iv©e
:

40 
mubË
 
±h»ad_mu‹x_t
 
m_mut
;

41 
	gpublic
:

42 
mu‹x
() {

43 
”rÜ
 = 
±h»ad_mu‹x_š™
(&
m_mut
, 
NULL
);

44 
as£¹
(!
”rÜ
);

46 
šlše
 
lock
() const {

47 
	g”rÜ
 = 
±h»ad_mu‹x_lock
Ğ&
m_mut
 );

48 
as£¹
(!
”rÜ
);

50 
šlše
 
uÆock
() const {

51 
	g”rÜ
 = 
±h»ad_mu‹x_uÆock
Ğ&
m_mut
 );

52 
as£¹
(!
”rÜ
);

54 
šlše
 
boŞ
 
Œy_lock
() const {

55  
±h»ad_mu‹x_Œylock
Ğ&
m_mut
 ) == 0;

57 ~
mu‹x
(){

58 
	g”rÜ
 = 
±h»ad_mu‹x_de¡roy
Ğ&
m_mut
 );

59 ià(
	g”rÜ
)

60 
³¼Ü
("Error: failedo destroy mutex");

61 
as£¹
(!
”rÜ
);

63 
ä›nd
 
şass
 
	gcÚd™iÚ®
;

66 #ià
_POSIX_SPIN_LOCKS
 >= 0

78 şas 
	c¥šlock
 {

79 
	g´iv©e
:

81 
mubË
 
±h»ad_¥šlock_t
 
m_¥š
;

82 
	gpublic
:

83 
¥šlock
 () {

84 
”rÜ
 = 
±h»ad_¥š_š™
(&
m_¥š
, 
PTHREAD_PROCESS_PRIVATE
);

85 
as£¹
(!
”rÜ
);

88 
šlše
 
lock
() const {

89 
	g”rÜ
 = 
±h»ad_¥š_lock
Ğ&
m_¥š
 );

90 
as£¹
(!
”rÜ
);

92 
šlše
 
uÆock
() const {

93 
	g”rÜ
 = 
±h»ad_¥š_uÆock
Ğ&
m_¥š
 );

94 
as£¹
(!
”rÜ
);

96 
šlše
 
boŞ
 
Œy_lock
() const {

97  
±h»ad_¥š_Œylock
Ğ&
m_¥š
 ) == 0;

99 ~
¥šlock
(){

100 
	g”rÜ
 = 
±h»ad_¥š_de¡roy
Ğ&
m_¥š
 );

101 
as£¹
(!
”rÜ
);

103 
ä›nd
 
şass
 
	gcÚd™iÚ®
;

105 
	#SPINLOCK_SUPPORTED
 1

	)

108 
mu‹x
 
	t¥šlock
;

109 
	#SPINLOCK_SUPPORTED
 0

	)

117 şas 
	ccÚd™iÚ®
 {

118 
	g´iv©e
:

119 
mubË
 
±h»ad_cÚd_t
 
m_cÚd
;

120 
	gpublic
:

121 
cÚd™iÚ®
() {

122 
”rÜ
 = 
±h»ad_cÚd_š™
(&
m_cÚd
, 
NULL
);

123 
as£¹
(!
”rÜ
);

125 
šlše
 
wa™
(cÚ¡ 
mu‹x
& 
mut
) const {

126 
	g”rÜ
 = 
±h»ad_cÚd_wa™
(&
m_cÚd
, &
mut
.
m_mut
);

127 
as£¹
(!
”rÜ
);

129 
šlše
 
timedwa™
(cÚ¡ 
mu‹x
& 
mut
, 
£c
) const {

130 
time¥ec
 
	gtimeout
;

131 
timev®
 
	gtv
;

132 
timezÚe
 
	gtz
;

133 
g‘timeofday
(&
tv
, &
tz
);

134 
	gtimeout
.
	gtv_n£c
 = 0;

135 
	gtimeout
.
	gtv_£c
 = 
tv
.
tv_£c
 + 
£c
;

136  
±h»ad_cÚd_timedwa™
(&
m_cÚd
, &
mut
.
m_mut
, &
timeout
);

138 
šlše
 
sigÇl
() const {

139 
	g”rÜ
 = 
±h»ad_cÚd_sigÇl
(&
m_cÚd
);

140 
as£¹
(!
”rÜ
);

142 
šlše
 
brßdÿ¡
() const {

143 
	g”rÜ
 = 
±h»ad_cÚd_brßdÿ¡
(&
m_cÚd
);

144 
as£¹
(!
”rÜ
);

146 ~
cÚd™iÚ®
() {

147 
	g”rÜ
 = 
±h»ad_cÚd_de¡roy
(&
m_cÚd
);

148 
as£¹
(!
”rÜ
);

156 şas 
	c£m­hÜe
 {

157 
	g´iv©e
:

158 
mubË
 
£m_t
 
m_£m
;

159 
	gpublic
:

160 
£m­hÜe
() {

161 
”rÜ
 = 
£m_š™
(&
m_£m
, 0,0);

162 
as£¹
(!
”rÜ
);

164 
šlše
 
po¡
() const {

165 
	g”rÜ
 = 
£m_po¡
(&
m_£m
);

166 
as£¹
(!
”rÜ
);

168 
šlše
 
wa™
() const {

169 
	g”rÜ
 = 
£m_wa™
(&
m_£m
);

170 
as£¹
(!
”rÜ
);

172 ~
£m­hÜe
() {

173 
	g”rÜ
 = 
£m_de¡roy
(&
m_£m
);

174 
as£¹
(!
”rÜ
);

181 
	#©omic_xadd
(
P
, 
V
è
	`__sync_ãtch_ªd_add
((P), (V))

	)

182 
	#cmpxchg
(
P
, 
O
, 
N
è
	`__sync_v®_com·»_ªd_sw­
((P), (O), (N))

	)

183 
	#©omic_šc
(
P
è
	`__sync_add_ªd_ãtch
((P), 1)

	)

192 şas 
	c¥šrwlock
 {

194 
	urwtick‘
 {

195 
	gu
;

196 
	gus
;

197 
__ex‹nsiÚ__
 struct {

198 
	gwr™e
;

199 
	g»ad
;

200 
	gu£rs
;

201 } 
	gs
;

203 
mubË
 
boŞ
 
	gwr™šg
;

204 
mubË
 vŞ©
rwtick‘
 
	gl
;

205 
	gpublic
:

206 
¥šrwlock
() {

207 
mem£t
(
cÚ¡_ÿ¡
<
rwtick‘
*>(&
l
), 0, (rwticket));

209 
šlše
 
wr™–ock
() const {

210 
	gme
 = 
©omic_xadd
(&
l
.
u
, (1<<16));

211 
	gv®
 = 
me
 >> 16;

213 
	gv®
 !ğ
l
.
s
.
wr™e
è
sched_y›ld
();

214 
	gwr™šg
 = 
Œue
;

217 
šlše
 
wruÆock
() const{

218 
rwtick‘
 
	gt
 = *
cÚ¡_ÿ¡
<rwtick‘*>(&
l
);

220 
	gt
.
	gs
.
	gwr™e
++;

221 
	gt
.
	gs
.
	g»ad
++;

223 *(vŞ©*è(&
	gl
èğ
t
.
us
;

224 
	gwr™šg
 = 
çl£
;

225 
__asm
("mfence");

228 
šlše
 
»adlock
() const {

229 
	gme
 = 
©omic_xadd
(&
l
.
u
, (1<<16));

230 
	gv®
 = 
me
 >> 16;

232 
	gv®
 !ğ
l
.
s
.
»ad
è
sched_y›ld
();

233 
	gl
.
	gs
.
	g»ad
++;

236 
šlše
 
rduÆock
() const {

237 
©omic_šc
(&
l
.
s
.
wr™e
);

240 
šlše
 
uÆock
() const {

241 ià(!
	gwr™šg
è
rduÆock
();

242 
wruÆock
();

246 #undeà
©omic_xadd


247 #undeà
cmpxchg


248 #undeà
©omic_šc


255 şas 
	crwlock
 {

256 
	g´iv©e
:

257 
mubË
 
±h»ad_rwlock_t
 
m_rwlock
;

258 
	gpublic
:

259 
rwlock
() {

260 
”rÜ
 = 
±h»ad_rwlock_š™
(&
m_rwlock
, 
NULL
);

261 
as£¹
(!
”rÜ
);

263 ~
rwlock
() {

264 
	g”rÜ
 = 
±h»ad_rwlock_de¡roy
(&
m_rwlock
);

265 
as£¹
(!
”rÜ
);

267 
šlše
 
»adlock
() const {

268 
±h»ad_rwlock_rdlock
(&
m_rwlock
);

271 
šlše
 
wr™–ock
() const {

272 
±h»ad_rwlock_w¾ock
(&
m_rwlock
);

275 
šlše
 
uÆock
() const {

276 
±h»ad_rwlock_uÆock
(&
m_rwlock
);

279 
šlše
 
rduÆock
() const {

280 
uÆock
();

282 
šlše
 
wruÆock
() const {

283 
uÆock
();

291 #ifdeà
__lšux__


296 şas 
	cb¬r›r
 {

297 
	g´iv©e
:

298 
mubË
 
±h»ad_b¬r›r_t
 
m_b¬r›r
;

299 
	gpublic
:

300 
b¬r›r
(
size_t
 
numth»ads
è{ 
±h»ad_b¬r›r_š™
(&
m_b¬r›r
, 
NULL
,‚umthreads); }

301 ~
b¬r›r
(è{ 
±h»ad_b¬r›r_de¡roy
(&
m_b¬r›r
); }

302 
šlše
 
wa™
(ècÚ¡ { 
±h»ad_b¬r›r_wa™
(&
m_b¬r›r
); }

310 şas 
	cb¬r›r
 {

311 
	g´iv©e
:

312 
mu‹x
 
m
;

313 
	gÃeded
;

314 
	gÿÎed
;

315 
cÚd™iÚ®
 
	gc
;

318 
	g¡d
::
veùÜ
<> 
wa™šg
;

319 
	gpublic
:

321 
b¬r›r
(
size_t
 
numth»ads
) {

322 
Ãeded
 = ()
numth»ads
;

323 
	gÿÎed
 = 0;

324 
	gwa™šg
.
»size
(
numth»ads
);

325 
	g¡d
::
fl
(
wa™šg
.
begš
(), wa™šg.
’d
(), 0);

328 ~
b¬r›r
() {}

331 
šlše
 
wa™
() {

332 
	gm
.
lock
();

334 
size_t
 
	gmyid
 = 
ÿÎed
;

335 
	gwa™šg
[
myid
] = 1;

336 
	gÿÎed
++;

338 ià(
	gÿÎed
 =ğ
Ãeded
) {

342 
ÿÎed
 = 0;

344 
	g¡d
::
fl
(
wa™šg
.
begš
(), wa™šg.
’d
(), 0);

345 
	gc
.
brßdÿ¡
();

349 
	gwa™šg
[
myid
]è
	gc
.
wa™
(
m
);

351 
	gm
.
uÆock
();

358 
šlše
 
	$´eãtch_¿nge
(*
addr
, 
size_t
 
Ën
) {

359 *
ı
;

360 *
’d
 = (*)(
addr
è+ 
Ën
;

362 
ı
 = (*)(
addr
); c°< 
’d
; c°+ğ64è
	`__butš_´eãtch
(cp, 0);

363 
	}
}

364 
šlše
 
	$´eãtch_¿nge_wr™e
(*
addr
, 
size_t
 
Ën
) {

365 *
ı
;

366 *
’d
 = (*)(
addr
è+ 
Ën
;

368 
ı
 = (*)(
addr
); c°< 
’d
; c°+ğ64è
	`__butš_´eãtch
(cp, 1);

369 
	}
}

	@util/qsort.hpp

24 #iâdeà
GRAPHCHI_QSORT_INCLUDED


25 
	#GRAPHCHI_QSORT_INCLUDED


	)

27 
	~<®gÜ™hm
>

28 
	~<veùÜ
>

30 
	g‹m¶©e
 <
şass
 
	gE
, cÏs 
	gBšP»d
>

31 
	$š£¹iÚSÜt
(
E
* 
A
, 
n
, 
BšP»d
 
f
) {

32 
i
=0; i < 
n
; i++) {

33 
E
 
v
 = 
A
[
i
];

34 
E
* 
B
 = 
A
 + 
i
;

35 --
B
 >ğ
A
 && 
	`f
(
v
,*B)) *(B+1) = *B;

36 *(
B
+1èğ
v
;

38 
	}
}

41 
	#ISORT
 25

	)

43 
	g‹m¶©e
 <
şass
 
	gE
, cÏs 
	gBšP»d
>

44 
E
 
	$medŸn
(
E
 
a
, E 
b
, E 
c
, 
BšP»d
 
f
) {

45  
	`f
(
a
,
b
è? (f(b,
c
) ? b : (f(a,c) ? c :‡))

46 : (
	`f
(
a
,
c
è?‡ : (f(
b
,c) ? c : b));

47 
	}
}

50 
	g‹m¶©e
 <
şass
 
	gE
, cÏs 
	gBšP»d
>

51 
	$quickSÜt
(
E
* 
A
, 
n
, 
BšP»d
 
f
) {

52 ià(
n
 < 
ISORT
è
	`š£¹iÚSÜt
(
A
,‚, 
f
);

54 
E
 
p
 = 
A
[
	`¿nd
(è% 
n
];

55 
E
* 
L
 = 
A
;

56 
E
* 
M
 = 
A
;

57 
E
* 
R
 = 
A
+
n
-1;

59 !
	`f
(
p
,*
M
)) {

60 ià(
	`f
(*
M
,
p
)è
¡d
::
	`sw­
(*M,*(
L
++));

61 ià(
M
 >ğ
R
) ;

62 
M
++;

64 
	`f
(
p
,*
R
)) R--;

65 ià(
M
 >ğ
R
) ;

66 
¡d
::
	`sw­
(*
M
,*
R
--);

67 ià(
	`f
(*
M
,
p
)è
¡d
::
	`sw­
(*M,*(
L
++));

68 
M
++;

70 
	`quickSÜt
(
A
, (è(
L
-A), 
f
);

71 
	`quickSÜt
(
M
, (è(
A
+
n
-M), 
f
);

73 
	}
}

	@util/radixSort.hpp

23 #iâdeà
_S_RADIX_INCLUDED


24 
	#_S_RADIX_INCLUDED


	)

26 
	~<io¡»am
>

27 
	~<®gÜ™hm
>

28 
	~<m©h.h
>

29 
	~"g¿phchi_ty³s.hµ
"

35 
Çme¥aû
 
	gg¿phchi
 {

41 
	#MAX_RADIX
 8

	)

42 
	#BUCKETS
 (1 << 
MAX_RADIX
)

	)

45 
	tbIndexT
;

46 
	tštT
;

49 
	g‹m¶©e
 <
şass
 
	gE
, cÏs 
	gF
>

50 
¿dixS‹p
(
E
* 
A
, E* 
B
, 
bIndexT
 *
Tmp
, 
štT
* 
couÁs
,

51 
štT
 
n
, iÁT 
m
, 
F
 
exŒaù
) {

52 
štT
 
	gi
 = 0; i < 
	gm
; i++è
	gcouÁs
[
i
] = 0;

53 
štT
 
	gj
 = 0; j < 
	gn
; j++) {

54 
štT
 
	gk
 = 
Tmp
[
j
] = 
exŒaù
(
A
[j]);

55 
	gcouÁs
[
k
]++;

57 
štT
 
	gs
 = 0;

58 
štT
 
	gi
 = 0; i < 
	gm
; i++) {

59 
	gs
 +ğ
couÁs
[
i
];

60 
	gcouÁs
[
i
] = 
s
;

62 
štT
 
	gj
 = 
n
-1; j >= 0; j--) {

63 
štT
 
	gx
 = --
couÁs
[
Tmp
[
j
]];

64 
	gB
[
x
] = 
A
[
j
];

69 
	g‹m¶©e
 <
şass
 
	gE
, cÏs 
	gF
>

70 
	seB™s
 {

71 
štT
 
	g_mask
; iÁT 
	g_off£t
; 
F
 
	g_f
;

72 
eB™s
(
b™s
, 
štT
 
off£t
, 
F
 
f
): 
_mask
((1<<bits)-1),

73 
_off£t
(
off£t
), 
_f
(
f
) {}

74 
štT
 
İ”©Ü
(è(
E
 
	gp
è{ 
	g_mask
&(
_f
(
p
)>>
	g_off£t
);}

77 
	g‹m¶©e
 <
şass
 
	gT
>

78 
štT
 
log2Up
(
T
 
i
) {

79 
štT
 
	ga
=0;

80 (1L << 
	ga
è<ğ
i
è
a
++;

81  
	ga
;

85 
	g‹m¶©e
 <
şass
 
	gE
, cÏs 
	gF
>

86 
iSÜt
(
E
 *
A
, 
štT
 
n
, iÁT 
m
, 
F
 
f
) {

87 
štT
 
	gb™s
 = 
log2Up
(
m
);

90 
E
* 
	gB
 = (E*è
m®loc
((E)*
n
);

91 
bIndexT
* 
	gTmp
 = (bIndexT*è
m®loc
((bIndexT)*
n
);

92 
štT
* 
	gcouÁs
 = (štT*è
m®loc
((štT)*
BUCKETS
);

94 
štT
 
	grounds
 = 1+(
b™s
-1)/
MAX_RADIX
;

95 
štT
 
	grb™s
 = 1+(
b™s
-1)/
rounds
;

96 
štT
 
	gb™Off£t
 = 0;

97 
boŞ
 
	gæ³d
 = 0;

99 
	gb™Off£t
 < 
	gb™s
) {

100 ià(
	gb™Off£t
+
	grb™s
 > 
	gb™s
èrb™ ğ
b™s
-
b™Off£t
;

101 ià(
	gæ³d
)

102 
¿dixS‹p
(
B
, 
A
, 
Tmp
, 
couÁs
, 
n
, 1L << 
rb™s
,

103 
eB™s
<
E
,
F
>(
rb™s
,
b™Off£t
,
f
));

105 
¿dixS‹p
(
A
, 
B
, 
Tmp
, 
couÁs
, 
n
, 1L << 
rb™s
,

106 
eB™s
<
E
,
F
>(
rb™s
,
b™Off£t
,
f
));

107 
	gb™Off£t
 +ğ
rb™s
;

108 
	gæ³d
 = !
æ³d
;

111 ià(
	gæ³d
)

112 
štT
 
	gi
=0; i < 
	gn
; i++)

113 
	gA
[
i
] = 
B
[i];

115 
ä“
(
B
); f»e(
Tmp
); f»e(
couÁs
);

	@util/randomweightinject.cpp

11 
	~<c¡dlib
>

12 
	~<io¡»am
>

13 
	~<as£¹.h
>

15 
	tvid_t
;

18 
šlše
 
	$FIXLINE
(* 
s
) {

19 
Ën
 = (è
	`¡¾’
(
s
)-1;

20 if(
s
[
Ën
] == '\n') s[len] = 0;

21 
	}
}

23 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

24 
FILE
 * 
šf
 = 
	`fİ’
(
¬gv
[1], "r");

25 
¡d
::
¡ršg
 
	`ty³
(
¬gv
[2]);

27 
ouŠame
[1024];

28 
	`¥rštf
(
ouŠame
, "%s_weigh‹d", 
¬gv
[1]);

29 
¡d
::
cout
 << "Ouut: " << 
ouŠame
 << std::
’dl
;

31 
FILE
 * 
outf
 = 
	`fİ’
(
ouŠame
, "w");

33 ià(
ty³
 == "edgelist" ) {

34 
size_t
 
by‹¤—d
 = 0;

35 
size_t
 
lš’um
 = 0;

37 
	`as£¹
(
šf
 !ğ
NULL
);

39 
s
[1024];

40 
	`fg‘s
(
s
, 1024, 
šf
è!ğ
NULL
) {

41 
lš’um
++;

42 ià(
lš’um
 % 10000000 == 0) {

43 
¡d
::
cout
 << "R—d " << 
lš’um
 << "†šes, " << 
by‹¤—d
 / 1024 / 1024. << " MB" << std::
’dl
;

45 
	`FIXLINE
(
s
);

46 
by‹¤—d
 +ğ
	`¡¾’
(
s
);

47 ià(
s
[0] == '#') ;

48 ià(
s
[0] == '%') ;

50 
d–ims
[] = "\t, ";

51 * 
t
;

53 
t
 = 
	`¡¹ok
(
s
, 
d–ims
);

54 
vid_t
 
äom
 = 
	`©oi
(
t
);

55 
t
 = 
	`¡¹ok
(
NULL
, 
d–ims
);

56 
vid_t
 
to
 = 
	`©oi
(
t
);

57 
	`årštf
(
outf
,"%d %d %d\n", 
äom
, 
to
, 
	`¿ndom
() % 100000000);

59 } ià(
ty³
 == "adjlist") {

60 
maxËn
 = 100000000;

61 * 
s
 = (*è
	`m®loc
(
maxËn
);

63 
size_t
 
by‹¤—d
 = 0;

65 
d–ims
[] = " \t";

66 
size_t
 
lš’um
 = 0;

67 
size_t
 
Ï¡log
 = 0;

69 
	`fg‘s
(
s
, 
maxËn
, 
šf
è!ğ
NULL
) {

70 
lš’um
++;

71 ià(
by‹¤—d
 - 
Ï¡log
 >= 500000000) {

72 
¡d
::
cout
 << "R—d " << 
lš’um
 << "†šes, " << 
by‹¤—d
 / 1024 / 1024. << " MB" << std::
’dl
;

73 
Ï¡log
 = 
by‹¤—d
;

75 
	`FIXLINE
(
s
);

76 
by‹¤—d
 +ğ
	`¡¾’
(
s
);

78 ià(
s
[0] == '#') ;

79 ià(
s
[0] == '%') ;

80 * 
t
 = 
	`¡¹ok
(
s
, 
d–ims
);

81 
vid_t
 
äom
 = 
	`©oi
(
t
);

82 
t
 = 
	`¡¹ok
(
NULL
,
d–ims
);

83 ià(
t
 !ğ
NULL
) {

84 
vid_t
 
num
 = 
	`©oi
(
t
);

85 
vid_t
 
i
 = 0;

86 (
t
 = 
	`¡¹ok
(
NULL
,
d–ims
)) != NULL) {

87 
vid_t
 
to
 = 
	`©oi
(
t
);

88 ià(
äom
 !ğ
to
)

89 
	`årštf
(
outf
,"%d %d %d\n", 
äom
, 
to
, 
	`¿ndom
() % 100000000);

90 
i
++;

92 ià(
num
 !ğ
i
) {

93 
¡d
::
û¼
 << "Mism©ch wh’„—dšg‡djaûncy†i¡: " << 
num
 << " !ğ" << 
i
 << " s: " << std::
	`¡ršg
(
s
)

94 << " oÀlše: " << 
lš’um
 << 
¡d
::
’dl
;

99 
	`ä“
(
s
);

103 
	`fşo£
(
outf
);

104 
	}
}

	@util/readdeg.cpp

9 
	~<io¡»am
>

10 
	~<f¡»am
>

12 
	sdeg»e
 {

13 
	mšdeg»e
;

14 
	moutdeg»e
;

17 
	$maš
(
¬gc
, cÚ¡ ** 
¬gv
) {

18 
FILE
 * 
f
 = 
	`fİ’
(
¬gv
[1], "r");

20 
wª‹d
 = 
	`©oi
(
¬gv
[2]);

21 
size_t
 
nout
 = 0;

22 
size_t
 
nš
 = 0;

23 
size_t
 
nÚz
 = 0;

24 
size_t
 
tÙ
 = 0;

25 
deg»e
 
d
;

26 
j
 = 0;

27 !
	`ãof
(
f
)) {

28 
	`ä—d
(&
d
, (
deg»e
), 1, 
f
);

29 
nout
 +ğ
d
.
outdeg»e
;

30 
nš
 +ğ
d
.
šdeg»e
;

31 ià(
wª‹d
 =ğ
j
) {

32 
¡d
::
cout
 << 
wª‹d
 << " indeg: " << 
d
.
šdeg»e
 << " outdeg: " << d.
outdeg»e
 << std::
’dl
;

35 
j
++;

37 
¡d
::
cout
 << "TÙ® in: " << 
nš
 << "Ù® out: " << 
nout
 << std::
’dl
;

38 
¡d
::
cout
 << "NÚ-sšgËtÚ v”tiûs: " << 
nÚz
 << std::
’dl
;

39 
¡d
::
cout
 << "TÙ® v”tiûs: " << 
tÙ
 << std::
’dl
;

41 
	}
}

	@util/synchronized_queue.hpp

1 #iâdeà
SYNCHRONIZED_QUEUE_HPP


2 
	#SYNCHRONIZED_QUEUE_HPP


	)

4 
	~<queue
>

5 
	~"±h»ad_toŞs.hµ
"

9 
Çme¥aû
 
	gg¿phchi
 {

12 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

13 şas 
	csynchrÚized_queue
 {

15 
	gpublic
:

16 
synchrÚized_queue
() { };

17 ~
synchrÚized_queue
() { };

19 
push
(cÚ¡ 
T
 &
™em
) {

20 
	g_queu–ock
.
lock
();

21 
	g_queue
.
push
(
™em
);

22 
	g_queu–ock
.
uÆock
();

25 
boŞ
 
§ãpİ
(
T
 * 
»t
) {

26 
	g_queu–ock
.
lock
();

27 ià(
	g_queue
.
size
() == 0) {

28 
_queu–ock
.
uÆock
();

30  
	gçl£
;

32 *
	g»t
 = 
_queue
.
äÚt
();

33 
	g_queue
.
pİ
();

34 
	g_queu–ock
.
uÆock
();

35  
	gŒue
;

38 
T
 
pİ
() {

39 
	g_queu–ock
.
lock
();

40 
T
 
	gt
 = 
_queue
.
äÚt
();

41 
	g_queue
.
pİ
();

42 
	g_queu–ock
.
uÆock
();

43  
	gt
;

46 
size_t
 
size
() const{

47  
	g_queue
.
size
();

49 
	g´iv©e
:

50 
¡d
::
queue
<
T
> 
_queue
;

51 
¥šlock
 
	g_queu–ock
;

	@util/toplist.hpp

29 #iâdeà
DEF_GRAPHCHI_TOPLIST


30 
	#DEF_GRAPHCHI_TOPLIST


	)

32 
	~<veùÜ
>

33 
	~<®gÜ™hm
>

34 
	~<”ºo.h
>

35 
	~<as£¹.h
>

37 
	~"io/¡redio.hµ
"

38 
	~"logg”/logg”.hµ
"

39 
	~"ut/m”ge.hµ
"

40 
	~"ut/iout.hµ
"

41 
	~"ut/qsÜt.hµ
"

42 
	~"­i/chif’ames.hµ
"

43 
	~"’gše/auxd©a/v”‹x_d©a.hµ
"

45 
Çme¥aû
 
	gg¿phchi
 {

47 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
>

48 
	sv”‹x_v®ue
 {

49 
vid_t
 
	gv”‹x
;

50 
V”‹xD©aTy³
 
	gv®ue
;

51 
v”‹x_v®ue
() {}

52 
v”‹x_v®ue
(
vid_t
 
v
, 
V”‹xD©aTy³
 
x
è: 
v”‹x
(v), 
v®ue
(x) {}

55 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
>

56 
boŞ
 
v”‹x_v®ue_g»©”
(cÚ¡ 
v”‹x_v®ue
<
V”‹xD©aTy³
> &
a
, cÚ¡ v”‹x_v®ue<V”‹xD©aTy³> &
b
) {

57  
	ga
.
	gv®ue
 > 
	gb
.value;

71 
	g‹m¶©e
 <
ty³Çme
 
	gV”‹xD©aTy³
>

72 
	g¡d
::
veùÜ
<
v”‹x_v®ue
<
V”‹xD©aTy³
> > 
g‘_tİ_v”tiûs
(
¡d
::
¡ršg
 
ba£f’ame
, 
Áİ
, 
vid_t
 
äom
=0, vid_ˆ
to
=0) {

73 
v”‹x_v®ue
<
	tV”‹xD©aTy³
> 
	tvv_t
;

76 
m‘rics
 
m
("toplist");

77 
¡redio
 * 
	giomgr
 = 
Ãw
 sŒedio(
m
);

80 
vid_t
 
	g»adwšdow
 = 1024 * 1024;

81 
size_t
 
	gnumv”tiûs
 = 
g‘_num_v”tiûs
(
ba£f’ame
);

82 
	gv”‹x_d©a_¡Üe
<
	gV”‹xD©aTy³
> * 
	gv”‹xd©a
 =

83 
Ãw
 
v”‹x_d©a_¡Üe
<
V”‹xD©aTy³
>(
ba£f’ame
, 
	gnumv”tiûs
, 
	giomgr
);

85 ià((
	gsize_t
)
	gÁİ
 > 
	gnumv”tiûs
) {

86 
	gÁİ
 = ()
numv”tiûs
;

90 
vv_t
 * 
	gbufãr_idxs
 = (vv_t*è
ÿÎoc
(
»adwšdow
, (vv_t));

91 
vv_t
 * 
	gtİbuf
 = (vv_t*è
ÿÎoc
(
Áİ
, (vv_t));

92 
vv_t
 * 
	gm”g—¼
 = (vv_t*è
ÿÎoc
(
Áİ
 * 2, (vv_t));

95 
size_t
 
	gidx
 = 0;

96 
vid_t
 
	g¡
 = 0;

97 
vid_t
 
	g’
 = 
numv”tiûs
 - 1;

99 
	gcouÁ
 = 0;

100 
	g¡
 <ğ
numv”tiûs
 - 1) {

101 
’
 = 
¡
 + 
»adwšdow
 - 1;

102 ià(
	g’
 >ğ
numv”tiûs
 - 1è
’
 =‚umvertices - 1;

105 
	gv”‹xd©a
->
lßd
(
¡
, 
’
);

107 
	gÁ
 = 
’
 - 
¡
 + 1;

108 
	gk
 = 0;

109 
V”‹xD©aTy³
 
	gmšima
 = VertexDataType();

110 ià(
	gcouÁ
 > 0) {

111 
	gmšima
 = 
tİbuf
[
Áİ
 - 1].
v®ue
;

113 
	gj
=0; j < 
	gÁ
; j++) {

114 
	gV”‹xD©aTy³
& 
	gv®
 = *
v”‹xd©a
->
v”‹x_d©a_±r
(
j
 + 
¡
);

115 ià(
	gcouÁ
 =ğ0 || (
v®
 > 
mšima
)) {

116 
bufãr_idxs
[
k
] = 
vv_t
((
vid_t
)
idx
 + 
äom
, 
v®
);

117 
	gk
++;

119 
	gidx
++;

121 
	gÁ
 = 
k
;

124 
quickSÜt
(
bufãr_idxs
, 
Á
, 
v”‹x_v®ue_g»©”
<
V”‹xD©aTy³
>);

127 ià(
	gcouÁ
 == 0) {

129 
memıy
(
tİbuf
, 
bufãr_idxs
, 
Áİ
 * (
vv_t
));

132 
	gm”ge
<
	gvv_t
>(
	gtİbuf
, 
	gÁİ
, 
	gbufãr_idxs
, 
	g¡d
::
mš
(
Áİ
, 
Á
), 
	gm”g—¼
, 
	gv”‹x_v®ue_g»©”
<
	gV”‹xD©aTy³
>);

133 
memıy
(
tİbuf
, 
m”g—¼
, 
Áİ
 * (
vv_t
));

136 
	gcouÁ
++;

137 
	g¡
 +ğ
»adwšdow
;

141 
	g¡d
::
veùÜ
< 
vv_t
 > 
»t
;

142 
	gi
=0; i < 
	gÁİ
; i++) {

143 
	g»t
.
push_back
(
tİbuf
[
i
]);

145 
ä“
(
bufãr_idxs
);

146 
ä“
(
m”g—¼
);

147 
ä“
(
tİbuf
);

149 
d–‘e
 
	gv”‹xd©a
;

150 
d–‘e
 
	giomgr
;

152  
	g»t
;

	@
1
.
0
80
2375
api/chifilenames.hpp
api/dynamicdata/chivector.hpp
api/functional/functional_api.hpp
api/functional/functional_bulksync.hpp
api/functional/functional_defs.hpp
api/functional/functional_semisync.hpp
api/graph_objects.hpp
api/graphchi_context.hpp
api/graphchi_program.hpp
api/graphlab2_1_GAS_api/assertions.hpp
api/graphlab2_1_GAS_api/graphchi_graphlabv2_1.hpp
api/graphlab2_1_GAS_api/graphlab.hpp
api/graphlab2_1_GAS_api/random.cpp
api/graphlab2_1_GAS_api/random.hpp
api/ischeduler.hpp
api/vertex_aggregator.hpp
engine/auxdata/degree_data.hpp
engine/auxdata/dynamicdata/vertex_data_dynamic.hpp
engine/auxdata/vertex_data.hpp
engine/bitset_scheduler.hpp
engine/dynamic_graphs/edgebuffers.hpp
engine/dynamic_graphs/graphchi_dynamicgraph_engine.hpp
engine/functional/functional_engine.hpp
engine/graphchi_engine.hpp
external/vpiotr-mongoose-cpp/examples/chat.c
external/vpiotr-mongoose-cpp/main.c
external/vpiotr-mongoose-cpp/mongcpp.cpp
external/vpiotr-mongoose-cpp/mongcpp.h
external/vpiotr-mongoose-cpp/mongoose.c
external/vpiotr-mongoose-cpp/mongoose.h
external/vpiotr-mongoose-cpp/test/embed.c
external/vpiotr-mongoose-cpp/test/mongotest.cpp
graphchi_basic_includes.hpp
graphchi_types.hpp
httpadmin/chi_httpadmin.hpp
httpadmin/plotter.hpp
io/stripedio.hpp
logger/logger.hpp
metrics/imetrics_reporter.hpp
metrics/metrics.hpp
metrics/reps/basic_reporter.hpp
metrics/reps/file_reporter.hpp
metrics/reps/html_reporter.hpp
metrics/reps/null_reporter.hpp
output/output.hpp
preprocessing/blocksplitter.cpp
preprocessing/conversions.hpp
preprocessing/sharder.hpp
preprocessing/sharder_basic.cpp
preprocessing/util/orderbydegree.hpp
shards/dynamicdata/dynamicblock.hpp
shards/dynamicdata/memoryshard.hpp
shards/dynamicdata/slidingshard.hpp
shards/memoryshard.hpp
shards/slidingshard.hpp
tests/basic_dynamicengine_smoketest.cpp
tests/basic_dynamicengine_smoketest2.cpp
tests/basic_smoketest.cpp
tests/bulksync_functional_test.cpp
tests/dynamicdata_smoketest.cpp
tests/test_dynamicedata_loader.cpp
util/atomic.hpp
util/binary_minheap.hpp
util/cmdopts.hpp
util/configfile.hpp
util/dense_bitset.hpp
util/erdosrenyi.cpp
util/graphgenerators.cpp
util/graphgenerators.h
util/ioutil.hpp
util/kwaymerge.hpp
util/labelanalysis.hpp
util/merge.hpp
util/pthread_tools.hpp
util/qsort.hpp
util/radixSort.hpp
util/randomweightinject.cpp
util/readdeg.cpp
util/synchronized_queue.hpp
util/toplist.hpp
